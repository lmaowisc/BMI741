---
title: "Chapter 5 - Other Non- and Semi-parametric Methods"
---

## Slides

Lecture slides [here](chap5.html){target="_blank"}. (To convert html to pdf, press E $\to$ Print $\to$ Destination: Save to pdf)

## Base R Code

```{r}
#| code-fold: true
#| code-summary: "Show the code"
#| eval: false

##################################################################
# This code generates all numerical results in chapter 5.      ##
##################################################################


library(survival)

##############################################
# GBC study
#############################################
#read in the complete data
gbc <- read.table("Data//German Breast Cancer Study//gbc.txt")

#subset to first event data
#Sort the data by time within each id
o <- order(gbc$id,gbc$time)
gbc <- gbc[o,]
#get the first row for each id
df <- gbc[!duplicated(gbc$id),]

#set status=1 if status==2 or 1
df$status <- (df$status > 0) + 0

# Reduce the scales of prog and estrg by 100
df$prog  <- df$prog / 100
df$estrg <- df$estrg / 100

############################################
# Restricted mean surval time (RMST) analysis
# with the "survRM2" package
##########################################

# install.packages("survRM2")
library(survRM2)


# Two-sample comparison between hormonal and non-hormonal
# groups on 5-year RMST
obj <- rmst2(time = df$time / 12, status = df$status, 
            arm = df$hormone - 1, tau = 5)

# print out results
obj
#> The truncation time: tau = 5  was specified. 
#> 
#> Restricted Mean Survival Time (RMST) by arm 
#>              Est.    se lower .95 upper .95
#> RMST (arm=1) 3.87 0.104     3.666     4.074
#> RMST (arm=0) 3.46 0.084     3.295     3.625
#> 
#> 
#> Restricted Mean Time Lost (RMTL) by arm 
#>              Est.    se lower .95 upper .95
#> RMTL (arm=1) 1.13 0.104     0.926     1.334
#> RMTL (arm=0) 1.54 0.084     1.375     1.705
#> 
#> 
#> Between-group contrast 
#>                       Est. lower .95 upper .95     p
#> RMST (arm=1)-(arm=0) 0.410     0.148     0.672 0.002
#> RMST (arm=1)/(arm=0) 1.118     1.042     1.201 0.002
#> RMTL (arm=1)/(arm=0) 0.734     0.595     0.905 0.004



# more compact results
obj$unadjusted.result

# obj$RMST.arm0
# obj$RMST.arm1

# Graphical display of the group-specific RMST 
# as area under the KM curves
plot(obj, xlab="Time (years)", ylab = "Relapse-free survival",
     col.RMST = "gray", col.RMTL = "white", cex.lab=1.2,
     cex.axis=1.2, col="black", xlim=c(0,5))


# Regression with all the other covariate
obj_reg <- rmst2(time = df$time / 12, status = df$status, 
            arm = df$hormone-1, covariates = df[, 5:11], tau = 5)

#overall results
obj_reg

# additive model on RMST
round(obj_reg$RMST.difference.adjusted, 3)

# multiplicative model on RMST
round(obj_reg$RMST.ratio.adjusted, 3)

# multiplicative model on RMTL
round(obj_reg$RMTL.ratio.adjusted, 3)

# for hormone treatment only 
obj.reg$adjusted.result


####################################
### Additive hazards analysis
## using the "addhazard" package
####################################


# install.packages("addhazard")
library(addhazard)
 
library(survival)
library(addhazard)

# Fit the additive hazards model to the data
fit <- ah(Surv(time, status) ~ age + hormone, data = df, ties = FALSE)

# Display the summary of the fitted model
summary(fit)



 # Fit additive hazards model
 
## preparation
df$hormone <- factor(df$hormone)
df$meno <- factor(df$meno) 

# Add an infinitesimal random number to time
 # to get rid of ties
df$time.dties <- df$time/12 + runif(nrow(df),0, 1e-12) 


# fit an additive hazard model
obj <- ah(Surv(time.dties,status) ~ hormone + meno
       + age + size + grade + prog + estrg,
       data = df, ties = FALSE)

# print out the summary
 summary(obj)
 
 
 # Aalen's model

 library(timereg)

 obj_aalen <- aalen(Surv(time.dties,status) ~ factor(hormone), data = df)

 obj_aalen$cum
 obj_aalen$var.cum
 summary(obj_aalen)

 
 
 ####################################
 ### Proportional odds analysis
 ## using the "timereg" package
 ####################################
 
 install.packages("timereg")
 library(timereg)
 
 # Fit a proportional odds model
 ## need to convert hormone and meno from numeric to factor
 obj <- prop.odds(Event(time, status) ~ hormone + meno
        + age + size + grade + prog + estrg,
        data = df)

 summary(obj)
 
 # Baseline cumulative odds function
 t <- obj$cum[,1]
 base_odds <- obj$cum[,2]
 
 # Plot baseline cumulative odds
 par(mfrow = c(1, 1))
 plot(stepfun(t, c(0, base_odds)), do.points = FALSE, lwd = 2,
      xlim=c(0,80), ylim=c(0,1.4), frame.plot = FALSE,
      ylab="Baseline cumulative odds", xlab="Time (months)", main ="")
 

 
 ###########################################
 ### Accelerated failure time (AFT) analysis
 ## using the "aftgee" package
 ##########################################
 
 install.packages("aftgee")
 library(aftgee)
 
 # fit an AFT model
 ## need to convert hormone and meno from numeric to factor
 ## (will take a little longer than usual...)
 obj <- aftgee(Surv(time, status) ~ hormone + meno
               + age + size + grade + prog + estrg,
               data = df)
  # print out summary
  summary(obj)
 
 exp(obj$coef.res) ## acceleration factors exp(beta)
 
```
