<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Chapter 15 - Machine Learning in Survival Analysis – BMI/STAT 741 Course Study Site</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-2a5582c6a9bd5a7be8848b51066e295e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Chapter 15 - Machine Learning in Survival Analysis – BMI/STAT 741 Course Study Site">
<meta property="og:description" content="">
<meta property="og:image" content="https://lmaowisc.github.io/BMI741/dc.jpg">
<meta property="og:site_name" content="BMI/STAT 741 Course Study Site">
<meta name="twitter:title" content="Chapter 15 - Machine Learning in Survival Analysis – BMI/STAT 741 Course Study Site">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://lmaowisc.github.io/BMI741/surv_hex.png">
<meta name="twitter:creator" content="@lmaowisc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image-height" content="600">
<meta name="twitter:image-width" content="518">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">BMI/STAT 741 Course Study Site</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">Syllabus</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./chapter14.html">Part III - Special Topics</a></li><li class="breadcrumb-item"><a href="./chapter15.html">Chapter 15 - Machine Learning in Survival Analysis</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Part I - Univariate Events</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 1 - Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 2 - Mathematical Foundations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 3 - Nonparametric Estimation and Testing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 4 - Cox Proportional Hazards Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 5 - Other Non- and Semi-parametric Methods</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 6 - Sample Size Determination and Study Design</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter7.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 7 - Left Truncation and Interval Censoring</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Part II - Complex Outcomes</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter8.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 8 - Multivariate Failure Times</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter9.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 9 - Recurrent Events</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 10 - Competing and Semi-Competing Risks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 11 - Joint Analysis of Longitudinal and Survival Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 12 - Multistate Modeling of Life History</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 13 - Composite Endpoints</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Part III - Special Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter14.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 14 - Causal Inference in Survival Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter15.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Chapter 15 - Machine Learning in Survival Analysis</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Miscellaneous</span></span>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#slides" id="toc-slides" class="nav-link active" data-scroll-target="#slides">Slides</a></li>
  <li><a href="#chapter-summary" id="toc-chapter-summary" class="nav-link" data-scroll-target="#chapter-summary">Chapter Summary</a>
  <ul>
  <li><a href="#regularized-cox-models" id="toc-regularized-cox-models" class="nav-link" data-scroll-target="#regularized-cox-models">Regularized Cox models</a></li>
  <li><a href="#survival-trees" id="toc-survival-trees" class="nav-link" data-scroll-target="#survival-trees">Survival trees</a></li>
  <li><a href="#ensemble-methods" id="toc-ensemble-methods" class="nav-link" data-scroll-target="#ensemble-methods">Ensemble methods</a></li>
  <li><a href="#example-r-code" id="toc-example-r-code" class="nav-link" data-scroll-target="#example-r-code">Example R code</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul></li>
  <li><a href="#r-code" id="toc-r-code" class="nav-link" data-scroll-target="#r-code">R Code</a></li>
  <li><a href="#tidymodels-code" id="toc-tidymodels-code" class="nav-link" data-scroll-target="#tidymodels-code"><code>Tidymodels</code> Code</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./chapter14.html">Part III - Special Topics</a></li><li class="breadcrumb-item"><a href="./chapter15.html">Chapter 15 - Machine Learning in Survival Analysis</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Chapter 15 - Machine Learning in Survival Analysis</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="slides" class="level2">
<h2 class="anchored" data-anchor-id="slides">Slides</h2>
<p>Lecture slides <a href="chap15.html" target="_blank">here</a>. (To convert html to pdf, press E <span class="math inline">\(\to\)</span> Print <span class="math inline">\(\to\)</span> Destination: Save to pdf)</p>
</section>
<section id="chapter-summary" class="level2">
<h2 class="anchored" data-anchor-id="chapter-summary">Chapter Summary</h2>
<p>Machine learning methods for survival analysis offer flexible and scalable alternatives to traditional models, especially in the presence of many covariates, nonlinear effects, or complex interactions. Two main approaches are considered: regularized Cox models for high-dimensional variable selection, and survival trees for nonparametric prediction. Ensemble methods such as bagging and random forests further enhance stability and prediction accuracy.</p>
<section id="regularized-cox-models" class="level3">
<h3 class="anchored" data-anchor-id="regularized-cox-models">Regularized Cox models</h3>
<p>When there are many candidate covariates, regularization can improve generalizability and interpretability.</p>
<ul>
<li><p><strong>Penalized partial likelihood</strong> (lasso-penalized Cox model): <span class="math display">\[
\hat\beta(\lambda) = \arg\min_\beta \left\{ -pl_n(\beta) + \lambda \sum_{j=1}^p |\beta_j| \right\},
\]</span> where <span class="math inline">\(pl_n(\beta)\)</span> is the partial log-likelihood and <span class="math inline">\(\lambda\)</span> controls the degree of shrinkage.</p></li>
<li><p><strong>Variable selection</strong>:<br>
The <span class="math inline">\(L_1\)</span>-penalty (lasso) produces sparse solutions by shrinking some coefficients exactly to zero.</p></li>
<li><p><strong>Cross-validation</strong>:<br>
The penalty parameter <span class="math inline">\(\lambda\)</span> is selected by minimizing the partial-likelihood deviance across validation folds.</p></li>
<li><p><strong>Prediction error</strong>:<br>
Assessed using inverse probability censored weighting (IPCW) estimators of the Brier score.</p></li>
<li><p><strong>Computation</strong>:<br>
Coordinate descent algorithm solves the penalized likelihood via iterative weighted least squares with soft-thresholding.</p></li>
</ul>
</section>
<section id="survival-trees" class="level3">
<h3 class="anchored" data-anchor-id="survival-trees">Survival trees</h3>
<p>Survival trees offer a nonparametric alternative, capable of automatically capturing nonlinearities and interactions without prespecification.</p>
<ul>
<li><strong>Tree construction</strong>:
<ul>
<li>Recursive binary splits based on covariates</li>
<li>Splitting criterion: minimize within-node deviance residuals</li>
<li>Fully grown tree followed by pruning based on cost-complexity and cross-validation.</li>
</ul></li>
<li><strong>Terminal nodes</strong>:
<ul>
<li>Within-node Kaplan–Meier curves provide survival predictions for new subjects.</li>
</ul></li>
<li><strong>Advantages</strong>:
<ul>
<li>No need to specify functional forms</li>
<li>Flexible to complex data structures</li>
<li>Naturally captures covariate interactions</li>
</ul></li>
</ul>
</section>
<section id="ensemble-methods" class="level3">
<h3 class="anchored" data-anchor-id="ensemble-methods">Ensemble methods</h3>
<p>Stability and prediction performance are improved by aggregating many trees.</p>
<ul>
<li><strong>Bagging</strong>:
<ul>
<li>Grow multiple trees on bootstrapped datasets</li>
<li>Average survival predictions across trees</li>
</ul></li>
<li><strong>Random forests</strong>:
<ul>
<li>Further randomize splits by selecting a random subset of covariates at each node</li>
<li>Reduce correlation among trees for better generalization</li>
</ul></li>
</ul>
</section>
<section id="example-r-code" class="level3">
<h3 class="anchored" data-anchor-id="example-r-code">Example R code</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">########################################</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Regularized Cox model</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="do">########################################</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(Z, <span class="fu">Surv</span>(time, status), <span class="at">family =</span> <span class="st">"cox"</span>, <span class="at">alpha =</span> <span class="dv">1</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>plotmo<span class="sc">::</span><span class="fu">plot_glmnet</span>(obj) <span class="co"># Coefficient paths</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-validation to select lambda</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>obj.cv <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(Z, <span class="fu">Surv</span>(time, status), <span class="at">family =</span> <span class="st">"cox"</span>, <span class="at">alpha =</span> <span class="dv">1</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(obj.cv)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="do">########################################</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Survival tree</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="do">########################################</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> covariates,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>             <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">xval =</span> <span class="dv">10</span>, <span class="at">minbucket =</span> <span class="dv">2</span>, <span class="at">cp =</span> <span class="dv">0</span>))</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Prune the tree</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">prune</span>(obj, <span class="at">cp =</span> obj<span class="sc">$</span>cptable[<span class="fu">which.min</span>(obj<span class="sc">$</span>cptable[, <span class="st">"xerror"</span>]), <span class="st">"CP"</span>])</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(fit)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict terminal nodes and Kaplan–Meier within nodes</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>fit<span class="sc">$</span>where</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion">Conclusion</h3>
<p>Machine learning methods provide flexible, data-driven tools for survival prediction and variable selection. Regularized Cox models yield interpretable sparse models and handle high-dimensional data efficiently. Survival trees offer a nonparametric alternative that automatically detects complex nonlinear effects and interactions. Ensemble methods like bagging and random forests further improve stability and predictive performance, making them powerful complements to traditional survival analysis techniques.</p>
</section>
</section>
<section id="r-code" class="level2">
<h2 class="anchored" data-anchor-id="r-code">R Code</h2>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">###############################################################################</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Chapter 15 R Code</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This script reproduces all major numerical results in Chapter 15, including:</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   1. Cox-Lasso analysis on GBC data (train/test split)</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   2. Survival tree modeling (pruning, terminal node curves)</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   3. Brier Score comparisons (Cox-lasso, full Cox, survival tree)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="do">###############################################################################</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Brier Score Function</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>BSfun <span class="ot">&lt;-</span> <span class="cf">function</span>(timepoints, time, status, St, t) {</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># timepoints: evaluation times</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># time, status: observed time X and event indicator Delta (1=event, 0=censor)</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># St: n x m predicted survival, columns correspond to t</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gtc, tc: censoring survival estimate G(tc) at times tc (KM)</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(St)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># censoring survival G(t) estimated via KM on censoring process</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># censor indicator: 1 if censored</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    cens <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> status</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    fitG <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">survfit</span>(survival<span class="sc">::</span><span class="fu">Surv</span>(time, cens) <span class="sc">~</span> <span class="dv">1</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Right-continuous step function for G, with G(0)=1</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    G_step <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">stepfun</span>(fitG<span class="sc">$</span>time, <span class="fu">c</span>(<span class="dv">1</span>, fitG<span class="sc">$</span>surv))</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># G(t) for each evaluation time</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  G_t <span class="ot">&lt;-</span> <span class="fu">G_step</span>(timepoints)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Avoid division by 0</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  G_t[G_t <span class="sc">&lt;=</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  BSmat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> n, <span class="at">ncol =</span> <span class="fu">length</span>(timepoints))</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># small epsilon for left-limit evaluation</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  eps <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fl">1e-8</span>, <span class="fl">1e-8</span> <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">c</span>(timepoints, time, tc), <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(n)) {</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    S_step_i <span class="ot">&lt;-</span> <span class="fu">stepfun</span>(t, <span class="fu">c</span>(<span class="dv">1</span>, St[i, ]))</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    S_i <span class="ot">&lt;-</span> <span class="fu">S_step_i</span>(timepoints)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># left-limit of G at observed time</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    G_xi <span class="ot">&lt;-</span> <span class="fu">G_step</span>(time[i] <span class="sc">-</span> eps)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.finite</span>(G_xi) <span class="sc">||</span> G_xi <span class="sc">&lt;=</span> <span class="dv">0</span>) G_xi <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># indicators over timepoints</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    I_event_by_t <span class="ot">&lt;-</span> (time[i] <span class="sc">&lt;=</span> timepoints) <span class="sc">&amp;</span> (status[i] <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    I_at_risk_t  <span class="ot">&lt;-</span> (time[i] <span class="sc">&gt;</span>  timepoints)</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># event term: S(t)^2 / G(X_i-)</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    BSmat[i, I_event_by_t] <span class="ot">&lt;-</span> (S_i[I_event_by_t]<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> G_xi</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># survival term: (1 - S(t))^2 / G(t)</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>    BSmat[i, I_at_risk_t]  <span class="ot">&lt;-</span> ((<span class="dv">1</span> <span class="sc">-</span> S_i[I_at_risk_t])<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> G_t[I_at_risk_t]</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># censored before t: contributes 0 (already 0)</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colMeans</span>(BSmat, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a><span class="co"># C-index: Harrell's and Uno's</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>Cindex_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">timepoints =</span> <span class="cn">NULL</span>, riskscore, time, status) {</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># timepoints: NULL -&gt; Harrell's C</span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>  <span class="co">#            numeric vector -&gt; Uno's time-restricted C at each tau in timepoints</span></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># riskscore: higher = higher risk (shorter survival)</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># time, status: observed time X and event indicator Delta (1=event, 0=censor)</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">length</span>(riskscore) <span class="sc">==</span> <span class="fu">length</span>(time),</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>            <span class="fu">length</span>(time) <span class="sc">==</span> <span class="fu">length</span>(status))</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(time)</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n <span class="sc">&lt;</span> <span class="dv">2</span>L) <span class="fu">stop</span>(<span class="st">"Need at least two observations."</span>)</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Helper: Harrell's C (pairwise definition)</span></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>  harrell_c <span class="ot">&lt;-</span> <span class="cf">function</span>(risk, time, status) {</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    conc <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># concordant pairs</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    ties <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># tied pairs</span></span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>    comp <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># comparable pairs</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(n <span class="sc">-</span> <span class="dv">1</span>L)) {</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> (i <span class="sc">+</span> <span class="dv">1</span>L)<span class="sc">:</span>n) {</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>        <span class="co"># comparable if the shorter observed time is an event</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (time[i] <span class="sc">&lt;</span> time[j] <span class="sc">&amp;&amp;</span> status[i] <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>          comp <span class="ot">&lt;-</span> comp <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (risk[i] <span class="sc">&gt;</span> risk[j]) conc <span class="ot">&lt;-</span> conc <span class="sc">+</span> <span class="dv">1</span>  <span class="co"># risk higher for shorter time</span></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> <span class="cf">if</span> (risk[i] <span class="sc">==</span> risk[j]) ties <span class="ot">&lt;-</span> ties <span class="sc">+</span> <span class="dv">1</span>  <span class="co"># tied risk scores</span></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span> (time[j] <span class="sc">&lt;</span> time[i] <span class="sc">&amp;&amp;</span> status[j] <span class="sc">==</span> <span class="dv">1</span>) { <span class="co"># Same for j &lt; i</span></span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>          comp <span class="ot">&lt;-</span> comp <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (risk[j] <span class="sc">&gt;</span> risk[i]) conc <span class="ot">&lt;-</span> conc <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> <span class="cf">if</span> (risk[i] <span class="sc">==</span> risk[j]) ties <span class="ot">&lt;-</span> ties <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if equal times, we skip (common choice; avoids ambiguity with ties)</span></span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (comp <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">NA_real_</span>)</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>    (conc <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> ties) <span class="sc">/</span> comp     <span class="co"># Harrell's C</span></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Helper: Uno's C restricted to tau</span></span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Uses IPCW weights 1/G(T_i-) for event times T_i &lt;= tau.</span></span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>  uno_c_tau <span class="ot">&lt;-</span> <span class="cf">function</span>(tau, risk, time, status) {</span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">length</span>(time)</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>    <span class="co"># censoring survival G(t) estimated via KM on censoring process</span></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># censor indicator: 1 if censored</span></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>    cens <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> status</span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>    fitG <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">survfit</span>(survival<span class="sc">::</span><span class="fu">Surv</span>(time, cens) <span class="sc">~</span> <span class="dv">1</span>)</span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Right-continuous step function for G, with G(0)=1</span></span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>    G_step <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">stepfun</span>(fitG<span class="sc">$</span>time, <span class="fu">c</span>(<span class="dv">1</span>, fitG<span class="sc">$</span>surv))</span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>    <span class="co"># left-limit at time t via tiny epsilon</span></span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>    eps <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fl">1e-8</span>, <span class="fl">1e-8</span> <span class="sc">*</span> <span class="fu">max</span>(time, tau, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>    num <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># numerator</span></span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>    den <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># denominator</span></span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>      <span class="co"># i must be an event observed by tau</span></span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (status[i] <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> time[i] <span class="sc">&lt;=</span> tau) {</span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>        Gi <span class="ot">&lt;-</span> <span class="fu">G_step</span>(time[i] <span class="sc">-</span> eps)</span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.finite</span>(Gi) <span class="sc">||</span> Gi <span class="sc">&lt;=</span> <span class="dv">0</span>) <span class="cf">next</span></span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>        wi <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> Gi<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>        <span class="co"># compare i against those who are still at risk after time[i]</span></span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (includes those censored after time[i], and those failing later)</span></span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (j <span class="sc">==</span> i) <span class="cf">next</span></span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (time[j] <span class="sc">&gt;</span> time[i]) {</span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>            den <span class="ot">&lt;-</span> den <span class="sc">+</span> wi</span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (risk[i] <span class="sc">&gt;</span> risk[j]) num <span class="ot">&lt;-</span> num <span class="sc">+</span> wi</span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="cf">if</span> (risk[i] <span class="sc">==</span> risk[j]) num <span class="ot">&lt;-</span> num <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> wi</span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (den <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">NA_real_</span>)</span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>    num <span class="sc">/</span> den</span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dispatch</span></span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(timepoints)) {</span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">harrell_c</span>(riskscore, time, status))</span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.numeric</span>(timepoints) <span class="sc">||</span> <span class="fu">length</span>(timepoints) <span class="sc">==</span> <span class="dv">0</span>L) {</span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"timepoints must be NULL or a non-empty numeric vector."</span>)</span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Uno's C for each tau</span></span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">vapply</span>(timepoints, <span class="cf">function</span>(tau) <span class="fu">uno_c_tau</span>(tau, riskscore, time, status), <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">tau =</span> timepoints, <span class="at">C =</span> out)</span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a><span class="co"># update glmnet package </span></span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("glmnet")</span></span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a><span class="co">#==============================================================================</span></span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a><span class="co"># (A) Cox-Lasso on GBC Data</span></span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a><span class="co">#==============================================================================</span></span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SurvMetrics)</span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a><span class="co"># library("glmpath") # alternative approach for lasso, commented out</span></span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Data Reading &amp; Preparation</span></span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a><span class="co"># The "gbc.txt" file contains the complete German Breast Cancer Study data</span></span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a>gbc <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"Data//German Breast Cancer Study//gbc.txt"</span>)</span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the data by (id, time) so that each subject’s rows appear chronologically</span></span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a>o    <span class="ot">&lt;-</span> <span class="fu">order</span>(gbc<span class="sc">$</span>id, gbc<span class="sc">$</span>time)</span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a>gbc  <span class="ot">&lt;-</span> gbc[o, ]</span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only the first row per subject =&gt; “first event” data</span></span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a><span class="co">#    i.e., we assume each subject either has 1 event or is censored.</span></span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> gbc[<span class="sc">!</span><span class="fu">duplicated</span>(gbc<span class="sc">$</span>id), ] <span class="sc">|&gt;</span></span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transformations</span></span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a>    <span class="at">status =</span> <span class="fu">as.integer</span>(status <span class="sc">&gt;</span> <span class="dv">0</span>),  <span class="co"># event: relapse or death</span></span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a>    <span class="at">age40 =</span> <span class="fu">as.integer</span>(age <span class="sc">&lt;=</span> <span class="dv">40</span>)  <span class="co"># age &lt;= 40</span></span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a><span class="co"># df$age40  &lt;- as.integer(df$age &lt;= 40)</span></span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a><span class="co"># df$status &lt;- as.integer(df$status &gt; 0)</span></span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a><span class="co"># Store total sample size</span></span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(df)</span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick peek at first few rows</span></span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df)</span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Train/Test Split</span></span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll do a random sample of 400 for training, the rest are test</span></span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a>ind   <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="at">size =</span> <span class="dv">400</span>)</span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> df[ind, ]</span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a>test  <span class="ot">&lt;-</span> df[<span class="sc">-</span>ind, ]</span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Fitting Cox-Lasso with glmnet</span></span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the set of predictors we want to consider</span></span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a>pred_list <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"hormone"</span>, <span class="st">"age40"</span>, <span class="st">"meno"</span>, <span class="st">"size"</span>, <span class="st">"grade"</span>,</span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a>               <span class="st">"nodes"</span>, <span class="st">"prog"</span>, <span class="st">"estrg"</span>)</span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct the design matrix Z from train data</span></span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(train[, pred_list])</span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract time and status vectors</span></span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a>time   <span class="ot">&lt;-</span> train<span class="sc">$</span>time</span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a>status <span class="ot">&lt;-</span> train<span class="sc">$</span>status</span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a Cox model with L1 penalty (alpha=1 =&gt; lasso), over a sequence of lambda</span></span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(Z, <span class="fu">Surv</span>(time, status), <span class="at">family =</span> <span class="st">"cox"</span>, <span class="at">alpha =</span> <span class="dv">1</span>)</span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the glmnet fit =&gt; mostly high-level info about the path</span></span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a>obj<span class="sc">$</span>beta  <span class="co"># coefficient matrix (p x m) for m lambda values</span></span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a>obj<span class="sc">$</span>lambda <span class="co"># lambda sequence used (m-vector)</span></span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(obj)  <span class="co"># basic plot of coefficient paths vs. log(lambda))</span></span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-243"><a href="#cb2-243" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform 10-fold cross-validation to select optimal lambda</span></span>
<span id="cb2-244"><a href="#cb2-244" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)  <span class="co"># for reproducibility</span></span>
<span id="cb2-245"><a href="#cb2-245" aria-hidden="true" tabindex="-1"></a>obj.cv <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(Z, <span class="fu">Surv</span>(time, status), <span class="at">family =</span> <span class="st">"cox"</span>, <span class="at">alpha =</span> <span class="dv">1</span>)</span>
<span id="cb2-246"><a href="#cb2-246" aria-hidden="true" tabindex="-1"></a><span class="co"># ?cv.glmnet</span></span>
<span id="cb2-247"><a href="#cb2-247" aria-hidden="true" tabindex="-1"></a><span class="co"># ?plot.cv.glmnet</span></span>
<span id="cb2-248"><a href="#cb2-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-249"><a href="#cb2-249" aria-hidden="true" tabindex="-1"></a>obj.cv</span>
<span id="cb2-250"><a href="#cb2-250" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(obj.cv)  <span class="co"># plot CV error vs. log(lambda)</span></span>
<span id="cb2-251"><a href="#cb2-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-252"><a href="#cb2-252" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative CV metrics</span></span>
<span id="cb2-253"><a href="#cb2-253" aria-hidden="true" tabindex="-1"></a><span class="co"># C-index, </span></span>
<span id="cb2-254"><a href="#cb2-254" aria-hidden="true" tabindex="-1"></a><span class="co"># obj.cv_c &lt;- cv.glmnet(Z, Surv(time, status), family = "cox", alpha = 1, </span></span>
<span id="cb2-255"><a href="#cb2-255" aria-hidden="true" tabindex="-1"></a><span class="co">#                     type.measure = "C")</span></span>
<span id="cb2-256"><a href="#cb2-256" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(obj.cv_c)</span></span>
<span id="cb2-257"><a href="#cb2-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-258"><a href="#cb2-258" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-259"><a href="#cb2-259" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Visualizing Coefficient Paths &amp; CV Error</span></span>
<span id="cb2-260"><a href="#cb2-260" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-261"><a href="#cb2-261" aria-hidden="true" tabindex="-1"></a><span class="co"># Remake the coefficient paths with standardized Z</span></span>
<span id="cb2-262"><a href="#cb2-262" aria-hidden="true" tabindex="-1"></a><span class="co"># and CV error plot side by side for consistent style</span></span>
<span id="cb2-263"><a href="#cb2-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-264"><a href="#cb2-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-265"><a href="#cb2-265" aria-hidden="true" tabindex="-1"></a><span class="co"># For coefficient paths, standardize Z for better comparison</span></span>
<span id="cb2-266"><a href="#cb2-266" aria-hidden="true" tabindex="-1"></a>obj_std <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(<span class="fu">scale</span>(Z), <span class="fu">Surv</span>(time, status), <span class="at">family =</span> <span class="st">"cox"</span>, <span class="at">alpha =</span> <span class="dv">1</span>)</span>
<span id="cb2-267"><a href="#cb2-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-268"><a href="#cb2-268" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the pathwise solutions</span></span>
<span id="cb2-269"><a href="#cb2-269" aria-hidden="true" tabindex="-1"></a>df_paths <span class="ot">&lt;-</span></span>
<span id="cb2-270"><a href="#cb2-270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb2-271"><a href="#cb2-271" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_lambda =</span> <span class="fu">log</span>(obj_std<span class="sc">$</span>lambda),</span>
<span id="cb2-272"><a href="#cb2-272" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(obj_std<span class="sc">$</span>beta) <span class="sc">|&gt;</span> <span class="fu">as.matrix</span>() <span class="sc">|&gt;</span> <span class="fu">as.tibble</span>()</span>
<span id="cb2-273"><a href="#cb2-273" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-274"><a href="#cb2-274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb2-275"><a href="#cb2-275" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span>log_lambda,</span>
<span id="cb2-276"><a href="#cb2-276" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"variable"</span>,</span>
<span id="cb2-277"><a href="#cb2-277" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"coefficient"</span></span>
<span id="cb2-278"><a href="#cb2-278" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-279"><a href="#cb2-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-280"><a href="#cb2-280" aria-hidden="true" tabindex="-1"></a><span class="co"># Labels and position for variable names at the right end of paths</span></span>
<span id="cb2-281"><a href="#cb2-281" aria-hidden="true" tabindex="-1"></a>df_paths_label <span class="ot">&lt;-</span> df_paths <span class="sc">|&gt;</span> </span>
<span id="cb2-282"><a href="#cb2-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(log_lambda <span class="sc">==</span> <span class="fu">min</span>(log_lambda)) <span class="sc">|&gt;</span> </span>
<span id="cb2-283"><a href="#cb2-283" aria-hidden="true" tabindex="-1"></a>  <span class="co"># estrg and size are too close, adjust y-positions</span></span>
<span id="cb2-284"><a href="#cb2-284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-285"><a href="#cb2-285" aria-hidden="true" tabindex="-1"></a>    <span class="at">coefficient =</span> <span class="fu">case_when</span>(</span>
<span id="cb2-286"><a href="#cb2-286" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"nodes"</span> <span class="sc">~</span> coefficient <span class="sc">+</span> <span class="fl">0.01</span>,</span>
<span id="cb2-287"><a href="#cb2-287" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"age40"</span> <span class="sc">~</span> coefficient <span class="sc">-</span> <span class="fl">0.01</span>,</span>
<span id="cb2-288"><a href="#cb2-288" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"grade"</span> <span class="sc">~</span> coefficient <span class="sc">+</span> <span class="fl">0.01</span>,</span>
<span id="cb2-289"><a href="#cb2-289" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"estrg"</span> <span class="sc">~</span> coefficient <span class="sc">-</span> <span class="fl">0.015</span>,</span>
<span id="cb2-290"><a href="#cb2-290" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"size"</span>  <span class="sc">~</span> coefficient <span class="sc">+</span> <span class="fl">0.015</span>,</span>
<span id="cb2-291"><a href="#cb2-291" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"meno"</span> <span class="sc">~</span> coefficient <span class="sc">-</span> <span class="fl">0.012</span>,</span>
<span id="cb2-292"><a href="#cb2-292" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span>                <span class="sc">~</span> coefficient</span>
<span id="cb2-293"><a href="#cb2-293" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb2-294"><a href="#cb2-294" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="fu">if_else</span>(variable <span class="sc">==</span> <span class="st">"hormone"</span>, <span class="st">"horm"</span>, variable)</span>
<span id="cb2-295"><a href="#cb2-295" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-296"><a href="#cb2-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-297"><a href="#cb2-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-298"><a href="#cb2-298" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot coefficient paths</span></span>
<span id="cb2-299"><a href="#cb2-299" aria-hidden="true" tabindex="-1"></a>gbc_path <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_paths, <span class="fu">aes</span>(<span class="at">x =</span> log_lambda, <span class="at">y =</span> coefficient, <span class="at">color =</span> variable)) <span class="sc">+</span></span>
<span id="cb2-300"><a href="#cb2-300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb2-301"><a href="#cb2-301" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">log</span>(obj.cv<span class="sc">$</span>lambda.min), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb2-302"><a href="#cb2-302" aria-hidden="true" tabindex="-1"></a>  <span class="co"># label variable names at the end</span></span>
<span id="cb2-303"><a href="#cb2-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb2-304"><a href="#cb2-304" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df_paths_label,</span>
<span id="cb2-305"><a href="#cb2-305" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> variable),</span>
<span id="cb2-306"><a href="#cb2-306" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.05</span>,</span>
<span id="cb2-307"><a href="#cb2-307" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb2-308"><a href="#cb2-308" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.5</span></span>
<span id="cb2-309"><a href="#cb2-309" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-310"><a href="#cb2-310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_reverse</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.15</span>))) <span class="sc">+</span></span>
<span id="cb2-311"><a href="#cb2-311" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-312"><a href="#cb2-312" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">log</span>(lambda)),</span>
<span id="cb2-313"><a href="#cb2-313" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Coefficients"</span></span>
<span id="cb2-314"><a href="#cb2-314" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-315"><a href="#cb2-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb2-316"><a href="#cb2-316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb2-317"><a href="#cb2-317" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position  =</span> <span class="st">"none"</span>,</span>
<span id="cb2-318"><a href="#cb2-318" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y  =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-319"><a href="#cb2-319" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>)</span>
<span id="cb2-320"><a href="#cb2-320" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-321"><a href="#cb2-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-322"><a href="#cb2-322" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot CV</span></span>
<span id="cb2-323"><a href="#cb2-323" aria-hidden="true" tabindex="-1"></a>df_cv <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-324"><a href="#cb2-324" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_lambda =</span> <span class="fu">log</span>(obj.cv<span class="sc">$</span>lambda),</span>
<span id="cb2-325"><a href="#cb2-325" aria-hidden="true" tabindex="-1"></a>  <span class="at">cvm       =</span> obj.cv<span class="sc">$</span>cvm,</span>
<span id="cb2-326"><a href="#cb2-326" aria-hidden="true" tabindex="-1"></a>  <span class="at">cvup      =</span> obj.cv<span class="sc">$</span>cvup,</span>
<span id="cb2-327"><a href="#cb2-327" aria-hidden="true" tabindex="-1"></a>  <span class="at">cvlo      =</span> obj.cv<span class="sc">$</span>cvlo,</span>
<span id="cb2-328"><a href="#cb2-328" aria-hidden="true" tabindex="-1"></a>  <span class="at">nzero     =</span> obj.cv<span class="sc">$</span>nzero</span>
<span id="cb2-329"><a href="#cb2-329" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-330"><a href="#cb2-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-331"><a href="#cb2-331" aria-hidden="true" tabindex="-1"></a>gbc_cv <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_cv, <span class="fu">aes</span>(<span class="at">x =</span> log_lambda, <span class="at">y =</span> cvm)) <span class="sc">+</span></span>
<span id="cb2-332"><a href="#cb2-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb2-333"><a href="#cb2-333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb2-334"><a href="#cb2-334" aria-hidden="true" tabindex="-1"></a>  <span class="co"># omit any ribbon / error bars to suppress SE</span></span>
<span id="cb2-335"><a href="#cb2-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">log</span>(obj.cv<span class="sc">$</span>lambda.min), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb2-336"><a href="#cb2-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_reverse</span>() <span class="sc">+</span></span>
<span id="cb2-337"><a href="#cb2-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">log</span>(lambda)), <span class="at">y =</span> obj.cv<span class="sc">$</span>name) <span class="sc">+</span></span>
<span id="cb2-338"><a href="#cb2-338" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb2-339"><a href="#cb2-339" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb2-340"><a href="#cb2-340" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position  =</span> <span class="st">"none"</span>,</span>
<span id="cb2-341"><a href="#cb2-341" aria-hidden="true" tabindex="-1"></a>    <span class="co"># axis.text.y  = element_blank(),</span></span>
<span id="cb2-342"><a href="#cb2-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>)</span>
<span id="cb2-343"><a href="#cb2-343" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-344"><a href="#cb2-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-345"><a href="#cb2-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-346"><a href="#cb2-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-347"><a href="#cb2-347" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the two plots side by side</span></span>
<span id="cb2-348"><a href="#cb2-348" aria-hidden="true" tabindex="-1"></a>gbc_combined <span class="ot">&lt;-</span> gbc_path <span class="sc">+</span> gbc_cv </span>
<span id="cb2-349"><a href="#cb2-349" aria-hidden="true" tabindex="-1"></a>gbc_combined</span>
<span id="cb2-350"><a href="#cb2-350" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("images/ml_glmnet_gbc.png", gbc_combined,</span></span>
<span id="cb2-351"><a href="#cb2-351" aria-hidden="true" tabindex="-1"></a><span class="co">#        width = 8, height = 4, dpi = 300)</span></span>
<span id="cb2-352"><a href="#cb2-352" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("images/ml_glmnet_gbc.eps", gbc_combined, device = cairo_ps,</span></span>
<span id="cb2-353"><a href="#cb2-353" aria-hidden="true" tabindex="-1"></a><span class="co">#        width = 8, height = 4)</span></span>
<span id="cb2-354"><a href="#cb2-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-355"><a href="#cb2-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-356"><a href="#cb2-356" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify the optimal lambda minimizing the CV error</span></span>
<span id="cb2-357"><a href="#cb2-357" aria-hidden="true" tabindex="-1"></a>lambda.opt <span class="ot">&lt;-</span> obj.cv<span class="sc">$</span>lambda.min</span>
<span id="cb2-358"><a href="#cb2-358" aria-hidden="true" tabindex="-1"></a>lambda.opt</span>
<span id="cb2-359"><a href="#cb2-359" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 0.02472102</span></span>
<span id="cb2-360"><a href="#cb2-360" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the coefficients at lambda.min</span></span>
<span id="cb2-361"><a href="#cb2-361" aria-hidden="true" tabindex="-1"></a>beta.opt   <span class="ot">&lt;-</span> <span class="fu">coef</span>(obj.cv, <span class="at">s =</span> <span class="st">"lambda.min"</span>)</span>
<span id="cb2-362"><a href="#cb2-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-363"><a href="#cb2-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-364"><a href="#cb2-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-365"><a href="#cb2-365" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify which coefficients are non-zero</span></span>
<span id="cb2-366"><a href="#cb2-366" aria-hidden="true" tabindex="-1"></a>beta.selected  <span class="ot">&lt;-</span> beta.opt[<span class="fu">abs</span>(beta.opt[, <span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>, ]</span>
<span id="cb2-367"><a href="#cb2-367" aria-hidden="true" tabindex="-1"></a>beta.selected  <span class="co"># show the non-zero variables</span></span>
<span id="cb2-368"><a href="#cb2-368" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(beta.selected)  <span class="co"># how many are non-zero?</span></span>
<span id="cb2-369"><a href="#cb2-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-370"><a href="#cb2-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-371"><a href="#cb2-371" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-372"><a href="#cb2-372" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Refit Cox Model Using Selected Variables</span></span>
<span id="cb2-373"><a href="#cb2-373" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-374"><a href="#cb2-374" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll pull the variable names and re-fit a coxph with these in the training set</span></span>
<span id="cb2-375"><a href="#cb2-375" aria-hidden="true" tabindex="-1"></a>selected_vars <span class="ot">&lt;-</span> <span class="fu">names</span>(beta.selected)</span>
<span id="cb2-376"><a href="#cb2-376" aria-hidden="true" tabindex="-1"></a><span class="co"># Refit the Cox model using only selected variables</span></span>
<span id="cb2-377"><a href="#cb2-377" aria-hidden="true" tabindex="-1"></a>obj_lasso <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> <span class="fu">as.matrix</span>(train[, selected_vars]), </span>
<span id="cb2-378"><a href="#cb2-378" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> train)</span>
<span id="cb2-379"><a href="#cb2-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-380"><a href="#cb2-380" aria-hidden="true" tabindex="-1"></a><span class="co"># Get risk scores in test set</span></span>
<span id="cb2-381"><a href="#cb2-381" aria-hidden="true" tabindex="-1"></a>beta_lasso <span class="ot">&lt;-</span> <span class="fu">coef</span>(obj_lasso)  <span class="co"># fitted coefficients</span></span>
<span id="cb2-382"><a href="#cb2-382" aria-hidden="true" tabindex="-1"></a>test_lasso_rs <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(test[, selected_vars]) <span class="sc">%*%</span> beta_lasso <span class="sc">|&gt;</span> <span class="fu">as.vector</span>()</span>
<span id="cb2-383"><a href="#cb2-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-384"><a href="#cb2-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-385"><a href="#cb2-385" aria-hidden="true" tabindex="-1"></a><span class="co"># Metrics data frames ----------------------------------------------------------</span></span>
<span id="cb2-386"><a href="#cb2-386" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 models: Lasso, Full Cox, inadequate Cox (without prog and nodes)</span></span>
<span id="cb2-387"><a href="#cb2-387" aria-hidden="true" tabindex="-1"></a><span class="co">#           survival tree (rpart), random survival forest (rsf), SSVM</span></span>
<span id="cb2-388"><a href="#cb2-388" aria-hidden="true" tabindex="-1"></a><span class="co"># For each model, we will compute C-index (Harrell's and Uno's) and Brier Score</span></span>
<span id="cb2-389"><a href="#cb2-389" aria-hidden="true" tabindex="-1"></a>c_index_results0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-390"><a href="#cb2-390" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">character</span>(),</span>
<span id="cb2-391"><a href="#cb2-391" aria-hidden="true" tabindex="-1"></a>  <span class="at">Harrell_C =</span> <span class="fu">numeric</span>(),</span>
<span id="cb2-392"><a href="#cb2-392" aria-hidden="true" tabindex="-1"></a>  <span class="at">Uno_C_60 =</span> <span class="fu">numeric</span>()</span>
<span id="cb2-393"><a href="#cb2-393" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-394"><a href="#cb2-394" aria-hidden="true" tabindex="-1"></a>brier_score_results0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-395"><a href="#cb2-395" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">character</span>(),</span>
<span id="cb2-396"><a href="#cb2-396" aria-hidden="true" tabindex="-1"></a>  <span class="at">Time =</span> <span class="fu">integer</span>(),</span>
<span id="cb2-397"><a href="#cb2-397" aria-hidden="true" tabindex="-1"></a>  <span class="at">Brier_Score =</span> <span class="fu">numeric</span>()</span>
<span id="cb2-398"><a href="#cb2-398" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-399"><a href="#cb2-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-400"><a href="#cb2-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-401"><a href="#cb2-401" aria-hidden="true" tabindex="-1"></a><span class="co"># C index </span></span>
<span id="cb2-402"><a href="#cb2-402" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.65827</span></span>
<span id="cb2-403"><a href="#cb2-403" aria-hidden="true" tabindex="-1"></a><span class="co"># Harrell's C</span></span>
<span id="cb2-404"><a href="#cb2-404" aria-hidden="true" tabindex="-1"></a>lasso_harrell_c <span class="ot">&lt;-</span> <span class="fu">Cindex_fun</span>(<span class="at">riskscore =</span> test_lasso_rs,</span>
<span id="cb2-405"><a href="#cb2-405" aria-hidden="true" tabindex="-1"></a>            <span class="at">time      =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-406"><a href="#cb2-406" aria-hidden="true" tabindex="-1"></a>            <span class="at">status    =</span> test<span class="sc">$</span>status)</span>
<span id="cb2-407"><a href="#cb2-407" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 0.6583023</span></span>
<span id="cb2-408"><a href="#cb2-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-409"><a href="#cb2-409" aria-hidden="true" tabindex="-1"></a><span class="co"># Uno's C at tau = 60</span></span>
<span id="cb2-410"><a href="#cb2-410" aria-hidden="true" tabindex="-1"></a>lasso_uno_c_60 <span class="ot">&lt;-</span> <span class="fu">Cindex_fun</span>(<span class="at">timepoints =</span> <span class="dv">60</span>,</span>
<span id="cb2-411"><a href="#cb2-411" aria-hidden="true" tabindex="-1"></a>            <span class="at">riskscore  =</span> test_lasso_rs,</span>
<span id="cb2-412"><a href="#cb2-412" aria-hidden="true" tabindex="-1"></a>            <span class="at">time       =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-413"><a href="#cb2-413" aria-hidden="true" tabindex="-1"></a>            <span class="at">status     =</span> test<span class="sc">$</span>status)</span>
<span id="cb2-414"><a href="#cb2-414" aria-hidden="true" tabindex="-1"></a><span class="co">#   tau         C</span></span>
<span id="cb2-415"><a href="#cb2-415" aria-hidden="true" tabindex="-1"></a><span class="co"># 1  60 0.6449649</span></span>
<span id="cb2-416"><a href="#cb2-416" aria-hidden="true" tabindex="-1"></a><span class="co"># Store results</span></span>
<span id="cb2-417"><a href="#cb2-417" aria-hidden="true" tabindex="-1"></a>c_index_results1 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb2-418"><a href="#cb2-418" aria-hidden="true" tabindex="-1"></a>  c_index_results0,</span>
<span id="cb2-419"><a href="#cb2-419" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb2-420"><a href="#cb2-420" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model =</span> <span class="st">"Cox-Lasso"</span>,</span>
<span id="cb2-421"><a href="#cb2-421" aria-hidden="true" tabindex="-1"></a>    <span class="at">Harrell_C =</span> lasso_harrell_c,</span>
<span id="cb2-422"><a href="#cb2-422" aria-hidden="true" tabindex="-1"></a>    <span class="at">Uno_C_60 =</span> lasso_uno_c_60<span class="sc">$</span>C</span>
<span id="cb2-423"><a href="#cb2-423" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-424"><a href="#cb2-424" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-425"><a href="#cb2-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-426"><a href="#cb2-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-427"><a href="#cb2-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-428"><a href="#cb2-428" aria-hidden="true" tabindex="-1"></a><span class="co">#==============================================================================</span></span>
<span id="cb2-429"><a href="#cb2-429" aria-hidden="true" tabindex="-1"></a><span class="co"># (B) Brier Score Calculation for Lasso </span></span>
<span id="cb2-430"><a href="#cb2-430" aria-hidden="true" tabindex="-1"></a><span class="co">#==============================================================================</span></span>
<span id="cb2-431"><a href="#cb2-431" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-432"><a href="#cb2-432" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Lasso-Fitted Model's Predictions on Test Data</span></span>
<span id="cb2-433"><a href="#cb2-433" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-434"><a href="#cb2-434" aria-hidden="true" tabindex="-1"></a>pred_lasso <span class="ot">&lt;-</span> <span class="fu">predsurv_cox</span>(</span>
<span id="cb2-435"><a href="#cb2-435" aria-hidden="true" tabindex="-1"></a>  obj_lasso,</span>
<span id="cb2-436"><a href="#cb2-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>(test[, selected_vars])</span>
<span id="cb2-437"><a href="#cb2-437" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-438"><a href="#cb2-438" aria-hidden="true" tabindex="-1"></a>St_lasso <span class="ot">&lt;-</span> pred_lasso<span class="sc">$</span>St</span>
<span id="cb2-439"><a href="#cb2-439" aria-hidden="true" tabindex="-1"></a>t_lasso  <span class="ot">&lt;-</span> pred_lasso<span class="sc">$</span>t</span>
<span id="cb2-440"><a href="#cb2-440" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-441"><a href="#cb2-441" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Evaluate Brier Score for Cox-Lasso at times 12..60</span></span>
<span id="cb2-442"><a href="#cb2-442" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-443"><a href="#cb2-443" aria-hidden="true" tabindex="-1"></a>timepoints     <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">60</span></span>
<span id="cb2-444"><a href="#cb2-444" aria-hidden="true" tabindex="-1"></a>brier_score_lasso <span class="ot">&lt;-</span> <span class="fu">BSfun</span>(</span>
<span id="cb2-445"><a href="#cb2-445" aria-hidden="true" tabindex="-1"></a>  <span class="at">timepoints =</span> timepoints,</span>
<span id="cb2-446"><a href="#cb2-446" aria-hidden="true" tabindex="-1"></a>    <span class="at">time   =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-447"><a href="#cb2-447" aria-hidden="true" tabindex="-1"></a>    <span class="at">status =</span> test<span class="sc">$</span>status,</span>
<span id="cb2-448"><a href="#cb2-448" aria-hidden="true" tabindex="-1"></a>    <span class="at">St     =</span> St_lasso,</span>
<span id="cb2-449"><a href="#cb2-449" aria-hidden="true" tabindex="-1"></a>    <span class="at">t      =</span> t_lasso</span>
<span id="cb2-450"><a href="#cb2-450" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-451"><a href="#cb2-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-452"><a href="#cb2-452" aria-hidden="true" tabindex="-1"></a>brier_score_results1 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb2-453"><a href="#cb2-453" aria-hidden="true" tabindex="-1"></a>  brier_score_results0,</span>
<span id="cb2-454"><a href="#cb2-454" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb2-455"><a href="#cb2-455" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model =</span> <span class="fu">rep</span>(<span class="st">"Cox-Lasso"</span>, <span class="fu">length</span>(timepoints)),</span>
<span id="cb2-456"><a href="#cb2-456" aria-hidden="true" tabindex="-1"></a>    <span class="at">Time =</span> timepoints,</span>
<span id="cb2-457"><a href="#cb2-457" aria-hidden="true" tabindex="-1"></a>    <span class="at">Brier_Score =</span> brier_score_lasso</span>
<span id="cb2-458"><a href="#cb2-458" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-459"><a href="#cb2-459" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-460"><a href="#cb2-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-461"><a href="#cb2-461" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-462"><a href="#cb2-462" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Full Cox Model</span></span>
<span id="cb2-463"><a href="#cb2-463" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-464"><a href="#cb2-464" aria-hidden="true" tabindex="-1"></a>obj_full <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(train<span class="sc">$</span>time, train<span class="sc">$</span>status) <span class="sc">~</span> <span class="fu">as.matrix</span>(train[, pred_list]))</span>
<span id="cb2-465"><a href="#cb2-465" aria-hidden="true" tabindex="-1"></a><span class="co"># Get risk scores in test set</span></span>
<span id="cb2-466"><a href="#cb2-466" aria-hidden="true" tabindex="-1"></a>beta_full <span class="ot">&lt;-</span> <span class="fu">coef</span>(obj_full)  <span class="co"># fitted coefficients</span></span>
<span id="cb2-467"><a href="#cb2-467" aria-hidden="true" tabindex="-1"></a>test_full_rs <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(test[, pred_list]) <span class="sc">%*%</span> beta_full <span class="sc">|&gt;</span> <span class="fu">as.vector</span>()</span>
<span id="cb2-468"><a href="#cb2-468" aria-hidden="true" tabindex="-1"></a><span class="co"># C index</span></span>
<span id="cb2-469"><a href="#cb2-469" aria-hidden="true" tabindex="-1"></a><span class="co"># Harrell's C</span></span>
<span id="cb2-470"><a href="#cb2-470" aria-hidden="true" tabindex="-1"></a>full_harrell_c <span class="ot">&lt;-</span> <span class="fu">Cindex_fun</span>(<span class="at">riskscore =</span> test_full_rs,</span>
<span id="cb2-471"><a href="#cb2-471" aria-hidden="true" tabindex="-1"></a>            <span class="at">time      =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-472"><a href="#cb2-472" aria-hidden="true" tabindex="-1"></a>            <span class="at">status    =</span> test<span class="sc">$</span>status)</span>
<span id="cb2-473"><a href="#cb2-473" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 0.6568314</span></span>
<span id="cb2-474"><a href="#cb2-474" aria-hidden="true" tabindex="-1"></a><span class="co"># Uno's C at tau = 60</span></span>
<span id="cb2-475"><a href="#cb2-475" aria-hidden="true" tabindex="-1"></a>full_uno_c_60 <span class="ot">&lt;-</span> <span class="fu">Cindex_fun</span>(<span class="at">timepoints =</span> <span class="dv">60</span>,</span>
<span id="cb2-476"><a href="#cb2-476" aria-hidden="true" tabindex="-1"></a>            <span class="at">riskscore  =</span> test_full_rs,</span>
<span id="cb2-477"><a href="#cb2-477" aria-hidden="true" tabindex="-1"></a>            <span class="at">time       =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-478"><a href="#cb2-478" aria-hidden="true" tabindex="-1"></a>            <span class="at">status     =</span> test<span class="sc">$</span>status)</span>
<span id="cb2-479"><a href="#cb2-479" aria-hidden="true" tabindex="-1"></a><span class="co">#   tau        C</span></span>
<span id="cb2-480"><a href="#cb2-480" aria-hidden="true" tabindex="-1"></a><span class="co"># 1  60 0.648307</span></span>
<span id="cb2-481"><a href="#cb2-481" aria-hidden="true" tabindex="-1"></a>c_index_results2 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb2-482"><a href="#cb2-482" aria-hidden="true" tabindex="-1"></a>  c_index_results1,</span>
<span id="cb2-483"><a href="#cb2-483" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb2-484"><a href="#cb2-484" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model =</span> <span class="st">"Full Cox"</span>,</span>
<span id="cb2-485"><a href="#cb2-485" aria-hidden="true" tabindex="-1"></a>    <span class="at">Harrell_C =</span> full_harrell_c,</span>
<span id="cb2-486"><a href="#cb2-486" aria-hidden="true" tabindex="-1"></a>    <span class="at">Uno_C_60 =</span> full_uno_c_60<span class="sc">$</span>C</span>
<span id="cb2-487"><a href="#cb2-487" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-488"><a href="#cb2-488" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-489"><a href="#cb2-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-490"><a href="#cb2-490" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Brier Score for Full Cox</span></span>
<span id="cb2-491"><a href="#cb2-491" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted survival in test set</span></span>
<span id="cb2-492"><a href="#cb2-492" aria-hidden="true" tabindex="-1"></a>pred_full <span class="ot">&lt;-</span> <span class="fu">predsurv_cox</span>(obj_full, <span class="fu">as.matrix</span>(test[, pred_list]))</span>
<span id="cb2-493"><a href="#cb2-493" aria-hidden="true" tabindex="-1"></a>St_full   <span class="ot">&lt;-</span> pred_full<span class="sc">$</span>St</span>
<span id="cb2-494"><a href="#cb2-494" aria-hidden="true" tabindex="-1"></a>t_full    <span class="ot">&lt;-</span> pred_full<span class="sc">$</span>t</span>
<span id="cb2-495"><a href="#cb2-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-496"><a href="#cb2-496" aria-hidden="true" tabindex="-1"></a><span class="co"># Brier Score for the full Cox</span></span>
<span id="cb2-497"><a href="#cb2-497" aria-hidden="true" tabindex="-1"></a>brier_score_full <span class="ot">&lt;-</span> <span class="fu">BSfun</span>(</span>
<span id="cb2-498"><a href="#cb2-498" aria-hidden="true" tabindex="-1"></a>    <span class="at">timepoints    =</span> timepoints,</span>
<span id="cb2-499"><a href="#cb2-499" aria-hidden="true" tabindex="-1"></a>    <span class="at">time   =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-500"><a href="#cb2-500" aria-hidden="true" tabindex="-1"></a>    <span class="at">status =</span> test<span class="sc">$</span>status,</span>
<span id="cb2-501"><a href="#cb2-501" aria-hidden="true" tabindex="-1"></a>    <span class="at">St     =</span> St_full,</span>
<span id="cb2-502"><a href="#cb2-502" aria-hidden="true" tabindex="-1"></a>    <span class="at">t      =</span> t_full</span>
<span id="cb2-503"><a href="#cb2-503" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-504"><a href="#cb2-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-505"><a href="#cb2-505" aria-hidden="true" tabindex="-1"></a>brier_score_results2 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb2-506"><a href="#cb2-506" aria-hidden="true" tabindex="-1"></a>  brier_score_results1,</span>
<span id="cb2-507"><a href="#cb2-507" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb2-508"><a href="#cb2-508" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model =</span> <span class="fu">rep</span>(<span class="st">"Full Cox"</span>, <span class="fu">length</span>(timepoints)),</span>
<span id="cb2-509"><a href="#cb2-509" aria-hidden="true" tabindex="-1"></a>    <span class="at">Time =</span> timepoints,</span>
<span id="cb2-510"><a href="#cb2-510" aria-hidden="true" tabindex="-1"></a>    <span class="at">Brier_Score =</span> brier_score_full</span>
<span id="cb2-511"><a href="#cb2-511" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-512"><a href="#cb2-512" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-513"><a href="#cb2-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-514"><a href="#cb2-514" aria-hidden="true" tabindex="-1"></a><span class="co"># An inadequate Cox model (without prog and nodes)</span></span>
<span id="cb2-515"><a href="#cb2-515" aria-hidden="true" tabindex="-1"></a>obj_inadequate <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(train<span class="sc">$</span>time, train<span class="sc">$</span>status) <span class="sc">~</span> <span class="fu">as.matrix</span>(train[, <span class="fu">c</span>(<span class="st">"hormone"</span>, <span class="st">"age40"</span>, <span class="st">"meno"</span>, <span class="st">"size"</span>, <span class="st">"grade"</span>, <span class="st">"estrg"</span>)]))</span>
<span id="cb2-516"><a href="#cb2-516" aria-hidden="true" tabindex="-1"></a><span class="co"># Get risk scores in test set</span></span>
<span id="cb2-517"><a href="#cb2-517" aria-hidden="true" tabindex="-1"></a>beta_inadequate <span class="ot">&lt;-</span> <span class="fu">coef</span>(obj_inadequate)  <span class="co"># fitted coefficients</span></span>
<span id="cb2-518"><a href="#cb2-518" aria-hidden="true" tabindex="-1"></a>test_inadequate_rs <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(test[, <span class="fu">c</span>(<span class="st">"hormone"</span>, <span class="st">"age40"</span>, <span class="st">"meno"</span>, <span class="st">"size"</span>, <span class="st">"grade"</span>, <span class="st">"estrg"</span>)]) <span class="sc">%*%</span> beta_inadequate <span class="sc">|&gt;</span> <span class="fu">as.vector</span>()</span>
<span id="cb2-519"><a href="#cb2-519" aria-hidden="true" tabindex="-1"></a><span class="co"># C index</span></span>
<span id="cb2-520"><a href="#cb2-520" aria-hidden="true" tabindex="-1"></a><span class="co"># Harrell's C</span></span>
<span id="cb2-521"><a href="#cb2-521" aria-hidden="true" tabindex="-1"></a>inadequate_harrell_c <span class="ot">&lt;-</span> <span class="fu">Cindex_fun</span>(<span class="at">riskscore =</span> test_inadequate_rs,</span>
<span id="cb2-522"><a href="#cb2-522" aria-hidden="true" tabindex="-1"></a>            <span class="at">time      =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-523"><a href="#cb2-523" aria-hidden="true" tabindex="-1"></a>            <span class="at">status    =</span> test<span class="sc">$</span>status)</span>
<span id="cb2-524"><a href="#cb2-524" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 0.602081</span></span>
<span id="cb2-525"><a href="#cb2-525" aria-hidden="true" tabindex="-1"></a><span class="co"># Uno's C at tau = 60</span></span>
<span id="cb2-526"><a href="#cb2-526" aria-hidden="true" tabindex="-1"></a>inadequate_uno_c_60 <span class="ot">&lt;-</span> <span class="fu">Cindex_fun</span>(<span class="at">timepoints =</span> <span class="dv">60</span>,</span>
<span id="cb2-527"><a href="#cb2-527" aria-hidden="true" tabindex="-1"></a>            <span class="at">riskscore  =</span> test_inadequate_rs,</span>
<span id="cb2-528"><a href="#cb2-528" aria-hidden="true" tabindex="-1"></a>            <span class="at">time       =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-529"><a href="#cb2-529" aria-hidden="true" tabindex="-1"></a>            <span class="at">status     =</span> test<span class="sc">$</span>status)</span>
<span id="cb2-530"><a href="#cb2-530" aria-hidden="true" tabindex="-1"></a><span class="co"># Store results</span></span>
<span id="cb2-531"><a href="#cb2-531" aria-hidden="true" tabindex="-1"></a>c_index_results3 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb2-532"><a href="#cb2-532" aria-hidden="true" tabindex="-1"></a>  c_index_results2,</span>
<span id="cb2-533"><a href="#cb2-533" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb2-534"><a href="#cb2-534" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model =</span> <span class="st">"Inadequate Cox"</span>,</span>
<span id="cb2-535"><a href="#cb2-535" aria-hidden="true" tabindex="-1"></a>    <span class="at">Harrell_C =</span> inadequate_harrell_c,</span>
<span id="cb2-536"><a href="#cb2-536" aria-hidden="true" tabindex="-1"></a>    <span class="at">Uno_C_60 =</span> inadequate_uno_c_60<span class="sc">$</span>C</span>
<span id="cb2-537"><a href="#cb2-537" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-538"><a href="#cb2-538" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-539"><a href="#cb2-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-540"><a href="#cb2-540" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Brier Score for Inadequate Cox</span></span>
<span id="cb2-541"><a href="#cb2-541" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted survival in test set</span></span>
<span id="cb2-542"><a href="#cb2-542" aria-hidden="true" tabindex="-1"></a>pred_inadequate <span class="ot">&lt;-</span> <span class="fu">predsurv_cox</span>(obj_inadequate, <span class="fu">as.matrix</span>(test[, <span class="fu">c</span>(<span class="st">"hormone"</span>, <span class="st">"age40"</span>, <span class="st">"meno"</span>, <span class="st">"size"</span>, <span class="st">"grade"</span>, <span class="st">"estrg"</span>)]))</span>
<span id="cb2-543"><a href="#cb2-543" aria-hidden="true" tabindex="-1"></a>St_inadequate   <span class="ot">&lt;-</span> pred_inadequate<span class="sc">$</span>St</span>
<span id="cb2-544"><a href="#cb2-544" aria-hidden="true" tabindex="-1"></a>t_inadequate    <span class="ot">&lt;-</span> pred_inadequate<span class="sc">$</span>t</span>
<span id="cb2-545"><a href="#cb2-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-546"><a href="#cb2-546" aria-hidden="true" tabindex="-1"></a>brier_score_inadequate <span class="ot">&lt;-</span> <span class="fu">BSfun</span>(</span>
<span id="cb2-547"><a href="#cb2-547" aria-hidden="true" tabindex="-1"></a>    <span class="at">timepoints     =</span> timepoints,</span>
<span id="cb2-548"><a href="#cb2-548" aria-hidden="true" tabindex="-1"></a>    <span class="at">time   =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-549"><a href="#cb2-549" aria-hidden="true" tabindex="-1"></a>    <span class="at">status =</span> test<span class="sc">$</span>status,</span>
<span id="cb2-550"><a href="#cb2-550" aria-hidden="true" tabindex="-1"></a>    <span class="at">St     =</span> St_inadequate,</span>
<span id="cb2-551"><a href="#cb2-551" aria-hidden="true" tabindex="-1"></a>    <span class="at">t      =</span> t_inadequate</span>
<span id="cb2-552"><a href="#cb2-552" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb2-553"><a href="#cb2-553" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-554"><a href="#cb2-554" aria-hidden="true" tabindex="-1"></a>brier_score_results3 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb2-555"><a href="#cb2-555" aria-hidden="true" tabindex="-1"></a>  brier_score_results2,</span>
<span id="cb2-556"><a href="#cb2-556" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb2-557"><a href="#cb2-557" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model =</span> <span class="fu">rep</span>(<span class="st">"Inadequate Cox"</span>, <span class="fu">length</span>(timepoints)),</span>
<span id="cb2-558"><a href="#cb2-558" aria-hidden="true" tabindex="-1"></a>    <span class="at">Time =</span> timepoints,</span>
<span id="cb2-559"><a href="#cb2-559" aria-hidden="true" tabindex="-1"></a>    <span class="at">Brier_Score =</span> brier_score_inadequate</span>
<span id="cb2-560"><a href="#cb2-560" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-561"><a href="#cb2-561" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-562"><a href="#cb2-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-563"><a href="#cb2-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-564"><a href="#cb2-564" aria-hidden="true" tabindex="-1"></a><span class="co">#==============================================================================</span></span>
<span id="cb2-565"><a href="#cb2-565" aria-hidden="true" tabindex="-1"></a><span class="co"># (C) Survival Tree Analysis</span></span>
<span id="cb2-566"><a href="#cb2-566" aria-hidden="true" tabindex="-1"></a><span class="co">#==============================================================================</span></span>
<span id="cb2-567"><a href="#cb2-567" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb2-568"><a href="#cb2-568" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span>
<span id="cb2-569"><a href="#cb2-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-570"><a href="#cb2-570" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-571"><a href="#cb2-571" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Building a Survival Tree (Train Set)</span></span>
<span id="cb2-572"><a href="#cb2-572" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-573"><a href="#cb2-573" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)  <span class="co"># for reproducibility</span></span>
<span id="cb2-574"><a href="#cb2-574" aria-hidden="true" tabindex="-1"></a>obj_tree <span class="ot">&lt;-</span> <span class="fu">rpart</span>(</span>
<span id="cb2-575"><a href="#cb2-575" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(time, status) <span class="sc">~</span> hormone <span class="sc">+</span> meno <span class="sc">+</span> size <span class="sc">+</span> grade <span class="sc">+</span> nodes <span class="sc">+</span> prog <span class="sc">+</span> estrg <span class="sc">+</span> age,</span>
<span id="cb2-576"><a href="#cb2-576" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">xval =</span> <span class="dv">10</span>, <span class="at">minbucket =</span> <span class="dv">2</span>, <span class="at">cp =</span> <span class="dv">0</span>),</span>
<span id="cb2-577"><a href="#cb2-577" aria-hidden="true" tabindex="-1"></a>  <span class="at">data    =</span> train</span>
<span id="cb2-578"><a href="#cb2-578" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-579"><a href="#cb2-579" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the tree object</span></span>
<span id="cb2-580"><a href="#cb2-580" aria-hidden="true" tabindex="-1"></a><span class="fu">printcp</span>(obj_tree)  <span class="co"># shows the cross-validation results</span></span>
<span id="cb2-581"><a href="#cb2-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-582"><a href="#cb2-582" aria-hidden="true" tabindex="-1"></a>cptable <span class="ot">&lt;-</span> obj_tree<span class="sc">$</span>cptable</span>
<span id="cb2-583"><a href="#cb2-583" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(cptable)</span>
<span id="cb2-584"><a href="#cb2-584" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "CP"        "nsplit"    "rel error" "xerror"    "xstd"</span></span>
<span id="cb2-585"><a href="#cb2-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-586"><a href="#cb2-586" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify the complexity parameter that yields minimal xerror</span></span>
<span id="cb2-587"><a href="#cb2-587" aria-hidden="true" tabindex="-1"></a>cptable  <span class="ot">&lt;-</span> obj_tree<span class="sc">$</span>cptable <span class="sc">|&gt;</span> </span>
<span id="cb2-588"><a href="#cb2-588" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb2-589"><a href="#cb2-589" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb2-590"><a href="#cb2-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-591"><a href="#cb2-591" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify optimal CP (min CV error)</span></span>
<span id="cb2-592"><a href="#cb2-592" aria-hidden="true" tabindex="-1"></a>cp_opt <span class="ot">&lt;-</span> cptable[<span class="fu">which.min</span>(cptable<span class="sc">$</span>xerror), <span class="st">"CP"</span>]</span>
<span id="cb2-593"><a href="#cb2-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-594"><a href="#cb2-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-595"><a href="#cb2-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-596"><a href="#cb2-596" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot CV error vs CP</span></span>
<span id="cb2-597"><a href="#cb2-597" aria-hidden="true" tabindex="-1"></a>tree_cv <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(cptable, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(CP), <span class="at">y =</span> xerror)) <span class="sc">+</span></span>
<span id="cb2-598"><a href="#cb2-598" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb2-599"><a href="#cb2-599" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb2-600"><a href="#cb2-600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">log</span>(cp_opt), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb2-601"><a href="#cb2-601" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_reverse</span>() <span class="sc">+</span></span>
<span id="cb2-602"><a href="#cb2-602" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-603"><a href="#cb2-603" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">log</span>(lambda)),</span>
<span id="cb2-604"><a href="#cb2-604" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Cross-validated relative error"</span></span>
<span id="cb2-605"><a href="#cb2-605" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-606"><a href="#cb2-606" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb2-607"><a href="#cb2-607" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb2-608"><a href="#cb2-608" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb2-609"><a href="#cb2-609" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>)</span>
<span id="cb2-610"><a href="#cb2-610" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-611"><a href="#cb2-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-612"><a href="#cb2-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-613"><a href="#cb2-613" aria-hidden="true" tabindex="-1"></a><span class="co"># Prune the tree using cp.opt</span></span>
<span id="cb2-614"><a href="#cb2-614" aria-hidden="true" tabindex="-1"></a>fit_tree <span class="ot">&lt;-</span> <span class="fu">prune</span>(obj_tree, <span class="at">cp =</span> cp_opt)</span>
<span id="cb2-615"><a href="#cb2-615" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(fit_tree)</span>
<span id="cb2-616"><a href="#cb2-616" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "rpart"</span></span>
<span id="cb2-617"><a href="#cb2-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-618"><a href="#cb2-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-619"><a href="#cb2-619" aria-hidden="true" tabindex="-1"></a><span class="co"># ?rpart</span></span>
<span id="cb2-620"><a href="#cb2-620" aria-hidden="true" tabindex="-1"></a><span class="co"># fit_tree$frame</span></span>
<span id="cb2-621"><a href="#cb2-621" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-622"><a href="#cb2-622" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Visualize the Pruned Tree and KM Curves</span></span>
<span id="cb2-623"><a href="#cb2-623" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-624"><a href="#cb2-624" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the tree structure</span></span>
<span id="cb2-625"><a href="#cb2-625" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(fit_tree)</span>
<span id="cb2-626"><a href="#cb2-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-627"><a href="#cb2-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-628"><a href="#cb2-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-629"><a href="#cb2-629" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine tree_cv and p_tree_manual by 40% vs 60% width</span></span>
<span id="cb2-630"><a href="#cb2-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-631"><a href="#cb2-631" aria-hidden="true" tabindex="-1"></a><span class="co"># fig_gbc_tree &lt;- tree_cv + p_tree_manual +</span></span>
<span id="cb2-632"><a href="#cb2-632" aria-hidden="true" tabindex="-1"></a><span class="co">#   plot_layout(widths = c(0.4, 0.6))</span></span>
<span id="cb2-633"><a href="#cb2-633" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb2-634"><a href="#cb2-634" aria-hidden="true" tabindex="-1"></a><span class="co"># fig_gbc_tree</span></span>
<span id="cb2-635"><a href="#cb2-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-636"><a href="#cb2-636" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("images/ml_rpart_gbc.png", fig_gbc_tree,</span></span>
<span id="cb2-637"><a href="#cb2-637" aria-hidden="true" tabindex="-1"></a><span class="co">#        width = 8, height = 4, dpi = 300)</span></span>
<span id="cb2-638"><a href="#cb2-638" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("images/ml_rpart_gbc.eps", fig_gbc_tree, device = cairo_ps,</span></span>
<span id="cb2-639"><a href="#cb2-639" aria-hidden="true" tabindex="-1"></a><span class="co">#        width = 8, height = 4)</span></span>
<span id="cb2-640"><a href="#cb2-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-641"><a href="#cb2-641" aria-hidden="true" tabindex="-1"></a><span class="co"># Variable importance</span></span>
<span id="cb2-642"><a href="#cb2-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-643"><a href="#cb2-643" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit_tree<span class="sc">$</span>variable.importance)</span>
<span id="cb2-644"><a href="#cb2-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-645"><a href="#cb2-645" aria-hidden="true" tabindex="-1"></a>fit_tree</span>
<span id="cb2-646"><a href="#cb2-646" aria-hidden="true" tabindex="-1"></a>fit_tree<span class="sc">$</span>where  <span class="co"># terminal node assignments for training subjects</span></span>
<span id="cb2-647"><a href="#cb2-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-648"><a href="#cb2-648" aria-hidden="true" tabindex="-1"></a><span class="co"># Map row numbers in fit_tree$frame to node numbers</span></span>
<span id="cb2-649"><a href="#cb2-649" aria-hidden="true" tabindex="-1"></a>where_to_nodes <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit_tree<span class="sc">$</span>frame)  <span class="co"># node numbers</span></span>
<span id="cb2-650"><a href="#cb2-650" aria-hidden="true" tabindex="-1"></a>term_nodes_train <span class="ot">&lt;-</span> where_to_nodes[fit_tree<span class="sc">$</span>where] <span class="co"># terminal node number for each subject</span></span>
<span id="cb2-651"><a href="#cb2-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-652"><a href="#cb2-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-653"><a href="#cb2-653" aria-hidden="true" tabindex="-1"></a>train<span class="sc">$</span>.term_node <span class="ot">&lt;-</span> term_nodes_train <span class="co"># add to node info to training set</span></span>
<span id="cb2-654"><a href="#cb2-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-655"><a href="#cb2-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-656"><a href="#cb2-656" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a KM in each terminal node =&gt; helpful to see the survival in each leaf</span></span>
<span id="cb2-657"><a href="#cb2-657" aria-hidden="true" tabindex="-1"></a>km_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> .term_node, <span class="at">data =</span> train)</span>
<span id="cb2-658"><a href="#cb2-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-659"><a href="#cb2-659" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb2-660"><a href="#cb2-660" aria-hidden="true" tabindex="-1"></a>  km_fit,</span>
<span id="cb2-661"><a href="#cb2-661" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty      =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,</span>
<span id="cb2-662"><a href="#cb2-662" aria-hidden="true" tabindex="-1"></a>  <span class="at">mark.time=</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-663"><a href="#cb2-663" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab     =</span> <span class="st">"Time (years)"</span>,</span>
<span id="cb2-664"><a href="#cb2-664" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab     =</span> <span class="st">"Relapse-free survival"</span>,</span>
<span id="cb2-665"><a href="#cb2-665" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd      =</span> <span class="dv">2</span>,</span>
<span id="cb2-666"><a href="#cb2-666" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex.lab  =</span> <span class="fl">1.2</span>,</span>
<span id="cb2-667"><a href="#cb2-667" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex.axis =</span> <span class="fl">1.2</span></span>
<span id="cb2-668"><a href="#cb2-668" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-669"><a href="#cb2-669" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb2-670"><a href="#cb2-670" aria-hidden="true" tabindex="-1"></a>  <span class="st">"bottomleft"</span>,</span>
<span id="cb2-671"><a href="#cb2-671" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">sort</span>(<span class="fu">unique</span>(term_nodes_train))),</span>
<span id="cb2-672"><a href="#cb2-672" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,</span>
<span id="cb2-673"><a href="#cb2-673" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb2-674"><a href="#cb2-674" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">1.2</span></span>
<span id="cb2-675"><a href="#cb2-675" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-676"><a href="#cb2-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-677"><a href="#cb2-677" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("ggsurvfit")</span></span>
<span id="cb2-678"><a href="#cb2-678" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot version</span></span>
<span id="cb2-679"><a href="#cb2-679" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggsurvfit)</span>
<span id="cb2-680"><a href="#cb2-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-681"><a href="#cb2-681" aria-hidden="true" tabindex="-1"></a>fig_km_tree <span class="ot">&lt;-</span> <span class="fu">survfit2</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> .term_node, </span>
<span id="cb2-682"><a href="#cb2-682" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> train <span class="sc">|&gt;</span> </span>
<span id="cb2-683"><a href="#cb2-683" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">mutate</span>(<span class="at">.term_node =</span> <span class="fu">str_c</span>(<span class="st">"Node "</span>, .term_node))) <span class="sc">|&gt;</span> </span>
<span id="cb2-684"><a href="#cb2-684" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsurvfit</span>(<span class="at">linetype_aes =</span> <span class="cn">TRUE</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb2-685"><a href="#cb2-685" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-686"><a href="#cb2-686" aria-hidden="true" tabindex="-1"></a>  <span class="do">## --- manual labels + arrows on the KM panel -----------------------------</span></span>
<span id="cb2-687"><a href="#cb2-687" aria-hidden="true" tabindex="-1"></a>  <span class="co"># High risk (assume lowest curve)</span></span>
<span id="cb2-688"><a href="#cb2-688" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb2-689"><a href="#cb2-689" aria-hidden="true" tabindex="-1"></a>    <span class="st">"text"</span>,</span>
<span id="cb2-690"><a href="#cb2-690" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="dv">18</span>, <span class="at">y =</span> <span class="fl">0.25</span>,</span>
<span id="cb2-691"><a href="#cb2-691" aria-hidden="true" tabindex="-1"></a>    <span class="at">label   =</span> <span class="st">"High risk"</span>,</span>
<span id="cb2-692"><a href="#cb2-692" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust   =</span> <span class="dv">1</span>,</span>
<span id="cb2-693"><a href="#cb2-693" aria-hidden="true" tabindex="-1"></a>    <span class="at">size    =</span> <span class="dv">4</span></span>
<span id="cb2-694"><a href="#cb2-694" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-695"><a href="#cb2-695" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_curve</span>(</span>
<span id="cb2-696"><a href="#cb2-696" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-697"><a href="#cb2-697" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">rep</span>(<span class="dv">19</span>, <span class="dv">2</span>), </span>
<span id="cb2-698"><a href="#cb2-698" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">rep</span>(<span class="fl">0.25</span>, <span class="dv">2</span>), </span>
<span id="cb2-699"><a href="#cb2-699" aria-hidden="true" tabindex="-1"></a>      <span class="at">xend =</span> <span class="fu">c</span>(<span class="dv">26</span>, <span class="dv">26</span>), </span>
<span id="cb2-700"><a href="#cb2-700" aria-hidden="true" tabindex="-1"></a>      <span class="at">yend =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.4</span>)</span>
<span id="cb2-701"><a href="#cb2-701" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb2-702"><a href="#cb2-702" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend),</span>
<span id="cb2-703"><a href="#cb2-703" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrow     =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.15</span>, <span class="st">"cm"</span>)),</span>
<span id="cb2-704"><a href="#cb2-704" aria-hidden="true" tabindex="-1"></a>    <span class="at">curvature =</span> <span class="dv">0</span></span>
<span id="cb2-705"><a href="#cb2-705" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-706"><a href="#cb2-706" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-707"><a href="#cb2-707" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Moderate risk</span></span>
<span id="cb2-708"><a href="#cb2-708" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb2-709"><a href="#cb2-709" aria-hidden="true" tabindex="-1"></a>    <span class="st">"text"</span>,</span>
<span id="cb2-710"><a href="#cb2-710" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="dv">42</span>, <span class="at">y =</span> <span class="fl">0.5</span>,</span>
<span id="cb2-711"><a href="#cb2-711" aria-hidden="true" tabindex="-1"></a>    <span class="at">label   =</span> <span class="st">"Moderate risk"</span>,</span>
<span id="cb2-712"><a href="#cb2-712" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust   =</span> <span class="fl">0.5</span>,</span>
<span id="cb2-713"><a href="#cb2-713" aria-hidden="true" tabindex="-1"></a>    <span class="at">size    =</span> <span class="dv">4</span></span>
<span id="cb2-714"><a href="#cb2-714" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-715"><a href="#cb2-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-716"><a href="#cb2-716" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-717"><a href="#cb2-717" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Low risk (assume top curve)</span></span>
<span id="cb2-718"><a href="#cb2-718" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb2-719"><a href="#cb2-719" aria-hidden="true" tabindex="-1"></a>    <span class="st">"text"</span>,</span>
<span id="cb2-720"><a href="#cb2-720" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="dv">48</span>, <span class="at">y =</span> <span class="fl">0.75</span>,</span>
<span id="cb2-721"><a href="#cb2-721" aria-hidden="true" tabindex="-1"></a>    <span class="at">label   =</span> <span class="st">"Low risk"</span>,</span>
<span id="cb2-722"><a href="#cb2-722" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust   =</span> <span class="fl">0.5</span>,</span>
<span id="cb2-723"><a href="#cb2-723" aria-hidden="true" tabindex="-1"></a>    <span class="at">size    =</span> <span class="dv">4</span></span>
<span id="cb2-724"><a href="#cb2-724" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-725"><a href="#cb2-725" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ------------------------------------------------------------------------</span></span>
<span id="cb2-726"><a href="#cb2-726" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-727"><a href="#cb2-727" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">72</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">72</span>, <span class="at">by =</span> <span class="dv">12</span>)) <span class="sc">+</span> </span>
<span id="cb2-728"><a href="#cb2-728" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(</span>
<span id="cb2-729"><a href="#cb2-729" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span></span>
<span id="cb2-730"><a href="#cb2-730" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-731"><a href="#cb2-731" aria-hidden="true" tabindex="-1"></a>  <span class="co"># number at risk</span></span>
<span id="cb2-732"><a href="#cb2-732" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_risktable</span>(</span>
<span id="cb2-733"><a href="#cb2-733" aria-hidden="true" tabindex="-1"></a>    <span class="at">risktable_stats =</span> <span class="st">"n.risk"</span>,</span>
<span id="cb2-734"><a href="#cb2-734" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">4</span></span>
<span id="cb2-735"><a href="#cb2-735" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb2-736"><a href="#cb2-736" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-737"><a href="#cb2-737" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time (months)"</span>,</span>
<span id="cb2-738"><a href="#cb2-738" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Relapse-free survival"</span>,</span>
<span id="cb2-739"><a href="#cb2-739" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Leaf"</span>,</span>
<span id="cb2-740"><a href="#cb2-740" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">"Leaf"</span></span>
<span id="cb2-741"><a href="#cb2-741" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-742"><a href="#cb2-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb2-743"><a href="#cb2-743" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb2-744"><a href="#cb2-744" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text     =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>),</span>
<span id="cb2-745"><a href="#cb2-745" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb2-746"><a href="#cb2-746" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.width   =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"cm"</span>),</span>
<span id="cb2-747"><a href="#cb2-747" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-748"><a href="#cb2-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-749"><a href="#cb2-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-750"><a href="#cb2-750" aria-hidden="true" tabindex="-1"></a>fig_km_tree</span>
<span id="cb2-751"><a href="#cb2-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-752"><a href="#cb2-752" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("images/ml_km_tree_gbc.png", fig_km_tree,</span></span>
<span id="cb2-753"><a href="#cb2-753" aria-hidden="true" tabindex="-1"></a><span class="co">#        width = 8, height = 5, dpi = 300)</span></span>
<span id="cb2-754"><a href="#cb2-754" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("images/ml_km_tree_gbc.eps", fig_km_tree, </span></span>
<span id="cb2-755"><a href="#cb2-755" aria-hidden="true" tabindex="-1"></a><span class="co">#        width = 8, height = 5)</span></span>
<span id="cb2-756"><a href="#cb2-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-757"><a href="#cb2-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-758"><a href="#cb2-758" aria-hidden="true" tabindex="-1"></a><span class="co"># combine nodes 5 and 7 into high risk group</span></span>
<span id="cb2-759"><a href="#cb2-759" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> train <span class="sc">|&gt;</span> </span>
<span id="cb2-760"><a href="#cb2-760" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-761"><a href="#cb2-761" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk_group =</span> <span class="fu">case_when</span>(</span>
<span id="cb2-762"><a href="#cb2-762" aria-hidden="true" tabindex="-1"></a>      .term_node <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"5"</span>, <span class="st">"7"</span>) <span class="sc">~</span> <span class="st">"High risk"</span>,</span>
<span id="cb2-763"><a href="#cb2-763" aria-hidden="true" tabindex="-1"></a>      .term_node <span class="sc">==</span> <span class="st">"6"</span>           <span class="sc">~</span> <span class="st">"Moderate risk"</span>,</span>
<span id="cb2-764"><a href="#cb2-764" aria-hidden="true" tabindex="-1"></a>      .term_node <span class="sc">==</span> <span class="st">"4"</span>           <span class="sc">~</span> <span class="st">"Low risk"</span></span>
<span id="cb2-765"><a href="#cb2-765" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-766"><a href="#cb2-766" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-767"><a href="#cb2-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-768"><a href="#cb2-768" aria-hidden="true" tabindex="-1"></a><span class="co"># KM plot by risk group</span></span>
<span id="cb2-769"><a href="#cb2-769" aria-hidden="true" tabindex="-1"></a>km_fit2 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> risk_group, <span class="at">data =</span> train)</span>
<span id="cb2-770"><a href="#cb2-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-771"><a href="#cb2-771" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabulate using gtsummary::tbl_survfit</span></span>
<span id="cb2-772"><a href="#cb2-772" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gtsummary)</span>
<span id="cb2-773"><a href="#cb2-773" aria-hidden="true" tabindex="-1"></a>tbl_surv <span class="ot">&lt;-</span> km_fit2 <span class="sc">|&gt;</span> </span>
<span id="cb2-774"><a href="#cb2-774" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_survfit</span>(                    <span class="co"># Pass `survfit` object</span></span>
<span id="cb2-775"><a href="#cb2-775" aria-hidden="true" tabindex="-1"></a>             <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">24</span>, <span class="dv">60</span>),     <span class="co"># Time points for estimates</span></span>
<span id="cb2-776"><a href="#cb2-776" aria-hidden="true" tabindex="-1"></a>             <span class="at">label_header =</span> <span class="st">"Month {time}"</span> <span class="co"># Column label: "Month xx"</span></span>
<span id="cb2-777"><a href="#cb2-777" aria-hidden="true" tabindex="-1"></a>             ) </span>
<span id="cb2-778"><a href="#cb2-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-779"><a href="#cb2-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-780"><a href="#cb2-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-781"><a href="#cb2-781" aria-hidden="true" tabindex="-1"></a>tbl_surv</span>
<span id="cb2-782"><a href="#cb2-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-783"><a href="#cb2-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-784"><a href="#cb2-784" aria-hidden="true" tabindex="-1"></a><span class="do">## Variable importance</span></span>
<span id="cb2-785"><a href="#cb2-785" aria-hidden="true" tabindex="-1"></a>vi_surrog <span class="ot">&lt;-</span> fit_tree<span class="sc">$</span>variable.importance</span>
<span id="cb2-786"><a href="#cb2-786" aria-hidden="true" tabindex="-1"></a>vi_surrog <span class="ot">&lt;-</span> vi_surrog <span class="sc">/</span> <span class="fu">sum</span>(vi_surrog) <span class="sc">*</span> <span class="dv">100</span>  <span class="co"># percent importance</span></span>
<span id="cb2-787"><a href="#cb2-787" aria-hidden="true" tabindex="-1"></a><span class="co"># without surrogate splits</span></span>
<span id="cb2-788"><a href="#cb2-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-789"><a href="#cb2-789" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)  <span class="co"># for reproducibility</span></span>
<span id="cb2-790"><a href="#cb2-790" aria-hidden="true" tabindex="-1"></a>obj_tree_no_surrog <span class="ot">&lt;-</span> <span class="fu">rpart</span>(</span>
<span id="cb2-791"><a href="#cb2-791" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(time, status) <span class="sc">~</span> hormone <span class="sc">+</span> meno <span class="sc">+</span> size <span class="sc">+</span> grade <span class="sc">+</span> nodes <span class="sc">+</span> prog <span class="sc">+</span> estrg <span class="sc">+</span> age,</span>
<span id="cb2-792"><a href="#cb2-792" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">xval =</span> <span class="dv">10</span>, <span class="at">minbucket =</span> <span class="dv">2</span>, <span class="at">cp =</span> <span class="dv">0</span>, <span class="at">maxsurrogate =</span> <span class="dv">0</span>),</span>
<span id="cb2-793"><a href="#cb2-793" aria-hidden="true" tabindex="-1"></a>  <span class="at">data    =</span> train</span>
<span id="cb2-794"><a href="#cb2-794" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-795"><a href="#cb2-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-796"><a href="#cb2-796" aria-hidden="true" tabindex="-1"></a>fit_tree_no_surrog <span class="ot">&lt;-</span> <span class="fu">prune</span>(obj_tree_no_surrog, <span class="at">cp =</span> cp_opt)</span>
<span id="cb2-797"><a href="#cb2-797" aria-hidden="true" tabindex="-1"></a>vi_no_surrog <span class="ot">&lt;-</span> fit_tree_no_surrog<span class="sc">$</span>variable.importance</span>
<span id="cb2-798"><a href="#cb2-798" aria-hidden="true" tabindex="-1"></a>vi_no_surrog <span class="ot">&lt;-</span> vi_no_surrog <span class="sc">/</span> <span class="fu">sum</span>(vi_no_surrog) <span class="sc">*</span> <span class="dv">100</span>  <span class="co"># percent importance</span></span>
<span id="cb2-799"><a href="#cb2-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-800"><a href="#cb2-800" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare variable importance with and without surrogate splits</span></span>
<span id="cb2-801"><a href="#cb2-801" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot</span></span>
<span id="cb2-802"><a href="#cb2-802" aria-hidden="true" tabindex="-1"></a><span class="co"># make tibble</span></span>
<span id="cb2-803"><a href="#cb2-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-804"><a href="#cb2-804" aria-hidden="true" tabindex="-1"></a>feature_list <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"hormone"</span>, <span class="st">"age"</span>, <span class="st">"meno"</span>, <span class="st">"size"</span>, <span class="st">"grade"</span>, <span class="st">"nodes"</span>, <span class="st">"prog"</span>, <span class="st">"estrg"</span>)</span>
<span id="cb2-805"><a href="#cb2-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-806"><a href="#cb2-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-807"><a href="#cb2-807" aria-hidden="true" tabindex="-1"></a>fig_tree_vi <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-808"><a href="#cb2-808" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="fu">names</span>(vi_surrog),</span>
<span id="cb2-809"><a href="#cb2-809" aria-hidden="true" tabindex="-1"></a>  <span class="at">vi =</span> vi_surrog) <span class="sc">|&gt;</span> </span>
<span id="cb2-810"><a href="#cb2-810" aria-hidden="true" tabindex="-1"></a>  <span class="co"># assign 0 to variables not in vi_surrog</span></span>
<span id="cb2-811"><a href="#cb2-811" aria-hidden="true" tabindex="-1"></a>  <span class="fu">complete</span>(<span class="at">variable =</span> feature_list, <span class="at">fill =</span> <span class="fu">list</span>(<span class="at">vi =</span> <span class="fl">0.1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-812"><a href="#cb2-812" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">reorder</span>(variable, vi), <span class="at">x =</span> vi)) <span class="sc">+</span></span>
<span id="cb2-813"><a href="#cb2-813" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb2-814"><a href="#cb2-814" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(<span class="fu">c</span>(vi_surrog, vi_no_surrog)) <span class="sc">*</span> <span class="fl">1.0</span>)) <span class="sc">+</span></span>
<span id="cb2-815"><a href="#cb2-815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-816"><a href="#cb2-816" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="cn">NULL</span>,</span>
<span id="cb2-817"><a href="#cb2-817" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Feature  importance (%)"</span>,</span>
<span id="cb2-818"><a href="#cb2-818" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"With surrogate splits"</span></span>
<span id="cb2-819"><a href="#cb2-819" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-820"><a href="#cb2-820" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb2-821"><a href="#cb2-821" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb2-822"><a href="#cb2-822" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb2-823"><a href="#cb2-823" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb2-824"><a href="#cb2-824" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-825"><a href="#cb2-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-826"><a href="#cb2-826" aria-hidden="true" tabindex="-1"></a>fig_tree_vi_no_surrog <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-827"><a href="#cb2-827" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="fu">names</span>(vi_no_surrog),</span>
<span id="cb2-828"><a href="#cb2-828" aria-hidden="true" tabindex="-1"></a>  <span class="at">vi =</span> vi_no_surrog) <span class="sc">|&gt;</span> </span>
<span id="cb2-829"><a href="#cb2-829" aria-hidden="true" tabindex="-1"></a>  <span class="co"># assign 0 to variables not in vi_no_surrog</span></span>
<span id="cb2-830"><a href="#cb2-830" aria-hidden="true" tabindex="-1"></a>  <span class="fu">complete</span>(<span class="at">variable =</span> feature_list, <span class="at">fill =</span> <span class="fu">list</span>(<span class="at">vi =</span> .<span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-831"><a href="#cb2-831" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">reorder</span>(variable, vi), <span class="at">x =</span> vi)) <span class="sc">+</span></span>
<span id="cb2-832"><a href="#cb2-832" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb2-833"><a href="#cb2-833" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(<span class="fu">c</span>(vi_surrog, vi_no_surrog)) <span class="sc">*</span> <span class="fl">1.0</span>)) <span class="sc">+</span></span>
<span id="cb2-834"><a href="#cb2-834" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-835"><a href="#cb2-835" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="cn">NULL</span>,</span>
<span id="cb2-836"><a href="#cb2-836" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Feature importance (%)"</span>,</span>
<span id="cb2-837"><a href="#cb2-837" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Without surrogate splits"</span></span>
<span id="cb2-838"><a href="#cb2-838" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-839"><a href="#cb2-839" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb2-840"><a href="#cb2-840" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb2-841"><a href="#cb2-841" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb2-842"><a href="#cb2-842" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb2-843"><a href="#cb2-843" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-844"><a href="#cb2-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-845"><a href="#cb2-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-846"><a href="#cb2-846" aria-hidden="true" tabindex="-1"></a>fig_tree_vi_comp <span class="ot">&lt;-</span> fig_tree_vi <span class="sc">+</span> fig_tree_vi_no_surrog <span class="sc">+</span></span>
<span id="cb2-847"><a href="#cb2-847" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb2-848"><a href="#cb2-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-849"><a href="#cb2-849" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("images/ml_tree_vi_gbc.png", </span></span>
<span id="cb2-850"><a href="#cb2-850" aria-hidden="true" tabindex="-1"></a><span class="co">#        fig_tree_vi_comp,</span></span>
<span id="cb2-851"><a href="#cb2-851" aria-hidden="true" tabindex="-1"></a><span class="co">#        width = 8, height = 4.5, dpi = 300)</span></span>
<span id="cb2-852"><a href="#cb2-852" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("images/ml_tree_vi_gbc.eps", </span></span>
<span id="cb2-853"><a href="#cb2-853" aria-hidden="true" tabindex="-1"></a><span class="co">#        fig_tree_vi_comp, </span></span>
<span id="cb2-854"><a href="#cb2-854" aria-hidden="true" tabindex="-1"></a><span class="co">#        width = 8, height = 4.5)</span></span>
<span id="cb2-855"><a href="#cb2-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-856"><a href="#cb2-856" aria-hidden="true" tabindex="-1"></a><span class="co"># Check surrogate split info in fit_tree</span></span>
<span id="cb2-857"><a href="#cb2-857" aria-hidden="true" tabindex="-1"></a>fit_tree<span class="sc">$</span>splits</span>
<span id="cb2-858"><a href="#cb2-858" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;         count ncat   improve index        adj</span></span>
<span id="cb2-859"><a href="#cb2-859" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; prog      400    1 41.929765  24.5 0.00000000</span></span>
<span id="cb2-860"><a href="#cb2-860" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; nodes     400   -1 27.853517   3.5 0.00000000</span></span>
<span id="cb2-861"><a href="#cb2-861" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; estrg     400    1 22.339746   8.5 0.00000000</span></span>
<span id="cb2-862"><a href="#cb2-862" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; grade     400   -1 12.676483   1.5 0.00000000</span></span>
<span id="cb2-863"><a href="#cb2-863" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; age       400    1 12.347645  31.5 0.00000000</span></span>
<span id="cb2-864"><a href="#cb2-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-865"><a href="#cb2-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-866"><a href="#cb2-866" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb2-867"><a href="#cb2-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-868"><a href="#cb2-868" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-869"><a href="#cb2-869" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Extracting Leaf-Specific Survival Functions</span></span>
<span id="cb2-870"><a href="#cb2-870" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-871"><a href="#cb2-871" aria-hidden="true" tabindex="-1"></a>tmp       <span class="ot">&lt;-</span> <span class="fu">summary</span>(km_fit2)</span>
<span id="cb2-872"><a href="#cb2-872" aria-hidden="true" tabindex="-1"></a>tmp.strata<span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*="</span>, <span class="st">""</span>, tmp<span class="sc">$</span>strata) <span class="co"># node labels</span></span>
<span id="cb2-873"><a href="#cb2-873" aria-hidden="true" tabindex="-1"></a>tmp.t     <span class="ot">&lt;-</span> tmp<span class="sc">$</span>time</span>
<span id="cb2-874"><a href="#cb2-874" aria-hidden="true" tabindex="-1"></a>tmp.surv  <span class="ot">&lt;-</span> tmp<span class="sc">$</span>surv</span>
<span id="cb2-875"><a href="#cb2-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-876"><a href="#cb2-876" aria-hidden="true" tabindex="-1"></a><span class="co"># Terminal node IDs</span></span>
<span id="cb2-877"><a href="#cb2-877" aria-hidden="true" tabindex="-1"></a>TN <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(tmp.strata))</span>
<span id="cb2-878"><a href="#cb2-878" aria-hidden="true" tabindex="-1"></a>N  <span class="ot">&lt;-</span> <span class="fu">length</span>(TN)</span>
<span id="cb2-879"><a href="#cb2-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-880"><a href="#cb2-880" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the unique times from tmp.t</span></span>
<span id="cb2-881"><a href="#cb2-881" aria-hidden="true" tabindex="-1"></a>t_unique <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(tmp.t))</span>
<span id="cb2-882"><a href="#cb2-882" aria-hidden="true" tabindex="-1"></a>m        <span class="ot">&lt;-</span> <span class="fu">length</span>(t_unique)</span>
<span id="cb2-883"><a href="#cb2-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-884"><a href="#cb2-884" aria-hidden="true" tabindex="-1"></a><span class="co"># fitted_surv[j,k] =&gt; survival at time t_unique[j] for node k</span></span>
<span id="cb2-885"><a href="#cb2-885" aria-hidden="true" tabindex="-1"></a>fitted_surv <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> m, <span class="at">ncol =</span> N)</span>
<span id="cb2-886"><a href="#cb2-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-887"><a href="#cb2-887" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(m)) {</span>
<span id="cb2-888"><a href="#cb2-888" aria-hidden="true" tabindex="-1"></a>  tj <span class="ot">&lt;-</span> t_unique[j]</span>
<span id="cb2-889"><a href="#cb2-889" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="fu">seq_len</span>(N)) {</span>
<span id="cb2-890"><a href="#cb2-890" aria-hidden="true" tabindex="-1"></a>    <span class="co"># times within that node</span></span>
<span id="cb2-891"><a href="#cb2-891" aria-hidden="true" tabindex="-1"></a>    node_times <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, tmp.t[tmp.strata <span class="sc">==</span> TN[k]])</span>
<span id="cb2-892"><a href="#cb2-892" aria-hidden="true" tabindex="-1"></a>    node_survs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, tmp.surv[tmp.strata <span class="sc">==</span> TN[k]])</span>
<span id="cb2-893"><a href="#cb2-893" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-894"><a href="#cb2-894" aria-hidden="true" tabindex="-1"></a>    idx <span class="ot">&lt;-</span> <span class="fu">sum</span>(node_times <span class="sc">&lt;=</span> tj)</span>
<span id="cb2-895"><a href="#cb2-895" aria-hidden="true" tabindex="-1"></a>    fitted_surv[j, k] <span class="ot">&lt;-</span> node_survs[idx]</span>
<span id="cb2-896"><a href="#cb2-896" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-897"><a href="#cb2-897" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-898"><a href="#cb2-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-899"><a href="#cb2-899" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-900"><a href="#cb2-900" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Apply the Tree to the Test Set</span></span>
<span id="cb2-901"><a href="#cb2-901" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-902"><a href="#cb2-902" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(treeClust)</span>
<span id="cb2-903"><a href="#cb2-903" aria-hidden="true" tabindex="-1"></a><span class="co"># ?rpart.predict.leaves</span></span>
<span id="cb2-904"><a href="#cb2-904" aria-hidden="true" tabindex="-1"></a><span class="co"># rpart.predict.leaves() =&gt; which leaf each test subject lands in</span></span>
<span id="cb2-905"><a href="#cb2-905" aria-hidden="true" tabindex="-1"></a><span class="co"># Terminal nodes ("where" labels) for test data</span></span>
<span id="cb2-906"><a href="#cb2-906" aria-hidden="true" tabindex="-1"></a>where_test <span class="ot">&lt;-</span> <span class="fu">rpart.predict.leaves</span>(fit_tree, <span class="at">newdata =</span> test)</span>
<span id="cb2-907"><a href="#cb2-907" aria-hidden="true" tabindex="-1"></a>term_node_test <span class="ot">&lt;-</span> where_to_nodes[where_test] <span class="co"># map to node numbers</span></span>
<span id="cb2-908"><a href="#cb2-908" aria-hidden="true" tabindex="-1"></a>pred_test <span class="ot">&lt;-</span> test <span class="sc">|&gt;</span>  <span class="co"># add terminal node info to test set</span></span>
<span id="cb2-909"><a href="#cb2-909" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="at">.term_node =</span> term_node_test) <span class="sc">|&gt;</span> </span>
<span id="cb2-910"><a href="#cb2-910" aria-hidden="true" tabindex="-1"></a>  <span class="co"># risk group</span></span>
<span id="cb2-911"><a href="#cb2-911" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-912"><a href="#cb2-912" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk_group =</span> <span class="fu">case_when</span>(</span>
<span id="cb2-913"><a href="#cb2-913" aria-hidden="true" tabindex="-1"></a>      .term_node <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"5"</span>, <span class="st">"7"</span>) <span class="sc">~</span> <span class="st">"High risk"</span>,</span>
<span id="cb2-914"><a href="#cb2-914" aria-hidden="true" tabindex="-1"></a>      .term_node <span class="sc">==</span> <span class="st">"6"</span>           <span class="sc">~</span> <span class="st">"Moderate risk"</span>,</span>
<span id="cb2-915"><a href="#cb2-915" aria-hidden="true" tabindex="-1"></a>      .term_node <span class="sc">==</span> <span class="st">"4"</span>           <span class="sc">~</span> <span class="st">"Low risk"</span></span>
<span id="cb2-916"><a href="#cb2-916" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-917"><a href="#cb2-917" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-918"><a href="#cb2-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-919"><a href="#cb2-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-920"><a href="#cb2-920" aria-hidden="true" tabindex="-1"></a><span class="co"># broom::tidy(km_fit) |&gt; </span></span>
<span id="cb2-921"><a href="#cb2-921" aria-hidden="true" tabindex="-1"></a><span class="co">#   nest_by(strata) |&gt; </span></span>
<span id="cb2-922"><a href="#cb2-922" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(</span></span>
<span id="cb2-923"><a href="#cb2-923" aria-hidden="true" tabindex="-1"></a><span class="co">#     .term_node = parse_number(sub(".*=", "", strata)</span></span>
<span id="cb2-924"><a href="#cb2-924" aria-hidden="true" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb2-925"><a href="#cb2-925" aria-hidden="true" tabindex="-1"></a><span class="co">#   ) </span></span>
<span id="cb2-926"><a href="#cb2-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-927"><a href="#cb2-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-928"><a href="#cb2-928" aria-hidden="true" tabindex="-1"></a>n_test  <span class="ot">&lt;-</span> <span class="fu">nrow</span>(test)</span>
<span id="cb2-929"><a href="#cb2-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-930"><a href="#cb2-930" aria-hidden="true" tabindex="-1"></a><span class="co"># ?rpart.predict.leaves</span></span>
<span id="cb2-931"><a href="#cb2-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-932"><a href="#cb2-932" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct an (n_test x m) matrix of survival probabilities</span></span>
<span id="cb2-933"><a href="#cb2-933" aria-hidden="true" tabindex="-1"></a>St_tree <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> n_test, <span class="at">ncol =</span> m)</span>
<span id="cb2-934"><a href="#cb2-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-935"><a href="#cb2-935" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (k <span class="cf">in</span> <span class="fu">seq_len</span>(N)) {</span>
<span id="cb2-936"><a href="#cb2-936" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Index test subjects in node k</span></span>
<span id="cb2-937"><a href="#cb2-937" aria-hidden="true" tabindex="-1"></a>  ind <span class="ot">&lt;-</span> <span class="fu">which</span>(pred_test<span class="sc">$</span>risk_group  <span class="sc">==</span> TN[k])</span>
<span id="cb2-938"><a href="#cb2-938" aria-hidden="true" tabindex="-1"></a>  <span class="co"># replicate the node-k survival curve for these subjects</span></span>
<span id="cb2-939"><a href="#cb2-939" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(ind) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb2-940"><a href="#cb2-940" aria-hidden="true" tabindex="-1"></a>    St_tree[ind, ] <span class="ot">&lt;-</span> <span class="fu">matrix</span>(fitted_surv[, k], <span class="at">nrow =</span> <span class="fu">length</span>(ind), <span class="at">ncol =</span> m, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-941"><a href="#cb2-941" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-942"><a href="#cb2-942" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-943"><a href="#cb2-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-944"><a href="#cb2-944" aria-hidden="true" tabindex="-1"></a><span class="co"># Risk score</span></span>
<span id="cb2-945"><a href="#cb2-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-946"><a href="#cb2-946" aria-hidden="true" tabindex="-1"></a>tree_rs <span class="ot">&lt;-</span> fit_tree<span class="sc">$</span>frame<span class="sc">$</span>yval[where_test]</span>
<span id="cb2-947"><a href="#cb2-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-948"><a href="#cb2-948" aria-hidden="true" tabindex="-1"></a><span class="co"># C index</span></span>
<span id="cb2-949"><a href="#cb2-949" aria-hidden="true" tabindex="-1"></a><span class="co"># Harrell's C</span></span>
<span id="cb2-950"><a href="#cb2-950" aria-hidden="true" tabindex="-1"></a>tree_harrell_c <span class="ot">&lt;-</span> <span class="fu">Cindex_fun</span>(<span class="at">riskscore =</span> tree_rs,</span>
<span id="cb2-951"><a href="#cb2-951" aria-hidden="true" tabindex="-1"></a>            <span class="at">time      =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-952"><a href="#cb2-952" aria-hidden="true" tabindex="-1"></a>            <span class="at">status    =</span> test<span class="sc">$</span>status)</span>
<span id="cb2-953"><a href="#cb2-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-954"><a href="#cb2-954" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 0.641105</span></span>
<span id="cb2-955"><a href="#cb2-955" aria-hidden="true" tabindex="-1"></a><span class="co"># Uno's C at tau = 60</span></span>
<span id="cb2-956"><a href="#cb2-956" aria-hidden="true" tabindex="-1"></a>tree_uno_c_60 <span class="ot">&lt;-</span> <span class="fu">Cindex_fun</span>(<span class="at">timepoints =</span> <span class="dv">60</span>,</span>
<span id="cb2-957"><a href="#cb2-957" aria-hidden="true" tabindex="-1"></a>            <span class="at">riskscore  =</span> tree_rs,</span>
<span id="cb2-958"><a href="#cb2-958" aria-hidden="true" tabindex="-1"></a>            <span class="at">time       =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-959"><a href="#cb2-959" aria-hidden="true" tabindex="-1"></a>            <span class="at">status     =</span> test<span class="sc">$</span>status)</span>
<span id="cb2-960"><a href="#cb2-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-961"><a href="#cb2-961" aria-hidden="true" tabindex="-1"></a><span class="co"># Store results</span></span>
<span id="cb2-962"><a href="#cb2-962" aria-hidden="true" tabindex="-1"></a>c_index_results4 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb2-963"><a href="#cb2-963" aria-hidden="true" tabindex="-1"></a>  c_index_results3,</span>
<span id="cb2-964"><a href="#cb2-964" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb2-965"><a href="#cb2-965" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model =</span> <span class="st">"Survival Tree"</span>,</span>
<span id="cb2-966"><a href="#cb2-966" aria-hidden="true" tabindex="-1"></a>    <span class="at">Harrell_C =</span> tree_harrell_c,</span>
<span id="cb2-967"><a href="#cb2-967" aria-hidden="true" tabindex="-1"></a>    <span class="at">Uno_C_60 =</span> tree_uno_c_60<span class="sc">$</span>C</span>
<span id="cb2-968"><a href="#cb2-968" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-969"><a href="#cb2-969" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-970"><a href="#cb2-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-971"><a href="#cb2-971" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-972"><a href="#cb2-972" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Brier Score for the Survival Tree</span></span>
<span id="cb2-973"><a href="#cb2-973" aria-hidden="true" tabindex="-1"></a><span class="co">#------------------------------------------------------------------------------</span></span>
<span id="cb2-974"><a href="#cb2-974" aria-hidden="true" tabindex="-1"></a>brier_score_tree <span class="ot">&lt;-</span> <span class="fu">BSfun</span>(</span>
<span id="cb2-975"><a href="#cb2-975" aria-hidden="true" tabindex="-1"></a>    <span class="at">timepoints   =</span> timepoints,</span>
<span id="cb2-976"><a href="#cb2-976" aria-hidden="true" tabindex="-1"></a>    <span class="at">time  =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-977"><a href="#cb2-977" aria-hidden="true" tabindex="-1"></a>    <span class="at">status=</span> test<span class="sc">$</span>status,</span>
<span id="cb2-978"><a href="#cb2-978" aria-hidden="true" tabindex="-1"></a>    <span class="at">St    =</span> St_tree,</span>
<span id="cb2-979"><a href="#cb2-979" aria-hidden="true" tabindex="-1"></a>    <span class="at">t     =</span> t_unique</span>
<span id="cb2-980"><a href="#cb2-980" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-981"><a href="#cb2-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-982"><a href="#cb2-982" aria-hidden="true" tabindex="-1"></a>brier_score_results4 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb2-983"><a href="#cb2-983" aria-hidden="true" tabindex="-1"></a>  brier_score_results3,</span>
<span id="cb2-984"><a href="#cb2-984" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb2-985"><a href="#cb2-985" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model =</span> <span class="fu">rep</span>(<span class="st">"Survival Tree"</span>, <span class="fu">length</span>(timepoints)),</span>
<span id="cb2-986"><a href="#cb2-986" aria-hidden="true" tabindex="-1"></a>    <span class="at">Time =</span> timepoints,</span>
<span id="cb2-987"><a href="#cb2-987" aria-hidden="true" tabindex="-1"></a>    <span class="at">Brier_Score =</span> brier_score_tree</span>
<span id="cb2-988"><a href="#cb2-988" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-989"><a href="#cb2-989" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-990"><a href="#cb2-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-991"><a href="#cb2-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-992"><a href="#cb2-992" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb2-993"><a href="#cb2-993" aria-hidden="true" tabindex="-1"></a><span class="co"># ------- Oblique random survival forest (ORSF) ----</span></span>
<span id="cb2-994"><a href="#cb2-994" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("aorsf") </span></span>
<span id="cb2-995"><a href="#cb2-995" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(aorsf)</span>
<span id="cb2-996"><a href="#cb2-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-997"><a href="#cb2-997" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a basic oblique random survival forest on training data</span></span>
<span id="cb2-998"><a href="#cb2-998" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>) <span class="co"># for reproducibility</span></span>
<span id="cb2-999"><a href="#cb2-999" aria-hidden="true" tabindex="-1"></a>orsf_fit <span class="ot">&lt;-</span> <span class="fu">orsf</span>(</span>
<span id="cb2-1000"><a href="#cb2-1000" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(time, status) <span class="sc">~</span> hormone <span class="sc">+</span> age <span class="sc">+</span> meno <span class="sc">+</span> size <span class="sc">+</span> grade <span class="sc">+</span> nodes <span class="sc">+</span> prog <span class="sc">+</span> estrg,</span>
<span id="cb2-1001"><a href="#cb2-1001" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> train,</span>
<span id="cb2-1002"><a href="#cb2-1002" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_tree =</span> <span class="dv">200</span>,</span>
<span id="cb2-1003"><a href="#cb2-1003" aria-hidden="true" tabindex="-1"></a>      <span class="at">oobag_pred_type =</span> <span class="st">'risk'</span>,</span>
<span id="cb2-1004"><a href="#cb2-1004" aria-hidden="true" tabindex="-1"></a>      <span class="at">oobag_pred_horizon =</span> <span class="dv">60</span>,</span>
<span id="cb2-1005"><a href="#cb2-1005" aria-hidden="true" tabindex="-1"></a>      <span class="at">oobag_eval_every =</span> <span class="dv">1</span></span>
<span id="cb2-1006"><a href="#cb2-1006" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-1007"><a href="#cb2-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1008"><a href="#cb2-1008" aria-hidden="true" tabindex="-1"></a>orsf_fit </span>
<span id="cb2-1009"><a href="#cb2-1009" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ---------- Oblique random survival forest</span></span>
<span id="cb2-1010"><a href="#cb2-1010" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb2-1011"><a href="#cb2-1011" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      Linear combinations: Accelerated Cox regression</span></span>
<span id="cb2-1012"><a href="#cb2-1012" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;           N observations: 400</span></span>
<span id="cb2-1013"><a href="#cb2-1013" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;                 N events: 174</span></span>
<span id="cb2-1014"><a href="#cb2-1014" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;                  N trees: 200</span></span>
<span id="cb2-1015"><a href="#cb2-1015" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;       N predictors total: 8</span></span>
<span id="cb2-1016"><a href="#cb2-1016" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    N predictors per node: 3</span></span>
<span id="cb2-1017"><a href="#cb2-1017" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  Average leaves per tree: 29.855</span></span>
<span id="cb2-1018"><a href="#cb2-1018" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Min observations in leaf: 5</span></span>
<span id="cb2-1019"><a href="#cb2-1019" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;       Min events in leaf: 1</span></span>
<span id="cb2-1020"><a href="#cb2-1020" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;           OOB stat value: 0.68</span></span>
<span id="cb2-1021"><a href="#cb2-1021" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;            OOB stat type: Harrell's C-index</span></span>
<span id="cb2-1022"><a href="#cb2-1022" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;      Variable importance: anova</span></span>
<span id="cb2-1023"><a href="#cb2-1023" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb2-1024"><a href="#cb2-1024" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -----------------------------------------</span></span>
<span id="cb2-1025"><a href="#cb2-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1026"><a href="#cb2-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1027"><a href="#cb2-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1028"><a href="#cb2-1028" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot out-of-bag C-statistic over number of trees</span></span>
<span id="cb2-1029"><a href="#cb2-1029" aria-hidden="true" tabindex="-1"></a>fig_rsf_ntree <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-1030"><a href="#cb2-1030" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_tree =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">200</span>, <span class="at">by =</span> <span class="dv">1</span>),</span>
<span id="cb2-1031"><a href="#cb2-1031" aria-hidden="true" tabindex="-1"></a>  <span class="at">c_stat =</span> orsf_fit<span class="sc">$</span>eval_oobag<span class="sc">$</span>stat_values</span>
<span id="cb2-1032"><a href="#cb2-1032" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb2-1033"><a href="#cb2-1033" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n_tree, <span class="at">y =</span> c_stat)) <span class="sc">+</span></span>
<span id="cb2-1034"><a href="#cb2-1034" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb2-1035"><a href="#cb2-1035" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb2-1036"><a href="#cb2-1036" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-1037"><a href="#cb2-1037" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Number of trees grown"</span>,</span>
<span id="cb2-1038"><a href="#cb2-1038" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">paste0</span>(<span class="st">"OOB "</span>, orsf_fit<span class="sc">$</span>eval_oobag<span class="sc">$</span>stat_type)</span>
<span id="cb2-1039"><a href="#cb2-1039" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-1040"><a href="#cb2-1040" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) </span>
<span id="cb2-1041"><a href="#cb2-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1042"><a href="#cb2-1042" aria-hidden="true" tabindex="-1"></a>fig_rsf_ntree</span>
<span id="cb2-1043"><a href="#cb2-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1044"><a href="#cb2-1044" aria-hidden="true" tabindex="-1"></a><span class="co"># Variance importance by permutation</span></span>
<span id="cb2-1045"><a href="#cb2-1045" aria-hidden="true" tabindex="-1"></a>vi_rsf <span class="ot">&lt;-</span> <span class="fu">orsf_vi_permute</span>(orsf_fit)</span>
<span id="cb2-1046"><a href="#cb2-1046" aria-hidden="true" tabindex="-1"></a><span class="co"># set negative values to 0 and normalize</span></span>
<span id="cb2-1047"><a href="#cb2-1047" aria-hidden="true" tabindex="-1"></a>vi_rsf<span class="ot">&lt;-</span> <span class="fu">pmax</span>(vi_rsf, <span class="dv">0</span>)</span>
<span id="cb2-1048"><a href="#cb2-1048" aria-hidden="true" tabindex="-1"></a>vi_rsf <span class="ot">&lt;-</span> vi_rsf <span class="sc">/</span> <span class="fu">sum</span>(vi_rsf) <span class="sc">*</span> <span class="dv">100</span>  <span class="sc">+</span> <span class="fl">0.1</span> <span class="co"># +0.1 for cosmetic purpose</span></span>
<span id="cb2-1049"><a href="#cb2-1049" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb2-1050"><a href="#cb2-1050" aria-hidden="true" tabindex="-1"></a>fig_rsf_vi <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-1051"><a href="#cb2-1051" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="fu">names</span>(vi_rsf),</span>
<span id="cb2-1052"><a href="#cb2-1052" aria-hidden="true" tabindex="-1"></a>  <span class="at">vi =</span> vi_rsf</span>
<span id="cb2-1053"><a href="#cb2-1053" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb2-1054"><a href="#cb2-1054" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">reorder</span>(variable, vi), <span class="at">x =</span> vi)) <span class="sc">+</span></span>
<span id="cb2-1055"><a href="#cb2-1055" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb2-1056"><a href="#cb2-1056" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-1057"><a href="#cb2-1057" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="cn">NULL</span>,</span>
<span id="cb2-1058"><a href="#cb2-1058" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Feature importance (%)"</span></span>
<span id="cb2-1059"><a href="#cb2-1059" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-1060"><a href="#cb2-1060" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb2-1061"><a href="#cb2-1061" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb2-1062"><a href="#cb2-1062" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb2-1063"><a href="#cb2-1063" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-1064"><a href="#cb2-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1065"><a href="#cb2-1065" aria-hidden="true" tabindex="-1"></a>fig_rsf_vi</span>
<span id="cb2-1066"><a href="#cb2-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1067"><a href="#cb2-1067" aria-hidden="true" tabindex="-1"></a>fig_gbc_rsf <span class="ot">&lt;-</span> fig_rsf_ntree <span class="sc">+</span> fig_rsf_vi </span>
<span id="cb2-1068"><a href="#cb2-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1069"><a href="#cb2-1069" aria-hidden="true" tabindex="-1"></a>fig_gbc_rsf</span>
<span id="cb2-1070"><a href="#cb2-1070" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("images/ml_rsf_gbc.png", fig_gbc_rsf,</span></span>
<span id="cb2-1071"><a href="#cb2-1071" aria-hidden="true" tabindex="-1"></a><span class="co">#        width = 8, height = 4.3, dpi = 300)</span></span>
<span id="cb2-1072"><a href="#cb2-1072" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("images/ml_rsf_gbc.eps", fig_gbc_rsf, device = cairo_ps,</span></span>
<span id="cb2-1073"><a href="#cb2-1073" aria-hidden="true" tabindex="-1"></a><span class="co">#        width = 8, height = 4.3)</span></span>
<span id="cb2-1074"><a href="#cb2-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1075"><a href="#cb2-1075" aria-hidden="true" tabindex="-1"></a><span class="co"># How to do prediction using orsf_fit</span></span>
<span id="cb2-1076"><a href="#cb2-1076" aria-hidden="true" tabindex="-1"></a>pred_orsf <span class="ot">&lt;-</span> <span class="fu">predict</span>(orsf_fit, <span class="at">new_data =</span> test, <span class="at">pred_type=</span> <span class="st">'surv'</span>,</span>
<span id="cb2-1077"><a href="#cb2-1077" aria-hidden="true" tabindex="-1"></a>                     <span class="at">pred_horizon =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">60</span>, <span class="at">by =</span> <span class="dv">1</span>)</span>
<span id="cb2-1078"><a href="#cb2-1078" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb2-1079"><a href="#cb2-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1080"><a href="#cb2-1080" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract risk scores (S(60))</span></span>
<span id="cb2-1081"><a href="#cb2-1081" aria-hidden="true" tabindex="-1"></a>orsf_rs <span class="ot">&lt;-</span> pred_orsf[, <span class="dv">60</span>]</span>
<span id="cb2-1082"><a href="#cb2-1082" aria-hidden="true" tabindex="-1"></a><span class="co"># C index</span></span>
<span id="cb2-1083"><a href="#cb2-1083" aria-hidden="true" tabindex="-1"></a><span class="co"># Harrell's C</span></span>
<span id="cb2-1084"><a href="#cb2-1084" aria-hidden="true" tabindex="-1"></a>orsf_harrell_c <span class="ot">&lt;-</span> <span class="fu">Cindex_fun</span>(<span class="at">riskscore =</span> <span class="sc">-</span> orsf_rs,  <span class="co"># negative of survival</span></span>
<span id="cb2-1085"><a href="#cb2-1085" aria-hidden="true" tabindex="-1"></a>            <span class="at">time      =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-1086"><a href="#cb2-1086" aria-hidden="true" tabindex="-1"></a>            <span class="at">status    =</span> test<span class="sc">$</span>status)</span>
<span id="cb2-1087"><a href="#cb2-1087" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 0.6893658</span></span>
<span id="cb2-1088"><a href="#cb2-1088" aria-hidden="true" tabindex="-1"></a><span class="co"># Uno's C at tau = 60</span></span>
<span id="cb2-1089"><a href="#cb2-1089" aria-hidden="true" tabindex="-1"></a>orsf_uno_c_60 <span class="ot">&lt;-</span> <span class="fu">Cindex_fun</span>(<span class="at">timepoints =</span> <span class="dv">60</span>,</span>
<span id="cb2-1090"><a href="#cb2-1090" aria-hidden="true" tabindex="-1"></a>            <span class="at">riskscore  =</span> <span class="sc">-</span> orsf_rs,</span>
<span id="cb2-1091"><a href="#cb2-1091" aria-hidden="true" tabindex="-1"></a>            <span class="at">time       =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-1092"><a href="#cb2-1092" aria-hidden="true" tabindex="-1"></a>            <span class="at">status     =</span> test<span class="sc">$</span>status)</span>
<span id="cb2-1093"><a href="#cb2-1093" aria-hidden="true" tabindex="-1"></a><span class="co"># Store results</span></span>
<span id="cb2-1094"><a href="#cb2-1094" aria-hidden="true" tabindex="-1"></a>c_index_results5 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb2-1095"><a href="#cb2-1095" aria-hidden="true" tabindex="-1"></a>  c_index_results4,</span>
<span id="cb2-1096"><a href="#cb2-1096" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb2-1097"><a href="#cb2-1097" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model =</span> <span class="st">"Oblique RSF"</span>,</span>
<span id="cb2-1098"><a href="#cb2-1098" aria-hidden="true" tabindex="-1"></a>    <span class="at">Harrell_C =</span> orsf_harrell_c,</span>
<span id="cb2-1099"><a href="#cb2-1099" aria-hidden="true" tabindex="-1"></a>    <span class="at">Uno_C_60 =</span> orsf_uno_c_60<span class="sc">$</span>C</span>
<span id="cb2-1100"><a href="#cb2-1100" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-1101"><a href="#cb2-1101" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-1102"><a href="#cb2-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1103"><a href="#cb2-1103" aria-hidden="true" tabindex="-1"></a><span class="co"># Brier Score for ORSF</span></span>
<span id="cb2-1104"><a href="#cb2-1104" aria-hidden="true" tabindex="-1"></a>St_orsf <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(pred_orsf)</span>
<span id="cb2-1105"><a href="#cb2-1105" aria-hidden="true" tabindex="-1"></a>t_orsf <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">60</span>, <span class="at">by =</span> <span class="dv">1</span>)</span>
<span id="cb2-1106"><a href="#cb2-1106" aria-hidden="true" tabindex="-1"></a>brier_score_orsf <span class="ot">&lt;-</span> <span class="fu">BSfun</span>(</span>
<span id="cb2-1107"><a href="#cb2-1107" aria-hidden="true" tabindex="-1"></a>    <span class="at">timepoints     =</span> timepoints,</span>
<span id="cb2-1108"><a href="#cb2-1108" aria-hidden="true" tabindex="-1"></a>    <span class="at">time   =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-1109"><a href="#cb2-1109" aria-hidden="true" tabindex="-1"></a>    <span class="at">status =</span> test<span class="sc">$</span>status,</span>
<span id="cb2-1110"><a href="#cb2-1110" aria-hidden="true" tabindex="-1"></a>    <span class="at">St     =</span> St_orsf,</span>
<span id="cb2-1111"><a href="#cb2-1111" aria-hidden="true" tabindex="-1"></a>    <span class="at">t      =</span> t_orsf</span>
<span id="cb2-1112"><a href="#cb2-1112" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb2-1113"><a href="#cb2-1113" aria-hidden="true" tabindex="-1"></a>brier_score_results5 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb2-1114"><a href="#cb2-1114" aria-hidden="true" tabindex="-1"></a>  brier_score_results4,</span>
<span id="cb2-1115"><a href="#cb2-1115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb2-1116"><a href="#cb2-1116" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model =</span> <span class="fu">rep</span>(<span class="st">"Oblique RSF"</span>, <span class="fu">length</span>(timepoints)),</span>
<span id="cb2-1117"><a href="#cb2-1117" aria-hidden="true" tabindex="-1"></a>    <span class="at">Time =</span> timepoints,</span>
<span id="cb2-1118"><a href="#cb2-1118" aria-hidden="true" tabindex="-1"></a>    <span class="at">Brier_Score =</span> brier_score_orsf</span>
<span id="cb2-1119"><a href="#cb2-1119" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-1120"><a href="#cb2-1120" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-1121"><a href="#cb2-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1122"><a href="#cb2-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1123"><a href="#cb2-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1124"><a href="#cb2-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1125"><a href="#cb2-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1126"><a href="#cb2-1126" aria-hidden="true" tabindex="-1"></a><span class="do">## Survival support vector machine (SSVM)</span></span>
<span id="cb2-1127"><a href="#cb2-1127" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("survivalsvm")</span></span>
<span id="cb2-1128"><a href="#cb2-1128" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survivalsvm)</span>
<span id="cb2-1129"><a href="#cb2-1129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1130"><a href="#cb2-1130" aria-hidden="true" tabindex="-1"></a><span class="co"># Preprocessing: standardize predictors in train and test</span></span>
<span id="cb2-1131"><a href="#cb2-1131" aria-hidden="true" tabindex="-1"></a>feature_list <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"hormone"</span>, <span class="st">"age40"</span>, <span class="st">"meno"</span>, <span class="st">"size"</span>, <span class="st">"grade"</span>, <span class="st">"nodes"</span>, <span class="st">"prog"</span>, <span class="st">"estrg"</span>)</span>
<span id="cb2-1132"><a href="#cb2-1132" aria-hidden="true" tabindex="-1"></a><span class="co"># Get mean and sd from train</span></span>
<span id="cb2-1133"><a href="#cb2-1133" aria-hidden="true" tabindex="-1"></a>train_means <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(train[, feature_list], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-1134"><a href="#cb2-1134" aria-hidden="true" tabindex="-1"></a>train_sds   <span class="ot">&lt;-</span> <span class="fu">apply</span>(train[, feature_list], <span class="dv">2</span>, sd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-1135"><a href="#cb2-1135" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardize train</span></span>
<span id="cb2-1136"><a href="#cb2-1136" aria-hidden="true" tabindex="-1"></a>train_scaled <span class="ot">&lt;-</span> train</span>
<span id="cb2-1137"><a href="#cb2-1137" aria-hidden="true" tabindex="-1"></a>train_scaled[, feature_list] <span class="ot">&lt;-</span> <span class="fu">scale</span>(train[, feature_list],</span>
<span id="cb2-1138"><a href="#cb2-1138" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">center =</span> train_means,</span>
<span id="cb2-1139"><a href="#cb2-1139" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">scale  =</span> train_sds)</span>
<span id="cb2-1140"><a href="#cb2-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1141"><a href="#cb2-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1142"><a href="#cb2-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1143"><a href="#cb2-1143" aria-hidden="true" tabindex="-1"></a><span class="co"># For validation of gamma.mu parameter -----------------------------------</span></span>
<span id="cb2-1144"><a href="#cb2-1144" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SurvMetrics)</span>
<span id="cb2-1145"><a href="#cb2-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1146"><a href="#cb2-1146" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform 10-fold cross-validation on training set</span></span>
<span id="cb2-1147"><a href="#cb2-1147" aria-hidden="true" tabindex="-1"></a>cv_folds <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb2-1148"><a href="#cb2-1148" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb2-1149"><a href="#cb2-1149" aria-hidden="true" tabindex="-1"></a>fold_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>cv_folds, <span class="at">length.out =</span> <span class="fu">nrow</span>(train_scaled)))</span>
<span id="cb2-1150"><a href="#cb2-1150" aria-hidden="true" tabindex="-1"></a><span class="co"># gamma values</span></span>
<span id="cb2-1151"><a href="#cb2-1151" aria-hidden="true" tabindex="-1"></a>gamma_values <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="at">by =</span> <span class="fl">0.2</span>))</span>
<span id="cb2-1152"><a href="#cb2-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1153"><a href="#cb2-1153" aria-hidden="true" tabindex="-1"></a><span class="co"># CV C-index storage</span></span>
<span id="cb2-1154"><a href="#cb2-1154" aria-hidden="true" tabindex="-1"></a>cv_cindex <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> cv_folds, <span class="at">ncol =</span> <span class="fu">length</span>(gamma_values))</span>
<span id="cb2-1155"><a href="#cb2-1155" aria-hidden="true" tabindex="-1"></a>cv_mods <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb2-1156"><a href="#cb2-1156" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (fold <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>cv_folds) {</span>
<span id="cb2-1157"><a href="#cb2-1157" aria-hidden="true" tabindex="-1"></a>  train_fold <span class="ot">&lt;-</span> train_scaled[fold_indices <span class="sc">!=</span> fold, ]</span>
<span id="cb2-1158"><a href="#cb2-1158" aria-hidden="true" tabindex="-1"></a>  val_fold   <span class="ot">&lt;-</span> train_scaled[fold_indices <span class="sc">==</span> fold, ]</span>
<span id="cb2-1159"><a href="#cb2-1159" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-1160"><a href="#cb2-1160" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(gamma_values)) {</span>
<span id="cb2-1161"><a href="#cb2-1161" aria-hidden="true" tabindex="-1"></a>    gamma_mu <span class="ot">&lt;-</span> gamma_values[i]</span>
<span id="cb2-1162"><a href="#cb2-1162" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-1163"><a href="#cb2-1163" aria-hidden="true" tabindex="-1"></a>    ssvm_model <span class="ot">&lt;-</span> <span class="fu">survivalsvm</span>(</span>
<span id="cb2-1164"><a href="#cb2-1164" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Surv</span>(time, status) <span class="sc">~</span> hormone <span class="sc">+</span> age40 <span class="sc">+</span> meno <span class="sc">+</span> size <span class="sc">+</span> grade <span class="sc">+</span> nodes <span class="sc">+</span> prog <span class="sc">+</span> estrg,</span>
<span id="cb2-1165"><a href="#cb2-1165" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> train_fold,</span>
<span id="cb2-1166"><a href="#cb2-1166" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="st">"regression"</span>,</span>
<span id="cb2-1167"><a href="#cb2-1167" aria-hidden="true" tabindex="-1"></a>      <span class="at">gamma.mu =</span> gamma_mu</span>
<span id="cb2-1168"><a href="#cb2-1168" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-1169"><a href="#cb2-1169" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-1170"><a href="#cb2-1170" aria-hidden="true" tabindex="-1"></a>    ssvm_pred_val <span class="ot">&lt;-</span> <span class="fu">predict</span>(ssvm_model, <span class="at">newdata =</span> val_fold)</span>
<span id="cb2-1171"><a href="#cb2-1171" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-1172"><a href="#cb2-1172" aria-hidden="true" tabindex="-1"></a>    surv_obj_val <span class="ot">&lt;-</span> <span class="fu">Surv</span>(val_fold<span class="sc">$</span>time, val_fold<span class="sc">$</span>status)</span>
<span id="cb2-1173"><a href="#cb2-1173" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-1174"><a href="#cb2-1174" aria-hidden="true" tabindex="-1"></a>    cv_cindex[fold, i] <span class="ot">&lt;-</span> <span class="fu">Cindex</span>(surv_obj_val, ssvm_pred_val<span class="sc">$</span>predicted)</span>
<span id="cb2-1175"><a href="#cb2-1175" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-1176"><a href="#cb2-1176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Fold"</span>, fold, <span class="st">"completed.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-1177"><a href="#cb2-1177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">colMeans</span>(cv_cindex, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-1178"><a href="#cb2-1178" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-1179"><a href="#cb2-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1180"><a href="#cb2-1180" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(cv_cindex, <span class="st">"Data/ssvmcv_cindex.RDS"</span>)</span>
<span id="cb2-1181"><a href="#cb2-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1182"><a href="#cb2-1182" aria-hidden="true" tabindex="-1"></a><span class="co"># Average CV C-index across folds</span></span>
<span id="cb2-1183"><a href="#cb2-1183" aria-hidden="true" tabindex="-1"></a>mean_cv_cindex <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(cv_cindex, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-1184"><a href="#cb2-1184" aria-hidden="true" tabindex="-1"></a><span class="co"># mean_cv_cindex</span></span>
<span id="cb2-1185"><a href="#cb2-1185" aria-hidden="true" tabindex="-1"></a>gamma_opt <span class="ot">&lt;-</span> gamma_values[<span class="fu">which.max</span>(mean_cv_cindex)]</span>
<span id="cb2-1186"><a href="#cb2-1186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1187"><a href="#cb2-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1188"><a href="#cb2-1188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1189"><a href="#cb2-1189" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot mean CV C-index vs log(gamma.mu)</span></span>
<span id="cb2-1190"><a href="#cb2-1190" aria-hidden="true" tabindex="-1"></a>fig_ssvm_cv <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-1191"><a href="#cb2-1191" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_gamma =</span> <span class="fu">log</span>(gamma_values),</span>
<span id="cb2-1192"><a href="#cb2-1192" aria-hidden="true" tabindex="-1"></a>  <span class="at">cindex    =</span> mean_cv_cindex</span>
<span id="cb2-1193"><a href="#cb2-1193" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb2-1194"><a href="#cb2-1194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> log_gamma, <span class="at">y =</span> cindex)) <span class="sc">+</span></span>
<span id="cb2-1195"><a href="#cb2-1195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb2-1196"><a href="#cb2-1196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">log</span>(gamma_opt), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb2-1197"><a href="#cb2-1197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb2-1198"><a href="#cb2-1198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_reverse</span>() <span class="sc">+</span></span>
<span id="cb2-1199"><a href="#cb2-1199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.686</span>, <span class="fl">0.7</span>, <span class="at">by =</span> <span class="fl">0.002</span>)) <span class="sc">+</span></span>
<span id="cb2-1200"><a href="#cb2-1200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-1201"><a href="#cb2-1201" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">log</span>(gamma)),</span>
<span id="cb2-1202"><a href="#cb2-1202" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Cross-validated Harrell's C"</span></span>
<span id="cb2-1203"><a href="#cb2-1203" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-1204"><a href="#cb2-1204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span>
<span id="cb2-1205"><a href="#cb2-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1206"><a href="#cb2-1206" aria-hidden="true" tabindex="-1"></a>fig_ssvm_cv</span>
<span id="cb2-1207"><a href="#cb2-1207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1208"><a href="#cb2-1208" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------------</span></span>
<span id="cb2-1209"><a href="#cb2-1209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1210"><a href="#cb2-1210" aria-hidden="true" tabindex="-1"></a><span class="co"># # Permutation method to assess variable importance </span></span>
<span id="cb2-1211"><a href="#cb2-1211" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb2-1212"><a href="#cb2-1212" aria-hidden="true" tabindex="-1"></a><span class="co"># # For the jth fold, fit model under gamma_opt on train_fold,</span></span>
<span id="cb2-1213"><a href="#cb2-1213" aria-hidden="true" tabindex="-1"></a><span class="co"># # with variable k permuted,</span></span>
<span id="cb2-1214"><a href="#cb2-1214" aria-hidden="true" tabindex="-1"></a><span class="co"># # predict on val_fold, </span></span>
<span id="cb2-1215"><a href="#cb2-1215" aria-hidden="true" tabindex="-1"></a><span class="co"># # and compute C-index. Average across folds for variable k importance.</span></span>
<span id="cb2-1216"><a href="#cb2-1216" aria-hidden="true" tabindex="-1"></a><span class="co"># var_names &lt;- c("hormone", "age40", "meno", "size", "grade", "nodes", "prog", "estrg")</span></span>
<span id="cb2-1217"><a href="#cb2-1217" aria-hidden="true" tabindex="-1"></a><span class="co"># var_importance &lt;- numeric(length(var_names))</span></span>
<span id="cb2-1218"><a href="#cb2-1218" aria-hidden="true" tabindex="-1"></a><span class="co"># names(var_importance) &lt;- var_names</span></span>
<span id="cb2-1219"><a href="#cb2-1219" aria-hidden="true" tabindex="-1"></a><span class="co"># set.seed(1234)</span></span>
<span id="cb2-1220"><a href="#cb2-1220" aria-hidden="true" tabindex="-1"></a><span class="co"># for (k in seq_along(var_names)) {</span></span>
<span id="cb2-1221"><a href="#cb2-1221" aria-hidden="true" tabindex="-1"></a><span class="co">#   var_k &lt;- var_names[k]</span></span>
<span id="cb2-1222"><a href="#cb2-1222" aria-hidden="true" tabindex="-1"></a><span class="co">#   cindex_perm &lt;- numeric(cv_folds)</span></span>
<span id="cb2-1223"><a href="#cb2-1223" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb2-1224"><a href="#cb2-1224" aria-hidden="true" tabindex="-1"></a><span class="co">#   for (fold in 1:cv_folds) {</span></span>
<span id="cb2-1225"><a href="#cb2-1225" aria-hidden="true" tabindex="-1"></a><span class="co">#     train_fold &lt;- train_scaled[fold_indices != fold, ]</span></span>
<span id="cb2-1226"><a href="#cb2-1226" aria-hidden="true" tabindex="-1"></a><span class="co">#     val_fold   &lt;- train_scaled[fold_indices == fold, ]</span></span>
<span id="cb2-1227"><a href="#cb2-1227" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb2-1228"><a href="#cb2-1228" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Permute variable k in train_fold</span></span>
<span id="cb2-1229"><a href="#cb2-1229" aria-hidden="true" tabindex="-1"></a><span class="co">#     train_fold_perm &lt;- train_fold</span></span>
<span id="cb2-1230"><a href="#cb2-1230" aria-hidden="true" tabindex="-1"></a><span class="co">#     train_fold_perm[[var_k]] &lt;- sample(train_fold[[var_k]])</span></span>
<span id="cb2-1231"><a href="#cb2-1231" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb2-1232"><a href="#cb2-1232" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Fit SSVM under gamma_opt</span></span>
<span id="cb2-1233"><a href="#cb2-1233" aria-hidden="true" tabindex="-1"></a><span class="co">#     ssvm_model &lt;- survivalsvm(</span></span>
<span id="cb2-1234"><a href="#cb2-1234" aria-hidden="true" tabindex="-1"></a><span class="co">#       Surv(time, status) ~ hormone + age40 + meno + size + grade + nodes + prog + estrg,</span></span>
<span id="cb2-1235"><a href="#cb2-1235" aria-hidden="true" tabindex="-1"></a><span class="co">#       data = train_fold_perm,</span></span>
<span id="cb2-1236"><a href="#cb2-1236" aria-hidden="true" tabindex="-1"></a><span class="co">#       type = "regression",</span></span>
<span id="cb2-1237"><a href="#cb2-1237" aria-hidden="true" tabindex="-1"></a><span class="co">#       gamma.mu = gamma_opt</span></span>
<span id="cb2-1238"><a href="#cb2-1238" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb2-1239"><a href="#cb2-1239" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb2-1240"><a href="#cb2-1240" aria-hidden="true" tabindex="-1"></a><span class="co">#     ssvm_pred_val &lt;- predict(ssvm_model, newdata = val_fold)</span></span>
<span id="cb2-1241"><a href="#cb2-1241" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb2-1242"><a href="#cb2-1242" aria-hidden="true" tabindex="-1"></a><span class="co">#     surv_obj_val &lt;- Surv(val_fold$time, val_fold$status)</span></span>
<span id="cb2-1243"><a href="#cb2-1243" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb2-1244"><a href="#cb2-1244" aria-hidden="true" tabindex="-1"></a><span class="co">#     cindex_perm[fold] &lt;- Cindex(surv_obj_val, ssvm_pred_val$predicted)</span></span>
<span id="cb2-1245"><a href="#cb2-1245" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb2-1246"><a href="#cb2-1246" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb2-1247"><a href="#cb2-1247" aria-hidden="true" tabindex="-1"></a><span class="co">#   # Variable importance as decrease in C-index due to permutation</span></span>
<span id="cb2-1248"><a href="#cb2-1248" aria-hidden="true" tabindex="-1"></a><span class="co">#   var_importance[k] &lt;- mean_cv_cindex[which(gamma_values == gamma_opt)] - mean(cindex_perm)</span></span>
<span id="cb2-1249"><a href="#cb2-1249" aria-hidden="true" tabindex="-1"></a><span class="co">#   cat("Variable", var_k, "importance:", var_importance[k], "\n")</span></span>
<span id="cb2-1250"><a href="#cb2-1250" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb2-1251"><a href="#cb2-1251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1252"><a href="#cb2-1252" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(var_importance, "Data/ssvm_var_importance.rds")</span></span>
<span id="cb2-1253"><a href="#cb2-1253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1254"><a href="#cb2-1254" aria-hidden="true" tabindex="-1"></a>var_importance <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"Data/ssvm_var_importance.rds"</span>)</span>
<span id="cb2-1255"><a href="#cb2-1255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1256"><a href="#cb2-1256" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize variable importance</span></span>
<span id="cb2-1257"><a href="#cb2-1257" aria-hidden="true" tabindex="-1"></a>var_importance <span class="ot">&lt;-</span> <span class="fu">pmax</span>(var_importance, <span class="dv">0</span>)</span>
<span id="cb2-1258"><a href="#cb2-1258" aria-hidden="true" tabindex="-1"></a>var_importance <span class="ot">&lt;-</span> var_importance <span class="sc">/</span> <span class="fu">sum</span>(var_importance) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">+</span> <span class="fl">0.1</span>  <span class="co"># +0.1 for cosmetic purpose</span></span>
<span id="cb2-1259"><a href="#cb2-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1260"><a href="#cb2-1260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1261"><a href="#cb2-1261" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot variable importance</span></span>
<span id="cb2-1262"><a href="#cb2-1262" aria-hidden="true" tabindex="-1"></a>fig_ssvm_vi <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-1263"><a href="#cb2-1263" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="fu">names</span>(var_importance),</span>
<span id="cb2-1264"><a href="#cb2-1264" aria-hidden="true" tabindex="-1"></a>  <span class="at">vi =</span> var_importance</span>
<span id="cb2-1265"><a href="#cb2-1265" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb2-1266"><a href="#cb2-1266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">reorder</span>(variable, vi), <span class="at">x =</span> vi)) <span class="sc">+</span></span>
<span id="cb2-1267"><a href="#cb2-1267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb2-1268"><a href="#cb2-1268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">24</span>, <span class="at">by =</span> <span class="dv">8</span>)) <span class="sc">+</span></span>
<span id="cb2-1269"><a href="#cb2-1269" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-1270"><a href="#cb2-1270" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="cn">NULL</span>,</span>
<span id="cb2-1271"><a href="#cb2-1271" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Feature importance (%)"</span></span>
<span id="cb2-1272"><a href="#cb2-1272" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-1273"><a href="#cb2-1273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb2-1274"><a href="#cb2-1274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb2-1275"><a href="#cb2-1275" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb2-1276"><a href="#cb2-1276" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-1277"><a href="#cb2-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1278"><a href="#cb2-1278" aria-hidden="true" tabindex="-1"></a>fig_gbc_ssvm  <span class="ot">&lt;-</span> fig_ssvm_cv <span class="sc">+</span>  fig_ssvm_vi</span>
<span id="cb2-1279"><a href="#cb2-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1280"><a href="#cb2-1280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1281"><a href="#cb2-1281" aria-hidden="true" tabindex="-1"></a>fig_gbc_ssvm</span>
<span id="cb2-1282"><a href="#cb2-1282" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("images/ml_ssvm_gbc.png", fig_gbc_ssvm,</span></span>
<span id="cb2-1283"><a href="#cb2-1283" aria-hidden="true" tabindex="-1"></a><span class="co">#        width = 8, height = 4.3, dpi = 300)</span></span>
<span id="cb2-1284"><a href="#cb2-1284" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("images/ml_ssvm_gbc.eps", fig_gbc_ssvm, device = cairo_ps,</span></span>
<span id="cb2-1285"><a href="#cb2-1285" aria-hidden="true" tabindex="-1"></a><span class="co">#        width = 8, height = 4.3)</span></span>
<span id="cb2-1286"><a href="#cb2-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1287"><a href="#cb2-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1288"><a href="#cb2-1288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1289"><a href="#cb2-1289" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit entire training data under gamma_opt</span></span>
<span id="cb2-1290"><a href="#cb2-1290" aria-hidden="true" tabindex="-1"></a>ssvm_fit <span class="ot">&lt;-</span> <span class="fu">survivalsvm</span>(</span>
<span id="cb2-1291"><a href="#cb2-1291" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(time, status) <span class="sc">~</span> hormone <span class="sc">+</span> age40 <span class="sc">+</span> meno <span class="sc">+</span> size <span class="sc">+</span> grade <span class="sc">+</span> nodes <span class="sc">+</span> prog <span class="sc">+</span> estrg,</span>
<span id="cb2-1292"><a href="#cb2-1292" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train_scaled,</span>
<span id="cb2-1293"><a href="#cb2-1293" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"regression"</span>,</span>
<span id="cb2-1294"><a href="#cb2-1294" aria-hidden="true" tabindex="-1"></a>  <span class="at">gamma.mu =</span> gamma_opt</span>
<span id="cb2-1295"><a href="#cb2-1295" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-1296"><a href="#cb2-1296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1297"><a href="#cb2-1297" aria-hidden="true" tabindex="-1"></a>test_scaled <span class="ot">&lt;-</span> test</span>
<span id="cb2-1298"><a href="#cb2-1298" aria-hidden="true" tabindex="-1"></a>test_scaled[, feature_list] <span class="ot">&lt;-</span> <span class="fu">scale</span>(test[, feature_list],</span>
<span id="cb2-1299"><a href="#cb2-1299" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">center =</span> train_means,</span>
<span id="cb2-1300"><a href="#cb2-1300" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">scale  =</span> train_sds)</span>
<span id="cb2-1301"><a href="#cb2-1301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1302"><a href="#cb2-1302" aria-hidden="true" tabindex="-1"></a><span class="co"># Risk score from SSVM on test data</span></span>
<span id="cb2-1303"><a href="#cb2-1303" aria-hidden="true" tabindex="-1"></a>ssvm_test_rs <span class="ot">&lt;-</span> <span class="sc">-</span> <span class="fu">predict</span>(ssvm_fit, <span class="at">newdata =</span> test_scaled)<span class="sc">$</span>predicted <span class="sc">|&gt;</span> <span class="fu">as.vector</span>()</span>
<span id="cb2-1304"><a href="#cb2-1304" aria-hidden="true" tabindex="-1"></a><span class="co"># C index</span></span>
<span id="cb2-1305"><a href="#cb2-1305" aria-hidden="true" tabindex="-1"></a><span class="co"># Harrell's C</span></span>
<span id="cb2-1306"><a href="#cb2-1306" aria-hidden="true" tabindex="-1"></a>ssvm_harrell_c <span class="ot">&lt;-</span> <span class="fu">Cindex_fun</span>(<span class="at">riskscore =</span> ssvm_test_rs,</span>
<span id="cb2-1307"><a href="#cb2-1307" aria-hidden="true" tabindex="-1"></a>            <span class="at">time      =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-1308"><a href="#cb2-1308" aria-hidden="true" tabindex="-1"></a>            <span class="at">status    =</span> test<span class="sc">$</span>status)</span>
<span id="cb2-1309"><a href="#cb2-1309" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 0.6740071</span></span>
<span id="cb2-1310"><a href="#cb2-1310" aria-hidden="true" tabindex="-1"></a><span class="co"># Uno's C at tau = 60</span></span>
<span id="cb2-1311"><a href="#cb2-1311" aria-hidden="true" tabindex="-1"></a>ssvm_uno_c_60 <span class="ot">&lt;-</span> <span class="fu">Cindex_fun</span>(<span class="at">timepoints =</span> <span class="dv">60</span>,</span>
<span id="cb2-1312"><a href="#cb2-1312" aria-hidden="true" tabindex="-1"></a>            <span class="at">riskscore  =</span> ssvm_test_rs,</span>
<span id="cb2-1313"><a href="#cb2-1313" aria-hidden="true" tabindex="-1"></a>            <span class="at">time       =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-1314"><a href="#cb2-1314" aria-hidden="true" tabindex="-1"></a>            <span class="at">status     =</span> test<span class="sc">$</span>status)</span>
<span id="cb2-1315"><a href="#cb2-1315" aria-hidden="true" tabindex="-1"></a><span class="co"># Store results</span></span>
<span id="cb2-1316"><a href="#cb2-1316" aria-hidden="true" tabindex="-1"></a>c_index_results6 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb2-1317"><a href="#cb2-1317" aria-hidden="true" tabindex="-1"></a>  c_index_results5,</span>
<span id="cb2-1318"><a href="#cb2-1318" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb2-1319"><a href="#cb2-1319" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model =</span> <span class="st">"Survival SVM"</span>,</span>
<span id="cb2-1320"><a href="#cb2-1320" aria-hidden="true" tabindex="-1"></a>    <span class="at">Harrell_C =</span> ssvm_harrell_c,</span>
<span id="cb2-1321"><a href="#cb2-1321" aria-hidden="true" tabindex="-1"></a>    <span class="at">Uno_C_60 =</span> ssvm_uno_c_60<span class="sc">$</span>C</span>
<span id="cb2-1322"><a href="#cb2-1322" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-1323"><a href="#cb2-1323" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-1324"><a href="#cb2-1324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1325"><a href="#cb2-1325" aria-hidden="true" tabindex="-1"></a><span class="co"># Brier Score for SSVM</span></span>
<span id="cb2-1326"><a href="#cb2-1326" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted survival in test set</span></span>
<span id="cb2-1327"><a href="#cb2-1327" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit cox model against risk score on training set</span></span>
<span id="cb2-1328"><a href="#cb2-1328" aria-hidden="true" tabindex="-1"></a>ssvm_cox <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> ssvm_rs,</span>
<span id="cb2-1329"><a href="#cb2-1329" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> train_scaled <span class="sc">|&gt;</span> </span>
<span id="cb2-1330"><a href="#cb2-1330" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">mutate</span>(<span class="at">ssvm_rs =</span> <span class="sc">-</span> <span class="fu">predict</span>(ssvm_fit, <span class="at">newdata =</span> train_scaled)<span class="sc">$</span>predicted <span class="sc">|&gt;</span> <span class="fu">as.vector</span>())</span>
<span id="cb2-1331"><a href="#cb2-1331" aria-hidden="true" tabindex="-1"></a>                  )</span>
<span id="cb2-1332"><a href="#cb2-1332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1333"><a href="#cb2-1333" aria-hidden="true" tabindex="-1"></a>pred_ssvm <span class="ot">&lt;-</span> <span class="fu">predsurv_cox</span>(ssvm_cox, <span class="fu">as.matrix</span>(test_scaled <span class="sc">|&gt;</span> </span>
<span id="cb2-1334"><a href="#cb2-1334" aria-hidden="true" tabindex="-1"></a>                                                 <span class="fu">mutate</span>(<span class="at">ssvm_rs =</span> ssvm_test_rs) <span class="sc">|&gt;</span> </span>
<span id="cb2-1335"><a href="#cb2-1335" aria-hidden="true" tabindex="-1"></a>                                                 <span class="fu">select</span>(ssvm_rs)</span>
<span id="cb2-1336"><a href="#cb2-1336" aria-hidden="true" tabindex="-1"></a>                                               ))</span>
<span id="cb2-1337"><a href="#cb2-1337" aria-hidden="true" tabindex="-1"></a>St_ssvm   <span class="ot">&lt;-</span> pred_ssvm<span class="sc">$</span>St</span>
<span id="cb2-1338"><a href="#cb2-1338" aria-hidden="true" tabindex="-1"></a>t_ssvm    <span class="ot">&lt;-</span> pred_ssvm<span class="sc">$</span>t</span>
<span id="cb2-1339"><a href="#cb2-1339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1340"><a href="#cb2-1340" aria-hidden="true" tabindex="-1"></a>brier_score_ssvm <span class="ot">&lt;-</span> <span class="fu">BSfun</span>(</span>
<span id="cb2-1341"><a href="#cb2-1341" aria-hidden="true" tabindex="-1"></a>    <span class="at">timepoints     =</span> timepoints,</span>
<span id="cb2-1342"><a href="#cb2-1342" aria-hidden="true" tabindex="-1"></a>    <span class="at">time   =</span> test<span class="sc">$</span>time,</span>
<span id="cb2-1343"><a href="#cb2-1343" aria-hidden="true" tabindex="-1"></a>    <span class="at">status =</span> test<span class="sc">$</span>status,</span>
<span id="cb2-1344"><a href="#cb2-1344" aria-hidden="true" tabindex="-1"></a>    <span class="at">St     =</span> St_ssvm,</span>
<span id="cb2-1345"><a href="#cb2-1345" aria-hidden="true" tabindex="-1"></a>    <span class="at">t      =</span> t_ssvm</span>
<span id="cb2-1346"><a href="#cb2-1346" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb2-1347"><a href="#cb2-1347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1348"><a href="#cb2-1348" aria-hidden="true" tabindex="-1"></a>brier_score_results6 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb2-1349"><a href="#cb2-1349" aria-hidden="true" tabindex="-1"></a>  brier_score_results5,</span>
<span id="cb2-1350"><a href="#cb2-1350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb2-1351"><a href="#cb2-1351" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model =</span> <span class="fu">rep</span>(<span class="st">"Survival SVM"</span>, <span class="fu">length</span>(timepoints)),</span>
<span id="cb2-1352"><a href="#cb2-1352" aria-hidden="true" tabindex="-1"></a>    <span class="at">Time =</span> timepoints,</span>
<span id="cb2-1353"><a href="#cb2-1353" aria-hidden="true" tabindex="-1"></a>    <span class="at">Brier_Score =</span> brier_score_ssvm</span>
<span id="cb2-1354"><a href="#cb2-1354" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-1355"><a href="#cb2-1355" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-1356"><a href="#cb2-1356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1357"><a href="#cb2-1357" aria-hidden="true" tabindex="-1"></a><span class="co"># Add IBS</span></span>
<span id="cb2-1358"><a href="#cb2-1358" aria-hidden="true" tabindex="-1"></a>c_index_results6 <span class="sc">|&gt;</span> </span>
<span id="cb2-1359"><a href="#cb2-1359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb2-1360"><a href="#cb2-1360" aria-hidden="true" tabindex="-1"></a>    brier_score_results6 <span class="sc">|&gt;</span> </span>
<span id="cb2-1361"><a href="#cb2-1361" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-1362"><a href="#cb2-1362" aria-hidden="true" tabindex="-1"></a>    <span class="at">Model =</span> <span class="fu">fct</span>(Model)</span>
<span id="cb2-1363"><a href="#cb2-1363" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb2-1364"><a href="#cb2-1364" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Model) <span class="sc">|&gt;</span></span>
<span id="cb2-1365"><a href="#cb2-1365" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb2-1366"><a href="#cb2-1366" aria-hidden="true" tabindex="-1"></a>    <span class="at">IBS =</span> <span class="fu">mean</span>(Brier_Score)</span>
<span id="cb2-1367"><a href="#cb2-1367" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb2-1368"><a href="#cb2-1368" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="st">"Model"</span></span>
<span id="cb2-1369"><a href="#cb2-1369" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb2-1370"><a href="#cb2-1370" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-1371"><a href="#cb2-1371" aria-hidden="true" tabindex="-1"></a>    <span class="co"># round stats by 3 decimal places</span></span>
<span id="cb2-1372"><a href="#cb2-1372" aria-hidden="true" tabindex="-1"></a>    <span class="at">Harrell_C =</span> <span class="fu">round</span>(Harrell_C, <span class="dv">3</span>),</span>
<span id="cb2-1373"><a href="#cb2-1373" aria-hidden="true" tabindex="-1"></a>    <span class="at">Uno_C_60  =</span> <span class="fu">round</span>(Uno_C_60, <span class="dv">3</span>),</span>
<span id="cb2-1374"><a href="#cb2-1374" aria-hidden="true" tabindex="-1"></a>    <span class="at">IBS       =</span> <span class="fu">round</span>(IBS, <span class="dv">3</span>)</span>
<span id="cb2-1375"><a href="#cb2-1375" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb2-1376"><a href="#cb2-1376" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Output to latex</span></span>
<span id="cb2-1377"><a href="#cb2-1377" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb2-1378"><a href="#cb2-1378" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">"latex"</span>,</span>
<span id="cb2-1379"><a href="#cb2-1379" aria-hidden="true" tabindex="-1"></a>    <span class="at">booktabs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-1380"><a href="#cb2-1380" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"C-index and Integrated Brier Score (IBS) for various models on the test set."</span></span>
<span id="cb2-1381"><a href="#cb2-1381" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-1382"><a href="#cb2-1382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1383"><a href="#cb2-1383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1384"><a href="#cb2-1384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1385"><a href="#cb2-1385" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot Brier Scores</span></span>
<span id="cb2-1386"><a href="#cb2-1386" aria-hidden="true" tabindex="-1"></a>brier_score_results6 <span class="sc">|&gt;</span> </span>
<span id="cb2-1387"><a href="#cb2-1387" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-1388"><a href="#cb2-1388" aria-hidden="true" tabindex="-1"></a>   <span class="at">Model =</span> <span class="fu">fct</span>(Model) </span>
<span id="cb2-1389"><a href="#cb2-1389" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb2-1390"><a href="#cb2-1390" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> Brier_Score, <span class="at">color =</span> Model)) <span class="sc">+</span></span>
<span id="cb2-1391"><a href="#cb2-1391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.1</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb2-1392"><a href="#cb2-1392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb2-1393"><a href="#cb2-1393" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-1394"><a href="#cb2-1394" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time (months)"</span>,</span>
<span id="cb2-1395"><a href="#cb2-1395" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Brier Score"</span>,</span>
<span id="cb2-1396"><a href="#cb2-1396" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="cn">NULL</span></span>
<span id="cb2-1397"><a href="#cb2-1397" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-1398"><a href="#cb2-1398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">60</span>, <span class="at">by =</span> <span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb2-1399"><a href="#cb2-1399" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb2-1400"><a href="#cb2-1400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb2-1401"><a href="#cb2-1401" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-1402"><a href="#cb2-1402" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb2-1403"><a href="#cb2-1403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb2-1404"><a href="#cb2-1404" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb2-1405"><a href="#cb2-1405" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>)</span>
<span id="cb2-1406"><a href="#cb2-1406" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-1407"><a href="#cb2-1407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1408"><a href="#cb2-1408" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"images/ml_brier_scores_all_models.png"</span>,</span>
<span id="cb2-1409"><a href="#cb2-1409" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">4</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb2-1410"><a href="#cb2-1410" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"images/ml_brier_scores_all_models.eps"</span>, <span class="at">device =</span> cairo_ps,</span>
<span id="cb2-1411"><a href="#cb2-1411" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">4</span>)</span>
<span id="cb2-1412"><a href="#cb2-1412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-1413"><a href="#cb2-1413" aria-hidden="true" tabindex="-1"></a><span class="co"># surv_obj &lt;- Surv(test$time, test$status)</span></span>
<span id="cb2-1414"><a href="#cb2-1414" aria-hidden="true" tabindex="-1"></a><span class="co"># Cindex(surv_obj, ssvm_pred$predicted)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="tidymodels-code" class="level2">
<h2 class="anchored" data-anchor-id="tidymodels-code"><code>Tidymodels</code> Code</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("tidymodels")</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ────────────────────────────────────── tidymodels 1.2.0 ──</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ broom        1.0.6      ✔ recipes      1.0.10
✔ dials        1.2.1      ✔ rsample      1.2.1 
✔ dplyr        1.1.4      ✔ tibble       3.2.1 
✔ ggplot2      4.0.1      ✔ tidyr        1.3.1 
✔ infer        1.0.7      ✔ tune         1.2.1 
✔ modeldata    1.3.0      ✔ workflows    1.1.4 
✔ parsnip      1.2.1      ✔ workflowsets 1.1.0 
✔ purrr        1.0.2      ✔ yardstick    1.3.1 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'scales' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.4.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──
✖ purrr::discard() masks scales::discard()
✖ dplyr::filter()  masks stats::filter()
✖ dplyr::lag()     masks stats::lag()
✖ recipes::step()  masks stats::step()
• Learn how to get started at https://www.tidymodels.org/start/</code></pre>
</div>
</div>



</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/lmaowisc\.github\.io\/BMI741");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>