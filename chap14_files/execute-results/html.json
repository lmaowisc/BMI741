{
  "hash": "c7fd7828d9b23c946a094ee315d831f7",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Applied Survival Analysis\"\nsubtitle: \"Chapter 14 - Causal Inference in Survival Analysis\"\ncss: style_slides.css\nauthor:\n  name: Lu Mao\n  affiliation: \n   - name: Department of Biostatistics & Medical Informatics\n   - University of Wisconsin-Madison\n  email: lmao@biostat.wisc.edu\nformat: \n  revealjs:\n    auto-stretch: false\neditor: visual\ninclude-in-header:\n  - text: |\n      <style type=\"text/css\">\n      ul li ul li {\n        font-size: 0.75em;\n      }\n      </style>\n---\n\n\n\n## Outline\n\n:::{.incremental}\n1.  The counterfactual framework\n\n2.  Inverse weighting and standardization\n\n3.  Estimating causal survival curves\n\n4.  Marginal structural models with time-varying treatment/confounding\n:::\n\n$$\\newcommand{\\d}{{\\rm d}}$$ $$\\newcommand{\\T}{{\\rm T}}$$ $$\\newcommand{\\dd}{{\\rm d}}$$ $$\\newcommand{\\cc}{{\\rm c}}$$ $$\\newcommand{\\pr}{{\\rm pr}}$$ $$\\newcommand{\\var}{{\\rm var}}$$ $$\\newcommand{\\se}{{\\rm se}}$$ $$\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}$$ $$\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}$$ $$\n\\newcommand\\mymathop[1]{\\mathop{\\operatorname{#1}}}\n$$ $$\n\\newcommand{\\Ut}{{n \\choose 2}^{-1}\\sum_{i<j}\\sum}\n\\def\\a{{(a)}} \\def\\b{{(1-a)}} \\def\\t{{(1)}} \\def\\c{{(0)}} \\def\\d{{\\rm d}} \\def\\T{{\\rm T}}\n$$\n\n\n\n# The Counterfactual Framework\n\n## Association vs Causation\n\n:::{.fragment}\n-   **Statistical inference**\n    -   **Association**: test of group difference, correlation, regression\n    -   **Causation**: informal or irrelevant\n:::\n:::{.fragment}\n-   **Causal inference**: study causal relationships \n    -   **Counterfactual framework**\n    -   **Causal diagrams**\n:::\n:::{.fragment}\n-   **Motivating example**: German Breast Cancer Study\n    -   Relapse-free survival ($T$) vs hormonal therapy ($A=1$: yes; $A=0$: no)\n    -   First assume $T$ is fully observed (no censoring)\n:::\n\n## RCT as Gold Standard\n:::{.fragment}\n-   **Randomized controlled trial (RCT)**\n    -   Patients randomly assigned to hormonal vs non-hormonal treatments\n\n    -   Two groups identical (exchangeable) in terms of baseline characteristic\n\n    -   Any between-group difference in relapse-free survival attributable to treatment (no confounding)\n\n        -   Increase in $t=5$ years relapse-free survival rate caused by hormonal treatment\n\n        $$\n        \\hat\\pr(T>t\\mid A=1)-\\hat\\pr(T>t\\mid A=0)\n        $$\n\n        -   (Causal) Hazard ratio under Cox model with binary group as covariate\n:::\n\n## Possible Confounding\n:::{.fragment}\n-   **Hormone non-randomized** ![](images/causal_tab1.png){fig-align=\"right\" width=\"100%\"}\n\n    -   Women under hormonal treatment more likely to be post-menopausal than non-treatment (76.0% vs 47.5%)\n    -   Difference in RFS $\\to$ treatment or menopause?\n    -   Confounder: menopausal status\n:::\n\n## Traditional Methods\n:::{.fragment}\n-   **Adjustment for confounding**\n    -   Log-rank test stratified by menopausal status (Ch. 3)\n    -   Cox regression with menopausal status as a covariate (Ch. 4; conditional hazard ratio)\n    -   Neither provides a population-level causal effect size of hormone treatment like that derived from an RCT\n:::\n:::{.fragment}\n-   **Goal**\n    -   Drawing causal inference in an RCT-like setting, even with observational data\n:::\n\n## Counterfactual Framework\n:::{.fragment}\n-   **Potential outcomes**\n    -   Each subject has two *potential* outcomes $T^{(a)}$ $(a=1, 0)$\n        -   $T^{(1)}$: had the subject been assigned to treatment\n        -   $T^{(0)}$: had the subject been assigned to control\n:::\n:::{.fragment}\n-   **Causal estimand**\n    -   Any contrast in distribution between $T^{(1)}$ vs $T^{(0)}$\n    -   **Example**\n        -   Survival probability: $\\pr(T^{(1)}>t)-\\pr(T^{(0)}>t)$\n        -   RMST: $E(T^{(1)}\\wedge t) - E(T^{(0)}\\wedge t)$\n:::\n\n## Exchangeability Assumption\n:::{.fragment}\n-   **Observed outcome**\n    -   $A = 1, 0$: actually assigned group $$T=AT^{(1)}+(1-A)T^{(0)}\\,\\,\\,\\, (\\rm consistency)$$\n:::\n:::{.fragment}\n-   **Assumptions**\n    -   **Complete randomization** $T^{(a)}\\indep A,\\hspace{5mm}a=1, 0$\n        -   Too strong, typically not satisfied\n    -   **Conditional exchangeability** \\begin{equation}\\label{eq:causal:cond_exch}\n        T^{(a)}\\indep A \\mid W,\\hspace{5mm} a=1, 0\n        \\end{equation}\n        -   Assignment independent of potential outcome given confounders $W$\n        -   All confounders are captured in $W$\n:::\n\n## Causal Diagrams\n:::{.fragment}\n-   **Directed Acyclic Graph**\n\n![](images/causal_dag.png){fig-align=\"right\" width=\"90%\"}\n:::\n\n# IPTW & Standardization\n\n## Estimand\n:::{.fragment}\n-   **Observed data** ($T_i$ fully observed)\n $$(T_i, A_i, W_i),\\,\\,\\,\\, i=1,\\ldots, n$$\n:::\n:::{.fragment}\n-   **Two classes of methods**\n    -   **Inverse probability treatment weighting (IPTW)**\n    -   **Standardization**\n:::\n:::{.fragment}\n-   **Causal estimand** \\begin{equation*}\n    S_a(t)=\\pr(T^{(a)}>t)\n    \\end{equation*}\n:::\n\n## Propensity Score\n:::{.fragment}\n-   **Selection bias**\n        $$\n        \\text{Naive estimator:}\\quad \\hat S_a^{\\rm naive}(t)=\\frac{\\sum_{i=1}^nI(A_i=a, T_i>t)}{\\sum_{i=1}^nI(A_i = a)}\n        $$\n      -   $(Y\\mid A = 1)$ and $(Y\\mid A = 0)$ non-representative of general population\n:::\n:::{.fragment}\n-   **Propensity score**\n     $$\n        \\pi_a(W)=\\pr(A=a\\mid W)\n     $$\n      -   Probability of entering treatment $a$\n      -   General population $\\stackrel{\\pi_a(W)}{\\rightleftarrows}$ Group $a$\n:::\n\n## IPTW\n:::{.fragment}\n-   **Re-constitute general population**\n    -   **Inverse weighting**: Group $a$ $\\stackrel{\\pi_a(W)^{-1}}{\\rightarrow}$ General population \\begin{equation}\\label{eq:causal:ipw_surv}\n        \\hat S_a^{\\rm IP}(t)=n^{-1}\\sum_{i=1}^n\\frac{I(A_i=a, T_i>t)}{\\pi_a(W_i)}\n        \\end{equation}\n    -   **Unbiased** \\begin{align*}\n        E\\left\\{\\frac{I(A=a, T>t)}{\\pi_a(W)}\\right\\}&=E\\left\\{\\frac{I(A=a, T^{(a)}>t)}{\\pi_a(W)}\\right\\}\\\\\n        &=E\\left[\\pi_a(W)^{-1}E\\left\\{I(A=a, T^{(a)}>t)\\mid W\\right\\}\\right]\\\\\n        &=E\\left\\{\\pi_a(W)^{-1}\\pr(A=a\\mid W)\\pr(T^{(a)}>t\\mid W)\\right\\}\\\\\n        &=E\\left\\{\\pr(T^{(a)}>t\\mid W)\\right\\}\\\\\n        &=S_a(t)\n        \\end{align*}\n:::\n\n## Estimate Propensity Score\n:::{.fragment}\n-   $\\pi_a(W)$ unknown unless by design\n    -   Estimate $\\hat\\pi_a(\\cdot)$ using $$\n        (A_i, W_i),\\,\\,\\ i=1,\\ldots,n \n        $$\n    -   Logistic regression/machine learning classification\n:::\n:::{.fragment}\n-   **IPTW estimator**\n    -   Plug in $\\hat\\pi_a(W_i)$ \\begin{equation}\n        \\hat S_a^{\\rm IP}(t)=n^{-1}\\sum_{i=1}^n\\frac{I(A_i=a, T_i>t)}{\\hat\\pi_a(W_i)}\n        \\end{equation}\n    -   Variance estimation needs to account for randomness in $\\hat\\pi_a(\\cdot)$\n:::\n\n## Standardization\n:::{.fragment}\n-   **Model outcome vs confounder**\n    -   Instead of treatment vs confounder $$\n        \\hat S_a(t\\mid W)= \\hat\\pr(T^{(a)}>t\\mid W)\n        $$\n    -   E.g., Cox model based on $$\n        \\{(T_i, W_i): A_i=a, i=1,\\ldots, n\\}\n        $$\n    -   $(T\\mid A =a, W) = (T^{(a)}\\mid A =a, W) = (T^{(a)}\\mid W)$ (conditional exchangeability)\n:::\n:::{.fragment}\n-   **Standardized estimator**\n    -   Average across population: $\\hat S_a^{\\rm reg}(t)=n^{-1}\\sum_{i=1}^n\\hat S_a(t\\mid W_i)$\n:::\n\n## IPTW vs Standardization\n:::{.fragment}\n-   **Modeling target**\n    -   **IPTW**: treatment vs confounder\n    -   **Standardization**: outcome vs confounder ![](images/causal_compare.png){fig-align=\"center\" width=\"32%\"}\n:::\n:::{.fragment}\n-   **Properties**\n    -   **Nonparametric setting** (categorical confounder): $\\hat S_a^{\\rm IP}(t)=\\hat S_a^{\\rm reg}(t)$\n    -   **Doubly robust estimator**: valid when *either* model is true, efficient when both are true\n:::\n\n# Estimating Causal Survival Curves\n\n## Dealing with Censored Data\n:::{.fragment}\n-   **In presence of censoring**\n    -   **IPTW** (+ IPCW)\n    -   **Standardardization** (adjust for cenosring)\n    -   **Observed data** $(X, \\delta, A, W)$\n        -   $X=T\\wedge C$, $\\delta = I(T\\leq C)$, $C$: censoring time\n:::\n:::{.fragment}\n-   **Two levels of coarsening**\n    -   $T^{(a)}\\to T$: treatment assignment\n    -   $T\\to (X, \\delta)$: Censoring\n:::\n\n## Assumptions about Censoring\n:::{.fragment}\n-   **Two types of assumption**\n    -   Censoring depends on confounder (general) \\begin{equation}\\label{eq:causal:indep_cens1}\n        T\\indep C\\mid (A, W)\n        \\end{equation}\n    -   Censoring not dependent on confounder \\begin{equation}\\label{eq:causal:indep_cens2}\n        T\\indep C\\mid A\n        \\end{equation}\n\n![](images/causal_censor_ass.png){fig-align=\"center\" width=\"60%\"}\n:::\n\n## IPCW\n:::{.fragment}\n-   **General assumption** $(W\\to C)$\n    -   Adjust for selection bias by censoring\n    -   Inverse probability treatment weighting (IPTW) + Inverse probability censoring weighting (IPCW)\n:::\n:::{.fragment}\n-   **Censoring weight**\n    -   $G_a(t\\mid W)=\\pr(C\\geq t\\mid A=a, W)$\n    -   E.g., Cox model fit on $$\n        (X_i, 1-\\delta_i, W_i)\\,\\,\\,\\, i=1,\\ldots, n\n        $$ with $C_i$ as outcome\n:::\n\n## Inverse Weighting\n:::{.fragment}\n-   **Selection probability**\n    -   In group $a$ and not censored by $t$: $\\pi_a(W)G_a(t\\mid W)$\n    -   **Inverse weight** $$\n        \\hat w_{ai}(t)=\\frac{I(A_i=a)}{\\hat\\pi_a(W_i)\\hat G_a(t\\mid W_i)}\n        $$\n:::\n:::{.fragment}\n-   **IPT(C)W-adjusted KM estimator**\n    -   $N_i(t)=I(X_i\\leq t,\\delta_i=1)$ \\begin{equation}\\label{eq:causal_ipcw}\n        \\hat S_a^{\\rm IP}(t)=\\prod_{0\\leq u\\leq t}\\left\\{1-\\frac{\\sum_{i=1}^n \\hat w_{ai}(u)\\dd N_i(u)}{\\sum_{i=1}^n \\hat w_{ai}(u)I(X_i\\geq u)}\\right\\}\n        \\end{equation}\n    -   If $(T\\indep C)\\mid A$, then $\\hat G_a(t\\mid W_i)\\equiv 1$\n:::\n\n## Causal Cox Model\n:::{.fragment}\n-   **Marginal structural model**\n    -   $\\lambda_a(t)$: hazard function of $T^{(a)}$ \\begin{equation}\\label{eq:causal:msm_cox}\n        \\lambda_a(t)=\\exp(a\\beta)\\lambda_0(t)\n        \\end{equation}\n:::\n:::{.fragment}\n-   **IPT(C)W-adjusted partial likelihood score**\n    -   $\\hat w_i(t)=\\{\\hat\\pi_{A_i}(W_i)\\hat G_{A_i}(t\\mid W_i)\\}^{-1}$ \\begin{equation}\\label{eq:causal:score}\n        n^{-1}\\sum_{i=1}^n\\int_0^\\infty\\left\\{A_i-\\frac{\\sum_{j=1}^nA_j\\hat w_{j}(t) I(X_j\\geq t)\\exp(A_j\\beta)}\n        {\\sum_{j=1}^n \\hat w_{j}(t) I(X_j\\geq t)\\exp(A_j\\beta)}\\right\\}\\hat w_{i}(t)\\dd N_i(t)=0\n        \\end{equation}\n    -   $\\exp(\\beta)$: causal hazard ratio\n:::\n\n## Standardization Approach\n:::{.fragment}\n-   **Two-steps**\n    -   Outcome (censored) vs confounder $$S_a(t\\mid W)=\\pr(T^{(a)}>t\\mid W)$$\n    -   Average $\\hat S_a^{\\rm reg}(t)=n^{-1}\\sum_{i=1}^n\\hat S_a(t\\mid W_i)$\n    -   Standard software\n:::\n\n## Software: `ipw::ipwpoint()`\n:::{.fragment}\n-   **Basic syntax for computing propensity scores**\n    -   `A`: A; `confounders`: W\n    -   `family = \"binomial\", link=\"logit\"`: logistic regression for binary $A$\n\n::: big-code\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntmp <- ipwpoint(exposure = A, denominator=~ confounders,\n                family = \"binomial\", link=\"logit\")\n```\n:::\n\n\n:::\n:::\n:::{.fragment}\n-   **Output**\n\n    -   `tmp$ipw.weights`: $n$-Vector of inverse weights\n    -   Plug in `survfit()` and `coxph()`\n\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    # IPTW-adjusted KM\n    obj <- survfit(Surv(time,status) ~ A, weights = tmp$ipw.weights)\n    ```\n    :::\n\n\n:::\n\n## GBC: An Example\n:::{.fragment}\n-   **German Breast Cancer study**\n    -   $A$: hormone treatment (1) vs no treatment (0)\n    -   $T$: relapse-free survival time\n    -   $𝑊$: confounders (menopausal status, tumor size, tumor grade, progesterone and estrogen receptor levels)\n:::\n:::{.fragment}\n-   **Assumption about censoring**\n    $$(T\\indep C)\\mid A$$ \n    -   Only IPTW needed (no IPCW)\n:::\n\n\n## GBC: Coding & Results\n:::{.fragment}\n-   **IPTW-adjusted vs unweighted KM**\n    -   Causal hazard ratio: 69.5% ($p$-value 0.006)\n\n    -   Standard error may be incorrect due to randomness in estimated weights\n\n        -   Bootstrap\n\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    # estimate propensity score\n    tmp <- ipwpoint(exposure = A, family=\"binomial\",link=\"logit\",\n                 denominator =~ meno + size + factor(grade) + nodes + prog \n                          + estrg, data=data.CE)\n    # IPTW-adjusted KM\n    obj <- survfit(Surv(time, status) ~ A, weights = tmp$ipw.weights, \n                           data = data.CE)\n    # IPTW Cox model (essentially a marginal structural Cox model)\n    coxph(Surv(time,status) ~ A, weights=tmp$ipw.weights, data=data.CE)\n    #>       coef exp(coef) se(coef) robust se     z       p\n    #> A -0.36947   0.69110  0.08318   0.13632 -2.71 0.00672\n    ```\n    :::\n\n\n:::\n\n## GBC: IPTW vs Naive\n:::{.fragment}\n-   **Confounding not obvious**\n\n![](images/causal_gbc.png){fig-align=\"center\" width=\"60%\"}\n:::\n\n# Marginal Structural Models (MSM)\n\n## Point Treatment\n:::{.fragment}\n-   **Causal inference**\n    -   Relationship between $T^{(a)}$ vs $a$, rather than $T$ vs $A$\n:::\n:::{.fragment}\n-   **Marginal structural models**\n    -   **Definition**: a model for $T^{(a)}$ against $a$, possibly adjusting for baseline covariates $V\\subset W$\n    -   **Marginal**: no need to condition on full $W$ as covariates\n    -   **Structural**: treatment is $a$ (as in RCT), not observed $A$\n    -   **Simplest case**: $V=\\emptyset$ \\begin{equation}\n        \\lambda_a(t)=\\exp(a\\beta)\\lambda_0(t)\n        \\end{equation}\n    -   Most useful in time-varying treatment/confounding\n:::\n\n## Marginal Structural Cox Model\n:::{.fragment}\n-   **General form**\n    -   $\\lambda_a(t\\mid V)$: conditional hazard of $T^{(a)}$ given $V$ \\begin{equation}\\label{eq:causal:msm_cox1}\n        \\lambda_a(t\\mid V)=\\exp(\\beta a+\\gamma^{\\rm T}V)\\lambda_0(t)\n        \\end{equation}\n    -   $\\exp(\\beta)$: causal hazard ratio for treatment vs control adjusting for $V$\n        -   Different from the causal HR conditional on all of $W$\n    -   Treatment $\\times$ covariate interaction \\begin{equation}\\label{eq:causal:msm_cox2}\n        \\lambda_a(t\\mid V)=\\exp(\\beta a+\\gamma^{\\rm T}V+a\\eta^{\\rm T}V)\\lambda_0(t)\n        \\end{equation}\n:::\n\n## Fitting MSM\n:::{.fragment}\n-   **General assumption**: $T\\indep C\\mid (A, W)$\n\n-   **Weight construction**\n\n    -   **Standard IPTW-IPCW weights** $$w_i(t)=\\frac{1}{\\pi_{A_i}(W_i)G_{A_i}(t\\mid W_i)}$$\n    -   **Stablized IPTW-IPCW weights** \\begin{equation}\\label{eq:causal:swights}\n        w^{\\rm s}_i(t)=\\frac{\\pi_{A_i}(V_i)G_{A_i}(t\\mid V_i)}{\\pi_{A_i}(W_i)G_{A_i}(t\\mid W_i)},\n        \\end{equation}\n        -   $\\pi_{a}(V)=\\pr(A=a\\mid V)$ and $G_{a}(t\\mid V)=\\pr(C>t\\mid A=a, V)$\n        -   Set $G_{a}(t\\mid V)=G_{a}(t\\mid W)\\equiv 1$ if $W\\not\\to C$\n:::\n\n## Weighted Partial-Likelihood Score\n:::{.fragment}\n-   **Using stablized weights**\n \\begin{equation}\\label{eq:causal:msm_ee}\n        n^{-1}\\sum_{i=1}^n\\int_0^\\infty\\left\\{Z_i-\\frac{\\sum_{j=1}^nZ_j\\hat w^{\\rm s}_j(t) I(X_j\\geq t)\\exp(\\zeta^{\\rm T}Z_j)}\n        {\\sum_{j=1}^n \\hat w^{\\rm s}_j(t) I(X_j\\geq t)\\exp(\\zeta^{\\rm T}Z_j)}\\right\\} \\hat w^{\\rm s}_i(t)\\dd N_i(t)=0\n        \\end{equation}\n    -   $\\hat w^{\\rm s}_i(t)$: an estimate of $w^{\\rm s}_i(t)$\n    -   $Z_i=(A_i, V_i^{\\rm T})^{\\rm T}$ and $\\zeta=(\\beta,\\gamma^{\\rm T})^{\\rm T}$\n:::\n\n## Time-Varying Treatment\n:::{.fragment}\n-   **MSM**\n    -   Adjust for confounders $\\not\\leftrightarrow$ adjust for covariates\n    -   Conditioning on covariate changes meaning of covariate effects\n:::\n:::{.fragment}\n-   **Most useful in time-varying treatment/confounding**\n    -   Mediator of previous treatment $\\leftrightarrow$ Confounder for current/future treatment\n    -   Previous anti-retroviral treatment $\\to$ current CD4 count $\\stackrel{\\rm prescribe}{\\rightarrow}$ ART\n        -   Conditioning on CD4 $\\to$ corrects confounding for current trt, blocks causal path of previous trt\n:::\n\n## Notation & DAG\n:::{.fragment}\n-   **Notation**\n    -   $a(t)$: hypothetical treatment at $t$; $A(t)$: observed treatment at $t$\n    -   $W(t)$: possible confounders at $t$\n    -   Discretization\n        -   $0=t_0<t_1<\\cdots<t_m$: time points\n        -   $A_{\\cdot j}=A(t_j)$ and $W_{\\cdot j}=W(t_j)$\n        -   $\\overline A_{\\cdot j}=\\{A_{\\cdot 0},\\ldots, A_{\\cdot j}\\}$; $\\overline W_{\\cdot j}=\\{W_{\\cdot 0},\\ldots, W_{\\cdot j}\\}$; $V\\subset W_{\\cdot 0}$: baseline covariates\n\n![](images/causal_tm_dag.png){fig-align=\"center\" width=\"50%\"}\n:::\n\n## MSM for Time-Varying Treatment\n:::{.fragment}\n-   **Modeling target**\n    -   **Treatment path (sequence)**: $\\overline a(t)=\\{a(u): 0\\leq u\\leq t\\}$\n    -   **Outcome**: $T^{(\\overline a)}$ = potential outcome under treatment path $\\overline a(\\infty)$ against $a(\\cdot)$\n:::\n:::{.fragment}\n-   **Model specification**\n    -   $\\lambda_{\\overline a}(t\\mid V)$: conditional hazard of $T^{(\\overline a)}$ given $V$ \\begin{equation}\\label{eq:causal:msm_tv}\n        \\lambda_{\\overline a}(t\\mid V)=\\exp\\{\\beta a(t)+\\gamma^{\\rm T}V\\}\n        \\end{equation}\n    -   Cox model with *external* (why?) time-varying covariate $a(t)$\n        -   Replace $a(t)$ by any summary of $\\overline a(t)$, e.g., total time on treatment\n:::\n\n## Sequential Randomization Assumption\n:::{.fragment}\n-   **Sequential conditional exchangeability**\n    -   An time-varying version of CE \\begin{equation}\\label{eq:causal:cond_exch1}\n        T^{(\\overline a)}\\indep A_{\\cdot j}\\mid (\\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})  \\hspace{2mm}j=1,\\ldots, m.\n        \\end{equation}\n    -   Treatment assignment random given previous treatments and current/previous confounders (biomarkers)\n:::\n\n## Longitudinal Weights\n:::{.fragment}\n-   **At time** $t_j$\n    -   **Propensity scores/non-censoring hazards** \\begin{align}\n        \\pi_k(t_j; \\overline A_{\\cdot, j-1}, V)&=\\pr(A_{\\cdot j}=k\\mid \\overline A_{\\cdot, j-1}, V)\\\\\n        \\pi_k(t_j; \\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})&=\\pr(A_{\\cdot j}=k\\mid \\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})\\\\\n        \\lambda_C(t_j\\mid \\overline A_{\\cdot, j-1}, V)&=\\pr(C>t_j \\mid \n        C>t_{j-1}, \\overline A_{\\cdot, j-1}, V)\\\\\n        \\lambda_C(t_j\\mid \\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})&=\\pr(C>t_j \\mid \n        C>t_{j-1}, \\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})\n        \\end{align}\n:::\n:::{.fragment}\n-   **Stablized weight at** $t$\n    -   **IPTW + IPCW** \\begin{equation}\\label{eq:causal:swights_tv}\n        w^{\\rm s}(t)=\\prod_{t_j\\leq t}\\frac{\\pi_{A_{\\cdot, j}}(t_j; \\overline A_{\\cdot, j-1}, V)\\lambda_C(t_j\\mid \\overline A_{\\cdot, j-1}, V)}\n        {\\pi_{A_{\\cdot, j}}(t_j; \\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})\\lambda_C(t_j\\mid \\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})}\n        \\end{equation}\n:::\n\n## Weighted Partial-Likelihood Score\n:::{.fragment}\n-   **Using stablized weights**\n    -   $\\hat w^{\\rm s}_i(t)$: estimated $w^{\\rm s}(t)$ for $i$th subject \\begin{align*}\n        n^{-1}\\sum_{i=1}^n\\int_0^\\infty\\left\\{Z_i(t)-\\frac{\\sum_{j=1}^n\\hat w^{\\rm s}_j(t) Z_j(t) I(X_j\\geq t)\\exp\\{\\zeta^{\\rm T}Z_j(t)\\}}\n        {\\sum_{j=1}^n \\hat w^{\\rm s}_j(t) I(X_j\\geq t)\\exp\\{\\zeta^{\\rm T}Z_j(t)\\}}\\right\\} \\hat w^{\\rm s}_i(t)\\dd N_i(t)\n        \\end{align*}\n        -   $Z_i(t)=\\{A_i(t), V_i^{\\rm T})\\}^{\\rm T}$; $\\zeta=(\\beta,\\gamma^{\\rm T})^{\\rm T}$\n:::\n\n## Software: `ipw::ipwtm()` (I)\n:::{.fragment}\n-   **Input data** (long format)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(haartdat)\n # patient tstart fuptime haartind event sex age      cd4 endtime dropout\n #       1   -100       0        0     0   1  22 23.83275    2900       0\n #       1      0     100        0     0   1  22 25.59297    2900       0\n #       1    100     200        0     0   1  22 23.47339    2900       0\n #       1    200     300        0     0   1  22 24.16609    2900       0\n #       1    300     400        0     0   1  22 23.23790    2900       0\n #       1    400     500        0     0   1  22 24.85961    2900       0\n # ...\n```\n:::\n\n\n:::\n\n## Software: `ipw::ipwtm()` (II)\n:::{.fragment}\n-   **Basic syntax for IPTW weights**\n    -   `trt`: treatment indicator; `V`: baseline covariates $V$; `W`: (time-varying) confounders; `(tstart, timevar)`: start/stop times; `id`: subject identifier\n\n::: big-code\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# treatment changes only once, from 0 to 1, \n# e.g., initiation of ART \niptw <- ipwtm(exposure = trt, family = \"survival\",\n        numerator =~ V, denominator =~ W, id, \n        tstart, timevar, type = \"first\")\n\n# treatment binary and changes arbitrarily\niptw <- ipwtm(exposure = trt, family = \"binomial\",\n        link=\"logit\", numerator =~ V, denominator =~ W,\n        id, type = \"all\")\n```\n:::\n\n\n:::\n:::\n\n## Software: `ipw::ipwtm()` (III)\n:::{.fragment}\n-   **IPTW output**:\n    -   `iptw$ipw.weights`: $$\n         \\prod_{t_j\\leq t}\\frac{\\pi_{A_{\\cdot, j}}(t_j; \\overline A_{\\cdot, j-1}, V)}\n        {\\pi_{A_{\\cdot, j}}(t_j; \\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})}\n         $$\n-   **Basic syntax for IPCW weights**\n    -   `censor = 1`: censored, `0`: not censored\n\n::: big-code\n\n\n::: {.cell}\n\n```{.r .cell-code}\nipcw <- ipwtm(exposure = censor, family = \"survival\",\n        numerator = ~V, denominator = ~W, id, \n        tstart, timevar, type = \"first\")\n```\n:::\n\n\n:::\n:::\n\n## Software: `ipw::ipwtm()` (III)\n:::{.fragment}\n-   **IPCW output**:\n    -   `ipcw$ipw.weights`: $$\n        \\prod_{t_j\\leq t}\\frac{\\lambda_C(t_j\\mid \\overline A_{\\cdot, j-1}, V)}\n        {\\lambda_C(t_j\\mid \\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})}\n         $$\n:::\n:::{.fragment}\n-   **Fit MSM using combined weights**\n    -   `iptw$ipw.weights * ipcw$ipw.weights`: $\\hat w^{\\rm s}_i(t)$\n\n::: big-code\n\n\n::: {.cell}\n\n```{.r .cell-code}\nobj <- coxph(Surv(tstart, timevar, status) ~ trt + V \n             + cluster(id), \n             weights = iptw$ipw.weights * ipcw$ipw.weights)\n```\n:::\n\n\n:::\n:::\n\n## An HIV Study\n:::{.fragment}\n-   **Study infomation**\n    -   **Population**: 1200 HIV-infected patients (van der Wal and Geskus, 2011) followed until death or censoring\n    -   **Treatment**: Some initiate **highly active anti-retroviral therapy (HAART)** during follow-up, as determined by patient *CD4 cell count*\n        -   $A=$ `haartind`; $V=$ `sex, age`; $W=$ `sex, age, cd4`\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(haartdat)\n # patient tstart fuptime haartind event sex age      cd4 endtime dropout\n #       1   -100       0        0     0   1  22 23.83275    2900       0\n #       1      0     100        0     0   1  22 25.59297    2900       0\n #       1    100     200        0     0   1  22 23.47339    2900       0\n # ...\n```\n:::\n\n\n:::\n\n## Fit MSM for HAART\n:::{.fragment}\n-   **Compute weights and fit model**\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Compute the IPTW weights\niptw <- ipwtm(exposure = haartind, family = \"survival\",\n          numerator = ~ sex + age, denominator = ~ cd4 + sex +\n          age, id = patient, tstart = tstart, timevar = fuptime, \n          type = \"first\", data = haartdat)\n\n# Compute the IPCW weights\nipcw <- ipwtm(exposure = dropout, family = \"survival\",\n          numerator = ~ sex + age, denominator = ~ cd4 + sex +\n          age, id = patient, tstart = tstart, timevar = fuptime, \n          type = \"first\", data = haartdat)\n\n# Fit IPTW/IPCW marginal structural Cox model\nobj <- coxph(Surv(tstart, fuptime, event) ~ haartind + sex +\n             age + cluster(patient), data = haartdat, \n             weights = iptw$ipw.weights * ipcw$ipw.weights)\n```\n:::\n\n\n:::\n\n## Inference\n:::{.fragment}\n-   **Results**\n    -   HAART initiation reduces the mortality risk by $1 – 0.382 = 61.8\\%$\n    -   Cox model without adjusting for CD4 confounding $\\to$ only $46.1\\%$ reduction\n        -   Patients who initiate HAART tend to have poor prognosis\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(obj)\n#>              coef exp(coef) se(coef) robust se      z Pr(>|z|)    \n#> haartind -0.96171   0.38224  0.43017   0.45148 -2.130 0.033160 *  \n#> sex       0.09761   1.10253  0.43770   0.45351  0.215 0.829592    \n#> age       0.06400   1.06609  0.01414   0.01678  3.815 0.000136 ***\n```\n:::\n\n\n\n::: callout-note\n### Exercise\n\nWhat happens if you adjust for CD4 cell count as a time-varying *covariate*?\n:::\n:::\n\n# Conclusion\n\n## Notes (I)\n\n-   **Counterfactual framework**\n    -   Causal inference for statistics, social, and biomedical sciences (Imbens and Rubin, 2015)\n-   **Point/time-varying treatment/confounding**\n    -   Causal inference: what if (Hernan and Robins, 2024)\n        -   [https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book](https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/)\n-   **Directed acyclic graph (DAG) approach**\n    -   Causality: models, reasoning, and inference (Pearl, 2011)\n\n## Notes (II)\n\n-   **Texts**\n\n![](images/causal_books.png){fig-align=\"center\" width=\"85%\"}\n\n## Summary (I)\n\n-   **Counterfactual framework**\n    -   **Potential outcomes** $T^{(a)}$ $(a=1, 0)$- mimicking RCT\n-   **Conditional exchangeability**\n    -   All confounders captured in $W$ ![](images/causal_censor_ass.png){fig-align=\"center\" width=\"62%\"}\n-   **Methods**\n    -   Inverse probability treatment weighting (IPTW; `ipw` R-package)\n    -   Standardization\n\n## Summary (II)\n\n-   **Marginal structural model (MSM)** \\begin{equation}\n        \\lambda_{\\overline a}(t\\mid V)=\\exp\\{\\beta a(t)+\\gamma^{\\rm T}V\\}\n        \\end{equation} ![](images/causal_tm_dag.png){fig-align=\"center\" width=\"50%\"}\n    -   IPTW/IPCW computed by `ipw::ipwtm()` and fed into `survival::coxph()`\n\n## HW6 (Due April 30)\n\n-   Problem 12.11\n-   Problem 13.13\n-   Problem 14.10\n-   (Extra credit) Problem 14.9\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}