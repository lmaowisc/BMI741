[
  {
    "objectID": "win_ratio.html",
    "href": "win_ratio.html",
    "title": "Defining estimand for the win ratio",
    "section": "",
    "text": "This is a talk I give at the FDA/AdvaMed Medical Device Statistical Issues (MDSI) Conference on April 3rd, 2024 in Washington, DC.\nTalk slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)"
  },
  {
    "objectID": "test.html#slide-1",
    "href": "test.html#slide-1",
    "title": "Test presentations",
    "section": "Slide 1",
    "text": "Slide 1"
  },
  {
    "objectID": "test.html#slide-2",
    "href": "test.html#slide-2",
    "title": "Test presentations",
    "section": "Slide 2",
    "text": "Slide 2\n\nTopic 1"
  },
  {
    "objectID": "test.html#slide-3",
    "href": "test.html#slide-3",
    "title": "Test presentations",
    "section": "Slide 3",
    "text": "Slide 3\n\nPlay with some graphics"
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Welcome to BMI/STAT 741",
    "section": "",
    "text": "This site will post additional study materials for BMI/STAT 741 in Spring 2025. These include slides, extra data/code examples or mathematical results.\nPlease check updated syllabus for course schedule and other information."
  },
  {
    "objectID": "HW1_solution.html",
    "href": "HW1_solution.html",
    "title": "HW1 sample solution (Spring 2025)",
    "section": "",
    "text": "\\(\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\) \\(\\newcommand{\\pr}{{\\rm pr}}\\)"
  },
  {
    "objectID": "HW1_solution.html#problem-1.1",
    "href": "HW1_solution.html#problem-1.1",
    "title": "HW1 sample solution (Spring 2025)",
    "section": "Problem 1.1",
    "text": "Problem 1.1\n\n\n\n\n\n\nQuestion\n\n\n\nSuppose that patient enrollment (and randomization) is uniform in calendar time \\([0, \\tau_b]\\) and that the study is terminated at calendar time \\(\\tau_c\\) \\((\\tau_c&gt;\\tau_b)\\). What is the distribution of the administrative censoring time? (Hint: see Fig. 1.1) Further suppose that patients are subject to a random LTFU following an exponential distribution with hazard \\(\\lambda_L\\) (whose survival function is \\(\\exp(-\\lambda_L t)\\)). Write out the survival function for the censoring time \\(C\\) (i.e., the earlier of administrative censoring and LTFU times).\n\n\nThe administrative censoring time \\(C_A\\) is defined as the duration between time of enrollment, \\(R\\sim \\mbox{Unif}[0, \\tau_b]\\), and time of study termination \\(\\tau_c\\) (see Fig. 1.1). So \\[C_A = (\\tau_c - R) \\sim \\mbox{Unif}[\\tau_c - \\tau_b, \\tau_c].\\] As a result, \\[{\\rm pr}(C_A &gt; t) = \\left(\\frac{\\tau_c - t}{\\tau_b}\\wedge 1\\right)_+\n=\\left\\{\n\\begin{array}{lr}\n1&  0\\leq t \\leq \\tau_c - \\tau_b\\\\\n\\frac{\\tau_c - t}{\\tau_b}& \\tau_c - \\tau_b &lt; t \\leq \\tau_c\\\\\n0 & t\\geq \\tau_c\n\\end{array}\n\\right.,\n\\] where \\(x_+=\\max(x, 0)\\).\nOn the other hand, the survival function for LTFU \\(C_L\\) is \\({\\rm pr}(C_L &gt; t) = \\exp(-\\lambda_L t)\\). Assuming \\(C_A\\indep C_L\\), the survival function for the overall censoring time \\(C\\) is \\[\\begin{align}\n{\\rm pr}(C &gt; t)&={\\rm pr}(C_A\\wedge C_L &gt; t)\\\\\n&={\\rm pr}(C_A &gt; t){\\rm pr}(C_L &gt; t)\\\\\n&=\\left(\\frac{\\tau_c - t}{\\tau_b}\\wedge 1\\right)_+\\exp(-\\lambda_L t)\n\\end{align}\\]"
  },
  {
    "objectID": "HW1_solution.html#problem-1.2",
    "href": "HW1_solution.html#problem-1.2",
    "title": "HW1 sample solution (Spring 2025)",
    "section": "Problem 1.2",
    "text": "Problem 1.2\n\n\n\n\n\n\nQuestion\n\n\n\nShow that \\(S_{\\rm imp}(t)\\leq S(t)\\) for all \\(t\\) whether censoring is independent or not. Give a simple sufficient condition for strict inequality under \\(C\\indep T\\).\n\n\nBecause \\(X=\\min(T,C)\\), we have that \\(X\\leq T\\) always. Therefore, \\(X&gt;t\\) implies \\(T&gt;t\\). Hence \\(\\pr(X&gt;t)\\leq \\pr(T&gt;t)\\). Under independence, we have that \\[\nS_{\\rm imp}(t)=\\pr(X&gt;t)=\\pr(T&gt;t)\\pr(C&gt;t)=S(t)\\pr(C&gt;t),\n\\] which is strictly less than \\(S(t)\\) if \\(\\pr(C&gt;t)&lt;1\\) and \\(S(t)&gt;0\\). That is, if there is a positive probability of censoring before \\(t\\) and a positive probability of failure after it."
  },
  {
    "objectID": "HW1_solution.html#problem-1.3-extra-credit",
    "href": "HW1_solution.html#problem-1.3-extra-credit",
    "title": "HW1 sample solution (Spring 2025)",
    "section": "Problem 1.3 (extra credit)",
    "text": "Problem 1.3 (extra credit)\n\n\n\n\n\n\nQuestion\n\n\n\nFormulate a survival function estimator under the “nonevent-imputation” approach described in Section 1.2.2 and show that it overestimates \\(S(t)\\) whether censoring is independent or not. Give a simple sufficient condition for strict overestimation under \\(C\\indep T\\).\n\n\nNon-event imputation means imputing event time to \\(\\infty\\) whenever censored, i.e., \\[\n\\hat T_i = \\left\\{\n\\begin{array}{cc}\nT_i, &\\delta_i =1\\\\\n\\infty,&\\delta_i =0\n\\end{array}\n\\right.\n\\] So the empirical survival function based on the \\(\\hat T_i\\) is \\[\\begin{align}\nn^{-1}\\sum_{i=1}^n I(\\hat T_i &gt;t) &= n^{-1}\\sum_{i=1}^n\\left\\{\\delta_iI(T_i &gt; t) + (1-\\delta_i)\\right\\}\\\\\n&= 1 - n^{-1}\\sum_{i=1}^n\\delta_i I(T_i\\leq t)\\\\\n&\\to 1- \\pr(T\\leq t\\wedge C)\\\\\n&= \\pr(T &gt; t\\wedge C)\\\\\n&\\geq \\pr(T &gt; t)\\\\\n& = S(t).\n\\end{align}\\] This shows that the estimator overestimates \\(S(t)\\) regardless of whether censoring is independent. Under \\(C\\indep T\\), \\[\n\\pr(T &gt; t\\wedge C) = E\\{S(C\\wedge t)\\}.\n\\] It turns out that there is no “simple” condition for the right hand side to be strictly greater than \\(S(t)\\). But the following condition works: (1) there exists \\(t_0 &lt; t\\) such that \\(S(t_0)&gt; S(t)\\); and (2) \\(\\pr(C\\leq t_0)&gt;0\\). That is, there is a positive probability of censoring before a point to the left of \\(t\\) where the survival rate is strictly greater than \\(S(t)\\). The proof is left as an exercise."
  },
  {
    "objectID": "HW1_solution.html#problem-1.8",
    "href": "HW1_solution.html#problem-1.8",
    "title": "HW1 sample solution (Spring 2025)",
    "section": "Problem 1.8",
    "text": "Problem 1.8\n\n\n\n\n\n\nQuestion\n\n\n\nSummarize the CGD (chronic granulomatous disease) study data described in Example 1.3 by the randomized treatment group in terms of patient baseline characteristics and event rates. Comment on the balance of baseline characteristics between the treatment arms. Also be sure to include the event rates for both\n\nthe first infection;\nrecurrent infections (including the first).\n\nOrganize your results in a table suitable for inclusion as “Table 1” in a medical research paper. (The study dataset is in cgd.txt.)\n\n\nThe baseline patient characteristics and events rates for the CGD study are summarized by treatment arm in Table 1 below. Most of the baseline characteristics are well balanced between the randomized arms, except that the proportion of X-linked inheritance is slightly higher in the treatment arm (71.4%) than in the control arm (63.1%). The event rates for both first and recurrent infections are substantially lower in the treatment arm.\n\n\n\n\n\n\n\nBase R approach\n## Read in the CGD  data\n\ndata &lt;- read.table(\"Chronic Granulomatous Disease Study//cgd.txt\")\nhead(data)\n\n\n###########################################################\n# Table 1 Patient characteristics for the CGD study\n###########################################################\n\n\n##A function calculating median (IQR) by \n## binary group\n## Input: y=quantitative variable\n##        trt=binary group variable\n##        decp=number of decimal points\n## Output: a row vector containing median (IQR)\n##    by the two levels of trt and overall \n\nMean.IQR.by.trt=function(y,trt,decp=1){\n  groups=sort(unique(trt))\n  all=quantile(y)\n  g1=quantile(y[trt==groups[1]])\n  g2=quantile(y[trt==groups[2]])\n  \n  result=matrix(NA,1,3)\n  colnames(result)=c(groups,\"Overall\")\n  result[1,1]=paste0(round(g1[3],decp),\" (\",round(g1[2],decp),\", \",round(g1[4],decp),\")\")\n  result[1,2]=paste0(round(g2[3],decp),\" (\",round(g2[2],decp),\", \",round(g2[4],decp),\")\")\n  result[1,3]=paste0(round(all[3],decp),\" (\",round(all[2],decp),\", \",round(all[4],decp),\")\")\n  return(result)\n}\n\n\n##A function calculating N (%) by \n## binary group\n## Input: x=categorical variable with p levels\n##        trt=binary group variable\n##        decp=number of decimal points of %\n## Output: a px3 matrix containing N (%) for each level of x\n##    by the two levels of trt and overall \n\nN.prct.by.trt=function(x,trt,decp=1){\n  groups=sort(unique(trt))\n  x.levels=sort(unique(x))\n  p=length(x.levels)\n  n=length(x)\n  n1=length(x[trt==groups[1]])\n  n2=length(x[trt==groups[2]])\n  \n  result=matrix(NA,p,3)\n  colnames(result)=c(groups,\"Overall\")\n  rownames(result)=x.levels\n  \n  for (i in 1:p){\n    n1i=sum(x[trt==groups[1]]==x.levels[i])\n    n2i=sum(x[trt==groups[2]]==x.levels[i])\n    ni=sum(x==x.levels[i])\n    \n    \n  result[i,1]=paste0(n1i,\" (\",round(n1i/n1*100,decp),\"%)\")\n  result[i,2]=paste0(n2i,\" (\",round(n2i/n2*100,decp),\"%)\")\n  result[i,3]=paste0(ni,\" (\",round(ni/n*100,decp),\"%)\")\n  }\n  \n  \n  return(result)\n}\n\n\n##Baseline characteristics by treatment arm:\n# sex\n# Sex of each patient(male, female)\n# \n# age\n# Age of each patient at study entry, in years\n# \n# height\n# Height of each patient at study entry, in cm\n# \n# weight\n# Weight of each patient at study entry, in kg\n# \n# inherit\n# Pattern of inheritance (autosomal recessive, X-linked)\n# \n# steroids\n# Using corticosteroids at times of study centry(1=Yes, 0=No)\n# \n# propylac\n# Using prophylactic antibiotics at time of study entry(1=Yes, 0=No)\n\n\n####################################################\n# To calculate the baseline characteristics,\n# first subset to one record per patient.\n# We do this by getting the first record \n#####################################################\n\no &lt;- order(data$id,data$time)\ndata &lt;- data[o,]\ndat &lt;- data[!duplicated(data$id),]\nn &lt;- nrow(dat)\n#n=128: number of subjects\n\ntable1 &lt;- rbind(\n  N.prct.by.trt(x=dat$sex,trt=dat$trt),\n  Mean.IQR.by.trt(y=dat$age,trt=dat$trt),\n  Mean.IQR.by.trt(y=dat$hght,trt=dat$trt),\n  Mean.IQR.by.trt(y=dat$wght,trt=dat$trt),\n  N.prct.by.trt(x=dat$inherit,trt=dat$trt),\n  N.prct.by.trt(x=dat$stero,trt=dat$trt),\n  N.prct.by.trt(x=dat$proph,trt=dat$trt)\n)\n\n\nnoquote(table1)\n\n#############################################\n##Calculate the *first event* rates (per year)\n# use the dataset \"dat\", since it contains\n# the first record for each patient\n############################################\n\n\n#Numerator: total # of events\n# note that event is coded as status=2\nnum.FE &lt;- c(sum(dat$status[dat$trt==\"placebo\"]&gt;0), \n        sum(dat$status[dat$trt==\"rIFN-g\"]&gt;0), \n        sum(dat$status&gt;0))\n\n#Demoninator: total length of follow-up (year)\ndenom.FE &lt;- c(sum(dat$time[dat$trt==\"placebo\"]), \n        sum(dat$time[dat$trt==\"rIFN-g\"]), \n        sum(dat$time))/12\n\n#death rate\nround(num.FE/denom.FE,3)\n\n#############################\n#Recurrent event rate       #\n#############################\n\n# the numerator is easy: simply the numbers of records\n# with non-zero status\nnum.rec &lt;- c(sum(data$status[data$trt==\"placebo\"]&gt;0), \n         sum(data$status[data$trt==\"rIFN-g\"]&gt;0), \n         sum(data$status&gt;0))\n\n# Denominator should be the sum of the longest\n# follow-up for each patient\n\n#sort the data by descending order of time\no &lt;- order(data$id,data$time,decreasing = TRUE)\ndata &lt;- data[o,]\n# get the first record, which contains\n# the overall length of follow-up\n# for each patient\ndat.last &lt;- data[!duplicated(data$id),]\n\ndenom.rec &lt;- c(sum(dat.last$time[dat.last$trt==\"placebo\"]), \n            sum(dat.last$time[dat.last$trt==\"rIFN-g\"]), \n            sum(dat.last$time))/12\n\n#recurrent event rate\nround(num.rec/denom.rec,3)\n\n\nThe following uses gtsummary to summarize the CGD study data.\n\n\nUsing gtsummary\nlibrary(gtsummary)\nlibrary(tidyverse)\n\n\n## Read in the CGD  data\ndf &lt;- read.table(\"Data//Chronic Granulomatous Disease Study//cgd.txt\")\n# head(df)\n\n# Patient-level summary\ndf |&gt; \n  group_by(id) |&gt; \n  slice(1) |&gt; # Take the first record for each patient\n  tbl_summary(\n  by = trt, # by treatment\n  include = c(age, sex, hght, wght, inherit, stero, proph) # variables tabulated\n  ) |&gt; \n  add_overall(last = TRUE) # add overall column to the *right*\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nplacebo, N = 651\nrIFN-g, N = 631\nOverall, N = 1281\n\n\n\n\nage\n14 (7, 24)\n12 (7, 20)\n12 (7, 22)\n\n\nsex\n\n\n\n\n\n\n\n\n    female\n12 (18%)\n12 (19%)\n24 (19%)\n\n\n    male\n53 (82%)\n51 (81%)\n104 (81%)\n\n\nhght\n143 (115, 171)\n139 (119, 167)\n141 (117, 170)\n\n\nwght\n36 (22, 64)\n34 (21, 54)\n35 (21, 59)\n\n\ninherit\n\n\n\n\n\n\n\n\n    autosomal\n24 (37%)\n18 (29%)\n42 (33%)\n\n\n    X-linked\n41 (63%)\n45 (71%)\n86 (67%)\n\n\nstero\n2 (3.1%)\n1 (1.6%)\n3 (2.3%)\n\n\nproph\n55 (85%)\n56 (89%)\n111 (87%)\n\n\n\n1 Median (IQR); n (%)\n\n\n\n\n\n\n\n\nUsing gtsummary\n# Event rates\ndf |&gt; \n  group_by(id, trt) |&gt; # compute patient-level summary of events and follow-up times\n  summarize(\n    first_event = any(status == 1), # first event: 1 or 0\n    n_event = sum(status == 1), # number of events\n    first_event_fu = min(time) / 12, # follow-up time (yrs) for the first event\n    tot_event_fu = max(time) / 12 # total follow-up time (yrs)\n  ) |&gt; \n  group_by(trt) |&gt; # summarize by group\n  summarize(\n    first_event_rate = sum(first_event) / sum(first_event_fu), # first event rate\n    rec_event_rate = sum(n_event) / sum(tot_event_fu) # recurrent event rate\n  ) |&gt; \n  knitr::kable(caption = \"Event rates by treatment arm\")\n\n\n\nEvent rates by treatment arm\n\n\ntrt\nfirst_event_rate\nrec_event_rate\n\n\n\n\nplacebo\n0.8015769\n1.1064565\n\n\nrIFN-g\n0.2986362\n0.3862185"
  },
  {
    "objectID": "chapter9_tmp.html",
    "href": "chapter9_tmp.html",
    "title": "Chapter 9 - Recurrent Events",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)"
  },
  {
    "objectID": "chapter9_tmp.html#slides",
    "href": "chapter9_tmp.html#slides",
    "title": "Chapter 9 - Recurrent Events",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)"
  },
  {
    "objectID": "chapter9_tmp.html#base-r-code",
    "href": "chapter9_tmp.html#base-r-code",
    "title": "Chapter 9 - Recurrent Events",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nShow the code\n##################################################################\n# This code generates all numerical results in chapter 9.       ##\n##################################################################\n\n\n\nlibrary(survival)\n\n# read in the cgd dataset in counting process format\ncgd &lt;- read.table(\"Data\\\\Chronic Granulomatous Disease Study\\\\cgd_counting.txt\")\nhead(cgd)\n\n\n# Andersen-Gill model\nobj.AG &lt;- coxph(Surv(tstart, tstop, status) ~ treat + sex + age + inherit + steroids +\n                 propylac, data = cgd)\nsummary(obj.AG)\n\n# Frailty model\nobj.frail &lt;- coxph(Surv(tstart, tstop, status) ~ treat + sex + age + inherit + steroids +\n                    propylac + frailty(id, distribution = \"gamma\"), data = cgd)\n\nsummary(obj.frail)\n\n\n# proportional mean model (LWYY)\nobj.pm &lt;- coxph(Surv(tstart, tstop, status) ~ treat + sex + age + inherit + steroids +\n                 propylac + cluster(id), data = cgd)\n\nsummary(obj.pm)\n\n\n# extract the beta's from the three models\ncoeff.AG &lt;- summary(obj.AG)$coeff\ncoeff.frail &lt;- summary(obj.frail)$coeff\ncoeff.pm &lt;- summary(obj.pm)$coeff\n\n\n#########################################\n# Table 9.1. beta, se(beta), and p-vaues\n# from the three models\n#########################################\n\n## Andersen-Gill model\nc1 &lt;- coeff.AG[,1]\nc2 &lt;- coeff.AG[,3]\nc3 &lt;- coeff.AG[,5]\n\n# Frailty model\nc4 &lt;- coeff.frail[1:6,1]\nc5 &lt;- coeff.frail[1:6,2]\nc6 &lt;- coeff.frail[1:6,6]\n\n# Proportional means model\nc7 &lt;- coeff.pm[1:6,1]\nc8 &lt;- coeff.pm[1:6,4]\nc9 &lt;- coeff.pm[1:6,6]\n\n#print out Table 9.1\nnoquote(round(cbind(c1,c2,c3,c4,c5,c6,c7,c8,c9),3))\n\n\n### Figure 9.2 #############################################\n# predicted  mean functions by treatment\n# for a female/male patient of 12 years old with X-linked \n# inheritance pattern and use of both steroids and \n#  prophylactic antibiotics\n############################################################\n\n# get beta\nbeta &lt;- obj.pm$coeff\n\n# get baseline mean function mu_0(t)\n# and t\nLt &lt;- basehaz(obj.pm,centered = F)\nt &lt;- Lt$time\nmu0 &lt;- Lt$hazard\n\n# covariate vector (besides treatement) for female patient\nzf &lt;- c(0,12,1,1,1)\n# covariate vector (besides treatement) for male patient\nzm &lt;- c(1,12,1,1,1)\n\n# female in treatment and control\nmu.f.trt &lt;- exp(sum(c(1,zf)*beta))*mu0\nmu.f.contr &lt;- exp(sum(c(0,zf)*beta))*mu0\n\n# male in treatment and control\nmu.m.trt &lt;- exp(sum(c(1,zm)*beta))*mu0\nmu.m.contr &lt;- exp(sum(c(0,zm)*beta))*mu0\n\n# Plot the figure\npar(mfrow=c(1,2))\n\n# for female (left panel)\nplot(t/30.5, mu.f.trt, type=\"s\",xlim=c(0, 12), ylim=c(0,6),frame.plot =F,lty=1, main=\"Female\",\n     xlab=\"Time (months)\",ylab = \"Mean number of infections\", lwd=2)\nlines(t/30.5,mu.f.contr,lty=3,lwd=2)\n\n#for male (right panel)\nplot(t/30.5, mu.m.trt, type=\"s\", xlim=c(0, 12), ylim=c(0,6),frame.plot =F,lty=1,main=\"Male\",\n     xlab=\"Time (months)\",ylab = \"Mean number of infections\",lwd=2)\nlines(t/30.5,mu.m.contr,lty=3,lwd=2)"
  },
  {
    "objectID": "chapter9_tmp.html#graphics-for-cgd-study",
    "href": "chapter9_tmp.html#graphics-for-cgd-study",
    "title": "Chapter 9 - Recurrent Events",
    "section": "Graphics for CGD Study",
    "text": "Graphics for CGD Study\n\nlibrary(tidyverse)\n\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors\n\n# read in the cgd dataset in counting process format\ncgd &lt;- read.table(\"Data\\\\Chronic Granulomatous Disease Study\\\\cgd_counting.txt\")\nhead(cgd)\n\n  id tstart tstop status   treat    sex age height weight   inherit steroids\n1  1      0   219      1  rIFN-g female  12    147   62.0 autosomal        0\n2  1    219   373      1  rIFN-g female  12    147   62.0 autosomal        0\n3  1    373   414      0  rIFN-g female  12    147   62.0 autosomal        0\n4  2      0     8      1 placebo   male  15    159   47.5 autosomal        0\n5  2      8    26      1 placebo   male  15    159   47.5 autosomal        0\n6  2     26   152      1 placebo   male  15    159   47.5 autosomal        0\n  propylac\n1        0\n2        0\n3        0\n4        1\n5        1\n6        1\n\n# number of patients by sex\nsex_n &lt;- cgd |&gt; count(sex)\n\n# panel labeller by sex\nsex_labeller &lt;- str_c(c(\"Female\", \"Male\"),\n                      \" (N = \", sex_n$n, \")\"\n                      )\nnames(sex_labeller) &lt;- c(\"female\", \"male\")\n\n\nrec_cgd_hist &lt;- cgd |&gt; \n  group_by(treat, sex, id) |&gt; \n  summarize(\n    N = sum(status)\n  ) |&gt; \n  ggplot(aes(x = N)) +\n  geom_bar(aes(fill = treat), \n           position = position_dodge(0.8, preserve = \"single\"), \n           width = 0.8) +\n  facet_wrap( ~ sex, labeller = labeller(sex = sex_labeller)) +\n  scale_x_continuous(\"Infection count per patient\", \n                   breaks = 0:7, labels = 0:7) +\n  scale_y_continuous(\"Number of patients\", expand = c(0, 1)) + \n  scale_fill_manual(values = c(\"gray80\", \"gray20\"), labels = c(\"Placebo\", \"rIFN-g\")) +\n  theme_bw() +\n  theme(\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor.x = element_blank(),\n    legend.position = \"top\",\n    legend.title = element_blank()\n  )\n\n`summarise()` has grouped output by 'treat', 'sex'. You can override using the\n`.groups` argument.\n\nggsave(\"rec_cgd_hist.pdf\", rec_cgd_hist, width = 8, height = 4.5)\nggsave(\"rec_cgd_hist.eps\", rec_cgd_hist, width = 8, height = 4.5)\n\n\nrec_cgd_fu &lt;- cgd |&gt; \n  left_join(\n    cgd |&gt; group_by(id) |&gt; summarize(max_fu = max(tstop)),\n    join_by(id)\n  ) |&gt; \n    mutate(\n    id = factor(id),\n    status = factor(status),\n    tstart = tstart / 30.5,\n    tstop = tstop / 30.5,\n    max_fu = max_fu / 30.5,\n    treat = if_else(treat == \"placebo\", \"Placebo\", treat)\n  ) |&gt; \n  ggplot(aes(y = reorder(id, max_fu))) +\n  geom_linerange(aes(xmin = tstart, xmax = tstop)) +\n  geom_point(aes(x = tstop, shape = status), size = 2, fill = \"white\") +\n  geom_vline(xintercept = 0, linewidth = 1) +\n  scale_shape_manual(values = c(23, 15), labels = c(\"Censoring\", \"Infection\")) + \n  scale_x_continuous(\"Time (months)\", limits = c(0, 15), breaks = seq(0, 15, by = 3),\n                     expand= c(0, 0.5)) +\n  scale_y_discrete(\"Patients\") +\n  facet_wrap( ~ treat, scales = \"free\") +\n  theme_minimal() +\n  theme(\n    legend.position = \"top\",\n    legend.title = element_blank(),\n    panel.grid.minor.x = element_blank(),\n    axis.text.y = element_blank(),\n    axis.ticks.y = element_blank(),\n    panel.grid.major.y = element_blank()\n  )\n  \nggsave(\"rec_cgd_fu.pdf\", rec_cgd_fu, width = 8, height = 8.5)\nggsave(\"rec_cgd_fu.eps\", rec_cgd_fu, width = 8, height = 8.5)"
  },
  {
    "objectID": "chapter8_tmp.html",
    "href": "chapter8_tmp.html",
    "title": "Chapter 8 - Multivariate Failure Times",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)"
  },
  {
    "objectID": "chapter8_tmp.html#slides",
    "href": "chapter8_tmp.html#slides",
    "title": "Chapter 8 - Multivariate Failure Times",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)"
  },
  {
    "objectID": "chapter8_tmp.html#base-r-code",
    "href": "chapter8_tmp.html#base-r-code",
    "title": "Chapter 8 - Multivariate Failure Times",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nShow the code\n##################################################################\n# This code generates all numerical results in chapter 8.      ##\n##################################################################\n\nlibrary(\"survival\")\n\n################################\n# NCCTG lung cancer study      #\n################################\n\n## read in the NCCTG lung cancer study\n## (clustered data by institution)\ndata &lt;- read.table(\"Data//NCCTG//lung.txt\")\nhead(data)\n\n\n\n\n## Follow up plot\nlibrary(tidyverse)\nlibrary(patchwork)\n\n# function to plot follow-up by\n# institution and sex\ninst_by_sex_fu_plot &lt;- function(df){\n  \n  df |&gt; \n  ggplot(aes(y = reorder(id, time), x = time, color = factor(2 - sex))) +\n  geom_linerange(aes(xmin = 0, xmax = time)) +\n  geom_point(aes(shape = factor(status)), size = 2, fill = \"white\") +\n  geom_vline(xintercept = 0, linewidth = 1) +\n  facet_grid(inst ~ ., scales = \"free\", space = \"free\", switch = \"y\")   +\n  theme_minimal() +\n  scale_x_continuous(\"Time (months)\", limits = c(0, 36), breaks = seq(0, 36, by = 12),\n                     expand = c(0, 0.25)) +\n  scale_y_discrete(\"Patients (by institution)\") +\n  scale_shape_manual(values = c(23, 19), labels = c(\"Censoring\", \"Death\")) +\n  scale_color_brewer(palette = \"Set1\", labels = c(\"Female\", \"Male\"))+\n  theme(\n    strip.background =  element_rect(fill = \"gray90\", color = \"gray90\"),\n    axis.text.y = element_blank(),\n    axis.ticks.y = element_blank(),\n    axis.line.y = element_blank(),\n    panel.grid.major.y = element_blank(),\n    legend.title = element_blank()\n  )\n  \n}\n\np1 &lt;- inst_by_sex_fu_plot(data |&gt; filter(inst &lt;= 11))\n\np2 &lt;- inst_by_sex_fu_plot(data |&gt; filter(inst &gt; 11))\n\nmul_lung_fu &lt;- p1 + p2 + plot_layout(ncol = 2, guides = \"collect\") & theme(legend.position = \"top\")\n\n# ggsave(\"mul_lung_fu.pdf\", mul_lung_fu, width = 8, height = 10)\n# ggsave(\"mul_lung_fu.eps\", mul_lung_fu, width = 8, height = 10)\n\n\n# Fit a Cox model with institution-specific frailty\n# to account for correlation within institution\nobj &lt;- coxph(Surv(time, status) ~ age+ factor(sex) + phec + phkn + ptkn +\n        wl + frailty(inst, distribution=\"gamma\"), data = data)\n\nsummary(obj)\n\n# fit a naive Cox model without institution-specific frailty\nobj.naive &lt;- coxph(Surv(time,status)~age+factor(sex)+phec+phkn+ptkn +\n                           wl,data=data)\n\nsummary(obj.naive)\n\n\n####################################################\n#  Prediction of subject-specific survival curves\n#  \n################################################\n\n# Median age\nmed_age &lt;- median(data$age)\n# Median ph.karno\nmed_phkn &lt;- median(data$phkn,na.rm=T)\n# Median pat.karno\nmed_ptkn &lt;- median(data$ptkn,na.rm=T)\n# Median wt.loss\nmed_wl &lt;- median(data$wl,na.rm=T)\n\n# Extract the regression coefficients\nbeta &lt;- obj$coefficients\n# Extract the (only) baseline function\nbase_obj &lt;- basehaz(obj,centered=F)\neta &lt;- base_obj$hazard\nt &lt;- base_obj$time\n\n\n# Figure 8.2 Prediction of survival probabilities for a typical patient \n# of median age (63 years), with median physician-\n#         and patient-rated Karnofsky scores (each 80), and with median\n# weighted loss (7 pounds) by sex and ECOG score.\n\n# Obtain the covariate profiles.\n## Female\nzf0 &lt;- c(med_age,1,0,med_phkn,med_ptkn,med_wl)\nzf1 &lt;- c(med_age,1,1,med_phkn,med_ptkn,med_wl)                              \nzf2 &lt;- c(med_age,1,2,med_phkn,med_ptkn,med_wl) \nzf3 &lt;- c(med_age,1,3,med_phkn,med_ptkn,med_wl) \n\n## Male\nzm0 &lt;- c(med_age,0,0,med_phkn,med_ptkn,med_wl)\nzm1 &lt;- c(med_age,0,1,med_phkn,med_ptkn,med_wl)                              \nzm2 &lt;- c(med_age,0,2,med_phkn,med_ptkn,med_wl) \nzm3 &lt;- c(med_age,0,3,med_phkn,med_ptkn,med_wl) \n\n# Plot the preducted survival curves\npar(mfrow=c(1,2))\nplot(t,exp(-exp(sum(beta*zf0))*eta),type=\"s\",xlim=c(0,35),\n     ylim=c(0,1),frame=F,lty=1,main=\"Female\",\n     xlab=\"Time (months)\",ylab=\"Survival probabilities\",lwd=2,cex.lab=1.3,\n     cex.axis=1.3,cex.main=1.3)\nlines(t,exp(-exp(sum(beta*zf1))*eta),lty=2,lwd=2)\nlines(t,exp(-exp(sum(beta*zf2))*eta),lty=3,lwd=2)\nlines(t,exp(-exp(sum(beta*zf3))*eta),lty=4,lwd=2)\nlegend(\"topright\",lty=1:4,lwd=2,cex=1.2,paste(\"ECOG\",0:3))\n\nplot(t,exp(-exp(sum(beta*zm0))*eta),type=\"s\",xlim=c(0,35),\n     ylim=c(0,1),frame=F,lty=1,main=\"Male\",\n     xlab=\"Time (months)\",ylab=\"Survival probabilities\",lwd=2,cex.lab=1.3,\n     cex.axis=1.3,cex.main=1.3)\nlines(t,exp(-exp(sum(beta*zm1))*eta),lty=2,lwd=2)\nlines(t,exp(-exp(sum(beta*zm2))*eta),lty=3,lwd=2)\nlines(t,exp(-exp(sum(beta*zm3))*eta),lty=4,lwd=2)\nlegend(\"topright\",lty=1:4,lwd=2,cex=1.2,paste(\"ECOG\",0:3))\n\n\n\n################################\n# Diabetic retinopathy study   #\n################################\n\n# read in the data\ndata &lt;- read.table(\"Data//Diabetic Retinopathy Study//drs.txt\")\nhead(data)\n\n# fit a bivariate marginal Cox model\n# with treatment, diabetic type\n# risk score, and treatment*type interaction\n# as covariates\nobj &lt;- coxph(Surv(time, status) ~ trt + type + trt * type + risk\n             + cluster(id), data = data)\n\nsummary(obj)\n\n# Table 8.1 Marginal Cox model analysis of the Diabetic Retinopathy Study\n# output table\ncoeff &lt;- summary(obj)$coeff\n# beta estimate\nc1 &lt;- coeff[,1]\n# robust se and p-value\nc2 &lt;- coeff[,4]\nc3 &lt;- coeff[,6]\n# naive se and p-value\nc4 &lt;- coeff[,3]\nc5 &lt;- 1-pchisq((c1/c4)^2,1)\n\n#output the table\nnoquote(round(cbind(c1,c2,c3,c4,c5),3))\n\n\n\n# Fig. 8.4 Prediction of vision-retention probabilities \n# for patients with a median risk\n# score (10) by treatment for each diabetic type.\n\n# Lambda_0(t) and t\nLt &lt;- basehaz(obj,centered = F)\nt &lt;- Lt$time\nL &lt;- Lt$hazard\n\n# beta\nbeta &lt;- coeff[,1]\n\n# plot the predicted survival functions\n\npar(mfrow=c(1,2))\n# Compute the survival function for \n# adult and juvenile patients in control and treatment\nadult.contr &lt;- exp(-exp(sum(beta*c(0,0,10,0)))*L)\nadult.trt &lt;- exp(-exp(sum(beta*c(1,0,10,0)))*L)\njuv.contr &lt;- exp(-exp(sum(beta*c(0,1,10,0)))*L)\njuv.trt &lt;- exp(-exp(sum(beta*c(1,1,10,1)))*L)\n\n# Plot the predicted survival curves\nplot(t,adult.contr,type=\"s\",xlim=c(0,80),ylim=c(0,1),frame.plot=F,lty=3,main=\"Adult\",\n     xlab=\"Time (months)\",ylab=\"Vision-retention probabilities\",lwd=2, cex.lab=1.2,\n     cex.axis=1.2,cex.main=1.2)\nlines(t,adult.trt,lty=1,lwd=2)\n\nplot(t,juv.contr,type=\"s\",xlim=c(0,80),ylim=c(0,1),frame.plot=F,lty=3,main=\"Juvenile\",\n     xlab=\"Time (months)\",ylab=\"Vision-retention probabilities\",lwd=2,cex.lab=1.2,\n     cex.axis=1.2,cex.main=1.2)\nlines(t,juv.trt,lty=1,lwd=2)\n\n\n\n################################\n# NCCTG lung cancer study      #\n################################\n\n## read in the NCCTG lung cancer study\n## (clustered data by institution)\ndata &lt;- read.table(\"Data//NCCTG//lung.txt\")\n# head(data)\n\n\n\n\n## Follow up plot\nlibrary(tidyverse)\nlibrary(patchwork)\n\n# function to plot follow-up by\n# institution and sex\ninst_by_sex_fu_plot &lt;- function(df){\n  \n  df |&gt; \n  ggplot(aes(y = reorder(id, time), x = time, color = factor(2 - sex))) +\n  geom_linerange(aes(xmin = 0, xmax = time)) +\n  geom_point(aes(shape = factor(status)), size = 2, fill = \"white\") +\n  geom_vline(xintercept = 0, linewidth = 1) +\n  facet_grid(inst ~ ., scales = \"free\", space = \"free\", switch = \"y\")   +\n  theme_minimal() +\n  scale_x_continuous(\"Time (months)\", limits = c(0, 36), breaks = seq(0, 36, by = 12),\n                     expand = c(0, 0.25)) +\n  scale_y_discrete(\"Patients (by institution)\") +\n  scale_shape_manual(values = c(23, 19), labels = c(\"Censoring\", \"Death\")) +\n  scale_color_brewer(palette = \"Set1\", labels = c(\"Female\", \"Male\"))+\n  theme(\n    strip.background =  element_rect(fill = \"gray90\", color = \"gray90\"),\n    axis.text.y = element_blank(),\n    axis.ticks.y = element_blank(),\n    axis.line.y = element_blank(),\n    panel.grid.major.y = element_blank(),\n    legend.title = element_blank()\n  )\n  \n}\n\np1 &lt;- inst_by_sex_fu_plot(data |&gt; filter(inst &lt;= 11))\n\np2 &lt;- inst_by_sex_fu_plot(data |&gt; filter(inst &gt; 11))\n\nmul_lung_fu &lt;- p1 + p2 + plot_layout(ncol = 2, guides = \"collect\") & theme(legend.position = \"top\")\n\n\nmul_lung_fu\n\n\n\n\n\n\n\nFigure 1: Follow-up of lung cancer patients by institution and by patient sex. Death rate appears to be higher in males than in females. Clustering of outcomes within institutions is not obvious.\n\n\n\n\n\n\n################################\n# Diabetic retinopathy study   #\n################################\n\n# read in the data\ndata &lt;- read.table(\"Data//Diabetic Retinopathy Study//drs.txt\")\n\n\n# widen the data\ndrs_wide &lt;- data |&gt; \n  pivot_wider(\n    id_cols = c(id, type),\n    values_from = c(time, status),\n    names_from = trt\n  ) |&gt; \n  mutate(\n    xmin = pmin(time_0, time_1),\n    xmax = pmax(time_0, time_1),\n    fav = time_1 &gt;= time_0\n  )\n\nmul_drs_fu &lt;- drs_wide |&gt; \n  ggplot(aes(y = reorder(factor(id), xmax))) +\n  geom_linerange(aes(xmin = 0, xmax = xmin), color = \"gray50\", linewidth = 1) +\n  geom_linerange(aes(xmin = xmin, xmax = xmax, color = fav), linewidth = 1.2, show.legend = FALSE) +\n  geom_point(aes(x = time_1, shape = factor(status_1), color =  FALSE), fill = \"white\", size = 2) +\n  geom_point(aes(x = time_0, shape = factor(status_0), color =  TRUE), fill = \"white\", size = 2) +\n  geom_vline(xintercept = 0, linewidth = 1) +\n  scale_x_continuous(\"Time (months)\", limits = c(0, 76), breaks = seq(0, 72, by = 12), expand = c(0, 0.05)) +\n  scale_y_discrete(\"Patients\") +\n  scale_color_manual(values = c(\"#F8766D\", \"#00BFC4\"), labels = c(\"Treated eye\", \"Control eye\")) + \n  scale_shape_manual(values = c(23, 19, 19), labels = c(\"Censoring\", \"Vision loss\")) + \n  facet_wrap( . ~ str_to_title(type), scales = \"free\") +\n  theme_minimal() +\n  theme(\n    legend.position = \"top\",\n    legend.title = element_blank(),\n    axis.text.y = element_blank(),\n    panel.grid.major.y = element_blank(),\n    strip.text = element_text(size = 11)\n  )\n\nmul_drs_fu\n\n\n\n\n\n\n\nFigure 2: Follow-up of diabetic retinopathy study patients by disease type. Photocoagulation treatment appears to delay onset of blindness in both types, but to a greater degree in adult diabetes."
  },
  {
    "objectID": "chapter7.html",
    "href": "chapter7.html",
    "title": "Chapter 7 - Left Truncation and Interval Censoring",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 7 - Left Truncation and Interval Censoring"
    ]
  },
  {
    "objectID": "chapter7.html#slides",
    "href": "chapter7.html#slides",
    "title": "Chapter 7 - Left Truncation and Interval Censoring",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 7 - Left Truncation and Interval Censoring"
    ]
  },
  {
    "objectID": "chapter7.html#base-r-code",
    "href": "chapter7.html#base-r-code",
    "title": "Chapter 7 - Left Truncation and Interval Censoring",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nShow the code\n##################################################################\n# This code generates all numerical results in chapter 7.      ##\n##################################################################\n\nlibrary(survival)\n\n# read in the Channing study data\nchanning &lt;- read.table(\"Data\\\\Channing House Study\\\\channing.txt\")\n\nhead(channing)\n\nchanning$gender &lt;- factor(channing$gender)\n\n# Fit a Cox model to the Channing study data\n# with entry age as left-truncation time\nobj &lt;- coxph(Surv(Entry.Age, End.Age, status) ~ gender, data = channing)\n# Summarize model\nsummary(obj)\n#&gt; Call:\n#&gt; coxph(formula = Surv(Entry.Age, End.Age, status) ~ gender, data = channing)\n#&gt; \n#&gt;   n= 458, number of events= 176 \n#&gt; \n#&gt;            coef exp(coef) se(coef)      z Pr(&gt;|z|)  \n#&gt; gender2 -0.3163    0.7289   0.1731 -1.827   0.0677 .\n#&gt; ---\n#&gt; Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1\n#&gt; \n#&gt;         exp(coef) exp(-coef) lower .95 upper .95\n#&gt; gender2    0.7289      1.372    0.5191     1.023\n#&gt; \n#&gt; Concordance= 0.528  (se = 0.018 )\n#&gt; Likelihood ratio test= 3.17  on 1 df,   p=0.07\n#&gt; Wald test            = 3.34  on 1 df,   p=0.07\n#&gt; Score (logrank) test = 3.36  on 1 df,   p=0.07\n\n\n### proportionality of gender ####\n# Schoenfeld residuals\nobj_zph &lt;- cox.zph(obj)\n# test result\nobj_zph\n# Plot the rescaled residuals\nplot(obj_zph, ylab = \"Gender\", xlab = \"Age (years)\", lwd = 2)\n\n### prediction of (conditional survival) ##\n\nlibrary(tidyverse)\n## numbers at risk\nt &lt;- seq(60, 100, by = 1)\n\n## function to compute number at risk\n## at each t based on entry (T_L) and end (X)\nn_risk_t &lt;- function(entry, end){\n  m &lt;- length(t)\n  n_j &lt;- rep(NA, m)\n  for (j in 1:m){\n    n_j[j] &lt;- sum(entry &lt;= t[j] & t[j] &lt;= end)\n  }\n  return(n_j)\n}\n\n## compute n at risk by gender\nnrisk&lt;- channing |&gt; \n  group_by(gender) |&gt; \n  reframe(\n    n_j = n_risk_t(Entry.Age, End.Age)\n  ) |&gt; \n  add_column(\n    t = rep(t, 2),\n    .before = 1\n  ) |&gt; \n  mutate(\n    gender = if_else(gender == 1, \"Male\", \"Female\")\n  )\n\n# plot n at risk by gender\nnrisk_fig &lt;- nrisk |&gt; \n  ggplot(aes(x = t, y = n_j)) +\n  geom_step(aes(linetype = gender)) +\n  theme_bw() +\n labs(\n   x = \"Age (years)\",\n   y = \"Number at risk\"\n ) +\n theme(\n    legend.title = element_blank(),\n    legend.position = \"top\"\n  )\n\n# set cut-off 70 yo\nt0 &lt;- 70\n# Get model-based parameter estimates\nbeta &lt;- obj$coefficients\nLambda0 &lt;- basehaz(obj, centered = FALSE)\nLambda0t0 &lt;- Lambda0[Lambda0$time &gt;= t0,]\nLambda0t0$hazard &lt;- Lambda0t0$hazard - Lambda0t0$hazard[1] ## conditional cum hazard after t0\n\n\n# predicted gender-specific conditional \n# survival functions given 70 yo\nsurv_t0 &lt;- Lambda0t0 |&gt; \n  mutate(\n    St = exp(- hazard),\n    gender = \"Male\"\n  ) |&gt; \n  add_row(\n    Lambda0t0 |&gt; \n      mutate(\n        St = exp(- hazard * exp(beta)),\n        gender = \"Female\"\n      )\n  )\n\n# plot conditional survival functions\nsurv_fig &lt;- surv_t0 |&gt; \n  ggplot(aes(x = time, y = St)) +\n  geom_step(aes(linetype = gender)) +\n  theme_bw() +\n  labs(\n    x = \"Age (years)\",\n    y = \"Conditional survival probabilities\"\n  ) +\n  theme(\n    legend.title = element_blank(),\n    legend.position = \"top\"\n  ) +\n  scale_x_continuous(expand = expansion(c(0, 0.05)))\n\n## package to combine plots\nlibrary(patchwork)\n# combine n-at-risk and conditional-survival plots\nchan_model &lt;- nrisk_fig + surv_fig + plot_layout(ncol = 2, guides = \"collect\") & \n  theme(legend.position = 'top')\n\n# ggsave(\"trunc_chan_model.pdf\", chan_model, width = 8, height = 4)\n# ggsave(\"trunc_chan_model.eps\", chan_model, width = 8, height = 4)\n\n\n\n## BMA HIV study\n\nlibrary(IntCens)\n## Bangkok Metropolitan Administration HIV Study\ndf &lt;- read.table(\"Data//Bangkok Metropolitan Administration HIV_AIDS Study//bam.txt\")\ndf\n\n\n# Fit a proportional hazards model\nPH_fit &lt;- icsurvfit(L = df$L, R = df$R, Z = df[, 3:7], model = \"PH\")\n# Print results  \nPH_fit\n#&gt; Call:\n#&gt; icsurvfit(L = df$L, R = df$R, Z = df[, 3:7], model = \"PH\")\n#&gt; \n#&gt; NPMLE of proportional hazards for interval-censored data:\n#&gt; \n#&gt; ICM algorithm converges in 102 iterations.\n#&gt; \n#&gt; Maximum Likelihood Estimates for Regression parameters:\n#&gt; \n#&gt;         Estimate    StdErr z.value  p.value   \n#&gt; age    -0.029914  0.011051 -2.7068 0.006793 **\n#&gt; sex     0.387923  0.268032  1.4473 0.147814   \n#&gt; needle  0.249568  0.144987  1.7213 0.085195 . \n#&gt; jail    0.456849  0.143961  3.1734 0.001506 **\n#&gt; inject  0.221270  0.146767  1.5076 0.131652   \n#&gt; ---\n#&gt; Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1\n\n# Alternative PO model\n# obj.PO &lt;- ICSurvICM(delta,gamma,U,V,Z=data[,5:9],model=\"PO\")\n\n\n# Table 7.3\n# construct a table for hazard ratio and\n# 95% confidence intervals\n\n#regression parameter\nbeta &lt;- PH_fit$beta\nse &lt;- sqrt(diag(PH_fit$var))\nc1 &lt;- round(exp(beta),2)\nc2 &lt;- paste0(\"(\",round(exp(beta - 1.96*se),2),\", \",\n   round(exp(beta + 1.96*se),2),\")\")\nnoquote(cbind(c1, c2))\n\n\n\n# Prediction of HIV sero-negative probabilities for a median-aged male IDU\n# without histories of needle sharing or drug injection in jail by prior imprisonment\n# status.\npar(mfrow=c(1, 1))\nage.med &lt;- median(df[,\"age\"])\nplot(PH_fit, z=c(age.med,1,0,0,0),xlim=c(0,50), lty = 2,\n     xlab=\"Time (months)\", ylab=\"HIV sero-negative probabilities\",\n     lwd=2, main = \"\")\nplot(PH_fit, z=c(age.med, 1, 0, 1, 0), xlim=c(0, 50), add = TRUE,\n     lwd=2)\nlegend(0, 0.3, lty=c(2, 1), c(\"No history of imprisonment\", \"History of imprisonment\"), \n       lwd = 2)"
  },
  {
    "objectID": "chapter7.html#follow-up-plots",
    "href": "chapter7.html#follow-up-plots",
    "title": "Chapter 7 - Left Truncation and Interval Censoring",
    "section": "Follow-up Plots",
    "text": "Follow-up Plots\nVisualization of subject-level follow-up under left truncation or interval censoring must account for the nonzero entry time or the imprecise location of the endpoint. This makes it different from right-censored data. To show the additional information, we need additional features on the plot.\n\nUnder left truncation\nFor each subject, we use a line segment to represent the period \\([T_{Li}, X_i]\\) on study, at the end of which the outcome event is distinguished from censoring by point shape.\nThe following is an example using the Channing House study.\n\nlibrary(tidyverse)\n# read in the Channing study data\nchanning &lt;- read.table(\"Data\\\\Channing House Study\\\\channing.txt\")\n\n# head(channing)\n# take a random sample of 100 females\nset.seed(2024)\nchanning_f_sub &lt;- channing |&gt; \n  filter(gender == 2) |&gt; \n  sample_n(100)\n# take all males\nchanning_m_sub &lt;- channing |&gt; \n  filter(gender == 1) \n\n# combine the sub-samples\nchanning_sub &lt;- channing_f_sub |&gt; add_row(channing_m_sub)\nn &lt;- nrow(channing_sub) # number of subjects in the sub-sample\n\n# panel labeller\ngender_labeller &lt;- c(\"1\" = \"Males\", \"2\" = \"Females\")\n\n# follow -up plot\nchan_fig &lt;- channing_sub |&gt; \n  add_column(ID = 1 : n) |&gt; # add an ID column as y-axis\n  ggplot(aes(y = reorder(ID, End.Age))) + # order subject ID shown on y-axis by end time\n  geom_linerange(aes(xmin = Entry.Age, xmax = End.Age)) + # line range (T_L, X)\n  geom_point(aes(x = Entry.Age, shape = \"2\"), fill = \"white\", size = 2) + # entry point (2)\n  geom_point(aes(x = End.Age, shape = factor(status)), fill = \"white\", size = 2)  + \n  # endpoint (1: event; 0: censoring)\n  geom_vline(xintercept = 60, linewidth = 1) + # start line at age 60\n  facet_wrap(~ gender, ncol = 2, scales = \"free\", # by gender\n             labeller = labeller(gender = gender_labeller)) +\n  theme_minimal() +\n  scale_y_discrete(name = \"Subjects\") +\n  scale_x_continuous(name = \"Age (years)\", limits = c(60, 100), \n                     breaks = seq(60, 100, by = 10), \n                     expand = expansion(c(0, 0.05)))  +\n  scale_shape_manual(limits = c(\"2\", \"0\", \"1\"),  values = c(22, 23, 19), \n                      labels = c(\"Admission\", \"Censoring\", \"Death\")) + # set the point shapes\n  theme( # theme formatting\n    legend.position = \"top\",\n    legend.title = element_blank(),\n    axis.text.y = element_blank(),\n    axis.ticks.y = element_blank(),\n    panel.grid.major.y = element_blank(),\n    legend.text = element_text(size = 11),\n    axis.title = element_text(size = 11),\n    axis.text = element_text(size = 10),\n    strip.text = element_text(size = 10)\n  )\n\nchan_fig\n# ggsave(\"trunc_chan_fig.pdf\", chan_fig, width = 8, height = 9)\n# ggsave(\"trunc_chan_fig.eps\", chan_fig, width = 8, height = 9)\n\n\n\n\n\n\n\nFigure 1: Follow-up plots for a random sample of 100 residents for each gender in the Channing House study. Males appear to suffer more deaths than females.\n\n\n\n\n\n\n\nUnder interval censoring\nFor each subject, we use a gray line to represent the follow-up period. The check-up times can be marked on it by dots if such data are available. The event-containing interval \\([L_i, R_i]\\) (\\(R_i&lt;\\infty\\)) is highlighted from the rest of the follow-up period using a black line segment.\nThe following is an example using the Bangkok Metropolitan Administration HIV study.\n\nlibrary(IntCens)\n## BMA HIV study\n## Bangkok Metropolitan Administration HIV Study\nbma &lt;- read.table(\"Data//Bangkok Metropolitan Administration HIV_AIDS Study//bam.txt\")\n\n# sample size\nn &lt;- nrow(bma)\n\n# create L and R\nbma_lr &lt;- bma |&gt; \n  mutate(\n    ID = 1 : n, \n    .before = 1\n  )\n\n# take a random sample of 150 subjects per imprisonment status\nset.seed(2024229)\nbma_lr_jail_sub &lt;- bma_lr |&gt; \n  filter(jail == 1) |&gt; \n  sample_n(150) \n  \nbma_lr_nojail_sub &lt;- bma_lr |&gt; \n  filter(jail == 0) |&gt; \n  sample_n(150) \n\n## combine the sub-samples\nbma_lr_sub &lt;- bma_lr_jail_sub |&gt; \n  add_row(bma_lr_nojail_sub) |&gt; \n  mutate(\n    end = ifelse(R == Inf, L, R),\n    status = (R &lt; Inf) + 0 # an indicator of event occurence vs right censoring\n  )\n\n\n# panel labeller\njail_labeller &lt;- c(\"0\" = \"No imprisonment\", \"1\" = \"Imprisonment\")\n\n# follow -up plot\nbma_fig &lt;- bma_lr_sub |&gt; \n  ggplot(aes(y = reorder(factor(ID), end))) + # order subjects by R or last check-up\n  geom_linerange(aes(xmin = 0, xmax = L), alpha = 0.3) + # gray line for non-event-containing period\n  geom_linerange(data = bma_lr_sub |&gt; filter(status == 1), \n    aes(xmin = L, xmax = R), linetype = 1) + # black line for event-containing interval\n  geom_point(data = bma_lr_sub |&gt; filter(status == 1), aes(x = L, shape = \"1\"), size = 2) +\n  geom_point(data = bma_lr_sub |&gt; filter(status == 1), aes(x = R, shape = \"1\"), size = 2) +\n  geom_point(data = bma_lr_sub |&gt; filter(status == 0), aes(x = L, shape = \"0\"), \n             fill = \"white\", size = 2) + # different point shapes\n  geom_vline(xintercept = 0) +\n  facet_wrap(~ jail, scales = \"free\", labeller = labeller(jail = jail_labeller)) + \n  # by imprisonment status\n  theme_minimal() +\n  scale_y_discrete(name = \"Subjects\") +\n  scale_x_continuous(name = \"Time (months)\", \n                     breaks = seq(0, 48, by = 6), \n                     expand = expansion(c(0, 0.05))) +\n  scale_shape_manual(limits = c(\"0\", \"1\"),  values = c(23, 19), \n                      labels = c(\"Right censoring\", \"L-R containing seroconversion\")) +\n  # set point shapes\n theme( # theme formatting\n    legend.position = \"top\",\n    legend.title = element_blank(),\n    axis.text.y = element_blank(),\n    axis.ticks.y = element_blank(),\n    panel.grid.major.y = element_blank(),\n    legend.text = element_text(size = 11),\n    axis.title = element_text(size = 11),\n    axis.text = element_text(size = 10),\n    strip.text = element_text(size = 10)\n  )\n\nbma_fig\n# ggsave(\"trunc_bma_fig.pdf\", bma_fig, width = 8, height = 12)\n# ggsave(\"trunc_bma_fig.eps\", bma_fig, width = 8, height = 12, device = cairo_pdf)\n\n\n\n\n\n\n\nFigure 2: Follow-up plots for a random sample of 150 intravenous drug users by imprisonment history in the Bangkok Metropolitan Administration study. Those who have been imprisoned before appear more likely to experience sero-conversion.",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 7 - Left Truncation and Interval Censoring"
    ]
  },
  {
    "objectID": "chapter5.html",
    "href": "chapter5.html",
    "title": "Chapter 5 - Other Non- and Semi-parametric Methods",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 5 - Other Non- and Semi-parametric Methods"
    ]
  },
  {
    "objectID": "chapter5.html#slides",
    "href": "chapter5.html#slides",
    "title": "Chapter 5 - Other Non- and Semi-parametric Methods",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 5 - Other Non- and Semi-parametric Methods"
    ]
  },
  {
    "objectID": "chapter5.html#base-r-code",
    "href": "chapter5.html#base-r-code",
    "title": "Chapter 5 - Other Non- and Semi-parametric Methods",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nShow the code\n##################################################################\n# This code generates all numerical results in chapter 5.      ##\n##################################################################\n\n\nlibrary(survival)\nlibrary(tidyverse)\n##############################################\n# GBC study\n#############################################\n#read in the complete data\ngbc &lt;- read.table(\"Data//German Breast Cancer Study//gbc.txt\")\n\n#subset to first event data\n#Sort the data by time within each id\no &lt;- order(gbc$id,gbc$time)\ngbc &lt;- gbc[o,]\n#get the first row for each id\ndf &lt;- gbc[!duplicated(gbc$id),]\n\n#set status=1 if status==2 or 1\ndf$status &lt;- (df$status &gt; 0) + 0\n\n# Reduce the scales of prog and estrg by 100\ndf$prog  &lt;- df$prog / 100\ndf$estrg &lt;- df$estrg / 100\n\n############################################\n# Restricted mean surval time (RMST) analysis\n# with the \"survRM2\" package\n##########################################\n\n# install.packages(\"survRM2\")\nlibrary(survRM2)\n\n\n# Two-sample comparison between hormonal and non-hormonal\n# groups on 5-year RMST\nobj &lt;- rmst2(time = df$time / 12, status = df$status, \n            arm = df$hormone - 1, tau = 5)\n\n# print out results\nobj\n#&gt; The truncation time: tau = 5  was specified. \n#&gt; \n#&gt; Restricted Mean Survival Time (RMST) by arm \n#&gt;              Est.    se lower .95 upper .95\n#&gt; RMST (arm=1) 3.87 0.104     3.666     4.074\n#&gt; RMST (arm=0) 3.46 0.084     3.295     3.625\n#&gt; \n#&gt; \n#&gt; Restricted Mean Time Lost (RMTL) by arm \n#&gt;              Est.    se lower .95 upper .95\n#&gt; RMTL (arm=1) 1.13 0.104     0.926     1.334\n#&gt; RMTL (arm=0) 1.54 0.084     1.375     1.705\n#&gt; \n#&gt; \n#&gt; Between-group contrast \n#&gt;                       Est. lower .95 upper .95     p\n#&gt; RMST (arm=1)-(arm=0) 0.410     0.148     0.672 0.002\n#&gt; RMST (arm=1)/(arm=0) 1.118     1.042     1.201 0.002\n#&gt; RMTL (arm=1)/(arm=0) 0.734     0.595     0.905 0.004\n\n\n\n# more compact results\nobj$unadjusted.result\n\n# obj$RMST.arm0\n# obj$RMST.arm1\n\n# Graphical display of the group-specific RMST \n# as area under the KM curves\nplot(obj, xlab=\"Time (years)\", ylab = \"Relapse-free survival\",\n     col.RMST = \"gray\", col.RMTL = \"white\", cex.lab=1.2,\n     cex.axis=1.2, col=\"black\", xlim=c(0,5))\n\n\n# Regression with all the other covariate\nobj_reg &lt;- rmst2(time = df$time / 12, status = df$status, \n            arm = df$hormone-1, covariates = df[, 5:11], tau = 5)\n\n#overall results\nobj_reg\n\n# additive model on RMST\nround(obj_reg$RMST.difference.adjusted, 3)\n\n# multiplicative model on RMST\nround(obj_reg$RMST.ratio.adjusted, 3)\n\n# multiplicative model on RMTL\nround(obj_reg$RMTL.ratio.adjusted, 3)\n\n# for hormone treatment only \nobj.reg$adjusted.result\n\n\n####################################\n### Additive hazards analysis\n## using the \"addhazard\" package\n####################################\n\n\n# install.packages(\"addhazard\")\nlibrary(addhazard)\n \n\n\n# Fit the additive hazards model to the data\nfit &lt;- ah(Surv(time, status) ~ age + hormone, data = df, ties = FALSE)\n\n# Display the summary of the fitted model\nsummary(fit)\n\n\n\n # Fit additive hazards model\n \n## preparation\ndf$hormone &lt;- factor(df$hormone)\ndf$meno &lt;- factor(df$meno) \n\n# Add an infinitesimal random number to time\n # to get rid of ties\nset.seed(123)\ndf$time.dties &lt;- df$time / 12 + runif(nrow(df),0, 1e-12) \n\n\n# fit an additive hazard model\nobj &lt;- ah(Surv(time.dties, status) ~ hormone + meno\n       + age + size + grade + nodes + prog + estrg,\n       data = df, ties = FALSE)\n\n# print out the summary\n summary(obj)\n \n beta &lt;- obj$coef\n obj$var\n \n \n # Aalen's model\n\n library(timereg)\n\n obj_aalen &lt;- aalen(Surv(time / 12, status) ~ hormone + meno\n       + age + size + grade + nodes + prog + estrg, data = df)\n\n Bt &lt;- obj_aalen$cum\n # obj_aalen$var.cum\n \n summary(obj_aalen)\n\n \n \npar(mfrow = c(5, 2))\nplot(obj_aalen)\n\n# plot the estimated cumulative regression coefficients\n aalen_beta &lt;- as_tibble(Bt) |&gt; \n   select(-`(Intercept)`) |&gt; # remove intercept\n   pivot_longer(\n     cols = -time, \n     names_to = \"covariate\", \n     values_to = \"beta\") |&gt; \n   mutate(\n    covariate = fct(covariate) \n   )\n\n \n ly_beta &lt;- tibble(\n   time =  Bt[, \"time\"],\n   as_tibble(Bt[, \"time\"] %*% t(beta))\n ) |&gt; \n    pivot_longer(\n     cols = -time, \n     names_to = \"covariate\", \n     values_to = \"beta\") |&gt; \n   mutate(\n    covariate = fct(covariate) \n   )\n \n var_labeller &lt;- c(\n   \"hormone2\" = \"Hormone therapy (yes v. no)\",\n   \"meno2\" = \"Menopausal (yes v. no)\",\n   \"age\" = \"Age (years)\",\n   \"size\" = \"Tumor size (mm)\",\n   \"grade\" = \"Grade (1-3)\",\n   \"nodes\" = \"Nodes\",\n   \"prog\" = \"Progesterone (100 fmol/mg)\",\n   \"estrg\" = \"Estrogen (100 fmol/mg)\"\n )\n \n \n  aalen_beta |&gt; \n   ggplot(aes(x = time, y = beta)) +\n   geom_step() +\n    geom_line(data = ly_beta, aes(x = time, y = beta), color = \"#C5050C\", linetype = 2, linewidth = 1) +\n   scale_x_continuous(\"Time (years)\", limits = c(0, 6), breaks = seq(0, 6, by = 1)) +\n   labs(\n     y = expression(\"B(t) (year\"^{-1}*\")\"),\n   ) + \n   facet_wrap(~covariate, scales = \"free_y\", ncol = 2, labeller = labeller(covariate = var_labeller)) +\n   theme_minimal()\n \n ggsave(\"images/nonhaz_aalen_beta.png\", width = 8, height = 8)\n ggsave(\"images/nonhaz_aalen_beta.eps\", width = 8, height = 8)\n  \n # Explore Cox-Aalen model\n # Fits Cox-Aalen model\n obj_cox_aalen &lt;- cox.aalen(Surv(time / 12, status) ~ prop(hormone) + meno\n       + age + size + grade + nodes + prog + estrg, data = df)\n \n summary(obj_cox_aalen)\n plot(obj_cox_aalen)\n \n obj_cox_aalen$gamma\n  obj_cox_aalen$var.gamma\n  \n  \n  \n ####################################\n ### Proportional odds analysis\n ## using the \"timereg\" package\n ####################################\n \n install.packages(\"timereg\")\n library(timereg)\n \n # Fit a proportional odds model\n ## need to convert hormone and meno from numeric to factor\n obj &lt;- prop.odds(Event(time, status) ~ hormone + meno\n        + age + size + grade + nodes + prog + estrg,\n        data = df)\n\n summary(obj)\n \n # Baseline cumulative odds function\n t &lt;- obj$cum[,1]\n base_odds &lt;- obj$cum[,2]\n \n\n\n\n # Plot baseline cumulative odds\n par(mfrow = c(1, 1))\n plot(stepfun(t, c(0, base_odds)), do.points = FALSE, lwd = 2,\n      xlim=c(0,80), ylim=c(0,1.4), frame.plot = FALSE,\n      ylab=\"Baseline cumulative odds\", xlab=\"Time (months)\", main =\"\")\n \n # ggplot version\n tibble(\n   time = t,\n   odds = base_odds\n ) |&gt; \n   ggplot(aes(x = time / 12, y = odds)) +\n   geom_step() +\n   scale_x_continuous(\"Time (years)\", limits = c(0, 6), breaks = 1:6) +\n   scale_y_continuous(\"Baseline cumulative odds\", limits = c(0, 1.25)) +\n   theme_minimal()\n   \nggsave(\"images/nonhaz_po_base.png\", width = 6, height = 4)\nggsave(\"images/nonhaz_po_base.eps\", width = 6, height = 4)\n \n # Plot the estimated cumulative odds\n \n ###########################################\n ### Accelerated failure time (AFT) analysis\n ## using the \"aftgee\" package\n ##########################################\n \n # install.packages(\"aftgee\")\n library(aftgee)\n\n # fit an AFT model\n ## need to convert hormone and meno from numeric to factor\n ## (will take a little longer than usual...)\n set.seed(123) # se is based on resampling\n obj &lt;- aftgee(Surv(time, status) ~ hormone + meno\n               + age + size + grade + nodes + prog + estrg,\n               data = df, B = 500)\n  # print out summary\n  summary(obj)\n \n exp(obj$coef.res) ## acceleration factors exp(beta)\n \n obj$var.res ## variance of the estimated log-acceleration factors\n \n \n # Parametric aft MODEL\n obj_aft &lt;- survreg(Surv(time, status) ~ hormone + meno\n               + age + size + grade + nodes + prog + estrg,\n               data = df, dist = \"loglogistic\")\n \n summary(obj_aft)\n obj_aft$coefficients\n obj_aft$var\n obj_aft$scale"
  },
  {
    "objectID": "chapter3_tmp.html",
    "href": "chapter3_tmp.html",
    "title": "Chapter 3 - Nonparametric Estimation and Testing",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)"
  },
  {
    "objectID": "chapter3_tmp.html#slides",
    "href": "chapter3_tmp.html#slides",
    "title": "Chapter 3 - Nonparametric Estimation and Testing",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)"
  },
  {
    "objectID": "chapter3_tmp.html#base-r-code",
    "href": "chapter3_tmp.html#base-r-code",
    "title": "Chapter 3 - Nonparametric Estimation and Testing",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nCode\n##################################################################\n# This code generates all numerical results in  chapter 3.      ##\n##################################################################\n\n###################################################\n# Figure 3.2  and Table 3.1                 \n# Nelsen-Aalen estimator of cumulative hazard function\n# for the rat study\n###################################################\n\nlibrary(survival)\n# ##################################################\n# Description of \"rats\" dataset\n# \n# Rat treatment data from Mantel et al. Three rats were chosen from each of 100 litters, \n# one of which was treated with a drug, and then all followed for tumor incidence.\n# \n# \n# \n# \n# Format\n# litter:   litter number from 1 to 100\n# rx:   treatment,(1=drug, 0=control)\n# time: time to tumor or last follow-up\n# status:   event status, 1=tumor and 0=censored\n# sex:  male or female\n# \n# N. Mantel, N. R. Bohidar and J. L. Ciminera. Mantel-Haenszel analyses of litter-matched \n# time to response data, with modifications for recovery of interlitter information. \n# Cancer Research, 37:3863-3868, 1977.\n##############################################################\n\nrats &lt;- read.table(\"Data//Rat Tumorigenicity Study//rats.txt\", header = T)\n\nhead(rats)\n\n#subset to treatment arm\nrats.rx &lt;- rats[rats$rx==1,]\n\n\n\n\n\n#X and delta\ntime &lt;- rats.rx$time\nstatus &lt;- rats.rx$status\n\n#ordered unique  event times\nts &lt;- unique(sort(time[status==1]))\nm &lt;- length(ts)\nts\n#numbers of failures at each point in ts\nds &lt;- table(time[status==1])\n##numbers at risk at each point in ts\nns &lt;- rep(NA,m)\n##Nelsen-Aalen estimator\n## for dLambda \ndL &lt;- rep(NA,m)\n## and Lambda\nL &lt;- rep(NA,m)\nfor (j in 1:m){\n  ns[j] &lt;- sum(time&gt;=ts[j])\n  dL[j] &lt;- ds[j]/ns[j]\n  L[j] &lt;- sum(dL[1:j])\n}\n\nresults &lt;- cbind(ts,ds,ns,dL,L)\n#print the table\nround(results,3)\n\n#plot the estimated cumulative hazard function\npar(mfrow=c(1,1))\nplot(stepfun(ts,c(0,L)),do.points = F,ylim=c(0,0.4),xlim=c(0,120),lwd=2,frame=F,\n     xlab=\"Time (days)\",ylab=\"Cumulative hazard function\",main=\"\",\n     cex.lab=1.5,cex.axis=1.5)\n\n\n\n###################################################\n# Table 3.2                 \n# Kaplan-Meier (KM) estimator of survival function\n# for the rat study\n###################################################\n\n#csurv (conditional survival): 1-d_j/n_j\ncsurv &lt;- 1 - dL\n#variance of csurv by Greenwoods's formula\nvar.csurv &lt;- ds/(ns*(ns-ds))\n\n#KM estimates of survival function\nKMsurv &lt;- rep(NA,m)\n##Greenwoods formula for se\nse &lt;- rep(NA,m)\n\n# Compute the KM estimates and Greenwood's se\nfor (j in 1:m){\n  KMsurv[j] &lt;- prod(csurv[1:j])\n  se[j] &lt;- KMsurv[j]*sqrt(sum(var.csurv[1:j]))\n}\n\nresults2 &lt;- cbind(ts,ds,ns,csurv,KMsurv,se)\n#print the table\nround(results2,3)\n  \n\n\n\n###################################################\n# Figure 3.3                 \n# Kaplan-Meier (KM) estimator of survival function\n# for the rat study\n###################################################\n\nobj &lt;- survfit(Surv(time,status)~1,data=rats.rx,conf.type=\"log-log\")\n\nsummary(obj)\n\n#plot the estimated cumulative hazard function\npar(mfrow=c(1,1))\nplot(obj,ylim=c(0,1),xlim=c(0,100),lwd=2,frame=F,\n     xlab=\"Time (days)\",ylab=\"Survival probabilities\",main=\"\",\n     cex.lab=1.5,cex.axis=1.5)\nlegend(1,0.2,lty=1:2,c(\"Kaplan-Meier curve\",\"95% Confidence limits\"),\n       lwd=2,cex=1.5)\n\n\n\n#################################################\n#   log-rank test for rat study\n#   combing treatment and control\n#################################################\n#dataset\nhead(rats)\n\n# log-rank test on treatment difference\nsurvdiff(Surv(time,status)~rx+ strata(sex),\n         data=rats,rho=0)\n\n##############################################\n# GBC study: igure 3.5 and related test results \n#############################################\n#read in the complete data\ngbc &lt;- read.table(\"German Breast Cancer Study//gbc.txt\")\n\n#subset to first event data\n#Sort the data by time within each id\no &lt;- order(gbc$id,gbc$time)\ngbc &lt;- gbc[o,]\n#get the first row for each id\ndata.CE &lt;- gbc[!duplicated(gbc$id),]\n\n#set status=1 if status==2 or 1\ndata.CE$status &lt;- (data.CE$status&gt;0)+0\n\n\n\n################################################\n# Figure 3.5  Plot the KM curves by hormonal group \n# stratified by menopausal status for GBC study\n################################################\n\npar(mfrow=c(1,3))\n## overall\nobj &lt;- survfit(Surv(time,status)~hormone,data=data.CE)\nplot(obj, xlim=c(0,80),lwd=2,frame=F, lty=c(2,1),\n     xlab=\"Time (months)\",ylab=\"Relaspe-free survival probabilities\",main=\"Overall\",\n     cex.lab=1.5,cex.axis=1.5,cex.main=1.5)\nlegend(1,0.2,lty=2:1,c(\"No Hormone\",\"Hormone\"),\n       lwd=2,cex=1.5)\n\n## pre-menopausal\nobj.pre &lt;- survfit(Surv(time,status)~hormone,data=data.CE[data.CE$meno==1,])\nplot(obj.pre, xlim=c(0,80),lwd=2,frame=F, lty=c(2,1),\n     xlab=\"Time (months)\",ylab=\"Relaspe-free survival probabilities\",main=\"Pre-Menopausal\",\n     cex.lab=1.5,cex.axis=1.5,cex.main=1.5)\nlegend(1,0.2,lty=2:1,c(\"No Hormone\",\"Hormone\"),\n       lwd=2,cex=1.5)\n\n## post-menopausal\nobj.post&lt;- survfit(Surv(time,status)~hormone,data=data.CE[data.CE$meno==2,])\nplot(obj.post, xlim=c(0,80),lwd=2,frame=F, lty=c(2,1),\n     xlab=\"Time (months)\",ylab=\"Relaspe-free survival probabilities\",main=\"Post-Menopausal\",\n     cex.lab=1.5,cex.axis=1.5,cex.main=1.5)\nlegend(1,0.2,lty=2:1,c(\"No Hormone\",\"Hormone\"),\n       lwd=2,cex=1.5)\n\n\n\n## Stratified log-rank test (by menopausal status)\nsurvdiff(Surv(time,status)~hormone+ strata(meno),\n         data=data.CE)\n## Unstratified log-rank test\nsurvdiff(Surv(time,status)~hormone,\n         data=data.CE)"
  },
  {
    "objectID": "chapter3_tmp.html#tidyverse-solutions",
    "href": "chapter3_tmp.html#tidyverse-solutions",
    "title": "Chapter 3 - Nonparametric Estimation and Testing",
    "section": "Tidyverse Solutions",
    "text": "Tidyverse Solutions\n\nlibrary(\"survminer\")\n\nWarning: package 'survminer' was built under R version 4.4.1\n\n\nLoading required package: ggplot2\n\n\nLoading required package: ggpubr\n\n\nWarning: package 'ggpubr' was built under R version 4.4.1\n\nlibrary(tidyverse)\n\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ lubridate 1.9.3     ✔ tibble    3.2.1\n✔ purrr     1.0.2     ✔ tidyr     1.3.1\n\n\n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors\n\nlibrary(\"survival\")\n\nWarning: package 'survival' was built under R version 4.4.1\n\n\n\nAttaching package: 'survival'\n\nThe following object is masked from 'package:survminer':\n\n    myeloma\n\nfit&lt;- survfit(Surv(time, status) ~ sex, data = lung)\n\n# Drawing survival curves\nggsurvplot(fit, data = lung, risk.table = TRUE)\n\n\n\n\n\n\n\ntab3_1 &lt;- tribble(\n  ~time, ~status,\n     101,     0, \n      55,     0,\n    67,      1, \n    23,      0, \n  45,    1, \n   98,     0, \n  34,      1,  \n   77,      0, \n   91,     0, \n  104,     0,  \n   88,     1\n) |&gt; \n  mutate(\n    id = row_number(),\n    .before = 1\n  )\n\n\n\nfig3_2 &lt;- tab3_1 |&gt; \n  ggplot(aes(x = time, y = reorder(id, time))) +\n  geom_linerange(aes(xmin = 0, xmax = time)) +\n  geom_point(aes(shape = factor(status)), size = 2.5, fill = \"white\") +\n  geom_vline(xintercept = 0, linewidth = 1) +\n  theme_minimal() +\n  scale_y_discrete(name = \"Rats\") +\n  scale_x_continuous(name = \"Time (days)\", breaks = seq(0, 100, by = 20), \n                     expand = expansion(c(0, 0.05))) +\n  scale_shape_manual(values = c(23, 19), labels = c(\"Censoring\", \"Tumor development\")) +\n  theme(\n    legend.position = \"top\",\n    legend.title = element_blank(),\n    axis.text.y = element_blank(),\n    axis.ticks.y = element_blank(),\n    panel.grid.major.y = element_blank(),\n    legend.text = element_text(size = 11)\n    \n  )\n  \n\nggsave(\"km_rats.pdf\", fig3_2, width = 8, height = 3.2)\nggsave(\"km_rats.eps\", fig3_2, width = 8, height = 3.2)\n\n\n#read in the complete data\ngbc &lt;- read.table(\"Data//German Breast Cancer Study//gbc.txt\")\n\ngbc_ce &lt;- gbc |&gt; \n  group_by(id) |&gt; \n  slice_min(time) |&gt; \n  slice_max(status) \n\n\n# gbc_ce |&gt; \n#   count(id) |&gt; \n#   filter(n&gt;1)\n# \n# gbc |&gt; \n#   filter(\n#     status == 1\n#   )\n\nn &lt;- nrow(gbc)\n\nset.seed(2024)\ngbc_ce_sub &lt;- gbc_ce |&gt; \n  filter(id %in% sample(n, 200)) \n\n# create a vector to label the panels\nhormone_labeller &lt;- c(\"1\" = \"No Hormone\", \"2\" = \"Hormone\")\n\nfig3_5 &lt;- gbc_ce_sub |&gt; \n  ggplot(aes(x = time, y = reorder(factor(id), time))) +\n  geom_linerange(aes(xmin = 0, xmax = time)) +\n  geom_point(aes(shape = factor(status), fill = factor(status)), size = 2.5) +\n  geom_vline(xintercept = 0, linewidth = 1) +\n  theme_minimal() +\n  scale_y_discrete(name = \"Patients\") +\n  scale_x_continuous(name = \"Time (months)\", breaks = seq(0, 84, by = 12), \n                     expand = expansion(c(0, 0.05))) +\n  scale_shape_manual(values = c(23, 22, 19), \n                     labels = c(\"Censoring\", \"Relapse\", \"Death\")) +\n  \n  scale_fill_manual(values = c(\"white\", \"black\", \"black\"), \n                     labels = c(\"Censoring\", \"Relapse\", \"Death\")) +\n  facet_wrap(~ hormone, scales = \"free\", \n             labeller = labeller(hormone = hormone_labeller)) +\n  theme(\n    legend.position = \"top\",\n    legend.title = element_blank(),\n    axis.text.y = element_blank(),\n    axis.ticks.y = element_blank(),\n    panel.grid.major.y = element_blank(),\n    legend.text = element_text(size = 11)\n    \n  )\n\n\nggsave(\"km_gbc_fu.pdf\", fig3_5, width = 8, height = 9)\nggsave(\"km_gbc_fu.eps\", fig3_5, width = 8, height = 9)\n\n\nfit &lt;- survfit(Surv(time, status &gt; 0) ~ hormone, data = gbc_ce)\nggsurvplot(fit, gbc_ce, risk.table = TRUE,\n                palette = \"jco\", pval = TRUE,\n           risk.table.height = 0.2)"
  },
  {
    "objectID": "chapter2.html",
    "href": "chapter2.html",
    "title": "Chapter 2 - Mathematical Foundations",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 2 - Mathematical Foundations"
    ]
  },
  {
    "objectID": "chapter2.html#slides",
    "href": "chapter2.html#slides",
    "title": "Chapter 2 - Mathematical Foundations",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 2 - Mathematical Foundations"
    ]
  },
  {
    "objectID": "chapter2.html#chapter-summary",
    "href": "chapter2.html#chapter-summary",
    "title": "Chapter 2 - Mathematical Foundations",
    "section": "Chapter Summary",
    "text": "Chapter Summary\nTime-to-event data require specialized techniques for analysis. These tend to focus on the survival function \\(S(t)\\) and the hazard function \\(\\lambda(t)\\) of the latent (uncensored) event time \\(T\\). Some methods rely on parametric models, while others leverage counting processes and martingales for robust inference.\n\nNotation and basic quantities\nAn outcome event time can be represented either as a random variable \\(T\\) or as a counting process \\(N^*(t) = I(T \\le t)\\). The survival function is defined as \\[\nS(t) = \\mathrm{pr}(T &gt; t),\n\\] while the hazard function \\(\\lambda(t)\\) quantifies the instantaneous risk of experiencing the event at time \\(t\\), conditional on survival up to that point. The cumulative hazard function is obtained by integrating \\(\\lambda(t)\\) over \\([0, t]\\): \\(\\Lambda(t) = \\int_0^t \\lambda(u)\\,\\mathrm{d}u\\), and relates to \\(S(t)\\) via \\[\n\\Lambda(t) = -\\log\\bigl\\{S(t)\\bigr\\} \\quad\\Longleftrightarrow\\quad S(t) = \\exp\\bigl\\{-\\Lambda(t)\\bigr\\}.\n\\] This relationship is central in survival analysis.\nSimple parametric models for \\(T\\) include the exponential, Weibull, Gamma, and log-normal distributions, each with distinct hazard functions. The exponential model assumes constant hazard, while the Weibull model allows for time-varying (but still monotone) hazards.\n\n\nObserved data and likelihood\nIn practice, the event time is subject to censoring by time \\(C\\). As a result, we only observe \\(X = \\min(T, C)\\), along with the event indicator \\(\\delta = I(T \\le C)\\). Under independent censoring, the likelihood function for the observed data \\((X, \\delta)\\) is given by \\[\np\\bigl(X,\\delta\\bigr)\n\\;=\\;\n\\lambda\\bigl(X\\bigr)^{\\delta}\\,S\\bigl(X\\bigr).\n\\] This means that, for a sample of size \\(n\\), the log-likelihood is \\[\n\\ell_n(\\theta) =  \nn^{-1}\\sum_{i=1}^n\n\\Bigl\\{\n  \\delta_i\\,\\log \\lambda\\bigl(X_i;\\theta\\bigr)\n  \\;-\\;\n  \\int_{0}^{\\infty}\n    I\\bigl(X_i \\ge t\\bigr)\\,\\lambda\\bigl(t;\\theta\\bigr)\\,\\mathrm{d}t.\n\\Bigr\\}\n\\] where \\(\\lambda(t;\\theta)\\) is the hazard function parametrized by \\(\\theta\\). We can use this general expression for the log-likelihood to derive maximum likelihood estimator for any parametric models.\n\n\nStochastic integrals and martingales\nTo count the observed event under censoring, define \\(N(t) = N^*(t\\wedge C)\\), where \\(x\\wedge y = \\min(x, y)\\). The step function \\(N(t)\\) takes a jump of size 1, i.e., \\(\\mathrm{d}N(t)=1\\), at \\(t = X\\) if \\(\\delta = 1\\); it stays flat if \\(\\delta = 0\\). Hence, any function of the form \\(\\delta h(X)\\) can be re-written as a stochastic integral \\(\\int_0^\\infty h(t)\\mathrm{d}N(t)\\).\nIf we consider \\(\\mathrm{d}N(t)\\) as the Bernoulli response of event occurrence at time \\(t\\), then we can decompose it into \\(\\mathrm{d}N(t) = I(X\\ge t)\\lambda(t)\\mathrm{d} t + \\mathrm{d}M(t)\\), where \\[\n\\mathrm{d}M(t)\n\\;=\\;\n\\underbrace{\\mathrm{d}N(t)}_{\\text{Observed}}\n\\;-\\;\n\\underbrace{I\\bigl(X \\ge t\\bigr)\\,\\lambda(t)\\,\\mathrm{d}t}_{\\text{Expectation given data\nprior to $t$}}.\n\\] is the martingale increment.\nThe martingale property of \\(M(t)\\) implies that the expectation of \\(\\mathrm{d}M(t)\\), given the event history up to time \\(t\\), is zero. It also implies that the increments at different times are uncorrelated. This property of uncorrelated increments simplifies the variance calculation for martingale integrals of the form: \\[\n\\int_0^t h(u)\\,\\mathrm{d}M(u)\n\\] Many test statistics, estimators, and score functions can be expressed in the above form, and the martingale properties facilitate their asymptotic analysis.\n\n\nConclusion\nAlthough \\(T\\) may not be directly observed, the partial information in \\((X, \\delta)\\) still supports principled inferences about its distribution. Parametric models describe \\(\\lambda(t)\\) or \\(S(t)\\) via a likelihood-based approach, while a martingale-based framework captures event processes through residuals and their properties. The latter approach will be utilized extensively in the non- and semi-parametric analysis presented in later chapters.",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 2 - Mathematical Foundations"
    ]
  },
  {
    "objectID": "chapter14.html",
    "href": "chapter14.html",
    "title": "Chapter 14 - Causal Inference in Survival Analysis",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)"
  },
  {
    "objectID": "chapter14.html#slides",
    "href": "chapter14.html#slides",
    "title": "Chapter 14 - Causal Inference in Survival Analysis",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)"
  },
  {
    "objectID": "chapter14.html#base-r-code",
    "href": "chapter14.html#base-r-code",
    "title": "Chapter 14 - Causal Inference in Survival Analysis",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nShow the code\n##################################################################\n# This code generates all numerical results in chapter 14.     ##\n##################################################################\n\n\nlibrary(survival)\n##############################################\n# GBC study\n#############################################\n#read in the complete data\ngbc &lt;- read.table(\"Data//German Breast Cancer Study//gbc.txt\")\n\n#subset to first event data\n#Sort the data by time within each id\no &lt;- order(gbc$id,gbc$time)\ngbc &lt;- gbc[o,]\n#get the first row for each id\ndata.CE &lt;- gbc[!duplicated(gbc$id),]\n\n#set status=1 if status==2 or 1\ndata.CE$status &lt;- (data.CE$status&gt;0)+0\n\nhead(data.CE)\n\n\n######################\n# Section 14.2.3\n######################\n\n# create treatment variable A\n# A=1: hormone treatment\n# A=0: non-treatment\ndata.CE$A &lt;- data.CE$hormone - 1\n\n\n\n# Load the ipw package for propensity score calculation\nlibrary(ipw)\n\n# compute propensity score for A against\n# menopausal status, tumor size, grade, nodes,\n# progesterone and estrogen receptor levels\ntmp &lt;- ipwpoint(exposure=A,family=\"binomial\",link=\"logit\",\n              denominator=~ meno+size+factor(grade)+nodes+\n                  prog+estrg, data=data.CE)\n\n# naive version (unweighted)\nobj.naive &lt;- survfit(Surv(time,status)~A,data=data.CE)\n# IPTW version (weighted by temp$ipw.weights computed from the\n#   ipwpoint() function)\nobj &lt;- survfit(Surv(time,status) ~ A,weights = tmp$ipw.weights, data = data.CE)\n\n\n# IPTW Cox model (essentially a marginal structural Cox model)\ncoxph(Surv(time,status)~A,weights=tmp$ipw.weights,data=data.CE)\n\ncoxph(Surv(time,status)~A,data=data.CE)\n\n\n#########################################################\n# Figure 15.3 Naive and IPTW-adjusted Kaplan--Meier \n# curves for the German Breast Cancer study by treatment\n#########################################################\nplot(obj.naive, xlim=c(0,80),lwd=2,frame=F, lty=c(2,1),\n     xlab=\"Time (months)\",ylab=\"Relaspe-free survival probabilities\",\n     cex.lab=1.5,cex.axis=1.5)\n\nlines(obj,col='red',lty=c(2,1), cex.lab=1.5,cex.axis=1.5)\nlegend(1,0.3,lty=c(2:1,2:1), col=rep(c(\"black\",\"red\"),each=2),\n       c(\"No Hormone (naive)\",\"Hormone (naive)\",\n         \"No Hormone (IPTW)\",\"Hormone (IPTW)\"),\n       lwd=2,cex=1.5)\n\n\n\n################################\n# Section 14.3.3 HIV/AIDS study \n################################\n\n# need the ipw package\ndata(\"haartdat\")\ncolnames(haartdat)[8] &lt;- \"cd4\"\n\nhead(haartdat)\n\n\n\n# Compute the IPTW weights\niptw &lt;- ipwtm(exposure = haartind, family = \"survival\",\n          numerator = ~ sex + age, denominator = ~ cd4 + sex + age,\n          id = patient, tstart = tstart, timevar = fuptime, type = \"first\",\n          data = haartdat)\n\n# Compute the IPCW weights\nipcw &lt;- ipwtm(exposure = dropout, family = \"survival\",\n              numerator = ~ sex + age, denominator = ~ cd4 + sex + age,\n              id = patient, tstart = tstart, timevar = fuptime, type = \"first\",\n              data = haartdat)\n\n# Fit IPTW/IPCW marginal structural Cox model\nobj &lt;- coxph(Surv(tstart, fuptime, event) ~ haartind + sex + age+ \n               cluster(patient), data = haartdat, \n             weights = iptw$ipw.weights*ipcw$ipw.weights)\nsummary(obj)\n\n\n# Naive Cox model with time-varying treatment\nobj_naive &lt;- coxph(Surv(tstart, fuptime, event) ~ haartind + sex + age+ \n               cluster(patient), data = haartdat)\nsummary(obj_naive)"
  },
  {
    "objectID": "chapter12.html",
    "href": "chapter12.html",
    "title": "Chapter 12 - Multistate Modeling of Life History",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 12 - Multistate Modeling of Life History"
    ]
  },
  {
    "objectID": "chapter12.html#slides",
    "href": "chapter12.html#slides",
    "title": "Chapter 12 - Multistate Modeling of Life History",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 12 - Multistate Modeling of Life History"
    ]
  },
  {
    "objectID": "chapter12.html#base-r-code",
    "href": "chapter12.html#base-r-code",
    "title": "Chapter 12 - Multistate Modeling of Life History",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nShow the code\n##################################################################\n# This code generates all numerical results in chapter 12.      ##\n##################################################################\n\n\n############################################################\n# Table 12.1\n# Multi-state analysis of the GBC Study\n############################################################\n\nlibrary(\"survival\")\n\n # read data\ngbc_ms &lt;- read.table(\"Data//German Breast Cancer Study//gbc_ms.txt\")\n\n# categorize age into three groups\n# &lt;=40, &gt;40 & &lt;=60, &gt;60\ngbc_ms$agec &lt;- (gbc_ms$age&lt;=40) + 2*(gbc_ms$age&gt;40&gbc_ms$age&lt;=60) +\n        3*(gbc_ms$age&gt;60)\n\n# B(t): time spent in current state\ngbc_ms$Bt &lt;- gbc_ms$stop - gbc_ms$start\n\n# change unit to 10 fmol/mg\ngbc_ms$prog &lt;- gbc_ms$prog/10\ngbc_ms$estrg &lt;- gbc_ms$estrg/10\n\n# convert variables to factors\ngbc_ms$hormone &lt;- factor(gbc_ms$hormone)\ngbc_ms$meno &lt;- factor(gbc_ms$meno)\ngbc_ms$agec &lt;- factor(gbc_ms$agec)\n\n###############################\n#Fit the transition models\n#############################\n\n### 0-&gt;1: remission to relapse\nobj01 &lt;- coxph(Surv(start, stop, status) ~ hormone + meno\n                     + agec + size + prog + estrg + strata(grade), data = gbc_ms,\n               subset = ((from==0) & (to == 1)))\n\n### 0-&gt;2: remission to death\nobj02 &lt;- coxph(Surv(start, stop, status) ~ hormone + meno\n            + size + prog + estrg + strata(grade), data = gbc_ms,\n            subset = ((from == 0) & (to == 2)))\n\n### 1-&gt;2: relapse to death\nobj12 &lt;- coxph(Surv(start, stop, status) ~ Bt + hormone + meno\n            + agec + size + prog + estrg + strata(grade), data = gbc_ms,\n            subset = ((from == 1) & (to == 2)))\n\n##########################################\n### Tabulate the results \n##########################################\n\n### 0-&gt;1: remission to relapse\nbeta01 &lt;- obj01$coefficients\nse01 &lt;- sqrt(diag(obj01$var))\np01 &lt;- 1-pchisq((beta01/se01)^2,1)\n\nc1 &lt;- round(exp(beta01),3)\nc2 &lt;- paste0(\"(\",round(exp(beta01-1.96*se01),3),\", \",\n          round(exp(beta01+1.96*se01),3),\")\")\nc3 &lt;- round(p01,3)\n# print out the sub-table\nnoquote(cbind(c1,c2,c3))\n\n\n\n### 0-&gt;2: remission to death\nbeta02 &lt;- obj02$coefficients\nse02 &lt;- sqrt(diag(obj02$var))\np02 &lt;- 1-pchisq((beta02/se02)^2,1)\n\nc1 &lt;- round(exp(beta02),3)\nc2 &lt;- paste0(\"(\",round(exp(beta02-1.96*se02),3),\", \",\n          round(exp(beta02+1.96*se02),3),\")\")\nc3 &lt;- round(p02,3)\n# print out the sub-table\nnoquote(cbind(c1,c2,c3))\n\n\n### 1-&gt;2: relapse to death\nbeta12 &lt;- obj12$coefficients\nse12 &lt;- sqrt(diag(obj12$var))\np12 &lt;- 1-pchisq((beta12/se12)^2,1)\n\nc1 &lt;- round(exp(beta12),3)\nc2 &lt;- paste0(\"(\",round(exp(beta12-1.96*se12),3),\", \",\n          round(exp(beta12+1.96*se12),3),\")\")\nc3 &lt;- round(p12,3)\n# print out the sub-table\nnoquote(cbind(c1,c2,c3))"
  },
  {
    "objectID": "chapter10.html",
    "href": "chapter10.html",
    "title": "Chapter 10 - Competing and Semi-Competing Risks",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 10 - Competing and Semi-Competing Risks"
    ]
  },
  {
    "objectID": "chapter10.html#slides",
    "href": "chapter10.html#slides",
    "title": "Chapter 10 - Competing and Semi-Competing Risks",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 10 - Competing and Semi-Competing Risks"
    ]
  },
  {
    "objectID": "chapter10.html#base-r-code",
    "href": "chapter10.html#base-r-code",
    "title": "Chapter 10 - Competing and Semi-Competing Risks",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nShow the code\n##################################################################\n# This code generates all numerical results in chapter 10.      ##\n##################################################################\n\n\n############################################################\n# Analysis of the Bone Marrow Transplantation Study\n############################################################\n\nlibrary(survival)\n# read in the study dataset\ncibmtr &lt;- read.table(\"Data//Bone Marrow Transplantation Study//cibmtr.txt\")\nhead(cibmtr)\n\n#load the cmprsk package\nlibrary(cmprsk)\n\n# Gray's (unweighted) log-rank-type test\nobj &lt;- cuminc(cibmtr$time, cibmtr$status, cibmtr$donor, rho = 0)\n\n# test results\nobj$Tests\n\n# a naive plot: everything in one plot\n# plot(obj)\n\n\n##################################\n# obj$`a k`: kth risk in group a #\n##################################\n\n# Obtain the estimated cumulative incidence functions\n# for kth (k=1, 2) risk in group a (a=1, 0)\n# k=1: relapse; k=2: TRM\nobj.rlp.sib &lt;- obj$`0 1`\nobj.rlp.nonsib &lt;- obj$`1 1`\nobj.trm.sib &lt;- obj$`0 2`\nobj.trm.nonsib &lt;- obj$`1 2`\n\n#############################################\n# Figure 10.2\n# plot the cumulative incidence functions\n##############################################\npar(mfrow=c(1,2))\n\nplot(obj.rlp.sib$time,obj.rlp.sib$est,type='s', frame.plot = F,\n     main=\"Relapse\",xlim=c(0,120),ylim=c(0,0.6),\n     xlab=\"Time (months)\", ylab=\"Cumulative incidence\", lwd=2)\nlines(obj.rlp.nonsib$time,obj.rlp.nonsib$est,lty=3,lwd=2)\n\nplot(obj.trm.sib$time,obj.trm.sib$est,type='s', frame.plot = F,\n     main=\"Treatment-related mortality\",xlim=c(0,120),ylim=c(0,0.6),\n     xlab=\"Time (months)\", ylab=\"Cumulative incidence\", lwd=2)\nlines(obj.trm.nonsib$time,obj.trm.nonsib$est,lty=3,lwd=2)\n\n\n\n###########################\n# Table 10.2              #\n###########################\n\n######################################################\n# Fine-Gray proportional sub-distribution hazard model\n# and cause-specific hazard model\n######################################################\n\n#change k\nk &lt;- 1\n\n#### proportional cause-specific hazards\nobj.cs &lt;- coxph(Surv(time, status == k) ~ cohort + donor + hist + wait,\n                data = cibmtr)\n\n#### Fine and Gray #################\nobj.fg &lt;- crr(cibmtr$time, cibmtr$status, cibmtr[,3:6], failcode = k)\n\n# beta estimates and se's\nbeta.fg &lt;- obj.fg$coef\nse.fg &lt;- sqrt(diag(obj.fg$var))\n\n# construct HR, 95% CI, and p-values\nc1 &lt;- round(exp(beta.fg),2)\nc2 &lt;- paste0(\"(\",round(exp(beta.fg-1.96*se.fg),2),\"-\",round(exp(beta.fg+1.96*se.fg),2),\")\")\nc3 &lt;- round(1-pchisq((beta.fg/se.fg)^2,1),3)\n\n### Cause-specific hazard ############\nobj.csh &lt;- coxph(Surv(time,status==k)~cohort+donor+hist+wait,data=cibmtr)\n\n# beta estimates and se's\nbeta.csh &lt;- obj.csh$coef\nse.csh &lt;- sqrt(diag(obj.csh$var))\n\n# construct HR, 95% CI, and p-values\nc4 &lt;- round(exp(beta.csh),2)\nc5 &lt;- paste0(\"(\",round(exp(beta.csh-1.96*se.csh),2),\"-\",round(exp(beta.csh+1.96*se.csh),2),\")\")\nc6 &lt;- round(1-pchisq((beta.csh/se.csh)^2,1),3)\n\n# print the results\nnoquote(cbind(c1,c2,c3,c4,c5,c6))\n\n#######################################\n## prediction of covariate-specific CIF\n# example \n#######################################\nz &lt;- c(1, 0, 1, 0)\n\n# Method 1\n# --- Method 1: use predict.crr() \nobj_pred1 &lt;- predict(obj.fg, z)\n# --- Method 2: manual calculation\nbeta &lt;- obj.fg$coef\nLambda &lt;- cumsum(obj.fg$bfitj)\ntime &lt;- obj.fg$uftime\n## calculate CIF based on FG model\ncif &lt;- 1- exp(- exp(sum(beta * z)) * Lambda)\n## Same as obj_pred from Method 1\nobj_pred2 &lt;- cbind(time, cif)\n\n## same results\ncbind(obj_pred1, obj_pred2)\n\n\n# Tidy competing risks analysis\nlibrary(tidycmprsk)\nlibrary(ggsurvfit)\n# library(gtsummary)\n\ndf &lt;- cibmtr |&gt; \n  dplyr::mutate(\n    status = factor(status, levels = c(\"0\", \"1\", \"2\"), labels = c(\"Censored\", \"Relapse\", \"TRM\")),\n    donor = factor(donor, levels = c(\"0\", \"1\"), \n                   labels = c(\"Id. sibling\", \"Unrelated\"))\n  )\n\n\n\n\n# Nonparametric analysis cumulative incidence by donor\nobj_cif &lt;- tidycmprsk::cuminc(Surv(time, status) ~ donor, data = df)\n# Print results\nobj_cif\n#&gt; ── cuminc() ─────────────────────────────────────────────────\n#&gt; \n#&gt; • Failure type \"Relapse\"\n#&gt; strata                  time   n.risk   estimate   std.error   95% CI          \n#&gt; HLA-identical sibling   50.0   78       0.386      0.023       0.341, 0.432    \n#&gt; HLA-identical sibling   100    23       0.451      0.026       0.400, 0.501    \n#&gt; HLA-identical sibling   150    1        0.557      0.044       0.466, 0.639    \n#&gt; Unrelated dono          50.0   12       0.505      0.031       0.443, 0.564    \n#&gt; Unrelated dono          100    3        0.529      0.032       0.464, 0.589    \n#&gt; Unrelated dono          150    0        0.529      0.032       0.464, 0.589    \n#&gt; \n#&gt; • Failure type \"TRM\"\n#&gt; strata                  time   n.risk   estimate   std.error   95% CI          \n#&gt; HLA-identical sibling   50.0   78       0.317      0.020       0.278, 0.357    \n#&gt; HLA-identical sibling   100    23       0.331      0.021       0.289, 0.373    \n#&gt; HLA-identical sibling   150    1        0.387      0.063       0.265, 0.507    \n#&gt; Unrelated dono          50.0   12       0.424      0.030       0.366, 0.482    \n#&gt; Unrelated dono          100    3        0.430      0.030       0.371, 0.488    \n#&gt; Unrelated dono          150    0        0.430      0.030       0.371, 0.488    \n#&gt; \n#&gt; • Tests\n#&gt; outcome   statistic   df     p.value    \n#&gt; Relapse   17.3        1.00   &lt;0.001     \n#&gt; TRM       12.3        1.00   &lt;0.001\n\n# Summaries at specific times with labeled treatment groups\ntbl_surv &lt;- tbl_cuminc(\n    x = obj_cif,                     # Provide the fitted tidycuminc object\n    times = seq(12, 120, by = 36),   # Time points for cumulative incidence\n    outcomes = c(\"Relapse\", \"TRM\"),  # Specify which risks to include\n    label_header = \"{time} months\",  # Column label: \"xx months\"\n    label = \"Donor\"                  # Group label \n) \n\ntbl_surv\n\nobj_cif |&gt; \n  ggcuminc(outcome = c(\"Relapse\", \"TRM\")) +\n  scale_x_continuous(\"Time (months)\", limits = c(0, 120), breaks = seq(0, 120, by = 24)) +\n  add_risktable(\n    risktable_stats = \"n.risk\", # Include only numbers at risk\n    theme = list(\n      theme_risktable_default() # Default risk table theme\n      # scale_y_discrete(labels = c('Drug', 'Control')) # Group labels\n    )\n  ) +\n  theme_minimal()\n\n## Separate plots by risk\n\nobj_cif |&gt; \n  ggcuminc(outcome = c(\"Relapse\", \"TRM\")) +\n  scale_x_continuous(\"Time (months)\", limits = c(0, 120), breaks = seq(0, 120, by = 24)) +\n  add_risktable(\n    risktable_stats = \"n.risk\", # Include only numbers at risk\n    theme = list(\n      theme_risktable_default(), # Default risk table theme\n      scale_y_discrete(labels = c('Drug', 'Control')) # Group labels\n    )\n  ) +\n  theme_minimal() \n\nlibrary(patchwork) # For combining plots\nlibrary(ggsci) # For the JAMA color style\n\nplot_bm_cif &lt;- function(obj_cif, outcome) {\n  \n  p &lt;- ggcuminc(obj_cif, outcome, linetype_aes = TRUE, linewidth = 0.8) +\n    add_risktable(\n      risktable_stats = \"n.risk\",\n      theme = list(\n        theme_risktable_default(),\n        scale_y_discrete()\n      )\n    ) +\n    ggtitle(outcome) + \n    scale_y_continuous(\n      \"Cumulative incidence\", \n      limits  = c(0, 0.6),\n      breaks  = seq(0, 1, by = 0.1),\n      expand  = expansion(c(0, 0.005))\n    ) +\n    scale_x_continuous(\"Time (months)\", limits = c(0, 120), breaks = seq(0, 120, by = 24)) +\n    scale_color_jama() +\n    scale_linetype_manual(values = c(2, 1)) +\n    theme_classic() +\n    theme(\n      plot.margin        = margin(0, 0, 0, 0),\n      legend.position    = \"top\",\n      legend.key.width   = unit(1, \"cm\"),\n      panel.grid.major.y = element_line(),\n      legend.text        = element_text(size = 10),\n      plot.caption       = element_text(size = 10),\n      plot.title         = element_text(size = 12)\n    )\n  \n  p\n}\n\n# Two panels by donor type\nrel_fig  &lt;- plot_bm_cif(obj_cif, \"Relapse\")\ntrm_fig  &lt;- plot_bm_cif(obj_cif, \"TRM\")\n\n# Combine with patchwork\nbm_fig &lt;- wrap_plots(ggsurvfit_build(rel_fig ), ggsurvfit_build(trm_fig), ncol = 2)\n\nbm_fig\n\nggsave(\"images/cmpr_bm.png\", bm_fig, width = 8, height = 4.5)\nggsave(\"images/cmpr_bm.eps\", bm_fig, width = 8, height = 4.5)\n\n\n# Fine-Gray regression\n# Relapse\nobj_rel &lt;- tidycmprsk::crr(Surv(time, status) ~ donor + cohort + hist + wait, \n                           data = df, failcode = \"Relapse\")\nobj_rel # Print the results\n#&gt; --- crr() ---------------------------------------------------\n#&gt; • Call Surv(time, status) ~ donor + cohort + hist + wait\n#&gt; • Failure type of interest \"Relapse\"\n#&gt; \n#&gt; Variable         Coef    SE      HR     95% CI       p-value    \n#&gt; donor            0.330   0.122   1.39   1.09, 1.77   0.007      \n#&gt; cohort           0.401   0.122   1.49   1.18, 1.90   0.001      \n#&gt; hist             0.351   0.125   1.42   1.11, 1.82   0.005      \n#&gt; wait             0.216   0.123   1.24   0.98, 1.58   0.078 \n\n# 2. TRM\nobj_trm &lt;- tidycmprsk::crr(Surv(time, status) ~ donor + cohort + hist + wait, \n                           data = df, failcode = \"TRM\")\nobj_trm # Print the results\n#&gt; --- crr() ---------------------------------------------------\n#&gt; • Call Surv(time, status) ~ donor + cohort + hist + wait\n#&gt; • Failure type of interest \"TRM\"\n#&gt; \n#&gt; Variable         Coef     SE      HR     95% CI       p-value    \n#&gt; donor            0.514    0.128   1.67   1.30, 2.15   &lt;0.001     \n#&gt; cohort           -0.578   0.139   0.56   0.43, 0.74   &lt;0.001     \n#&gt; hist             -0.460   0.153   0.63   0.47, 0.85   0.003      \n#&gt; wait             0.248    0.135   1.28   0.98, 1.67   0.065   \n\n\nlibrary(gtsummary)\ntbl_regression(obj_fg1, exponentiate = TRUE)\n\n## Proportional subdistribution odds\nlibrary(timereg)\n# Relapse\nobj_po1 &lt;- prop.odds.subdist(Event(time, status) ~ donor + cohort + hist + wait, \n                            data = df, cause = 1)\n\nobj_po1$gamma\nobj_po1$robvar.gamma\n\n\n\n## component-wise marginal regression\nlibrary(gtsummary)\nlibrary(labelled)\nlibrary(tidycmprsk)\n\n# read data\ngbc &lt;- read.table(\"Data//German Breast Cancer Study//gbc.txt\")\n### data transformation\ngbc &lt;- gbc |&gt; \n  mutate(\n    age40 = (age &gt; 40) + 0,\n    grade = factor(grade),\n    prog = prog / 100, # rescale progesterone\n    estrg = estrg / 100 # rescale estrogen\n  )\n\nvar_label(gbc) &lt;- list(\n  hormone = \"Hormone\",\n  meno = \"Menopause\",\n  age40 = \"Age 40+\",\n  grade = \"Tumor grade\",\n  size = \"Tumor size (mm)\",\n  prog = \"Progesterone (100 fmol/mg)\",\n  estrg = \"Estrogen (100 fmol/mg)\"\n  )\n\n### Regular cox model for death\ngbc_death &lt;- gbc|&gt; \n  filter(status != 1) |&gt; \n  mutate(status = status &gt; 0)\n\n\n# gbc_death |&gt; \n#   count(status)\n\nobj_death &lt;- coxph(Surv(time, status) ~ hormone + meno\n                   + age40 + grade + size + prog + estrg, \n                   data = gbc_death)\n\n\ndeath_tbl &lt;- tbl_regression(obj_death, exponentiate = TRUE)\n\n### cause-specific hazards for relapse\n\ngbc_relc &lt;- gbc |&gt; \n  group_by(id) |&gt; \n  slice_min(time) |&gt; \n  mutate(\n    status = if_else(status == 2, 0, status)\n  ) |&gt; \n  slice_max(status) |&gt; \n  ungroup()\n\n# gbc_relc |&gt; \n#   count(status)\n\nobj_relc &lt;- coxph(Surv(time, status) ~ hormone + meno\n                   + age40 + grade + size + prog + estrg, \n                   data = gbc_relc)\n\n\nrelc_tbl &lt;- tbl_regression(obj_relc, exponentiate = TRUE)\n\n\n\n\n### subdistribution hazards for relapse\n\ngbc_tfe &lt;- gbc |&gt; \n  group_by(id) |&gt; \n  slice_min(time) |&gt; \n  slice_max(status) |&gt; # death &gt; relapse &gt; censoring\n  mutate(\n    status = factor(status, levels = c(\"0\", \"1\", \"2\"))\n  ) |&gt; \n  ungroup()\n\ngbc_tfe |&gt; count(status) \n# gbc_tfe$status\n\n\nobj_rel_sub &lt;- crr(Surv(time, status) ~ hormone + meno\n                   + age40 + grade + size + prog + estrg, \n                   data = gbc_tfe, failcode = \"1\")\n\nrel_sub_tbl &lt;- tbl_regression(obj_rel_sub, exponentiate = TRUE)\n\n\ntbl &lt;- tbl_merge(\n  tbls = list(death_tbl, relc_tbl, rel_sub_tbl),\n  tab_spanner = c(\"**Death**\", \"**Relapse (cause-specific)**\",\n                  \"**Relapse (subdistribution)**\")\n)\n\ntbl\n# as_kable_extra(tbl, format = \"latex\")\n\n## bladder tumor study\nlibrary(tidyverse)\ndevtools::install_github(\"lmaowisc/rccf2\")\nlibrary(rccf2)\n# ?rccf\ndata(bladder)\nbladder\n# descritpive analysis\nbladder |&gt; \n  count(status)\n\n\n## follow-up plot\n\ndf &lt;- bladder |&gt; \n  left_join(\n    bladder |&gt; group_by(id) |&gt; summarize(max_fu = max(time)),\n    join_by(id)\n  ) |&gt; \n  mutate(\n    id = factor(id),\n    status = factor(status, levels = c(\"0\", \"1\", \"2\")),\n    trt = if_else(trt == 1,  \"Thiotepa\", \"Placebo\")\n  ) \n\ndfmax &lt;-  df |&gt; \n  group_by(id, trt) |&gt; \n  summarize(max_fu = max(time))\n\ndf |&gt; \n  ggplot(aes(y = reorder(id, max_fu))) +\n  geom_linerange(data = dfmax, aes(xmin = 0, xmax = max_fu)) +\n  geom_point(aes(x = time, shape = status), size = 2, fill = \"white\") +\n  geom_vline(xintercept = 0, linewidth = 1) +\n  scale_shape_manual(values = c(23, 15, 19), labels = c(\"Censoring\", \"Tumor recurrence\", \"Death\")) + \n  scale_x_continuous(\"Time (months)\", limits = c(0, 65), breaks = seq(0, 60, by = 12),\n                     expand= c(0, 0.5)) +\n  scale_y_discrete(\"Patients\") +\n  facet_wrap( ~ trt, scales = \"free\") +\n  theme_minimal() +\n  theme(\n    legend.position = \"top\",\n    legend.title = element_blank(),\n    panel.grid.minor.x = element_blank(),\n    axis.text.y = element_blank(),\n    axis.ticks.y = element_blank(),\n    panel.grid.major.y = element_blank()\n  )\n\nggsave(\"cmpr_blad_fu.pdf\",  width = 8, height = 8)\nggsave(\"cmpr_blad_fu.eps\",  width = 8, height = 8)\n\n\nid &lt;- bladder$id\ntime &lt;- bladder$time\nstatus &lt;- bladder$status\ntrt &lt;- bladder$trt\n\n# trt &lt;- ifelse(trt == 1,  \"Thiotepa\", \"Placebo\")\n\nobj &lt;- rccf(id,time,status,trt)\n\n\nstat=obj$stat\nS=obj$S\nu1=obj$u1\nu2=obj$u2\nt=obj$t\n\n\n# test on recurrent event\nQLR=stat[1]/sqrt(S[1,1])\npLR=1-pchisq(QLR^2,1)\n\n# test on death\nQD=stat[2]/sqrt(S[2,2])\npD=1-pchisq(QD^2,1)\n\n#joint test\nQ=t(stat)%*%solve(S)%*%stat\np=1-pchisq(Q,2)\n\npar(mfrow=c(1,2))\n\nfatal=bladder[status != 1,]\n\nobj=survfit(Surv(time,status &gt; 0)~trt,data=fatal)\nplot(obj,lty=c(1,3),frame=F,xlim=c(0,50),lwd=2,cex.lab=1.5,\n     cex.axis=1.5,xlab=\"Time (months)\",ylab=\"Survival probabilities\")\n# legend(0.82,2.8,c(\"Thiotepa\",\"Placebo\"),lty=c(1,3),cex=1.5,lwd=2)\ntext(35,0.14,paste0(\"Log-rank test: p=\",round(pD,3)),cex=1.2)\n\n#plot the mean functions\nstepmu1=stepfun(t,c(0,u1))\nstepmu2=stepfun(t,c(0,u2))\nplot(stepmu2,do.points=F,xlab=\"Time (months)\",ylab=\"Cumulative tumor frequency\",\n     xlim=c(0,60),ylim=c(0,3), main=\"\", frame=F,lwd=2,cex.lab=1.5,\n     cex.axis=1.5,lty=3)\nplot(stepmu1,add=T,lty=1,do.points=F,lwd=2)\n# legend(1,2.8,c(\"Thiotepa\",\"Placebo\"),lty=c(1,3),cex=1.5,lwd=2)\ntext(40,0.4,paste0(\"Ghosh-Lin test: p=\",round(pLR,3)),cex=1.2)\n\n# Ghosh-Lin proportional CF regression\nlibrary(mets)\n\n# create a start variable that is the event time of previous event\n# for each subject id\ndata(bladder)\ndf &lt;- bladder |&gt;\n  group_by(id) |&gt;\n  mutate(\n    start = lag(time, default = 0),\n    stop = if_else(time == 0, 1e-4, time)\n    ) |&gt; \n  select(\n    id, start, stop, status, trt\n  ) |&gt; as.data.frame()\n  \nobj_reg &lt;- recreg(Event(start, stop, status) ~ trt + cluster(id), \n                  cause = 1, death.code=2,\n                  data = df)\nsummary(obj_reg)"
  },
  {
    "objectID": "chap2.html#outline",
    "href": "chap2.html#outline",
    "title": "Applied Survival Analysis",
    "section": "Outline",
    "text": "Outline\n\nRandom variable and counting process notations\nLikelihood and score functions\nMartingale residuals and integrals \\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\]"
  },
  {
    "objectID": "chap2.html#outcome-event-notation",
    "href": "chap2.html#outcome-event-notation",
    "title": "Applied Survival Analysis",
    "section": "Outcome Event: Notation",
    "text": "Outcome Event: Notation\n\nTime to outcome event (latent, w.o. censoring): \\(T\\)\n\nCumulative distribution function (cdf): \\(F(t)={\\rm pr}(T\\leq t)\\)\nSurvival function: \\(S(t) = 1- F(t) = {\\rm pr}(T &gt; t)\\)\nDensity function: \\(f(t) = \\d F(t)/\\d t = - \\d S(t)/ \\d t\\)\n\nLeibniz notation\n\n\\(\\d F(t) = f(t)\\d t = \\pr(t \\leq T &lt; t + \\d t)\\): infinitesimal (marginal) event rate (i.e., incidence) over \\([t, t + \\d t)\\)"
  },
  {
    "objectID": "chap2.html#outcome-event-hazard-function",
    "href": "chap2.html#outcome-event-hazard-function",
    "title": "Applied Survival Analysis",
    "section": "Outcome Event: Hazard Function",
    "text": "Outcome Event: Hazard Function\n\nHazard rate: conditional incidence given at risk \\[\\lambda(t)\\dd t=\\pr(t\\leq T&lt;t+\\dd t\\mid T\\geq t)=\\frac{\\dd F(t)}{S(t-)}\\]\n\nSo \\(\\lambda(t) = f(t)/S(t-)\\)\n\nDensity vs hazard functions"
  },
  {
    "objectID": "chap2.html#outcome-event-distributions",
    "href": "chap2.html#outcome-event-distributions",
    "title": "Applied Survival Analysis",
    "section": "Outcome Event: Distributions",
    "text": "Outcome Event: Distributions\n\nRelationship\n\n\\(\\lambda(t)\\d t = - \\d S(t)/S(t -) = -\\d\\log S(t)\\)\n\\(S(t) = \\exp\\{-\\Lambda(t)\\}\\), where \\(\\Lambda(t)=\\int_0^t \\lambda(u)\\d u\\) (cumulative hazard)\n\nExamples\n\nExponential distribution: \\(\\lambda(t)\\equiv \\lambda &gt; 0\\), \\(S(t)=\\exp(-\\lambda t)\\)\n\nConstant risk, also “memoryless”: \\(\\pr(T &gt; t + u\\mid T &gt; t) = \\pr(T &gt; u)\\)\n\nWeibull distribution: \\(\\lambda(t;\\alpha,\\gamma)=\\alpha\\gamma^{-\\alpha} t^{\\alpha-1}\\) with \\(\\gamma, \\alpha&gt;0\\)\n\n\\(0 &lt; \\alpha &lt; 1\\): risk \\(\\downarrow\\) (infant mortality)\n\\(\\alpha &gt; 1\\): risk \\(\\uparrow\\) (aging effect)\n\\(\\alpha = 1\\): Exponential (constant risk)\n\\(\\gamma\\): scale parameter such that \\(E(T)\\propto \\gamma\\)"
  },
  {
    "objectID": "chap2.html#outcome-event-the-weibull",
    "href": "chap2.html#outcome-event-the-weibull",
    "title": "Applied Survival Analysis",
    "section": "Outcome Event: The Weibull",
    "text": "Outcome Event: The Weibull\n\nWeibull\\((\\alpha, \\gamma)\\)"
  },
  {
    "objectID": "chap2.html#outcome-event-counting-process",
    "href": "chap2.html#outcome-event-counting-process",
    "title": "Applied Survival Analysis",
    "section": "Outcome Event: Counting Process",
    "text": "Outcome Event: Counting Process\n\nDefinition\n\n\\(N^*(t)=I(T\\leq t)\\): number of event (0 or 1) by \\(t\\) (cumulative)\n\\(\\d N^*(t)=N^*(t) - N^*(t-) = I (T=t)\\): number of event at \\(t\\) (incident)  \\[E\\{N^*(t)\\} = F(t),\\,\\,\\, E\\{\\d N^*(t)\\} = \\d F(t)\\] \\[E\\{\\d N^*(t)\\mid N^*(t -) = 0\\} = E\\{\\d N^*(t)\\mid T\\geq t\\}=\\d\\Lambda(t)\\]"
  },
  {
    "objectID": "chap2.html#observed-data",
    "href": "chap2.html#observed-data",
    "title": "Applied Survival Analysis",
    "section": "Observed Data",
    "text": "Observed Data\n\nObserved data: \\((X, \\delta)\\)\n\n\\(X = T\\wedge C\\): duration of follow-up (time variable) \\((a\\wedge b = \\min(a, b))\\)\n\\(\\delta = I(T\\leq C)\\): event indicator (status variable)\n\\(C\\): (right) censoring time\n\nObserved counting process\n\n\\(N(t) = I(X\\leq t, \\delta = 1)\\)\nSo \\(\\d N(t) = \\d N^*(t)I(C\\geq t)\\)\n\nIndependent censoring assumption\n\n\\[C\\indep T\\]"
  },
  {
    "objectID": "chap2.html#likelihood-function",
    "href": "chap2.html#likelihood-function",
    "title": "Applied Survival Analysis",
    "section": "Likelihood Function",
    "text": "Likelihood Function\n\nLikelihood on a single subject \\[p(X, \\delta)\\propto f(X)^\\delta S(X)^{1-\\delta}=\\lambda(X)^\\delta S(X)\\]\nLog-likelihood on a random \\(n\\)-sample\n\nUnder a model with parameter \\(\\theta\\): \\(\\lambda(t) = \\lambda(t; \\theta)\\), \\(\\Lambda(t) = \\Lambda(t; \\theta)\\) \\[\\begin{align}\nl_n(\\theta)&= n^{-1}\\sum_{i=1}^n\\log p(X_i, \\delta_i)\\\\\n&=n^{-1}\\sum_{i=1}^n\\left\\{\\delta_i\\log\\lambda(X_i;\\theta) -\\Lambda(X_i;\\theta)\\right\\}\\\\\n&= n^{-1}\\sum_{i=1}^n\\left\\{\\delta_i\\log\\lambda(X_i;\\theta)-\\int_0^\\infty I(X_i\\geq t) \\lambda(t;\\theta)\\dd t\\right\\}\n\\end{align}\\]"
  },
  {
    "objectID": "chap2.html#score-function",
    "href": "chap2.html#score-function",
    "title": "Applied Survival Analysis",
    "section": "Score Function",
    "text": "Score Function\n\nScore function \\[\\frac{\\partial}{\\partial\\theta} l_n(\\theta)=n^{-1}\\sum_{i=1}^n \\left\\{\\delta_ih(X_i;\\theta)-\\int_0^\\infty h(t;\\theta) I(X_i\\geq t)\\lambda(t;\\theta)\\dd t\\right\\}\\]\n\nwhere \\(h(t;\\theta)=\\frac{\\partial}{\\partial\\theta}\\log\\lambda(t;\\theta)\\) (hazard score function)\nSolve \\(\\frac{\\partial}{\\partial\\theta} l_n(\\hat\\theta)=0\\) to obtain maximum likelihood estimator (MLE) \\(\\hat\\theta\\)\n\nExample: exponential distribution \\(\\lambda(t; \\theta) = \\lambda\\)\n\n\\(h(t;\\theta) =\\lambda^{-1}\\)\nClosed-form solution (Newton-Raphson algorithm in general) \\[\\hat\\lambda=\\frac{\\sum_{i=1}^n\\delta_i}{\\sum_{i=1}^n X_i}\\]"
  },
  {
    "objectID": "chap2.html#stochastic-integration",
    "href": "chap2.html#stochastic-integration",
    "title": "Applied Survival Analysis",
    "section": "Stochastic Integration",
    "text": "Stochastic Integration\n\nTransformation of \\(T\\) by some \\(h(\\cdot)\\)\n\n\\(h(T)\\) if \\(T\\) is observed to lie in \\([0, t]\\)\n0 otherwise\nI.e., \\(\\delta I(X\\leq t) h(X)\\)\n\nCompact notation \\[\\delta I(X\\leq t) h(X) = \\int_0^t h(u)\\dd N(u)\\]\n\n\\(\\dd N(u) = 1\\) only if \\(\\delta = 1\\) and \\(T= u\\in[0, t]\\)\n\\(\\dd N(u) \\equiv 0\\) otherwise"
  },
  {
    "objectID": "chap2.html#stochastic-integration-examples",
    "href": "chap2.html#stochastic-integration-examples",
    "title": "Applied Survival Analysis",
    "section": "Stochastic Integration: Examples",
    "text": "Stochastic Integration: Examples\n\nLog-likelihood \\[\nl_n(\\theta)=n^{-1}\\sum_{i=1}^n\\left\\{\\int_0^\\infty \\log\\lambda(t;\\theta)\\dd N_i(t)-\\int_0^\\infty I(X_i\\geq t)\\lambda(t;\\theta)\\dd t\\right\\}\n\\]\n\n\\(N_i(t)= I(X_i\\leq t, \\delta_i =1)\\), i.e., \\(N(t)\\) on subject \\(i\\)\n\nScore (subject-level) \\[\n\\begin{align}\n\\dot l(\\theta)&=\\int_0^\\infty h(t;\\theta)\\dd N(t)-\\int_0^\\infty h(t;\\theta) I(X\\geq t)\\dd\\Lambda(t;\\theta)\\\\\n&=\\int_0^\\infty h(t;\\theta)\\left\\{\\dd N(t)-I(X\\geq t)\\dd\\Lambda(t;\\theta)\\right\\}\n\\end{align}\n\\]"
  },
  {
    "objectID": "chap2.html#martingale-definition",
    "href": "chap2.html#martingale-definition",
    "title": "Applied Survival Analysis",
    "section": "Martingale: Definition",
    "text": "Martingale: Definition\n\nScore re-expression \\[\\dot l(\\theta) = \\int_0^\\infty h(t;\\theta)\\dd M(t;\\ \\theta)\\]\n\n\\(\\dd M(t;\\theta)=\\dd N(t) - I(X\\geq t)\\dd\\Lambda(t;\\theta)\\)\n\nGeneral martingale residual \\[\n\\begin{align}\n  \\dd M(t)&=\\dd N(t) - I(X\\geq t)\\dd\\Lambda(t)\\\\\n      &= \\dd N(t) - E\\{\\dd N(t)\\mid\\mbox{Data prior to }t\\}\n\\end{align}\n\\]\n\nSo \\(E\\{\\dd M(t)\\mid\\mbox{Data prior to }t\\}=0\\)"
  },
  {
    "objectID": "chap2.html#martingale-construction",
    "href": "chap2.html#martingale-construction",
    "title": "Applied Survival Analysis",
    "section": "Martingale: Construction",
    "text": "Martingale: Construction\n\nData observed up to \\(t\\) \\[\n\\mathcal H(t) =\\{N(u), N_C(u):0\\leq u\\leq t\\}\n\\]\n\n\\(N_C(u) = I(X\\leq u, \\delta = 0)\\): censoring process\n\n\\(\\mathcal H(t-) =\\) Data prior to \\(t\\)\n\nShow \\[E\\{\\dd N(t)\\mid\\mathcal H(t-)\\} = I(X\\geq t)\\dd\\Lambda(t)\\]\n\nHow can the past influence the current incidence (risk)?\nOnly through the at-risk status \\({X\\geq t}\\)"
  },
  {
    "objectID": "chap2.html#martingale-derivation",
    "href": "chap2.html#martingale-derivation",
    "title": "Applied Survival Analysis",
    "section": "Martingale: Derivation",
    "text": "Martingale: Derivation\n\nTwo scenarios: not-at-risk \\((X &lt; t)\\) vs at-risk \\((X\\geq t)\\) \\[\n\\begin{align}\nE\\{\\dd N(t)\\mid\\mathcal H(t-)\\}&=I(X&lt;t)E\\{\\dd N(t)\\mid X&lt;t, \\mathcal H(t-)\\}\\notag\\\\\n&\\hspace{15mm}+I(X\\geq t)E\\{\\dd N(t)\\mid X\\geq t, \\mathcal H(t-)\\}\\notag\\\\\n& = 0 + I(X\\geq t)E\\{\\dd N(t)\\mid X\\geq t\\}\\notag\\\\\n&=I(X\\geq t)\\frac{\\pr\\{\\dd N^*(t)=1, C\\geq t\\}}{\\pr(T\\geq t, C\\geq t)}\n\\notag\\\\\n&=I(X\\geq t)E\\{\\dd N^*(t)\\mid T\\geq t\\}\\notag\\\\\n&=I(X\\geq t)\\dd\\Lambda(t),\n\\end{align}\n\\]\n\nQuestion: why is the 4th equality true?"
  },
  {
    "objectID": "chap2.html#martingale-properties",
    "href": "chap2.html#martingale-properties",
    "title": "Applied Survival Analysis",
    "section": "Martingale: Properties",
    "text": "Martingale: Properties\n\nInterpretation \\[\\underbrace{\\dd M(t)}_{\\mbox{residual}}\n=\\underbrace{\\dd N(t)}_{\\mbox{observed response}} - \\underbrace{I(X\\geq t)\\dd\\Lambda(t)}_{\\mbox{systematic part}}\\]\nConditional mean & variance \\[\nE\\{\\dd M(t)\\mid\\mathcal H(t-)\\}=0,\\,\\,\\,\nE\\{\\dd M(t)^2\\mid\\mathcal H(t-)\\}=I(X\\geq t)\\dd\\Lambda(t)\n\\]\nUncorrelated increments (UCI) (for \\(t&lt;s\\)) \\[\nE\\{\\dd M(t)\\dd M(s)\\}=E\\left[\\dd M(t)E\\{\\dd M(s)\\mid\\mathcal H(s-)\\}\\right]\n=0\n\\]"
  },
  {
    "objectID": "chap2.html#martingale-integral",
    "href": "chap2.html#martingale-integral",
    "title": "Applied Survival Analysis",
    "section": "Martingale Integral",
    "text": "Martingale Integral\n\nCentered statistics take the form \\[\n\\sum_{i=1}^n\\int_0^t h(u)\\dd M_i(u)\n\\]\n\nWeighted sum of the \\(\\dd M_i(u)\\)\n\n\n\n\n\n\n\n\nMean and variance of martingale integral\n\n\n\\[E\\left\\{\\int_0^t h(u)\\dd M(u)\\right\\}=\\int_0^t h(u)E\\left\\{\\dd M(u)\\right\\}=0\\]\n\\[\n\\begin{align}\nE\\left\\{\\int_0^t h(u)\\dd M(u)\\right\\}^2 \\stackrel{\\mbox{UCI}}{=}\\int_0^t h(u)^2E\\left\\{\\dd M(u)^2\\right\\}\n=\\int_0^t h(u)^2\\pr(X\\geq u)\\dd\\Lambda(u)\n\\end{align}\n\\]"
  },
  {
    "objectID": "chap2.html#martingale-integral-example",
    "href": "chap2.html#martingale-integral-example",
    "title": "Applied Survival Analysis",
    "section": "Martingale Integral: Example",
    "text": "Martingale Integral: Example\n\nScore function \\[\n\\dot l(\\theta) = \\int_0^\\infty h(t;\\theta)\\dd M(t; \\theta)\n\\]\n\nInformation \\[\n\\mathcal I(\\theta) = E\\{\\dot l(\\theta)^2\\} =\n\\int_0^\\infty h(t;\\theta)^2\\pr(X\\geq t)\\dd\\Lambda(t;\\theta)\n\\]\n\nExample: exponential distribution \\(h(t;\\theta)=\\lambda^{-1}\\) \\[\n\\mathcal I(\\theta) = \\int_0^\\infty \\lambda^{-2}\\pr(X\\geq t)\\lambda\\dd t=\n\\lambda^{-1}\\int_0^\\infty\\pr(X\\geq t)\\dd t\n\\]\n\nCompare with standard one by taking negative quadrature of log-likelihood"
  },
  {
    "objectID": "chap2.html#notes",
    "href": "chap2.html#notes",
    "title": "Applied Survival Analysis",
    "section": "Notes",
    "text": "Notes\n\nMore parametric families in KP (2002) and KM (2003)\n\n(Inverse) Gamma; Log-normal/logistic; Gompertz; Generalized \\(F\\)\nNotes of textbook\n\nMartingale first introduced in survival analysis by O. O. Aalen (1975, 1978)\n\nSimplifies derivation of statistical properties\nIntegrand \\(h(u)\\) can depend on \\(\\mathcal H(u-)\\)\nLess useful with multivariate outcomes (correlated increments)\n\nCurrent risk depends on past in complex ways"
  },
  {
    "objectID": "chap2.html#summary-i",
    "href": "chap2.html#summary-i",
    "title": "Applied Survival Analysis",
    "section": "Summary (I)",
    "text": "Summary (I)\n\nNotation\n\nOutcome data: \\(T\\)\nObserved data: \\(𝑋=𝑇∧𝐶\\) (time), \\(𝛿=𝐼(𝑇≤𝐶)\\) (status)\nCounting process: \\(𝑁(𝑡)=𝐼(𝑋≤𝑡,𝛿=1)\\)\nCounting process integral \\[\\delta I(X\\leq t) h(X) = \\int_0^t h(u)\\dd N(u)\\]\n\nMartingale residual \\[\\underbrace{\\dd M(t)}_{\\mbox{residual}}\n=\\underbrace{\\dd N(t)}_{\\mbox{observed response}} - \\underbrace{I(X\\geq t)\\dd\\Lambda(t)}_{\\mbox{systematic part}}\\]"
  },
  {
    "objectID": "chap2.html#summary-ii",
    "href": "chap2.html#summary-ii",
    "title": "Applied Survival Analysis",
    "section": "Summary (II)",
    "text": "Summary (II)\n\nMartingale integral (e.g., score function) \\[\n\\int_0^t h(u)\\dd M(u)=\\int_0^t h(u)\\left\\{\\dd N(u)-I(X\\geq u)\\dd\\Lambda(u)\\right\\}\n\\]\n\nMean zero with easily computable variance"
  },
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "Syllabus",
    "section": "",
    "text": "Overview\nThis course surveys modern statistical methods for analyzing censored time-to-event data in clinical, epidemiological, sociological, and engineering studies. We provide intuitive explanations of statistical theory, such as counting-process martingale, to address real-world problems and build problem-solving skills. The course combines methodological exposition with extensive case studies, primarily from health sciences research (sample R/SAS code will be provided). The focus is on the application of data analysis and study design.\n\n\nCourse Structure\nThe course consists of three parts. The first part covers methods for univariate event times, e.g., Kaplan–Meier curve, log-rank test, and Cox proportional hazards model. The second part extends to complex outcomes such as recurrent events, multivariate events, (semi-)competing risks, joint survival and longitudinal data analysis, multistate data, and composite endpoints. The third part explores cutting-edge topics, including causal inference and machine learning for censored data.\n\n\nLearning Outcomes\nStudents will:\n\nUnderstand the features of censored data and their impact on statistical inference.\nSelect appropriate non- and semi-parametric methods for various data types.\nEvaluate and verify assumptions for estimation and inference.\nApply statistical procedures to solve real-world problems using R (or SAS).\nClearly interpret and present analytical results to address substantive questions.\n\n\n\nPrerequisites\nStudents should have foundational knowledge in random variables, expectation, variance, and maximum likelihood estimation, as well as introductory courses in hypothesis testing (e.g., t-test, ANOVA) and (generalized) linear regression models. Prior experience with R or SAS is helpful but not required.\n\n\nTime and Location\nMW 2:35–3:45pm; Clinical Sciences Center (CSC) - Room G5/119\n\nNote: Classes on 1/27 and 4/28 will be held in HSLC 1220.\n\n\n\nInstructors\n\nMain Instructor\nLu Mao, PhD (https://lmaowisc.github.io)\nWARF 207A, 610 Walnut St, Madison, WI 53726\nEmail: lmao@biostat.wisc.edu\nPhone: 608-263-5674\nOffice Hours: T&Th 3–4pm, or by appointment.\nZoom link provided on Canvas.\n\n\nTeaching Assistant\nYunhong Wu\nEmail: wu292@wisc.edu\nOffice Hours: MW 1-2pm, or by appointment.\nZoom link provided on Canvas.\n\n\n\nReadings\n\n[Required] Applied Survival Analysis: From Univariate to Complex Time-to-Event Outcomes (Posted on Canvas by chapter)\n[For Methodological Insight] Kalbfleisch, J. D. & Prentice, R. L. (2002). The Statistical Analysis of Failure Time Data (2nd Ed). John Wiley & Sons.\n[For Applied Focus] Klein, J. P. & Moeschberger, M. L. (2003). Survival Analysis: Techniques for Censored and Truncated Data (2nd Ed). Springer.\n[For Theoretical Depth] Fleming, T. R. & Harrington, D. P. (1991). Counting Processes and Survival Analysis. John Wiley & Sons.\n\n\n\nCourse Schedule\n\nKickoff\n\n\n\nDate\nTopic\nNotes\n\n\n\n\n1/22\nLecture\nOverview\n\n\n\nReading\nSyllabus\n\n\n\n\n\nPart I: Univariate Events\n\n\n\n\n\n\n\n\nDate\nTopic\nNotes\n\n\n\n\n1/27\nIntroduction\nChapter 1\n\n\n1/29\nMathematical Foundations\nChapter 2\n\n\n2/3\nNonparametric Estimation of the Survival Curve\nChapter 3\n\n\n2/5\nComparing Survival Rates Between Groups\nChapter 3\n\n\n2/10\nCox Proportional Hazards Model – Assumptions and Inference\nChapter 4\n\n\n2/12\nCox Proportional Hazards Model – Residual Analysis\nChapter 4\n\n\n2/17\nCox Proportional Hazards Model – Time-Varying Covariates\nChapter 4\n\n\n2/19\nOther Non- and Semi-parametric Methods\nChapter 5\n\n\n2/24\nStudy Design and Sample Size Calculation\nChapter 6\n\n\n2/26\nLeft Truncation\nChapter 7\n\n\n3/3\nInterval Censoring\nChapter 7\n\n\n\n\n\nPart II: Complex Outcomes\n\n\n\n\n\n\n\n\nDate\nTopic\nNotes\n\n\n\n\n3/5\nMultivariate Events – Conditional (Frailty) Models\nChapter 8\n\n\n3/10\nMultivariate Event Times – Marginal Models\nChapter 8\n\n\n3/12\nRecurrent Events\nChapter 9\n\n\n3/17\nCompeting and Semi-competing Risks\nChapter 10\n\n\n3/31\nJoint Analysis of Longitudinal and Survival Data\nChapter 11\n\n\n4/2\nMultistate Models – Introduction\nChapter 12\n\n\n4/7\nMultistate Models – Cox-Type Markov and Semi-Markov Models\nChapter 12\n\n\n4/9\nComposite Endpoints – Nonparametric Estimation\nChapter 13\n\n\n4/14\nComposite Endpoints – Semiparametric Regression\nChapter 13\n\n\n\n\n\nPart III: Special Topics\n\n\n\n\n\n\n\n\nDate\nTopic\nNotes\n\n\n\n\n4/16\nCausal Inference with Censored Data – IPTW and Standardization\nChapter 14\n\n\n4/21\nCausal Inference with Censored Data – Marginal Structural Models\nChapter 14\n\n\n4/23\nMachine Learning with Censored Data – Variable Selection\nChapter 15\n\n\n4/28\nMachine Learning with Censored Data – Nonlinear Regression\nChapter 15\n\n\n4/30\nGuest Lecture or recap\n\n\n\n\n\n\n\nHomework and Exams\n\nHomework: Biweekly.\nIn-class: quizzes\nMid-term project.\nFinal data analysis project.\n\n\n\nGrading\n\n20% Attendance and in-class quizzes\n\n35% Homework\n\n20% Mid-term\n\n25% Final project"
  },
  {
    "objectID": "chap1.html#outline",
    "href": "chap1.html#outline",
    "title": "Applied Survival Analysis",
    "section": "Outline",
    "text": "Outline\n\nTime-to-event data and examples\nCensoring mechanisms and implications\nSummarizing the raw data\n\n\\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\]"
  },
  {
    "objectID": "chap1.html#what-are-time-to-event-data",
    "href": "chap1.html#what-are-time-to-event-data",
    "title": "Applied Survival Analysis",
    "section": "What are time-to-event data?",
    "text": "What are time-to-event data?\n\nCommon outcome type in medical studies\n\nStarting point: Randomization, study entry, birth, etc.\nEndpoint: Death, hospitalization, disease onset, etc.\nIn engineering: Machine failure times (reliability analysis)\n\nRight censoring\n\nEvent does not occur by study end or dropout\n\nOnly know event time \\(&gt;\\) censoring time\n\nSurvival analysis: Statistical methods for censored data"
  },
  {
    "objectID": "chap1.html#example-univariate-event-i",
    "href": "chap1.html#example-univariate-event-i",
    "title": "Applied Survival Analysis",
    "section": "Example: Univariate event (I)",
    "text": "Example: Univariate event (I)\n\nGerman Breast Cancer (GBC) Study\n\nPopulation: 686 patients with node-positive breast cancer\n\nObjective: Assess if tamoxifen + chemo reduces mortality\n\nBaseline info: Age, tumor size, hormone levels, menopausal status, etc.\n\nFollow-up: Median 44 months\n\n171 deaths \\(\\to\\) exact times known\n\n515 censored \\(\\to\\) survival time \\(&gt;\\) censoring time"
  },
  {
    "objectID": "chap1.html#example-univariate-event-ii",
    "href": "chap1.html#example-univariate-event-ii",
    "title": "Applied Survival Analysis",
    "section": "Example: Univariate event (II)",
    "text": "Example: Univariate event (II)\n\nGerman Breast Cancer (GBC) Study"
  },
  {
    "objectID": "chap1.html#example-recurrent-events-i",
    "href": "chap1.html#example-recurrent-events-i",
    "title": "Applied Survival Analysis",
    "section": "Example: Recurrent events (I)",
    "text": "Example: Recurrent events (I)\n\nChronic Granulomatous Disease (CGD) Study\n\nPopulation: 128 patients in a randomized placebo-controlled trial\n\nObjective: Assess gamma interferon effect on recurrent infections\n\nFollow-up: Median 293 days\n\nInfections: Min = 0, Max = 7\n\n\nChallenge: Correlated events within individuals\nData in “long” format (multiple records per patient)"
  },
  {
    "objectID": "chap1.html#example-recurrent-events-ii",
    "href": "chap1.html#example-recurrent-events-ii",
    "title": "Applied Survival Analysis",
    "section": "Example: Recurrent events (II)",
    "text": "Example: Recurrent events (II)\n\nChronic Granulomatous Disease (CGD) Study"
  },
  {
    "objectID": "chap1.html#example-multivariateclustered-events-i",
    "href": "chap1.html#example-multivariateclustered-events-i",
    "title": "Applied Survival Analysis",
    "section": "Example: Multivariate/Clustered Events (I)",
    "text": "Example: Multivariate/Clustered Events (I)\n\nDiabetic Retinopathy Study\n\nPopulation: 197 high-risk diabetic patients in a randomized controlled trial\nObjective: Determine if photocoagulation (a laser treatment) delays blindness onset\nDesign: One eye treated (by either xenon or argon), the other untreated (control)\nChallenge: Correlation between eyes"
  },
  {
    "objectID": "chap1.html#example-multivariateclustered-events-ii",
    "href": "chap1.html#example-multivariateclustered-events-ii",
    "title": "Applied Survival Analysis",
    "section": "Example: Multivariate/Clustered Events (II)",
    "text": "Example: Multivariate/Clustered Events (II)\n\nDiabetic Retinopathy Study"
  },
  {
    "objectID": "chap1.html#example-competing-risks-i",
    "href": "chap1.html#example-competing-risks-i",
    "title": "Applied Survival Analysis",
    "section": "Example: Competing Risks (I)",
    "text": "Example: Competing Risks (I)\n\nDefinition: Multiple types of events where one prevents the occurrence of the others\n\nNatural example: different causes of death\n\nCompeting risk vs censoring:\n\nBoth terminate follow-up\nCompeting risk: part of the outcome; inference based on its presence\nCensoring: irrelevant to outcome; inference based on its absence\n\nExample: death from prostate cancer as main outcome\n\nDeath from other (metastasized) cancers \\(\\to\\) competing risk\nDeath from traffic accidents \\(\\to\\) censoring"
  },
  {
    "objectID": "chap1.html#example-competing-risks-ii",
    "href": "chap1.html#example-competing-risks-ii",
    "title": "Applied Survival Analysis",
    "section": "Example: Competing Risks (II)",
    "text": "Example: Competing Risks (II)\n\nBone Marrow Transplant Study\n\npopulation: 864 multiple-myeloma leukemia patients undergoing allogeneic haematopoietic cell transplantation (HCT)\nObjective: Evaluate risk factors for treatment-related mortality (TRM) and relapse of leukemia\nCompeting risks: TRM defined as death in remission (i.e., before relapse); thus is precluded by relapse\nRisk factors: cohort indicator (years 1995–2000 or 2001–2005), type of donor (unrelated or identical sibling), history of a prior transplant, time from diagnosis to transplantation (&lt;24 months, or ≥ 24 months)"
  },
  {
    "objectID": "chap1.html#example-competing-risks-iii",
    "href": "chap1.html#example-competing-risks-iii",
    "title": "Applied Survival Analysis",
    "section": "Example: Competing Risks (III)",
    "text": "Example: Competing Risks (III)\n\nBone Marrow Transplant Study\n\nWhy only one record per patient?"
  },
  {
    "objectID": "chap1.html#example-more-complex-outcomes-semi-competing-risks",
    "href": "chap1.html#example-more-complex-outcomes-semi-competing-risks",
    "title": "Applied Survival Analysis",
    "section": "Example: More Complex Outcomes (Semi-competing risks)",
    "text": "Example: More Complex Outcomes (Semi-competing risks)\n\nGerman Breast Cancer (GBC) Study\n\nNonfatal event + terminal event (death)"
  },
  {
    "objectID": "chap1.html#example-more-complex-outcomes-with-longitudinal-data",
    "href": "chap1.html#example-more-complex-outcomes-with-longitudinal-data",
    "title": "Applied Survival Analysis",
    "section": "Example: More Complex Outcomes (with Longitudinal data)",
    "text": "Example: More Complex Outcomes (with Longitudinal data)\n\nAnti-Retroviral Drug Trial\n\nRepeated measures of CD4 cell count + death"
  },
  {
    "objectID": "chap1.html#example-more-complex-outcomes-multistate-process",
    "href": "chap1.html#example-more-complex-outcomes-multistate-process",
    "title": "Applied Survival Analysis",
    "section": "Example: More Complex Outcomes (Multistate process)",
    "text": "Example: More Complex Outcomes (Multistate process)\n\nBreast Cancer Life History Study\n\nRemission \\(\\to\\) relapse \\(\\to\\) metastasis \\(\\to\\) death (can skip states)"
  },
  {
    "objectID": "chap1.html#example-composite-endpointsi",
    "href": "chap1.html#example-composite-endpointsi",
    "title": "Applied Survival Analysis",
    "section": "Example: Composite Endpoints(I)",
    "text": "Example: Composite Endpoints(I)\n\nComposite endpoint: one with multiple components\n\nRecurrent/multivariate events\n(Semi-)Competing risks\nLongitudinal measurements\nMultistate processes\n\nAnalysis of complex outcomes\n\nMarginal approach: models components separately\nConditional approach: models components jointly\nComposite approach: combines components\n\nProgression/relapse-free survival (time to the earlier of progression/relapse or death)"
  },
  {
    "objectID": "chap1.html#example-composite-endpointsii",
    "href": "chap1.html#example-composite-endpointsii",
    "title": "Applied Survival Analysis",
    "section": "Example: Composite Endpoints(II)",
    "text": "Example: Composite Endpoints(II)\n\nAdvantages:\n\nConcentrates information \\(\\to\\) Statistical efficiency\nNo need for multiple testing adjustment\nA single measure of overall effect size\n\nPreferred for primary analysis of Phase-III clinical trials by\n\nUS Food and Drug Administration (FDA)\nICH (International Council for Harmonisation for pharmaceuticals)\n\nChallenges:\n\nStatistical efficiency (e.g., beyond first event)\nScientific relevance (e.g., relative importance of components)"
  },
  {
    "objectID": "chap1.html#censoring-mechanisms",
    "href": "chap1.html#censoring-mechanisms",
    "title": "Applied Survival Analysis",
    "section": "Censoring Mechanisms",
    "text": "Censoring Mechanisms\n\nTwo mechanisms\n\nStudy termination (administrative censoring)\nLoss to follow-up (LTFU, e.g., withdrawal, death from other causes)\n\n\n\n\n\n\n\n\nCaution about censoring\n\n\n\nEvent/censoring time \\(=\\) time from starting point (e.g., randomization) to event/censoring (as opposed to time on the calendar)\nLTFU may not be independent of outcome (e.g., sicker patients withdraw early)\nCollect withdrawal reasons if possible\nCensoring or competing risk? \\(\\leftarrow\\) Domain knowledge"
  },
  {
    "objectID": "chap1.html#censoring-mechanisms-illustration",
    "href": "chap1.html#censoring-mechanisms-illustration",
    "title": "Applied Survival Analysis",
    "section": "Censoring Mechanisms: Illustration",
    "text": "Censoring Mechanisms: Illustration\n\nCalendar time vs time synchronized by starting point"
  },
  {
    "objectID": "chap1.html#statistical-implications-i",
    "href": "chap1.html#statistical-implications-i",
    "title": "Applied Survival Analysis",
    "section": "Statistical Implications (I)",
    "text": "Statistical Implications (I)\n\nCensored observation\n\nNot completely missing!\nPartial information: event time \\(&gt;\\) censoring time\nIgnoring partial information \\(\\to\\) Bias in inference\n\nNaive approaches\n\nTreat censoring as event \\(\\to\\) Underestimates time to event\nExclude censored observations \\(\\to\\) Underestimates time to event (longer event times more likely censored)"
  },
  {
    "objectID": "chap1.html#statistical-implications-ii",
    "href": "chap1.html#statistical-implications-ii",
    "title": "Applied Survival Analysis",
    "section": "Statistical Implications (II)",
    "text": "Statistical Implications (II)\n\nNotation\n\n\\(T\\): Outcome event time\n\\(C\\): Censoring time\nObserved data: \\(X=\\min(T, C)\\), \\(\\delta = I(T\\leq C)\\)\n\n(𝑋, 𝛿) = (time, status) in previous data examples\n\n\nEstimation\n\nIndependent censoring assumption\n\n\\[ C \\indep T\\]\n\nEstimand: \\(S(t)={\\rm pr}(T &gt; t)\\), i.e., probability of subject “surviving” to time \\(t\\), using a random sample of \\((X_i, \\delta_i)\\) \\((i=1,\\ldots, n)\\)"
  },
  {
    "objectID": "chap1.html#statistical-implications-iii",
    "href": "chap1.html#statistical-implications-iii",
    "title": "Applied Survival Analysis",
    "section": "Statistical Implications (III)",
    "text": "Statistical Implications (III)\n\nNaive methods\n\nEvent-imputation empirical survival function: \\[\\hat S_{\\rm imp}(t)=n^{-1}\\sum_{i=1}^n I(X_i &gt; t) \\to {\\rm pr}(X &gt; t)\\leq S(t)\\]\nComplete-case empirical survival function: \\[\\hat S_{\\rm cc}(t)=\\frac{\\sum_{i=1}^n I(X_i &gt; t, \\delta_i = 1)}{\\sum_{i=1}^n\\delta_i}\n  \\to {\\rm pr}(T &gt; t\\mid T\\leq C)\\leq S(t)\\]\nBoth naïve methods underestimate the true survival function"
  },
  {
    "objectID": "chap1.html#statistical-implications-example",
    "href": "chap1.html#statistical-implications-example",
    "title": "Applied Survival Analysis",
    "section": "Statistical Implications: Example",
    "text": "Statistical Implications: Example\n\nGerman Breast Cancer (GBC) Study"
  },
  {
    "objectID": "chap1.html#importance-of-descriptive-analysis",
    "href": "chap1.html#importance-of-descriptive-analysis",
    "title": "Applied Survival Analysis",
    "section": "Importance of Descriptive Analysis",
    "text": "Importance of Descriptive Analysis\n\nStatistical models rely more or less on assumptions\nGood practice to summarize data descriptively as first step\n\nGet to know the data\nInforms subsequent analysis\nCheck balance of baseline characteristics between randomized arms\n“Table 1” in medical research papers\n\nTwo types of summary statistics\n\nSubject-level characteristics (baseline variables, number of events per subject)\nEvent rates (over aggregate length of follow-up)"
  },
  {
    "objectID": "chap1.html#how-to-calculate-event-rate-i",
    "href": "chap1.html#how-to-calculate-event-rate-i",
    "title": "Applied Survival Analysis",
    "section": "How to Calculate Event Rate (I)",
    "text": "How to Calculate Event Rate (I)\n\nLength of follow-up is event-specific\n\nIf an event is “non-recurrent”, its occurrence means patient is no longer at risk for it\n\n\n\n\n\n\n\n\n\n\n\n\n\nNote\n\n\nDenominator is called person-year (or person-time) of follow-up."
  },
  {
    "objectID": "chap1.html#how-to-calculate-event-rate-ii",
    "href": "chap1.html#how-to-calculate-event-rate-ii",
    "title": "Applied Survival Analysis",
    "section": "How to Calculate Event Rate (II)",
    "text": "How to Calculate Event Rate (II)\n\nSemi-competing risks"
  },
  {
    "objectID": "chap1.html#how-to-calculate-event-rate-iii",
    "href": "chap1.html#how-to-calculate-event-rate-iii",
    "title": "Applied Survival Analysis",
    "section": "How to Calculate Event Rate (III)",
    "text": "How to Calculate Event Rate (III)\n\nRecurrent events"
  },
  {
    "objectID": "chap1.html#table-one-example",
    "href": "chap1.html#table-one-example",
    "title": "Applied Survival Analysis",
    "section": "Table One: Example",
    "text": "Table One: Example"
  },
  {
    "objectID": "chap1.html#chapter-summary",
    "href": "chap1.html#chapter-summary",
    "title": "Applied Survival Analysis",
    "section": "Chapter Summary",
    "text": "Chapter Summary\n\nTypes of time-to-event outcomes\n\nUnivariate, recurrent, multivariate/clustered, (semi-)competing risks, repeated measures, multistate processes, and everything in between…\n\nCommon feature: censoring\n\nArises if study ends or patient drops out prior to event\nMust be handled with care to avoid false conclusion\n\nImportance of descriptive analysis\n\nEvent rate \\(\\to\\) attention to denominator"
  },
  {
    "objectID": "chap1.html#hw1-due-feb-5",
    "href": "chap1.html#hw1-due-feb-5",
    "title": "Applied Survival Analysis",
    "section": "HW1 (Due Feb 5)",
    "text": "HW1 (Due Feb 5)\n\nChoose one\n\nProblem 1.1 (Recommended for PhD in Stats/BDS)\nProblem 1.2\n\nProblem 1.8 (Attach you annotated code)\n(Extra credit) Problem 1.3"
  },
  {
    "objectID": "chap1.html#guidelines-for-hw",
    "href": "chap1.html#guidelines-for-hw",
    "title": "Applied Survival Analysis",
    "section": "Guidelines for HW",
    "text": "Guidelines for HW\n\nPresent a readable and coherent text to report your methods and results\n\nInclude numerical/graphical results only if they contribute to your narrative\nAll tables and figures should be properly titled/captioned, with informative labels/legends\nUse full names instead of abbreviations/acronyms\n\nE.g., “meno” \\(\\to\\) “Menopause (yes v no)”; “est” \\(\\to\\) “Estrogen (fmol/mg)”\n\nSpecify the unit of variable, e.g., “Age (years)”\nSee Table 1.11 and Fig. 1.2 for examples\n\nAppend the full code for diagnostic purposes"
  },
  {
    "objectID": "chapter1.html",
    "href": "chapter1.html",
    "title": "Chapter 1 - Introduction",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 1 - Introduction"
    ]
  },
  {
    "objectID": "chapter1.html#slides",
    "href": "chapter1.html#slides",
    "title": "Chapter 1 - Introduction",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 1 - Introduction"
    ]
  },
  {
    "objectID": "chapter1.html#chapter-summary",
    "href": "chapter1.html#chapter-summary",
    "title": "Chapter 1 - Introduction",
    "section": "Chapter Summary",
    "text": "Chapter Summary\nTime-to-event (or survival) data are collected by following subjects from a clearly defined starting point until a particular event occurs or until they are censored. The latter occurs when the subject does not experience the event by the time the study ends or they withdraw, leaving the exact event time unknown. Properly integrating the partial information contained in censored observations—rather than discarding or misclassifying them—is essential to avoid systematic bias.\n\nReal examples\nNumerous real studies illustrate the complexity of time-to-event data. In some settings, a single (univariate) endpoint—such as death—drives the analysis, as in the German Breast Cancer (GBC) Study. In others, such as the Chronic Granulomatous Disease (CGD) Study, individuals can experience recurrent events (e.g., repeated infections), leading to correlated outcomes within each subject. Meanwhile, the Diabetic Retinopathy Study (DRS) exemplifies a scenario where each subject has more than one at-risk unit (two eyes), so the events of interest (vision loss) are clustered within the same person. Still other investigations involve competing risks, as with bone marrow transplant patients whose relapse and treatment-related mortality exclude each other, or semi-competing risks, where a nonfatal event can occur only before death. Some studies collect longitudinal biomarkers (e.g., serial CD4 measurements) in conjunction with survival outcomes, and many modern trials unify multiple event types into a composite endpoint, providing a holistic view of patient experience.\n\n\nImplications of censoring\nUnderneath these variations, censoring remains the main factor complicating statistical inference. When subjects drop out early or when the study reaches its planned end date, the only information gained is that a subject’s event time exceeds the last observation time. A naive approach—such as imputing the event time at the censoring point or discarding censored subjects—typically lead to bias, as longer-living or later-failing subjects are censored more often. To address this bias, many standard methods (e.g., Kaplan–Meier, Cox regression) assume independent censoring. If this assumption does not hold and censoring depends on unobserved factors linked to the event, more advanced techniques or sensitivity analyses become necessary.\n\n\nDescriptive analysis\nA thorough descriptive analysis of the data is recommended before applying any model-based approach. This generally includes an initial “Table 1” that compares baseline characteristics (such as age, sex, tumor size, or hormone status) across treatment or exposure groups, ensuring any key differences or imbalances are made explicit. It may also involve calculating event rates—defined as total events divided by total person-time at risk. Care must be taken to distinguish between overall follow-up (lasting until a terminal event or the study’s end) and event-specific follow-up (which may end sooner if the event of interest has occurred). Aligning the numerator (events) with the relevant denominator (time at risk) ensures clarity and consistency in summarizing outcomes.\n\n\nConclusion\nThese fundamental ideas—awareness of different event structures, accurate handling of censoring, and proper descriptive summaries—form the bedrock upon which future methods will build.",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 1 - Introduction"
    ]
  },
  {
    "objectID": "chapter1.html#base-r-code",
    "href": "chapter1.html#base-r-code",
    "title": "Chapter 1 - Introduction",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nShow the code\n###############################################################################\n# Chapter 1 R Code: Figure 1.2 and Table 1.12\n# \n# This script generates:\n#  1. Figure 1.2: Demonstration of proper (Kaplan–Meier) vs. \n#     improper (event-imputation, complete-case) survival estimates.\n#  2. Table 1.12: Baseline characteristics for the German Breast Cancer (GBC) study.\n#\n# It also computes event rates (death, composite event) for each hormone group.\n###############################################################################\n\n# -------------------------------------------------------\n# 0. Preparations\n# -------------------------------------------------------\n\n# (a) Load required packages\nlibrary(survival)\n\n# -------------------------------------------------------\n# 1. Read in the German Breast Cancer (GBC) mortality data\n# -------------------------------------------------------\n\ngbc_mort &lt;- read.table(\"Data/German Breast Cancer Study/gbc_mort.txt\", header = TRUE)\nhead(gbc_mort)\n\n# The data frame 'gbc_mort' contains:\n#  time:   time (months) to death or censoring\n#  status: event indicator (1 = death, 0 = censoring)\n#  hormone: hormone therapy group (1 = no hormone, 2 = hormone)\n#  age, meno, size, grade, nodes, prog, estrg (baseline characteristics)\n\n# -------------------------------------------------------\n# 2. Kaplan–Meier Estimates (Proper) vs. Naive Methods\n# -------------------------------------------------------\n\n# (a) Subset by hormone group\ngbc_mort_1 &lt;- subset(gbc_mort, hormone == 1)  # no hormone\ngbc_mort_2 &lt;- subset(gbc_mort, hormone == 2)  # hormone\n\n# (b) Fit group-specific Kaplan–Meier curves\nKMfit1 &lt;- survfit(Surv(time, status) ~ 1, data = gbc_mort_1)\nKMfit2 &lt;- survfit(Surv(time, status) ~ 1, data = gbc_mort_2)\n\n# (c) Define a function to calculate an \"empirical\" survival curve \n#     by treating all observations in x as if they were complete (event-imputation).\nemp.surv &lt;- function(x) {\n  n  &lt;- length(x)\n  tU &lt;- sort(unique(x))\n  m  &lt;- length(tU)\n  S  &lt;- numeric(m)\n  for (i in seq_len(m)) {\n    S[i] &lt;- sum(x &gt; tU[i]) / n\n  }\n  list(t = tU, S = S)\n}\n\n# (d) Event-imputation survival curves\nobj1_imp &lt;- emp.surv(gbc_mort_1$time)\nobj2_imp &lt;- emp.surv(gbc_mort_2$time)\n\n# (e) Complete-case survival curves (ignores censored data)\nobj1_cc &lt;- emp.surv(gbc_mort_1$time[gbc_mort_1$status == 1])\nobj2_cc &lt;- emp.surv(gbc_mort_2$time[gbc_mort_2$status == 1])\n\n# (f) Plot KM (solid), event-imputed (dashed), and complete-case (dotted) curves\npar(mfrow = c(1, 2))\n\n# No Hormone group\nplot(KMfit1, conf.int = FALSE, xlab = \"Time (months)\", ylab = \"Survival Rate\",\n     main = \"No Hormone\", lwd = 2, cex.axis = 1.5, cex.lab = 1.5, cex.main = 1.5)\nlines(obj1_imp$t, obj1_imp$S, lty = 2, lwd = 2)\nlines(obj1_cc$t, obj1_cc$S, lty = 3, lwd = 2)\n\n# Hormone group\nplot(KMfit2, conf.int = FALSE, xlab = \"Time (months)\", ylab = \"Survival Rate\",\n     main = \"Hormone\", lwd = 2, cex.axis = 1.5, cex.lab = 1.5, cex.main = 1.5)\nlines(obj2_imp$t, obj2_imp$S, lty = 2, lwd = 2)\nlines(obj2_cc$t, obj2_cc$S, lty = 3, lwd = 2)\n\n# --------------------------------------------------------\n# 3. Table 1.12: Baseline Characteristics by Hormone Group\n# --------------------------------------------------------\n\n# (a) Define helper functions for summarizing quantitative and categorical variables\n\n# This function calculates median (IQR) for a quantitative variable by a binary group\nMean.IQR.by.trt &lt;- function(y, trt, decp = 1) {\n  groups &lt;- sort(unique(trt))\n  overall_q &lt;- quantile(y, probs = c(0.25, 0.5, 0.75))\n  g1_q &lt;- quantile(y[trt == groups[1]], probs = c(0.25, 0.5, 0.75))\n  g2_q &lt;- quantile(y[trt == groups[2]], probs = c(0.25, 0.5, 0.75))\n  \n  out &lt;- matrix(NA, nrow = 1, ncol = 3)\n  colnames(out) &lt;- c(groups, \"Overall\")\n  \n  out[1, 1] &lt;- paste0(round(g1_q[2], decp), \" (\", \n                      round(g1_q[1], decp), \", \", \n                      round(g1_q[3], decp), \")\")\n  out[1, 2] &lt;- paste0(round(g2_q[2], decp), \" (\", \n                      round(g2_q[1], decp), \", \", \n                      round(g2_q[3], decp), \")\")\n  out[1, 3] &lt;- paste0(round(overall_q[2], decp), \" (\",\n                      round(overall_q[1], decp), \", \",\n                      round(overall_q[3], decp), \")\")\n  \n  out\n}\n\n# This function calculates N (%) for each level of a categorical variable by a binary group\nN.prct.by.trt &lt;- function(x, trt, decp = 1) {\n  groups &lt;- sort(unique(trt))\n  x_levels &lt;- sort(unique(x))\n  p &lt;- length(x_levels)\n  \n  n_total &lt;- length(x)\n  n1 &lt;- sum(trt == groups[1])\n  n2 &lt;- sum(trt == groups[2])\n  \n  out &lt;- matrix(NA, nrow = p, ncol = 3)\n  colnames(out) &lt;- c(groups, \"Overall\")\n  rownames(out) &lt;- x_levels\n  \n  for (i in seq_len(p)) {\n    n1i &lt;- sum(x[trt == groups[1]] == x_levels[i])\n    n2i &lt;- sum(x[trt == groups[2]] == x_levels[i])\n    ni  &lt;- sum(x == x_levels[i])\n    \n    out[i, 1] &lt;- paste0(n1i, \" (\", round(n1i / n1 * 100, decp), \"%)\")\n    out[i, 2] &lt;- paste0(n2i, \" (\", round(n2i / n2 * 100, decp), \"%)\")\n    out[i, 3] &lt;- paste0(ni, \" (\", round(ni / n_total * 100, decp), \"%)\")\n  }\n  \n  out\n}\n\n# (b) Generate the summary table\ntable1_data &lt;- rbind(\n  Mean.IQR.by.trt(y = gbc_mort$age,   trt = gbc_mort$hormone),\n  N.prct.by.trt(x = gbc_mort$meno,   trt = gbc_mort$hormone),\n  Mean.IQR.by.trt(y = gbc_mort$size,  trt = gbc_mort$hormone),\n  N.prct.by.trt(x = gbc_mort$grade,  trt = gbc_mort$hormone),\n  Mean.IQR.by.trt(y = gbc_mort$nodes, trt = gbc_mort$hormone),\n  Mean.IQR.by.trt(y = gbc_mort$prog,  trt = gbc_mort$hormone),\n  Mean.IQR.by.trt(y = gbc_mort$estrg, trt = gbc_mort$hormone)\n)\n\ncat(\"\\n=== Table 1.12: Baseline Characteristics by Hormone Group ===\\n\")\nprint(noquote(table1_data))\n\n# -------------------------------------------------------\n# 4. Calculate Event Rates (Death, Composite Endpoint)\n# -------------------------------------------------------\n\n## 4a. Death Rate\n# Numerator: total # of deaths\nnum_D &lt;- c(\n  sum(gbc_mort$status[gbc_mort$hormone == 1]),\n  sum(gbc_mort$status[gbc_mort$hormone == 2]),\n  sum(gbc_mort$status)\n)\n\n# Denominator: total length of follow-up (in years)\ndenom_D &lt;- c(\n  sum(gbc_mort$time[gbc_mort$hormone == 1]),\n  sum(gbc_mort$time[gbc_mort$hormone == 2]),\n  sum(gbc_mort$time)\n) / 12\n\n# Death rate (per year)\ndeath_rate &lt;- round(num_D / denom_D, 3)\ncat(\"\\nDeath rate (per year) by hormone group:\\n\")\nnames(death_rate) &lt;- c(\"Hormone=1\", \"Hormone=2\", \"Overall\")\nprint(death_rate)\n\n## 4b. Composite Endpoint Rate\n# The composite endpoint data file \"gbc.txt\" includes additional info \n#  on relapse. We only take the first event (relapse or death).\ngbc &lt;- read.table(\"Data/German Breast Cancer Study/gbc.txt\", header = TRUE)\n\n# Sort data by (id, time) and pick the first row per patient\ngbc &lt;- gbc[order(gbc$id, gbc$time), ]\nfirst_event &lt;- gbc[!duplicated(gbc$id), ]  # each patient's first observed record\n\n# Numerator: total # of composite events (status &gt; 0)\nnum_CE &lt;- c(\n  sum(first_event$status[first_event$hormone == 1] &gt; 0),\n  sum(first_event$status[first_event$hormone == 2] &gt; 0),\n  sum(first_event$status &gt; 0)\n)\n\n# Denominator: total length of follow-up (in years)\ndenom_CE &lt;- c(\n  sum(first_event$time[first_event$hormone == 1]),\n  sum(first_event$time[first_event$hormone == 2]),\n  sum(first_event$time)\n) / 12\n\n# Composite event rate (per year)\nCE_rate &lt;- round(num_CE / denom_CE, 3)\ncat(\"\\nComposite event rate (per year) by hormone group:\\n\")\nnames(CE_rate) &lt;- c(\"Hormone=1\", \"Hormone=2\", \"Overall\")\nprint(CE_rate)\n\ncat(\"\\n=== End of Chapter 1 Code ===\\n\")",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 1 - Introduction"
    ]
  },
  {
    "objectID": "chapter1.html#tidyverse-solutions",
    "href": "chapter1.html#tidyverse-solutions",
    "title": "Chapter 1 - Introduction",
    "section": "Tidyverse Solutions",
    "text": "Tidyverse Solutions\nFirst load the required packages:\n\n# Load required libraries\nlibrary(tidyverse)\nlibrary(survival)\nlibrary(knitr) # For formatted tables\n\n\nParsing censored data\nInstead of (time, status), sometimes the observed data are stored in a single column with censored observations indicated with a “+” or “&gt;” sign.\nFor example, Table 1.1 of Klein and Moeschberger (2003) lists the times (in months) to relapse of leukemia in the treatment group (6-MP):\n\nMP &lt;- c(10, 7, \"32+\", 23, 22, 6, 16, \"34+\", \"32+\", \"25+\", \"11+\", \"20+\", \n        \"19+\", 6, \"17+\", \"35+\", 6, 13, \"9+\", \"6+\", \"10+\")\n\nTo convert the character strings to (time, status), use parse_number() to parse out the number and str_detect() to detect whether the string contains “+”:\n\n# Example data: relapse times with \"+\" indicating censoring\nMP &lt;- c(10, 7, \"32+\", 23, 22, 6, 16, \"34+\", \"32+\", \"25+\", \n        \"11+\", \"20+\", \"19+\", 6, \"17+\", \"35+\", 6, 13, \"9+\", \n        \"6+\", \"10+\")\n\n# Convert to (time, status) format\ndf &lt;- tibble(\n  MP = MP,\n  time = parse_number(MP),               # Extract numeric part\n  status = 1 - str_detect(MP, \"\\\\+\")    # Censored if \"+\" detected\n)\n\n# Display the parsed data\ndf\n\n# A tibble: 21 × 3\n#    MP     time status\n#    &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt;\n#  1 10       10      1\n#  2 7         7      1\n#  3 32+      32      0\n#  4 23       23      1\n#  5 22       22      1\n#  6 6         6      1\n#  7 16       16      1\n#  8 34+      34      0\n#  9 32+      32      0\n# 10 25+      25      0\n# ℹ 11 more rows\n# ℹ Use `print(n = ...)` to see more rows\n\nNow feed this dataset into survfit() to estimate survival probabilities:\n\n# Kaplan-Meier fit\nkm &lt;- survfit(Surv(time, status) ~ 1, data = df)\n\n# Plot the survival curve\nplot(\n  km,\n  main = \"Relapse of Leukemia in 6-MP Group\",\n  xlab = \"Time (months)\",\n  ylab = \"Relapse-free probabilities\",\n  conf.int = FALSE,\n  frame = FALSE\n)\n\n\n\n\n\n\n\n\n\n\nFacet plotting Fig. 1.2\nHere, we use survival data from the German Breast Cancer Study (GBC). Adjust the file path as needed.\n\n# Read in the GBC mortality data\ndata &lt;- read.table(\"Data//German Breast Cancer Study//gbc_mort.txt\")\n\n# Display the first few rows\nhead(data)\n#   id      time status hormone age meno size grade nodes prog estrg\n# 1  1 74.819672      0       1  38    1   18     3     5  141   105\n# 2  2 65.770492      0       1  52    1   20     1     1   78    14\n# 3  3 47.737705      1       1  47    1   30     2     1  422    89\n# 4  4  4.852459      0       1  40    1   24     1     3   25    11\n# 5  5 61.081967      0       2  64    2   19     2     1   19     9\n# 6  6 63.377049      0       2  49    2   56     1     3  356    64\n\nThen compute the different estimates within each level of hormone. Do this by using group_by(hormone) and performing the calculations within reframe(). But first we use survfit() to get the Kaplan–Meier estimates:\n\n# Kaplan-Meier estimates\nobj &lt;- summary(survfit(Surv(time, status) ~ hormone, data = data))\n\n# Extract survival probabilities into a tibble\nkm &lt;- tibble(\n  t = obj$time,\n  surv = obj$surv,\n  hormone = parse_number(as.character(obj$strata)), # Hormone group\n  type = \"Kaplan-Meier\"\n) |&gt; \n  add_row(\n    # Add starting points at (0, 1) for each group\n    t = c(0, 0),\n    surv = c(1, 1),\n    hormone = 1:2,\n    type = \"Kaplan-Meier\"\n  )\n\nThen the event-imputation and complete-case estimates (with ecdf() for empirical distribution function):\n\n# Event-imputation estimates\nimp &lt;- data |&gt; \n  group_by(hormone) |&gt; \n  reframe(\n    t = time,\n    surv = 1 - ecdf(time)(time)  # Empirical survival function\n  ) |&gt; \n  arrange(t) |&gt; \n  mutate(type = \"Event-imputation\")\n\n# Complete-case estimates\ncc &lt;- data |&gt; \n  filter(status == 1) |&gt; \n  group_by(hormone) |&gt; \n  reframe(\n    t = time,\n    surv = 1 - ecdf(time)(time)\n  ) |&gt; \n  arrange(t) |&gt; \n  mutate(type = \"Complete-case\")\n\nNow plot the figure:\n\n# Combine estimates\nestimates &lt;- bind_rows(km, imp, cc)\n\n# Define panel labels\nhormone_labeller &lt;- c(\"1\" = \"No Hormone\", \"2\" = \"Hormone\")\n\n# Plot\nestimates |&gt; \n  mutate(type = factor(type, levels = c(\"Kaplan-Meier\", \"Event-imputation\", \"Complete-case\"))) |&gt; \n  ggplot(aes(x = t, y = surv, linetype = type)) +\n  geom_step() +\n  facet_wrap(~ hormone, labeller = labeller(hormone = hormone_labeller)) +\n  theme_bw() +\n  scale_x_continuous(name = \"Time (months)\", breaks = seq(0, 72, 12), limits = c(0, 72)) +\n  scale_y_continuous(name = \"Survival rate\", limits = c(0, 1)) +\n  scale_linetype_manual(name = \"Method\", values = 1:3) +\n  theme(legend.position = \"bottom\")\n\n\n\n\n\n\n\n\nPrettier than Fig. 1.2?\n\n\nTable 1\nLet’s recreate Table 1.12, that is, “Table 1” for the German Breast Cancer study. Because the summary statistics are grouped by hormone status and overall, we add a replica to the original data where hormone is set to “Overall”, thereby creating three levels: “No hormone”, “Hormone”, “Overall”. Then we can use summarize() to calculate the summary statistics within each level of hormone after group_by(hormone).\nTo do so, we will define three summary functions:\n\nOne calculating median (IQR) for a quantitative variable;\nOne calculating N (%) for each level of a categorical variable;\nOne calculating event rate based on time and status.\n\nTo start, read in and clean the GBC mortality data for the subject-level statistics and death rate:\n\nlibrary(knitr) # for printing formatted table\n\n## for subject-level summary and mortality\n## read in the GBC mortality data\ndata &lt;- read.table(\"Data//German Breast Cancer Study//gbc_mort.txt\")\n\n# Clean and expand data with \"Overall\" group\ndf &lt;- data |&gt; \n  mutate(hormone = if_else(hormone == 1, \"No Hormone\", \"Hormone\")) |&gt; \n  add_row(data |&gt; mutate(hormone = \"Overall\")) |&gt; \n  mutate(\n    hormone = factor(hormone, levels = c(\"No Hormone\", \"Hormone\", \"Overall\")),\n    meno = if_else(meno == 1, \"No\", \"Yes\")\n  )\n\nNow, write a function to compute median (IQR) and use it on the quantitative variables. In the process, we use pivot_longer() and pivot_wider() to put the hormone levels on the columns rather than rows. (For details on these data transposition tools, see https://r4ds.hadley.nz/data-tidy).\n\n## Function to compute median (IQR) for x\n## rounded to the rth decimal place\nmed_iqr &lt;- function(x, r = 1){\n  qt &lt;- quantile(x, na.rm = TRUE)\n  \n  str_c(round(qt[3], r), \" (\", \n        round(qt[2], r), \", \",\n        round(qt[4], r), \")\")\n}\n\n# create summary table for quantitative variables\n# age, size, nodes, prog, estrg\ntab_quant &lt;- df |&gt; \n  group_by(hormone) |&gt; \n  summarize(\n    across(c(age, size, nodes, prog, estrg), med_iqr)\n  ) |&gt; \n  pivot_longer( # long format: value = median (IQR); name = variable names\n    !hormone,\n    values_to = \"value\",\n    names_to = \"name\"\n  ) |&gt; \n  pivot_wider( # wide format: name = variable names; hormone levels as columns\n    values_from = value,\n    names_from = hormone\n  ) |&gt; \n  mutate(\n    name = case_when( # format the variable names\n      name == \"age\" ~ \"Age (years)\",\n      name == \"size\" ~ \"Tumor size (mm)\",\n      name == \"nodes\" ~ \"# Nodes\",\n      name == \"prog\" ~ \"Progesterone (fmol/mg)\",\n      name == \"estrg\" ~ \"Estrogen (fmol/mg)\"\n    )\n  )\n\nSee what the result looks like:\n\ntab_quant\n# # A tibble: 5 × 4\n#   name                   `No Hormone` Hormone       Overall        \n#   &lt;chr&gt;                  &lt;chr&gt;        &lt;chr&gt;         &lt;chr&gt;          \n# 1 Age (years)            50 (45, 59)  58 (50, 63)   53 (46, 61)    \n# 2 Tumor size (mm)        25 (20, 35)  25 (20, 35)   25 (20, 35)    \n# 3 # Nodes                3 (1, 7)     3 (1, 7)      3 (1, 7)       \n# 4 Progesterone (fmol/mg) 32 (7, 130)  35 (7.2, 133) 32.5 (7, 131.8)\n# 5 Estrogen (fmol/mg)     32 (8, 92.2) 46 (9, 182.5) 36 (8, 114) \n\nNext we deal with categorical variables. Because the results span multiple rows due to multiple levels, it is easier to write a data frame function, one that takes the tibble data frame as an argument. For details, see https://r4ds.hadley.nz/functions#data-frame-functions.\n\n## a function that computes N (%) for each level of var\n## by group in data frame df (percent rounded to rth point)\nfreq_pct&lt;- function(df, group, var, r = 1){\n  # compute the N for each level of var by group\n  var_counts &lt;- df |&gt; \n    group_by({{ group }}, {{ var }}) |&gt; \n    summarize(\n      n = n(),\n      .groups = \"drop\"\n    ) \n  # compute N (%)\n  var_counts |&gt; \n    left_join( # compute the total number (demoninator) in each group\n               # and joint it back to the numerator\n      var_counts |&gt; group_by({{ group }}) |&gt; summarize(N = sum(n)),\n      by = join_by({{ group }})\n    ) |&gt; \n    mutate( # N (%)\n      value = str_c(n, \" (\", round(100 * n / N, r), \"%)\")\n    ) |&gt; \n    select(- c(n, N)) |&gt; \n    pivot_wider( # put group levels on columns\n      names_from = {{ group }},\n      values_from = value\n    ) |&gt; \n    rename(\n      name = {{ var }} # name = variable names \n    )\n}\n\nApply this function to meno and grade (by hormone of course):\n\n## menopausal status\nmeno &lt;- df |&gt;\n  freq_pct(hormone, meno) |&gt; \n  mutate(\n    name = str_c(\"Menopause - \", name)\n  )\n\n## tumor grade\ngrade &lt;- df |&gt; \n  freq_pct(hormone, grade) |&gt; \n  mutate(\n    name = str_c(\"Tumor grade - \", name)\n  )\n\nCombine with the quantitative variables:\n\ntabone &lt;- tab_quant |&gt; \n  add_row(meno) |&gt; \n  add_row(grade)\n\ntabone\n# # A tibble: 10 × 4\n#    name                   `No Hormone` Hormone       Overall        \n#    &lt;chr&gt;                  &lt;chr&gt;        &lt;chr&gt;         &lt;chr&gt;          \n#  1 Age (years)            50 (45, 59)  58 (50, 63)   53 (46, 61)    \n#  2 Tumor size (mm)        25 (20, 35)  25 (20, 35)   25 (20, 35)    \n#  3 # Nodes                3 (1, 7)     3 (1, 7)      3 (1, 7)       \n#  4 Progesterone (fmol/mg) 32 (7, 130)  35 (7.2, 133) 32.5 (7, 131.8)\n#  5 Estrogen (fmol/mg)     32 (8, 92.2) 46 (9, 182.5) 36 (8, 114)    \n#  6 Menopause - No         231 (52.5%)  59 (24%)      290 (42.3%)    \n#  7 Menopause - Yes        209 (47.5%)  187 (76%)     396 (57.7%)    \n#  8 Tumor grade - 1        48 (10.9%)   33 (13.4%)    81 (11.8%)     \n#  9 Tumor grade - 2        281 (63.9%)  163 (66.3%)   444 (64.7%)    \n# 10 Tumor grade - 3        111 (25.2%)  50 (20.3%)    161 (23.5%)  \n\nAs the last step, create an event rate function and apply it to df to calculate the death rate:\n\n# event rate function\n# status = 1 for event\nevent_rate &lt;- function(time, status){\n  sum(status)/sum(time) \n  # we don't use sum(x, na.rm = TRUE) because\n  # missing data should alarm us\n}\n\n# calculate death rates\ndeath_rates &lt;- df |&gt; \n  group_by(hormone) |&gt; \n  summarize(\n    death_rate = as.character(round(event_rate(time, status) * 12, 3)) # per year\n  ) |&gt; \n  pivot_wider(\n    names_from = hormone,\n    values_from = death_rate\n  ) |&gt; \n  mutate(\n    name = \"Death rate (per person-year)\",\n    .before = 1\n  )\n\ndeath_rates\n# # A tibble: 1 × 4\n#   name                         `No Hormone` Hormone Overall\n#   &lt;chr&gt;                        &lt;chr&gt;        &lt;chr&gt;   &lt;chr&gt;  \n# 1 Death rate (per person-year) 0.075        0.059   0.069  \n\nFinally, read in and clean up the complete data (relapse and death) to calculate the composite endpoint (CE; time to first) event rate.\n\n# Read in the complete data\ngbc &lt;- read.table(\"Data//German Breast Cancer Study//gbc.txt\")\n\n## get the first event (minimum time)\n## for each patient id\ngbc_ce &lt;- gbc |&gt; \n  group_by(id) |&gt; \n  slice_min(time) |&gt; # take min time\n  slice_max(status) |&gt; # if death (2) is tied with relapse (1), take death\n  ungroup()\n\n## same manipulations\ndf_ce &lt;- gbc_ce |&gt; \n  mutate(\n    hormone = if_else(hormone == 1, \"No Hormone\", \"Hormone\")\n  ) |&gt; \n  add_row(gbc_ce |&gt; mutate(hormone = \"Overall\")) |&gt; \n  mutate(\n    hormone = fct(hormone, levels = c(\"No Hormone\", \"Hormone\", \"Overall\")),\n  )\n\nApply the same event rate function to calculate the CE rate.\n\nce_rates &lt;- df_ce |&gt; \n  group_by(hormone) |&gt; \n  summarize(\n    ce_rate = as.character(round(event_rate(time, status &gt; 0) * 12, 3)) # per year\n  ) |&gt; \n  pivot_wider(\n    names_from = hormone,\n    values_from = ce_rate\n  ) |&gt; \n  mutate(\n    name = \"CE rate (per person-year)\",\n    .before = 1\n  )\n\nAdd the event rates to the table and print it out:\n\n## add event rates\ntabone &lt;- tabone |&gt; \n  add_row(\n    death_rates\n  ) |&gt; \n  add_row(\n    ce_rates\n  ) \n\n## add N to group names  \ncolnames(tabone) &lt;- c(\" \", str_c(colnames(tabone)[2:4], \" (N=\", table(df$hormone),\")\"))\n## print out the table\nkable(tabone)\n\n\n\nTable 1: Patient characteristics in the German Breast Cancer study.\n\n\n\n\n\n\n\n\n\n\n\n\n\nNo Hormone (N=440)\nHormone (N=246)\nOverall (N=686)\n\n\n\n\nAge (years)\n50 (45, 59)\n58 (50, 63)\n53 (46, 61)\n\n\nTumor size (mm)\n25 (20, 35)\n25 (20, 35)\n25 (20, 35)\n\n\n# Nodes\n3 (1, 7)\n3 (1, 7)\n3 (1, 7)\n\n\nProgesterone (fmol/mg)\n32 (7, 130)\n35 (7.2, 133)\n32.5 (7, 131.8)\n\n\nEstrogen (fmol/mg)\n32 (8, 92.2)\n46 (9, 182.5)\n36 (8, 114)\n\n\nMenopause - No\n231 (52.5%)\n59 (24%)\n290 (42.3%)\n\n\nMenopause - Yes\n209 (47.5%)\n187 (76%)\n396 (57.7%)\n\n\nTumor grade - 1\n48 (10.9%)\n33 (13.4%)\n81 (11.8%)\n\n\nTumor grade - 2\n281 (63.9%)\n163 (66.3%)\n444 (64.7%)\n\n\nTumor grade - 3\n111 (25.2%)\n50 (20.3%)\n161 (23.5%)\n\n\nDeath rate (per person-year)\n0.075\n0.059\n0.069\n\n\nCE rate (per person-year)\n0.161\n0.113\n0.142\n\n\n\n\n\n\n\n\n\nUsing gtsummary\nThere is a simpler way to create Table 1.12 using the gtsummary package.\n\nlibrary(gtsummary) \nlibrary(labelled) # For labelling variables\n\n# Re-read data to keep it distinct (optional)\ngbc_mort &lt;- read.table(\"Data//German Breast Cancer Study//gbc_mort.txt\")\n\ndf_gts &lt;- gbc_mort |&gt; \n  mutate(\n    hormone = if_else(hormone == 1, \"No Hormone\", \"Hormone\"),\n    hormone = factor(hormone, levels = c(\"No Hormone\", \"Hormone\")),\n    meno = if_else(meno == 1, \"No\", \"Yes\") |&gt; factor(levels = c(\"No\", \"Yes\"))\n  )\n\n# Labeling variables\nvar_label(df_gts) &lt;- list(\n  time = \"Time to event (months)\",\n  status = \"Event status\",\n  hormone = \"Hormone therapy\",\n  age = \"Age (years)\",\n  meno = \"Menopausal status\",\n  size = \"Tumor size (mm)\",\n  grade = \"Tumor grade\",\n  nodes = \"Number of nodes\",\n  prog = \"Progesterone (fmol/mg)\",\n  estrg = \"Estrogen (fmol/mg)\"\n)\n\ntbl1 &lt;- df_gts |&gt;\n  tbl_summary(\n    by = hormone,\n    include = ! c(id, time, status),\n    missing = \"no\"\n  ) |&gt;\n  add_overall(last = TRUE) |&gt; # At the end\n  italicize_levels()\n\ntbl1\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nNo Hormone, N = 4401\nHormone, N = 2461\nOverall, N = 6861\n\n\n\n\nAge (years)\n50 (45, 59)\n58 (50, 63)\n53 (46, 61)\n\n\nMenopausal status\n209 (48%)\n187 (76%)\n396 (58%)\n\n\nTumor size (mm)\n25 (20, 35)\n25 (20, 35)\n25 (20, 35)\n\n\nTumor grade\n\n\n\n\n\n\n\n\n    1\n48 (11%)\n33 (13%)\n81 (12%)\n\n\n    2\n281 (64%)\n163 (66%)\n444 (65%)\n\n\n    3\n111 (25%)\n50 (20%)\n161 (23%)\n\n\nNumber of nodes\n3 (1, 7)\n3 (1, 7)\n3 (1, 7)\n\n\nProgesterone (fmol/mg)\n32 (7, 130)\n35 (7, 133)\n33 (7, 132)\n\n\nEstrogen (fmol/mg)\n32 (8, 92)\n46 (9, 183)\n36 (8, 114)\n\n\n\n1 Median (IQR); n (%)\n\n\n\n\n\n\n\n\nHowever, we still need to “manually” calculate the event rates.",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 1 - Introduction"
    ]
  },
  {
    "objectID": "chapter11.html",
    "href": "chapter11.html",
    "title": "Chapter 11 - Joint Analysis of Longitudinal and Survival Data",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 11 - Joint Analysis of Longitudinal and Survival Data"
    ]
  },
  {
    "objectID": "chapter11.html#slides",
    "href": "chapter11.html#slides",
    "title": "Chapter 11 - Joint Analysis of Longitudinal and Survival Data",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 11 - Joint Analysis of Longitudinal and Survival Data"
    ]
  },
  {
    "objectID": "chapter11.html#base-r-code",
    "href": "chapter11.html#base-r-code",
    "title": "Chapter 11 - Joint Analysis of Longitudinal and Survival Data",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nShow the code\n##################################################################\n# This code generates all numerical results in chapter 11.      ##\n##################################################################\n\n\n############################################################\n# Analysis of the anti-retroviral drug trial\n############################################################\n\n#load required packages\n# library(nlme) # for linear mixed effects model\nlibrary(survival)\nlibrary(tidyverse)\n#load the JM package\n# install.packages(\"JM\")\nlibrary(JM)\n\n# read in the study dataset\ndf &lt;- read.table(\"Data//Anti-retroviral Trial//aids.txt\")\nhead(df)\n\n# create a de-duplicated data for survival sub-model\ndf_surv &lt;- df[!duplicated(df$id),]\n\n# Joint model fit for the HIV/AIDS dataset\n# longitudinal sub-model: linear time\nlongit_sub &lt;- lme(CD4 ~ obsmo + obsmo:drug + sex + hist,\n                   random = ~ obsmo|id, data = df)\n\n# Alternative longitudinal sub-models\n# Natural splines\n# longit_sub &lt;- lme(CD4 ~ ns(obsmo, 3) + ns(obsmo, 3):drug + sex + hist,\n#                    random = ~ obsmo|id, data = df)\n\n\n# survival sub-model\nsurv_sub &lt;- coxph(Surv(time, status) ~ drug + sex + hist,\n                     data = df_surv, x = TRUE)\n\n# combine the two models\n# piecewise linear baseline with six internal knots\nobj_joint &lt;- jointModel(longit_sub, surv_sub, timeVar = \"obsmo\",\n                            method = \"piecewise-PH-aGH\")\n## 3-month lag\n# obj_join_l3m &lt;- jointModel(longit_sub, surv_sub, timeVar = \"obsmo\", lag = 3,\n#                             method = \"piecewise-PH-aGH\")\n\n# print out the summary\nsummary(obj_joint)\n#&gt; Call:\n#&gt; jointModel(lmeObject = longit_sub, survObject = surv_sub, timeVar = \"obsmo\", \n#&gt;     method = \"piecewise-PH-aGH\")\n#&gt; \n#&gt; Data Descriptives:\n#&gt; Longitudinal Process     Event Process\n#&gt; Number of Observations: 1405 Number of Events: 188 (40.3%)\n#&gt; Number of Groups: 467\n#&gt; \n#&gt; Joint Model Summary:\n#&gt; Longitudinal Process: Linear mixed-effects model\n#&gt; Event Process: Relative risk model with piecewise-constant\n#&gt;      baseline risk function\n#&gt; Parameterization: Time-dependent \n#&gt; \n#&gt;    log.Lik      AIC      BIC\n#&gt;  -4404.569 8849.139 8932.065\n#&gt; \n#&gt; Variance Components:\n#&gt;              StdDev    Corr\n#&gt; (Intercept)  3.9797  (Intr)\n#&gt; obsmo        0.1928 -0.0890\n#&gt; Residual     2.0428        \n#&gt; \n#&gt; Coefficients:\n#&gt; Longitudinal Process\n#&gt;                 Value Std.Err z-value p-value\n#&gt; (Intercept)    5.8614  0.6562  8.9322 &lt;0.0001\n#&gt; obsmo         -0.1922  0.0240 -8.0175 &lt;0.0001\n#&gt; sexmale       -0.3823  0.6642 -0.5757  0.5649\n#&gt; histnoAIDS     4.8617  0.4091 11.8835 &lt;0.0001\n#&gt; obsmo:drugddI  0.0219  0.0333  0.6558  0.5120\n#&gt; \n#&gt; Event Process\n#&gt;              Value Std.Err z-value p-value\n#&gt; drugddI     0.3487  0.1576  2.2118  0.0270\n#&gt; sexmale    -0.3313  0.2608 -1.2701  0.2040\n#&gt; histnoAIDS -0.5873  0.2255 -2.6040  0.0092\n#&gt; Assoct     -0.2569  0.0374 -6.8708 &lt;0.0001\n#&gt; ...\n\n# Extract estimated coefficients\nobj_joint$coefficients\n\n\n## Residual analysis \npar(mfrow = c(2, 2))\nplot(obj_joint) # Standard plot\n\n# Longitudinal residuals\nepsilons &lt;- residuals(obj_joint, process = \"Longitudinal\", type = \"Subject\")\nlength(epsilons)\nRs &lt;- residuals(obj_joint, process = \"Longitudinal\", type = \"Marginal\")\nlength(Rs)\n# Fitted m_i(t)\nms &lt;- fitted(obj_joint, process = \"Longitudinal\")\nlength(ms)\nms1 &lt;- fitted(obj_joint, process = \"Longitudinal\", type = \"EventTime\")\nlength(ms1)\n\nms2 &lt;- df$y - epsilons\n\nms[1:10]\nms1[1:10]\nms2[1:10]\n\n# Martingale residuals\nmart &lt;- residuals(obj_joint, process = \"Event\")\n\nplot(ms1, mart)\n\ntibble(\n  y_obs = df$y,\n  y_pred = ms2\n) |&gt; \n  ggplot(aes(x = y_obs, y = y_pred)) +\n  geom_point(color = \"gray20\") +\n  geom_abline(intercept = 0, slope = 1, color = \"red\") +\n  coord_fixed() +\n  labs(title = \"Martingale residuals vs. Fitted values\",\n       x = expression(\"Fitted \"~ sqrt(CD4)),\n       y = expression(\"Observed \"~ sqrt(CD4))) +\n  theme_minimal()\n\n# Fitted value of true CD4\nmt &lt;- df$y - epsilons\n\n## Dynamic prediction\nhead(df)\n\ndf$id\n\nsurv_pred2 &lt;- survfitJM(obj_joint, newdata = df[df$id == 2, ], simulate = FALSE)\n\nsurv_pred2 &lt;- survfitJM(obj_joint, newdata = data.frame(id = 1, y = 3, obsmo = 6, drug = \"ddI\",  sex = \"male\", hist = \"noAIDS\"))\n\n\n#######################################\n# Figure \n######################################\n\n# compute the mean trajectories based on the longitudinal\n# sub-model results\n\nt &lt;- (0:180)/10\n\ng0 &lt;- gamma[1]\ng1 &lt;- gamma[2]\ng3 &lt;- gamma[4]\ng4 &lt;- gamma[5]\n\n\nddC_nonhist &lt;- (g0+g3+g1*t)^2\nddC_hist &lt;- (g0 + g1*t)^2\n\n\nddI_nonhist &lt;- (g0+g3+(g1+g4)*t)^2\nddI_hist &lt;- (g0+(g1+g4)*t)^2\n\n\n#######################################################\n# \n# Model-based estimates of the mean trajectories\n#  of CD4 count for female patients by treatment\n#  group and previous infection status. Solid, ddC;\n#  dotted, ddI\n######################################################\npar(mfrow=c(1,2))\n\nplot(t, ddC_nonhist,type='l',frame.plot=F,\n     main=\"No previous infection\",xlim=c(0,18),ylim=c(0,120),\n     xlab=\"Time (months)\", ylab=\"Mean CD4 cell count\", lwd=2, cex.main = 1)\nlines(t,ddI_nonhist,lty=3,lwd=2)\n\nplot(t, ddC_hist,type='l',frame.plot=F,\n     main=\"Previous infection\",xlim=c(0,18),ylim=c(0,120),\n     xlab=\"Time (months)\", ylab=\"Mean CD4 cell count\", lwd=2, cex.main = 1)\nlines(t,ddI_hist,lty=3,lwd=2)\n\n## ggplot version\n\nm &lt;- length(t)\ntibble(\n  t = rep(t, 4),\n  CD4 = c(ddC_nonhist, ddI_nonhist, ddC_hist, ddI_hist),\n  trt = rep(rep(c(\"ddC\", \"ddI\"), each = m), 2),\n  hist = rep(c(\"No previous infection\", \"Previous infection\"), each = 2*m)\n    ) |&gt; \n  ggplot(aes(x = t, y = CD4)) +\n    geom_line(aes(linetype = trt), linewidth = 0.8) +\n    facet_wrap(~ hist) +\n  scale_x_continuous(breaks = seq(0, 18, 6)) +\n  scale_y_continuous(limits = c(0, 120), breaks = seq(0, 120, 30)) +\n  labs(\n    x = \"Time (months)\",\n    y = expression(\"CD4 cell count / mm\"^3),\n    linetype = NULL\n  ) +\n    theme_minimal() +\n  theme(\n    legend.position = \"top\",\n    strip.text = element_text(size = 11),\n    legend.text = element_text(size = 11),\n    legend.key.width = unit(1, \"cm\")\n  )\n\nggsave(\"images/longit_mean_cd4.png\", width = 8, height = 4.5)\nggsave(\"images/longit_mean_cd4.eps\", width = 8, height = 4.5)\n\n\n\n# Multivariate analsysis ---------------------------------------------------\nlibrary(JMbayes2)\n# Heart valve replacement study\ndf &lt;- read.table(\"Data//Heart Valve Implantation Study//heartv.txt\", header = TRUE)\n\n# Descriptive statistics\n\nn &lt;- length(unique(df$id))\n# Number of deaths\ndf |&gt; \n  group_by(id) |&gt;\n  slice(1) |&gt; \n  filter(status == 1) |&gt;\n  nrow()\n\ndf |&gt; \n  dplyr::select(id, surv_time, status, obsyear, ef50, grad, lvmi,  age, sex, vsize, lvef, redo)\n#     id surv_time status   obsyear ef50 grad   lvmi      age sex vsize lvef redo\n# 4   2  9.663014      0 6.3643840    0   14 114.93 45.79452   0    22    2    1\n# 5   2  9.663014      0 7.3041100    0    9 109.80 45.79452   0    22    2    1\n# 6   2  9.663014      0 8.3013700    0   12 157.40 45.79452   0    22    2    1\n# 7   2  9.663014      0 9.3068490    0   12 114.93 45.79452   0    22    2    1\n# 8   3  7.915068      0 0.4767123    1   10 191.62 63.26575   0    25    1    0\n# 9   3  7.915068      0 1.3205480    0   10 168.38 63.26575   0    25    1    0\n# 10  3  7.915068      0 2.9123290    1   10 148.23 63.26575   0    25    1    0\n# 56 13  5.186301      1 0.1369863    0   15 201.45 69.94247   1    26    2    1\n# 57 13  5.186301      1 1.0575340    0   17 197.03 69.94247   1    26    2    1\n# 58 13  5.186301      1 2.0547950    0   20 120.85 69.94247   1    26    2    1\n# 59 13  5.186301      1 2.6547940    0   20 162.33 69.94247   1    26    2    1\n# 60 13  5.186301      1 3.9726030    0   30 147.44 69.94247   1    26    2    1\n\n\n# Joint modeling of heart valve implantation study\n\n# Longitudinal outcomes\n# 1. Ejection fraction &lt;= 50% (Logistic GLMM)\n# 2. Log valve gradient at follow-up (LME)\n# 3. Log left ventricular mass index at follow-up (LME)\n\n# Survival outcome\n# (surv_time, status): death\n\n# Longitudinal sub-models\n# 1. Ejection fraction &lt;= 50% at follow-up\nef_mod &lt;- mixed_model(ef50 ~ obsyear + age + sex  + vsize + lvef + redo \n                      + cabg + acei + hc + emergenc, \n                      random = ~ obsyear | id, data = df,\n                      family = binomial()\n                      )\nsummary(ef_mod)\n\n# 2. LV gradient at follow-up\ngrad_mod &lt;- lme(grad ~ obsyear + age + sex  + vsize + lvef + redo \n                + cabg + acei + hc + emergenc, \n                random = ~ obsyear | id, data = df)\nsummary(grad_mod)\n\n# 3. LV mass index at follow-up\nlvmi_mod &lt;- lme(lvmi ~ obsyear + age + sex  + vsize + lvef + redo \n                + cabg + acei + hc + emergenc, \n                random = ~ obsyear | id, data = df)\n\nsummary(lvmi_mod)\n\n# Survival sub-model\ndf_surv &lt;- df[!duplicated(df$id),] # de-duplicated data\nsurv_mod &lt;- coxph(Surv(surv_time, status) ~ age + sex,  \n                  data = df_surv)\n\n# Join model\n# Set-up functional forms biomarkers in Cox model\nfForms &lt;- list(\n  \"ef50\" = ~ value(ef50),\n  \"grad\" = ~ slope(grad) + value(grad),\n  \"lvmi\" = ~ slope(lvmi) + value(lvmi)\n)\n\n# Fit joint model\n# jointFit0 &lt;- jm(surv_mod, list(ef_mod, grad_mod, lvmi_mod), \n#                 time_var = \"obsyear\",\n#                 functional_forms = fForms)\nobj &lt;- jm(surv_mod, list(ef_mod, grad_mod, lvmi_mod), \n                time_var = \"obsyear\",\n                functional_forms = fForms)\nsummary(obj)\n# Survival Outcome:\n#   Mean  StDev    2.5%  97.5%      P   Rhat\n# age          0.1096 0.0314  0.0531 0.1795 0.0000 1.1006\n# sex          0.4488 0.4760 -0.4989 1.4019 0.3313 1.0374\n# value(ef50)  0.4888 0.2483  0.1190 1.0641 0.0013 1.2045\n# slope(grad) -0.2257 0.1608 -0.5817 0.0456 0.1158 1.1209\n# value(grad) -0.0572 0.0425 -0.1622 0.0057 0.0796 1.2309\n# slope(lvmi) -0.0695 0.0681 -0.2410 0.0404 0.2384 1.2876\n# value(lvmi) -0.0018 0.0071 -0.0172 0.0104 0.8762 1.1779\n\n\n\n# Tabulate regression results \nstats &lt;- obj$statistics\nstats_mean &lt;- stats$Mean\nstats_sd &lt;- stats$SD\n\n# Longitudinal sub-models\n# ef50\ngamma_ef50_est &lt;- stats_mean$betas1\ngamma_ef50_se &lt;- stats_sd$betas1\n# grad\ngamma_grad_est &lt;- stats_mean$betas2\ngamma_grad_se &lt;- stats_sd$betas2\n# lvmi\ngamma_lvmi_est &lt;- stats_mean$betas3\ngamma_lvmi_se &lt;- stats_sd$betas3\n\n# Tabulate estimate and 95% confidence intervals\nza &lt;- qnorm(0.975)\n\n# Function to calculate effect size (95% CI)\nest_ci &lt;- function(est, se, r = 2, exponentiate = TRUE) {\n  \n  if (exponentiate){\n    paste0(\n      round(exp(est), r), \" (\",\n      round(exp(est - za * se), r), \", \",\n      round(exp(est + za * se), r), \")\"\n    )\n  } else{\n    paste0(\n      round(est, r), \" (\",\n      round(est - za * se, r), \", \",\n      round(est + za * se, r), \")\"\n    )\n  }\n  \n  \n}\n\n\n# Function to calculate p-value\npval_calc &lt;- function(est, se) {\n  scales::pvalue(1 - pchisq((est / se)^2, df = 1))\n}\n\n# Create table\ndf_res &lt;- tibble(\n  variable = c(\n    \"(Intercept)\", \"Years after sugery\", \"Age (years)\", \"Male v. female\", \"Valve size\", \n    \"LVEF grade (1-3)\", \"History of surgery\", \"CABG\", \"ACE inhibitor\", \"High cholesterol\", \"Emergency grade (1-3)\"\n  ),\n  EF_OR       = est_ci(gamma_ef50_est, gamma_ef50_se, r = 1),\n  Grad     = est_ci(gamma_grad_est, gamma_grad_se, exponentiate = FALSE, r = 1),\n  LVMI     = est_ci(gamma_lvmi_est, gamma_lvmi_se, exponentiate = FALSE, r = 1)\n)\n\npval_calc(gamma_ef50_est, gamma_ef50_se)\npval_calc(gamma_grad_est, gamma_grad_se)\npval_calc(gamma_lvmi_est, gamma_lvmi_se)\n# Print out table\ndf_res\n# variable                  EF_OR          Grad              LVMI               \n# &lt;chr&gt;                     &lt;chr&gt;          &lt;chr&gt;             &lt;chr&gt;              \n#   1 (Intercept)               0 (0, 0.1)     15.4 (-2.4, 33.2) 34.9 (-13, 82.8)   \n# 2 Time after sugery (years) 1 (0.8, 1.2)   -1.1 (-1.8, -0.4) -1.9 (-3.7, -0.1)  \n# 3 Age (years)               1 (1, 1.1)     -0.1 (-0.2, 0.1)  -0.2 (-0.7, 0.4)   \n# 4 Male v. female            0.5 (0.2, 1.5) 2 (-1.8, 5.9)     -18.8 (-33.8, -3.9)\n# 5 Valve size                1.1 (0.9, 1.3) 0.4 (-0.3, 1)     5.4 (3.2, 7.6)     \n# 6 LVEF grade (1-3)          3.4 (1.8, 6.3) 0.7 (-1.9, 3.3)   4.4 (-6, 14.8)     \n# 7 History of surgery        1.1 (0.3, 4.4) -2.9 (-8.6, 2.8)  -2.5 (-24.1, 19.2) \n# 8 CABG                      1.7 (0.7, 4.2) -2.9 (-6.7, 0.8)  -8.8 (-24.2, 6.6)  \n# 9 ACE inhibitor             1.8 (0.8, 4.2) -1 (-4.4, 2.4)    15.8 (1.7, 29.9)   \n# 10 High cholesterol          1.2 (0.3, 4.5) 2.6 (-2.9, 8)     9.6 (-11.6, 30.8)  \n# 11 Emergency grade                 1.2 (0.6, 2.4) 0.9 (-2.1, 3.9)   2.4 (-9.8, 14.6)   \n\n\n\n# Summarize survival sub-model\nnu &lt;- stats_mean$alphas\nnu_se &lt;- stats_sd$alphas\n\ncox_df &lt;- tibble(\n  variable = c(\n    \"EF&lt;= 50% (log-odds)\", \n    \"LV gradient (mmHg)\",\n    \"LV gradient slope (mmHg/yr)\",\n    \"LVMI (g/m^2)\",\n    \"LVMI slope (g/m^2/yr)\"\n  ),\n  HR = est_ci(nu, nu_se, r = 2),\n  pval = pval_calc(nu, nu_se)\n)\n# Print out table\ncox_df\n\n\n# Dynamic predictions\n# Set up data\nt0 &lt;- 3 # Set current time u\nnewdf &lt;- df[df$id == 3, ] # Get data from patient 3\nnewdf &lt;- newdf[newdf$obsyear &lt; t0, ] # Subset to times before t0\n# Indicate that the patient is alive at t0\nnewdf$status &lt;- 0\nnewdf$surv_time &lt;- t0\n\n\n# Predict longitudinal trajectories\npred_longit &lt;- predict(obj, newdata = newdf,\n                     times = seq(t0, 10, length.out = 10),\n                     return_newdata = TRUE)\n\n\n\n\n\n\n\n# Plot the predicted trajectories\npar(mfrow = c(1, 3))\n# In R, the default margins for plots, controlled by par(mar), \n# are c(5.1, 4.1, 4.1, 2.1), \n# representing bottom, left, top, and right margins \n\npar(mar = c(5, 5.2, 2, 1))\n\n\nplot(pred_longit, outcomes = 1:3, \n     ylab_long = c(\"Probability of reduced LVEF\", \"Valve gradient (mmHg)\", \n                   expression(\"LVMI (\" ~ g/m^2 ~ \")\")),\n     xlab = \"Time (years)\", xlim = c(0, 10), \n     cex_axis = 1.5,\n     cex_xlab = 1.8, cex_ylab_long = 1.8, \n     col_points = \"gray20\", col_line_long = \"black\",\n     fill_CI_long = \"gray80\")\n     \n# Predict survival probabilities\npred_surv &lt;- predict(obj, newdata = newdf, process = \"event\",\n                     times = seq(t0, 10, length.out = 10),\n                     return_newdata = TRUE)\n\npar(mfrow = c(1, 1))\n\nplot(pred_longit, pred_surv, outcomes = 1:3,\n     fun_event = function (x) 1 - x,\n     ylab_event = \"Survival Probabilities\",\n     ylab_long = c(\"Probability of reduced LVEF\", \"LV gradient (mmHg)\", \n                   expression(\"LVMI (\" ~ g/m^2 ~ \")\")),\n     pos_ylab_long = c(0.5, 40, 300),\n     col_points = \"gray20\", col_line_long = \"black\",\n     fill_CI_long = \"gray80\",\n     col_line_event = \"black\",\n     fill_CI_event = \"gray80\",\n     xlab = \"Time (years)\", xlim = c(0, 10), \n     cex_axis = 1.2,\n     cex_xlab = 1, cex_ylab_long = 1.2, cex_ylab_event = 1\n     )\n     \n# Prdicted survival at 10 years\npred_surv |&gt; \n  filter(surv_time == 10) |&gt; \n  dplyr::select(id, surv_time, pred_CIF, low_CIF, upp_CIF) |&gt; \n  mutate(\n    pred = round(1 - pred_CIF , 3),\n    lower = round(1 - upp_CIF, 3),\n    upper = round(1 - low_CIF, 3)\n  )"
  },
  {
    "objectID": "chapter13.html",
    "href": "chapter13.html",
    "title": "Chapter 13 - Composite Endpoints",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 13 - Composite Endpoints"
    ]
  },
  {
    "objectID": "chapter13.html#slides",
    "href": "chapter13.html#slides",
    "title": "Chapter 13 - Composite Endpoints",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 13 - Composite Endpoints"
    ]
  },
  {
    "objectID": "chapter13.html#base-r-code",
    "href": "chapter13.html#base-r-code",
    "title": "Chapter 13 - Composite Endpoints",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nShow the code\n#######################################################\n#  Section 13.2 RMT-IF analysis of the high-risk\n#   subgroup of the HF-ACTION study data\n#######################################################\n\n\n# install load the rmt package\ninstall.packages(\"rmt\")\nlibrary(rmt)\n##### Read in HF-ACTION DATA########\ndata(\"hfaction\")\n\ndata &lt;- hfaction\n\n# number of unique patients by treatment\n# group and overall\nuid &lt;- unique(data$patid)\nn &lt;- length(uid)\n\nuid1 &lt;- unique(data$patid[data$trt_ab==1])\nn1 &lt;- length(uid1)\n\nuid0 &lt;- unique(data$patid[data$trt_ab==0])\nn0 &lt;- length(uid0)\n\n\n## average number of hosps\nsum(data$status[data$trt_ab==1]==1)/n1\nsum(data$status[data$trt_ab==0]==1)/n0\n\n## total number of hosps\nsum(data$status==1)\n## total number of deaths\nsum(data$status==2)\n\n\n# extract variables for analysis by\n# rmtfit()\nid &lt;- data$patid\ntime &lt;- data$time\nstatus &lt;- data$status\ntrt &lt;- data$trt_ab\n\n\n\n###### Standard RMST analysis #################\nlibrary(survRM2)\n\n### create datasets for time to first event ###\ndata.TFE &lt;- data[!duplicated(data$patid),]\n\n### create datasets for overall mortality ###\n## death: status=2\ndata_death &lt;- data[data$status==2|data$status==0,]\n\n##RMST analysis for hospitalization-free survival and overall survival\nrmst2(data.TFE$time, data.TFE$status&gt;0, data.TFE$trt_ab, tau=3.97)\nrmst2(data_death$time, data_death$status&gt;0, data_death$trt_ab, tau=3.97)\n\n\n#### Kaplan-Meier (KM) curves for the hospitalization-free survival\n## (time to the first event) and overall survival by treatment group.\n\n# Fit KM curves by trt_ab\nobj.TFE &lt;- survfit(Surv(time,status&gt;0)~trt_ab,data=data.TFE)\nobj.death &lt;- survfit(Surv(time,status==2)~trt_ab,data=data_death)\n\n\n# Plot Fig 13.1\npar(mfrow=c(1,2))\nplot(obj.TFE,main=\"Hopitalization-free survival\",lty=1:2,ylab=\"Survival probabilities\",\n     xlab=\"Time (years)\", lwd=2)\nlegend(\"bottomleft\",c(\"Usual care\",\"Exercise training\"),lwd=2, lty=1:2)\nabline(v=4,lty=3,lwd=2)\n\nplot(obj.death,main=\"Overall survival\",lty=1:2,ylab=\"Survival probabilities\",\n     xlab=\"Time (years)\", lwd=2)\nlegend(\"bottomleft\",lty=1:2,c(\"Usual care\",\"Exercise training\"),lwd=2)\nabline(v=4,lty=3,lwd=2)\n\n########################\n# RMT-IF analysis\n########################\n\n\n# analyze the data using rmtfit()\nobj &lt;- rmtfit(rec(patid,time,status)~trt_ab,data=data)\n# Alternatively\n# obj=rmtfit(id,time,status,trt,type=\"recurrent\")\n\nsummary(obj, Kmax=1, tau=3.97)\n\n#############################################################\n# Graphical analysis of the HF-ACTION trial to\n# evaluate the effect of exercise training.\n###########################################################\n\npar(mfrow=c(1,2))\n# Kmax=4: to aggregate k=4,..., K\nbouquet(obj,Kmax=4,cex.group = 1.0,cex.lab=1.5,cex.axis=1.5,\n        xlab=\"Restricted mean win/loss time (years)\",\n        ylab=\"Follow-up time (years)\",group.label=F,ylim=c(0,4.2))\ntext(-0.8,4.15,paste(\"Usual care\"),cex=1.2)\ntext(0.8,4.15,paste(\"Exercise training\"),cex=1.2)\n\nplot(obj,conf=T,lwd=2, cex.lab=1.5,cex.axis=1.5,xlab=\"Follow-up time (years)\",\n     ylab=\"RMT-IF of training (years)\",main=\"\")\npar(mfrow=c(1,1))\n\n### LaTeX table ###\n\n### format to LATEX table\npval_fmt3=function(x){\n  if(x&lt;0.001){\n    return(\"$&lt;$0.001\")\n  }else{\n    return(round(x,3))\n  }\n}\n\n\nltable=NULL\n# aggregate the results for k=1,..., K\nhosp_sum=summary(obj,Kmax=1,tau=3.97)$tab\n# aggregate the results for k=4,..., K\nall_sum=summary(obj,Kmax=4,tau=3.97)$tab\n\nltable=c(\"&\",\"&\",\"&\",round(12*hosp_sum[1,1],2),\"&\",round(12*hosp_sum[1,2],2),\"&\",pval_fmt3(hosp_sum[1,4]),\"\\\\\")\n\nfor (i in 1:6){\n  tmp=c(\"&\",i,\"&&\",round(12*all_sum[i,1],2),\"&\",round(12*all_sum[i,2],2),\"&\",pval_fmt3(all_sum[i,4]),\"\\\\\")\n  ltable=rbind(ltable,tmp)\n}\n\nltable[5,2]=\"4+\"\nltable[6:7,2]=\"\"\n\nrownames(ltable)=c(\"Hopitalization\",\"\",\"\" ,\"\",\"\",\"Death\",\"Overall\")\n\nnoquote(ltable)\n\n\n\n\n\n##################################################################\n# This code is related to the numerical results in chapter 13   ##\n##################################################################\n\n\n# The real data used in Section 13.3.7 are protected by data sharing agreement.\n# Below is a similar analysis based on a subset of the data using the \"WR\" package.\n# The analysis illustrates the use of the pwreg() function for fitting Pocock's PW\n# regression model and score.proc() function for plotting standardized score processes\n\n\n# An example: HF-ACTION study\n\n# We consider a dataset from the HF-ACTION study consisting of 451 non-ischemic heart failure\n# patients. The study was conducted between April 2003 through Feb 2007 at 82 sites in the USA,\n# Canada, and France (O'Connor et al., 2009). The study objective was to assess the effect of\n# adding aerobic exercise training to usual care on the patients CV outcomes. The primary\n# endpoint was a composite of all-cause death and all-cause hospitalization.\n\n#######################################################################\n# We first load the WR package and the analysis dataset non_ischemic\n#######################################################################\n\n# If the \"WR\" hasn't been installed, need to download and install it\n# from CRAN\ninstall.packages(\"WR\")\nlibrary(WR)\n#&gt; Loading required package: survival\nhead(non_ischemic)\n#&gt;   ID time status trt_ab age sex Black.vs.White Other.vs.White   bmi\n#&gt; 1  1  221      2      0  62   1              0              0 25.18\n#&gt; 2  1  383      0      0  62   1              0              0 25.18\n#&gt; 3  2   23      2      0  75   1              1              0 22.96\n#&gt; 4  2 1400      0      0  75   1              1              0 22.96\n#&gt; 5  5    7      2      0  48   1              1              0 34.37\n#&gt; 6  5   10      1      0  48   1              1              0 34.37\n#&gt;   bipllvef hyperten COPD diabetes acei betab smokecurr\n#&gt; 1    32.24        0    0        0    0     1         1\n#&gt; 2    32.24        0    0        0    0     1         1\n#&gt; 3    21.71        1    0        0    0     1         0\n#&gt; 4    21.71        1    0        0    0     1         0\n#&gt; 5    22.97        1    0        0    0     1         0\n#&gt; 6    22.97        1    0        0    0     1         0\n\n\n# Re-label the covariates with informative names.\n\ncolnames(non_ischemic)[4:16]=c(\n  \"Training vs Usual\",\"Age (year)\",\"Male vs Female\",\"Black vs White\",\n  \"Other vs White\", \"BMI\",\"LVEF\",\"Hypertension\",\"COPD\",\"Diabetes\",\n  \"ACE Inhibitor\",\"Beta Blocker\", \"Smoker\"\n)\n\n#Compute the sample size the median length of follow-up.\n\n# sample size\nlength(unique(non_ischemic$ID))\n#&gt; [1] 451\n# median length of follow-up time\nmedian(non_ischemic$time[non_ischemic$status&lt;2])/30.5\n#&gt; [1] 31.63934\n\n#So we have n=451 unique patients with a median follow-up of 31.6 months.\n\n\n################################################################\n# Next, we use the pwreg() function to fit the PW model:\n################################################################\n\n# get the number of rows and number of covariates.\nnr &lt;- nrow(non_ischemic)\np &lt;- ncol(non_ischemic) - 3\n\n# extract ID, time, status and covariates matrix Z from the data.\n# note that: ID, time and status should be column vector.\n# covariatesZ should be (nr, p) matrix.\nID &lt;- non_ischemic[,\"ID\"]\ntime &lt;- non_ischemic[,\"time\"]\nstatus &lt;- non_ischemic[,\"status\"]\nZ &lt;- as.matrix(non_ischemic[,4:(3+p)], nr, p)\n\n\n# pass the parameters into the function\npwreg.obj &lt;- pwreg(ID=ID, time=time, status=status, Z=Z)\n\nprint(pwreg.obj)\n#&gt; Call:\n#&gt; pwreg(time = time, status = status, Z = Z, ID = ID)\n#&gt;\n#&gt; Proportional win-fractions regression models for priority-adjusted composite endpoint\n#&gt;\n#&gt;\n#&gt;\n#&gt; Total number of pairs: 101475\n#&gt; Wins-losses on death:  7644 (7.5%)\n#&gt; Wins-losses on non-fatal event:  78387 (77.2%)\n#&gt; Indeterminate pairs 15444 (15.2%)\n#&gt;\n#&gt; Newton-Raphson algorithm converged in 5 iterations.\n#&gt;\n#&gt; Overall test: chisq test with 13 degrees of freedom;\n#&gt;  Wald statistic 24.9 with p-value 0.02392931\n#&gt;\n#&gt; Estimates for Regression parameters:\n#&gt;\n#&gt;                     Estimate         se z.value p.value\n#&gt; Training vs Usual  0.1906687  0.1264658  1.5077 0.13164\n#&gt; Age (year)        -0.0128306  0.0057285 -2.2398 0.02510 *\n#&gt; Male vs Female    -0.1552923  0.1294198 -1.1999 0.23017\n#&gt; Black vs White    -0.3026335  0.1461330 -2.0709 0.03836 *\n#&gt; Other vs White    -0.3565390  0.3424360 -1.0412 0.29779\n#&gt; BMI               -0.0181310  0.0097582 -1.8580 0.06316 .\n#&gt; LVEF               0.0214905  0.0086449  2.4859 0.01292 *\n#&gt; Hypertension      -0.0318291  0.1456217 -0.2186 0.82698\n#&gt; COPD              -0.4023069  0.2066821 -1.9465 0.05159 .\n#&gt; Diabetes           0.0703990  0.1419998  0.4958 0.62006\n#&gt; ACE Inhibitor     -0.1068201  0.1571317 -0.6798 0.49662\n#&gt; Beta Blocker      -0.5344979  0.3289319 -1.6250 0.10417\n#&gt; Smoker            -0.0602350  0.1682826 -0.3579 0.72039\n#&gt; ---\n#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#&gt;\n#&gt;\n#&gt; Point and interval estimates for for win ratios:\n#&gt;\n#&gt;                   Win Ratio 95% lower CL 95% higher CL\n#&gt; Training vs Usual 1.2100585    0.9444056     1.5504374\n#&gt; Age (year)        0.9872513    0.9762288     0.9983983\n#&gt; Male vs Female    0.8561648    0.6643471     1.1033663\n#&gt; Black vs White    0.7388699    0.5548548     0.9839127\n#&gt; Other vs White    0.7000951    0.3578286     1.3697431\n#&gt; BMI               0.9820323    0.9634287     1.0009952\n#&gt; LVEF              1.0217231    1.0045572     1.0391823\n#&gt; Hypertension      0.9686721    0.7281543     1.2886357\n#&gt; COPD              0.6687755    0.4460178     1.0027865\n#&gt; Diabetes          1.0729362    0.8122757     1.4172433\n#&gt; ACE Inhibitor     0.8986873    0.6604773     1.2228110\n#&gt; Beta Blocker      0.5859634    0.3075270     1.1164977\n#&gt; Smoker            0.9415433    0.6770144     1.3094312\n#\n# The output consists of three parts. The first part presents some descriptive statistics\n# on the proportions of win-loss status among all (n2)=101,475\n# pairs. According to the output, 7.5% of them are determined by death;\n# 77.2% by hospitalization, and the remaining 7.2% are indeterminate.\n# It also reports an overall (Wald) test with p-value 0.024, suggesting that,\n# at the conventional 0.05 level, the 13 covariates are significantly associated\n# with the composite outcome.\n#\n# The second part presents a table for the estimates and standard errors of the regression\n# coefficient, along with their corresponding p -value for testing the coefficient being\n# zero. The third part is perhaps the most informative, tabulating the estimated win ratios\n# (exponential of the regression coefficients) and their associated 95% confidence intervals.\n# We can see that a patient in exercise training is 21% more likely to have a better\n#  priority-adjusted composite outcome than one in usual care. However, this difference\n# is statistically not significant. In addition, younger age, white race, higher LVEF are\n# significantly associated with more favorable outcomes than otherwise, while the beneficial\n# effects of low BMI and absence of COPD history are border-line significant.\n#\n\n\n# To assess the effect of race on the composite outcome, we test the null hypothesis\n# H0:\\beta_4=\\beta_5=0.\n# We conduct a 2-df Chi-square Wald test based on (\\beta_4,\\beta_5)\n\n\n  #extract estimates of (\\beta_4,\\beta_5)\n  beta &lt;- matrix(pwreg.obj$beta[4:5])\n  #extract estimated covariance matrix for (\\beta_4,\\beta_5)\n  Sigma &lt;- pwreg.obj$Var[4:5,4:5]\n  #compute chisq statistic in quadratic form\n  chistats &lt;- t(beta) %*% solve(Sigma) %*% beta\n\n# compare the Wald statistic with the reference\n# distribution of chisq(2) to obtain the p-value\n1 - pchisq(chistats, df = 2)\n#&gt;           [,1]\n#&gt; [1,] 0.1016988\n\n#  The p -value is 0.102. So the overall effect of race on the composite outcome is\n# non-significant.\n\n\n#  Finally, we use the score.proc() function to plot the standardized score process\n# for each covariate:\n\n  score.obj &lt;- score.proc(pwreg.obj)\n  print(score.obj)\n#&gt; This object contains two components:\n#&gt;  't': an l-vector of times\n#&gt;  'score': a p-by-l matrix whose k'th row is the standardized score process for the k'th\n  # covariate\n#&gt;           as a function of t\n#&gt;\n#&gt; Use 'plot(object,k=k)' to plot the k'th score process.\n\noldpar &lt;- par(mfrow = par(\"mfrow\"))\npar(mfrow = c(4,4))\nfor(i in c(1:13)){\n  plot(score.obj, k = i)\n}\npar(oldpar)"
  },
  {
    "objectID": "chapter15.html",
    "href": "chapter15.html",
    "title": "Chapter 15 - Machine Learning in Survival Analysis",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)"
  },
  {
    "objectID": "chapter15.html#slides",
    "href": "chapter15.html#slides",
    "title": "Chapter 15 - Machine Learning in Survival Analysis",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)"
  },
  {
    "objectID": "chapter15.html#base-r-code",
    "href": "chapter15.html#base-r-code",
    "title": "Chapter 15 - Machine Learning in Survival Analysis",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nShow the code\n##################################################################\n# This code generates all numerical results in chapter 15.     ##\n##################################################################\n\n\n# library(\"glmpath\")\nlibrary(\"glmnet\")\nlibrary(survival)\n# read in the complete data\ngbc &lt;- read.table(\"Data//German Breast Cancer Study//gbc.txt\")\n\n# subset to first event data\n# Sort the data by time within each id\no &lt;- order(gbc$id,gbc$time)\ngbc &lt;- gbc[o,]\n# get the first row for each id\ndata.CE &lt;- gbc[!duplicated(gbc$id),]\n\n#set status=1 if status==2 or 1\ndata.CE$status &lt;- (data.CE$status &gt; 0 ) + 0\n\n# create a binary variable for age&lt;=40 years\ndata.CE$age40 &lt;- (data.CE$age &lt;= 40) + 0\n\n\n\nn &lt;- nrow(data.CE)\nhead(data.CE)\n\n## select training set\n# N=400\nset.seed(1234)\nind &lt;- sample(1:n)[1:400]\ntrain &lt;- data.CE[ind,]\ntest &lt;- data.CE[-ind,]\n\n# Predictor list for Cox-lasso\npred_list &lt;- c(\"hormone\", \"age40\", \"meno\", \"size\", \"grade\",\n            \"nodes\", \"prog\", \"estrg\")\n\n# covariate matrix \nZ &lt;- as.matrix(train[,pred_list])\n\n# time and status variables\ntime &lt;- train$time\nstatus &lt;- train$status\n\n# dimension of covariate matrix\ndim(Z)\n# 400x 8\n\n# compute the covariate path as a function of lambda\n# alpha=1: L_1 penalty (lasso)\nobj &lt;- glmnet(Z,Surv(time, status), family=\"cox\", alpha = 1)\nsummary(obj)\n\n# compute 10-fold (default) cross-validation\nobj.cv &lt;- cv.glmnet(Z,Surv(time, status), family=\"cox\", alpha = 1)\n\n\n# Figure parameters\npar(mfrow = c(1,2))\n# par(cex = 1.2)\n\n# plot the covariate paths as\n# a function of log-lambda\nlibrary(plotmo) # for plot_glmnet\nplotmo::plot_glmnet(obj, lwd=2)\n\n# plot(obj,xvar=\"lambda\",lwd=2,label=TRUE)\n\n# plot the the validation error (partial-likelihood deviance)\n# as a function of log-lambda\nplot(obj.cv)\n\n# the optimal lambda\nobj.cv$lambda.min\n\nlog(obj.cv$lambda.min)\n\n# the beta at optimal lambda\nbeta &lt;- coef(obj.cv, s = \"lambda.min\")\n# the non-zero coefficients\nbeta.selected &lt;- beta[abs(beta[,1])&gt;0,]\n# print out the non-zero coefficients\nbeta.selected\n# number of non-zero coefficients\nlength(beta.selected)\n\n\n# Refit the training data using the variables selected\nselected &lt;- names(beta.selected)\nobj &lt;- coxph(Surv(train$time, train$status) ~ as.matrix(train[,selected]))\n\n###############################################################################\n## A function that takes on a coxph object obj and a (n x p) test covariate\n## matrix Z and outputs the predicted survival function\n## Output:\n### St: (n x m) matrix with the ith row the predicted survival rates for the\n###  ith subject;\n### t: m-vector of times.\n###############################################################################\npredsurv_cox &lt;- function(obj, Z){\n  beta=obj$coefficients\n  bhaz=basehaz(obj,centered=F)\n  L=bhaz$hazard\n  t=c(0, bhaz$time)\n  St=cbind(rep(1,nrow(Z)),exp(-exp(Z%*%beta)%*%t(L)))\n  return(list(St=St,t=t))\n}\n\n## Get the predicted survival rates for the test set by Cox-lasso \npred_surv &lt;- predsurv_cox(obj, Z=as.matrix(test[,selected]))\n\nSt &lt;- pred_surv$St\nt &lt;- pred_surv$t\n\n\n## Get the KM estimates for censoring distribution\nG_obj &lt;- summary(survfit(Surv(time, 1-status)~1, data=test))\ntc &lt;- c(0,G_obj$time)\nGtc &lt;- c(1,G_obj$surv)\n\n#####################################################\n# A function calculating the Brier score BS(tau)\n# Input:\n#   tau: time at which the score is evaluated\n#   (time, status): observed test outcomes\n#   St,t: predicted survival rates\n#   Gtc,tc: KM estimates for censoring distributions\n######################################################\nBSfun=function(tau,time,status,St,t,Gtc,tc){\n  \n  n=length(time)\n  BSvec=rep(NA,n)\n  \n  pos=sum(t&lt;=tau)\n  \n  for (i in 1:n){\n    X_i=time[i]\n    S_i=St[i,pos]\n    \n    G_i=ifelse(X_i&lt;=tau&&status[i]==1, \n               Gtc[sum(tc&lt;=X_i)], \n               Gtc[sum(tc&lt;=tau)])\n    \n    BSvec[i]=ifelse(X_i&lt;=tau&&status[i]==1, \n                    S_i^2/G_i, ifelse(\n                      X_i&gt;tau,(1-S_i)^2/G_i,0\n                     )\n                    )\n  \n  }\n  return(mean(BSvec,na.rm=T))\n  \n}  \n\n# Compute the Brier score at tau=12 to 60 months\n# under Cox-lasso\ntau_list &lt;- 12:60\nBS_tau &lt;- rep(NA,length(tau_list))\nfor(i in 1:length(tau_list)){\n  BS_tau[i] &lt;- BSfun(tau=tau_list[i],test$time,test$status,St,t,Gtc,tc)\n}\n\nplot(tau_list,BS_tau,type='l',lwd=2)\n\n# Full Cox model\nobj_full &lt;- coxph(Surv(train$time, train$status)~as.matrix(train[,pred_list]))\n\n# Get the predicted survival rates\npred_surv_full &lt;- predsurv_cox(obj_full, Z=as.matrix(test[,pred_list]))\nSt_full &lt;- pred_surv_full$St\nt_full &lt;- pred_surv_full$t\n\n# Compute the Brier score at tau=12 to 60 months\n# under Cox-full\nBS_tau_full &lt;- rep(NA,length(tau_list))\nfor(i in 1:length(tau_list)){\n  BS_tau_full[i] &lt;- BSfun(tau=tau_list[i],test$time,test$status,St_full,t_full,Gtc,tc)\n}\n\n  \n\n##############################\n# Survival trees             #\n##############################\n\n\nlibrary(rpart)\nlibrary(rpart.plot)\n\n\n### Build survival tree with cross-validation error ###\nset.seed(12345)\n\n# Conduct 10-fold cross-validation (xval = 10),\n# with minimum terminal node size 2 (minbucket = 2)\nobj &lt;- rpart(Surv(time, status) ~ hormone+meno+size+grade+nodes+ \n              prog+estrg+age,\n             control = rpart.control(xval = 10, minbucket = 2, cp=0),\n             data = train)\nprintcp(obj)\n\n#             CP nsplit rel.error  xerror   xstd\n# 1  0.07556835      0   1.00000 1.00411 0.046231\n# 2  0.03720019      1   0.92443 0.96817 0.047281\n# 3  0.02661914      2   0.88723 0.95124 0.046567\n# 4  0.01716925      3   0.86061 0.92745 0.046606\n# 5  0.01398306      4   0.84344 0.92976 0.047514\n# 6  0.01394869      5   0.82946 0.93941 0.048404\n# 7  0.01055028      9   0.77120 0.97722 0.052133\n# 8  0.01053135     10   0.76065 1.00140 0.054295\n\n# summary(obj)\n\n\n# cross-validation results\ncptable &lt;- obj$cptable\n# complexity parameter values\nCP &lt;- cptable[, 1]\n# obtain the optimal parameter\ncp.opt &lt;- CP[which.min(cptable[, 4])]\n# Prune the tree \nfit &lt;- prune(obj, cp = cp.opt)\n\n\n\npar(mfrow=c(1,2))\n# plot the pruned tree structure\nrpart.plot(fit)\n# plot the KM curves for the terminal nodes\nkm &lt;- survfit(Surv(time, status) ~ fit$where, train)\nplot(km, lty = 1:4, mark.time = FALSE,\n       xlab = \"Years\", ylab = \"Progression\",lwd=2,cex.lab=1.2,cex.lab=1.2)\nlegend(\"bottomleft\", paste('Node', sort(unique(fit$where))), lty = 1:4,lwd=2,cex=1.2)\n\n\n# Get the KM estimates for the outcome in each terminal node\ntmp &lt;- summary(km)\ntmp.strata &lt;- as.integer(sub(\".*=\", \"\", tmp$strata))  \ntmp.t &lt;- tmp$time\ntmp.surv &lt;- tmp$surv\n\n# Number of terminal nodes\nTN &lt;- unique(tmp.strata)\nN &lt;- length(TN)\n\n# Combine the predicted survival rates together,\n# as functions of t\nt &lt;- sort(unique(tmp.t))\nm &lt;- length(t)\nfitted_surv=matrix(NA,m,N)\nfor (j in 1:m){\n  tj &lt;- t[j]\n  for (k in 1:N){\n    tk &lt;- c(0,tmp.t[tmp.strata==TN[k]])\n    survk &lt;- c(1,tmp.surv[tmp.strata==TN[k]])\n    fitted_surv[j,k] &lt;- survk[sum(tk&lt;=tj)]\n  }\n}\n\n\n\n# Get the terminal node prediction\n# for the test data\nlibrary(treeClust)\ntest_term &lt;- rpart.predict.leaves(fit, test)\n\nn &lt;- length(test_term)\n\nSt_tree &lt;- matrix(NA, n, m)\nfor (k in 1:N){\n  ind &lt;- which(test_term==TN[k])\n  St_tree[ind,] &lt;- matrix(fitted_surv[,k], nrow=length(ind), \n                       ncol=m, byrow=TRUE)\n}\n\n\n\n## Get the KM estimates for censoring distribution\nG_obj &lt;- summary(survfit(Surv(time, 1-status)~1, data=test))\ntc &lt;- c(0,G_obj$time)\nGtc &lt;- c(1,G_obj$surv)\n\n# Compute the Brier score at tau=12 to 60 months\n# under the pruned survival tree\ntau_list &lt;- 12:60\nBS_tau_tree &lt;- rep(NA,length(tau_list))\nfor(i in 1:length(tau_list)){\n  BS_tau_tree[i] &lt;- BSfun(tau=tau_list[i],test$time,test$status,St_tree,t,Gtc,tc)\n  \n}\n\n# Plot the Bier score curves for Cox-lasso, Cox-full, and survival tree\npar(mfrow=c(1,1))\n\nplot(tau_list/12,BS_tau_tree,type='l',lwd=2,col=\"red\",cex.axis=1.2,\n     cex.lab=1.2,xlab=\"t (years)\", ylab=\"BS(t)\",ylim=c(0,0.25))\nlines(tau_list/12,BS_tau,lty=1,lwd=2,col=\"blue\")\nlines(tau_list/12,BS_tau_full,lty=1,lwd=2,col=\"black\")\nlegend(\"bottomright\",1,col=c(\"red\",\"blue\",\"black\"),lwd=2,\n       c(\"Survival Tree\",\"Cox-lasso\",\"Cox-full\"),cex=1.2)"
  },
  {
    "objectID": "chapter3.html",
    "href": "chapter3.html",
    "title": "Chapter 3 - Nonparametric Estimation and Testing",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 3 - Nonparametric Estimation and Testing"
    ]
  },
  {
    "objectID": "chapter3.html#slides",
    "href": "chapter3.html#slides",
    "title": "Chapter 3 - Nonparametric Estimation and Testing",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 3 - Nonparametric Estimation and Testing"
    ]
  },
  {
    "objectID": "chapter3.html#base-r-code",
    "href": "chapter3.html#base-r-code",
    "title": "Chapter 3 - Nonparametric Estimation and Testing",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nShow the code\n##################################################################\n# This code generates all numerical results in  chapter 3.      ##\n##################################################################\n\n###################################################\n# Figure 3.3 and Table 3.2                 \n# Nelsen-Aalen estimator of cumulative hazard function\n# for the rat study\n###################################################\n\nlibrary(survival)\n# ##################################################\n# Description of \"rats\" dataset\n# \n# Rat treatment data from Mantel et al. Three rats were chosen from each of 100 litters, \n# one of which was treated with a drug, and then all followed for tumor incidence.\n# Usage\n# \n# \n# \n# Format\n# litter:   litter number from 1 to 100\n# rx:   treatment,(1=drug, 0=control)\n# time: time to tumor or last follow-up\n# status:   event status, 1=tumor and 0=censored\n# sex:  male or female\n# \n# N. Mantel, N. R. Bohidar and J. L. Ciminera. Mantel-Haenszel analyses of litter-matched \n# time to response data, with modifications for recovery of interlitter information. \n# Cancer Research, 37:3863-3868, 1977.\n##############################################################\n\nrats &lt;- read.table(\"Data//Rat Tumorigenicity Study//rats.txt\",header=T)\n\nhead(rats)\n\n#subset to treatment arm\nrats.rx &lt;- rats[rats$rx==1,]\n\n#X and delta\ntime &lt;- rats.rx$time\nstatus &lt;- rats.rx$status\n\n#ordered unique  event times\nts &lt;- unique(sort(time[status==1]))\nm &lt;- length(ts)\nts\n#numbers of failures at each point in ts\nds &lt;- table(time[status==1])\n##numbers at risk at each point in ts\nns &lt;- rep(NA,m)\n##Nelsen-Aalen estimator\n## for dLambda \ndL &lt;- rep(NA,m)\n## and Lambda\nL &lt;- rep(NA,m)\nfor (j in 1:m){\n  ns[j] &lt;- sum(time&gt;=ts[j])\n  dL[j] &lt;- ds[j]/ns[j]\n  L[j] &lt;- sum(dL[1:j])\n}\n\nresults &lt;- cbind(ts,ds,ns,dL,L)\n#print the table\nround(results,3)\n\n#plot the estimated cumulative hazard function\npar(mfrow=c(1,1))\nplot(stepfun(ts,c(0,L)),do.points = F,ylim=c(0,0.4),xlim=c(0,120), lwd=2, \n     frame.plot=FALSE, xlab=\"Time (days)\",ylab=\"Cumulative hazard function\",\n     main=\"\", cex.lab=1.5, cex.axis=1.5)\n\n\n\n###################################################\n# Table 3.3                 \n# Kaplan-Meier (KM) estimator of survival function\n# for the rat study\n###################################################\n\n#csurv (conditional survival): 1-d_j/n_j\ncsurv &lt;- 1-dL\n#variance of csurv by Greenwoods's formula\nvar.csurv &lt;- ds/(ns*(ns-ds))\n\n#KM estimates of survival function\nKMsurv &lt;- rep(NA,m)\n##Greenwoods formula for se\nse &lt;- rep(NA,m)\n\n# Compute the KM estimates and Greenwood's se\nfor (j in 1:m){\n  KMsurv[j] &lt;- prod(csurv[1:j])\n  se[j] &lt;- KMsurv[j]*sqrt(sum(var.csurv[1:j]))\n}\n\nresults2 &lt;- cbind(ts,ds,ns,csurv,KMsurv,se)\n#print the table\nround(results2,3)\n  \n\n\n\n###################################################\n# Figure 3.4                 \n# Kaplan-Meier (KM) estimator of survival function\n# for the rat study\n###################################################\n\nobj &lt;- survfit(Surv(time,status) ~ 1, data = rats.rx, conf.type = \"log-log\")\n\nsummary(obj)\n\n# plot the estimated survival function\nplot(obj, ylim = c(0,1), xlim = c(0, 100), lwd = 2, frame.plot = FALSE,\n     xlab = \"Time (days)\", ylab = \"Tumor-free probabilities\", main = \"\")\n\nlegend(1, 0.2, c(\"Kaplan-Meier curve\", \"95% Confidence limits\"),\n       lty = 1:2, lwd = 2)\n\n\n###################################################\n# Table 3.4\n###########################################\n# install.packages(\"gtsummary\")\nlibrary(gtsummary)\n\n# A single-group KM model\nobj &lt;- survfit(Surv(time, status) ~ 1, data = rats.rx)\n\n# 1) Summaries at specific times\ntbl_time &lt;- tbl_survfit(\n  x = obj,\n  times = seq(40, 100, by = 20),\n  label_header = \"{time} days\"\n)\n\ntbl_time\n\n# install.packages(\"ggsurvfit\")\nlibrary(ggsurvfit)\nobj &lt;- survfit(Surv(time, status) ~ 1, data = rats.rx)\n\n# Create a KM plot with confidence intervals and an at-risk table\nggsurvfit(obj) +\n  add_confidence_interval() +  # shaded 95% CI region\n  add_risktable() +  # Show risk table \n  scale_x_continuous(breaks= seq(0, 100, by = 20)) + # x-axis breaks\n  ylim(0, 1) + # y-axis limits\n  labs(\n    x = \"Time (days)\",\n    y = \"Tumor-free probabilities\"\n  ) +\n  theme_minimal()\n\nggsave(\"images//rats_KM_gg.png\", width = 7.5, height = 4)\nggsave(\"images//rats_KM_gg.eps\", device = cairo_ps, width = 7.5, height = 4)\n\n#################################################\n#   log-rank test for rat study\n#   comparing treatment and control\n#################################################\n#dataset\nhead(rats)\n\n# Log-rank test on treatment difference in tumorigenicity\nobj &lt;- survdiff(Surv(time,status)~ rx + strata(sex),\n          data = rats, rho = 0)\n# Print out test results\nobj\n#&gt; Call:\n#&gt; survdiff(formula = Surv(time, status) ~ rx + strata(sex), data = rats, \n#&gt;     rho = 0)\n#&gt; \n#&gt;        N Observed Expected (O-E)^2/E (O-E)^2/V\n#&gt; rx=0 200       21     28.9      2.16      6.99\n#&gt; rx=1 100       21     13.1      4.77      6.99\n#&gt; \n#&gt;  Chisq= 7  on 1 degrees of freedom, p= 0.008 \n \n \nobj$pvalue\n\n####\n# Tidy tools\n#\n\n# A two-group KM model\nobj &lt;- survfit(Surv(time, status) ~ rx, data = rats)\n\n# Summaries at specific times with labeled treatment groups\ntbl_surv &lt;- tbl_survfit(\n  x = obj,                         # Provide the fitted survfit object\n  times = seq(40, 100, by = 20),   # Time points for survival rates\n  label_header = \"{time} days\",    # Column label: \"xx days\"\n  label = list(rx ~ \"Treatment\")   # Rename 'rx' to 'Treatment'\n)\n\n# Print out the table\ntbl_surv\n\n## graphics\n\n# Load required packages\nlibrary(ggsurvfit)  # For Kaplan-Meier survival curves\nlibrary(ggplot2)    # For plot customization\n\n# Use survfit2 as recommended by ggsurvfit\nobj2 &lt;- survfit2(Surv(time, status) ~ rx, data = rats)\n\n\n# Create a KM plot with confidence intervals and an at-risk table\nggsurvfit(obj2, linetype_aes = TRUE, linewidth = 1) +  # Use line types instead of colors\n  add_pvalue(caption = \"Log-rank {p.value}\") +  # Add log-rank test p-value\n  add_risktable(                    \n    risktable_stats = \"n.risk\",  # Include only numbers at risk\n    theme = list(\n      theme_risktable_default(),  # Apply default risk table theme\n      scale_y_discrete(labels = c('Drug', 'Control'))  # Properly label treatment groups\n    )\n  ) +  \n  labs(\n    x = \"Time (days)\",  # Label for X-axis\n    y = \"Tumor-free probabilities\"  # Label for Y-axis\n  ) +\n  scale_linetype_manual(\n    values = c(2, 1),  # Use different line types (dashed for Control, solid for Drug)\n    labels = c(\"Control\", \"Drug\")  # Label groups in the legend\n  ) +  \n  scale_color_discrete(\n    labels = c(\"Control\", \"Drug\")  # Ensure correct labeling of groups\n  ) +  \n  # scale_x_continuous(breaks = seq(0, 100, by = 20), expand = c(0, 0.01)) +  # X-axis breaks (commented out)\n  scale_y_continuous(\n    limits = c(0, 1),  # Ensure Y-axis covers full probability range\n    breaks = seq(0, 1, by = 0.2),  # Set Y-axis tick marks at 0, 0.2, ..., 1\n    expand = c(0, 0)  # Prevent extra padding on Y-axis\n  ) +  \n  theme_classic() +\n  theme(\n    legend.position = \"top\", # Move legend to the top\n    legend.key.width = unit(1, \"cm\"), # Make legend key longer\n    panel.grid.major.y = element_line(), # Add horizontal grid lines\n    legend.text = element_text(size = 10), # Increase legend text size\n    caption = element_text(size = 10)  # Increase caption text size\n  )\n\nggsave(\"images//rats_KM_gg2.png\", width = 7, height = 5)\nggsave(\"images//rats_KM_gg2.eps\", device = cairo_ps, width = 7, height = 5)\n\n##############################################\n# GBC study: Figure 3.7 and related test results \n#############################################\n#read in the complete data\ngbc &lt;- read.table(\"Data//German Breast Cancer Study//gbc.txt\")\n\n#subset to first event data\n#Sort the data by time within each id\no &lt;- order(gbc$id,gbc$time)\ngbc &lt;- gbc[o,]\n#get the first row for each id\ndata.CE &lt;- gbc[!duplicated(gbc$id),]\n\n#set status=1 if status==2 or 1\ndata.CE$status &lt;- (data.CE$status&gt;0)+0\n\n\n\n################################################\n# Figure 3.7  Plot the KM curves by hormonal group \n# stratified by menopausal status for GBC study\n################################################\n\npar(mfrow=c(1,3))\n## overall\nobj &lt;- survfit(Surv(time,status)~hormone,data=data.CE)\nplot(obj, xlim=c(0,80),lwd=2,frame=F, lty=c(2,1),\n     xlab=\"Time (months)\",ylab=\"Relaspe-free survival probabilities\",main=\"Overall\",\n     cex.lab=1.5,cex.axis=1.5,cex.main=1.5)\nlegend(1,0.2,lty=2:1,c(\"No Hormone\",\"Hormone\"),\n       lwd=2,cex=1.5)\n\n## pre-menopausal\nobj.pre &lt;- survfit(Surv(time,status)~hormone,data=data.CE[data.CE$meno==1,])\nplot(obj.pre, xlim=c(0,80),lwd=2,frame=F, lty=c(2,1),\n     xlab=\"Time (months)\",ylab=\"Relaspe-free survival probabilities\",main=\"Pre-Menopausal\",\n     cex.lab=1.5,cex.axis=1.5,cex.main=1.5)\nlegend(1,0.2,lty=2:1,c(\"No Hormone\",\"Hormone\"),\n       lwd=2,cex=1.5)\n\n## post-menopausal\nobj.post&lt;- survfit(Surv(time,status)~hormone,data=data.CE[data.CE$meno==2,])\nplot(obj.post, xlim=c(0,80),lwd=2,frame=F, lty=c(2,1),\n     xlab=\"Time (months)\",ylab=\"Relaspe-free survival probabilities\",main=\"Post-Menopausal\",\n     cex.lab=1.5,cex.axis=1.5,cex.main=1.5)\nlegend(1,0.2,lty=2:1,c(\"No Hormone\",\"Hormone\"),\n       lwd=2,cex=1.5)\n\n\n\n## Stratified log-rank test (by menopausal status)\nsurvdiff(Surv(time, status) ~ hormone + strata(meno),\n         data = data.CE)\n## Unstratified log-rank test\nsurvdiff(Surv(time, status) ~ hormone,\n         data = data.CE)"
  },
  {
    "objectID": "chapter4.html",
    "href": "chapter4.html",
    "title": "Chapter 4 - Cox Proportional Hazards Regression",
    "section": "",
    "text": "\\[\n\\def\\T{\\mathrm{T}}\n\\]",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 4 - Cox Proportional Hazards Regression"
    ]
  },
  {
    "objectID": "chapter4.html#slides",
    "href": "chapter4.html#slides",
    "title": "Chapter 4 - Cox Proportional Hazards Regression",
    "section": "Slides",
    "text": "Slides\nLecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 4 - Cox Proportional Hazards Regression"
    ]
  },
  {
    "objectID": "chapter4.html#base-r-code",
    "href": "chapter4.html#base-r-code",
    "title": "Chapter 4 - Cox Proportional Hazards Regression",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nShow the code\n##################################################################\n# This code generates all numerical results in chapter 4.      ##\n##################################################################\n\n\n###################################################\n# Section 4.2.6 (Figure 4.2)                \n# Cox proportional hazards model on GBC study data\n###################################################\nlibrary(survival)\n##############################################\n# GBC study\n#############################################\n# read in the complete data\ngbc &lt;- read.table(\"Data//German Breast Cancer Study//gbc.txt\")\n\n# subset to first event data\n# Sort the data by time within each id\no &lt;- order(gbc$id,gbc$time)\ngbc &lt;- gbc[o,]\n# get the first row for each id\ndf &lt;- gbc[!duplicated(gbc$id),]\n\n# set status=1 if status==2 or 1\ndf$status &lt;- (data.CE$status&gt;0)+0\n\n\n# fit the Cox proportional hazards model\n## preparation\n\ndf$hormone &lt;- factor(df$hormone)\ndf$meno &lt;- factor(df$meno)\ndf$grade &lt;- factor(df$grade)\n  \nobj &lt;- coxph(Surv(time, status)~ hormone + meno + age + size + grade\n           + prog + estrg, data = df)\n\n# beta estimates\nobj$coefficients\n# variance matrix\nobj$var\n\n#summarize results\nsummary(obj)\n\n# Wald test on tumor grade\n# H_0: beta_5=beta_6=0\nbeta_q &lt;- obj$coefficients[5:6]\nSigma_q &lt;- obj$var[5:6,5:6]\n\n#chisq statistic with 2 d.f.\nchisq2 &lt;- t(beta_q) %*% solve(Sigma_q) %*% beta_q\n#p-value\npval &lt;- 1 - pchisq(chisq2, 2)\n\n\n### explore forest plot\nlibrary(survminer)\nggforest(obj, data = data.CE)\n####\n\n\n### Get the Breslow estimates of baseline\n### cumulative hazard function\nLambda0 &lt;- basehaz(obj,centered = FALSE)\n#plot the baseline hazard function\npar(mfrow=c(1,1))\nplot(stepfun(Lambda0$time,c(0,Lambda0$hazard)),\n     do.points=F,xlim=c(0,100),ylim=c(0,0.8),lwd=2,frame.plot=F, \n     xlab=\"Time (months)\",ylab=\"Baseline cumulative hazard function\", \n     main=\"\")\n\n\n\n\n\n############################\n# Residual analysis\n# (Figures 4.3--4.6)\n############################\n\n\n\n#####################################\n\n## First get the Cox-Snell residuals.;\n## The default residuals of coxph in R are the martingale residuals.\n## resid(obj,type=c(\"martingale\", \"deviance\", \"score\", \"schoenfeld\",\n##                   \"dfbeta\", \"dfbetas\", \"scaledsch\",\"partial\"))\n\n\n\n## Use relationship between cox-snell and martingal\n## residuals\n\ncoxsnellres &lt;- data.CE$status-resid(obj, type=\"martingale\")\n## Then use N-A method to estimate the cumulative \n## hazard function for residuals;\nfit &lt;- survfit(Surv(coxsnellres,data.CE$status) ~ 1)\nHtilde &lt;- cumsum(fit$n.event/fit$n.risk)\nplot(log(fit$time),log(Htilde), xlab=\"log(t)\", frame.plot = FALSE,\n     ylab=\"log-cumulative hazard\", xlim = c(-8, 2), ylim = c(-8, 2))\nabline(0, 1, lty = 3, lwd = 1.5)\n\n\n# rescaled Schoelfeld residuals\nsch &lt;- cox.zph(obj) \n\n# chi-square test results for proportionality\n# of each covariate and overall\nsch$table\n\n### calculated residuals ###\nsch_time &lt;- sch$time # the X_i's (m-vector)\nsch_resids &lt;-  sch$y # rescaled residuals (m x p matrix)\n\n# Plot rescaled Schoelfeld residuals for each covariate\n# using the object sch directly\npar(mar = c(4, 4, 2, 2), mfrow=c(4,2))\nplot(sch, xlab=\"Time (months)\", lwd=2, cex.lab=1.2, cex.axis=1.2,\n     ylab = c(\"Hormone\", \"Menopause\", \"Age\", \"Tumor size\",\n               \"Tumor grade\", \"Progesterone\", \"Estrogen\"))\n\n## an alternative graphic provided in survminer package\n# ggcoxzph(sch)\n\n\n# To address non-proportionality of tumor grade\n# re-fit the Cox proportional hazards model\n# stratified by tumor grade\nobj.stra &lt;- coxph(Surv(time, status) ~ hormone + meno\n         + age + size + prog + estrg + strata(grade), data = data.CE)\n#Schoelfeld\n#produce proportionality test results\nsch.stra &lt;- cox.zph(obj.stra) \nround(sch.stra$table, 4)\n\n## residual plots for stratified model\npar(mfrow=c(3,2))\nplot(sch.stra, xlab=\"Time (months)\", lwd=2, cex.lab=1.2, cex.axis=1.2,\n     ylab = c(\"Hormone\", \"Menopause\", \"Age\", \"Tumor size\",\n              \"Progesterone\", \"Estrogen\"))\n\n\n\n## Martingale residuals\nmart_resid &lt;- resid(obj.stra,type = 'martingale')\n## Deviance residuals\ndev_resid &lt;- resid(obj.stra,type = 'deviance')\n\n\n#plot the martingale residuals against\n# the fours quantitative covariates:\n# age, tumor size, progesterone and\n# estrogen receptor levels\n\n## Age\npar(mfrow=c(2,2))\nplot(data.CE$age, mart_resid,\n     xlab=\"Age (years)\", ylab=\"Martingale residuals\",\n     main='Age',cex.lab=1.2,cex.axis=1.2)\nlines(lowess(data.CE$age, mart_resid), lwd = 2)\nabline(0,0,lty=3,lwd=2)\n\n## Tumor size\nplot(data.CE$size, mart_resid,\n     xlab=\"Tumor size (mm)\", ylab=\"Martingale residuals\",\n     main='Tumor size',cex.lab=1.2,cex.axis=1.2)\nlines(lowess(data.CE$size, mart_resid),lwd=2)\nabline(0,0,lty=3,lwd=2)\n\n## Progesterone\nplot(data.CE$prog, mart_resid,\n     xlab=\"Progesterone receptor (fmol/mg)\", ylab=\"Martingale Residuals\",\n     main='Progesterone',cex.lab=1.2,cex.axis=1.2)\nlines(lowess(data.CE$prog, mart_resid),lwd=2)\nabline(0,0,lty=3,lwd=2)\n\n\n## Estrogen\nplot(data.CE$estrg, mart_resid,\n     xlab=\"Estrogen receptor (fmol/mg)\", ylab=\"Martingale Residuals\",\n     main='Estrogen',cex.lab=1.2,cex.axis=1.2)\nlines(lowess(data.CE$estrg, mart_resid),lwd=2)\nabline(0,0,lty=3,lwd=2)\n\n\n# To address non-linear age\n# categorize age in agec\n# age&lt;=40: agec=1\n# 40&lt;age&lt;=60: agec=2\n# age&gt;60: agec=3\ndata.CE$agec &lt;- (data.CE$age&lt;=40)+2*(data.CE$age&gt;40&data.CE$age&lt;=60)+\n    3*(data.CE$age&gt;60)\ndata.CE$agec &lt;- factor(data.CE$agec)\n\n\n#re-fit the model with agec\nobj.stra.final &lt;- coxph(Surv(time,status)~ hormone + meno\n               + agec + size + prog + estrg + strata(grade), data = data.CE)\n\n\n#plot the estimated HRs for agec (Figure 4.6)\n# and confidence intervals\nfinal.sum &lt;- summary(obj.stra.final)\nfinal.sum\n\n\n# Plot the age-group-specific HR and confidence\n# intervals from the re-fitted model\nci.table=final.sum$conf.int\nhr=ci.table[3:4,1]\nhr.low=ci.table[3:4,3]\nhr.up=ci.table[3:4,4]\n\npar(mfrow=c(1,1))\nplot(1:3,c(1,hr),ylim=c(0,1.2),frame=F,xaxt='n',\n     xlab=\"Age (years)\", ylab=\"Hazard ratio\",pch=19,cex=1.5,cex.lab=1.2,\n     cex.axis=1.2)\naxis(1, at=c(1,2,3),labels=c(\"(20, 40]\",\"(40, 60]\",\"(60, 80]\"),cex.axis=1.2)\n# horizontal error bars\narrows(2:3, hr.low, 2:3, hr.up, length=0.05, angle=90, code=3,lwd=2)\nlines(1:3,c(1,hr),lty=3,lwd=2)\n\n\n\n\n###########################################\n# Illustration with time-varying covariates\n# Stanford heart study\n###########################################\nhead(heart)\n## change variable name \"year\" -&gt; \"accpt\"\ncolnames(heart)[5] &lt;- \"accpt\"\n\n#sample size\nn &lt;- length(unique(heart$id))\n\n# fit a Cox model with time-dependent \"transplant\"\nobj &lt;- coxph(Surv(start, stop, event) ~ age + accpt + surgery + transplant, data=heart)\n#summarize results\nsummary(obj)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 4 - Cox Proportional Hazards Regression"
    ]
  },
  {
    "objectID": "chapter6.html",
    "href": "chapter6.html",
    "title": "Chapter 6 - Sample Size Determination and Study Design",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 6 - Sample Size Determination and Study Design"
    ]
  },
  {
    "objectID": "chapter6.html#slides",
    "href": "chapter6.html#slides",
    "title": "Chapter 6 - Sample Size Determination and Study Design",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 6 - Sample Size Determination and Study Design"
    ]
  },
  {
    "objectID": "chapter6.html#base-r-code",
    "href": "chapter6.html#base-r-code",
    "title": "Chapter 6 - Sample Size Calculation and Study Design",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nShow the code\n##################################################################\n# This code generates all numerical results in chapter 6.      ##\n##################################################################\n\n\n################################################################\n# Part I. Compile functions needed for sample size calculation #\n################################################################\n\n\n###########################################\n# Compile the following code for function\n# psi_fun(lambda0,lambdaL,b, c)\n# which computes the event proportion psi\n# needed for sample size calculation for\n# Cox model\n# INPUT: lambda0 = hazard rate for T\n#        lambdaL = hazard rate for LTFU\n#        b = length of accrual\n#        c = additional length of follow-up\n##########################################\n\npsi_fun &lt;- function(lambda0, lambdaL, b, c){\n        lambda &lt;- lambda0 + lambdaL\n   psi &lt;- lambda0 / lambda * (1 - exp(- lambda * c) * (1 - exp(- lambda * b)) / (lambda * b))\n   return(psi)\n}\n\n\n\n###########################################\n# Compile the following code for function\n# zeta_fun(tau,lambda0,lambdaL,b, c)\n# which computes the RMST variance\n# needed for sample size calculation.\n# INPUT: tau = restricting time\n#       lambda0 = hazard rate for T\n#       lambdaL = hazard rate for LTFU\n#       b = length of accural\n#       c = additional length of follow-up\n##########################################\n\n## Survival function for censoring\nGfun &lt;- function(t, lambdaL, b, c){\n  Gt &lt;- ifelse(t &lt;= c, exp(- lambdaL * t),\n    ifelse(t &lt; c + b, exp(- lambdaL * t) * (b + c -t ) / b, 0))\n  return(Gt)\n}\n\n## The integrand of zeta\nzeta_integrand &lt;- function(t, tau, lambda0,lambdaL, b, c){\n  integrand &lt;- (exp(- lambda0 * t) - exp( - lambda0 * tau))^2*\n      exp(lambda0 * t)/(Gfun(t, lambdaL, b, c) * lambda0)\n  return(integrand)\n}\n\n## Use the integrate() for numerical integration\n# ?integrate\nzeta_fun &lt;- function(tau, lambda0, lambdaL, b, c){\n  f &lt;- function(t){\n   return(zeta_integrand(t, tau, lambda0, lambdaL, b, c))\n  }\n  zeta &lt;- integrate(f, lower = 0, upper = tau)\n  return(zeta$value)\n}\n\n\n\n################################################################\n# Part II. Generate the numerical results in Section 6.2.2     #\n################################################################\n\n\nzeta_fun(tau=5,lambda0=0.2,lambdaL=0.01,b=2,c=4)\n\n\n\nlibrary(survival)\n\n##############################################\n# GBC study\n#############################################\n#read in the complete data\ngbc &lt;- read.table(\"Data//German Breast Cancer Study//gbc.txt\")\n\n#subset to first event data\n#Sort the data by time within each id\no &lt;- order(gbc$id,gbc$time)\ngbc &lt;- gbc[o,]\n#get the first row for each id\ndata.CE &lt;- gbc[!duplicated(gbc$id),]\n\n#set status=1 if status==2 or 1\ndata.CE$status &lt;- (data.CE$status&gt;0)+0\n\n## restrict to the subgroup of post-menopausal\n## women with no hormonal treatment\n\npilot &lt;- data.CE[data.CE$meno==2&data.CE$hormone==1,]\nn &lt;- nrow(pilot)\n## n=209, consistent with the # in Table 1.1 of Chapter 1\n\n# calculate the event rate\n# convert time from month to year\npilot$time &lt;- pilot$time/12\nlambda0 &lt;- sum(pilot$status&gt;0)/sum(pilot$time)\n# lambda0=0.174\n\n### Design for the new study\n# Accrual period: b=2 years\n# Additional follow-up: c=3.5 years\n# LTFU rate: lambda=0.01 per year. \nlambdaL &lt;- 0.01\nb &lt;- 2\nc &lt;- 3.5 \n\n# calculate the parameters psi and zeta(tau=3, 5)\npsi &lt;- psi_fun(lambda0,lambdaL,b, c)\nzeta3 &lt;- zeta_fun(tau=3,lambda0,lambdaL,b, c)\nzeta5 &lt;- zeta_fun(tau=5,lambda0,lambdaL,b, c)\n\n\n# Hypothetical treatment group\n# A spectrum of hypothetical hazard ratios\nHR &lt;- seq(0.6,0.9,by=0.01)\n# log(HR) is the effect size for Cox model\n\n# Hazard rate in the treatment\nlambda1 &lt;- lambda0*HR\n## Function to compute the corresponding effect size in RMST\n## based on the exponential distribution\nRMST_diff &lt;- function(tau,lambda0,lambda1){\n     return(lambda1^{-1}*(1-exp(-lambda1*tau))-lambda0^{-1}*(1-exp(-lambda0*tau)))\n}\n\n## for tau=3 and 5.\ntheta3 &lt;- RMST_diff(tau=3,lambda0,lambda1)\ntheta5 &lt;- RMST_diff(tau=5,lambda0,lambda1)\n\n# Sample size calculation for q=1/2 and alpha=0.05\nq &lt;- 0.5\nza &lt;- qnorm(0.975)\n# Power=0.8, 0.9\ngamma_list &lt;- c(0.8,0.9)\n\n# For each gamma, compute the sample size needed \n# for log-rank test and RMST tests\n# as a function of HR\n\npar(mfrow=c(1,2))\n\nfor (i in 1:2){\n   gamma &lt;- gamma_list[i]\n   zg &lt;- qnorm(gamma)\n   \n   # n for log-rank, 3-RMST, and 5-RMST\n   ncox &lt;- (za+zg)^2/(q*(1-q)*psi*log(HR)^2)\n   nRMST3 &lt;- zeta3*(za+zg)^2/(q*(1-q)*theta3^2)\n   nRMST5 &lt;- zeta5*(za+zg)^2/(q*(1-q)*theta5^2)\n   \n   plot(HR,ncox,type=\"l\",lwd=2,ylim=c(0,7000),ylab=\"Sample size\",\n        xlab=\"Hazard ratio\", main=paste0(\"Power = \",gamma),\n        cex.lab=1.2,cex.axis=1.2)\n   lines(HR,nRMST5,lty=2,lwd=2)\n   lines(HR,nRMST3,lty=3,lwd=2)\n   legend(\"topleft\",lty=1:3,c(\"Log-rank\",\"5-RMST\",\"3-RMST\"),lwd=2,\n          cex=1.2)\n}\n\n## sample sizes at HR=0.8 and power=0.9\n\nncox[HR==0.8]\nnRMST3[HR==0.8]\nnRMST5[HR==0.8]"
  },
  {
    "objectID": "chapter8.html",
    "href": "chapter8.html",
    "title": "Chapter 8 - Multivariate Failure Times",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 8 - Multivariate Failure Times"
    ]
  },
  {
    "objectID": "chapter8.html#slides",
    "href": "chapter8.html#slides",
    "title": "Chapter 8 - Multivariate Failure Times",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 8 - Multivariate Failure Times"
    ]
  },
  {
    "objectID": "chapter8.html#base-r-code",
    "href": "chapter8.html#base-r-code",
    "title": "Chapter 8 - Multivariate Failure Times",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nShow the code\n##################################################################\n# This code generates all numerical results in chapter 8.      ##\n##################################################################\n\nlibrary(survival)\n\n################################\n# NCCTG lung cancer study      #\n################################\n\n## read in the NCCTG lung cancer study\n## (clustered data by institution)\ndf &lt;- read.table(\"Data//NCCTG//lung.txt\")\n\n\n\nhead(df)\n\n\n\n\n\n## Follow up plot\nlibrary(tidyverse)\nlibrary(patchwork)\n\n# function to plot follow-up by\n# institution and sex\ninst_by_sex_fu_plot &lt;- function(df){\n  \ndf |&gt; \n  ggplot(aes(y = reorder(id, time), x = time, color = factor(2 - sex))) +\n  geom_linerange(aes(xmin = 0, xmax = time)) +\n  geom_point(aes(shape = factor(status)), size = 2, fill = \"white\") +\n  geom_vline(xintercept = 0, linewidth = 1) +\n  facet_grid(inst ~ ., scales = \"free\", space = \"free\", switch = \"y\")   +\n  theme_minimal() +\n  scale_x_continuous(\"Time (months)\", limits = c(0, 36), breaks = seq(0, 36, by = 12),\n                     expand = c(0, 0.25)) +\n  scale_y_discrete(\"Patients (by institution)\") +\n  scale_shape_manual(values = c(23, 19), labels = c(\"Censoring\", \"Death\")) +\n  scale_color_brewer(palette = \"Set1\", labels = c(\"Female\", \"Male\"))+\n  theme(\n    strip.background =  element_rect(fill = \"gray90\", color = \"gray90\"),\n    axis.text.y = element_blank(),\n    axis.ticks.y = element_blank(),\n    axis.line.y = element_blank(),\n    panel.grid.major.y = element_blank(),\n    legend.title = element_blank()\n  )\n  \n}\n\np1 &lt;- inst_by_sex_fu_plot(df |&gt; filter(inst &lt;= 11))\n\np2 &lt;- inst_by_sex_fu_plot(df |&gt; filter(inst &gt; 11))\n\nmul_lung_fu &lt;- p1 + p2 + plot_layout(ncol = 2, guides = \"collect\") & theme(legend.position = \"top\")\nmul_lung_fu\n\n# ggsave(\"mul_lung_fu.pdf\", mul_lung_fu, width = 8, height = 10)\n# ggsave(\"mul_lung_fu.eps\", mul_lung_fu, width = 8, height = 10)\n\n# Convert sex to factor\ndf$sex &lt;- factor(df$sex)\n# Fit a Cox model with institution-specific frailty\n# to account for correlation within institution\nobj &lt;- coxph(Surv(time, status) ~ age + sex + phec + phkn + ptkn +\n        wl + frailty(inst, distribution = \"gamma\"), data = df)\n\n# obj &lt;- coxph(Surv(time, status) ~ age + sex + phec + phkn + ptkn +\n#         wl + frailty(inst, distribution = \"gaussian\"), data = df)\n\n# Summarize results\nsummary(obj)\n\nobj$coefficients\nobj$frail\n\n# fit a naive Cox model without institution-specific frailty\nobj_naive &lt;- coxph(Surv(time,status)~ age + sex+phec+phkn+ptkn +\n                           wl,data = df)\n\nsummary(obj_naive)\n\n\n####################################################\n#  Prediction of subject-specific survival curves\n#  \n################################################\n\n# Median age\nmed_age &lt;- median(data$age)\n# Median ph.karno\nmed_phkn &lt;- median(data$phkn,na.rm=T)\n# Median pat.karno\nmed_ptkn &lt;- median(data$ptkn,na.rm=T)\n# Median wt.loss\nmed_wl &lt;- median(data$wl,na.rm=T)\n\n# Extract the regression coefficients\nbeta &lt;- obj$coefficients\n# Extract the (only) baseline function\nbase_obj &lt;- basehaz(obj,centered=F)\neta &lt;- base_obj$hazard\nt &lt;- base_obj$time\n\n\n# Figure 8.2 Prediction of survival probabilities for a typical patient \n# of median age (63 years), with median physician-\n#         and patient-rated Karnofsky scores (each 80), and with median\n# weighted loss (7 pounds) by sex and ECOG score.\n\n# Obtain the covariate profiles.\n## Female\nzf0 &lt;- c(med_age,1,0,med_phkn,med_ptkn,med_wl)\nzf1 &lt;- c(med_age,1,1,med_phkn,med_ptkn,med_wl)                              \nzf2 &lt;- c(med_age,1,2,med_phkn,med_ptkn,med_wl) \nzf3 &lt;- c(med_age,1,3,med_phkn,med_ptkn,med_wl) \n\n## Male\nzm0 &lt;- c(med_age,0,0,med_phkn,med_ptkn,med_wl)\nzm1 &lt;- c(med_age,0,1,med_phkn,med_ptkn,med_wl)                              \nzm2 &lt;- c(med_age,0,2,med_phkn,med_ptkn,med_wl) \nzm3 &lt;- c(med_age,0,3,med_phkn,med_ptkn,med_wl) \n\n# Plot the preducted survival curves\npar(mfrow=c(1,2))\nplot(t,exp(-exp(sum(beta*zf0))*eta),type=\"s\",xlim=c(0,35),\n     ylim=c(0,1),frame=F,lty=1,main=\"Female\",\n     xlab=\"Time (months)\",ylab=\"Survival probabilities\",lwd=2,cex.lab=1.3,\n     cex.axis=1.3,cex.main=1.3)\nlines(t,exp(-exp(sum(beta*zf1))*eta),lty=2,lwd=2)\nlines(t,exp(-exp(sum(beta*zf2))*eta),lty=3,lwd=2)\nlines(t,exp(-exp(sum(beta*zf3))*eta),lty=4,lwd=2)\nlegend(\"topright\",lty=1:4,lwd=2,cex=1.2,paste(\"ECOG\",0:3))\n\nplot(t,exp(-exp(sum(beta*zm0))*eta),type=\"s\",xlim=c(0,35),\n     ylim=c(0,1),frame=F,lty=1,main=\"Male\",\n     xlab=\"Time (months)\",ylab=\"Survival probabilities\",lwd=2,cex.lab=1.3,\n     cex.axis=1.3,cex.main=1.3)\nlines(t,exp(-exp(sum(beta*zm1))*eta),lty=2,lwd=2)\nlines(t,exp(-exp(sum(beta*zm2))*eta),lty=3,lwd=2)\nlines(t,exp(-exp(sum(beta*zm3))*eta),lty=4,lwd=2)\nlegend(\"topright\",lty=1:4,lwd=2,cex=1.2,paste(\"ECOG\",0:3))\n\n\n\n################################\n# Diabetic retinopathy study   #\n################################\n\n# read in the data\ndf &lt;- read.table(\"Data//Diabetic Retinopathy Study//drs.txt\")\nhead(df)\n\n# fit a bivariate marginal Cox model\n# with treatment, diabetic type\n# risk score, and treatment*type interaction\n# as covariates\nobj &lt;- coxph(Surv(time, status) ~ trt + type + trt : type + risk\n                           + cluster(id), data = df)\n\nsummary(obj)\n\n# Table 8.1 Marginal Cox model analysis of the Diabetic Retinopathy Study\n# output table\ncoeff &lt;- summary(obj)$coeff\n# beta estimate\nc1 &lt;- coeff[,1]\n# robust se and p-value\nc2 &lt;- coeff[,4]\nc3 &lt;- coeff[,6]\n# naive se and p-value\nc4 &lt;- coeff[,3]\nc5 &lt;- 1-pchisq((c1/c4)^2,1)\n\n#output the table\nnoquote(round(cbind(c1,c2,c3,c4,c5),3))\n\n\n\n# Fig. 8.4 Prediction of vision-retention probabilities \n# for patients with a median risk\n# score (10) by treatment for each diabetic type.\n\n# Lambda_0(t) and t\nLt &lt;- basehaz(obj,centered = F)\nt &lt;- Lt$time\nL &lt;- Lt$hazard\n\n# beta\nbeta &lt;- coeff[,1]\n\n# plot the predicted survival functions\n\npar(mfrow=c(1,2))\n# Compute the survival function for \n# adult and juvenile patients in control and treatment\nadult.contr &lt;- exp(-exp(sum(beta*c(0,0,10,0)))*L)\nadult.trt &lt;- exp(-exp(sum(beta*c(1,0,10,0)))*L)\njuv.contr &lt;- exp(-exp(sum(beta*c(0,1,10,0)))*L)\njuv.trt &lt;- exp(-exp(sum(beta*c(1,1,10,1)))*L)\n\n# Plot the predicted survival curves\nplot(t,adult.contr,type=\"s\",xlim=c(0,80),ylim=c(0,1),frame.plot=F,lty=3,main=\"Adult\",\n     xlab=\"Time (months)\",ylab=\"Vision-retention probabilities\",lwd=2, cex.lab=1.2,\n     cex.axis=1.2,cex.main=1.2)\nlines(t,adult.trt,lty=1,lwd=2)\n\nplot(t,juv.contr,type=\"s\",xlim=c(0,80),ylim=c(0,1),frame.plot=F,lty=3,main=\"Juvenile\",\n     xlab=\"Time (months)\",ylab=\"Vision-retention probabilities\",lwd=2,cex.lab=1.2,\n     cex.axis=1.2,cex.main=1.2)\nlines(t,juv.trt,lty=1,lwd=2)"
  },
  {
    "objectID": "chapter8.html#descriptive-analysis-of-topcat-trial",
    "href": "chapter8.html#descriptive-analysis-of-topcat-trial",
    "title": "Chapter 8 - Multivariate Failure Times",
    "section": "Descriptive analysis of TOPCAT trial",
    "text": "Descriptive analysis of TOPCAT trial\n\nlibrary(survival)\nlibrary(tidyverse)\nlibrary(knitr)\n\n##########################\n#   TOPCAT               #\n##########################\n\n# read in the data\ntopcat &lt;- read.table(\"Data//TOPCAT//topcat.txt\")\n# head(topcat)\n\n# median follow-up\ntopcat |&gt; \n  group_by(id) |&gt; \n  slice_max(time) |&gt; \n  slice_head() |&gt; \n  ungroup() |&gt; \n  summarize(\n    median(time)\n  )\n\n# A tibble: 1 × 1\n  `median(time)`\n           &lt;dbl&gt;\n1           3.55\n\n# table(topcat$drug)\n# table(topcat$race)\n\n# topcat |&gt; \n#   count(endpoint, status)\n\n\n# Descriptive analysis ----------------------------------------------------\n\n## clean up data\n\ntmp &lt;- topcat |&gt; \n  mutate( # clean up the levels of drug, gender\n    drug = if_else(drug == \"Spiro\", \"Spironolactone\", \"Placebo\"),\n    gender = if_else(gender == \"1:Male\", \"Male\", \"Female\")\n  ) \n  \n## de-duplicate\ndf &lt;- tmp |&gt; \n  pivot_wider( # flatten endpoints\n    id_cols = id,\n    # names_prefix = c(time, status),\n    names_from = endpoint,\n    values_from = c(time, status),\n  ) |&gt; # join with baseline data\n  left_join(\n    tmp |&gt; filter(endpoint == \"HF\"),\n    join_by(id)\n  )\n\n## a function to compute median (IQR) for x\n## rounded to the rth decimal place\nmed_iqr &lt;- function(x, r = 1){\n  qt &lt;- quantile(x, na.rm = TRUE)\n  \n  str_c(round(qt[3], r), \" (\", \n        round(qt[2], r), \", \",\n        round(qt[4], r), \")\")\n}\n\n# create summary table for quantitative variables\n# age, size, nodes, prog, estrg\ntab_quant &lt;- df |&gt; \n  filter(endpoint == \"HF\") |&gt; \n  group_by(drug) |&gt; \n  summarize(\n    across(c(age,  bmi, hr), med_iqr)\n  ) |&gt; \n  pivot_longer( # long format: value = median (IQR); name = variable names\n    !drug,\n    values_to = \"value\",\n    names_to = \"name\"\n  ) |&gt; \n  pivot_wider( # wide format: name = variable names; hormone levels as columns\n    values_from = value,\n    names_from = drug\n  ) |&gt; \n  mutate(\n    name = case_when( # format the variable names\n      name == \"age\" ~ \"Age (years)\",\n      name == \"bmi\" ~ \"BMI (kg/m^2)\",\n      name == \"hr\" ~ \"Heart rate (per min)\"\n    )\n  )\n\n## a function that computes N (%) for each level of var\n## by group in data frame df (percent rounded to rth point)\nfreq_pct&lt;- function(df, group, var, r = 1){\n  # compute the N for each level of var by group\n  var_counts &lt;- df |&gt; \n    group_by({{ group }}, {{ var }}) |&gt; \n    summarize(\n      n = n(),\n      .groups = \"drop\"\n    ) \n  # compute N (%)\n  var_counts |&gt; \n    left_join( # compute the total number (demoninator) in each group\n      # and joint it back to the numerator\n      var_counts |&gt; group_by({{ group }}) |&gt; summarize(N = sum(n)),\n      by = join_by({{ group }})\n    ) |&gt; \n    mutate( # N (%)\n      value = str_c(n, \" (\", round(100 * n / N, r), \"%)\")\n    ) |&gt; \n    select(- c(n, N)) |&gt; \n    pivot_wider( # put group levels on columns\n      names_from = {{ group }},\n      values_from = value\n    ) |&gt; \n    rename(\n      name = {{ var }} # name = variable names \n    )\n}\n\n## gender\ngender &lt;- df |&gt;\n  freq_pct(drug, gender) |&gt; \n  mutate(\n    name = str_c(\"Gender - \", name)\n  )\n## race\nrace &lt;- df |&gt;\n  freq_pct(drug, race) |&gt; \n  mutate(\n    name = str_c(\"Race - \", name)\n  )\n## nyha\nnyha &lt;- df |&gt;\n  freq_pct(drug, nyha) |&gt; \n  mutate(\n    name = str_c(\"NYHA - \", name)\n  ) |&gt; \n  filter(!is.na(name))\n\n\n\n\n## function to compute N (%) for binary condition\nbin_pct &lt;- function(condition, r = 1){\n  n &lt;- sum(condition, na.rm = TRUE)\n  N &lt;- n()\n  str_c(n, \" (\", round(100 * n / N, r), \"%)\")\n}\n\n## tabulate binary variables, including number of endpoints\ntabin &lt;- df |&gt; \n  group_by(drug) |&gt; \n  summarize(\n    N = n(),\n    across(c(smoke:cabg, status_HF, status_MI, status_Stroke), bin_pct)\n  ) |&gt; \n  select(!N) |&gt; \n  pivot_longer( # long format: value = median (IQR); name = variable names\n    !drug,\n    values_to = \"value\",\n    names_to = \"name\"\n  ) |&gt; \n  pivot_wider( # wide format: name = variable names; hormone levels as columns\n    values_from = value,\n    names_from = drug\n  ) |&gt; \n  mutate(\n      name = case_when( # format the variable names\n      name == \"smoke\" ~ \"Smoker\",\n      name == \"chf_hosp\" ~ \"CHF\",\n      name == \"copd\" ~ \"COPD\",\n      name == \"asthma\" ~ \"Asthma\",\n      name == \"dm\" ~ \"Diabetes\",\n      name == \"htn\" ~ \"Hypertension\",\n      name == \"cabg\" ~ \"Coronary surgery\",\n      name == \"status_HF\" ~ \"HF\",\n      name == \"status_MI\" ~ \"MI\",\n      name == \"status_Stroke\" ~ \"Stroke\"\n    )\n  )\n\n## tabulate event rates\nevent_rates &lt;- df |&gt; \n  group_by(drug) |&gt; \n  summarize(\n    `HF rate (per person-year)` = sum(status_HF) / sum(time_HF),\n    `MI rate (per person-year)` = sum(status_MI) / sum(time_MI),\n    `Stroke rate (per person-year)` = sum(status_Stroke) / sum(time_Stroke)\n  ) |&gt; \n  pivot_longer( # long format: value = median (IQR); name = variable names\n    !drug,\n    values_to = \"value\",\n    names_to = \"name\"\n  ) |&gt; \n  pivot_wider( # wide format: name = variable names; hormone levels as columns\n    values_from = value,\n    names_from = drug\n  ) |&gt; \n  mutate(\n    Placebo = as.character(round(Placebo, 4)),\n    Spironolactone = as.character(round(Spironolactone, 4))\n  )\n\n\n## combine tables\n\ntabone &lt;- bind_rows(\n  tab_quant[1, ],\n  gender,\n  race,\n  nyha,\n  tab_quant[- 1, ],\n  tabin,\n  event_rates\n)\n\n## add N to group names  \ncolnames(tabone) &lt;- c(\" \", str_c(colnames(tabone)[2:3], \" (N=\", table(df$drug),\")\"))\n## print out the table\nkable(tabone)\n\n\n\n\n\n\n\n\n\n\nPlacebo (N=1446)\nSpironolactone (N=1465)\n\n\n\n\nAge (years)\n68 (60, 74)\n68 (60, 75)\n\n\nGender - Female\n763 (52.8%)\n790 (53.9%)\n\n\nGender - Male\n683 (47.2%)\n675 (46.1%)\n\n\nRace - Caucasian\n1422 (98.3%)\n1432 (97.7%)\n\n\nRace - Other\n24 (1.7%)\n33 (2.3%)\n\n\nNYHA - 1-2\n993 (68.7%)\n1003 (68.5%)\n\n\nNYHA - 3-4\n451 (31.2%)\n461 (31.5%)\n\n\nBMI (kg/m^2)\n30.8 (27.2, 35.6)\n31.1 (27.3, 35.6)\n\n\nHeart rate (per min)\n68 (61.2, 76)\n68 (61, 75)\n\n\nSmoker\n154 (10.7%)\n146 (10%)\n\n\nCHF\n1057 (73.1%)\n1057 (72.2%)\n\n\nCOPD\n152 (10.5%)\n166 (11.3%)\n\n\nAsthma\n84 (5.8%)\n93 (6.3%)\n\n\nDiabetes\n439 (30.4%)\n456 (31.1%)\n\n\nHypertension\n1335 (92.3%)\n1336 (91.2%)\n\n\nCoronary surgery\n173 (12%)\n171 (11.7%)\n\n\nHF\n147 (10.2%)\n127 (8.7%)\n\n\nMI\n40 (2.8%)\n44 (3%)\n\n\nStroke\n36 (2.5%)\n29 (2%)\n\n\nHF rate (per person-year)\n0.0303\n0.0255\n\n\nMI rate (per person-year)\n0.0079\n0.0086\n\n\nStroke rate (per person-year)\n0.0071\n0.0056\n\n\n\n\n\n\n## fit the model (scenario 3)\nobj &lt;- coxph(Surv(time, status) ~ \n        (drug + age +  gender + nyha + bmi + smoke + chf_hosp + copd + asthma + dm + htn + cabg) * \n        strata(endpoint) + cluster(id), data = topcat)\n\nsummary(obj)\n\nCall:\ncoxph(formula = Surv(time, status) ~ drug + age + gender + nyha + \n    bmi + smoke + chf_hosp + copd + asthma + dm + htn + cabg + \n    strata(endpoint) + drug:strata(endpoint) + age:strata(endpoint) + \n    gender:strata(endpoint) + nyha:strata(endpoint) + bmi:strata(endpoint) + \n    smoke:strata(endpoint) + chf_hosp:strata(endpoint) + copd:strata(endpoint) + \n    asthma:strata(endpoint) + dm:strata(endpoint) + htn:strata(endpoint) + \n    cabg:strata(endpoint), data = topcat, cluster = id)\n\n  n= 8715, number of events= 421 \n   (18 observations deleted due to missingness)\n\n                                           coef exp(coef)  se(coef) robust se\ndrugSpiro                             -0.207278  0.812794  0.121754  0.122400\nage                                    0.041354  1.042221  0.007477  0.008097\ngender2:Female                        -0.238238  0.788015  0.128800  0.129867\nnyha3-4                                0.749433  2.115800  0.125931  0.128086\nbmi                                    0.056324  1.057940  0.008662  0.008771\nsmoke                                  0.177758  1.194536  0.242795  0.248293\nchf_hosp                               0.153693  1.166133  0.140620  0.143243\ncopd                                   0.456659  1.578791  0.157523  0.161216\nasthma                                 0.290733  1.337407  0.200752  0.205817\ndm                                     0.748368  2.113548  0.133287  0.132486\nhtn                                    0.396062  1.485961  0.311908  0.312459\ncabg                                   0.432078  1.540455  0.158414  0.157821\ndrugSpiro:strata(endpoint)MI           0.249229  1.283036  0.250358  0.237127\ndrugSpiro:strata(endpoint)Stroke      -0.043475  0.957456  0.277908  0.273113\nage:strata(endpoint)MI                -0.009436  0.990609  0.015221  0.014406\nage:strata(endpoint)Stroke            -0.043921  0.957030  0.016572  0.017254\ngender2:Female:strata(endpoint)MI      0.300202  1.350131  0.265436  0.259827\ngender2:Female:strata(endpoint)Stroke  0.425938  1.531026  0.293651  0.301089\nnyha3-4:strata(endpoint)MI            -0.746980  0.473795  0.269703  0.254952\nnyha3-4:strata(endpoint)Stroke        -0.712956  0.490193  0.299105  0.300530\nbmi:strata(endpoint)MI                -0.092089  0.912024  0.021580  0.021413\nbmi:strata(endpoint)Stroke            -0.068103  0.934165  0.022233  0.019952\nsmoke:strata(endpoint)MI               0.509670  1.664742  0.422624  0.373759\nsmoke:strata(endpoint)Stroke          -0.202749  0.816483  0.517037  0.495307\nchf_hosp:strata(endpoint)MI           -0.535797  0.585203  0.274164  0.265939\nchf_hosp:strata(endpoint)Stroke       -0.405289  0.666784  0.312368  0.312737\ncopd:strata(endpoint)MI                0.097983  1.102944  0.327119  0.319773\ncopd:strata(endpoint)Stroke           -0.237202  0.788832  0.408008  0.395973\nasthma:strata(endpoint)MI             -0.071974  0.930555  0.454665  0.441084\nasthma:strata(endpoint)Stroke         -0.144770  0.865221  0.522952  0.542787\ndm:strata(endpoint)MI                  0.126785  1.135173  0.271051  0.250783\ndm:strata(endpoint)Stroke              0.067654  1.069995  0.301790  0.304118\nhtn:strata(endpoint)MI                 0.433845  1.543180  0.670495  0.629397\nhtn:strata(endpoint)Stroke            -0.248418  0.780034  0.610228  0.585943\ncabg:strata(endpoint)MI               -0.048813  0.952359  0.328140  0.326680\ncabg:strata(endpoint)Stroke           -0.147798  0.862606  0.382419  0.404562\n                                           z Pr(&gt;|z|)    \ndrugSpiro                             -1.693 0.090370 .  \nage                                    5.107 3.26e-07 ***\ngender2:Female                        -1.834 0.066583 .  \nnyha3-4                                5.851 4.89e-09 ***\nbmi                                    6.422 1.35e-10 ***\nsmoke                                  0.716 0.474040    \nchf_hosp                               1.073 0.283291    \ncopd                                   2.833 0.004617 ** \nasthma                                 1.413 0.157780    \ndm                                     5.649 1.62e-08 ***\nhtn                                    1.268 0.204954    \ncabg                                   2.738 0.006186 ** \ndrugSpiro:strata(endpoint)MI           1.051 0.293242    \ndrugSpiro:strata(endpoint)Stroke      -0.159 0.873524    \nage:strata(endpoint)MI                -0.655 0.512467    \nage:strata(endpoint)Stroke            -2.546 0.010909 *  \ngender2:Female:strata(endpoint)MI      1.155 0.247931    \ngender2:Female:strata(endpoint)Stroke  1.415 0.157168    \nnyha3-4:strata(endpoint)MI            -2.930 0.003391 ** \nnyha3-4:strata(endpoint)Stroke        -2.372 0.017676 *  \nbmi:strata(endpoint)MI                -4.301 1.70e-05 ***\nbmi:strata(endpoint)Stroke            -3.413 0.000642 ***\nsmoke:strata(endpoint)MI               1.364 0.172683    \nsmoke:strata(endpoint)Stroke          -0.409 0.682290    \nchf_hosp:strata(endpoint)MI           -2.015 0.043932 *  \nchf_hosp:strata(endpoint)Stroke       -1.296 0.194996    \ncopd:strata(endpoint)MI                0.306 0.759289    \ncopd:strata(endpoint)Stroke           -0.599 0.549149    \nasthma:strata(endpoint)MI             -0.163 0.870381    \nasthma:strata(endpoint)Stroke         -0.267 0.789688    \ndm:strata(endpoint)MI                  0.506 0.613167    \ndm:strata(endpoint)Stroke              0.222 0.823956    \nhtn:strata(endpoint)MI                 0.689 0.490633    \nhtn:strata(endpoint)Stroke            -0.424 0.671593    \ncabg:strata(endpoint)MI               -0.149 0.881220    \ncabg:strata(endpoint)Stroke           -0.365 0.714867    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n                                      exp(coef) exp(-coef) lower .95 upper .95\ndrugSpiro                                0.8128     1.2303    0.6394    1.0332\nage                                      1.0422     0.9595    1.0258    1.0589\ngender2:Female                           0.7880     1.2690    0.6109    1.0164\nnyha3-4                                  2.1158     0.4726    1.6461    2.7196\nbmi                                      1.0579     0.9452    1.0399    1.0763\nsmoke                                    1.1945     0.8371    0.7343    1.9433\nchf_hosp                                 1.1661     0.8575    0.8807    1.5441\ncopd                                     1.5788     0.6334    1.1511    2.1655\nasthma                                   1.3374     0.7477    0.8935    2.0020\ndm                                       2.1135     0.4731    1.6302    2.7402\nhtn                                      1.4860     0.6730    0.8055    2.7414\ncabg                                     1.5405     0.6492    1.1306    2.0989\ndrugSpiro:strata(endpoint)MI             1.2830     0.7794    0.8061    2.0421\ndrugSpiro:strata(endpoint)Stroke         0.9575     1.0444    0.5606    1.6353\nage:strata(endpoint)MI                   0.9906     1.0095    0.9630    1.0190\nage:strata(endpoint)Stroke               0.9570     1.0449    0.9252    0.9899\ngender2:Female:strata(endpoint)MI        1.3501     0.7407    0.8114    2.2467\ngender2:Female:strata(endpoint)Stroke    1.5310     0.6532    0.8486    2.7623\nnyha3-4:strata(endpoint)MI               0.4738     2.1106    0.2875    0.7809\nnyha3-4:strata(endpoint)Stroke           0.4902     2.0400    0.2720    0.8834\nbmi:strata(endpoint)MI                   0.9120     1.0965    0.8745    0.9511\nbmi:strata(endpoint)Stroke               0.9342     1.0705    0.8983    0.9714\nsmoke:strata(endpoint)MI                 1.6647     0.6007    0.8002    3.4633\nsmoke:strata(endpoint)Stroke             0.8165     1.2248    0.3093    2.1555\nchf_hosp:strata(endpoint)MI              0.5852     1.7088    0.3475    0.9855\nchf_hosp:strata(endpoint)Stroke          0.6668     1.4997    0.3612    1.2308\ncopd:strata(endpoint)MI                  1.1029     0.9067    0.5893    2.0642\ncopd:strata(endpoint)Stroke              0.7888     1.2677    0.3630    1.7141\nasthma:strata(endpoint)MI                0.9306     1.0746    0.3920    2.2090\nasthma:strata(endpoint)Stroke            0.8652     1.1558    0.2986    2.5070\ndm:strata(endpoint)MI                    1.1352     0.8809    0.6944    1.8558\ndm:strata(endpoint)Stroke                1.0700     0.9346    0.5895    1.9420\nhtn:strata(endpoint)MI                   1.5432     0.6480    0.4494    5.2986\nhtn:strata(endpoint)Stroke               0.7800     1.2820    0.2474    2.4596\ncabg:strata(endpoint)MI                  0.9524     1.0500    0.5020    1.8066\ncabg:strata(endpoint)Stroke              0.8626     1.1593    0.3903    1.9062\n\nConcordance= 0.73  (se = 0.012 )\nLikelihood ratio test= 289.2  on 36 df,   p=&lt;2e-16\nWald test            = 344.7  on 36 df,   p=&lt;2e-16\nScore (logrank) test = 322.3  on 36 df,   p=&lt;2e-16,   Robust = 184.4  p=&lt;2e-16\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n\nobj$coefficients\n\n                            drugSpiro                                   age \n                         -0.207278003                           0.041354304 \n                       gender2:Female                               nyha3-4 \n                         -0.238237982                           0.749432848 \n                                  bmi                                 smoke \n                          0.056323750                           0.177757987 \n                             chf_hosp                                  copd \n                          0.153693475                           0.456659435 \n                               asthma                                    dm \n                          0.290732785                           0.748367868 \n                                  htn                                  cabg \n                          0.396061756                           0.432077651 \n         drugSpiro:strata(endpoint)MI      drugSpiro:strata(endpoint)Stroke \n                          0.249228920                          -0.043475250 \n               age:strata(endpoint)MI            age:strata(endpoint)Stroke \n                         -0.009435877                          -0.043921039 \n    gender2:Female:strata(endpoint)MI gender2:Female:strata(endpoint)Stroke \n                          0.300201761                           0.425938279 \n           nyha3-4:strata(endpoint)MI        nyha3-4:strata(endpoint)Stroke \n                         -0.746979844                          -0.712955994 \n               bmi:strata(endpoint)MI            bmi:strata(endpoint)Stroke \n                         -0.092089383                          -0.068102650 \n             smoke:strata(endpoint)MI          smoke:strata(endpoint)Stroke \n                          0.509670435                          -0.202749427 \n          chf_hosp:strata(endpoint)MI       chf_hosp:strata(endpoint)Stroke \n                         -0.535797148                          -0.405289388 \n              copd:strata(endpoint)MI           copd:strata(endpoint)Stroke \n                          0.097983051                          -0.237202110 \n            asthma:strata(endpoint)MI         asthma:strata(endpoint)Stroke \n                         -0.071973799                          -0.144770002 \n                dm:strata(endpoint)MI             dm:strata(endpoint)Stroke \n                          0.126785437                           0.067653872 \n               htn:strata(endpoint)MI            htn:strata(endpoint)Stroke \n                          0.433845273                          -0.248417938 \n              cabg:strata(endpoint)MI           cabg:strata(endpoint)Stroke \n                         -0.048813345                          -0.147797544 \n\n## tabulate component-specific HR (95% CI) and p-values\n\np &lt;- 12 # number of covariates\n\n### global beta and variance matrix\nbeta &lt;- obj$coefficients\nvar &lt;- obj$var\n\n### set up log-HR and variances\nbetaHF &lt;- rep(NA, p)\nvarHF &lt;- rep(NA, p)\nbetaMI &lt;- rep(NA, p)\nvarMI &lt;- rep(NA, p)\nbetaStr &lt;- rep(NA, p)\nvarStr  &lt;- rep(NA, p)\n\nfor (j in 1:p){\n  #### HF (reference)\n  betaHF[j] &lt;- beta[j]\n  varHF[j] &lt;- var[j, j]\n  #### MI (ref + interaction with MI stratum)\n  betaMI[j] &lt;- beta[j] + beta[p + 2 * j - 1]\n  varMI[j] &lt;- var[j, j] + var[p + 2 * j - 1, p + 2 * j - 1] + 2* var[j, p + 2 * j - 1]\n  #### Stroke (ref + interaction with stroke stratum)\n  betaStr[j] &lt;- beta[j] + beta[p + 2 * j]\n  varStr[j] &lt;- var[j, j] + var[p + 2 * j, p + 2 * j] + 2* var[j, p + 2 * j]  \n}\n\n### make the table\nza &lt;- qnorm(0.975)\n#### functions to compute HR (95% CI) and p-value\n#### r: number of decimal place\nhr_ci &lt;- function(beta, var, r = 2){\n  se &lt;- sqrt(var)\n\n  str_c(round(exp(beta), r), \" (\",\n        round(exp(beta - za * se), r), \", \",\n        round(exp(beta + za * se), r), \")\")\n}\n\n#### p-value\nhr_p &lt;- function(beta, var){\n  se &lt;- sqrt(var)\n  round(1 - pchisq((beta/se)^2 , df = 1), 3)\n}\n\n\ndf &lt;- tibble(\n  betaHF, varHF, betaMI, varMI, betaStr, varStr \n) |&gt; \n  mutate(\n    variable = c(\"Spironolactone\", \n                 \"Age (years)\",\n                 \"Female\",\n                 # \"Non-caucasian\",\n                 \"NYHA 3-4\",\n                 \"BMI\",\n                 \"Smoke\",\n                 \"CHF\",\n                 \"COPD\",\n                 \"Asthma\",\n                 \"Diabetes\",\n                 \"Hypertension\",\n                 \"Coronary surgery\"),\n    HF = hr_ci(betaHF, varHF),\n    HF_p = hr_p(betaHF, varHF),\n    MI = hr_ci(betaMI, varMI),\n    MI_p = hr_p(betaMI, varMI),\n    Stroke = hr_ci(betaStr, varStr),\n    Stroke_p = hr_p(betaStr, varStr),\n    .before = 1\n  ) |&gt; \n  select(variable:Stroke_p)\n\n## joint test of spironolactone effect on HF/stroke\n### main effect (HF) and interaction with stroke\nbeta_q &lt;- beta[c(1, 14)]\nSigma_q &lt;- var[c(1, 14), c(1, 14)]\n\n\n#chisq statistic with 2 d.f.\nchisq2 &lt;- t(beta_q) %*% solve(Sigma_q) %*% beta_q\n#p-value\npval &lt;- 1 - pchisq(chisq2, 2)"
  },
  {
    "objectID": "chapter9.html",
    "href": "chapter9.html",
    "title": "Chapter 9 - Recurrent Events",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 9 - Recurrent Events"
    ]
  },
  {
    "objectID": "chapter9.html#slides",
    "href": "chapter9.html#slides",
    "title": "Chapter 9 - Recurrent Events",
    "section": "",
    "text": "Lecture slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 9 - Recurrent Events"
    ]
  },
  {
    "objectID": "chapter9.html#base-r-code",
    "href": "chapter9.html#base-r-code",
    "title": "Chapter 9 - Recurrent Events",
    "section": "Base R Code",
    "text": "Base R Code\n\n\nShow the code\n##################################################################\n# This code generates all numerical results in chapter 9.       ##\n##################################################################\n\nlibrary(survival)\n\n# read in the cgd dataset in counting process format\ncgd &lt;- read.table(\"Data\\\\Chronic Granulomatous Disease Study\\\\cgd_counting.txt\")\nhead(cgd)\n\n\n# Andersen-Gill model\nobj_AG &lt;- coxph(Surv(tstart, tstop, status) ~ treat + sex + age + inherit + steroids +\n                 propylac, data = cgd)\nsummary(obj_AG)\n\n\n# Residuals\ncox.zph(obj_AG)\nresiduals(obj_AG, type = \"martingale\", collapse = cgd$id)\n\n\n# Frailty model\nobj_frail &lt;- coxph(Surv(tstart, tstop, status) ~ treat + sex + age + inherit + steroids +\n                    propylac + frailty(id, distribution = \"gamma\"), data = cgd)\n\nsummary(obj_frail)\n\n\n# Proportional means model (LWYY)\nobj_pm &lt;- coxph(Surv(tstart, tstop, status) ~ treat + sex + age + inherit + steroids +\n                 propylac + cluster(id), data = cgd)\n\nsummary(obj_pm)\n\n\n# extract the beta's from the three models\ncoeff.AG &lt;- summary(obj.AG)$coeff\ncoeff.frail &lt;- summary(obj.frail)$coeff\ncoeff.pm &lt;- summary(obj.pm)$coeff\n\n\n#########################################\n# Table 9.1. beta, se(beta), and p-vaues\n# from the three models\n#########################################\n\n## Andersen-Gill model\nc1 &lt;- coeff.AG[,1]\nc2 &lt;- coeff.AG[,3]\nc3 &lt;- coeff.AG[,5]\n\n# Frailty model\nc4 &lt;- coeff.frail[1:6,1]\nc5 &lt;- coeff.frail[1:6,2]\nc6 &lt;- coeff.frail[1:6,6]\n\n# Proportional means model\nc7 &lt;- coeff.pm[1:6,1]\nc8 &lt;- coeff.pm[1:6,4]\nc9 &lt;- coeff.pm[1:6,6]\n\n#print out Table 9.1\nnoquote(round(cbind(c1,c2,c3,c4,c5,c6,c7,c8,c9),3))\n\n\n### Figure 9.2 #############################################\n# predicted  mean functions by treatment\n# for a female/male patient of 12 years old with X-linked \n# inheritance pattern and use of both steroids and \n#  prophylactic antibiotics\n############################################################\n\n# get beta\nbeta &lt;- obj.pm$coeff\n\n# get baseline mean function mu_0(t)\n# and t\nLt &lt;- basehaz(obj.pm,centered = F)\nt &lt;- Lt$time\nmu0 &lt;- Lt$hazard\n\n# covariate vector (besides treatement) for female patient\nzf &lt;- c(0,12,1,1,1)\n# covariate vector (besides treatement) for male patient\nzm &lt;- c(1,12,1,1,1)\n\n# female in treatment and control\nmu.f.trt &lt;- exp(sum(c(1,zf)*beta))*mu0\nmu.f.contr &lt;- exp(sum(c(0,zf)*beta))*mu0\n\n# male in treatment and control\nmu.m.trt &lt;- exp(sum(c(1,zm)*beta))*mu0\nmu.m.contr &lt;- exp(sum(c(0,zm)*beta))*mu0\n\n# Plot the figure\npar(mfrow=c(1,2))\n\n# for female (left panel)\nplot(t/30.5, mu.f.trt, type=\"s\",xlim=c(0, 12), ylim=c(0,6),frame.plot =F,lty=1, main=\"Female\",\n     xlab=\"Time (months)\",ylab = \"Mean number of infections\", lwd=2)\nlines(t/30.5,mu.f.contr,lty=3,lwd=2)\n\n#for male (right panel)\nplot(t/30.5, mu.m.trt, type=\"s\", xlim=c(0, 12), ylim=c(0,6),frame.plot =F,lty=1,main=\"Male\",\n     xlab=\"Time (months)\",ylab = \"Mean number of infections\",lwd=2)\nlines(t/30.5,mu.m.contr,lty=3,lwd=2)\n\n# Multivariate approaches -------------------------------------------------\n\nlibrary(tidyverse)\nlibrary(gtsummary)\nlibrary(knitr)\ncgd\n\ncgd_mul &lt;- cgd |&gt; \n  arrange(id, tstart) |&gt; \n  group_by(id) |&gt; \n  mutate(\n    order = row_number(),\n    gtime = tstop - tstart,\n    .after = tstop\n  ) |&gt; ungroup()\n\ncgd_mul |&gt; \n  mutate(\n    tstart = tstart / 30.5,\n    tstop = tstop / 30.5,\n    gtime = gtime / 30.5\n  ) |&gt; \n  select(id, tstart, tstop, gtime, order,  status, treat,   sex,      age,\n         inherit,   steroids, propylac)\n\n## WLW \n\nwlw_obj &lt;- coxph(Surv(tstop, status) ~ (treat + sex + age) * \n                   strata(order), cgd_mul |&gt; \n                   filter(order &lt;= 3))\nwlw_obj0 &lt;- coxph(Surv(tstop, status) ~ (treat + sex + age) + \n                   strata(order), cgd_mul)\n# tbl_regression(wlw_obj)\n\n\npwp_tt_obj &lt;- coxph(Surv(tstart, tstop, status) ~ (treat + sex + age) * strata(order), cgd_mul |&gt; \n                   filter(order &lt;= 3))\npwp_tt_obj0 &lt;- coxph(Surv(tstart, tstop, status) ~ (treat + sex + age) + strata(order), cgd_mul)\n# tbl_regression(pwp_tt_obj)\n\n\npwp_gt_obj &lt;- coxph(Surv(gtime, status) ~ (treat + sex + age) * strata(order), cgd_mul |&gt; \n                      filter(order &lt;= 3))\npwp_gt_obj0 &lt;- coxph(Surv(gtime, status) ~ (treat + sex + age) + strata(order), cgd_mul)\n# tbl_regression(pwp_gt_obj)\n\n\nobj &lt;- wlw_obj\nobj0 &lt;- wlw_obj0\n\nobj &lt;- pwp_tt_obj\nobj0 &lt;- pwp_tt_obj0\n\nobj &lt;- pwp_gt_obj\nobj0 &lt;- pwp_gt_obj0\n\n## tabulate trt HR (95% CI) and p-values\nK &lt;- 3\np &lt;- 3 # number of covariates, including treatment\n\ntrt_hr_mul &lt;- function(obj, obj0, p, K, r = 2){\n\n\n### global beta and variance matrix\nbeta &lt;- obj$coefficients\nvar &lt;- obj$var\n\n### set up log-HR and variances\nbeta_trt &lt;- rep(NA, p + 1)\nvar_trt &lt;- rep(NA, p + 1)\n\nbeta_trt[1] &lt;- beta[1]\nvar_trt[1] &lt;- var[1, 1]\n\nfor (j in 2:K){\n  beta_trt[j] &lt;- beta[1] + beta[p + j - 1]\n  var_trt[j] &lt;- var[1, 1] + var[p + j - 1, p + j - 1] + 2* var[1, p + j - 1]\n}\n## overall \nbeta_trt[p + 1] &lt;- obj0$coefficients[1]\nvar_trt[p + 1] &lt;- obj0$var[1, 1]\n\nse_trt &lt;- sqrt(var_trt)\n### make the table\nza &lt;- qnorm(0.975)\n\n\ndf &lt;- tibble(\n  HR =   str_c(round(exp(beta_trt), r), \" (\",\n               round(exp(beta_trt - za * se_trt), r), \", \",\n               round(exp(beta_trt + za * se_trt), r), \")\"),\n  P = round(1 - pchisq((beta_trt / se_trt)^2 , df = 1), 3)\n  \n)\n\ndf\n}\n\nN &lt;- cgd_mul |&gt; filter(order == 1) |&gt; count(treat) |&gt; pull(n)\n\nrow_header &lt;- cgd_mul |&gt; \n  filter(status == 1) |&gt; \n  count(treat, order) |&gt; \n  filter(order &lt;= 3) |&gt; \n  pivot_wider(\n    values_from = n,\n    names_from = treat\n  ) |&gt; \n  mutate(\n    order = as.character(order)\n  ) |&gt; \n  add_row(\n    order = \"All\",\n    placebo = cgd_mul |&gt; filter(treat == \"placebo\", status == 1) |&gt; count() |&gt; pull(),\n    `rIFN-g` = cgd_mul |&gt; filter(treat == \"rIFN-g\", status == 1) |&gt; count()|&gt; pull()\n  ) |&gt; \n  mutate(\n    placebo = str_c(placebo, \" (\", round(100 * placebo / N[1], 1), \"%)\"),\n    `rIFN-g` = str_c(`rIFN-g`, \" (\", round(100 * `rIFN-g` / N[2], 1), \"%)\")\n  ) |&gt; \n  select(order, `rIFN-g`, placebo)\n\n\ncgd_tab &lt;- row_header |&gt; \n  add_column(\n    WLW = trt_hr_mul(wlw_obj, wlw_obj0, 3, 3,)$HR,\n    `PWP-TT` = trt_hr_mul(pwp_tt_obj, pwp_tt_obj0, 3, 3,)$HR,\n    `PWP-GT` = trt_hr_mul(pwp_gt_obj, pwp_gt_obj0, 3, 3,)$HR,\n  ) \n\n\ncgd_tab |&gt; \n  kable(\"latex\")\n\n\n# forest plot -------------------------------------------------------------\n\n## parse the hr and 95% ci\n\nhr_ci_parse &lt;- function(x){\n  separate_wider_regex(\n    x,\n    patterns = c(x = \".+\", \" \\\\(\", xmin = \".+\", \", \", ymax = \".+\", \"\\\\)\")\n  )\n}\n\ncgd_models &lt;- cgd_tab |&gt; \n  separate_wider_regex(\n    WLW:`PWP-GT`,\n    patterns = c(x = \".+\", \" \\\\(\", xmin = \".+\", \", \", xmax = \".+\", \"\\\\)\"),\n    names_sep = \"_\"\n  ) |&gt; \n  mutate(\n    across(!c(order:placebo), as.numeric)\n  ) |&gt; \n  pivot_longer(\n    !c(order:placebo),\n    names_to = c(\"Model\", \".value\"),\n    names_sep = \"_\"\n  )\n\n  \ncgd_models |&gt; \n  ggplot(aes(x = x, y = order)) +\n  geom_point(aes(size = (order == \"All\"))) +\n  geom_linerange(aes(xmin = xmin, xmax = xmax, linewidth = (order == \"All\"))) +\n  geom_vline(xintercept = 1, linetype = 2) +\n  facet_wrap(~ fct(Model), ncol = 3) + \n  scale_y_discrete(\"Infection\", limits = rev(c(\"1\", \"2\", \"3\", \"All\")),\n                   labels = rev(c(\"1st\", \"2nd\", \"3rd\", \"All\"))) +\n  scale_x_log10(\"Treatment hazard ratio (95% CI)\") +\n  scale_size_manual(values = c(1.5, 2)) +\n  scale_linewidth_manual(values = c(0.5, 0.8)) +\n  theme_minimal() +\n  theme(\n    axis.text = element_text(size = 10),\n    axis.title  = element_text(size = 11),\n    panel.grid = element_blank(),\n    strip.text = element_text(size = 11),\n    legend.position = \"none\"\n  )\n \n\nggsave(\"rec_cgd_forest.pdf\", width = 8, height = 4.5)\nggsave(\"rec_cgd_forest.eps\", width = 8, height = 4.5)\n\n## Poisson/NB regression\n\n# Dataset: flatten data - one row per subject\n# count: total number of events; follow_up: censoring time\nlibrary(tidyverse)\ndf &lt;- cgd |&gt; \n  group_by(id) |&gt; \n  mutate(\n    count = sum(status),       # Compute the total number of events\n    follow_up = max(tstop)     # Compute the maximum 'tstop' (censoring time) \n  ) |&gt; \n  distinct(id, .keep_all = T)  # Keep only one row per 'id' and keeping all variables\n\n# Fit a Poisson regression model\nps_obj &lt;- glm(count ~ treat + age + sex       # Covariates\n                    + offset(log(follow_up)), # Offset term\n            family = poisson(link=\"log\"), # Poisson model with log link\n            data = df)  \nsummary(ps_obj)  # Summarize results\n\n# Fit a negative binomial regression model\nnb_obj &lt;- MASS::glm.nb(count ~ treat + age + sex   # Covariates\n                        + offset(log(follow_up)),  # Offset term\n                    data = df) \nsummary(nb_obj)  # Summarize results"
  },
  {
    "objectID": "index.knit.html",
    "href": "index.knit.html",
    "title": "quarto",
    "section": "",
    "text": "This is a Quarto website.\nTo learn more about Quarto websites visit https://quarto.org/docs/websites.\n\n1 + 1\n\n[1] 2\n\n\n\ntest"
  },
  {
    "objectID": "rmtif.html",
    "href": "rmtif.html",
    "title": "Retricted mean time in favor of treatment",
    "section": "",
    "text": "This is a talk I give at the 2024 Duke Industry Statistics Symposium (DISS) on April 4th, 2024 in Durham, NC.\nTalk slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)\nAnother talk on October 22nd, 2024 in the Department of Statistics and Actuarial Science at the University of Waterloo."
  },
  {
    "objectID": "wa_estimands.html",
    "href": "wa_estimands.html",
    "title": "While-alive estimands for recurrent events in presence of death",
    "section": "",
    "text": "This is a talk I give at the 2024 Society for Clinical Trials Annual Meeting on May 21st, 2024 in Boston, MA.\nTalk slides here. (To convert html to pdf, press E \\(\\to\\) Print \\(\\to\\) Destination: Save to pdf)"
  },
  {
    "objectID": "chapter2.html#summary",
    "href": "chapter2.html#summary",
    "title": "Chapter 2 - Mathematical Foundations",
    "section": "Summary",
    "text": "Summary\nThe chapter establishes the foundations of survival analysis, focusing on the representation of time-to-event data, handling of censored observations, and development of key quantities, models, and methods.\n\nFull Outcome Data\nAn event time (T) is described as a random variable, with the survival function (S(t) = (T &gt; t)) representing the probability of surviving beyond time (t), and the hazard function ((t)) quantifying the instantaneous risk of the event at (t). The cumulative hazard function, ((t) = _0^t (u),u), relates directly to (S(t)) via ((t) = -(S(t))). These quantities describe the event-time distribution and form the basis for constructing survival models. Examples such as the exponential and Weibull distributions illustrate parametric models, where the hazard can remain constant (exponential) or vary systematically (Weibull).\n\n\nObserved Data\nRight-censored data are described by the observed time (X = (T, C)) and an event indicator (= I(T C)). The likelihood for censored data is derived under the assumption of independent censoring, where (T) and (C) are assumed to be independent. The likelihood function is expressed in terms of the hazard and survival functions, separating the contributions of event times and censored observations. This framework enables parametric inference, where the likelihood is maximized to estimate model parameters.\n\n\nParametric Families and Likelihood Construction\nParametric models define specific forms for ((t)) and (S(t)), tailoring the hazard to reflect different patterns over time. For instance, the exponential model assumes a constant hazard, while the Weibull model allows the hazard to increase or decrease, depending on the shape parameter. The likelihood for parametric models incorporates both hazard and survival components: [ L() = _{i=1}^n (X_i; )^{_i} S(X_i; ), ] where (X_i) and (_i) represent the observed data. Maximum likelihood estimation is performed by solving score equations, either analytically for simple models (e.g., exponential) or numerically for more flexible models (e.g., Weibull, using Newton–Raphson). These models also facilitate hypothesis testing and confidence interval construction through the Fisher information matrix.\n\n\nCounting Processes and Martingales\nThe counting process (N(t)) tracks event occurrences over time, with (N^*(t)) serving as the indicator of an event by time (t). Martingale theory provides a framework for decomposing (N(t)) into a predictable component (A(t)), linked to the hazard function, and a stochastic component (M(t)), which has mean zero. This decomposition simplifies derivations of key quantities, such as the Nelson–Aalen estimator for the cumulative hazard, and supports the development of test statistics, such as the log-rank test. By expressing these tools as integrals with respect to martingales, their properties can be leveraged for efficient and rigorous inference.\n\n\nStochastic Integrals\nSurvival-analysis tools, including the log-likelihood, score equations, and variance formulas, are reformulated as stochastic integrals with respect to counting processes and martingales. These integrals simplify computations and ensure that statistical methods remain grounded in rigorous large-sample theory. Martingale properties, such as uncorrelated increments and mean-zero expectations, support the derivation of asymptotic results, including the normality of estimators.\n\n\nConclusion\nThe survival and hazard functions provide the foundation for modeling time-to-event data, with censored observations incorporated through likelihood methods. Parametric families like the exponential and Weibull distributions offer flexibility in hazard modeling, while counting-process and martingale frameworks unify key tools and simplify calculations. These concepts establish a rigorous foundation for the development of advanced survival analysis methods.",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 2 - Mathematical Foundations"
    ]
  },
  {
    "objectID": "chapter2.html#chapter-summary-1",
    "href": "chapter2.html#chapter-summary-1",
    "title": "Chapter 2 - Mathematical Foundations",
    "section": "Chapter Summary",
    "text": "Chapter Summary\nCensored event times require specialized methods for analysis, which are grounded in fundamental quantities like the survival function \\(S(t)\\) and the hazard function \\(\\lambda(t)\\). Some methods rely on parametric models, while others leverage counting processes and martingales to provide a robust framework for understanding and modeling time-to-event data.\n\nNotation and Basic Quantities\nAn outcome event time can be represented either as a random variable \\(T\\) or as a counting process \\(N^*(t) = I(T \\le t)\\). The survival function is defined as [ S(t) = (T &gt; t), ] while the hazard function \\(\\lambda(t)\\) quantifies the instantaneous risk of experiencing the event at time \\(t\\), conditional on survival up to that point. The cumulative hazard function is obtained by integrating \\(\\lambda(t)\\) over \\([0, t]\\): [ (t) = _0^t (u),u, ] and relates to \\(S(t)\\) via [ (t) = -(S(t)) S(t) = {-(t)}. ] This relationship is central to survival analysis, facilitating transitions between hazard-based and survival-based formulations.\n\n\nParametric Families and Likelihood\nParametric models, such as the exponential, Weibull, and gamma distributions, define specific forms for \\(\\lambda(t)\\), which in turn determine \\(S(t)\\) and the associated likelihood for censored data. The observed data, \\((X_i, \\delta_i)\\), consist of the minimum of event and censoring times and an event indicator. Under the assumption of independent censoring, the likelihood separates neatly into hazard and survival components. Inferences are then made by solving score equations, either analytically for simpler models (e.g., exponential) or numerically for more complex ones (e.g., Weibull, using Newton–Raphson).\n\n\nCounting Processes and Martingales\nThe counting-process framework offers a unified way to represent time-to-event data. The observed counting process \\(N(t)\\) tracks event occurrences over time and can be decomposed as: [ N(t) = A(t) + M(t), ] where \\(A(t)\\) is the predictable compensator, linked to \\(\\lambda(t)\\), and \\(M(t)\\) is a martingale representing the random fluctuations. This decomposition simplifies the derivation of key quantities, such as means and variances, and underpins many survival-analysis tools, including the Nelson–Aalen estimator and test statistics. Martingale properties enable straightforward calculations and inference.\n\n\nConclusion\nThis chapter provides the mathematical foundation for survival analysis, emphasizing the definition and role of \\(\\lambda(t)\\) and \\(S(t)\\), the treatment of censored data through likelihood-based methods, and the utility of counting processes and martingales. The independence of \\(T\\) and the censoring time \\(C\\) is a crucial assumption, ensuring valid inference from partially observed data. These concepts form the basis for more advanced methodologies in survival analysis.",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 2 - Mathematical Foundations"
    ]
  },
  {
    "objectID": "chap2.html#outcome-event-notation-1",
    "href": "chap2.html#outcome-event-notation-1",
    "title": "Applied Survival Analysis",
    "section": "Outcome Event: Notation",
    "text": "Outcome Event: Notation\n\nTime to outcome event (latent, w.o. censoring): \\(T\\)\n\nCumulative distribution function (cdf): \\(F(t)={\\rm pr}(T\\leq t)\\)\nSurvival function: \\(S(t) = 1- F(t) = {\\rm pr}(T &gt; t)\\)\nDensity function: \\(f(t) = \\d F(t)/\\d t = - \\d S(t)/ \\d t\\)\n\nLeibniz notation\n\n\\(\\d F(t) = f(t)\\d t = \\pr(t \\leq T &lt; t + \\d t)\\): infinitesimal (marginal) event rate (i.e. incidence) over \\([t, t + \\d t)\\)"
  },
  {
    "objectID": "chap2.html#summary",
    "href": "chap2.html#summary",
    "title": "Applied Survival Analysis",
    "section": "Summary",
    "text": "Summary\n\nNotation\n\nOutcome data: \\(T\\)\nObserved data: \\(X=T\\wedge C\\) (time), \\(\\delta=I(T\\leq C)\\) (status)\nCounting process: \\(N(t)=I(X\\leq t,\\delta=1)\\)\nCounting process integral \\[\\delta I(X\\leq t) h(X) = \\int_0^t h(u)\\dd N(u)\\]\n\nMartingale residual \\[\\dd M(t) = \\dd N(t) - I(X\\geq t)\\dd\\Lambda(t)\\]"
  },
  {
    "objectID": "chapter3.html#r-code",
    "href": "chapter3.html#r-code",
    "title": "Chapter 3 - Nonparametric Estimation and Testing",
    "section": "R Code",
    "text": "R Code\n\n\nShow the code\n###############################################################################\n# Chapter 3 R Code\n#\n# This script reproduces all major numerical results in Chapter 3, including:\n#  1. The Nelson–Aalen estimator (Figures 3.3, Table 3.2)\n#  2. Kaplan–Meier (KM) analysis (Figure 3.4, Table 3.3, Table 3.5, Table 3.6)\n#  3. Log-rank tests for the rat study and the GBC study\n#  4. Additional code for generating Figures 3.7 and 3.9\n###############################################################################\n\n\n#==============================================================================\n# (A) Nelson–Aalen Estimator for the Rat Study (Figures 3.3, Table 3.2)\n#==============================================================================\nlibrary(survival)\nlibrary(tidyverse)\n\n# The 'rats' dataset records times to tumor or censoring in rats receiving a drug\n# vs. control. Each row corresponds to one rat, with variables:\n#   litter:  Litter ID, from 1 to 100 (3 rats per litter)\n#   rx:      Treatment (1 = drug, 0 = control)\n#   time:    Time to tumor or last follow-up\n#   status:  Event status (1 = tumor, 0 = censored)\n#   sex:     'male' or 'female'\n#\n# N. Mantel, N. R. Bohidar, and J. L. Ciminera. \n# \"Mantel-Haenszel analyses of litter-matched time-to-response data, with \n#  modifications for recovery of interlitter information.\" \n#  Cancer Research, 37:3863-3868, 1977.\n\n#------------------------------------------------------------------------------\n# 1. Read and inspect the dataset\n#------------------------------------------------------------------------------\nrats &lt;- read.table(\"Data//Rat Tumorigenicity Study//rats.txt\", header = TRUE)\nhead(rats)\n\n#------------------------------------------------------------------------------\n# 2. Subset to the treatment group (rx == 1)\n#------------------------------------------------------------------------------\nrats.rx &lt;- rats[rats$rx == 1, ]\n\ntime   &lt;- rats.rx$time\nstatus &lt;- rats.rx$status\n\n#------------------------------------------------------------------------------\n# 3. Extract unique sorted event times (for status == 1)\n#------------------------------------------------------------------------------\nts &lt;- unique(sort(time[status == 1])) \nm  &lt;- length(ts)\nts\n\n# Count number of failures at each event time\nds &lt;- table(time[status == 1])\n\n# Prepare vectors for risk set sizes, the dLambda increments, and cumulative Lambda\nns &lt;- rep(NA, m)   # Number at risk\ndL &lt;- rep(NA, m)   # Incremental hazard\nL  &lt;- rep(NA, m)   # Cumulative hazard\n\n#------------------------------------------------------------------------------\n# 4. Compute Nelson–Aalen estimates\n#------------------------------------------------------------------------------\nfor (j in seq_len(m)) {\n  # (a) Risk set: subjects still under observation at ts[j]\n  ns[j] &lt;- sum(time &gt;= ts[j])\n  \n  # (b) Increment for the Nelson–Aalen: dLambda = d_j / n_j\n  dL[j] &lt;- ds[j] / ns[j]\n  \n  # (c) Cumulative hazard: sum of all increments up to j\n  L[j] &lt;- sum(dL[1:j])\n}\n\n# Combine into a table for display\nresults &lt;- cbind(ts, ds, ns, dL, L)\nround(results, 3)\n\n#------------------------------------------------------------------------------\n# 5. Plot the estimated cumulative hazard function\n#------------------------------------------------------------------------------\npar(mfrow = c(1, 1))\nplot(\n  stepfun(ts, c(0, L)), \n  do.points  = FALSE, \n  ylim       = c(0, 0.4), \n  xlim       = c(0, 120), \n  lwd        = 2, \n  frame.plot = FALSE,\n  xlab       = \"Time (days)\",\n  ylab       = \"Cumulative hazard function\",\n  cex.lab    = 1.5, \n  cex.axis   = 1.5,\n  main = \"\"\n)\n\n\n#==============================================================================\n# (B) Kaplan–Meier Estimates for the Rat Study (Figure 3.4, Table 3.3)\n#==============================================================================\n# The 'dL' vector above is used for calculating incremental survival probabilities:\n#   S_{j} = S_{j-1} * (1 - d_j / n_j)\n# Greenwood's formula provides approximate variance.\n\n#------------------------------------------------------------------------------\n# 1. Define incremental survival and variance components\n#------------------------------------------------------------------------------\ncsurv        &lt;- 1 - dL               # 1 - (d_j / n_j)\nvar.csurv    &lt;- ds / (ns * (ns - ds))  # Greenwood piece: d_j / [n_j*(n_j - d_j)]\n\n# KM estimates at each event time\nKMsurv &lt;- rep(NA, m)\nse     &lt;- rep(NA, m)\n\n#------------------------------------------------------------------------------\n# 2. Compute step-by-step Kaplan–Meier survival and Greenwood SE\n#------------------------------------------------------------------------------\nfor (j in seq_len(m)) {\n  # Multiply all previous (1 - d_i/n_i)\n  KMsurv[j] &lt;- prod(csurv[1:j])\n  \n  # Greenwood's formula for variance\n  se[j] &lt;- KMsurv[j] * sqrt(sum(var.csurv[1:j]))\n}\n\n# Create a summary table\nresults2 &lt;- cbind(ts, ds, ns, csurv, KMsurv, se)\nround(results2, 3)\n\n#------------------------------------------------------------------------------\n# 3. Compare to survfit() from the survival package\n#------------------------------------------------------------------------------\nobj &lt;- survfit(Surv(time, status) ~ 1, data = rats.rx, conf.type = \"log-log\")\nsummary(obj)\n\n# Plot Kaplan–Meier curve via base R\nplot(\n  obj, \n  ylim       = c(0, 1), \n  xlim       = c(0, 100), \n  lwd        = 2, \n  frame.plot = FALSE,\n  xlab       = \"Time (days)\",\n  ylab       = \"Tumor-free probabilities\"\n)\n\nlegend(\n  1, 0.2,\n  c(\"Kaplan–Meier curve\", \"95% Confidence limits\"),\n  lty = 1:2, lwd = 2\n)\n\n\n#==============================================================================\n# (C) Summaries at Specific Times and Enhanced Tables (Table 3.4)\n#==============================================================================\nlibrary(gtsummary)\n\n#------------------------------------------------------------------------------\n# 1. Single-group KM model\n#------------------------------------------------------------------------------\nobj &lt;- survfit(Surv(time, status) ~ 1, data = rats.rx)\n\n# Summaries at specific time points (40, 60, 80, 100 days)\ntbl_time &lt;- tbl_survfit(\n  x            = obj,\n  times        = seq(40, 100, by = 20),\n  label_header = \"{time} days\"\n)\ntbl_time\n\n#------------------------------------------------------------------------------\n# 2. Example of plotting via ggsurvfit\n#------------------------------------------------------------------------------\nlibrary(ggsurvfit)\n\nggplot_obj &lt;- survfit(Surv(time, status) ~ 1, data = rats.rx)\n\nggsurvfit(ggplot_obj) +\n  add_confidence_interval() +\n  add_risktable() +\n  scale_x_continuous(breaks = seq(0, 100, by = 20)) +\n  ylim(0, 1) +\n  labs(x = \"Time (days)\", y = \"Tumor-free probabilities\") +\n  theme_minimal()\n\nggsave(\"images//rats_KM_gg.png\", width = 7.5, height = 4)\nggsave(\"images//rats_KM_gg.eps\", device = cairo_ps, width = 7.5, height = 4)\n\n\n#==============================================================================\n# (D) Log-Rank Test for Rat Study (Comparing Treatment vs. Control)\n#==============================================================================\n# Log-rank test with optional stratification by sex\n#------------------------------------------------------------------------------\nhead(rats)\n\n# Basic log-rank test on treatment group difference\nlogrank_obj &lt;- survdiff(Surv(time, status) ~ rx + strata(sex), data = rats, rho = 0)\nlogrank_obj\n\n# p-value associated with the test\nlogrank_obj$pvalue\n\n\n#------------------------------------------------------------------------------\n# 1. Tidy tools for a two-group KM\n#------------------------------------------------------------------------------\nobj2 &lt;- survfit(Surv(time, status) ~ rx, data = rats)\n\n# Summaries at time points\ntbl_surv &lt;- tbl_survfit(\n  x            = obj2,\n  times        = seq(40, 100, by = 20),\n  label_header = \"{time} days\",\n  label        = list(rx ~ \"Treatment\")\n)\ntbl_surv\n\n#------------------------------------------------------------------------------\n# 2. KM plot with multiple groups\n#------------------------------------------------------------------------------\nlibrary(ggplot2)\nobj3 &lt;- survfit2(Surv(time, status) ~ rx, data = rats)\n\nggsurvfit(obj3, linetype_aes = TRUE, linewidth = 1) +\n  add_pvalue(caption = \"Log-rank {p.value}\") +\n  add_risktable(risktable_stats = \"n.risk\") +\n  labs(x = \"Time (days)\", y = \"Tumor-free probabilities\") +\n  scale_linetype_manual(values = c(2, 1), labels = c(\"Control\", \"Drug\")) +\n  scale_color_discrete(labels = c(\"Control\", \"Drug\")) +\n  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2), expand = c(0, 0)) +\n  theme_classic() +\n  theme(\n    legend.position   = \"top\",\n    legend.key.width  = unit(1, \"cm\"),\n    panel.grid.major.y= element_line(),\n    legend.text       = element_text(size = 10),\n    plot.caption      = element_text(size = 10)\n  )\n\nggsave(\"images//rats_KM_gg2.png\", width = 7, height = 5)\nggsave(\"images//rats_KM_gg2.eps\", device = cairo_ps, width = 7, height = 5)\n\n\n#==============================================================================\n# (E) German Breast Cancer (GBC) Study for Figures 3.7, 3.9\n#==============================================================================\n# Detailed data contains multiple events, but we focus on first-event times.\n#------------------------------------------------------------------------------\ngbc &lt;- read.table(\"Data//German Breast Cancer Study//gbc.txt\", header = TRUE)\n\n# Sort by subject id, then time\no &lt;- order(gbc$id, gbc$time)\ngbc &lt;- gbc[o,]\n\n# Keep only first row per subject =&gt; first event\ndata.CE &lt;- gbc[!duplicated(gbc$id), ]\n\n# Convert status&gt;0 to 1 if it is either relapse or death\ndata.CE$status &lt;- ifelse(data.CE$status &gt; 0, 1, 0)\n\n\n#------------------------------------------------------------------------------\n# 1. KM curves by hormone group, possibly stratified by menopausal status\n#------------------------------------------------------------------------------\npar(mfrow = c(1, 3))\n\n# (a) Overall\nkm_overall &lt;- survfit(Surv(time, status) ~ hormone, data = data.CE)\nplot(\n  km_overall, \n  xlim  = c(0, 80), \n  lwd   = 2, \n  frame = FALSE, \n  lty   = c(2, 1),\n  xlab  = \"Time (months)\",\n  ylab  = \"Relapse-free survival probabilities\",\n  main  = \"Overall\",\n  cex.lab = 1.5, cex.axis = 1.5, cex.main = 1.5\n)\nlegend(\n  1, 0.2, \n  lty = 2:1, c(\"No Hormone\", \"Hormone\"), \n  lwd = 2, cex = 1.5\n)\n\n# (b) Pre-menopausal (meno == 1)\nkm_pre &lt;- survfit(Surv(time, status) ~ hormone, data = data.CE[data.CE$meno == 1, ])\nplot(\n  km_pre, \n  xlim  = c(0, 80), \n  lwd   = 2, \n  frame = FALSE,\n  lty   = c(2, 1),\n  xlab  = \"Time (months)\",\n  ylab  = \"Relapse-free survival probabilities\",\n  main  = \"Pre-Menopausal\",\n  cex.lab = 1.5, cex.axis = 1.5, cex.main = 1.5\n)\nlegend(\n  1, 0.2, \n  lty = 2:1, c(\"No Hormone\", \"Hormone\"), \n  lwd = 2, cex = 1.5\n)\n\n# (c) Post-menopausal (meno == 2)\nkm_post &lt;- survfit(Surv(time, status) ~ hormone, data = data.CE[data.CE$meno == 2, ])\nplot(\n  km_post, \n  xlim  = c(0, 80), \n  lwd   = 2, \n  frame = FALSE,\n  lty   = c(2, 1),\n  xlab  = \"Time (months)\",\n  ylab  = \"Relapse-free survival probabilities\",\n  main  = \"Post-Menopausal\",\n  cex.lab = 1.5, cex.axis = 1.5, cex.main = 1.5\n)\nlegend(\n  1, 0.2,\n  lty = 2:1, c(\"No Hormone\", \"Hormone\"),\n  lwd = 2, cex = 1.5\n)\n\n\n#------------------------------------------------------------------------------\n# 2. ggplot2 version (3.9) via ggsurvfit, patchwork\n#------------------------------------------------------------------------------\nlibrary(patchwork) # For combining plots\nlibrary(ggsci) # For the JAMA color style\nlibrary(ggsurvfit)\n\n# (a) Subset survival fits\npre_obj2  &lt;- survfit2(Surv(time, status) ~ hormone, data = data.CE |&gt; filter(meno == 1))\npost_obj2 &lt;- survfit2(Surv(time, status) ~ hormone, data = data.CE |&gt; filter(meno == 2))\nall_obj2  &lt;- survfit2(Surv(time, status) ~ hormone, data = data.CE)\n\n# (b) Helper function to produce KM plot\nplot_gbc_KM &lt;- function(obj, title = NULL) {\n  p &lt;- ggsurvfit(obj, linetype_aes = TRUE, linewidth = 1) +\n    add_risktable(\n      risktable_stats = \"n.risk\",\n      theme = list(\n        theme_risktable_default(),\n        scale_y_discrete(labels = c(\"Hormone\", \"No Hormone\"))\n      )\n    ) +\n    scale_y_continuous(\n      \"Relapse-free survival probabilities\", \n      limits  = c(0, 1),\n      breaks  = seq(0, 1, by = 0.2),\n      expand  = expansion(c(0, 0.005))\n    ) +\n    scale_x_continuous(\"Time (months)\", breaks = seq(0, 84, by = 12)) +\n    scale_color_jama(labels = c(\"No Hormone\", \"Hormone\")) +\n    scale_linetype_manual(values = c(2, 1), labels = c(\"No Hormone\", \"Hormone\")) +\n    theme_classic() +\n    theme(\n      plot.margin        = margin(0, 0, 0, 0),\n      legend.position    = \"top\",\n      legend.key.width   = unit(1, \"cm\"),\n      panel.grid.major.y = element_line(),\n      legend.text        = element_text(size = 10),\n      plot.caption       = element_text(size = 10),\n      plot.title         = element_text(size = 12)\n    )\n  if (!is.null(title)) p &lt;- p + ggtitle(title)\n  p\n}\n\n# Three panels by menopausal status and overall\npre_fig  &lt;- plot_gbc_KM(pre_obj2,  \"Pre-Menopausal\")\npost_fig &lt;- plot_gbc_KM(post_obj2, \"Post-Menopausal\")\nall_fig  &lt;- plot_gbc_KM(all_obj2,  \"Overall\")\n\n# Combine with patchwork\nfig_meno &lt;- wrap_plots(ggsurvfit_build(pre_fig), ggsurvfit_build(post_fig), ncol = 2)\nwrap_plots(ggsurvfit_build(all_fig), plot_spacer(), fig_meno, ncol = 1) +\n  plot_layout(heights = c(1, 0.02, 1))\n\nggsave(\"images//gbc_KM_gg.png\", width = 8, height = 9)\nggsave(\"images//gbc_KM_gg.eps\", width = 8, height = 9)\n\n#------------------------------------------------------------------------------\n# 3. Stratified log-rank test (menopausal status) and unstratified log-rank\n#------------------------------------------------------------------------------\nsurvdiff(Surv(time, status) ~ hormone + strata(meno), data = data.CE)\nsurvdiff(Surv(time, status) ~ hormone, data = data.CE)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 3 - Nonparametric Estimation and Testing"
    ]
  },
  {
    "objectID": "chapter3.html#chapter-summary",
    "href": "chapter3.html#chapter-summary",
    "title": "Chapter 3 - Nonparametric Estimation and Testing",
    "section": "Chapter Summary",
    "text": "Chapter Summary\nConditioning on the cohort at risk at each observed event time naturally leads to discrete hazard-based approaches for analyzing time-to-event data. These approaches illuminate how nonparametric estimators, such as the Kaplan–Meier curve, and group-comparison tests, such as the log-rank statistic, arise directly from examining discrete hazards over the course of a study.\n\nThe discrete hazard\nA discrete hazard captures the probability of an event happening exactly at a specific observed time, given that the subject remains event-free up to that instant. Let \\(d_j\\) be the number of events at time \\(t_j\\) and \\(n_j\\) the size of the at-risk cohort immediately before \\(t_j\\). Then the discrete hazard at \\(t_j\\) is often estimated by \\[\n\\hat\\lambda(t_j)\n=\n\\frac{d_j}{n_j}.\n\\] As event times become dense in larger samples, the sum of these discrete hazards approximate the cumulative hazard. This perspective incorporates censoring by reducing \\(n_j\\) each time individuals drop out or experience the event. The discrete hazard thus defines a step-by-step mechanism for survival analysis, tying observed failures at each \\(t_j\\) to the relevant risk set.\nWorking with a discrete hazard emphasizes the fact that each observed event time carries information about the underlying risk. By updating \\(n_j\\) dynamically, these methods properly weight the observed data for unbiased inference under independent censoring. In practical studies where event times are not necessarily continuous, such discrete formulations provide an elegant way to handle censored observations and can be generalized to more complex sampling and trial designs.\n\n\nThe Kaplan–Meier estimator\nFrom discrete hazards, the Kaplan–Meier estimator emerges as a product-limit construction. If \\(\\hat\\lambda(t_j)\\) denotes the discrete hazard at \\(t_j\\), the survival function is estimated by \\[\n\\hat S(t)\n=\n\\prod_{t_j \\le t}\n  \\bigl(1 - \\hat\\lambda(t_j)\\bigr)\n=\n\\prod_{t_j \\le t}\n  \\Bigl(1 - \\frac{d_j}{n_j}\\Bigr).\n\\] Each factor \\(1 - d_j / n_j\\) represents the proportion of subjects who “survive” past \\(t_j\\), given that \\(n_j\\) remain at risk immediately before \\(t_j\\). Because \\(n_j\\) is updated to exclude prior failures and censored observations, the estimator remains consistent even when censoring occurs at arbitrary times. At large sample sizes, \\(\\hat S(t)\\) converges in probability to the true \\(S(t)\\), making it a cornerstone of nonparametric survival analysis.\nBeyond plotting the full curve, summary measures like the median survival time emerge by identifying \\(t\\) such that \\(\\hat S(t)\\) falls to 0.5. This approach can easily extend to other percentiles or even partial survival probabilities at fixed times of interest. The stepwise nature of the Kaplan–Meier curve also offers straightforward visualization, indicating event occurrences at each jump and seamlessly accounting for censoring up to those points.\n\n\nThe log-rank test\nGroups often require formal comparison to assess whether one experiences faster or slower rates of failure than another. The log-rank test constructs a weighted difference in group-specific event counts over time. Let \\(d_{1j}\\) and \\(n_{1j}\\) denote the observed failures and risk set in group 1 at time \\(t_j\\), with \\(d_j\\) and \\(n_j\\) as the totals across all groups. The log-rank statistic sums \\[\nd_{1j} - d_j \\frac{n_{1j}}{n_j}\n\\] over \\(t_j\\). Under a null hypothesis of no group difference, the fraction \\(n_{1j}/n_j\\) should capture group 1’s expected share of failures, so repeated departures from that share indicate differing survival experiences. In large samples, this statistic often approximates a chi-square distribution, allowing standard significance testing. The log-rank test has strong power under proportional hazards, where one group’s hazard is a constant multiple of the other’s. Nonetheless, real data may violate strict proportionality, motivating alternative weighting schemes or more flexible tests.\n\n\nExtensions of the log-rank test\nWeighted log-rank variants highlight different parts of the follow-up period. When early effects dominate, decreasing weights place emphasis on initial events. For delayed effects, increasing weights spotlight later intervals. A “max-combo test” addresses uncertainty about the exact timing of effects by calculating multiple weighted statistics and taking their maximum, adjusting for correlation to preserve correct Type I error. This approach captures a broad array of hazard patterns, albeit with more complex null distributions. Stratification extends the log-rank framework further by partitioning subjects into strata defined by confounders (e.g., menopausal status). Within each stratum, the test proceeds as usual, and these stratum-level statistics combine into a single global test. This adjustment effectively controls for measured covariates that could otherwise bias group comparisons.\n\n\nStatistical properties via martingale\nBeyond heuristic arguments, martingale theory provides rigorous large-sample derivations for Kaplan–Meier estimator and log-rank tests. This is because the estimators and test statstics can be written as stochastic integrals of martingales, which simplify the computation of variances and covariances.\n\n\nSoftware use\nNonparametric survival estimates and log-rank tests are easily performed in R via the survival package. The survfit function fits Kaplan–Meier curves from a time-to-event variable and an event indicator, while the survdiff function calculates log-rank tests (and variations such as stratified or weighted log-rank). Many standard analyses can therefore be completed with just a few lines of code, shown below:\n\nlibrary(survival)\n\n# Fit Kaplan–Meier curves for two groups\nkm_fit &lt;- survfit(Surv(time, status) ~ group, data = mydata)\n\n# Summarize survival estimates and times\nsummary(km_fit)\n\n# Perform a log-rank test to compare groups\nlr_test &lt;- survdiff(Surv(time, status) ~ group, data = mydata)\nlr_test\n\nAdditional utilities are available for generating publication-ready tables and plots. The gtsummary package, for instance, provides a tbl_survfit() function that creates neatly formatted tables of survival estimates by group or stratum, including confidence intervals and median times. The ggsurvfit package extends ggplot2 to produce enhanced Kaplan–Meier graphs with at-risk tables, confidence interval shading, and optional log-rank \\(p\\)-values annotated on the plot:\n\nlibrary(gtsummary)\nlibrary(ggsurvfit)\n\n# Summarize survival estimates in a neat table\ntbl &lt;- tbl_survfit(km_fit, times = c(12, 24, 48, 96))\ntbl\n\n# Create a KM plot with confidence intervals and at-risk tables\nggsurvfit(km_fit) +\n  add_confidence_interval() +\n  add_risktable()\n\nThese higher-level functions streamline the presentation of nonparametric survival analyses, ensuring that both the numeric results and the visual displays are clear and publication-ready.\n\n\nConclusion\nDiscrete hazard constructs offer a flexible pathway to nonparametric survival estimation and testing. By updating risk sets at each event time, they integrate censoring into hazard estimators, leading to the Kaplan–Meier survival curve. For group comparisons, the log-rank test accumulates deviations in observed vs. expected failures across time, capturing hazard differences in a simple chi-square framework. Weighted extensions and max-combo designs handle a variety of hazard patterns and timing effects, while stratification addresses possible confounders. Underlying it all, martingale theory justifies the asymptotic properties of the estimators and tests, ensuring their validity and robustness in large samples.",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 3 - Nonparametric Estimation and Testing"
    ]
  },
  {
    "objectID": "chapter3.html#the-discrete-hazard",
    "href": "chapter3.html#the-discrete-hazard",
    "title": "Chapter 3 - Nonparametric Estimation and Testing",
    "section": "The Discrete Hazard",
    "text": "The Discrete Hazard\nThe discrete hazard quantifies the probability of an event happening at a specific observed time, given survival up to that time. By conditioning on the subjects still at risk, the Nelsen–Aalen estimator captures this discrete hazard as: \\[\n\\hat\\Lambda(t_j) \\;=\\;\n\\sum_{l : t_l \\le t_j}\n  \\frac{d_l}{n_l},\n\\] where (d_l) is the number of events at (t_l) and (n_l) is the number at risk just before (t_l)."
  },
  {
    "objectID": "chapter3.html#kaplanmeier-estimator",
    "href": "chapter3.html#kaplanmeier-estimator",
    "title": "Chapter 3 - Nonparametric Estimation and Testing",
    "section": "Kaplan–Meier Estimator",
    "text": "Kaplan–Meier Estimator\nThe Kaplan–Meier estimator for the survival function follows from taking the product limit of these discrete hazards: \\[\n\\hat S(t)\n\\;=\\;\n\\prod_{t_j \\le t}\\bigl(1 - \\tfrac{d_j}{n_j}\\bigr).\n\\] Because it sequentially updates the cohort size to account for censoring, this estimator remains unbiased under independent censoring and converges to the true survival function as sample size grows."
  },
  {
    "objectID": "chapter3.html#log-rank-test",
    "href": "chapter3.html#log-rank-test",
    "title": "Chapter 3 - Nonparametric Estimation and Testing",
    "section": "Log-Rank Test",
    "text": "Log-Rank Test\nTo compare survival experiences across multiple groups, the log-rank test forms a weighted difference of the group-specific hazards over time: \\[\n\\sum_{j=1}^{m} \\Bigl( d_{1j} - d_j \\tfrac{n_{1j}}{n_j} \\Bigr).\n\\] Under proportional hazards or similar assumptions, this statistic approximates a simple chi-square test that is powerful for detecting consistent hazard differences."
  },
  {
    "objectID": "chapter3.html#extensions-of-the-log-rank-test",
    "href": "chapter3.html#extensions-of-the-log-rank-test",
    "title": "Chapter 3 - Nonparametric Estimation and Testing",
    "section": "Extensions of the Log-Rank Test",
    "text": "Extensions of the Log-Rank Test\nFor more flexible patterns (e.g., early or delayed effects), the log-rank test can be weighted to emphasize particular time intervals or events. A “max-combo test” takes the maximum among multiple weighted variants, maintaining appropriate correlation adjustments to control the Type I error rate."
  },
  {
    "objectID": "chapter3.html#statistical-properties-and-martingales",
    "href": "chapter3.html#statistical-properties-and-martingales",
    "title": "Chapter 3 - Nonparametric Estimation and Testing",
    "section": "Statistical Properties and Martingales",
    "text": "Statistical Properties and Martingales\nHeuristic arguments clarify how these estimators and test statistics behave. More formally, a martingale framework decomposes observed increments into predictable and random parts: \\[\n\\mathrm{d}N(t) \\;=\\; I\\bigl(X \\ge t\\bigr)\\,\\lambda(t)\\,\\mathrm{d}t \\;+\\; \\mathrm{d}M(t),\n\\] where (M(t)) represents the martingale increment. This perspective simplifies derivations of asymptotic variances and supports rigorous large-sample inference for both estimation and testing."
  },
  {
    "objectID": "chap3.html#outline",
    "href": "chap3.html#outline",
    "title": "Applied Survival Analysis",
    "section": "Outline",
    "text": "Outline\n\n\nNelsen–Aalen estimator of cumulative hazard\n\nKaplan–Meier estimator of survival function\n\nLog-rank test and variations\n\nAnalysis of the German Breast Cancer study\n\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\]"
  },
  {
    "objectID": "chap3.html#nonparametric-approach",
    "href": "chap3.html#nonparametric-approach",
    "title": "Applied Survival Analysis",
    "section": "Nonparametric Approach",
    "text": "Nonparametric Approach\n\n\nMotivation\n\nNaive empirical distribution biased with censoring\nParametric models constrained\n\nWeibull model \\(\\to\\) monotone risk\n\n\n\n\n\n\nNonparametric inference\n\nEstimation of \\(S(t)=\\pr(T &gt;t)\\)\nComparison of survival function between groups\n\n\n\n\n\nDiscrete hazard: a useful tool"
  },
  {
    "objectID": "chap3.html#discrete-hazard-set-up",
    "href": "chap3.html#discrete-hazard-set-up",
    "title": "Applied Survival Analysis",
    "section": "Discrete Hazard: Set-up",
    "text": "Discrete Hazard: Set-up\n\n\nObserved data \\[(X_i, \\delta_i)\\,\\, (i=1,\\ldots, n)\\] \n\n\\(0&lt;t_1&lt;\\cdots&lt;t_m\\): unique observed event (failure) times (the \\(X_i\\) with \\(\\delta_i =1\\))\n\\(d_j\\): number of observed failures at \\(t_j\\)\n\\(n_j\\): number of subjects at risk \\(t_j\\) (those with \\(X_i\\geq t_j\\))\n\n\\(n_{j-1} - n_j\\): number of failures and censorings in \\([t_{j-1}, t_j)\\)"
  },
  {
    "objectID": "chap3.html#discrete-hazard-definition",
    "href": "chap3.html#discrete-hazard-definition",
    "title": "Applied Survival Analysis",
    "section": "Discrete Hazard: Definition",
    "text": "Discrete Hazard: Definition\n\n\nCounting process notation \\[d_j = \\sum_{i=1}^n \\dd N_i(t_j)\\, \\mbox{ and }\\,\\, n_j = \\sum_{i=1}^n I(X_i \\geq t_j)\\]\n\n\n\n\nDiscretize distribution at observed event times \\[t_1&lt;t_2&lt;\\cdots&lt;t_m\\]\n\nDiscrete hazard \\[\\dd\\Lambda(t_j)=\\pr(t_j \\leq T &lt; t_j+\\dd t\\mid T\\geq t_j)=\\pr(T = t_j\\mid T\\geq t_j)\\]\n\n\\(\\dd\\Lambda(t)\\equiv 0\\) otherwise"
  },
  {
    "objectID": "chap3.html#nelsenaalen-estimator-i",
    "href": "chap3.html#nelsenaalen-estimator-i",
    "title": "Applied Survival Analysis",
    "section": "Nelsen–Aalen Estimator (I)",
    "text": "Nelsen–Aalen Estimator (I)\n\n\nRecall in Chapter 2…\\[\\begin{align}\nE\\{\\dd N(t)\\mid X\\geq t\\}&=\\frac{\\pr\\{\\dd N^*(t)=1, C\\geq t\\}}{\\pr(T\\geq t, C\\geq t)}\n\\notag\\\\\n&=\\frac{\\pr\\{\\dd N^*(t)=1\\}\\pr(C\\geq t)}{\\pr(T\\geq t)\\pr(C\\geq t)}\n\\notag\\\\\n&=E\\{\\dd N^*(t)\\mid T\\geq t\\}\\notag\\\\\n&=\\dd\\Lambda(t),\n\\end{align}\\]\n\nSo \\[\\dd\\Lambda(t_j) = E\\{\\dd N(t_j)\\mid X\\geq t_j\\}=\\frac{E\\{\\dd N(t_j)\\}}{\\pr(X\\geq t_j)}\\]"
  },
  {
    "objectID": "chap3.html#nelsenaalen-estimator-ii",
    "href": "chap3.html#nelsenaalen-estimator-ii",
    "title": "Applied Survival Analysis",
    "section": "Nelsen–Aalen Estimator (II)",
    "text": "Nelsen–Aalen Estimator (II)\n\n\nMotivates empirical estimator \\[\\begin{align}\n\\dd\\hat\\Lambda(t_j) & = \\frac{d_j}{n_j} =\n\\frac{\\sum_{i=1}^n \\dd N_i(t_j)}{\\sum_{i=1}^n I(X_i\\geq t_j)}\\\\\n&=\\mbox{proportion of failures among those at risk}\n\\end{align}\\]\n\n\n\n\nCumulative hazard \\[\n\\hat\\Lambda(t)=\\sum_{j:t_j\\leq t}\\frac{d_j}{n_j} =\\int_0^t\\frac{\\sum_{i=1}^n \\dd N_i(u)}{\\sum_{i=1}^n I(X_i\\geq u)}\n\\]\n\nNelsen–Aalen estimator\nA step function (starting from 0) that jumps \\(d_j/n_j\\) at \\(t_j\\) \\((j=1,\\ldots, m)\\)"
  },
  {
    "objectID": "chap3.html#example-rat-carcinogen-study-i",
    "href": "chap3.html#example-rat-carcinogen-study-i",
    "title": "Applied Survival Analysis",
    "section": "Example: Rat Carcinogen Study (I)",
    "text": "Example: Rat Carcinogen Study (I)\n\n\nCarcinogenicity study: 100 rats treated with a drug\n\nFollowed for tumor development"
  },
  {
    "objectID": "chap3.html#example-rat-carcinogen-study-ii",
    "href": "chap3.html#example-rat-carcinogen-study-ii",
    "title": "Applied Survival Analysis",
    "section": "Example: Rat Carcinogen Study (II)",
    "text": "Example: Rat Carcinogen Study (II)\n\n\nFollow-up plot (sub-sample)"
  },
  {
    "objectID": "chap3.html#example-rat-carcinogen-study-iii",
    "href": "chap3.html#example-rat-carcinogen-study-iii",
    "title": "Applied Survival Analysis",
    "section": "Example: Rat Carcinogen Study (III)",
    "text": "Example: Rat Carcinogen Study (III)\n\n\n“Hand” calculations"
  },
  {
    "objectID": "chap3.html#example-rat-carcinogen-study-iv",
    "href": "chap3.html#example-rat-carcinogen-study-iv",
    "title": "Applied Survival Analysis",
    "section": "Example: Rat Carcinogen Study (IV)",
    "text": "Example: Rat Carcinogen Study (IV)\n\n\nVisualization"
  },
  {
    "objectID": "chap3.html#from-hazard-to-survival",
    "href": "chap3.html#from-hazard-to-survival",
    "title": "Applied Survival Analysis",
    "section": "From Hazard to Survival",
    "text": "From Hazard to Survival\n\n\nContinuous relationship \\[\n\\tilde S(t)=\\exp\\left\\{-\\hat\\Lambda(t)\\right\\}\n\\]\n\n\n\n\nDiscrete relationship (more general and intuitive)"
  },
  {
    "objectID": "chap3.html#progressive-conditioning",
    "href": "chap3.html#progressive-conditioning",
    "title": "Applied Survival Analysis",
    "section": "Progressive Conditioning",
    "text": "Progressive Conditioning\n\n\nSurviving past \\(t_j\\): step by step \\[\\begin{align*}\nS(t_j)&=\\pr(T&gt;t_j)\\\\\n&=\\pr(T&gt;t_1)\\pr(T&gt;t_2\\mid T&gt;t_1)\\cdots\\pr(T&gt;t_j\\mid T&gt;t_{j-1})\\\\\n&=\\pr(T&gt;t_1\\mid T\\geq t_1)\\pr(T&gt;t_2\\mid T\\geq t_2)\\cdots\\pr(T&gt;t_j\\mid T\\geq t_j)\\\\\n&=\\prod_{l=1}^j\\pr(T&gt;t_l\\mid T\\geq t_l),\n\\end{align*}\\]\n\n\n\n\nOverall \\[\\begin{equation*}\nS(t)=\\prod_{j:t_j\\leq t}\\pr(T&gt;t_j\\mid T\\geq t_j)\n\\end{equation*}\\]"
  },
  {
    "objectID": "chap3.html#kaplanmeier-estimator-1",
    "href": "chap3.html#kaplanmeier-estimator-1",
    "title": "Applied Survival Analysis",
    "section": "Kaplan–Meier Estimator",
    "text": "Kaplan–Meier Estimator\n\n\nEach conditional survival \\[\n\\pr(T&gt;t_j\\mid T\\geq t_j) = 1-\\pr(T=t_j\\mid T\\geq t_j) = 1-\\dd\\Lambda(t_j)\n\\]\n\n\n\n\nPlug-in Nelsen–Aalen \\[\\begin{equation}\n\\hat S(t)=\\prod_{j:t_j\\leq t}\\{1-\\dd\\hat\\Lambda(t_j)\\}=\\prod_{j:t_j\\leq t}(1-d_j/n_j)\n\\end{equation}\\]\n\nKaplan–Meier (product-limit) estimator\nReduces to empirical survival in the absence of censoring\nAdjusts for censoring by updating number at risk \\(t_j\\) over time"
  },
  {
    "objectID": "chap3.html#kaplanmeier-estimator-variance-i",
    "href": "chap3.html#kaplanmeier-estimator-variance-i",
    "title": "Applied Survival Analysis",
    "section": "Kaplan–Meier Estimator: Variance (I)",
    "text": "Kaplan–Meier Estimator: Variance (I)\n\n\n\\(\\var\\{\\hat S(t)\\}\\)?\n\nLog-transform: product \\(\\to\\) sum \\[\n\\log\\hat S(t)=\\sum_{j:t_j\\leq t}\\log(1-d_j/n_j)\n\\]\nDelta method\\(^*\\) \\[\n\\hat\\var\\{\\hat S(t)\\}=\\hat S(t)^2\\hat\\var\\{\\log\\hat S(t)\\},\n\\]\n\n\n\n\n\n\n\n\n\n\nDelta Method\n\n\nIf approximately \\(S_n \\sim N(\\mu, \\sigma^2)\\), then approximately \\(g(S_n) \\sim N\\left\\{g(\\mu), \\dot g(\\mu)^2\\sigma^2\\right\\}\\), where \\(\\dot g(\\mu)=\\dd g(\\mu)/\\dd\\mu\\)."
  },
  {
    "objectID": "chap3.html#kaplanmeier-estimator-variance-ii",
    "href": "chap3.html#kaplanmeier-estimator-variance-ii",
    "title": "Applied Survival Analysis",
    "section": "Kaplan–Meier Estimator: Variance (II)",
    "text": "Kaplan–Meier Estimator: Variance (II)\n\n\n\\(\\var\\{\\log\\hat S(t)\\}\\)?\n\nWith the \\(n_j\\) fixed, the \\(d_j\\) are independent (different subjects) \\[\\begin{align}\n\\hat{\\rm var}\\{\\log\\hat S(t)\\}&=\\sum_{j:t_j\\leq t}\\hat{\\rm var}\\left[\\log\\{1-d_j/n_j\\}\\right]\\notag\\\\\n&\\approx \\sum_{j:t_j\\leq t}\\frac{n_j^2}{(n_j-d_j)^2}\\hat{\\rm var}(d_j/n_j)\\tag{Delta method}\\\\\n&=\\sum_{j:t_j\\leq t}\\frac{d_j}{n_j(n_j-d_j)},\n\\end{align}\\]\nLast equality: variance of binomial proportion \\[\n\\hat{\\rm var}(d_j/n_j)=(d_j/n_j)(1-d_j/n_j)/n_j\n\\]"
  },
  {
    "objectID": "chap3.html#kaplanmeier-estimator-variance-iii",
    "href": "chap3.html#kaplanmeier-estimator-variance-iii",
    "title": "Applied Survival Analysis",
    "section": "Kaplan–Meier Estimator: Variance (III)",
    "text": "Kaplan–Meier Estimator: Variance (III)\n\n\nVariance of KM \\[\\begin{equation}\\label{eq:km:greenwood}\n\\hat\\var\\{\\hat S(t)\\}=\\hat S(t)^2\\sum_{j:t_j\\leq t}\\frac{d_j}{n_j(n_j-d_j)}\n\\end{equation}\\]\n\nGreenwood’s formula\n\n\n\n\n\nNaive 95% confidence interval (CI) \\[\\begin{equation}\\label{eq:km:ci_plain}\n\\left[\\hat S(t)-1.96\\hat\\se\\{\\hat S(t)\\}, \\hat S(t)+1.96\\hat\\se\\{\\hat S(t)\\}\\right]\n\\end{equation}\\] \n\nMay contain values outside \\([0, 1]\\)\nBounded quantity approximated by unbounded (normal) distribution"
  },
  {
    "objectID": "chap3.html#kaplanmeier-estimator-ci",
    "href": "chap3.html#kaplanmeier-estimator-ci",
    "title": "Applied Survival Analysis",
    "section": "Kaplan–Meier Estimator: CI",
    "text": "Kaplan–Meier Estimator: CI\n\n\nLog-log transformed CI\n\nTransform \\(\\zeta(t)=\\log\\{-\\log S(t)\\} \\in \\mathbb R\\)\nCI for \\(\\zeta(t)\\) \\[\\begin{equation}\n\\left[\\hat\\zeta(t)-1.96\\hat\\se\\{\\hat\\zeta(t)\\},\\hat\\zeta(t)+1.96\\hat\\se\\{\\hat\\zeta(t)\\}\\right]\n\\end{equation}\\]\nTransform the bounds back to \\(S(t)\\) \\[\n\\left[\\hat S(t)^{\\exp[1.96\\hat\\se\\{\\hat\\zeta(t)\\}]}, \\hat S(t)^{\\exp[-1.96\\hat\\se\\{\\hat\\zeta(t)\\}]}\\right]\n\\subset [0, 1]\n\\]\nRemains to calculate \\(\\hat\\se\\{\\hat\\zeta(t)\\}\\) by delta method (Exercise)"
  },
  {
    "objectID": "chap3.html#example-rat-carcinogen-study-v",
    "href": "chap3.html#example-rat-carcinogen-study-v",
    "title": "Applied Survival Analysis",
    "section": "Example: Rat Carcinogen Study (V)",
    "text": "Example: Rat Carcinogen Study (V)\n\n\n“Hand” calculations"
  },
  {
    "objectID": "chap3.html#software-survivalsurvfit-i",
    "href": "chap3.html#software-survivalsurvfit-i",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::survfit() (I)",
    "text": "Software: survival::survfit() (I)\n\n\nBasic syntax for fitting KM curve\n\n\n\n # df: data frame; time: X; status: delta\nobj &lt;- survfit(Surv(time, status) ~ 1, data = df, \n               conf.type = \"log-log\")\n\n\n\n\n\nInput\n\nSurv(time, status) ~ 1: fit curve to a homogeneous sample\n\nSurv(time, status) ~ group: fit curve to each level of group\n\ndata = df: input data frame df\nconf.type = \"log-log\": log-log transformation for CI\n\n\"log\": default log transformation\n\"plain\": naive CI"
  },
  {
    "objectID": "chap3.html#software-survivalsurvfit-ii",
    "href": "chap3.html#software-survivalsurvfit-ii",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::survfit() (II)",
    "text": "Software: survival::survfit() (II)\n\n\nOutput: a surfit object containing KM estimates\n\nCall summary() and plot()\nsummary(obj): a list containing\n\ntime: \\(t_j\\) \\((j=1,\\ldots, m)\\)\nsurv: \\(\\hat S(t_j)\\)\nn.risk: \\(n_j\\)\nn.event: \\(d_j\\)\nstd.err: \\(\\hat\\se\\{\\hat S(t_j)\\}\\)\n..."
  },
  {
    "objectID": "chap3.html#example-rat-carcinogen-study-vi",
    "href": "chap3.html#example-rat-carcinogen-study-vi",
    "title": "Applied Survival Analysis",
    "section": "Example: Rat Carcinogen Study (VI)",
    "text": "Example: Rat Carcinogen Study (VI)\n\n\nData frame: rats.rx\n\nCheck with Table 3.3\n\n\n\n\n\nobj &lt;- survfit(Surv(time, status) ~ 1, data = rats.rx, \n               conf.type = \"log-log\")\nsummary(obj)\n# Call: survfit(formula = Surv(time, status) ~ 1, data = rats.rx, \n#               conf.type = \"log-log\")\n# \n# time n.risk n.event survival std.err lower 95% CI upper 95% CI\n#   34     99       1    0.990  0.0100        0.930        0.999\n#   39     98       1    0.980  0.0141        0.922        0.995\n#   45     97       1    0.970  0.0172        0.909        0.990\n#   67     89       1    0.959  0.0202        0.894        0.984\n#   70     86       1    0.948  0.0228        0.879        0.978\n#   ..."
  },
  {
    "objectID": "chap3.html#example-rat-carcinogen-study-vii",
    "href": "chap3.html#example-rat-carcinogen-study-vii",
    "title": "Applied Survival Analysis",
    "section": "Example: Rat Carcinogen Study (VII)",
    "text": "Example: Rat Carcinogen Study (VII)\n\n\nPlot the survival function (with 95% CI)\n\nBase plot()\n\n\n\n\n\n# plot the estimated survival function\nplot(obj, ylim = c(0,1), xlim = c(0, 100), lwd = 2, frame.plot = FALSE,\n     xlab = \"Time (days)\", ylab = \"Tumor-free probabilities\", main = \"\")\n\nlegend(1, 0.2, c(\"Kaplan-Meier curve\", \"95% Confidence limits\"),\n       lty = 1:2, lwd = 2)"
  },
  {
    "objectID": "chap3.html#example-rat-carcinogen-study-viii",
    "href": "chap3.html#example-rat-carcinogen-study-viii",
    "title": "Applied Survival Analysis",
    "section": "Example: Rat Carcinogen Study (VIII)",
    "text": "Example: Rat Carcinogen Study (VIII)\n\n\nResult"
  },
  {
    "objectID": "chap3.html#comparing-survival-rates",
    "href": "chap3.html#comparing-survival-rates",
    "title": "Applied Survival Analysis",
    "section": "Comparing Survival Rates",
    "text": "Comparing Survival Rates\n\n\nMotivation: compare event rate across groups for treatment/exposure effect\n\n\n\n\nExample\n\nRat study: 100 treated (analyzed) vs 200 untreated for tumor incidence\nGBC study: hormone vs non-hormone treatments for (relapse-free) survival\n\n\n\n\n\nHypothesis \\[\\begin{equation}\\label{eq:km:null}\n    H_0: S_1(t)=S_0(t) \\mbox{ for all } t.\n\\end{equation}\\]\n\n\\(S_a(t) =\\) survival function of \\(T\\) in group \\(a\\) (\\(1\\): treatment; \\(0\\): control)"
  },
  {
    "objectID": "chap3.html#two-group-comparison-set-up",
    "href": "chap3.html#two-group-comparison-set-up",
    "title": "Applied Survival Analysis",
    "section": "Two-Group Comparison: Set-up",
    "text": "Two-Group Comparison: Set-up\n\n\nObserved data \\[\\begin{equation}\n\\{(X_{1i},\\delta_{1i}): i=1,\\ldots, N_1\\} \\mbox{ and } \\{(X_{0i},\\delta_{0i}): i=1,\\ldots, N_0\\},\n\\end{equation}\\]\n\n\\((X_{ai},\\delta_{ai})\\) \\((i=1,\\ldots, N_a)\\): a random sample of \\((X,\\delta)\\) in group \\(a\\)\n\n\\(n_{1j}\\), \\(n_{0j}\\): numbers at risk in groups 1 and 0 at \\(t_j\\) (totaling \\(n_j = n_{1j} + n_{0j}\\) at risk)\n\\(d_{1j}\\), \\(d_{0j}\\): numbers of events in groups 1 and 0 at \\(t_j\\) (totaling \\(d_j = d_{1j} + d_{0j}\\) events)"
  },
  {
    "objectID": "chap3.html#two-group-comparison-contingency",
    "href": "chap3.html#two-group-comparison-contingency",
    "title": "Applied Survival Analysis",
    "section": "Two-Group Comparison: Contingency",
    "text": "Two-Group Comparison: Contingency\n\n\nFixing \\(d_j\\) (total # uninformative of group difference)"
  },
  {
    "objectID": "chap3.html#two-group-comparison-log-rank-i",
    "href": "chap3.html#two-group-comparison-log-rank-i",
    "title": "Applied Survival Analysis",
    "section": "Two-Group Comparison: Log-rank (I)",
    "text": "Two-Group Comparison: Log-rank (I)\n\n\nContingency table \\((2\\times 2)\\)\n\n\\(H_0\\): No association between event occurence vs group affiliation\nEvent occurs in proportion to number at risk \\[\\begin{align}\nR_j&=d_{1j}-d_j\\frac{n_{1j}}{n_j}\\\\\n&=\\mbox{(Observed events)} - \\mbox{(Expected events)}\n\\end{align}\\]\n\\(R_j &gt; 0\\): higher incidence in treatment; \\(R_j &lt; 0\\): higher incidence in control\n\\(E(R_j\\mid d_j, n_{1j}, n_{0j})\\stackrel{H_0}{=}0\\)\n\\(\\var(R_j\\mid d_j, n_{1j}, n_{0j})\\stackrel{H_0}{=:} V_j\\) by hypergeometric distribution"
  },
  {
    "objectID": "chap3.html#two-group-comparison-log-rank-ii",
    "href": "chap3.html#two-group-comparison-log-rank-ii",
    "title": "Applied Survival Analysis",
    "section": "Two-Group Comparison: Log-rank (II)",
    "text": "Two-Group Comparison: Log-rank (II)\n\n\nTesting overall incidence \\[\\begin{equation}\\label{eq:km:logrank_stat}\nS_{N_1,N_0}=\\frac{(\\sum_{j=1}^m R_j)^2}{\\sum_{j=1}^m V_j}\\stackrel{H_0}{\\sim} \\chi_1^2\n\\end{equation}\\]\n\n\\(\\hat\\var(\\sum_{j=1}^m R_j)=\\sum_{j=1}^m V_j\\) by conditioning (martingale) arguments\n\nUncorrelated increments\n\nReject \\(H_0\\) if \\[S_{N_1,N_0}&gt;\\chi_1^2(1-\\alpha)\\]\n\n\\(\\chi_1^2(1-\\alpha)\\) is the \\(100(1-\\alpha)\\)th percentile of \\(\\chi_1^2\\)\n\nLog-rank test (with significance level \\(\\alpha\\))"
  },
  {
    "objectID": "chap3.html#two-group-comparison-log-rank-iii",
    "href": "chap3.html#two-group-comparison-log-rank-iii",
    "title": "Applied Survival Analysis",
    "section": "Two-Group Comparison: Log-rank (III)",
    "text": "Two-Group Comparison: Log-rank (III)\n\n\nAlternative hypothesis \\[\\begin{equation}\\label{eq:km:logrank_alter}\nH_A: \\lambda_1(t)\\leq\\lambda_0(t)\\mbox{ for all } t \\mbox{ with strict inequality for some }t\n\\end{equation}\\]\n\nOrdered hazards: treatment consistently lowers risk over time compared to control (or vice versa) \\[\\pr\\left\\{S_{N_1,N_0}&gt;\\chi_1^2(1-\\alpha)\\right\\}\\stackrel{H_A}{\\to} 1 \\mbox{ as } n\\to\\infty\\]\n\\(\\sum_{j=1}^m R_j =\\) Weighted difference of group-specific Nelsen–Aalen estimates of hazard functions (Section 3.2.2)\nCrossing hazards \\(\\to\\) weak power"
  },
  {
    "objectID": "chap3.html#log-rank-extension-multiple-groups",
    "href": "chap3.html#log-rank-extension-multiple-groups",
    "title": "Applied Survival Analysis",
    "section": "Log-Rank Extension: Multiple Groups",
    "text": "Log-Rank Extension: Multiple Groups\n\n\n\\(K\\) groups \\((k = 0, 1, \\ldots, K-1)\\) \\[\\begin{equation}\\label{eq:km:logrank_mult}\n\\gamma=\\sum_{j=1}^m\\left(d_{1j}-d_j\\frac{n_{1j}}{n_j},d_{2j}-d_j\\frac{n_{2j}}{n_j},\\ldots, d_{K-1,j}-d_j\\frac{n_{K-1,j}}{n_j}\\right)^{\\rm T}\n\\end{equation}\\]\n\n\\(t_1&lt;\\cdots&lt;t_m\\): unique event times pooled across \\(K\\) groups\n\\(d_{kj}, n_{kj}\\): numbers of failed and at-risk subjects in group \\(k\\) at \\(t_j\\)\nTest statistic \\[\n\\gamma^{\\rm T}\\var(\\gamma)^{-1}\\gamma\\stackrel{H_0}{\\sim}\\chi_{K-1}^2\n\\]\nAlternative hypothesis: exist two groups with ordered hazards"
  },
  {
    "objectID": "chap3.html#log-rank-extension-stratification",
    "href": "chap3.html#log-rank-extension-stratification",
    "title": "Applied Survival Analysis",
    "section": "Log-Rank Extension: Stratification",
    "text": "Log-Rank Extension: Stratification\n\n\nStratification: compare groups only within same stratum\n\nRace/ethnicity, sex, age group, study center\nAdjust for confounder\nStatistical efficiency\n\n\n\n\n\nTest statistic\n\nCalculate and aggregate stratum-specific \\(\\sum_{j=1}^m R_j\\)\nAlternative hypothesis: ordered hazards (same order) across strata"
  },
  {
    "objectID": "chap3.html#log-rank-extension-weighting-i",
    "href": "chap3.html#log-rank-extension-weighting-i",
    "title": "Applied Survival Analysis",
    "section": "Log-Rank Extension: Weighting (I)",
    "text": "Log-Rank Extension: Weighting (I)\n\n\nWeight \\(w_j\\) at time \\(t_j\\): \\[\\begin{equation}\\label{eq:eq:km:ej_w}\n\\frac{(\\sum_{j=1}^{m} w_jR_{j})^2}{\\sum_{j=1}^{m} w_j^2V_{j}} \\stackrel{H_0}{\\sim} \\chi_1^2\n\\end{equation}\\]\n\nLog-rank: \\(w_j\\equiv 1\\)\nGehan: \\(w_j = n_j/n\\)\nHarrington-Fleming (HF) \\(G^\\rho\\) family: \\(\\hat S(t_j-)^\\rho\\) \\((\\rho\\geq 0)\\)\n\n\\(\\hat S(t_j-)\\): KM estimate based on pooled sample\nExtended to \\(G^{\\rho,\\gamma}\\) family: \\(\\hat S(t_j-)^\\rho\\{1-\\hat S(t_j-)\\}^\\gamma\\) \\((\\rho, \\gamma \\geq 0)\\)"
  },
  {
    "objectID": "chap3.html#log-rank-extension-weighting-ii",
    "href": "chap3.html#log-rank-extension-weighting-ii",
    "title": "Applied Survival Analysis",
    "section": "Log-Rank Extension: Weighting (II)",
    "text": "Log-Rank Extension: Weighting (II)\n\n\nChoice\n\nPre-specify to avoid bias\nDecreasing weights: sensitive to early effects\nIncreasing weights: sensitive to delayed effects\nConstant weight (default): optimal for proportional hazards alternative \\[\nH_A^{\\rm PH}:\\lambda_1(t)=\\exp(\\theta)\\lambda_0(t) \\mbox{ for all } t\n\\]"
  },
  {
    "objectID": "chap3.html#software-survivalsurvdiff",
    "href": "chap3.html#software-survivalsurvdiff",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::survdiff()",
    "text": "Software: survival::survdiff()\n\n\nBasic syntax for log-rank test\n\n\n\n# Log-rank test\nsurvdiff(Surv(time, status) ~ group + strata(str_var), rho)\n\n\n\n\n\nInput\n\nSurv(time, status) ~ group: test survival function between levels of variable group\nstrata(str_var): stratified by variable str_var (optional)\nrho = r: weights \\(\\hat S(t_j-)^\\rho\\) with \\(\\rho=\\) r\n\nOutput: a list containing pvalue (p-value of the test)"
  },
  {
    "objectID": "chap3.html#example-rat-carcinogen-study-ix",
    "href": "chap3.html#example-rat-carcinogen-study-ix",
    "title": "Applied Survival Analysis",
    "section": "Example: Rat Carcinogen Study (IX)",
    "text": "Example: Rat Carcinogen Study (IX)\n\nLog-rank test by rx stratified by sex\n\n\nhead(rats)\n#   litter rx time status sex\n# 1      1  1  101      0   f\n# 2      1  0   49      1   f\n# 3      1  0  104      0   f\n# ...\n\nsurvdiff(Surv(time, status) ~ rx + strata(sex), data = rats)\n# Call:\n# survdiff(formula = Surv(time, status) ~ rx + strata(sex), data = rats)\n# \n#        N Observed Expected (O-E)^2/E (O-E)^2/V\n# rx=0 200       21     28.9      2.16      6.99\n# rx=1 100       21     13.1      4.77      6.99\n# \n#  Chisq= 7  on 1 degrees of freedom, p= 0.008"
  },
  {
    "objectID": "chap3.html#baseline-characteristics",
    "href": "chap3.html#baseline-characteristics",
    "title": "Applied Survival Analysis",
    "section": "Baseline Characteristics",
    "text": "Baseline Characteristics\n\n\n686 patients with primary node positive breast cancer"
  },
  {
    "objectID": "chap3.html#relapse-free-survival",
    "href": "chap3.html#relapse-free-survival",
    "title": "Applied Survival Analysis",
    "section": "Relapse-Free Survival",
    "text": "Relapse-Free Survival\n\nEndpoint: the earlier of relapse or death"
  },
  {
    "objectID": "chap3.html#hormone-treatment-effect",
    "href": "chap3.html#hormone-treatment-effect",
    "title": "Applied Survival Analysis",
    "section": "Hormone Treatment Effect",
    "text": "Hormone Treatment Effect\n\n\nHormonal therapy\n\nStratified by menopausal status\n\n\n\n## Stratified log-rank test (by menopausal status)\nsurvdiff(Surv(time, status) ~ hormone + strata(meno),\n         data = data.CE)\n\n\n\n\nResult\n\n\\(\\chi_1^2=\\) 9.5 with p-value 0.002\n\nAdjusting for menopausal status, hormonal therapy has a highly significant beneficial effect on relapse-free survival in breast cancer patients\n\nUnadjusted test result similar"
  },
  {
    "objectID": "chap3.html#notes",
    "href": "chap3.html#notes",
    "title": "Applied Survival Analysis",
    "section": "Notes",
    "text": "Notes\n\n\nKaplan and Meier (1958)\n\n60k + citations by Feb 2025\nMost cited statistical paper of all time\n\n\n\n\n\nDerivation of log-rank\n\nMantel–Haenszel (1959) analysis of \\(2\\times 2\\) contingency tables stratified by \\(t_j\\)\n\n\n\n\n\nOther tests\n\nGehan npsm::gehan.test()\nMax-combo nph::logrank.maxtest() (maximum over multiple weighting schemes)"
  },
  {
    "objectID": "chap3.html#summary-i",
    "href": "chap3.html#summary-i",
    "title": "Applied Survival Analysis",
    "section": "Summary (I)",
    "text": "Summary (I)\n\n\nDiscrete hazard: \\(\\dd\\Lambda(t_j)= d_j/n_j\\) \n\nProportion of failures among those at risk\n\n\n\n\n\nKaplan–Meier \\[\\begin{equation}\n\\hat S(t)=\\prod_{j:t_j\\leq t}\\{1-\\dd\\hat\\Lambda(t_j)\\}=\\prod_{j:t_j\\leq t}(1-d_j/n_j)\n\\end{equation}\\]\n\nsurvival::survfit():"
  },
  {
    "objectID": "chap3.html#summary-ii",
    "href": "chap3.html#summary-ii",
    "title": "Applied Survival Analysis",
    "section": "Summary (II)",
    "text": "Summary (II)\n\n\nLog-rank test: multi-group comparison\n\n\\(K\\) groups \\(\\to\\) \\(K-1\\) degrees of freedom\nStratification: adjust for confounding\nWeighting: optimality depends on effect pattern over time\nsurvival::survdiff()\n\n\n\n\n\nEnhanced tabulation and graphics\n\ngtsummary::tbl_survfit()\nggsurvfit::ggsurvfit()"
  },
  {
    "objectID": "chap3.html#hw2-due-feb-21",
    "href": "chap3.html#hw2-due-feb-21",
    "title": "Applied Survival Analysis",
    "section": "HW2 (Due Feb 21)",
    "text": "HW2 (Due Feb 21)\n\nChoose one\n\nProblem 3.2\nProblem 3.3\n\nProblem 3.17\n(Extra credit) Problem 3.15"
  },
  {
    "objectID": "chapter3.html#software-use",
    "href": "chapter3.html#software-use",
    "title": "Chapter 3 - Nonparametric Estimation and Testing",
    "section": "Software Use",
    "text": "Software Use\nNonparametric survival estimates and log-rank tests are easily performed in R via the survival package. The survfit function fits Kaplan–Meier curves from a time-to-event variable and an event indicator, while the survdiff function calculates log-rank tests (and variations such as stratified or weighted log-rank). Many standard analyses can therefore be completed with just a few lines of code, shown below:\n\nlibrary(survival)\n\n# Fit Kaplan–Meier curves for two groups\nkm_fit &lt;- survfit(Surv(time, status) ~ group, data = mydata)\n\n# Summarize survival estimates and times\nsummary(km_fit)\n\n# Perform a log-rank test to compare groups\nlr_test &lt;- survdiff(Surv(time, status) ~ group, data = mydata)\nlr_test\n\nAdditional utilities are available for generating publication-ready tables and plots. The gtsummary package, for instance, provides a tbl_survfit() function that creates neatly formatted tables of survival estimates by group or stratum, including confidence intervals and median times. The ggsurvfit package extends ggplot2 to produce enhanced Kaplan–Meier graphs with at-risk tables, confidence interval shading, and optional log-rank \\(p\\)-values annotated on the plot:\n\nlibrary(gtsummary)\nlibrary(ggsurvfit)\n\n# Summarize survival estimates in a neat table\ntbl &lt;- tbl_survfit(km_fit, times = c(12, 24, 48, 96))\ntbl\n\n# Create a KM plot with confidence intervals and at-risk tables\nggsurvfit(km_fit) +\n  add_confidence_interval() +\n  add_risktable()\n\nThese higher-level functions streamline the presentation of nonparametric survival analyses, ensuring that both the numeric results and the visual displays are clear and publication-ready.\n\nConclusion\nDiscrete hazard constructs offer a flexible pathway to nonparametric survival estimation and testing. By updating risk sets at each event time, they integrate censoring efficiently into hazard estimators, leading to the Kaplan–Meier survival curve. For group comparisons, the log-rank test accumulates deviations in observed vs. expected failures across time, capturing hazard differences in a simple chi-square framework. Weighted extensions and max-combo designs handle a variety of hazard patterns and timing effects, while stratification addresses possible confounders. Underlying it all, martingale theory justifies the large-sample performance of these methods, ensuring that discrete hazard philosophies and counting-process constructions jointly deliver robust conclusions for a wide range of time-to-event analyses."
  },
  {
    "objectID": "chapter3.html#software-use-1",
    "href": "chapter3.html#software-use-1",
    "title": "Chapter 3 - Nonparametric Estimation and Testing",
    "section": "Software Use",
    "text": "Software Use\nNonparametric survival estimates and log-rank tests are easily performed in the environment via the package. The function fits Kaplan–Meier curves from a time-to-event variable and an event indicator, while the function calculates log-rank tests (and variations such as stratified or weighted log-rank). Many standard analyses can therefore be completed with just a few lines of code, shown below:\n\nlibrary(survival)\n\n# Fit Kaplan–Meier curves for two groups\nkm_fit &lt;- survfit(Surv(time, status) ~ group, data = mydata)\n\n# Summarize survival estimates and times\nsummary(km_fit)\n\n# Perform a log-rank test to compare groups\nlr_test &lt;- survdiff(Surv(time, status) ~ group, data = mydata)\nlr_test\n\nAdditional utilities are available for generating publication-ready tables and plots. The gtsummary package, for instance, provides a tbl_survfit() function that creates neatly formatted tables of survival estimates by group or stratum, including confidence intervals and median times. The ggsurvfit package extends ggplot2 to produce enhanced Kaplan–Meier graphs with at-risk tables, confidence interval shading, and optional log-rank \\(p\\)-values annotated on the plot:\n\nlibrary(gtsummary)\nlibrary(ggsurvfit)\n\n# Summarize survival estimates in a neat table\ntbl &lt;- tbl_survfit(km_fit, times = c(12, 24, 48, 96))\ntbl\n\n# Create a KM plot with confidence intervals and at-risk tables\nggsurvfit(km_fit) +\n  add_confidence_interval() +\n  add_risktable()\n\nThese higher-level functions streamline the presentation of nonparametric survival analyses, ensuring that both the numeric results and the visual displays are clear and publication-ready.\n\nConclusion\nDiscrete hazard constructs offer a flexible pathway to nonparametric survival estimation and testing. By updating risk sets at each event time, they integrate censoring efficiently into hazard estimators, leading to the Kaplan–Meier survival curve. For group comparisons, the log-rank test accumulates deviations in observed vs. expected failures across time, capturing hazard differences in a simple chi-square framework. Weighted extensions and max-combo designs handle a variety of hazard patterns and timing effects, while stratification addresses possible confounders. Underlying it all, martingale theory justifies the large-sample performance of these methods, ensuring that discrete hazard philosophies and counting-process constructions jointly deliver robust conclusions for a wide range of time-to-event analyses."
  },
  {
    "objectID": "chap3.html#software-gtsummary",
    "href": "chap3.html#software-gtsummary",
    "title": "Applied Survival Analysis",
    "section": "Software: gtsummary::",
    "text": "Software: gtsummary::"
  },
  {
    "objectID": "chap3.html#software-gtsummarytbl_survfit",
    "href": "chap3.html#software-gtsummarytbl_survfit",
    "title": "Applied Survival Analysis",
    "section": "Software: gtsummary::tbl_survfit()",
    "text": "Software: gtsummary::tbl_survfit()\n\n\nCustomizable, publication-ready table\n\nBased on survfit() results\n\n\n\n\n\n# install.packages(\"gtsummary\")\nlibrary(gtsummary)\n# A single-group KM model\nobj &lt;- survfit(Surv(time, status) ~ 1, data = df)\n\n# Summaries at specific times\ntbl_surv &lt;- tbl_survfit(\n  x = obj,                         # Provide the fitted survfit object\n  times = seq(40, 100, by = 20),   # Time points for survival rates\n  label_header = \"{time} days\"     # Column label: \"xx days\"\n)\n\n# Print out the table\ntbl_surv"
  },
  {
    "objectID": "chap3.html#software-ggsurvfitggsurvfit",
    "href": "chap3.html#software-ggsurvfitggsurvfit",
    "title": "Applied Survival Analysis",
    "section": "Software: ggsurvfit::ggsurvfit()",
    "text": "Software: ggsurvfit::ggsurvfit()\n\n\nEnhanced KM plot\n\nPowered by ggplot2\n\n\n\n\n\n# install.packages(\"ggsurvfit\")\nlibrary(ggsurvfit)\nobj &lt;- survfit(Surv(time, status) ~ 1, data = df)\n\n# Create a KM plot with confidence intervals and an at-risk table\nggsurvfit(obj) +\n  add_confidence_interval() + # Shaded 95% CI region\n  add_risktable() +           # Show risk table\n  scale_x_continuous(breaks = seq(0, 100, by = 20)) + # X-axis breaks\n  ylim(0, 1) +                # Y-axis limits\n  labs(\n    x = \"Time (days)\",\n    y = \"Tumor-free probabilities\"\n  ) +\n  theme_minimal()"
  },
  {
    "objectID": "chap3.html#software-gtsummarytbl_survfit-i",
    "href": "chap3.html#software-gtsummarytbl_survfit-i",
    "title": "Applied Survival Analysis",
    "section": "Software: gtsummary::tbl_survfit() (I)",
    "text": "Software: gtsummary::tbl_survfit() (I)\n\n\nCustomizable, publication-ready table\n\nBased on survfit() results\n\n\n\n\n\n# install.packages(\"gtsummary\")\nlibrary(gtsummary)\n# A single-group KM model\nobj &lt;- survfit(Surv(time, status) ~ 1, data = df)\n\n# Summaries at specific times\ntbl_surv &lt;- tbl_survfit(\n  x = obj,                         # Provide the fitted survfit object\n  times = seq(40, 100, by = 20),   # Time points for survival rates\n  label_header = \"{time} days\"     # Column label: \"xx days\"\n)\n\n# Print out the table\ntbl_surv"
  },
  {
    "objectID": "chap3.html#software-gtsummarytbl_survfit-1",
    "href": "chap3.html#software-gtsummarytbl_survfit-1",
    "title": "Applied Survival Analysis",
    "section": "Software: gtsummary::tbl_survfit()",
    "text": "Software: gtsummary::tbl_survfit()\n\n\nMulti-group tabulation\n\n\nlibrary(gtsummary)\n# A two-group KM model\nobj &lt;- survfit(Surv(time, status) ~ rx, data = rats)\n\n# Summaries at specific times with labeled treatment groups\ntbl_surv &lt;- tbl_survfit(\n  x = obj,                         # Provide the fitted survfit object\n  times = seq(40, 100, by = 20),   # Time points for survival rates\n  label_header = \"{time} days\",    # Column label: \"xx days\"\n  label = list(rx ~ \"Treatment\")   # Rename 'rx' to 'Treatment'\n)\n\n# Print out the table\ntbl_surv"
  },
  {
    "objectID": "chap3.html#software-ggsurvfitggsurvfit-1",
    "href": "chap3.html#software-ggsurvfitggsurvfit-1",
    "title": "Applied Survival Analysis",
    "section": "Software: ggsurvfit::ggsurvfit()",
    "text": "Software: ggsurvfit::ggsurvfit()\n\n\nMulti-group KM graphics\n\n\nlibrary(ggsurvfit)\n\n# Use survfit2 as recommended by ggsurvfit\nobj2 &lt;- survfit2(Surv(time, status) ~ rx, data = rats)\n\n# Create a group-specific KM plot with log-rank test p-value\nggsurvfit(obj, linetype_aes = TRUE, linewidth = 1) +  # Use line types \n  add_risktable(                    \n    risktable_stats = \"n.risk\",  # Include only numbers at risk\n    theme = list(\n      theme_risktable_default(),  # Default risk table theme\n      scale_y_discrete(labels = c('Drug', 'Control'))  # Group labels\n    )\n  ) +  \n  theme_classic()"
  },
  {
    "objectID": "chap3.html#relapse-free-survival-overall",
    "href": "chap3.html#relapse-free-survival-overall",
    "title": "Applied Survival Analysis",
    "section": "Relapse-Free Survival: Overall",
    "text": "Relapse-Free Survival: Overall\n\n\nEndpoint: the earlier of relapse or death"
  },
  {
    "objectID": "chap3.html#relapse-free-survival-by-menupause",
    "href": "chap3.html#relapse-free-survival-by-menupause",
    "title": "Applied Survival Analysis",
    "section": "Relapse-Free Survival: by Menupause",
    "text": "Relapse-Free Survival: by Menupause"
  },
  {
    "objectID": "chap3.html#relapse-free-survival-subgroups",
    "href": "chap3.html#relapse-free-survival-subgroups",
    "title": "Applied Survival Analysis",
    "section": "Relapse-Free Survival: Subgroups",
    "text": "Relapse-Free Survival: Subgroups\n\n\nMenopausal status: pre- vs post-menopausal"
  },
  {
    "objectID": "chap3.html#hw2-due-feb-19",
    "href": "chap3.html#hw2-due-feb-19",
    "title": "Applied Survival Analysis",
    "section": "HW2 (Due Feb 19)",
    "text": "HW2 (Due Feb 19)\n\nChoose one\n\nProblem 3.2\nProblem 3.3\n\nProblem 3.19\n(Extra credit) Choose one\n\nProblem 3.15\nProblems 3.17 and 3.18"
  },
  {
    "objectID": "chapter4.html#r-code",
    "href": "chapter4.html#r-code",
    "title": "Chapter 4 - Cox Proportional Hazards Regression",
    "section": "R Code",
    "text": "R Code\n\n\nShow the code\n###############################################################################\n# Chapter 4 R Code\n#\n# This script reproduces all major numerical results in Chapter 4, including:\n#   1. A Cox proportional hazards model on the German Breast Cancer (GBC) study\n#      (Figure 4.2, Table 4.1)\n#   2. Residual analysis and model diagnostics (Figures 4.3–4.6, Tables 4.2–4.4)\n#   3. Cox model with time-varying covariates for Stanford Heart study (Table 4.6)\n###############################################################################\n\n\n#==============================================================================\n# (A) Cox Proportional Hazards Model on GBC Data \n#     (Section 4.2.6, Figure 4.2)\n#==============================================================================\nlibrary(survival)\nlibrary(tidyverse) # for data manipulation and visualization\n\n#------------------------------------------------------------------------------\n# 1. Read GBC data, subset to first events, set up for Cox PH\n#------------------------------------------------------------------------------\ngbc &lt;- read.table(\"Data//German Breast Cancer Study//gbc.txt\")\n\n# Sort the data by time within each id\no &lt;- order(gbc$id, gbc$time)\ngbc &lt;- gbc[o,]\n\n# Keep the first row for each id (first event)\ndf &lt;- gbc[!duplicated(gbc$id), ]\n\n# Set status = 1 if status == 2 or 1\ndf$status &lt;- (df$status &gt; 0) + 0\n\n#------------------------------------------------------------------------------\n# 2. Fit the Cox proportional hazards model\n#------------------------------------------------------------------------------\n# Convert categorical variables to factors\ndf$hormone &lt;- factor(df$hormone)\ndf$meno    &lt;- factor(df$meno)\ndf$grade   &lt;- factor(df$grade)\n\n# Reduce the scales of prog and estrg by 100\ndf$prog  &lt;- df$prog / 100\ndf$estrg &lt;- df$estrg / 100\n\nobj &lt;- coxph(\n  Surv(time, status) ~ hormone + meno + age + size + grade + prog + estrg,\n  data = df\n)\n\n# beta estimates\nobj$coefficients\n\n# variance matrix\nobj$var\n\n# Summarize results\nsummary(obj)\n\n# Wald test on tumor grade (H_0: beta_grade2 = beta_grade3 = 0)\nbeta_q  &lt;- obj$coefficients[5:6]\nSigma_q &lt;- obj$var[5:6, 5:6]\nchisq2  &lt;- t(beta_q) %*% solve(Sigma_q) %*% beta_q\npval    &lt;- 1 - pchisq(chisq2, 2)\npval\n\n#------------------------------------------------------------------------------\n# 3. Breslow estimates of the baseline cumulative hazard\n#------------------------------------------------------------------------------\nLambda0 &lt;- basehaz(obj, centered = FALSE)\n\n# Plot the baseline hazard function\nplot(\n  stepfun(Lambda0$time, c(0, Lambda0$hazard)), \n  do.points   = FALSE,\n  cex.axis    = 0.9,\n  lwd         = 2,\n  frame.plot  = FALSE,\n  xlim        = c(0, 100),\n  ylim        = c(0, 0.8),\n  xlab        = \"Time (months)\",\n  ylab        = \"Baseline cumulative hazard\",\n  main        = \"\"\n)\n\n#------------------------------------------------------------------------------\n# 4. Enhanced tabulation via gtsummary\n#------------------------------------------------------------------------------\nlibrary(gtsummary)\n\nobj &lt;- coxph(\n  Surv(time, status) ~ hormone + meno + age + size + grade + prog + estrg,\n  data = df\n)\n\ntbl &lt;- tbl_regression(\n  obj, \n  exponentiate = TRUE,\n  label = list(\n    hormone = \"Hormone\", \n    meno    = \"Menopause\",\n    age     = \"Age (years)\",\n    size    = \"Tumor size (mm)\",\n    grade   = \"Tumor grade (1-3)\",\n    prog    = \"Progesterone (fmol/mg)\",\n    estrg   = \"Estrogen  (fmol/mg)\"\n  )\n)\ntbl\n\n#------------------------------------------------------------------------------\n# 5. Forest plot via survminer\n#------------------------------------------------------------------------------\nlibrary(survminer)\nggforest(obj, data = df)\n\n\n#==============================================================================\n# (B) Residual Analysis (Figures 4.3–4.6)\n#==============================================================================\n############################\n# Cox-Snell residuals, etc.\n############################\n\n#------------------------------------------------------------------------------\n# 1. Cox-Snell residuals\n#------------------------------------------------------------------------------\ncoxsnellres &lt;- df$status - resid(obj, type = \"martingale\")\n\n# Then use the N–A method to estimate the cumulative hazard of residuals\nfit &lt;- survfit(Surv(coxsnellres, df$status) ~ 1)\nHtilde &lt;- cumsum(fit$n.event / fit$n.risk)\n\npar(mfrow = c(1, 1))\nplot(\n  log(fit$time), log(Htilde), \n  xlab       = \"log(t)\",\n  ylab       = \"log-cumulative hazard\",\n  frame.plot = FALSE,\n  xlim       = c(-8, 2),\n  ylim       = c(-8, 2)\n)\nabline(0, 1, lty = 3, lwd = 1.5)\n\n# ggplot version of Cox-Snell\ntibble(\n  time   = fit$time,\n  Htilde = Htilde\n) %&gt;%\n  ggplot(aes(x = log(time), y = log(Htilde))) +\n  geom_point(size = 2) +\n  geom_abline(intercept = 0, slope = 1, linetype = \"dashed\", linewidth = 1) +\n  xlab(\"log(t)\") +\n  ylab(\"Log-cumulative hazard\") +\n  theme_minimal() +\n  coord_fixed()\n\nggsave(\"images/cox_cox_snell.png\", width = 4, height = 4)\nggsave(\"images/cox_cox_snell.eps\", width = 4, height = 4)\n\n#------------------------------------------------------------------------------\n# 2. Schoenfeld residuals (test proportional hazards)\n#------------------------------------------------------------------------------\nsch &lt;- cox.zph(obj)\nsch$table  # p-values for each covariate and the global test\n\n# Base R plots\npar(mar = c(4, 4, 2, 2), mfrow = c(4, 2))\nplot(\n  sch, \n  xlab    = \"Time (months)\", \n  lwd     = 2, \n  cex.lab = 1.2, \n  cex.axis= 1.2,\n  ylab    = c(\"Hormone\", \"Menopause\", \"Age\", \"Tumor size\",\n              \"Tumor grade\", \"Progesterone\", \"Estrogen\")\n)\n\n# survminer version\nggcoxzph(sch)\n\n#------------------------------------------------------------------------------\n# 3. Re-fit with stratification by tumor grade\n#------------------------------------------------------------------------------\nobj_stra &lt;- coxph(\n  Surv(time, status) ~ hormone + meno + age + size + prog + estrg + strata(grade),\n  data = df\n)\n\n# Check PH with stratification\nsch_stra &lt;- cox.zph(obj_stra)\nround(sch_stra$table, 4)\n\nggcoxzph(sch_stra)\n\n# Residual plots for stratified model\npar(mfrow = c(3, 2))\nplot(\n  sch_stra, \n  xlab     = \"Time (months)\",\n  lwd      = 2,\n  cex.lab  = 1.2,\n  cex.axis = 1.2,\n  ylab     = c(\"Hormone\", \"Menopause\", \"Age\", \"Tumor size\",\n               \"Progesterone\", \"Estrogen\")\n)\n\n#------------------------------------------------------------------------------\n# 4. Martingale/deviance residuals\n#------------------------------------------------------------------------------\nmart_resid &lt;- resid(obj_stra, type = \"martingale\")\ndev_resid  &lt;- resid(obj_stra, type = \"deviance\")\n\n# Plot martingale residuals vs. quantitative covariates\npar(mfrow = c(2, 2))\n\n# Age\nplot(\n  df$age, mart_resid,\n  xlab = \"Age (years)\", \n  ylab = \"Martingale residuals\",\n  main = \"Age\", \n  cex.lab = 1.2, \n  cex.axis= 1.2\n)\nlines(lowess(df$age, mart_resid), lwd = 2)\nabline(0, 0, lty = 3, lwd = 2)\n\n# Tumor size\nplot(\n  df$size, mart_resid,\n  xlab = \"Tumor size (mm)\", \n  ylab = \"Martingale residuals\",\n  main = \"Tumor size\", \n  cex.lab = 1.2, \n  cex.axis= 1.2\n)\nlines(lowess(df$size, mart_resid), lwd = 2)\nabline(0, 0, lty = 3, lwd = 2)\n\n# Progesterone\nplot(\n  df$prog, mart_resid,\n  xlab = \"Progesterone receptor (100 fmol/mg)\",\n  ylab = \"Martingale Residuals\",\n  main = \"Progesterone\",\n  cex.lab = 1.2, \n  cex.axis= 1.2\n)\nlines(lowess(df$prog, mart_resid), lwd = 2)\nabline(0, 0, lty = 3, lwd = 2)\n\n# Estrogen\nplot(\n  df$estrg, mart_resid,\n  xlab = \"Estrogen receptor (100 fmol/mg)\",\n  ylab = \"Martingale Residuals\",\n  main = \"Estrogen\",\n  cex.lab = 1.2, \n  cex.axis= 1.2\n)\nlines(lowess(df$estrg, mart_resid), lwd = 2)\nabline(0, 0, lty = 3, lwd = 2)\n\n#------------------------------------------------------------------------------\n# 5. Addressing non-linear age effect\n#------------------------------------------------------------------------------\ndf$agec &lt;- (df$age &lt;= 40) + 2 * (df$age &gt; 40 & df$age &lt;= 60) + 3 * (df$age &gt; 60)\ndf$agec &lt;- factor(df$agec)\n\nobj_stra_final &lt;- coxph(\n  Surv(time, status) ~ hormone + meno + agec + size + prog + estrg + strata(grade),\n  data = df\n)\n\nfinal_sum &lt;- summary(obj_stra_final)\nfinal_sum\n\n# Tabulate final model results\ntbl_final &lt;- tbl_regression(\n  obj_stra_final, \n  exponentiate = TRUE,\n  label = list(\n    hormone = \"Hormone\", \n    meno    = \"Menopause\",\n    agec    = \"Age group\",\n    size    = \"Tumor size (mm)\",\n    prog    = \"Progesterone (100 fmol/mg)\",\n    estrg   = \"Estrogen  (100 fmol/mg)\"\n  )\n)\n\n# Print table\ntbl_final\n\n# Plot the age-group-specific HR and confidence intervals (Figure 4.6)\nci.table &lt;- final_sum$conf.int\nhr       &lt;- ci.table[3:4, 1]\nhr.low   &lt;- ci.table[3:4, 3]\nhr.up    &lt;- ci.table[3:4, 4]\n\npar(mfrow = c(1, 1))\nplot(\n  1:3, c(1, hr),\n  ylim     = c(0, 1.2),\n  frame    = FALSE,\n  xaxt     = 'n',\n  xlab     = \"Age (years)\",\n  ylab     = \"Hazard ratio\",\n  pch      = 19,\n  cex      = 1.5,\n  cex.lab  = 1.2,\n  cex.axis = 1.2\n)\naxis(1, at = c(1, 2, 3), labels = c(\"(20, 40]\", \"(40, 60]\", \"(60, 80]\"), cex.axis = 1.2)\narrows(2:3, hr.low, 2:3, hr.up, length = 0.05, angle = 90, code = 3, lwd = 2)\nlines(1:3, c(1, hr), lty = 3, lwd = 2)\n\n# ggplot version\ntibble(\n  age_group = c(\"(20, 40]\", \"(40, 60]\", \"(60, 80]\"),\n  HR       = c(1, hr),\n  HR_low   = c(1, hr.low),\n  HR_up    = c(1, hr.up)\n) %&gt;%\n  ggplot(aes(x = age_group, y = HR)) +\n  geom_point(size = 3) +\n  geom_errorbar(aes(ymin = HR_low, ymax = HR_up), width = 0.2, linewidth = 0.8) +\n  geom_line(group = 1, linetype = \"dashed\", linewidth = 0.8) +\n  xlab(\"Age group (years)\") +\n  ylab(\"Hazard ratio\") +\n  theme_minimal() +\n  scale_y_log10(\n    limits = c(0.125, 1.05),\n    breaks = c(0.125, 0.25, 0.5, 0.75, 1),\n    labels = scales::label_percent(accuracy = 1)\n  ) +\n  theme(axis.text = element_text(size = 10))\n\nggsave(\"images/cox_nonlinear_age.png\", width = 7.5, height = 4)\nggsave(\"images/cox_nonlinear_age.eps\", width = 7.5, height = 4)\n\n#==============================================================================\n# (C) Illustration with Time-Varying Covariates \n#     (Stanford Heart Study)\n#==============================================================================\nhead(heart)\n\n# Rename variable \"year\" -&gt; \"accpt\"\ncolnames(heart)[5] &lt;- \"accpt\"\n\n# Sample size\nn &lt;- length(unique(heart$id))\n\n#------------------------------------------------------------------------------\n# 1. Fit a Cox model with a time-dependent \"transplant\" variable\n#------------------------------------------------------------------------------\nobj &lt;- coxph(Surv(start, stop, event) ~ age + accpt + surgery + transplant, data = heart)\n\nsummary(obj)\n\n# Tabulate using gtsummary\nheart_tbl &lt;- tbl_regression(\n  obj, \n  exponentiate = TRUE,\n  label = list(\n    age       = \"Age (years)\",\n    accpt     = \"Acceptance\",\n    surgery   = \"Surgery\",\n    transplant= \"Transplant\"\n  )\n)\n\nheart_tbl",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 4 - Cox Proportional Hazards Regression"
    ]
  },
  {
    "objectID": "chap4.html#outline",
    "href": "chap4.html#outline",
    "title": "Applied Survival Analysis",
    "section": "",
    "text": "Model specification\nPartial-likelihood estimation and inference\nResidual analysis and goodness-of-fit\nTime-dependent covariates\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\]"
  },
  {
    "objectID": "chap4.html#regression-modeling",
    "href": "chap4.html#regression-modeling",
    "title": "Applied Survival Analysis",
    "section": "Regression Modeling",
    "text": "Regression Modeling\n\n\nRegression vs testing\n\nMultiple (quantitative) predictors\nQuantify treatment effect\n\n\n\n\n\nCox proportional hazards (PH) model\n\nMost popular for time-to-event data\nConditional (covariate-specific) hazard of \\(T\\) \\[\n\\lambda(t\\mid Z)\\dd t = \\pr(t\\leq T &lt; t +\\dd t\\mid T\\geq t, Z)\n\\]\n\n\\(Z=(Z_{\\cdot 1},\\ldots, Z_{\\cdot p})^\\T\\): a \\(p\\)-vector of covariates\n\\(\\lambda(t\\mid z)\\): risk for a subject in the sub-population with \\(Z = z\\)"
  },
  {
    "objectID": "chap4.html#cox-proportional-hazards-model",
    "href": "chap4.html#cox-proportional-hazards-model",
    "title": "Applied Survival Analysis",
    "section": "Cox Proportional Hazards Model",
    "text": "Cox Proportional Hazards Model\n\n\nModel specification \\[\\begin{equation}\\label{eq:cox:model_spec}\n\\lambda(t\\mid Z)=\\lambda_0(t)\\exp(\\beta^\\T Z)\n\\end{equation}\\]\n\n\\(\\beta=(\\beta_1,\\ldots,\\beta_p)^\\T\\): \\(p\\)-dimensional regression coefficients\n\\(\\lambda_0(t)\\): (nonparametric) baseline hazard function\n\n\n\n\n\nProportionality: comparing two covariate groups \\[\\begin{equation}\\label{eq:cox:prop_haz}\n\\frac{\\lambda(t\\mid z_i)}{\\lambda(t\\mid z_j)}=\\exp\\{\\beta^\\T (z_i-z_j)\\}.\n\\end{equation}\\]\n\n\\(\\beta_k\\): log-hazard ratio with one unit increase in \\(Z_{\\cdot k}\\) \\((k=1,\\ldots, p)\\)\n\none unit increase in \\(Z_{\\cdot k}\\) increases (reduces) risk by \\(\\exp(\\beta_k)\\)"
  },
  {
    "objectID": "chap4.html#parametric-sub-model",
    "href": "chap4.html#parametric-sub-model",
    "title": "Applied Survival Analysis",
    "section": "Parametric Sub-Model",
    "text": "Parametric Sub-Model\n\n\nParametrize baseline function \\[\\begin{equation}\\label{eq:cox:ph_param}\n\\lambda(t\\mid Z;\\theta)=\\lambda_0(t;\\eta)\\exp(\\beta^\\T Z)\n\\end{equation}\\]\n\n\\(\\theta=(\\beta, \\eta)\\)\n\n\n\n\n\nWeibull PH model \\[\\begin{equation}\\label{eq:cox:weibull_base}\n\\lambda(t\\mid Z;\\theta)=\\alpha\\gamma^{-\\alpha}t^{\\alpha-1}\\exp(\\beta^\\T Z).\n\\end{equation}\\]\n\n\n\n\nEstimation\n\nMaximum likelihood (Chapter 2)"
  },
  {
    "objectID": "chap4.html#censored-data-and-assumption",
    "href": "chap4.html#censored-data-and-assumption",
    "title": "Applied Survival Analysis",
    "section": "Censored Data and Assumption",
    "text": "Censored Data and Assumption\n\n\nObserved data \\[\\begin{equation}\\label{eq:cox:obs_data}\n(X_i, \\delta_i, Z_i), \\hspace{5mm} i=1,\\ldots,n,\n\\end{equation}\\]\n\ni.i.d. replicates of \\((X, \\delta, Z)\\), where \\(X=\\min(T, C)\\) and \\(\\delta=I(T\\leq C)\\)\n\n\n\n\n\nIndependent censoring (conditional) \\[\\begin{equation}\\label{eq:cox:cond_ind}\n(C\\indep T)\\mid Z.\n\\end{equation}\\]\n\nCensoring distribution can differ between covariate levels\nMust be independent with outcome within each level"
  },
  {
    "objectID": "chap4.html#parametric-mle",
    "href": "chap4.html#parametric-mle",
    "title": "Applied Survival Analysis",
    "section": "Parametric MLE",
    "text": "Parametric MLE\n\n\nGeneral form of score function (Chapter 2)\n\nMartingale integral of hazard score \\(\\partial\\log\\lambda(t\\mid Z,\\theta)/\\partial\\theta\\)\nFirst component: \\(\\partial\\log\\lambda(t\\mid Z,\\theta)/\\partial\\beta=Z\\)\n\n\n\n\n\nScore function \\[\\begin{equation}\\label{eq:cox:score}\n\\Pn\\left[\\int_0^\\infty\\left\\{Z_i^\\T,\\frac{\\partial}{\\partial\\eta^\\T}\\log\\lambda_0(t;\\hat\\eta)\\right\\}^\\T\\dd M_i(t;\\hat\\theta)\\right]=0,\n\\end{equation}\\]\n\n\\(\\dd M_i(t; \\theta)=\\dd N_i(t)-I(X_i\\geq t)\\exp(\\beta^\\T Z_i)\\lambda_0(t;\\eta)\\dd t\\)\nSolve by standard Newton-Raphson algorithm"
  },
  {
    "objectID": "chap4.html#semiparametric-model",
    "href": "chap4.html#semiparametric-model",
    "title": "Applied Survival Analysis",
    "section": "Semiparametric Model",
    "text": "Semiparametric Model\n\n\nParametric constraints\n\nDetermine shape of baseline function\n\n\n\n\n\nSemiparametric model\n\n\\(\\beta\\): parametric covariate effects\n\\(\\lambda_0(\\cdot)\\): nonparametric time trend\nStandard MLE does not apply due to nonparametric \\(\\lambda_0(\\cdot)\\)\n\n\n\n\n\nPartial likelihood\n\nFocus on data most relevant to covariate effects\nA function of only \\(\\beta\\) not \\(\\lambda_0(\\cdot)\\)"
  },
  {
    "objectID": "chap4.html#set-up",
    "href": "chap4.html#set-up",
    "title": "Applied Survival Analysis",
    "section": "Set-up",
    "text": "Set-up\n\n\nObserved event times \\(t_1&lt;\\cdots&lt;t_m\\)\n\n\\(\\mathcal F_j =\\{(j)\\}\\): singleton index (assume no ties) for the subject that fails at \\(t_j\\)\n\\(\\mathcal R_j\\): set of indices for those at risk at \\(t_j\\)\nIndex \\(i\\) \\(\\to\\) covariates \\(Z_i\\)"
  },
  {
    "objectID": "chap4.html#conditional-information",
    "href": "chap4.html#conditional-information",
    "title": "Applied Survival Analysis",
    "section": "Conditional Information",
    "text": "Conditional Information\n\n\nData most informative of \\(\\beta\\)\n\nDifference in risk between covariate groups\nIdentity of failed subject (\\(\\mathcal F_j\\)) given a failure (\\(d_j=1\\)) among those at risk (\\(\\mathcal R_j\\)) \\[\\begin{align}\\label{eq:cox:cond_lik}\n\\pr(\\mathcal F_j\\mid \\mathcal R_j,d_j=1)&=\\frac{\\pr(\\mbox{Subject $(j)$ fails given at risk at $t_j$})}{\\pr(\\mbox{One in $\\mathcal R_j$ fails given all at risk at $t_j$})}\\notag\\\\\n&\\approx\\frac{\\lambda(t_j\\mid Z_{(j)})\\dd t_j}{\\sum_{i\\in\\mathcal R_j}\\lambda(t_j\\mid Z_i)\\dd t_j}\\notag\\\\\n&=\\frac{\\exp(\\beta^\\T Z_{(j)})\\lambda_0(t)\\dd t_j}{\\sum_{i\\in\\mathcal R_j}\\exp(\\beta^\\T Z_i)\\lambda_0(t)\\dd t_j}\\notag\\\\\n&=\\frac{\\exp(\\beta^\\T Z_{(j)})}{\\sum_{i\\in\\mathcal R_j}\\exp(\\beta^\\T Z_i)}\n\\end{align}\\]\n\nIndeed a function only of \\(\\beta\\)"
  },
  {
    "objectID": "chap4.html#partial-likelihood-construction",
    "href": "chap4.html#partial-likelihood-construction",
    "title": "Applied Survival Analysis",
    "section": "Partial Likelihood Construction",
    "text": "Partial Likelihood Construction\n\n\nCombine over time\n\nPartial likelihood \\[\\begin{align*}\nPL_n(\\beta)=\\prod_{j=1}^m\\pr(\\mathcal F_j\\mid \\mathcal R_j,d_j=1)\n=\\prod_{j=1}^m\\frac{\\exp(\\beta^\\T Z_{(j)})}{\\sum_{i\\in\\mathcal R_j}\\exp(\\beta^\\T Z_i)}\n\\end{align*}\\]\nLog-partial likelihood \\[\\begin{align}\\label{eq:cox:pln}\npl_n(\\beta)=n^{-1}\\log PL_n(\\beta)&=n^{-1}\\sum_{j=1}^m\\left\\{\\beta^\\T Z_{(j)}-\\log\\sum_{i\\in\\mathcal R_j}\\exp(\\beta^\\T Z_i)\\right\\}\\notag\\\\\n&= n^{-1}\\sum_{i=1}^n \\delta_i\\left\\{\\beta^\\T Z_i- \\log\\sum_{j=1}^n I(X_j\\geq X_i)\\exp(\\beta^\\T Z_j) \\right\\}\\notag\\\\\n&=n^{-1}\\sum_{i=1}^n\\int_0^\\infty \\left\\{\\beta^\\T Z_i- \\log\\sum_{j=1}^n I(X_j\\geq t)\\exp(\\beta^\\T Z_j) \\right\\}\\dd N_i(t).\n\\end{align}\\]"
  },
  {
    "objectID": "chap4.html#maximum-partial-likelihood-estimation-mple",
    "href": "chap4.html#maximum-partial-likelihood-estimation-mple",
    "title": "Applied Survival Analysis",
    "section": "Maximum Partial-Likelihood Estimation (MPLE)",
    "text": "Maximum Partial-Likelihood Estimation (MPLE)\n\nEstimator: \\(\\hat\\beta=\\arg\\max_\\beta pl_n(\\beta)\\)\n\n\\(pl_n(\\beta)\\approx\\) log-likelihood of a parametric model\nPartial-likelihood score \\[\\begin{equation}\\label{eq:cox:pl_score}\nU_n(\\beta)=\\frac{\\partial}{\\partial\\beta} pl_n(\\beta)\n=n^{-1}\\sum_{i=1}^n\\int_0^\\infty \\left\\{Z_i- \\frac{\\sum_{j=1}^n I(X_j\\geq t)Z_j\\exp(\\beta^\\T Z_j)}{\\sum_{j=1}^n I(X_j\\geq t)\\exp(\\beta^\\T Z_j)}\n\\right\\}\\dd N_i(t)\n\\end{equation}\\]\n\nSolve \\(U_n(\\hat\\beta)=0\\) (by Newton-Raphson)\n\nVariance by inverse “information”\n\n\\(\\hat\\var(\\hat\\beta)=n^{-1}\\hat{\\mathcal I}^{-1}\\)\n\\(\\hat{\\mathcal I}=-\\partial U_n(\\hat\\beta)/\\partial\\beta\\)"
  },
  {
    "objectID": "chap4.html#martingale-framework",
    "href": "chap4.html#martingale-framework",
    "title": "Applied Survival Analysis",
    "section": "Martingale Framework",
    "text": "Martingale Framework\n\n\nEquivalently \\[\\begin{equation}\\label{eq:cox:pl_score_mart}\nU_n(\\beta)=n^{-1}\\sum_{i=1}^n\\int_0^\\infty \\left\\{Z_i- \\frac{\\sum_{j=1}^n I(X_j\\geq t)Z_j\\exp(\\beta^\\T Z_j)}{\\sum_{j=1}^n I(X_j\\geq t)\\exp(\\beta^\\T Z_j)}\n\\right\\}\\dd M_i(t;\\beta,\\Lambda_0),\n\\end{equation}\\]\n\n\\(\\dd M_i(t;\\beta,\\Lambda_0)=\\dd N_i(t)-I(X_i\\geq t)\\exp(\\beta^\\T Z_i)\\dd \\Lambda_0(t)\\)\n\\(\\var\\{U_n(\\beta)\\}\\) by variance formula for martingale integrals\nJustifies \\(\\hat\\var(\\hat\\beta)=n^{-1}\\hat{\\mathcal I}^{-1}\\)"
  },
  {
    "objectID": "chap4.html#inference-on-beta",
    "href": "chap4.html#inference-on-beta",
    "title": "Applied Survival Analysis",
    "section": "Inference on \\(\\beta\\)",
    "text": "Inference on \\(\\beta\\)\n\n\nIndividual hazard ratio: \\(\\exp(\\beta_k)\\) \\((k=1,\\ldots, p)\\)\n\n95% CI \\[\\begin{equation}\\label{eq:cox:hr_ci}\n\\left[\\exp\\left\\{\\hat\\beta_k-1.96\\hat\\se(\\hat\\beta_k)\\right\\}, \\exp\\left\\{\\hat\\beta_k+1.96\\hat\\se(\\hat\\beta_k)\\right\\}\\right]\n\\end{equation}\\]\n\n\n\n\n\nJoint test of multiple coefficients\n\nMultiple dummy variables of same categorical predictor (e.g., race groups) \\[\nH_0:\\beta_{(q)}=(\\beta_1,\\ldots,\\beta_q)^\\T=0\n\\]\nWald test \\[\\begin{equation}\\label{eq:cox:joint_test}\n  \\hat\\beta_{(q)}^\\T\\hat\\var(\\hat\\beta_{(q)})^{-1}\\hat\\beta_{(q)}\\sim\\chi_q^2\n  \\end{equation}\\]\n\n\\(\\hat\\var(\\hat\\beta_{(q)})\\): sub-matrix of \\(\\hat\\var(\\hat\\beta)\\)"
  },
  {
    "objectID": "chap4.html#breslow-estimator",
    "href": "chap4.html#breslow-estimator",
    "title": "Applied Survival Analysis",
    "section": "Breslow Estimator",
    "text": "Breslow Estimator\n\n\nCumulative baseline function \\(\\Lambda_0(t)\\)\n\nBy \\(E\\{\\dd M_i(t;\\beta,\\Lambda_0)\\}=0\\): \\[\\begin{equation}\\label{eq:cox:Lambda}\n\\dd \\Lambda_0(t)=\\frac{E\\{\\dd N_i(t)\\}}{E\\{I(X_i\\geq t)\\exp(\\beta^\\T Z_i)\\}}.\n\\end{equation}\\]\nBreslow estimator \\[\\begin{equation}\\label{eq:cox:breslow}\n\\hat\\Lambda_0(t)=\\int_0^t\\frac{\\sum_{i=1}^n\\dd N_i(s)}{\\sum_{i=1}^n I(X_i\\geq s)\\exp(\\hat\\beta^\\T Z_i)}.\n\\end{equation}\\]"
  },
  {
    "objectID": "chap4.html#predicting-survival",
    "href": "chap4.html#predicting-survival",
    "title": "Applied Survival Analysis",
    "section": "Predicting Survival",
    "text": "Predicting Survival\n\n\nModel-based survival function for given \\(z\\) \\[\nS(t\\mid z;\\beta,\\Lambda_0)=\\exp\\left\\{-\\exp(\\beta^\\T z)\\Lambda_0(t)\\right\\}\n\\]\n\nPlug in parameter estimates \\[S(t\\mid z;\\hat\\beta,\\hat\\Lambda_0)\\]\n\n\n\n\n\n\n\n\nExercise: Conditional survival\n\n\n\nA patient with covariate value \\(z\\) is censored at time \\(c\\). Use the fit model to predict his/her future survival probabilities."
  },
  {
    "objectID": "chap4.html#stratified-model",
    "href": "chap4.html#stratified-model",
    "title": "Applied Survival Analysis",
    "section": "Stratified Model",
    "text": "Stratified Model\n\n\nStratification: within-stratum comparison\n\nSex, race, study center, etc.\nAdjust for confounder without including it as covariate\n\nNo PH assumption across strata\n\n\n\n\n\n\nConditional hazard in \\(l\\)th stratum \\[\\begin{equation}\\label{eq:cox:model_strat}\n\\lambda_l(t\\mid Z^{(l)})=\\lambda_{0l}(t)\\exp(\\beta^\\T Z^{(l)})\n\\end{equation}\\]\n\n\\(\\lambda_{0l}(\\cdot)\\): Stratum-specific baseline functions\n\nNeed not be proportional (useful in addressing non-proportionality in covariates)\n\n\\(\\beta\\): Common covariate effects\nEstimation: Use sum of stratum-specific partial-likelihood scores"
  },
  {
    "objectID": "chap4.html#software-survivalcoxph-i",
    "href": "chap4.html#software-survivalcoxph-i",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::coxph() (I)",
    "text": "Software: survival::coxph() (I)\n\n\nBasic syntax for Cox model\n\n\n\n# Fit (time, status) vs covariates stratified by str_var\nobj &lt;- coxph(Surv(time, status) ~ covariates \n             + strata(str_var))\n\n\n\n\n\nInput\n\nSurv(time, status) ~ covariates: \\((X, \\delta) \\sim Z\\)\nstrata(str_var): stratified by variable str_var (optional)\n\n\n\n\n\nOutput: an object of class coxph\n\nobj$coefficients: \\(\\hat\\beta\\)\nobj$var: \\(\\hat\\var(\\hat\\beta)\\)"
  },
  {
    "objectID": "chap4.html#software-survivalcoxph-ii",
    "href": "chap4.html#software-survivalcoxph-ii",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::coxph() (II)",
    "text": "Software: survival::coxph() (II)\n\n\nBreslow estimates \\(\\hat\\Lambda_0(t)\\)\n\n\n# obj: coxph object\n# centered = FALSE for baseline (Z = 0)\nLambda0 &lt;- basehaz(obj, centered = FALSE)\n\n\n\n\nOutput: a data frame\n\nLambda0$time: \\(t\\); Lambda0$hazard: \\(\\hat\\Lambda_0(t)\\)\nLambda0$strata: levels of str_var if stratified by it\n\n\n\n\n\nPrediction of survival\n\n\n# Model-based survival estimates for new observations\nsurvfit(obj, newdata)"
  },
  {
    "objectID": "chap4.html#software-survivalcoxph-iii",
    "href": "chap4.html#software-survivalcoxph-iii",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::coxph() (III)",
    "text": "Software: survival::coxph() (III)\n\n\nSummary: summary(obj)\n\nsummary(obj)$coefficients: a matrix containing \\(\\hat\\beta\\), hazard ratio \\(\\exp(\\hat\\beta)\\), \\(\\hat\\se(\\hat\\beta)\\), test statistic, and \\(p\\)-value as columns\n\n\n\n\n\nJoint test of multiple coefficients\n\n\n# Sample code for testing\n# H_0: beta_1 = ... =  beta_q = 0\nbeta_q &lt;- obj$coefficients[1:q] # get beta_(q)\nSigma_q &lt;- obj$var[1:q, 1:q] # get q x q variance matrix\n#chisq statistic with q d.f.\nchi_q &lt;- t(beta_q) %*% solve(Sigma_q) %*% beta_q\n#p-value\npval &lt;- 1 - pchisq(chi_q, q)"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-i",
    "href": "chap4.html#example-german-breast-cancer-i",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (I)",
    "text": "Example: German Breast Cancer (I)\n\n\nEndpoint: relapse-free survival"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-ii",
    "href": "chap4.html#example-german-breast-cancer-ii",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (II)",
    "text": "Example: German Breast Cancer (II)\n\n\nModel fitting\n\n\n#--- Data frame ---------------------\nhead(df)\n#   id      time status hormone age meno size grade nodes prog estrg\n# 1  1 43.836066      1       1  38    1   18     3     5  141   105\n# 3  2 46.557377      1       1  52    1   20     1     1   78    14\n# 5  3 41.934426      1       1  47    1   30     2     1  422    89\n# 7  4  4.852459      0       1  40    1   24     1     3   25    11\n# 8  5 61.081967      0       2  64    2   19     2     1   19     9\n# 9  6 63.377049      0       2  49    2   56     1     3  356    64\n\n#--- Model fitting ------------------\nobj &lt;- coxph(Surv(time, status)~ hormone + meno + age + size + grade\n           + prog + estrg, data = df)"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-iii",
    "href": "chap4.html#example-german-breast-cancer-iii",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (III)",
    "text": "Example: German Breast Cancer (III)\n\n\nSummary results\n\nHormone-treated women 70.1% times as likely to relapse/die as untreated\n\n\n#--- Summary results ------------------\nsummary(obj)\n#   n= 686, number of events= 299 \n#                coef  exp(coef)   se(coef)      z Pr(&gt;|z|)    \n# hormone2 -0.3552391  0.7010058  0.1292278 -2.749  0.00598 ** \n# meno2     0.2683165  1.3077610  0.1840516  1.458  0.14489    \n# age      -0.0087937  0.9912449  0.0093783 -0.938  0.34842    \n# size      0.0153213  1.0154392  0.0036538  4.193 2.75e-05 ***\n# grade2    0.7078888  2.0297017  0.2485544  2.848  0.00440 ** \n# grade3    0.8171706  2.2640847  0.2689544  3.038  0.00238 ** \n# prog     -0.0022942  0.9977084  0.0005775 -3.972 7.12e-05 ***\n# estrg     0.0001788  1.0001789  0.0004686  0.382  0.70274    \n# ---\n# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-iv",
    "href": "chap4.html#example-german-breast-cancer-iv",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (IV)",
    "text": "Example: German Breast Cancer (IV)\n\n\nHRs: forest plot\n\nHormone-treated women 70.1% times as likely to relapse/die as untreated"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-v",
    "href": "chap4.html#example-german-breast-cancer-v",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (V)",
    "text": "Example: German Breast Cancer (V)\n\n\nTumor grade?\n\nJoint test on grade2 and grade3\n\\(\\chi_2^2=9.4\\), \\(p=0.009\\)\n\n\n#--- Wald test on tumor grade ------------------\n# H_0: beta_5=beta_6=0\nbeta_q &lt;- obj$coefficients[5:6]\nSigma_q &lt;- obj$var[5:6,5:6]\n#chisq statistic with 2 d.f.\nchisq2 &lt;- t(beta_q) %*% solve(Sigma_q) %*% beta_q\nchisq2\n# [1,] 9.428787\n#p-value\npval &lt;- 1 - pchisq(chisq2, 2)\npval\n# [1,] 0.008965302"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-vi",
    "href": "chap4.html#example-german-breast-cancer-vi",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (VI)",
    "text": "Example: German Breast Cancer (VI)\n\n\nBaseline \\(\\hat\\Lambda_0(t)\\)\n\n\n#--- Breslow estimates of baseline function ------------------\nLambda0 &lt;- basehaz(obj, centered = FALSE)\n# Plot the baseline hazard function\nplot(stepfun(Lambda0$time, c(0, Lambda0$hazard)), do.points = FALSE, \n     cex.axis = 0.9, lwd = 2, frame.plot = FALSE, xlim = c(0, 100),\n     ylim = c(0, 0.8), xlab = \"Time (months)\", \n     ylab = \"Baseline cumulative hazard\", main = \"\")\n\n\n\n\n\n\n\n\n\nExercise: Survival prediction\n\n\n\nPredict survival function for arbitrary \\(z\\).\n\nUse obj$coefficients (\\(\\hat\\beta\\)) and Lambda0 (\\(\\hat\\Lambda_0(t)\\))\nUse survfit(obj, newdata)"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-vii",
    "href": "chap4.html#example-german-breast-cancer-vii",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (VII)",
    "text": "Example: German Breast Cancer (VII)\n\n\nBaseline \\(\\hat\\Lambda_0(t)\\)"
  },
  {
    "objectID": "chap4.html#assumptions-in-cox-model",
    "href": "chap4.html#assumptions-in-cox-model",
    "title": "Applied Survival Analysis",
    "section": "Assumptions in Cox Model",
    "text": "Assumptions in Cox Model\n\n\nCox model assumptions \\[\\begin{equation}\n\\lambda(t\\mid Z)=\\lambda_0(t)\\exp(\\beta^\\T Z)\n\\end{equation}\\]\n\nProportionality (\\(\\beta\\) is time-constant)\nFunctional form of \\(Z_{\\cdot k}\\) (linear? quadratic? categorical?)\nLink function \\(\\exp(\\cdot)\\) for \\(\\beta^\\T Z\\)\n\n\n\n\n\nResiduals\n\nObserved vs model-predicted\nModel fits data \\(\\to\\) predictions capture systematic trend \\(\\to\\) random residuals\nPattern in residuals \\(\\to\\) inadequate fit"
  },
  {
    "objectID": "chap4.html#cox-snell-residuals-i",
    "href": "chap4.html#cox-snell-residuals-i",
    "title": "Applied Survival Analysis",
    "section": "Cox-Snell Residuals (I)",
    "text": "Cox-Snell Residuals (I)\n\n\nStandard result\n\n\\(S(T)\\sim\\mbox{Unif}[0, 1]\\)\n\\(\\Lambda(T)=-\\log S(T) \\sim \\mbox{Expn}(1)\\) (exponential with unit hazard rate)\n\n\n\n\n\nUnder Cox model \\[\n\\Lambda(t\\mid Z;\\beta,\\Lambda_0)=\\exp(\\beta^\\T Z)\\Lambda_0(t)\n\\]\n\n\\(\\Lambda(T\\mid Z;\\beta,\\Lambda_0)\\sim \\mbox{Expn}(1)\\)\n\\(\\Lambda(X\\mid Z;\\beta,\\Lambda_0)\\): Censored version of \\(\\Lambda(T\\mid Z;\\beta,\\Lambda_0)\\sim \\mbox{Expn}(1)\\)\n\\(\\{\\hat s_i\\equiv \\Lambda(X_i\\mid Z_i;\\hat\\beta,\\hat\\Lambda_0), \\delta_i\\}\\): A sample of censored “times” from \\(\\mbox{Expn}(1)\\)\n\n\\(\\hat s_i\\) \\((i=1,\\ldots, n)\\): Cox-Snell residuals"
  },
  {
    "objectID": "chap4.html#cox-snell-residuals-ii",
    "href": "chap4.html#cox-snell-residuals-ii",
    "title": "Applied Survival Analysis",
    "section": "Cox-Snell Residuals (II)",
    "text": "Cox-Snell Residuals (II)\n\n\nNelsen-Aalen estimates \\(\\hat\\Lambda_{\\rm CS}(t)\\)\n\nBased on \\((\\hat s_i, \\delta_i)\\) \\((i=1,\\ldots, n)\\)\nRecovers cumulative hazard of \\(\\mbox{Expn}(1)\\), i.e., \\(\\Lambda(t)=t\\)\n\n\n\n\n\nGraphical check\n\nOverall fit: \\(\\hat\\Lambda_{\\rm CS}(\\hat s_i)\\approx \\hat s_i\\)\n\\(\\log\\hat\\Lambda_{\\rm CS}(\\hat s_i)\\) vs \\(\\log\\hat s_i\\): straight line passing through origin (similar to Q-Q plot)\nDeparture (e.g., curvature) suggests lack of fit\n\nDoesn’t tell which assumptions are violated"
  },
  {
    "objectID": "chap4.html#schoenfeld-residuals-i",
    "href": "chap4.html#schoenfeld-residuals-i",
    "title": "Applied Survival Analysis",
    "section": "Schoenfeld Residuals (I)",
    "text": "Schoenfeld Residuals (I)\n\n\nDefined only for failed subjects \\[\\begin{equation}\\label{eq:cox:schoenfeld}\n\\hat r_i=Z_i-\\mathcal E(X_i;\\hat\\beta) \\hspace{10mm} (\\delta_i=1; i=1,\\ldots,n).\n\\end{equation}\\]\n\n\\(\\mathcal E(t_j;\\beta) = E(Z_{(j)}\\mid \\mathcal R_j, d_j=1)=\\frac{\\sum_{j=1}^nI(X_j\\geq t)Z_j\\exp(\\beta^\\T Z_j)}{\\sum_{j=1}^nI(X_j\\geq t)\\exp(\\beta^\\T Z_j)}\\)\nObserved minus (conditionally) expected covariates\nSensitive to proportionality (canceling of \\(\\lambda_0(\\cdot)\\))\n\\(\\hat r_{ik}\\) (rescaled) vs \\(X_i\\): mean zero if proportionality holds on \\(Z_{\\cdot k}\\)\nFormal \\(\\chi^2\\) tests based on the \\(\\hat r_{ik}\\) (with proportionality as \\(H_0\\))\n\nServe only as guidelines to graphical results"
  },
  {
    "objectID": "chap4.html#schoenfeld-residuals-ii",
    "href": "chap4.html#schoenfeld-residuals-ii",
    "title": "Applied Survival Analysis",
    "section": "Schoenfeld Residuals (II)",
    "text": "Schoenfeld Residuals (II)\n\n\nIn case of non-proportionality\n\nHR changes over time\nStratify rather than set as covariate\nInclude covariate \\(\\times\\) time interaction, e.g., \\(Z_{\\cdot k}\\log(t)\\)\nChoose alternatives over Cox model (Chapter 5)\n\nRestricted mean life\nAdditive hazards\nProportional odds\nAccelerate failure time (AFT)"
  },
  {
    "objectID": "chap4.html#martingaledeviance-residuals",
    "href": "chap4.html#martingaledeviance-residuals",
    "title": "Applied Survival Analysis",
    "section": "Martingale/Deviance Residuals",
    "text": "Martingale/Deviance Residuals\n\n\nUsual residuals: observed response minus expected \\[\\begin{align*}\nM_i(X_i; \\hat\\beta,\\hat\\Lambda_0)&=N_i(X_i)-\\int_0^{X_i} I(X_i\\geq t)\\exp(\\hat\\beta^\\T Z_i)\\dd \\hat\\Lambda_0(t)\\\\\n&=\\delta_i-\\exp(\\hat\\beta^\\T Z_i)\\hat\\Lambda_0(X_i)\n\\end{align*}\\]\n\n\\(\\exp(\\hat\\beta^\\T Z_i)\\hat\\Lambda_0(X_i)\\) is Cox-Snell residual\nFunctional form of \\(Z_{\\cdot k}\\): plot \\(M_i(X_i; \\hat\\beta,\\hat\\Lambda_0)\\) against \\(Z_{ik}\\) \\((i=1,\\ldots, n)\\)\n\nInappropriate form \\(\\to\\) transform by log, square root, power, or grouping\n\nLink function: plot \\(M_i(X_i; \\hat\\beta,\\hat\\Lambda_0)\\) against \\(\\hat\\beta^\\T Z_i\\)\nDeviance residuals: Standardized/symmetrized martingale residuals \\(\\to\\) outlier detection"
  },
  {
    "objectID": "chap4.html#software-survivalresid-i",
    "href": "chap4.html#software-survivalresid-i",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::resid() (I)",
    "text": "Software: survival::resid() (I)\n\n\nBasic syntax for Cox model residuals\n\n\n# obj: object returned by coxph()\nresid(obj, type = c(\"martingale\", \"deviance\", \"score\", \"schoenfeld\", \n                    \"dfbeta\", \"dfbetas\", \"scaledsch\", \"partial\"))\n\n\n\n\nCox-Snell residuals\n\n\n# Calculate Cox-Snell by martingale residuals \n# df: data frame\ncoxsnellres &lt;- df$status - resid(obj, type = \"martingale\")\n# Compute Nelsen-Aalen estimates for cumulative hazard\nfit &lt;- survfit(Surv(coxsnellres, df$status) ~ 1)\nLambda &lt;- cumsum(fit$n.event / fit$n.risk)\n# Scatter plot\nplot(log(fit$time), log(Lambda), xlab = \"log(t)\", \n     ylab = \"log-cumulative hazard\")\nabline(0, 1, lty = 3) # add a dotted reference line"
  },
  {
    "objectID": "chap4.html#software-survivalcox.zph",
    "href": "chap4.html#software-survivalcox.zph",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::cox.zph()",
    "text": "Software: survival::cox.zph()\n\n\nRescaled Schoenfeld residuals\n\n\n# rescaled Schoenfeld residuals and tests\nsch &lt;- cox.zph(obj) \n\n\n\n\nOutput\n\nsch$table: \\(\\chi^2\\) tests of proportionality (each covariate and overall)\nsch$time: \\(m\\)-vector of the \\(X_i\\)\nsch$y: \\((m\\times p)\\)-matrix of the rescaled \\(\\hat r_i\\)\nplot(sch): plot the residuals, one covariate per panel"
  },
  {
    "objectID": "chap4.html#software-survivalresid-ii",
    "href": "chap4.html#software-survivalresid-ii",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::resid() (II)",
    "text": "Software: survival::resid() (II)\n\n\nMartingale/Deviance residuals\n\ndf: data frame\nzk: name of covariate of interest\n\n\n# Get the residuals\nmart_resid &lt;- resid(obj, type = 'martingale') # n-vector of martingale\ndev_resid &lt;- resid(obj, type = 'deviance') # n-vector of deviance\n# Scatter plot residuals against covariate\nplot(df$zk, mart_resid)\nlines(lowess(df$zk, mart_resid)) # add a smooth line through points\nabline(0, 0, lty = 3) # add a dotted reference line"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-viii",
    "href": "chap4.html#example-german-breast-cancer-viii",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (VIII)",
    "text": "Example: German Breast Cancer (VIII)\n\n\nOverall fit - Cox-Snell residuals\n\n\n# Compute the residuals\ncoxsnellres &lt;- df$status-resid(obj, type=\"martingale\")\n## Then use N-A method to estimate the cumulative \n## hazard function for residuals\nfit &lt;- survfit(Surv(coxsnellres,df$status) ~ 1)\nHtilde &lt;- cumsum(fit$n.event/fit$n.risk)\n# Scatter plot\nplot(log(fit$time), log(Htilde), xlab=\"log(t)\", frame.plot = FALSE,\n     ylab=\"log-cumulative hazard\", xlim = c(-8, 2), ylim = c(-8, 2))\nabline(0, 1, lty = 3, lwd = 1.5) # add a reference line"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-ix",
    "href": "chap4.html#example-german-breast-cancer-ix",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (IX)",
    "text": "Example: German Breast Cancer (IX)\n\n\nOverall fit - Cox-Snell residuals"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-x",
    "href": "chap4.html#example-german-breast-cancer-x",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (X)",
    "text": "Example: German Breast Cancer (X)\n\n\nProportionality - Schoenfeld residuals\n\n\n# Rescaled Schoelfeld residuals\nsch &lt;- cox.zph(obj) \nsch$table # chi-square tests"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-xi",
    "href": "chap4.html#example-german-breast-cancer-xi",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (XI)",
    "text": "Example: German Breast Cancer (XI)\n\n\nProportionality - Schoenfeld residuals\n\n\n# Plot rescaled Schoenfeld residuals for each covariate directly\nplot(sch, xlab=\"Time (months)\", lwd=2, cex.lab=1.2, cex.axis=1.2,\n     ylab = c(\"Hormone\", \"Menopause\", \"Age\", \"Tumor size\",\n               \"Tumor grade\", \"Progesterone\", \"Estrogen\"))"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-xii",
    "href": "chap4.html#example-german-breast-cancer-xii",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (XII)",
    "text": "Example: German Breast Cancer (XII)\n\n\nStratification by tumor grade\n\n\n# fit a Cox model stratified by tumor grade\nobj_stra &lt;- coxph(Surv(time, status) ~ hormone + meno\n         + age + size + prog + estrg + strata(grade), data = df)\ncox.zph(obj_stra)$table # proportionality tests"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-xiii",
    "href": "chap4.html#example-german-breast-cancer-xiii",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (XIII)",
    "text": "Example: German Breast Cancer (XIII)\n\n\nCovariate form - Martingale (deviance) residuals\n\n\n## Martingale residuals\nmart_resid &lt;- resid(obj_stra,type = 'martingale')\n#plot residuals against, e.g., age\nplot(df$age, mart_resid, main='Age', cex.lab=1.2, cex.axis=1.2,\n     xlab=\"Age (years)\", ylab=\"Martingale residuals\")\nlines(lowess(df$age, mart_resid), lwd = 2) # add a smooth line\nabline(0, 0, lty = 3, lwd = 2) # add a reference line"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-xiv",
    "href": "chap4.html#example-german-breast-cancer-xiv",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (XIV)",
    "text": "Example: German Breast Cancer (XIV)\n\n\nCovariate form - Martingale (deviance) residuals"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-xv",
    "href": "chap4.html#example-german-breast-cancer-xv",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (XV)",
    "text": "Example: German Breast Cancer (XV)\n\n\nCategorize age\n\nMore events in younger women than accounted for by linear age\nRefit model with agec=1: \\(\\leq 40\\) yrs; agec=2: \\((40, 60]\\) yrs; agec=3: \\(&gt; 60\\) yrs\n\n\n\n# Call:\n# coxph(formula = Surv(time, status) ~ hormone + meno + agec + \n#     size + prog + estrg + strata(grade), data = df)\n#                coef  exp(coef)   se(coef)      z Pr(&gt;|z|)    \n# hormone2 -0.3788600  0.6846415  0.1294642 -2.926  0.00343 ** \n# meno2     0.2804119  1.3236749  0.1567576  1.789  0.07364 .  \n# agec2    -0.5315678  0.5876829  0.1984112 -2.679  0.00738 ** \n# agec3    -0.4965589  0.6086214  0.2497403 -1.988  0.04678 *  \n# size      0.0164114  1.0165468  0.0036964  4.440 9.00e-06 ***\n# prog     -0.0022708  0.9977318  0.0005812 -3.907 9.36e-05 ***\n# estrg     0.0001254  1.0001254  0.0004718  0.266  0.79041    \n# ---"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-xvi",
    "href": "chap4.html#example-german-breast-cancer-xvi",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (XVI)",
    "text": "Example: German Breast Cancer (XVI)\n\n\nCategorize age\n\nAge differences masked by inappropriate linear form (\\(p\\)-value 0.348)"
  },
  {
    "objectID": "chap4.html#internal-vs-external-covariates",
    "href": "chap4.html#internal-vs-external-covariates",
    "title": "Applied Survival Analysis",
    "section": "Internal vs External Covariates",
    "text": "Internal vs External Covariates\n\n\nNotation: \\(Z(t)=\\{Z_{\\cdot 1}(t),\\ldots, Z_{\\cdot p}(t)\\}^\\T\\)\n\n\n\n\nInternal covariates\n\nMeasured on same subject during follow-up, influenced by failure process\n\nBiomarkers (CD4 cell count), quality of life, other events\n\nModeling: current (instantaneous) risk vs covariate history\n\n\n\n\n\nExternal covariates\n\nExtraneous factors, changes unaffected by subject’s failure process\n\nPre-planned treatment sequence, environmental factors, baseline covariates \\(\\times\\) time\n\nModeling: risk profile vs entire covariate path"
  },
  {
    "objectID": "chap4.html#internal-covariates",
    "href": "chap4.html#internal-covariates",
    "title": "Applied Survival Analysis",
    "section": "Internal Covariates",
    "text": "Internal Covariates\n\n\nModeling target (intensity function) \\[\n\\lambda\\{t\\mid\\overline Z(t)\\}\\dd t=\\pr\\{t\\leq T&lt;t+\\dd t\\mid T\\geq t, \\overline Z(t)\\}\n\\]\n\n\\(\\overline Z(t)=\\{Z(u): 0\\leq u\\leq t\\}\\): covariate path up to \\(t\\)\n\n\n\n\n\nModel specification \\[\\begin{equation}\\label{eq:cox:time_varying_model}\n\\lambda\\{t\\mid\\overline Z(t)\\}=\\lambda_0(t)\\exp\\{\\beta^\\T Z(t)\\}.\n\\end{equation}\\]\n\nCurrent risk depends on past only through \\(Z(t)\\)\nDefine \\(Z(t)\\) to be useful summary of past\n\nshould not be “current” measurements due to delay in cause and effect\n\nExample: frequency of drug use in past week, month, or year"
  },
  {
    "objectID": "chap4.html#external-covariates-i",
    "href": "chap4.html#external-covariates-i",
    "title": "Applied Survival Analysis",
    "section": "External Covariates (I)",
    "text": "External Covariates (I)\n\n\nModeling target (hazard function) \\[\n\\lambda(t\\mid Z)\\dd t=\\pr(t\\leq T&lt;t+\\dd t\\mid T\\geq t, Z)\n\\]\n\n\\(Z=\\{Z(t):0\\leq t\\leq \\infty\\}\\): entire covariate path\n\n\n\n\n\nModel specification \\[\\begin{equation}\\label{eq:cox:time_varying_model_ex}\n\\lambda(t\\mid Z)=\\lambda_0(t)\\exp\\{\\beta^\\T Z(t)\\}.\n\\end{equation}\\]\n\n\\(Z(t)\\): useful summary before \\(t\\)\nConditional survival (not applicable to internal covariates) \\[\nS(t\\mid Z)=\\exp\\left\\{-\\int_0^t\\lambda(s\\mid Z)\\dd s\\right\\}=\\exp\\left[-\\int_0^t\\exp\\{\\beta^\\T Z(s)\\}\\lambda_0(s)\\dd s\\right]\n\\]"
  },
  {
    "objectID": "chap4.html#external-covariates-ii",
    "href": "chap4.html#external-covariates-ii",
    "title": "Applied Survival Analysis",
    "section": "External Covariates (II)",
    "text": "External Covariates (II)\n\n\nBaseline covariates \\(times\\) time\n\nAddressing non-proportionality\n\n\n\n\n\nExample: \\(Z_{\\cdot 1} = 1, 0\\)\n\nNon-proportionality: \\(\\lambda(t\\mid Z_{\\cdot 1} =1)/\\lambda(t\\mid Z_{\\cdot 1} =0)\\) changes with \\(t\\)\nAdd \\(Z_{\\cdot 2}(t) = Z_{\\cdot 1} t\\), then \\[\\lambda(t\\mid Z_{\\cdot 1}, Z_{\\cdot 2})=\\exp\\{\\beta_1Z_{\\cdot 1} + \\beta_2Z_{\\cdot 2}(t)\\}\\lambda_0(t)\\] So \\[\n\\frac{\\lambda(t\\mid Z_{\\cdot 1}=1)}{\\lambda(t\\mid Z_{\\cdot 1}=0)}=\\exp(\\beta_1+\\beta_2 t)\n\\]\nHopefully captures temporal pattern of effect size"
  },
  {
    "objectID": "chap4.html#estimation-and-inference",
    "href": "chap4.html#estimation-and-inference",
    "title": "Applied Survival Analysis",
    "section": "Estimation and Inference",
    "text": "Estimation and Inference\n\n\nSame inference procedure: partial likelihood \\[\\begin{align*}\nPL_n(\\beta)=\\prod_{j=1}^m\\frac{\\exp\\{\\beta^\\T Z_{(j)}(t_j)\\}}{\\sum_{i\\in\\mathcal R_j}\\exp\\{\\beta^\\T Z_i(t_j)\\}}.\n\\end{align*}\\]\n\n\n\n\nPartial-likelihood score \\[\nU_n(\\beta)=n^{-1}\\sum_{i=1}^n\\int_0^\\infty \\left\\{Z_i(t)- \\frac{\\sum_{j=1}^n I(X_j\\geq t)Z_j(t)\\exp\\{\\beta^\\T Z_j(t)\\}}{\\sum_{j=1}^n I(X_j\\geq t)\\exp\\{\\beta^\\T Z_j(t)\\}}\n\\right\\}\\dd N_i(t)\n\\]\n\nSame Newton-Raphson algorithm"
  },
  {
    "objectID": "chap4.html#software-survivalcoxph-iv",
    "href": "chap4.html#software-survivalcoxph-iv",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::coxph() (IV)",
    "text": "Software: survival::coxph() (IV)\n\n\nBasic syntax for time-varying covariates\n\n\n\n# (start, stop): left and right ends of time period\n# event: 1 = event; 0 = no event\nobj &lt;- coxph(Surv(start, stop, event) ~ covariates)\n\n\n\n\n\nInput\n\nData in counting process (long) format (multiple records per subject)\n(start, stop): period during which covariate takes on a particular value\nevent: event indicator at time stop\n\nevent = 0 need not mean censoring (why?)\n\n\n\n\n\n\nOutput: coxph object"
  },
  {
    "objectID": "chap4.html#example-stanford-heart-study-i",
    "href": "chap4.html#example-stanford-heart-study-i",
    "title": "Applied Survival Analysis",
    "section": "Example: Stanford Heart Study (I)",
    "text": "Example: Stanford Heart Study (I)\n\n\nHeart transplant study (1967–74)\n\nPopulation: 103 cardiac patients in transplantation program\nObjective: Evaluate effect of transplant (time-varying) on time from enrollment to death"
  },
  {
    "objectID": "chap4.html#example-stanford-heart-study-ii",
    "href": "chap4.html#example-stanford-heart-study-ii",
    "title": "Applied Survival Analysis",
    "section": "Example: Stanford Heart Study (II)",
    "text": "Example: Stanford Heart Study (II)\n\n\nResults\n\nAdjusting for other predictors, receiving a transplant reduces the risk of mortality by \\(1-0.990=1.0\\%\\) (\\(p\\)-value 0.974)\n\n\n\n# Call:\n# coxph(formula = Surv(start, stop, event) ~ age + accpt + surgery + \n#       transplant, data = heart)\n# \n#   n= 172, number of events= 75 \n# \n#                 coef exp(coef) se(coef)      z Pr(&gt;|z|)  \n# age          0.02717   1.02754  0.01371  1.981   0.0476 *\n# accpt       -0.14635   0.86386  0.07047 -2.077   0.0378 *\n# surgery     -0.63721   0.52877  0.36723 -1.735   0.0827 .\n# transplant1 -0.01025   0.98980  0.31375 -0.033   0.9739  \n---"
  },
  {
    "objectID": "chap4.html#summary-i",
    "href": "chap4.html#summary-i",
    "title": "Applied Survival Analysis",
    "section": "Summary (I)",
    "text": "Summary (I)\n\nCox proportional hazards (PH) model \\[\\begin{equation}\n\\lambda(t\\mid Z)=\\lambda_0(t)\\exp(\\beta^\\T Z)\n\\end{equation}\\]\n\n\\(\\exp(\\beta)\\): hazard ratios associated with unit increases in \\(Z\\)\n\\(\\hat\\beta\\): partial-likelihood estimator\n\\(\\hat\\Lambda_0(t)\\): Breslow estimator\nStratification: adjustment without proportionality constraint\nSurvival prediction: \\(S(t\\mid z;\\hat\\beta,\\hat\\Lambda_0)\\)\nR-function: survival::coxph()\nSAS procedure: PHREG"
  },
  {
    "objectID": "chap4.html#summary-ii",
    "href": "chap4.html#summary-ii",
    "title": "Applied Survival Analysis",
    "section": "Summary (II)",
    "text": "Summary (II)\n\nResidual analysis\n\nCox-Snell: Overall fit\n\ndf$status - residuals(obj, type = \"martingale\")\n\nSchoenfeld: Proportionality\n\ncox.zph(obj)\n\nMartingale/Deviance: Covariate form, link function, outlier\n\nresiduals(obj, type = c(\"martingale\", \"deviance\"))\n\n\nTime-varying covariates\n\nInternal vs external\ncoxph(Surv(start, stop, event) ~ covariates)"
  },
  {
    "objectID": "chap4.html#hw3-due-mar-6",
    "href": "chap4.html#hw3-due-mar-6",
    "title": "Applied Survival Analysis",
    "section": "HW3 (Due Mar 6)",
    "text": "HW3 (Due Mar 6)\n\nProblem 4.8\nProblem 4.14\nProblems 4.15 and 4.21"
  },
  {
    "objectID": "chap4.html#maximum-partial-likelihood-mple",
    "href": "chap4.html#maximum-partial-likelihood-mple",
    "title": "Applied Survival Analysis",
    "section": "Maximum Partial-Likelihood (MPLE)",
    "text": "Maximum Partial-Likelihood (MPLE)\n\n\nEstimator: \\(\\hat\\beta=\\arg\\max_\\beta pl_n(\\beta)\\)\n\n\\(pl_n(\\beta)\\approx\\) log-likelihood of a parametric model\nPartial-likelihood score \\[\\begin{equation}\\label{eq:cox:pl_score}\nU_n(\\beta)=\\frac{\\partial}{\\partial\\beta} pl_n(\\beta)\n=n^{-1}\\sum_{i=1}^n\\int_0^\\infty \\left\\{Z_i- \\frac{\\sum_{j=1}^n I(X_j\\geq t)Z_j\\exp(\\beta^\\T Z_j)}{\\sum_{j=1}^n I(X_j\\geq t)\\exp(\\beta^\\T Z_j)}\n\\right\\}\\dd N_i(t)\n\\end{equation}\\]\n\nSolve \\(U_n(\\hat\\beta)=0\\) (by Newton-Raphson)\n\nVariance by inverse “information”\n\n\\(\\hat\\var(\\hat\\beta)=n^{-1}\\hat{\\mathcal I}^{-1}\\)\n\\(\\hat{\\mathcal I}=-\\partial U_n(\\hat\\beta)/\\partial\\beta\\)"
  },
  {
    "objectID": "chap4.html#software-gtsummarytbl_regression",
    "href": "chap4.html#software-gtsummarytbl_regression",
    "title": "Applied Survival Analysis",
    "section": "Software: gtsummary::tbl_regression()",
    "text": "Software: gtsummary::tbl_regression()\n\n\nSummary table\n\nSpecify label = list(...) for custom variable labels\n\n\nlibrary(gtsummary)\n# Fit (time, status) vs covariates stratified by str_var\nobj &lt;- coxph(Surv(time, status) ~ covariates)\n# Summary table\ntbl_regression(obj) # default: HR, 95% CI, p-value"
  },
  {
    "objectID": "chap4.html#hw3-due-mar-5",
    "href": "chap4.html#hw3-due-mar-5",
    "title": "Applied Survival Analysis",
    "section": "HW3 (Due Mar 5)",
    "text": "HW3 (Due Mar 5)\n\nProblem 4.8\nProblem 4.14\nProblems 4.15 and 4.21\nExtra credit: Problem 4.22"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-xvi-1",
    "href": "chap4.html#example-german-breast-cancer-xvi-1",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (XVI)",
    "text": "Example: German Breast Cancer (XVI)\n\n\nTabulate final model\n\n\n# Tabulate final model results\ntbl_final &lt;- tbl_regression(\n  obj_stra_final, # coxph object for final model\n  label = list(\n    hormone = \"Hormone\", \n    meno    = \"Menopause\",\n    agec    = \"Age group\",\n    size    = \"Tumor size (mm)\",\n    prog    = \"Progesterone (100 fmol/mg)\",\n    estrg   = \"Estrogen  (100 fmol/mg)\"\n  )\n)\n\ntbl_final"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-xvii",
    "href": "chap4.html#example-german-breast-cancer-xvii",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (XVII)",
    "text": "Example: German Breast Cancer (XVII)\n\n\nTabulate final model\n\n\n# Tabulate final model results\ntbl_final &lt;- tbl_regression(\n  obj_stra_final, # coxph object for final model\n  label = list(\n    hormone = \"Hormone\", \n    meno    = \"Menopause\",\n    agec    = \"Age group\",\n    size    = \"Tumor size (mm)\",\n    prog    = \"Progesterone (100 fmol/mg)\",\n    estrg   = \"Estrogen  (100 fmol/mg)\"\n  )\n)\n\ntbl_final"
  },
  {
    "objectID": "chap4.html#example-german-breast-cancer-xviii",
    "href": "chap4.html#example-german-breast-cancer-xviii",
    "title": "Applied Survival Analysis",
    "section": "Example: German Breast Cancer (XVIII)",
    "text": "Example: German Breast Cancer (XVIII)\n\n\nFinal model"
  },
  {
    "objectID": "chap4.html#software-survivalcoxph-v",
    "href": "chap4.html#software-survivalcoxph-v",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::coxph() (V)",
    "text": "Software: survival::coxph() (V)\n\n\nResidual analysis\n\nSubject indexing to aggregate residuals\n\n\n# Residual calculations for Cox model with time-varying covariates\nresiduals(obj, type = c(\"martingale\", \"deviance\", \"schoenfeld\", \"score\",\n                        \"scaledsch\", \"dfbeta\", \"dfbetas\", \"partial\"),\n               collapse = df$id # specify subject ID\n            )"
  },
  {
    "objectID": "chap4.html#example-stanford-heart-study-iii",
    "href": "chap4.html#example-stanford-heart-study-iii",
    "title": "Applied Survival Analysis",
    "section": "Example: Stanford Heart Study (III)",
    "text": "Example: Stanford Heart Study (III)\n\n\nInternal or external\n\nExternal: if donor matching follows predetermined protocol\nInternal: if donor matching depends on patient’s health status\n\nCritically ill more likely to receive transplant sooner\n\n\n\n\n\n\nModel diagnostics\n\nExercise"
  },
  {
    "objectID": "chap4.html#notes",
    "href": "chap4.html#notes",
    "title": "Applied Survival Analysis",
    "section": "Notes",
    "text": "Notes\n\n\nPartial likelihood\n\nOriginal introduced by Sir David R. Cox (Cox, 1972)\nStatistically efficient (\\(\\S\\) 5.2 of Tsiatis, 2006)\nWidely used by statisticians and medical researchers alike\n\n\n\n\n\nResidual analysis\n\nCox–Snell residuals by Kay (1977)\nSchoenfeld residuals by Schoenfeld (1980, 1982)\nProportionality tests implemented in cox.zph() based on Grambsch and Therneau (1994)"
  },
  {
    "objectID": "chap4.html#notes-i",
    "href": "chap4.html#notes-i",
    "title": "Applied Survival Analysis",
    "section": "Notes (I)",
    "text": "Notes (I)\n\n\nPartial likelihood\n\nOriginal introduced by Sir David R. Cox (Cox, 1972)\nStatistically efficient (\\(\\S\\) 5.2 of Tsiatis, 2006)\nWidely used by statisticians and medical researchers alike\n\n\n\n\n\nResidual analysis\n\nCox–Snell residuals by Kay (1977)\nSchoenfeld residuals by Schoenfeld (1980, 1982)\nProportionality tests implemented in cox.zph() based on Grambsch and Therneau (1994)"
  },
  {
    "objectID": "chap4.html#notes-ii",
    "href": "chap4.html#notes-ii",
    "title": "Applied Survival Analysis",
    "section": "Notes (II)",
    "text": "Notes (II)\n\n\nTime-varying coefficients\n\nHazard raio changing over time \\[\n\\lambda\\bigl(t \\mid Z\\bigr) = \\lambda_0(t) \\exp\\bigl\\{\\beta(t)^\\T Z\\bigr\\}\n\\]\nCovariate \\(\\times\\) time\n\n\ncoxph(Surv(time, status) ~ age + meno + hormone + prog + estrg  \n        + meno:log(time), data = df)\n\n\n\n\n\nSpline models\n\nFlexible forms for continuous covariates\n\n\n# Fit a Cox model with penalized splines for age\ncox_spline &lt;- coxph(Surv(time, status) ~ pspline(age, df = 4) + hormone \n                + meno + size + grade + prog + estrg, data = df)"
  },
  {
    "objectID": "chapter4.html#chapter-summary",
    "href": "chapter4.html#chapter-summary",
    "title": "Chapter 4 - Cox Proportional Hazards Regression",
    "section": "Chapter Summary",
    "text": "Chapter Summary\nThe Cox proportional hazards model is a most popular semiparametric regression model for time-to-event data. The partial likelihood provides a key tool for making inferences on parametric covariate effects in the presence of a nonparametric time trend.\n\nBasic model specification\nThe Cox proportional hazards model expresses each subject’s hazard rate as a product of a baseline function and an exponential term involving covariates. For a subject with covariates \\(Z\\), the hazard at time \\(t\\) is\n\\[\n\\lambda(t \\mid Z) = \\lambda_0(t)\\exp(\\beta^{\\rm T} Z).\n\\]\nThis decomposition leaves \\(\\lambda_0(t)\\) fully unspecified, focusing on the log-hazard coefficients \\(\\beta\\). Under proportional hazards, any two covariate sets differ by a constant hazard ratio over time, enabling a direct interpretation of \\(\\exp(\\beta_k)\\) as the risk multiplier per unit increase in the \\(k\\)-th covariate.\n\n\nThe partial-likelihood approach\nEstimation of \\(\\beta\\) proceeds through a partial-likelihood function that isolates each event’s contribution while conditioning on the subjects at risk. Suppose the observed sample has unique failure times \\(t_1 &lt; \\dots &lt; t_m\\), each with a single failing subject denoted by \\((j)\\). Let \\(\\mathcal{R}_j\\) be the risk set at \\(t_j\\), meaning the indices of all subjects still under observation just before \\(t_j\\).\n\n\n\n\n\nThen the Cox partial likelihood is\n\\[\nPL(\\beta)\n=\n\\prod_{j=1}^m\n  \\frac{\n    \\exp(\\beta^\\T Z_{(j)})\n  }{\n    \\sum_{i \\in \\mathcal{R}_j}\n      \\exp(\\beta^\\T Z_i)\n  },\n\\] where \\(Z_{(j)}\\) is the covariate vector for the subject who fails at \\(t_j\\). This construction eliminates \\(\\lambda_0(t)\\) from the likelihood by focusing on how the failures are “allocated” among those at risk.\nTaking logarithms leads to the log-partial likelihood,\n\\[\n\\log PL(\\beta)\n=\n\\sum_{j=1}^m\n  \\left[\n    \\beta^\\T Z_{(j)}\n    \\;-\\;\n    \\log \\sum_{i \\in \\mathcal{R}_j}\n        \\exp\\{\\beta^\\T Z_i\\}\n  \\right].\n\\]\nWe then differentiate to obtain the partial-likelihood score function,\n\\[\nU(\\beta)\n=\n\\frac{\\partial}{\\partial \\beta}\n  \\log PL(\\beta)\n=\n\\sum_{i=1}^n\n  \\delta_i\n  \\Biggl[\n    Z_i\n    -\n    \\frac{\n      \\sum_{j=1}^n\n        I(X_j \\ge X_i)\\,\n        Z_j\\,\n        \\exp(\\beta^\\T Z_j)\n    }{\n      \\sum_{j=1}^n\n        I(X_j \\ge X_i)\\,\n        \\exp(\\beta^\\T Z_j)\n    }\n  \\Biggr],\n\\]\nwhich is set to zero to solve for the maximum partial-likelihood estimator \\(\\hat{\\beta}\\). The resulting \\(\\hat{\\beta}\\) inherits many large-sample properties from classical likelihood theory, including approximate normality and consistent variance estimation. Standard errors, Wald tests, and confidence intervals for hazard ratios \\(\\exp(\\hat{\\beta}_k)\\) are then derived in a manner analogous to parametric models.\n\n\nResidual-based diagnostics\nModel adequacy is assessed via residuals that reveal potential violations of proportional hazards or mis-specification of covariate functional forms.\n\nCox–Snell residuals transform observed times and event indicators so that, under correct modeling, they should behave like censored samples from an exponential distribution with unit mean.\nSchoenfeld residuals target the time constancy of each covariate’s hazard ratio. If a covariate’s effect changes over time, its Schoenfeld residuals display systematic trends.\nMartingale and deviance residuals detect nonlinearity or outliers in continuous covariates by measuring how observed outcomes differ from fitted values. Plotting these against each covariate often shows whether transformations or alternative model structures are needed.\n\n\n\nTime-varying covariates\nSome covariates evolve during follow-up (internal) or follow external factors independent of the subject’s health status (external). A time-varying \\(Z(t)\\) replaces the static \\(Z\\) in the hazard model:\n\\[\n\\lambda(t \\mid Z(\\cdot)) = \\lambda_0(t)\\exp\\{\\beta^\\T Z(t)\\}.\n\\]\nFor internal covariates, the hazard depends on the covariate history only through its most recent value. Estimation still uses the same partial-likelihood framework, but data must be organized in “start–stop” segments that reflect changing covariate levels over time.\n\n\nStatistical properties via martingale\nLarge-sample properties of the partial-likelihood estimator follow from writing the score function as a sum of martingale integrals. This perspective simplifies the derivation of asymptotic variance formulas for \\(\\hat{\\beta}\\) and helps justify robust inferences under independent censoring. The Breslow estimator of the baseline hazard, \\(\\hat{\\Lambda}_0(t)\\), also arises through martingale arguments, matching how the Nelson–Aalen estimator can be viewed for simpler nonparametric settings.\n\n\nSoftware use\nFitting a Cox model in R can be done with just a few commands from the survival package:\n\nlibrary(survival)\n# Example data frame 'mydata' with columns:\n#   time: Event or censoring time\n#   status: Event indicator (1 if event observed, 0 if censored)\n#   x1, x2: Covariates\n#   group: A grouping variable (e.g., for stratification)\n\n# 1. Fit a basic Cox model\nobj &lt;- coxph(Surv(time, status) ~ x1 + x2, data = mydata)\n\n# 2. Summarize the fitted model\nsummary(obj)\n# This provides coefficient estimates (log-hazard), hazard ratios (exp(coef)),\n# standard errors, confidence intervals, and p-values.\n\n# 3. Obtain Breslow estimates of the baseline cumulative hazard\nbase_haz &lt;- basehaz(obj, centered = FALSE)\nhead(base_haz)\n\n# 4. Extract residuals for diagnostics\nmart_res &lt;- residuals(obj, type = \"martingale\")   # Martingale residuals\nsch   &lt;- cox.zph(obj)   # Schoenfeld residuals and tests\n\n# 5. Fit a stratified Cox model\nobj_str &lt;- coxph(Surv(time, status) ~ x1 + x2 + strata(group), data = mydata)\n\n# 6. Fit a Cox model with time-varying covariates\n# (Requires data in long \"start-stop\" format)\nobj_tv &lt;- coxph(Surv(start, stop, event) ~ x1 + tv_cov, data = tv_data)\n\nBeyond these base functions, other packages offer enhanced output and plots:\n\ngtsummary can produce formatted tables of estimated coefficients, hazard ratios, and confidence intervals in a single step using tbl_regression(obj, exponentiate = TRUE).\nsurvminer provides visualization tools: ggcoxzph(cox.zph(obj)) to diagnose proportional hazards via Schoenfeld residuals, and ggforest(obj) to show a forest plot of hazard ratios.\nggsurvfit simplifies the creation of Kaplan–Meier curves alongside at-risk tables, p-values, and confidence intervals.\n\n\n\nConclusion\nThe Cox proportional hazards model accommodates flexible, nonparametric baseline hazards while preserving a straightforward regression interpretation of covariate effects. Partial-likelihood estimation, together with various model-based residuals, allows rigorous inferences of covariate effects and time trends. Time-varying covariates further expand its applicability to complex longitudinal settings. By combining robust inference with interpretability, the Cox model remains a central tool in regression-based survival analysis.",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 4 - Cox Proportional Hazards Regression"
    ]
  },
  {
    "objectID": "quiz.html",
    "href": "quiz.html",
    "title": "10-Minute In-Class Quiz: Survival Analysis (Chapters 1–5)",
    "section": "",
    "text": "You have 10 minutes to complete this quiz.\nAnswer all questions concisely.\nShow all relevant calculations where applicable."
  },
  {
    "objectID": "quiz.html#instructions",
    "href": "quiz.html#instructions",
    "title": "10-Minute In-Class Quiz: Survival Analysis (Chapters 1–5)",
    "section": "",
    "text": "You have 10 minutes to complete this quiz.\nAnswer all questions concisely.\nShow all relevant calculations where applicable."
  },
  {
    "objectID": "quiz.html#question-1-3-points",
    "href": "quiz.html#question-1-3-points",
    "title": "10-Minute In-Class Quiz: Survival Analysis (Chapters 1–5)",
    "section": "Question 1 (3 points)",
    "text": "Question 1 (3 points)\nThe table below shows survival data for 5 individuals in a study. The event times and status (1: event; 0: censoring) information are given:\n\n\n\nTime\nStatus\n\n\n\n\n2\n1\n\n\n4\n0\n\n\n6\n1\n\n\n7.5\n0\n\n\n8\n1\n\n\n\n\nCompute the Kaplan-Meier estimator \\(\\hat{S}(t)\\) at times \\(t = 2, 6, 8\\).\n\nInterpret \\(\\hat{S}(6)\\) in words."
  },
  {
    "objectID": "quiz.html#question-2-2-points",
    "href": "quiz.html#question-2-2-points",
    "title": "10-Minute In-Class Quiz: Survival Analysis (Chapters 1–5)",
    "section": "Question 2 (2 points)",
    "text": "Question 2 (2 points)\nThe hazard function \\(h(t)\\) is defined as: \\[\n\\lambda(t) = \\lim_{\\Delta t \\to 0} \\frac{P(t \\leq T &lt; t+\\Delta t \\mid T \\geq t)}{\\Delta t}\n\\] (a) Explain what the hazard function represents in survival analysis.\n(b) How is it related to the survival function \\(S(t)\\)?"
  },
  {
    "objectID": "quiz.html#question-3-2-points",
    "href": "quiz.html#question-3-2-points",
    "title": "10-Minute In-Class Quiz: Survival Analysis (Chapters 1–5)",
    "section": "Question 3 (2 points)",
    "text": "Question 3 (2 points)\nYou fit a Kaplan-Meier estimator to a dataset and obtain the following estimated survival probabilities at two time points: \\[\n\\hat{S}(3) = 0.80, \\quad \\hat{S}(5) = 0.65.\n\\] (a) For a subject who has already survived to 3 (years), what is their probability of surviving to 5 years?"
  },
  {
    "objectID": "chap5.html#outline",
    "href": "chap5.html#outline",
    "title": "Applied Survival Analysis",
    "section": "Outline",
    "text": "Outline\n\n\nRestricted Mean Survival Time (RMST)\nAdditive Hazards (AH) Model\nProportional Odds (PO) Model\nAccelerated Failure Time (AFT) Model\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\]"
  },
  {
    "objectID": "chap5.html#motivation",
    "href": "chap5.html#motivation",
    "title": "Applied Survival Analysis",
    "section": "Motivation",
    "text": "Motivation\n\n\nLimitations of hazard ratio\n\nProportionality\nDepends on time frame in case of non-proportionality\n\n\n\n\n\nAlternative metric\n\n\\(\\tau\\)-year survival rate \\(S(\\tau)\\) for a fixed \\(\\tau\\)\n\n\\(5\\)-year survival rates for cancer patients\n\n\\(S_1(\\tau) - S_0(\\tau)\\): increase in survival rate by treatment vs control\nLimitation: cross-sectional survival status at \\(\\tau\\)\n\nDistribution of \\(T\\) in \\([0, \\tau]\\) ignored\nDelay of death within \\([0, \\tau]\\) not captured"
  },
  {
    "objectID": "chap5.html#definition-and-interpretation",
    "href": "chap5.html#definition-and-interpretation",
    "title": "Applied Survival Analysis",
    "section": "Definition and Interpretation",
    "text": "Definition and Interpretation\n\n\nRestricted mean survival time (RMST) \\[\\mu(\\tau)=E(T\\wedge\\tau)\\]\n\na.k.a. Restricted mean life\nAveraged time lived in the first \\(\\tau=5\\) years\nRestricted mean time lost (RMTL): \\(L(\\tau) = \\tau - \\mu(\\tau)\\)\nAlternate expression (area under survival curve, AUC) \\[\\begin{equation}\\label{eq:non_haz:auc}\n\\mu(\\tau)=\\int_0^\\tau S(t)\\dd t.\n\\end{equation}\\]\n\nEstimator \\(\\hat\\mu(\\tau)=\\int_0^\\tau \\hat S(t)\\dd t\\), where \\(\\hat S(t)\\) is KM estimator"
  },
  {
    "objectID": "chap5.html#survival-rate-vs-rmst",
    "href": "chap5.html#survival-rate-vs-rmst",
    "title": "Applied Survival Analysis",
    "section": "Survival Rate vs RMST",
    "text": "Survival Rate vs RMST\n\n\n\\(S(\\tau)\\) vs \\(\\mu(\\tau)\\)\n\n\\(S(\\tau)\\): survival status at \\(\\tau\\)\n\\(\\mu(\\tau)\\): summary of survival experience in \\([0, \\tau]\\) (more information)"
  },
  {
    "objectID": "chap5.html#two-sample-inference",
    "href": "chap5.html#two-sample-inference",
    "title": "Applied Survival Analysis",
    "section": "Two-Sample Inference",
    "text": "Two-Sample Inference\n\n\nEffect size (\\(a=1\\): treatment; 0: control)\n\nAdditive: \\(\\mu_1(\\tau)-\\mu_0(\\tau)\\)\n\nAverage survival (event-free) time gained in \\([0, \\tau]\\)\n\nMultiplicative: \\(\\mu_1(\\tau)/\\mu_0(\\tau)\\) or \\(L_1(\\tau)/L_0(\\tau)\\)\n\nFold change in average survival time (lost) in \\([0, \\tau]\\)\n\n\n\n\n\n\nEstimation and inference\n\nPlug in KM estimators \\(\\hat S_a(t)\\) \\((a= 1, 0)\\)\nObtain \\(\\hat\\var\\{\\hat\\mu_a(\\tau)\\}\\) by \\[\n\\hat\\mu_a(\\tau) = \\mbox{time-weighted sum of the }\\hat S_a(t_j)\n\\mbox{ up to }\\tau\n\\]\n\nGreenwood’s formula for \\(\\hat\\var\\{\\hat S_a(t_j)\\}\\)"
  },
  {
    "objectID": "chap5.html#regression-models",
    "href": "chap5.html#regression-models",
    "title": "Applied Survival Analysis",
    "section": "Regression Models",
    "text": "Regression Models\n\n\nModeling target: conditional RMST \\[\n\\mu(\\tau\\mid Z)=E(T\\wedge \\tau\\mid Z)\n\\]\n\n\n\n\nModel specification \\[\ng\\{\\mu(\\tau\\mid Z)\\}=\\beta^\\T Z\n\\]\n\n\\(g(x) = x\\): Additive model on RMST\n\nUnit increases in \\(Z\\) increase \\(\\tau\\)-RMST by \\(\\beta\\)\n\n\\(g(x) = \\log(x) \\mbox{ or } \\log(\\tau -x)\\): Multiplicative model on RMST/RMTL\n\nUnit increases in \\(Z\\) change \\(\\tau\\)-RMST/RMTL by \\(\\exp(\\beta)\\) times\n\n\\(Z = 1, 0\\) \\(\\Rightarrow\\) Two-sample additive/multiplicative effect sizes"
  },
  {
    "objectID": "chap5.html#fitting-regression-models",
    "href": "chap5.html#fitting-regression-models",
    "title": "Applied Survival Analysis",
    "section": "Fitting Regression Models",
    "text": "Fitting Regression Models\n\n\nObserved data\n\n\\[\n    (X_i, \\delta_i, Z_i)\\,\\,\\, i=1,\\ldots, n\n    \\]\n\n\n\nInverse probability censoring weighting (IPCW) \\[\\begin{equation}\\label{eq:nonhaz_rmst_ipcw}\nn^{-1}\\sum_{i=1}^n \\frac{\\delta_i}{G(X_i\\mid Z_i)}Z_i \\{X_i\\wedge\\tau - g^{-1}(\\hat\\beta^\\T Z_i)\\} = 0,\n\\end{equation}\\]\n\n\\(G(t\\mid Z) = \\pr(C&gt;t\\mid Z)\\): replace by model-based version\nWorks because \\(E\\left[\\frac{\\delta}{G(X\\mid Z)}Z\\{X\\wedge\\tau - g^{-1}(\\beta^\\T Z)\\}\\right]=0\\) under \\(C\\indep T\\mid Z\\) (Exercise)"
  },
  {
    "objectID": "chap5.html#software-survrm2rmst2-i",
    "href": "chap5.html#software-survrm2rmst2-i",
    "title": "Applied Survival Analysis",
    "section": "Software: survRM2::rmst2() (I)",
    "text": "Software: survRM2::rmst2() (I)\n\n\nBasic syntax for RMST analysis\n\n\n\nlibrary(survRM2)\n# Two-sample or regression analysis of RMST\nobj &lt;- rmst2(time, status, arm, tau, covariates = NULL)\n\n\n\n\n\nInput\n\n(time, status): \\((X, \\delta)\\)\narm: vector of indicators (1-0) for treatment vs control\ntau: scaler \\(\\tau\\)\ncovariates: optional covariate matrix (or data frame)"
  },
  {
    "objectID": "chap5.html#software-survrm2rmst2-ii",
    "href": "chap5.html#software-survrm2rmst2-ii",
    "title": "Applied Survival Analysis",
    "section": "Software: survRM2::rmst2() (II)",
    "text": "Software: survRM2::rmst2() (II)\n\n\nTwo-sample output (covariates = NULL)\n\nobj$RMST.arm1 & obj$RMST.arm0: two lists of group-wise inference results for arm = 1 and 0\nobj$unadjusted.result: matrix containing estimates, 95% confidence intervals, and \\(p\\)-values for \\(\\mu_1(\\tau) - \\mu_0(\\tau)\\), \\(\\mu_1(\\tau)/\\mu_0(\\tau)\\), and \\(L_1(\\tau)/L_0(\\tau)\\)\n\n\n\n\n\nRegression output (covariates supplied)\n\nobj$RMST.difference.adjusted: regression results for \\(g(x) =x\\)\nobj$RMST.ratio.adjusted: regression results for \\(g(x) = \\log(x)\\)\nobj$RMTL.ratio.adjusted: regression results for \\(g(x) = \\log(\\tau - x)\\)"
  },
  {
    "objectID": "chap5.html#rmst-german-breast-cancer-i",
    "href": "chap5.html#rmst-german-breast-cancer-i",
    "title": "Applied Survival Analysis",
    "section": "RMST: German Breast Cancer (I)",
    "text": "RMST: German Breast Cancer (I)\n\n\nEndpoint: 5-year restricted mean relapse-free survival time\n\nTwo-sample: Hormone (arm=1) vs non-hormone (arm=0)\n\n\n\n# Two sample: hormonal and non-hormonal groups on 5-year RMST\nobj &lt;- rmst2(time = df$time / 12, status = df$status, \n            arm = df$hormone - 1, tau = 5)\nobj\n# Restricted Mean Survival Time (RMST) by arm \n#              Est.    se lower .95 upper .95\n# RMST (arm=1) 3.87 0.104     3.666     4.074\n# RMST (arm=0) 3.46 0.084     3.295     3.625\n# \n# Restricted Mean Time Lost (RMTL) by arm \n#              Est.    se lower .95 upper .95\n# RMTL (arm=1) 1.13 0.104     0.926     1.334\n# RMTL (arm=0) 1.54 0.084     1.375     1.705"
  },
  {
    "objectID": "chap5.html#rmst-german-breast-cancer-ii",
    "href": "chap5.html#rmst-german-breast-cancer-ii",
    "title": "Applied Survival Analysis",
    "section": "RMST: German Breast Cancer (II)",
    "text": "RMST: German Breast Cancer (II)\n\n\nTwo-sample\n\nHormone increases 5-year RMST by 0.41 years (\\(p\\)=0.002)\n\n\n# Between-group contrast \n#                       Est. lower .95 upper .95     p\n# RMST (arm=1)-(arm=0) 0.410     0.148     0.672 0.002\n# RMST (arm=1)/(arm=0) 1.118     1.042     1.201 0.002\n# RMTL (arm=1)/(arm=0) 0.734     0.595     0.905 0.004\n#\n#-----  Graphic -------------------------------------------------\n# Graphical display of the group-specific RMST \n# as area under the KM curves\nplot(obj, xlab=\"Time (years)\", ylab = \"Relapse-free survival\",\n     col.RMST = \"gray\", col.RMTL = \"white\", cex.lab = 1.2,\n     cex.axis = 1.2, col = \"black\", xlim = c(0,5))"
  },
  {
    "objectID": "chap5.html#rmst-german-breast-cancer-iii",
    "href": "chap5.html#rmst-german-breast-cancer-iii",
    "title": "Applied Survival Analysis",
    "section": "RMST: German Breast Cancer (III)",
    "text": "RMST: German Breast Cancer (III)\n\n\nTwo-sample"
  },
  {
    "objectID": "chap5.html#rmst-german-breast-cancer-iv",
    "href": "chap5.html#rmst-german-breast-cancer-iv",
    "title": "Applied Survival Analysis",
    "section": "RMST: German Breast Cancer (IV)",
    "text": "RMST: German Breast Cancer (IV)\n\n\nRegression\n\nHormone extends 5-year RMST by 1.137 - 1 = 13.7% (\\(p&lt;\\) 0.001)\n\n\n\n# Regression with all the other covariate\nobj_reg &lt;- rmst2(time = df$time / 12, status = df$status, \n            arm = df$hormone - 1, covariates = df[, 5:11], tau = 5)\n#----- Print out multiplicative model on RMST ---------------\nobj_reg$RMST.ratio.adjusted\n#             coef se(coef)      z     p exp(coef) lower .95 upper .95\n# intercept  1.574    0.153 10.257 0.000     4.824     3.571     6.516\n# arm        0.129    0.039  3.318 0.001     1.137     1.054     1.227\n# age        0.006    0.004  1.537 0.124     1.006     0.998     1.013\n# meno      -0.111    0.072 -1.539 0.124     0.895     0.777     1.031\n# size      -0.004    0.002 -2.132 0.033     0.996     0.992     1.000\n# grade     -0.120    0.035 -3.463 0.001     0.887     0.828     0.949\n# nodes     -0.032    0.006 -5.421 0.000     0.969     0.957     0.980\n# ..."
  },
  {
    "objectID": "chap5.html#semiparametric-ah-model",
    "href": "chap5.html#semiparametric-ah-model",
    "title": "Applied Survival Analysis",
    "section": "Semiparametric AH Model",
    "text": "Semiparametric AH Model\n\n\nAdditive, not multiplicative (Cox), hazards \\[\\begin{equation}\\label{eq:non_haz:add_haz}\n\\lambda(t\\mid Z)=\\lambda_0(t)+\\beta^\\T Z,\n\\end{equation}\\]\n\n\\(\\beta_k\\): risk difference (attributable risk) with one unit increase in \\(Z_{\\cdot k}\\)\nUnit: per (person-)time\n\n“Score” equation\n\n\\(\\hat\\beta\\): explicit solution to \\(U_n(\\hat\\beta)=0\\) (Lin and Ying, 1994) \\[\\begin{equation}\nU_n(\\beta) = n^{-1}\\sum_{i=1}^n\\int_0^\\tau\\left\\{Z_i -\\frac{\\sum_{j=1}^n I(X_j\\geq t)Z_j}{\\sum_{j=1}^n I(X_j\\geq t)}\\right\\}\n\\{\\dd N_i(t) - I(X_i\\geq t)\\beta^\\T Z_i \\dd t\\},\n\\end{equation}\\]"
  },
  {
    "objectID": "chap5.html#ah-model-extensions",
    "href": "chap5.html#ah-model-extensions",
    "title": "Applied Survival Analysis",
    "section": "AH Model Extensions",
    "text": "AH Model Extensions\n\n\nTime-varying covariates \\[\\begin{equation}\n\\lambda(t\\mid Z) =\\lambda_0(t)+\\beta^\\T Z(t)\n\\end{equation}\\]\n\n\n\n\nResiduals\n\nCox-Snell, score, martingale/deviance\n\n\n\n\n\nAalen’s nonparametric AH model \\[\\begin{equation}\\label{eq:non_haz:add_haz1}\n\\lambda(t\\mid Z)=\\lambda_0(t)+\\beta(t)^\\T Z(t),\n\\end{equation}\\]\n\nLeast-squares type estimates for \\(B(t)=\\int_0^t\\beta(s)\\dd s\\)\nCan be used to check constancy of \\(\\beta\\)"
  },
  {
    "objectID": "chap5.html#software-addhazardah",
    "href": "chap5.html#software-addhazardah",
    "title": "Applied Survival Analysis",
    "section": "Software: addhazard::ah()",
    "text": "Software: addhazard::ah()\n\n\nBasic syntax for semiparametric AH\n\n\n\nlibrary(addhazard)\n# Fit semiparametric AH model\nobj &lt;- ah(Surv(time, status) ~ covariates, ties = FALSE)\n\n\n\n\n\nInput\n\nSurv(time, status) ~ covariates: same formula as in coxph()\nties = FALSE: specify and de-tie time (add a small noise)\n\n\n\n\n\nOutput: an object of class ah\n\nobj$coef: \\(\\hat\\beta\\), obj$var: \\(\\hat\\var(\\hat\\beta)\\)\nsummary(obj): outputs regression table"
  },
  {
    "objectID": "chap5.html#software-timeregaalen",
    "href": "chap5.html#software-timeregaalen",
    "title": "Applied Survival Analysis",
    "section": "Software: timereg::aalen()",
    "text": "Software: timereg::aalen()\n\n\nBasic syntax for Aalen’s nonparametric AH\n\n\n\nlibrary(timereg)\n# Fit Aalen's nonparametric AH model\nobj &lt;- aalen(Surv(time, status) ~ covariates)\n\n\n\nInput\n\nSurv(time, status) ~ covariates: same formula as coxph()\n\nOutput: an object of class aalen\n\nobj$cum: matrix containing \\(t\\) and \\(\\hat B(t)\\)\nobj$var: matrix containing \\(t\\) and pointwise \\(\\hat\\var\\{\\hat B(t)\\}\\)\nsummary(obj): outputs test results for \\(H_0: \\beta(t)\\equiv 0\\)"
  },
  {
    "objectID": "chap5.html#ah-german-breast-cancer",
    "href": "chap5.html#ah-german-breast-cancer",
    "title": "Applied Survival Analysis",
    "section": "AH: German Breast Cancer",
    "text": "AH: German Breast Cancer\n\n\nSemiparametric AH model\n\nHormone reduces relapse/death rate by 0.047 per person-year\n\n\n\n# Add a small random number to time to get rid of ties\ndata.CE$time.dties &lt;- data.CE$time/12 + runif(nrow(data.CE),0, 1e-12) \n# fit an additive hazard model\nobj &lt;- ah(Surv(time.dties,status) ~ hormone + meno + age + size + \n            grade + prog + estrg, data = data.CE, ties = FALSE)\n# print out summary\nsummary(obj)\n#               coef         se   lower.95   upper.95      z  p.value    \n# hormone -4.741e-02  1.705e-02 -8.082e-02 -1.400e-02 -2.782 0.005411 ** \n# meno     4.015e-02  2.417e-02 -7.218e-03  8.751e-02  1.661 0.096652 .  \n# age     -1.070e-03  1.391e-03 -3.796e-03  1.655e-03 -0.770 0.441488    \n# size     2.447e-03  7.095e-04  1.056e-03  3.838e-03  3.449 0.000563 ***\n# ..."
  },
  {
    "objectID": "chap5.html#semiparametric-po-model",
    "href": "chap5.html#semiparametric-po-model",
    "title": "Applied Survival Analysis",
    "section": "Semiparametric PO Model",
    "text": "Semiparametric PO Model\n\n\nModel specification \\[\\begin{equation}\\label{eq:non_haz:po}\n\\log\\left\\{\\frac{1-S(t\\mid Z)}{S(t\\mid Z)}\\right\\}=h_0(t)+\\beta^\\T Z,\n\\end{equation}\\]\n\n\\(h_0(t)\\): nonparametric (non-decreasing) baseline cumulative log-odds\nFix \\(t\\) \\(\\to\\) logistic regression for \\(I(T\\leq t)\\)\n\nTime-varying intercept, constant odds ratio\n\nProportional odds \\[\\begin{equation}\\label{eq:non_haz:poprop}\n\\frac{\\{1-S(t\\mid z_1)\\}/S(t\\mid z_1)}{\\{1-S(t\\mid z_2)\\}/S(t\\mid z_2)}=\\exp\\{\\beta^\\T(z_1-z_2)\\}.\n\\end{equation}\\]\n\n\\(\\exp(\\beta_k)\\): odds ratio for an early event (regardless of cut-off) with one unit increase in \\(Z_{\\cdot k}\\)"
  },
  {
    "objectID": "chap5.html#estimation-and-extension",
    "href": "chap5.html#estimation-and-extension",
    "title": "Applied Survival Analysis",
    "section": "Estimation and Extension",
    "text": "Estimation and Extension\n\n\nEstimation and inference\n\nNonparametric MLE: Joint maximization w.r.t. \\(\\beta\\) and the \\(\\Delta h(t_j)= h(t_j) - h(t_j-)\\) \\((j=1,\\ldots, m)\\)\n\n\n\n\n\nSemiparametric transformation models \\[\\begin{equation}\\label{eq:non_haz:linear_trans}\ng\\{F(t\\mid Z)\\}=h_0(t)+\\beta^\\T Z,\n\\end{equation}\\]\n\n\\(F(t\\mid Z)=1- S(t\\mid Z)\\)\n\\(\\log\\{x/(1-x)\\}\\): Proportional odds\n\\(\\log(-\\log(1 - x))\\): Proportional hazards (Cox)"
  },
  {
    "objectID": "chap5.html#software-timeregprop.odds",
    "href": "chap5.html#software-timeregprop.odds",
    "title": "Applied Survival Analysis",
    "section": "Software: timereg::prop.odds()",
    "text": "Software: timereg::prop.odds()\n\n\nBasic syntax for semiparametric PO model\n\n\n\nlibrary(timereg)\n# Fit a semiparametric proportional odds model\nobj &lt;- prop.odds(Event(time, status) ~ covariates)\n\n\n\n\n\nInput\n\nEvent(time, status) ~ covariates: similar to Surv(time, status) ~ covariates in coxph()\n\nOutput: an object of class cox.aalen\n\nobj$gamma: \\(\\hat\\beta\\); obj$var.gamma: \\(\\hat\\var(\\hat\\beta)\\)\nobj$cum: matrix containing \\(t\\) and \\(\\exp\\{\\hat h_0(t)\\}\\)\nsummary(obj): summarizes regression results"
  },
  {
    "objectID": "chap5.html#po-german-breast-cancer-i",
    "href": "chap5.html#po-german-breast-cancer-i",
    "title": "Applied Survival Analysis",
    "section": "PO: German Breast Cancer (I)",
    "text": "PO: German Breast Cancer (I)\n\n\nSemiparametric PO model\n\nHormone reduces odds of early relapse/death by \\(1-\\exp(-0.522)=40.7\\%\\) (\\(p\\)-value 0.002)\n\n\n\n# Fit a PO model\nobj &lt;- prop.odds(Event(time, status) ~ hormone + meno + age + size + \n                   grade + nodes + prog + estrg, data = df)\n# print out summary\nsummary(obj)\n#              Coef.  SE       z      P-val   lower2.5% upper97.5%\n# hormone2 -0.52200 0.17000  -3.0800 2.08e-03 -0.855000   -0.18900\n# meno2     0.49000 0.24300   1.9100 5.66e-02  0.013700    0.96600\n# age      -0.02240 0.01280  -1.7500 8.09e-02 -0.047500    0.00269\n# size      0.01150 0.00611   1.7800 7.57e-02 -0.000475    0.02350\n# ..."
  },
  {
    "objectID": "chap5.html#po-german-breast-cancer-ii",
    "href": "chap5.html#po-german-breast-cancer-ii",
    "title": "Applied Survival Analysis",
    "section": "PO: German Breast Cancer (II)",
    "text": "PO: German Breast Cancer (II)\n\n # Plot baseline cumulative odds\n plot(stepfun(t, c(0, base_odds)), do.points = FALSE, lwd = 2,\n      xlim=c(0,80), ylim=c(0,1.4), frame.plot = FALSE,\n      ylab=\"Baseline cumulative odds\", xlab=\"Time (months)\", main =\"\")"
  },
  {
    "objectID": "chap5.html#model-specification",
    "href": "chap5.html#model-specification",
    "title": "Applied Survival Analysis",
    "section": "Model Specification",
    "text": "Model Specification\n\n\nLog-linear model \\[\\begin{equation}\\label{eq:non_haz:aft}\n\\log T=\\beta^\\T Z + \\epsilon, \\hspace{10mm} \\epsilon\\indep Z,\n\\end{equation}\\]\n\n\\(\\epsilon\\): random error with unknow distribution\n\\(T=\\exp(\\beta^\\T Z)\\exp(\\epsilon)\\): multiplicative covariate effects on \\(T\\)\n\n\\(Z\\) changes survival time by \\(\\exp(\\beta^\\T Z)\\) fold\n\nAccelerated failure time (AFT): with \\(S_\\epsilon(t)=\\pr\\{\\exp(\\epsilon) &gt; t\\}\\) \\[\\begin{align*}\nS(t\\mid Z) &=\\pr\\left\\{\\exp(\\beta^\\T Z)\\exp(\\epsilon) &gt; t\\mid Z\\right\\}\\\\\n& = S_\\epsilon\\left\\{\\exp(-\\beta^\\T Z)t\\right\\}\n\\end{align*}\\]\n\nAccelerates time course by a factor of \\(\\exp(\\beta^\\T Z)\\)"
  },
  {
    "objectID": "chap5.html#parametric-vs-semiparametric",
    "href": "chap5.html#parametric-vs-semiparametric",
    "title": "Applied Survival Analysis",
    "section": "Parametric vs Semiparametric",
    "text": "Parametric vs Semiparametric\n\n\nParametric AFT\n\n\\(\\exp(\\epsilon)\\sim\\) Weibull, log-normal, log-logistic, etc\nSimplifies estimation \\(\\to\\) MLE\nWeibull AFT model \\(\\Leftrightarrow\\) Weibull PH model (only distribution with this equivalency)\n\n\n\n\n\nSemiparametric AFT\n\n\\(\\exp(\\epsilon)\\sim\\) nonparametric distribution\nBuckley-James estimator \\[\n\\mbox{Least squares} \\stackrel{\\rm iterate}{\\longleftrightarrow}\n\\mbox{Imputing censored values}\n\\]"
  },
  {
    "objectID": "chap5.html#software-aftgeeaftgee",
    "href": "chap5.html#software-aftgeeaftgee",
    "title": "Applied Survival Analysis",
    "section": "Software: aftgee::aftgee()",
    "text": "Software: aftgee::aftgee()\n\n\nBasic syntax for semiparametric AFT model\n\n\n\nlibrary(aftgee)\n# Fit a semiparametric AFT model\n obj &lt;- aftgee(Surv(time,status) ~ covariates)\n\n\n\n\n\nInput\n\nSurv(time,status) ~ covariates: same formula as in coxph()\n\nOutput: an object of class aftgee\n\nobj$coef.res: \\(\\hat\\beta\\)\nobj$var.res: \\(\\hat\\var(\\hat\\beta)\\)\nsummary(obj): summarizes regression results"
  },
  {
    "objectID": "chap5.html#aft-german-breast-cancer",
    "href": "chap5.html#aft-german-breast-cancer",
    "title": "Applied Survival Analysis",
    "section": "AFT: German Breast Cancer",
    "text": "AFT: German Breast Cancer\n\nSemiparametric AFT model\n\nHormone increases relapse-free survival time by \\(\\exp(0.320) = 1.38\\) fold (\\(p\\)-value 0.001)\n\n\n\n# Fit an AFT model\nset.seed(123)  # SE is based on resampling\nobj &lt;- aftgee(Surv(time, status) ~ hormone + meno + age + size + grade + \n                nodes + prog + estrg, data = df,\n                B = 500) # Number of resamples\n# print out summary\nsummary(obj)\n#             Estimate StdErr z.value p.value    \n# (Intercept)    4.262  0.410   10.40  &lt;2e-16 ***\n# hormone2       0.320  0.092    3.47   0.001 ***\n# meno2         -0.270  0.148   -1.82   0.068 .  \n# age            0.013  0.007    1.69   0.092 .  \n# size          -0.006  0.003   -1.89   0.059 .  \n# ..."
  },
  {
    "objectID": "chap5.html#summary-i",
    "href": "chap5.html#summary-i",
    "title": "Applied Survival Analysis",
    "section": "Summary (I)",
    "text": "Summary (I)\n\n\\(\\tau\\)-RMST\n\nDifference/ratio in survival time by time \\(\\tau\\)\nTwo-sample and regression\nsurvRM2::rmst2()\n\nAdditive hazards\n\nDifference in risk (attributable risk)\naddhazard::ah() (semiparametric: constant difference)\ntimereg::aalen() (nonparametric: time-varying difference)"
  },
  {
    "objectID": "chap5.html#summary-ii",
    "href": "chap5.html#summary-ii",
    "title": "Applied Survival Analysis",
    "section": "Summary (II)",
    "text": "Summary (II)\n\nProportional odds\n\nOdds ratio for an early event\ntimereg::prop.odds()\n\nAccelerated failure time\n\nRatio in survival time\naftgee::aftgee() (semiparametric: unspecified error distribution)\nsurvival::survreg() (parametric error distribution)"
  },
  {
    "objectID": "chap5.html#ah-german-breast-cancer-i",
    "href": "chap5.html#ah-german-breast-cancer-i",
    "title": "Applied Survival Analysis",
    "section": "AH: German Breast Cancer (I)",
    "text": "AH: German Breast Cancer (I)\n\n\nSemiparametric AH model\n\nHormone reduces relapse/death rate by 0.050 per person-year\n\n\n\n# Add a small random number to time to get rid of ties\ndf$time.dties &lt;- df$time/12 + runif(nrow(df),0, 1e-12) \n# fit an additive hazard model\nobj &lt;- ah(Surv(time.dties, status) ~ hormone + meno + age + size + \n            grade + nodes + prog + estrg, data = df, ties = FALSE)\n# print out summary\nsummary(obj)\n#               coef         se   lower.95   upper.95      z  p.value    \n# hormone -0.0497713  0.0170343 -0.0831585 -0.0163842 -2.922  0.00348 ** \n# meno     0.0373581  0.0242005 -0.0100749  0.0847911  1.544  0.12266    \n# age     -0.0011667  0.0013891 -0.0038895  0.0015560 -0.840  0.40096    \n# size     0.0010200  0.0007299 -0.0004107  0.0024506  1.397  0.16231   \n# ..."
  },
  {
    "objectID": "chap5.html#ah-german-breast-cancer-ii",
    "href": "chap5.html#ah-german-breast-cancer-ii",
    "title": "Applied Survival Analysis",
    "section": "AH: German Breast Cancer (II)",
    "text": "AH: German Breast Cancer (II)\n\nSemi- vs. Non-parametric"
  },
  {
    "objectID": "chap5.html#notes",
    "href": "chap5.html#notes",
    "title": "Applied Survival Analysis",
    "section": "Notes",
    "text": "Notes\n\nPseudo-value approach to RMST regression \\[\n   \\hat{\\mu}_i(\\tau) = n \\hat{\\mu}(\\tau) - (n - 1) \\hat{\\mu}^{(-i)}(\\tau)\n\\]\n\n\\(\\hat{\\mu}^{(-i)}(\\tau)\\): RMST without \\(i\\)-th observation\nRegress \\(\\hat{\\mu}_i(\\tau)\\) on \\(Z_i\\)\npseudo package\n\nCox–Aalen model \\[\n\\lambda(t \\mid Z) \\;=\\; \\lambda_0(t) \\exp\\left(\\gamma^\\T Z_{(1)}\\right) + \\beta(t)^\\T Z_{(2)}\n\\]\n\nMultiplicative hazards for \\(Z_{(1)}\\), additive hazards for \\(Z_{(2)}\\)\ntimereg::cox.aalen()"
  },
  {
    "objectID": "chapter5.html#chapter-summary",
    "href": "chapter5.html#chapter-summary",
    "title": "Chapter 5 - Other Non- and Semi-parametric Methods",
    "section": "Chapter Summary",
    "text": "Chapter Summary\nWhen the proportional hazards assumption is questionable or when alternative measures of treatment effect are desired, a variety of non- and semi-parametric approaches can be employed. Restricted mean survival time (RMST) focuses on time lived within a specified window, while additive hazards models quantify absolute rather than relative risk. The proportional odds model captures time-invariant covariate effects on the odds of failing early, and accelerated failure time (AFT) models directly relate log-time to covariates, often offering more intuitive interpretations of “time gained or lost.”\n\nRestricted mean survival time\nThe restricted mean survival time over \\([0, \\tau]\\) is \\[\n\\mu(\\tau) \\;=\\; E\\bigl(T \\wedge \\tau\\bigr) \\;=\\; \\int_0^\\tau S(t)\\,dt,\n\\] where \\(S(t)\\) is the survival function. Compared to hazard ratios, RMST allows direct interpretation of how many additional event-free years (or months) are gained or lost under different conditions. For a two-sample comparison, one can compute the difference \\(\\mu_1(\\tau)-\\mu_0(\\tau)\\) or the ratio \\(\\mu_1(\\tau)/\\mu_0(\\tau)\\). Regression extends this to \\[\ng\\{\\mu(\\tau \\mid Z)\\} = \\beta^\\mathrm{T} Z,\n\\] where \\(g\\) could be the identity (additive on RMST) or log (multiplicative on RMST). Estimation often uses inverse probability of censoring weights (IPCW) or pseudo-observations and remains valid without a proportional hazards assumption.\n\n\nAdditive hazards model\nWhere the Cox model uses the hazard ratio, the additive hazards model posits that covariates contribute additively: \\[\n\\lambda(t \\mid Z) \\;=\\; \\lambda_0(t) + \\beta^\\mathrm{T} Z.\n\\] A coefficient \\(\\beta_k\\) has units of “events per person-time” rather than a ratio, providing an absolute effect size. Semiparametric estimation (Lin’s method) is analogous to partial likelihood, allowing estimation of \\(\\beta\\) and baseline \\(\\lambda_0(t)\\). If time-varying coefficients \\(\\beta(t)\\) are preferred, Aalen’s nonparametric additive model offers full flexibility, with the cumulative effect estimated in a stepwise manner.\nFinally, a Cox–Aalen hybrid model allows some covariates to act multiplicatively on the hazard and others additively over time, bridging the two approaches.\n\n\n\nProportional odds model\nThe proportional odds model targets survival functions via cumulative odds: \\[\n\\log\\left[\\frac{1-S(t\\mid Z)}{S(t \\mid Z)}\\right]\n\\;=\\;\nh_0(t) \\;+\\; \\beta^\\mathrm{T} Z.\n\\] This implies a covariate’s effect is a constant odds ratio on “early” failure. It often accommodates scenarios where hazard ratios decline over time, but the odds ratio remains more stable. Estimation proceeds via a nonparametric maximum likelihood for \\(h_0(t)\\) and a finite-dimensional parameter \\(\\beta\\).\n\n\nAccelerated failure time model\nThe accelerated failure time (AFT) framework directly models log-time: \\[\n\\log T \\;=\\; \\beta^\\mathrm{T} Z \\;+\\; \\varepsilon,\n\\] so \\(\\exp(\\beta_k)\\) is a time ratio. A unit increase in \\(Z_k\\) multiplies median (or mean) survival time by \\(\\exp(\\beta_k)\\). Parametric versions (e.g., log-normal, Weibull) are fit via standard maximum likelihood, while semiparametric AFT estimation uses iterative least squares or rank-based approaches (e.g., Buckley–James, rank-GEE). Such methods can be numerically sensitive when censoring is heavy or the underlying distribution is heavily skewed, but they provide an appealing direct interpretation of how survival time “speeds up” or “slows down.”\n\n\nExample R commands\nBelow is an illustration of core functions (in different packages) implementing these methods. Assume a data frame df with columns: time, status, and additional covariates.\n\n###############################\n# 1. RMST (two-sample/regression)\n###############################\nlibrary(survRM2)\nobj_rmst &lt;- rmst2(time = df$time, status = df$status, arm = df$arm, tau = 5)\nsummary(obj_rmst)           # RMST difference, ratio, etc.\nplot(obj_rmst)              # KM curves with RMST shading\n\n# Regression (IPCW-based) for RMST\nobj_rmst_reg &lt;- rmst2(time = df$time, status = df$status,\n                      arm = df$arm,\n                      covariates = df[, c(\"x1\", \"x2\")],\n                      tau = 5)\nobj_rmst_reg$RMST.difference.adjusted  # Additive model\nobj_rmst_reg$RMST.ratio.adjusted       # Multiplicative model\n\n###############################\n# 2. Additive hazards\n###############################\nlibrary(addhazard)\nobj_ah &lt;- ah(Surv(time, status) ~ x1 + x2, data = df, ties = FALSE)\nsummary(obj_ah)  # Semiparametric additive hazards\n\nlibrary(timereg)\nobj_aalen &lt;- aalen(Surv(time, status) ~ x1 + x2, data = df)\nsummary(obj_aalen)  # Aalen’s nonparametric version\nplot(obj_aalen)\n\n# Cox-Aalen hybrid\nobj_coxaalen &lt;- cox.aalen(Surv(time, status) ~ prop(x1) + x2, data = df)\nsummary(obj_coxaalen)\nplot(obj_coxaalen)   # Time-varying additive effect for x2\n\n###############################\n# 3. Proportional odds\n###############################\nobj_po &lt;- prop.odds(Event(time, status) ~ x1 + x2, data = df)\nsummary(obj_po)\n# Baseline cumulative odds stored in obj_po$cum\n\n###############################\n# 4. AFT models\n###############################\nlibrary(survival)\n# Parametric\nobj_weibull &lt;- survreg(Surv(time, status) ~ x1 + x2,\n                       data = df, dist = \"weibull\")\nsummary(obj_weibull)\n\n# Semiparametric (rank-based or weighted least squares)\nlibrary(aftgee)\nobj_aft_sp &lt;- aftgee(Surv(time, status) ~ x1 + x2,\n                     data = df, B=200)\nsummary(obj_aft_sp)\n\n\n\nConclusion\nEach of these methods introduced can be more appealing than the Cox model when hazard ratios vary over time or when the interpretation of “time gained” or “time ratio” is more intuitive for clinical or policy purposes. By integrating these options, practitioners have a broader and more robust toolkit for analyzing survival data across a wide range of scenarios.",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 5 - Other Non- and Semi-parametric Methods"
    ]
  },
  {
    "objectID": "chapter5.html#r-code",
    "href": "chapter5.html#r-code",
    "title": "Chapter 5 - Other Non- and Semi-parametric Methods",
    "section": "R Code",
    "text": "R Code\n\n\nShow the code\n###############################################################################\n# Chapter 5 R Code\n#\n# This script reproduces all major numerical results in Chapter 5, including:\n#   1. Restricted mean survival time (RMST) analysis (with survRM2)\n#   2. Additive hazards analyses (with addhazard, timereg)\n#   3. Proportional odds models (with timereg)\n#   4. Accelerated failure time (AFT) models (with aftgee, survival)\n#   5. Pseudo-observation approach to RMST (with pseudo)\n###############################################################################\n\n\n#==============================================================================\n# (A) GBC Data Setup\n#==============================================================================\nlibrary(survival)\nlibrary(tidyverse)\n\n#------------------------------------------------------------------------------\n# 1. Read and Prepare GBC Data\n#------------------------------------------------------------------------------\ngbc &lt;- read.table(\"Data//German Breast Cancer Study//gbc.txt\")\n\n# Sort the data by time within each id\no   &lt;- order(gbc$id, gbc$time)\ngbc &lt;- gbc[o, ]\n\n# Keep the first row for each id (first event)\ndf &lt;- gbc[!duplicated(gbc$id), ]\n\n# Set status = 1 if status == 2 or 1\ndf$status &lt;- (df$status &gt; 0) + 0\n\n# Reduce the scales of prog and estrg by 100\ndf$prog  &lt;- df$prog / 100\ndf$estrg &lt;- df$estrg / 100\n\n\n#==============================================================================\n# (B) Restricted Mean Survival Time (RMST) Analysis\n#     Using the \"survRM2\" Package\n#==============================================================================\n# install.packages(\"survRM2\")\nlibrary(survRM2)\n\n#------------------------------------------------------------------------------\n# 1. Two-Sample Comparison (Hormonal vs. Non-Hormonal) on 5-Year RMST\n#------------------------------------------------------------------------------\nobj &lt;- rmst2(\n  time = df$time / 12,   # convert months to years\n  status = df$status,\n  arm = df$hormone - 1,  # hormone: {1, 2} =&gt; arm: {0, 1}\n  tau = 5\n)\n\n# Print results\nobj\n# More compact results\nobj$unadjusted.result\n\n# Graphical display of group-specific RMST\nplot(\n  obj,\n  xlab     = \"Time (years)\",\n  ylab     = \"Relapse-free survival\",\n  col.RMST = \"gray\",\n  col.RMTL = \"white\",\n  col      = \"black\",\n  cex.lab  = 1.2,\n  cex.axis = 1.2,\n  xlim     = c(0, 5)\n)\n\n#------------------------------------------------------------------------------\n# 2. Regression Adjustment for Additional Covariates\n#------------------------------------------------------------------------------\nobj_reg &lt;- rmst2(\n  time       = df$time / 12,\n  status     = df$status,\n  arm        = df$hormone - 1,\n  covariates = df[, 5:11],  # columns 5-11 in df\n  tau        = 5\n)\n\n# Print overall results\nobj_reg\n\n# Additive model on RMST\nround(obj_reg$RMST.difference.adjusted, 3)\n\n# Multiplicative model on RMST\nround(obj_reg$RMST.ratio.adjusted, 3)\n\n# Multiplicative model on RMTL\nround(obj_reg$RMTL.ratio.adjusted, 3)\n\n# For hormone treatment only\n# (May require checking if the object contains this component)\nobj_reg$adjusted.result\n\n\n#==============================================================================\n# (C) Additive Hazards Analysis\n#==============================================================================\n# install.packages(\"addhazard\")\nlibrary(addhazard)\n\n#------------------------------------------------------------------------------\n# 1. Fitting an Additive Hazards Model (ah) from addhazard\n#------------------------------------------------------------------------------\n# Convert hormone/meno to factors\ndf$hormone &lt;- factor(df$hormone)\ndf$meno    &lt;- factor(df$meno)\n\n# Add a tiny random component to break ties\nset.seed(123)\ndf$time.dties &lt;- df$time / 12 + runif(nrow(df), 0, 1e-12)\n\n# Fit additive hazards model\nobj_ah &lt;- ah(\n  Surv(time.dties, status) ~ hormone + meno + age + size + grade + nodes + prog + estrg,\n  data = df,\n  ties = FALSE\n)\n\nsummary(obj_ah)\nbeta &lt;- obj_ah$coef  # estimated regression coefficients\n#------------------------------------------------------------------------------\n# 2. Aalen's Nonparametric Model (aalen) from timereg\n#------------------------------------------------------------------------------\n# install.packages(\"timereg\")\nlibrary(timereg)\n\nobj_aalen &lt;- aalen(\n  Surv(time / 12, status) ~ hormone + meno + age + size + grade + nodes + prog + estrg,\n  data = df\n)\n\nsummary(obj_aalen)\n\nBt &lt;- obj_aalen$cum  # cumulative regression function estimates\n\npar(mfrow = c(5, 2))\nplot(obj_aalen)\n\n#------------------------------------------------------------------------------\n# 3. Plotting the Estimated Cumulative Regression Coefficients\n#------------------------------------------------------------------------------\naalen_beta &lt;- as_tibble(Bt) %&gt;%\n  select(-`(Intercept)`) %&gt;%    # remove intercept\n  pivot_longer(\n    cols      = -time,\n    names_to  = \"covariate\",\n    values_to = \"beta\"\n  ) %&gt;%\n  mutate(covariate = fct_inorder(covariate))\n\n# (Optional) If you intended a semiparametric overlay, \n# you would need a 'beta' object. This is a placeholder:\nly_beta &lt;- tibble(\n  time = Bt[, \"time\"],\n  # example usage if 'beta' were a coefficient vector or matrix\n  as_tibble(Bt[, \"time\"] %*% t(beta))\n) %&gt;%\n  pivot_longer(\n    cols      = -time,\n    names_to  = \"covariate\",\n    values_to = \"beta\"\n  ) %&gt;%\n  mutate(covariate = fct_inorder(covariate))\n\nvar_labeller &lt;- c(\n  \"hormone2\" = \"Hormone therapy (yes v. no)\",\n  \"meno2\"    = \"Menopausal (yes v. no)\",\n  \"age\"      = \"Age (years)\",\n  \"size\"     = \"Tumor size (mm)\",\n  \"grade\"    = \"Grade (1-3)\",\n  \"nodes\"    = \"Nodes\",\n  \"prog\"     = \"Progesterone (100 fmol/mg)\",\n  \"estrg\"    = \"Estrogen (100 fmol/mg)\"\n)\n\naalen_beta %&gt;%\n  ggplot(aes(x = time, y = beta)) +\n  geom_step() +\n  # If you had a semiparametric line, you'd add:\n  geom_line(data = ly_beta, aes(x = time, y = beta),\n            color = \"#C5050C\", linetype = 2, linewidth = 1) +\n  scale_x_continuous(\n    \"Time (years)\",\n    limits = c(0, 6),\n    breaks = seq(0, 6, by = 1)\n  ) +\n  labs(y = expression(\"B(t) (year\"^{-1} * \")\")) +\n  facet_wrap(\n    ~covariate,\n    scales   = \"free_y\",\n    ncol     = 2,\n    labeller = labeller(covariate = var_labeller)\n  ) +\n  theme_minimal()\n\nggsave(\"images/nonhaz_aalen_beta.png\", width = 8, height = 8)\nggsave(\"images/nonhaz_aalen_beta.eps\", width = 8, height = 8)\n\n#------------------------------------------------------------------------------\n# 4. Cox-Aalen Model\n#------------------------------------------------------------------------------\nobj_cox_aalen &lt;- cox.aalen(\n  Surv(time / 12, status) ~ prop(hormone) + meno + age + size + grade + nodes + prog + estrg,\n  data = df\n)\n\nsummary(obj_cox_aalen)\nplot(obj_cox_aalen)\n\nobj_cox_aalen$gamma\nobj_cox_aalen$var.gamma\n\n\n#==============================================================================\n# (D) Proportional Odds Analysis\n#==============================================================================\n# install.packages(\"timereg\")\nlibrary(timereg)\n\nobj_po &lt;- prop.odds(\n  Event(time, status) ~ hormone + meno + age + size + grade + nodes + prog + estrg,\n  data = df\n)\n\nsummary(obj_po)\n\nt         = obj_po$cum[, 1]\nbase_odds = obj_po$cum[, 2]\n\n#------------------------------------------------------------------------------\n# 1. Plot Baseline Cumulative Odds (Base R)\n#------------------------------------------------------------------------------\npar(mfrow = c(1, 1))\nplot(\n  stepfun(t, c(0, base_odds)),\n  do.points   = FALSE,\n  lwd         = 2,\n  xlim        = c(0, 80),\n  ylim        = c(0, 1.4),\n  frame.plot  = FALSE,\n  xlab        = \"Time (months)\",\n  ylab        = \"Baseline cumulative odds\",\n  main        = \"\"\n)\n\n#------------------------------------------------------------------------------\n# 2. Plot Baseline Cumulative Odds (ggplot)\n#------------------------------------------------------------------------------\ntibble(\n  time = t,\n  odds = base_odds\n) %&gt;%\n  ggplot(aes(x = time / 12, y = odds)) +\n  geom_step() +\n  scale_x_continuous(\n    \"Time (years)\",\n    limits = c(0, 6),\n    breaks = 1:6\n  ) +\n  scale_y_continuous(\"Baseline cumulative odds\", limits = c(0, 1.25)) +\n  theme_minimal()\n\nggsave(\"images/nonhaz_po_base.png\", width = 6, height = 4)\nggsave(\"images/nonhaz_po_base.eps\", width = 6, height = 4)\n\n\n#==============================================================================\n# (E) Accelerated Failure Time (AFT) Analysis\n#==============================================================================\n# install.packages(\"aftgee\")\nlibrary(aftgee)\n\n#------------------------------------------------------------------------------\n# 1. Semiparametric AFT Model (aftgee)\n#------------------------------------------------------------------------------\nset.seed(123)  # SE is based on resampling\nobj_aftgee &lt;- aftgee(\n  Surv(time, status) ~ hormone + meno + age + size + grade + nodes + prog + estrg,\n  data = df,\n  B    = 500\n)\n\nsummary(obj_aftgee)\n\n# Acceleration factors exp(beta)\nexp(obj_aftgee$coef.res)\n\n# Variance of the log-acceleration factors\nobj_aftgee$var.res\n\n#------------------------------------------------------------------------------\n# 2. Parametric AFT Model (survreg)\n#------------------------------------------------------------------------------\nobj_aft &lt;- survreg(\n  Surv(time, status) ~ hormone + meno + age + size + grade + nodes + prog + estrg,\n  data  = df,\n  dist  = \"loglogistic\"\n)\n\nsummary(obj_aft)\nobj_aft$coefficients\nobj_aft$var\nobj_aft$scale\n\n\n#==============================================================================\n# (F) Pseudo-Observations Approach to RMST\n#==============================================================================\n# install.packages(\"pseudo\")\nlibrary(pseudo)\n\n# Example usage on df (instead of lung)\ntau          &lt;- 5\npseudo_rmst  &lt;- pseudomean(df$time / 12, df$status, tmax = tau)\n\n# Fit a regression model using pseudo-observations\nlibrary(geepack)\nfit_pseudo &lt;- geese(\n  pseudo_rmst ~ hormone + meno + age + size + grade + nodes + prog + estrg,\n  data      = df,\n  mean.link = \"identity\"\n)\n# Alternatively: mean.link = \"log\"\n\nsummary(fit_pseudo)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 5 - Other Non- and Semi-parametric Methods"
    ]
  },
  {
    "objectID": "chap6.html#outline",
    "href": "chap6.html#outline",
    "title": "Applied Survival Analysis",
    "section": "Outline",
    "text": "Outline\n\n\nSample size for Cox model and RMST\nImpact of study design and censoring\nAn example using pilot study\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\]"
  },
  {
    "objectID": "chap6.html#motivation",
    "href": "chap6.html#motivation",
    "title": "Applied Survival Analysis",
    "section": "Motivation",
    "text": "Motivation\n\n\nSample size calculation\n\nEnsure power (80% or 90%) to detect meaningful difference\n\nPower: probability of rejecting \\(H_0\\) under alternative\n\nToo small sample \\(\\to\\) low power \\(\\to\\) fail to reject \\(H_0\\) even if \\(H_A\\) is true\n\n\n\n\n\nInput information\n\nHypothesized effect size: minimal important difference (MID)\n\nHazard ratio, difference in RMST, etc.\n\nDesired power (0.8 or 0.9)\nSignificance level \\(\\alpha\\) (0.05)\nGroup allocation ratio (1:1)"
  },
  {
    "objectID": "chap6.html#general-setting",
    "href": "chap6.html#general-setting",
    "title": "Applied Survival Analysis",
    "section": "General Setting",
    "text": "General Setting\n\n\nStandardized test statistic \\[\\begin{equation}\\label{eq:design_form}\nS_n=\\sqrt n T_n/\\hat\\sigma_n \\stackrel{H_0}{\\sim}\\mathcal N(0, 1)\n\\end{equation}\\]\n\n\\(\\sqrt n T_n\\stackrel{H_0}{\\sim}\\mathcal N(0,\\sigma_0^2)\\); \\(\\,\\) \\(\\hat\\sigma^2_n=\\) Estimator of \\(\\sigma_0^2\\)\n\\(T_n\\): Test statistic converging at \\(n^{-1/2}\\) rate as \\(n\\to\\infty\\)\n\n\n\n\n\nLevel-\\(\\alpha\\) test\n\nReject \\(H_0\\) if \\(|S_n|&gt;z_{1-\\alpha/2}\\)\n\\(z_{1-\\alpha/2}\\): \\(100(1-\\alpha/2)\\) percentile of standard normal\n\n\n\n\n\nqnorm(0.975)\n# [1] 1.959964"
  },
  {
    "objectID": "chap6.html#general-derivation",
    "href": "chap6.html#general-derivation",
    "title": "Applied Survival Analysis",
    "section": "General Derivation",
    "text": "General Derivation\n\n\nEffect size \\(\\theta\\)\n\n\\(H_0: \\theta = 0\\); \\(\\,\\) \\(H_A: \\theta\\neq 0\\)\n\n\\(\\theta=\\) log-hazard ratio under Cox model\n\\(\\theta =\\) difference in RMST\n\n\n\n\n\n\nSuppose under \\(H_A\\)\n\nMean of test statistic (\\(\\theta=\\) MID) \\[\nE_\\theta(T_n)\\approx f(\\theta)\n\\]\n\n\\(f(\\theta)\\) is some function with \\(f(0)=0\\) (centered under \\(H_0\\))\n\nThen, \\[S_n=\\sqrt n T_n/\\hat\\sigma_n \\stackrel{H_A}{\\sim} \\mathcal N\\{\\sqrt nf(\\theta)/\\sigma_0, 1\\}\\]\n\n\\(f(\\theta)/\\sigma_0\\): signal-to-noise ratio"
  },
  {
    "objectID": "chap6.html#general-formula",
    "href": "chap6.html#general-formula",
    "title": "Applied Survival Analysis",
    "section": "General Formula",
    "text": "General Formula\n\n\nPower requirement \\[\n\\pr_\\theta(|S_n|&gt;z_{1-\\alpha/2})\\geq\\gamma\n\\]\n\n\\(\\gamma\\): desired power (0.8 or 0.9)\nUse \\(S_n \\sim \\mathcal N\\{\\sqrt nf(\\theta)/\\sigma_0, 1\\}\\) to solve for \\(n\\)\n\n\n\n\n\nSample size formula \\[\\begin{equation}\\label{eq:design_ss_gen}\nn=\\frac{\\sigma_0^2(z_{1-\\alpha/2}+z_\\gamma)^2}{f(\\theta)^2}\n\\end{equation}\\]\n\nFind mean \\(f(\\theta)\\) and variance \\(\\sigma_0^2\\)"
  },
  {
    "objectID": "chap6.html#case-study-cox-model",
    "href": "chap6.html#case-study-cox-model",
    "title": "Applied Survival Analysis",
    "section": "Case Study: Cox Model",
    "text": "Case Study: Cox Model\n\n\nPartial-likelihood score/log-rank test\n\nTest statistic \\(T_n = U_n(0)\\)\n\nEquivalent to log-rank test under \\(Z = 1, 0\\)\n\\(f(\\theta)=E\\{U_n(0)\\}\\approx\\theta q(1-q)\\psi\\) and \\(\\sigma_0^2=q(1-q)\\psi\\)\n\\(q=N_1/n\\): proportion randomized to treatment\n\\(\\theta\\): log-hazard ratio\n\\(\\psi=\\int_0^\\infty \\pi(t)\\lambda_0(t)\\dd t=\\pr(T\\leq C)\\): proportion of failure observed, where \\(\\pi(t)=\\pr(X&gt; t)\\)\n\n\n\n\n\n\nSample size formula \\[\\begin{equation}\\label{eq:cox_sample_size}\nn= \\frac{(z_{1-\\alpha/2}+z_{\\gamma})^2}{q(1-q)\\psi\\theta^2}\n\\end{equation}\\]\n\nExpected number of events \\(n\\psi = (z_{1-\\alpha/2}+z_{\\gamma})^2/\\{q(1-q)\\theta^2\\}\\)"
  },
  {
    "objectID": "chap6.html#case-study-rmst",
    "href": "chap6.html#case-study-rmst",
    "title": "Applied Survival Analysis",
    "section": "Case Study: RMST",
    "text": "Case Study: RMST\n\n\nDifference in \\(\\tau\\)-RMST\n\nTest statistic \\(T_n = \\hat\\theta(\\tau)=\\hat\\mu_1(\\tau) - \\hat\\mu_0(\\tau)\\)\n\n\\(f(\\theta)=E\\{\\hat\\theta(\\tau)\\}\\approx\\theta(\\tau)\\) and \\(\\sigma_0^2=\\var\\{\\sqrt n\\hat\\theta(\\tau)\\}\\approx q^{-1}(1-q)^{-1}\\zeta(\\tau)\\)\n\\(\\zeta(\\tau)=\\int_0^\\tau R_0(\\tau;t)^2\\pi(t)^{-1}\\lambda_0(t)\\dd t\\)\n\\(R_0(\\tau;t)=\\int_t^\\tau S_0(t)\\dd t\\)\n\\(S_0(t)\\) and \\(\\lambda_0(t)\\): survival/hazard functions in control\n\n\n\n\n\n\nSample size formula \\[\\begin{equation}\\label{eq:rmst_sample_size}\nn= \\frac{\\zeta(\\tau)(z_{1-\\alpha/2}+z_{\\gamma})^2}{q(1-q)\\theta(\\tau)^2}\n\\end{equation}\\]"
  },
  {
    "objectID": "chap6.html#dependence-on-censoring",
    "href": "chap6.html#dependence-on-censoring",
    "title": "Applied Survival Analysis",
    "section": "Dependence on Censoring",
    "text": "Dependence on Censoring\n\n\nTwo types of parameters\n\nThe failure factor: \\(S_0(t), \\lambda_0(t)\\), log-HR, \\(\\theta(\\tau)\\)\n\nUse domain knowledge (or pilot study data) to specify (or estimate)\n\nThe censoring factor \\[\n\\pi(t)=\\pr(X&gt;t)=S_0(t)G(t)\n\\]\n\n\\(G(t)=\\pr(C &gt; t)\\)\nInvolved in \\(\\psi\\) for log-rank (Cox) and \\(\\zeta(\\tau)\\) for RMST\n\n\n\n\n\n\nCensoring depends on study design\n\nInitial period of subject accrual\nAdditional follow-up"
  },
  {
    "objectID": "chap6.html#simplified-model",
    "href": "chap6.html#simplified-model",
    "title": "Applied Survival Analysis",
    "section": "Simplified Model",
    "text": "Simplified Model\n\n\nParametric set-up\n\n\\(T\\sim\\mbox{Expn}(\\lambda_0)\\)\nLoss to follow-up (LTFU) \\(\\sim\\mbox{Expn}(\\lambda_L)\\)\nAdministrative censoring \\(\\sim\\mbox{Unif}[c, b + c]\\)\n\nUniform accrual in \\([0, b]\\)\nSubsequent follow-up time \\(c\\)"
  },
  {
    "objectID": "chap6.html#model-based-expressions",
    "href": "chap6.html#model-based-expressions",
    "title": "Applied Survival Analysis",
    "section": "Model-Based Expressions",
    "text": "Model-Based Expressions\n\n\nUnder this set-up\n\nCensoring survival function \\[\\begin{equation}\\label{eq:design:censoring}\nG(t;\\lambda_L, b, c):=\\pr(C&gt;t)=\\left\\{\\begin{array}{ll} \\exp(-\\lambda_L t)& 0\\leq t\\leq c\\\\\nb^{-1}(c+b-t)\\exp(-\\lambda_L t) & c&lt;t&lt;c+b \\\\\n0& t\\geq c+b.\n\\end{array}\\right.\n\\end{equation}\\]\n\n\\(\\psi\\) for log-rank (closed-form) \\[\\begin{equation}\\label{eq:cox:psi}\n\\psi(\\lambda_0,\\lambda_L, b, c)=\\frac{\\lambda_0}{\\lambda_0+\\lambda_L}\\left[1-\\exp\\{-(\\lambda_0+\\lambda_L)c\\}\n\\frac{1-\\exp\\{-(\\lambda_0+\\lambda_L)b\\}}{(\\lambda_0+\\lambda_L)b}\\right]\n\\end{equation}\\]\n\\(\\zeta(\\tau)\\) for RMST (needs numerical integration) \\[\\begin{equation}\\label{eq:design:rmst_zeta}\n\\zeta(\\tau; \\lambda_0, \\lambda_L, b, c)=\\lambda_0^{-1}\\int_0^\\tau\\{\\exp(-\\lambda_0 t)-\\exp(-\\lambda_0 \\tau)\\}^2\\exp(\\lambda_0 t)G(t;\\lambda_L, b, c)^{-1}\\dd t\n\\end{equation}\\]\n\nPlug \\(\\psi\\) or \\(\\zeta(\\tau)\\) back into sample size formulas"
  },
  {
    "objectID": "chap6.html#programming-the-functions-i",
    "href": "chap6.html#programming-the-functions-i",
    "title": "Applied Survival Analysis",
    "section": "Programming the Functions (I)",
    "text": "Programming the Functions (I)\n\n\\(G(t;\\lambda_L, b, c)\\): Survival function for censoring\n\n\nGfun &lt;- function(t, lambdaL, b, c){\n  Gt &lt;- ifelse(t &lt;= c, exp(- lambdaL * t),\n    ifelse(t &lt; c + b, exp(- lambdaL * t) * (b + c - t ) / b, 0))\n  return(Gt)\n}\n\n\n\\(\\psi(\\lambda_0,\\lambda_L, b, c)\\): \\(\\psi\\) parameter for log-rank\n\n\npsi_fun &lt;- function(lambda0, lambdaL, b, c){\n        lambda &lt;- lambda0 + lambdaL\n   psi &lt;- lambda0 / lambda * \n     (1 - exp(- lambda * c) * (1 - exp(- lambda * b)) / (lambda * b))\n   return(psi)\n}"
  },
  {
    "objectID": "chap6.html#programming-the-functions-ii",
    "href": "chap6.html#programming-the-functions-ii",
    "title": "Applied Survival Analysis",
    "section": "Programming the Functions (II)",
    "text": "Programming the Functions (II)\n\n\\(\\zeta(\\tau; \\lambda_0, \\lambda_L, b, c)\\): \\(\\zeta(\\tau)\\) for RMST\n\n\n# ------ integrand function --------------------------------\nzeta_integrand &lt;- function(t, tau, lambda0,lambdaL, b, c){\n  integrand &lt;- (exp(- lambda0 * t) - exp( - lambda0 * tau))^2*\n      exp(lambda0 * t)/(Gfun(t, lambdaL, b, c) * lambda0)\n  return(integrand)\n}\n\n# ------ numerical integration by integrate() --------------\nzeta_fun &lt;- function(tau, lambda0, lambdaL, b, c){\n  f &lt;- function(t){\n   return(zeta_integrand(t, tau, lambda0, lambdaL, b, c))\n  }\n  zeta &lt;- integrate(f, lower = 0, upper = tau)\n  return(zeta$value)\n}"
  },
  {
    "objectID": "chap6.html#how-to-specify-parameters",
    "href": "chap6.html#how-to-specify-parameters",
    "title": "Applied Survival Analysis",
    "section": "How to Specify Parameters",
    "text": "How to Specify Parameters\n\n\nSpecification of \\((\\lambda_0, \\lambda_L, b, c)\\)\n\n\\(\\lambda_0\\) (and \\(\\lambda_L\\)): use domain knowledge or estimate from historical data\n\\(\\hat\\lambda_0\\): (crude) event rate (see Chapters 1 & 2) \\[\n\\hat\\lambda_0 = \\frac{\\mbox{Number of events}}{\\mbox{Total person-time}}\n\\]\n\\(b, c\\): determined by current study design\n\n\n\n\n\nSpecification of \\(\\theta\\)\n\nSupplied by investigator based on domain knowledge (MID)"
  },
  {
    "objectID": "chap6.html#example-gbc-as-pilot-study-i",
    "href": "chap6.html#example-gbc-as-pilot-study-i",
    "title": "Applied Survival Analysis",
    "section": "Example: GBC as Pilot Study (I)",
    "text": "Example: GBC as Pilot Study (I)\n\n\nDesign objective\n\nA randomized controlled trial to evaluate hormonal treatment on relapse-free survival of post-menopausal breast cancer patients\n\\(b=2\\) years of accrual; \\(c=3.5\\) years subsequent follow-up\n\n\n\n\n\nGBC pilot data\n\n\\(\\hat\\lambda_0=0.174\\) per person-year based on \\(n=209\\)\n\nOther parameters\n\nSet \\(\\lambda_L=0.01\\) per person-year\n\\(\\lambda_1\\): (constant) hazard rate in treatment, taking a range of values\nHR: \\(\\lambda_1/\\lambda_0\\); difference in RMST (Exercise)"
  },
  {
    "objectID": "chap6.html#example-gbc-as-pilot-study-ii",
    "href": "chap6.html#example-gbc-as-pilot-study-ii",
    "title": "Applied Survival Analysis",
    "section": "Example: GBC as Pilot Study (II)",
    "text": "Example: GBC as Pilot Study (II)\n\n\nSample sizes for Cox (log-rank), 3y-RMST, 5y-RMST"
  },
  {
    "objectID": "chap6.html#notes-i",
    "href": "chap6.html#notes-i",
    "title": "Applied Survival Analysis",
    "section": "Notes (I)",
    "text": "Notes (I)\n\nSAS code for log-rank\n\n\nPROC POWER;\n   TWOSAMPLESURVIVAL TEST=LOGRANK\n      HAZARDRATIO = 0.7, 0.75, 0.8, 0.85, 0.9\n      REFSURVEXPHAZARD = 0.174 \n      ACCRUALTIME = 2\n      FOLLOWUPTIME = 3.5\n      GROUPLOSSEXPHAZARDS = (0.01, 0.01)\n      NTOTAL = .\n      POWER = 0.8, 0.9;\nRUN;\n\n\nSample size formula for log-rank (Schoenfeld, 1981)\n\nFreedman (1982): more accurate when \\(\\theta\\) is large\nSchoenfeld (1983): covariate adjusted test (Schoenfeld, 1983)"
  },
  {
    "objectID": "chap6.html#notes-ii",
    "href": "chap6.html#notes-ii",
    "title": "Applied Survival Analysis",
    "section": "Notes (II)",
    "text": "Notes (II)\n\nR-package npsurvSS (Yung and Liu, 2020)\n\nVarious tests (e.g., weighted log-rank, RMST, survival probability tests)\nNon-exponential event/ LTFU, non-uniform accrual\n\n\n\n# Set up the two groups\ncontrol &lt;- create_arm(\n              # Parameter set-up for control\n                      )\ntreatment &lt;- create_arm(\n              # Parameter set-up for treatment\n                      )\n# Compute sample size\nsize_two_arm(control, treatment, \n      test = list(list(test=\"weighted logrank\"), # Log-rank test\n                  list(test=\"rmst difference\", milestone=3), # 3y-RMST \n                  list(test=\"rmst difference\", milestone=5)) # 5y-RMST \n              )"
  },
  {
    "objectID": "chap6.html#summary",
    "href": "chap6.html#summary",
    "title": "Applied Survival Analysis",
    "section": "Summary",
    "text": "Summary\n\nSample size calculations\n\nCox (log-rank) \\[\\begin{equation}\nn= \\frac{(z_{1-\\alpha/2}+z_{\\gamma})^2}{q(1-q)\\psi\\theta^2}\n\\end{equation}\\]\n\\(\\tau\\)-RMST \\[\\begin{equation}\nn= \\frac{\\zeta(\\tau)(z_{1-\\alpha/2}+z_{\\gamma})^2}{q(1-q)\\theta(\\tau)^2}\n\\end{equation}\\]\n\\(\\psi\\) or \\(\\zeta(\\tau)\\) calculated under simplifying assumptions\n\nExponential failure and LTFU\nUniform accrual"
  },
  {
    "objectID": "chapter6.html#r-code",
    "href": "chapter6.html#r-code",
    "title": "Chapter 6 - Sample Size Determination and Study Design",
    "section": "R code",
    "text": "R code\n\n\nShow the code\n###############################################################################\n# Chapter 6 R Code\n#\n# This script reproduces all major numerical results in Chapter 6, including:\n#   1. Functions for sample size calculations (psi_fun, zeta_fun)\n#   2. Numerical examples from Section 6.2.2\n#   3. Sample size computations for the GBC pilot data\n###############################################################################\n\n\n#==============================================================================\n# (A) Functions Needed for Sample Size Calculation\n#==============================================================================\n\n#------------------------------------------------------------------------------\n# 1. psi_fun(lambda0, lambdaL, b, c)\n#    Computes the event proportion psi for Cox model sample size\n#\n#    Inputs:\n#       lambda0 = hazard rate for T\n#       lambdaL = hazard rate for LTFU\n#       b       = length of accrual (years)\n#       c       = additional length of follow-up (years)\n#------------------------------------------------------------------------------\npsi_fun &lt;- function(lambda0, lambdaL, b, c) {\n  lambda &lt;- lambda0 + lambdaL\n  psi &lt;- lambda0 / lambda * (\n    1 - exp(-lambda * c) * (1 - exp(-lambda * b)) / (lambda * b)\n  )\n  return(psi)\n}\n\n\n#------------------------------------------------------------------------------\n# 2. zeta_fun(tau, lambda0, lambdaL, b, c)\n#    Computes the variance component for RMST sample size via numerical integral\n#\n#    Inputs:\n#       tau     = restricting time\n#       lambda0 = hazard rate for T\n#       lambdaL = hazard rate for LTFU\n#       b       = length of accrual (years)\n#       c       = additional follow-up (years)\n#------------------------------------------------------------------------------\n\n# Survival function for censoring\nGfun &lt;- function(t, lambdaL, b, c) {\n  Gt &lt;- ifelse(\n    t &lt;= c,\n    exp(-lambdaL * t),\n    ifelse(\n      t &lt; (c + b),\n      exp(-lambdaL * t) * (b + c - t) / b,\n      0\n    )\n  )\n  return(Gt)\n}\n\n# The integrand for zeta\nzeta_integrand &lt;- function(t, tau, lambda0, lambdaL, b, c) {\n  integrand &lt;- (exp(-lambda0 * t) - exp(-lambda0 * tau))^2 *\n    exp(lambda0 * t) / (Gfun(t, lambdaL, b, c) * lambda0)\n  return(integrand)\n}\n\n# Main function using integrate()\nzeta_fun &lt;- function(tau, lambda0, lambdaL, b, c) {\n  f &lt;- function(t) {\n    zeta_integrand(t, tau, lambda0, lambdaL, b, c)\n  }\n  zeta &lt;- integrate(f, lower = 0, upper = tau)\n  return(zeta$value)\n}\n\n\n#==============================================================================\n# (B) Numerical Results in Section 6.2.2\n#==============================================================================\n\n# Evaluate zeta_fun at specific values\nzeta_fun(tau = 5, lambda0 = 0.2, lambdaL = 0.01, b = 2, c = 4)\n\n\n#==============================================================================\n# (C) Sample Size Calculation Example with GBC Data\n#==============================================================================\nlibrary(survival)\n\n#------------------------------------------------------------------------------\n# 1. Read GBC Data\n#------------------------------------------------------------------------------\ngbc &lt;- read.table(\"Data//German Breast Cancer Study//gbc.txt\")\n\n# Sort the data by time within each id\no   &lt;- order(gbc$id, gbc$time)\ngbc &lt;- gbc[o, ]\n\n# Keep the first row for each id\ndf &lt;- gbc[!duplicated(gbc$id), ]\n\n# Set status = 1 if status == 1 or 2\ndf$status &lt;- (df$status &gt; 0) + 0\n\n# Subset: post-menopausal (meno==2) & no hormonal treatment (hormone==1)\npilot &lt;- df[df$meno == 2 & df$hormone == 1, ]\nn &lt;- nrow(pilot)  # n = 209, matches Table 1.12 (Chapter 1)\n\n#------------------------------------------------------------------------------\n# 2. Estimate Baseline Hazard and Setup\n#------------------------------------------------------------------------------\npilot$time &lt;- pilot$time / 12  # convert months to years\nlambda0 &lt;- sum(pilot$status &gt; 0) / sum(pilot$time)  # ~0.174\n\n# Accrual (b = 2 years), follow-up (c = 3.5 years)\nlambdaL &lt;- 0.01  # LTFU rate\nb &lt;- 2\nc &lt;- 3.5\n\n# Compute psi and zeta at tau = 3, 5\npsi &lt;- psi_fun(lambda0, lambdaL, b, c)\nzeta3 &lt;- zeta_fun(tau = 3, lambda0, lambdaL, b, c)\nzeta5 &lt;- zeta_fun(tau = 5, lambda0, lambdaL, b, c)\n\n#------------------------------------------------------------------------------\n# 3. Sample Size Computations for Various Hazard Ratios\n#------------------------------------------------------------------------------\nHR &lt;- seq(0.6, 0.9, by = 0.01)  # hazard ratio range\nlambda1 &lt;- lambda0 * HR\n\n# Function for difference in RMST (exponential assumption)\nRMST_diff &lt;- function(tau, lam0, lam1) {\n  val &lt;- (1 - exp(-lam1 * tau)) / lam1 - (1 - exp(-lam0 * tau)) / lam0\n  return(val)\n}\n\n# For tau = 3 and tau = 5\ntheta3 &lt;- RMST_diff(3, lambda0, lambda1)\ntheta5 &lt;- RMST_diff(5, lambda0, lambda1)\n\n# Setup for alpha = 0.05 (two-sided), power = 0.8 or 0.9\nq &lt;- 0.5\nza &lt;- qnorm(0.975)\ngamma_list &lt;- c(0.80, 0.90)\n\npar(mfrow = c(1, 2))\nfor (i in seq_along(gamma_list)) {\n  gamma &lt;- gamma_list[i]\n  zg &lt;- qnorm(gamma)\n  \n  # Sample sizes for log-rank, 3-RMST, and 5-RMST\n  ncox    &lt;- (za + zg)^2 / (q * (1 - q) * psi * (log(HR))^2)\n  nRMST3  &lt;- zeta3 * (za + zg)^2 / (q * (1 - q) * theta3^2)\n  nRMST5  &lt;- zeta5 * (za + zg)^2 / (q * (1 - q) * theta5^2)\n  \n  plot(\n    HR, ncox,\n    type = \"l\",\n    lwd  = 2,\n    ylim = c(0, 7000),\n    xlab = \"Hazard ratio\",\n    ylab = \"Sample size\",\n    main = paste0(\"Power = \", gamma),\n    cex.lab  = 1.2,\n    cex.axis = 1.2\n  )\n  lines(HR, nRMST5, lty = 2, lwd = 2)\n  lines(HR, nRMST3, lty = 3, lwd = 2)\n  legend(\n    \"topleft\",\n    lty = 1:3,\n    c(\"Log-rank\", \"5-RMST\", \"3-RMST\"),\n    lwd = 2,\n    cex = 1.2\n  )\n}\n\n\n#==============================================================================\n# (D) Demonstration with npsurvSS Package (Yung and Liu, 2020)\n#==============================================================================\nlibrary(npsurvSS)\n\n#------------------------------------------------------------------------------\n# 1. Configure Two Arms (Control vs. Treatment)\n#------------------------------------------------------------------------------\nlambda0 &lt;- 0.173  # baseline event hazard\nlambdaL &lt;- 0.01   # hazard rate for LTFU\n\ncontrol &lt;- create_arm(\n  size       = 500,\n  accr_time  = 2,\n  follow_time= 3.5,\n  surv_scale = lambda0,\n  surv_shape = 1,   # default\n  loss_scale = lambdaL,\n  loss_shape = 1\n)\n\nlambda1 &lt;- lambda0 * 0.8\n\ntreatment &lt;- create_arm(\n  size       = 500,\n  accr_time  = 2,\n  follow_time= 3.5,\n  surv_scale = lambda1,\n  loss_scale = lambdaL\n)\n\n#------------------------------------------------------------------------------\n# 2. Compare Required Sample Sizes for Several Tests\n#------------------------------------------------------------------------------\nsize_two_arm(\n  control,\n  treatment,\n  test = list(\n    list(test = \"weighted logrank\"),               # Log-rank test\n    list(test = \"rmst difference\", milestone = 3), # RMST at 3 years\n    list(test = \"rmst difference\", milestone = 5)  # RMST at 5 years\n  )\n)\n\n# Alternatively, power calculations could be done via power_two_arm()\n# power_two_arm(control, treatment)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 6 - Sample Size Determination and Study Design"
    ]
  },
  {
    "objectID": "chapter6.html#chapter-summary",
    "href": "chapter6.html#chapter-summary",
    "title": "Chapter 6 - Sample Size Determination and Study Design",
    "section": "Chapter Summary",
    "text": "Chapter Summary\nDetermining an appropriate sample size is a crucial step in designing a time-to-event study. Inadequate sample size can lead to insufficient power, while an overpowered study may waste resources. As two most important methods in survival analysis, the log-rank test (or equivalently, a Cox model with a binary predictor) and restricted mean survival time (RMST) analysis need special attanetion. In their sample size calculations, study design choices—such as accrual patterns, length of follow-up, and loss to follow-up assumptions—play an important role.\n\nGeneral approach to sample size calculation\nA common starting point is to consider a test statistic \\(S_n=\\sqrt n T_n /\\hat\\sigma_n\\) that is approximately standard normal under the null hypothesis. Define a minimal clinically important effect size \\(\\theta\\) (e.g., a targeted log-hazard ratio or a difference in RMST) and specify the desired power \\(\\gamma\\). The general form for the required sample size, under asymptotic normality, often reduces to\n\\[\nn\n\\;=\\;\n\\frac{\\sigma_0^2\\,\\bigl(z_{1-\\alpha/2} \\,+\\, z_\\gamma\\bigr)^2}{f(\\theta)^2},\n\\]\nwhere \\(f(\\theta) = E(T_n)\\) is the “signal” contributed by the effect size, \\(\\sigma_0^2\\) is the variance term under the null, and \\(z_{p}\\) is the \\(p\\)-quantile of the standard normal distribution. Intuitively, stronger signals \\(\\bigl|f(\\theta)\\bigr|\\) reduce the required \\(n\\), while higher variance \\(\\sigma_0^2\\) or more stringent significance/power criteria increase \\(n\\).\n\n\nSchoenfeld’s formula for the Cox (log-rank) test\nUnder a proportional hazards model with a binary treatment: \\[\n\\lambda(t \\mid Z=1)\n\\;=\\;\n\\lambda_0(t)\\,\\exp(\\theta),\n\\] the log-rank test statistic has a well-known large-sample result leading to Schoenfeld’s formula:\n\\[\\begin{equation}\\label{eq:cox:sample_size}\nn\n\\;=\\;\n\\frac{\\bigl(z_{1-\\alpha/2} + z_\\gamma\\bigr)^2}{q(1-q)\\,\\psi\\,\\theta^2}, \\tag{1}\n\\end{equation}\\]\nwhere:\n\n\\(q\\) is the proportion allocated to treatment,\n\\(\\theta\\) is the log-hazard ratio (\\(\\theta=0\\) under the null),\n\\(\\psi\\) is the expected proportion of events (failures).\n\nAlternatively, we can express \\(n\\psi\\), the total number of events, as the right-hand side of \\(\\eqref{eq:cox:sample_size}\\) without \\(\\psi\\) in the denominator. You often hear this referred to as an “event-driven” calculation—knowing the total number of events required can be more important than total enrollment.\n\n\nSample size for RMST\nThe restricted mean survival time (RMST) over \\([0, \\tau]\\) captures the average time lived up to \\(\\tau\\). For a two-sample comparison, the difference \\(\\theta(\\tau) = \\mu_1(\\tau) - \\mu_0(\\tau)\\) can be tested, by its estimator \\(\\hat\\theta(\\tau)\\). The corresponding sample size formula is:\n\\[\\begin{equation}\\label{eq:rmst:sample_size}\nn\n\\;=\\;\n\\frac{\\zeta(\\tau)\\,\\bigl(z_{1-\\alpha/2} + z_\\gamma\\bigr)^2}{\n  q(1-q)\\,\\theta(\\tau)^2}, \\tag{2}\n\\end{equation}\\]\nwhere \\(\\zeta(\\tau)\\) is a variance-related term (depending on survival and censoring distributions). While slightly less efficient under strict proportional hazards, RMST-based tests offer a direct interpretation of how many additional months or years are gained under one treatment arm compared to another.\n\n\nStudy design and its impact\nStudy design considerations—uniform accrual over \\(b\\) years, additional follow-up \\(c\\) years after accrual closes, and potential exponential loss to follow-up—shape the computations of \\(\\psi\\) (for log-rank) and \\(\\zeta(\\tau)\\) (for RMST) through the censoring distribution.\n\n\n\n\n\nUnder this set-up:\n\nAdministrative censoring: Uniform\\([c, b + c]\\)\nLoss to follow-up: Assume exponential dropout with rate \\(\\lambda_L\\).\n\nThese assumptions feed into analytic or numerical formulas to calculate:\n\nCensoring survival function \\[\\begin{equation}\\label{eq:design:censoring}\n    G(t;\\lambda_L, b, c):=\\mathrm{pr}(C&gt;t)=\\left\\{\\begin{array}{ll} \\exp(-\\lambda_L t)& 0\\leq t\\leq c\\\\\n    b^{-1}(c+b-t)\\exp(-\\lambda_L t) & c&lt;t&lt;c+b \\\\\n    0& t\\geq c+b.\n    \\end{array}\\right.\n    \\end{equation}\\]\n\\(\\psi\\) for log-rank (closed-form) \\[\\begin{equation}\\label{eq:cox:psi}\n        \\psi=\\frac{\\lambda_0}{\\lambda_0+\\lambda_L}\\left[1-\\exp\\{-(\\lambda_0+\\lambda_L)c\\}\n        \\frac{1-\\exp\\{-(\\lambda_0+\\lambda_L)b\\}}{(\\lambda_0+\\lambda_L)b}\\right]\n        \\end{equation}\\]\n\\(\\zeta(\\tau)\\) for RMST (needs numerical integration) \\[\\begin{equation}\\label{eq:design:rmst_zeta}\n        \\zeta(\\tau)=\\lambda_0^{-1}\\int_0^\\tau\\{\\exp(-\\lambda_0 t)-\\exp(-\\lambda_0 \\tau)\\}^2\\exp(\\lambda_0 t)G(t;\\lambda_L, b, c)^{-1}\\mathrm{d} t\n        \\end{equation}\\]\nPlug \\(\\psi\\) or \\(\\zeta(\\tau)\\) back into sample size formulas \\(\\eqref{eq:cox:sample_size}\\) or \\(\\eqref{eq:rmst:sample_size}\\), respectively.\n\n\n\nA general implementation\nThe R package npsurvSS offers more general routines for sample size/power calculations under log-rank and RMST approaches. Suppose we hypothesize an exponential event rate \\(\\lambda_0\\) in the control group and a hazard ratio \\(\\mathrm{HR} = \\exp(\\theta)\\) in the treatment group:\n\n# Install if needed\n# install.packages(\"npsurvSS\")\n\nlibrary(npsurvSS)\n\n# 1. Define arms (control vs. treatment) for a two-arm study\ncontrol &lt;- create_arm(size = 500,\n                      accr_time = 2,     # uniform accrual over 2 years\n                      follow_time = 3.5, # then followed 3.5 years\n                      surv_scale = 0.174,  # baseline hazard for event\n                      loss_scale = 0.01)   # hazard of loss to follow-up\n\ntreatment &lt;- create_arm(size = 500,\n                        accr_time = 2,\n                        follow_time = 3.5,\n                        surv_scale = 0.174 * 0.8, # hazard ratio = 0.8\n                        loss_scale = 0.01)\n\n# 2. Compute required sample size for different tests\nres_size &lt;- size_two_arm(\n  control, \n  treatment,\n  test = list(\n    list(test = \"weighted logrank\"),               # log-rank \n    list(test = \"rmst difference\", milestone = 3), # RMST at 3 years\n    list(test = \"rmst difference\", milestone = 5)  # RMST at 5 years\n  )\n)\n\nprint(res_size)\n\nYou can customize the accrual pattern (piecewise uniform or otherwise), use Weibull rather than exponential survival times, or request sample size for alternative tests (e.g., Gehan–Wilcoxon, RMST ratio, survival probability difference).\n\n\nConclusion\nPlanning a time-to-event study involves balancing the feasibility of enrolling and following patients against the power to detect a meaningful effect. Schoenfeld’s formula under the proportional hazards framework yields intuitive “event-driven” calculations, while RMST-based approaches similarly ensure adequate power for differences in average time lived within a specified window. Because design factors—accrual, follow-up length, and dropout processes—directly enter these formulas, it is vital to specify reasonable assumptions and possibly refine them via pilot data.",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 6 - Sample Size Determination and Study Design"
    ]
  },
  {
    "objectID": "chap7.html#outline",
    "href": "chap7.html#outline",
    "title": "Applied Survival Analysis",
    "section": "Outline",
    "text": "Outline\n\n\nLeft truncation mechanisms\nStandard and general methods for left truncation\nNon- and Semi-parametric methods for Interval censoring\nBangkok Metropolitan Administration HIV Study\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\]"
  },
  {
    "objectID": "chap7.html#truncation---biased-sampling",
    "href": "chap7.html#truncation---biased-sampling",
    "title": "Applied Survival Analysis",
    "section": "Truncation - Biased Sampling",
    "text": "Truncation - Biased Sampling\n\n\nLeft truncation\n\nOnly subjects who fail in \\([T_L, \\infty)\\) can be observed\n\n\\(T_L\\): left truncation time\nThose who fail in \\([0, T_L)\\) are excluded (truncated)\nBiased sampling \\((T\\geq T_L)\\)\n\n\n\n\n\n\nMechanism: delayed entry\n\nSubject entering study after starting point"
  },
  {
    "objectID": "chap7.html#examples-of-delayed-entry",
    "href": "chap7.html#examples-of-delayed-entry",
    "title": "Applied Survival Analysis",
    "section": "Examples of Delayed Entry",
    "text": "Examples of Delayed Entry\n\n\nStarting point: before enrollment\n\nBirth: age at death\n\nDead before enrollment excluded\n\nDiagnosis of cancer: time from diagnosis to death\n\nDead before enrollment excluded\n\nBlood transfusion: time from tranfusion to AIDS\n\nPositive before enrollment excluded"
  },
  {
    "objectID": "chap7.html#truncation-vs-censoring",
    "href": "chap7.html#truncation-vs-censoring",
    "title": "Applied Survival Analysis",
    "section": "Truncation vs Censoring",
    "text": "Truncation vs Censoring\n\n\nDifference\n\nTruncation : Biased sampling\nCensoring: Partial missing data\n\n\n\n\n\nLeft truncation \\(+\\) right censoring"
  },
  {
    "objectID": "chap7.html#data-and-assumption",
    "href": "chap7.html#data-and-assumption",
    "title": "Applied Survival Analysis",
    "section": "Data and Assumption",
    "text": "Data and Assumption\n\n\nTarget of inference: still \\(T\\)\n\n\n\n\nObserved data \\[\n(T_{Li}, X_i, \\delta_i) \\,\\,\\, (i=1,\\ldots, n)\n\\]\n\n\\(T_{Li}\\): left truncation (delayed entry) time for subject \\(i\\)\n\n\n\n\n\nIndependent truncation \\[T_L\\indep T\\]\n\nIn case with covariates \\((T_L\\indep T)\\mid Z\\)"
  },
  {
    "objectID": "chap7.html#standard-methods",
    "href": "chap7.html#standard-methods",
    "title": "Applied Survival Analysis",
    "section": "Standard Methods",
    "text": "Standard Methods\n\n\nMethods by at-risk conditioning\n\nKaplan–Meier estimate\nLog-rank test\nCox model\n\n\n\n\n\nEasy fix: adjust at-risk status\n\nSubject not at risk before entry\nAt risk (on study): \\([T_{Li},\\; X_i]\\)"
  },
  {
    "objectID": "chap7.html#standard-methods-nonparametric-i",
    "href": "chap7.html#standard-methods-nonparametric-i",
    "title": "Applied Survival Analysis",
    "section": "Standard Methods: Nonparametric (I)",
    "text": "Standard Methods: Nonparametric (I)\n\n\nNelsen-Aalen estimator: \\(\\dd\\hat\\Lambda(t_j)=d_j/n_j\\) \n\nWithout late entry: \\(n_j=\\sum_{i=1}^nI(X_i\\geq t_j)\\)\nWith late entry: \\(n_j=\\sum_{i=1}^nI(T_{Li}\\leq t_j\\leq X_i)\\)\n\n\n\n\n\nKaplan-Meier estimator \\[\n\\hat S(t)=\\prod_{j: t_j\\leq t}\\left(1 - d_j/n_j\\right)\n\\]"
  },
  {
    "objectID": "chap7.html#standard-methods-nonparametric-ii",
    "href": "chap7.html#standard-methods-nonparametric-ii",
    "title": "Applied Survival Analysis",
    "section": "Standard Methods: Nonparametric (II)",
    "text": "Standard Methods: Nonparametric (II)\n\n\nIdentifiability\n\nSuppose earliest entry time \\(t_0=\\min(T_{Li})&gt;0\\)\nNo data in \\([0, t_0]\\)\n\n\n\n\n\nConditional survival function \\[\\begin{align}\n\\hat S(t)&\\to \\pr(T&gt;t_1\\mid T&gt;t_0)\\pr(T&gt;t_2\\mid T&gt;t_1)\\cdots\\pr(T&gt;t\\mid T&gt;t_j)\\\\\n& = \\pr(T&gt;t \\mid T&gt;t_0)\n\\end{align}\\]\n\nNot the marginal \\(\\pr(T&gt;t)\\)\nSolution: choose a late \\(t_0^*&gt; t_0\\) (s.t. \\(n_j\\gg 1\\) for all \\(t_j\\geq t_0^*\\)) and consider \\[\\begin{equation}\n\\hat\\pr(T&gt;t\\mid T \\geq t_0^*)=\\prod_{j:t_0^*\\leq t_j\\leq t}(1-d_j/n_j),\n\\end{equation}\\]"
  },
  {
    "objectID": "chap7.html#standard-methods---cox-model-i",
    "href": "chap7.html#standard-methods---cox-model-i",
    "title": "Applied Survival Analysis",
    "section": "Standard Methods - Cox Model (I)",
    "text": "Standard Methods - Cox Model (I)\n\n\nPartial likelihood construction \n\nWithout late entry: \\(\\mathcal R_j=\\{i: X_i\\geq t_j\\}\\)\nWith late entry: \\(\\mathcal R_j=\\{i: T_{Li}\\leq t_j\\leq X_i\\}\\)"
  },
  {
    "objectID": "chap7.html#standard-methods---cox-model-ii",
    "href": "chap7.html#standard-methods---cox-model-ii",
    "title": "Applied Survival Analysis",
    "section": "Standard Methods - Cox Model (II)",
    "text": "Standard Methods - Cox Model (II)\n\n\nRisk sets: example"
  },
  {
    "objectID": "chap7.html#standard-methods---cox-model-iii",
    "href": "chap7.html#standard-methods---cox-model-iii",
    "title": "Applied Survival Analysis",
    "section": "Standard Methods - Cox Model (III)",
    "text": "Standard Methods - Cox Model (III)\n\n\nPartial-likelihood score\n\nAdjust the at-risk process \\[\nU_n(\\beta)=\\Pn\\int_0^\\infty\\left\\{Z_i-\\frac{\\sum_{j=1}^n I(T_{Lj}\\leq t\\leq X_j)Z_j\\exp(\\beta^\\T Z_j)}\n{\\sum_{j=1}^n I(T_{Lj}\\leq t\\leq X_j)\\exp(\\beta^\\T Z_j)}\\right\\}\\dd N_i(t)\n\\]\n\n\n\n\n\nOther extensions\n\nLog-rank test: \\(U_n(0)\\) with binary \\(Z\\)\nMartingale residuals: \\[\n  \\dd M_i(t)=\\dd N_i(t)-I(T_{Li}\\leq t\\leq X_i)\\exp(\\beta^\\T Z_i)\\dd\\Lambda_0(t)\n  \\]\nTime-varying covariates"
  },
  {
    "objectID": "chap7.html#standard-methods---cox-model-iv",
    "href": "chap7.html#standard-methods---cox-model-iv",
    "title": "Applied Survival Analysis",
    "section": "Standard Methods - Cox Model (IV)",
    "text": "Standard Methods - Cox Model (IV)\n\n\nPrediction of survival rate\n\nIf all subjects enter late, choose late cutoff \\(t_0^*\\)\nConditional survival function \\[\\begin{equation}\n\\hat\\pr(T &gt; t\\mid T\\geq t_0^*, Z) =\n\\exp\\left[-\\left\\{\\hat\\Lambda_0(t)- \\hat\\Lambda_0(t_0^*)\\right\\}\\exp(\\hat\\beta^\\T Z)\\right]\n\\end{equation}\\]\n\n\n\n\n\n\n\n\n\n\nExercise\n\n\nShow that \\[\\pr(T &gt; t\\mid T\\geq t_0^*, Z) =\n\\exp\\left[-\\left\\{\\Lambda_0(t)- \\Lambda_0(t_0^*)\\right\\}\\exp(\\beta^\\T Z)\\right]  \\] for any \\(t&gt;t_0^*\\) under the Cox model."
  },
  {
    "objectID": "chap7.html#general-approach---likelihood",
    "href": "chap7.html#general-approach---likelihood",
    "title": "Applied Survival Analysis",
    "section": "General Approach - Likelihood",
    "text": "General Approach - Likelihood\n\n\nNon-hazard-based methods\n\nProportional odds model\nAccelerated failure time model\n\n\n\n\n\nRe-construct likelihood\n\nA model parametrized by \\(\\theta\\) \\[\\begin{equation}\\label{eq:trunc:lik}\nL_n(\\theta)=\\prod_{i=1}^n S(T_{Li};\\theta)^{-1}\\lambda(X_i;\\theta)^{\\delta_i}S(X_{i};\\theta)\n\\end{equation}\\]\n\nEvery subject sampled is conditioned upon \\(T_i\\geq T_{Li}\\), hence inverse weight \\(S(T_{Li};\\theta)\\)\n\nLog-likelihood: \\(l_n(\\theta)=\\sum_{i=1}^n\\left[\\delta_i\\log\\lambda(X_i;\\theta)-\\left\\{\\Lambda(X_i;\\theta)-\\Lambda(T_{Li};\\theta)\\right\\}\\right]\\)"
  },
  {
    "objectID": "chap7.html#maximum-likelihood-po-model",
    "href": "chap7.html#maximum-likelihood-po-model",
    "title": "Applied Survival Analysis",
    "section": "Maximum Likelihood: PO Model",
    "text": "Maximum Likelihood: PO Model\n\n\nExample: Proportional odds model\n\nModel specification with \\(\\theta = (\\beta, h_0)\\) \\[\\begin{equation}\\label{eq:non_haz:po}\n\\log\\left\\{\\frac{1-S(t\\mid Z)}{S(t\\mid Z)}\\right\\}=h_0(t)+\\beta^\\T Z,\n\\end{equation}\\]\nModel-based hazard functions \\[\\begin{align}    \n\\lambda(t\\mid Z;\\beta, h_0)&=\\frac{\\exp\\{h_0(t)+\\beta^\\T Z\\}h_0'(t)}{1+\\exp\\{h_0(t)+\\beta^\\T Z\\}}\\\\\n\\Lambda(t\\mid Z;\\beta, h_0)&=\\log\\left[1+\\exp\\{h_0(t)+\\beta^\\T Z\\}\\right]\n\\end{align}\\]\nNonparametric maximum likelihood (NPMLE)\n\nDiscretize \\(h_0(\\cdot)\\) at observed event times \\(t_1&lt;\\cdots&lt;t_m\\)\n\\(h_0'(t_j)=h_{0j}\\); \\(h_0(t)=\\sum_{j:t_j\\leq t}h_{0j}\\)"
  },
  {
    "objectID": "chap7.html#software-survivalsurv",
    "href": "chap7.html#software-survivalsurv",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::Surv()",
    "text": "Software: survival::Surv()\n\n\nBasic syntax for handling left truncation\n\n\n\n## Fit Kaplan-Meier curve to left-truncated data\nsurvfit(Surv(entry, end, status) ~ 1)\n## Fit Cox model to left-truncated data\ncoxph(Surv(entry, end, status) ~ covariates)\n\n\n\n\n\nInput\n\nentry: \\(T_{L}\\); end: \\(X\\); status: \\(\\delta\\)\n\nOutput: survfit or coxph object\nlog-rank test: score test under coxph()"
  },
  {
    "objectID": "chap7.html#example-channing-house-study-i",
    "href": "chap7.html#example-channing-house-study-i",
    "title": "Applied Survival Analysis",
    "section": "Example: Channing House Study (I)",
    "text": "Example: Channing House Study (I)\n\n\nStudy information\n\nPopulation: 462 elderly residents of Channing House, a retirement center\nEndpoint: Age at death (starting point: birth)\nAim: Compare mortality between males (gender=1) and females (gender=2)\nTruncation: Age of admission into the center (Entry.Age)\n\nSubject must survive long enough to enter cohort (link to follow-up plot)\n\n\n\n\n\n\nhead(channing)\n#   Entry.Age  End.Age status gender\n# 1  86.83333 97.66667      1      2\n# 2  76.75000 86.66667      1      2\n# 3  73.75000 83.58333      1      2\n# ..."
  },
  {
    "objectID": "chap7.html#example-channing-house-study-ii",
    "href": "chap7.html#example-channing-house-study-ii",
    "title": "Applied Survival Analysis",
    "section": "Example: Channing House Study (II)",
    "text": "Example: Channing House Study (II)\n\n\nCox model\n\nfemales at 72.9% risk as males for mortality (\\(p\\)-value 0.07)\n\n\n\nobj &lt;- coxph(Surv(Entry.Age, End.Age, status) ~ factor(gender), \n             data = channing)\nsummary(obj)\n#                    coef exp(coef) se(coef)      z Pr(&gt;|z|)  \n# factor(gender)2 -0.3163    0.7289   0.1731 -1.827   0.0677 .\n# ---\n# \n#                 exp(coef) exp(-coef) lower .95 upper .95\n# factor(gender)2    0.7289      1.372    0.5191     1.023\n# \n# Concordance= 0.528  (se = 0.018)\n# Likelihood ratio test= 3.17  on 1 df,   p=0.07\n# Wald test            = 3.34  on 1 df,   p=0.07\n# Score (logrank) test = 3.36  on 1 df,   p=0.07"
  },
  {
    "objectID": "chap7.html#example-channing-house-study-iii",
    "href": "chap7.html#example-channing-house-study-iii",
    "title": "Applied Survival Analysis",
    "section": "Example: Channing House Study (III)",
    "text": "Example: Channing House Study (III)\n\n\nChecking proportionality\n\n\n# Schoenfeld residuals\nobj_zph &lt;- cox.zph(obj)\n# test result\nobj_zph\n# plot the rescaled residuals\nplot(obj_zph, ylab = \"Gender\", xlab = \"Age (years)\", lwd = 2)"
  },
  {
    "objectID": "chap7.html#example-channing-house-study-iv",
    "href": "chap7.html#example-channing-house-study-iv",
    "title": "Applied Survival Analysis",
    "section": "Example: Channing House Study (IV)",
    "text": "Example: Channing House Study (IV)\n\n\nPrediction (at age 70)"
  },
  {
    "objectID": "chap7.html#observation-setting",
    "href": "chap7.html#observation-setting",
    "title": "Applied Survival Analysis",
    "section": "Observation Setting",
    "text": "Observation Setting\n\n\nInterval censoring\n\nPeriodic check-ups for an asymptomatic event\nEvent is only known to have occurred in between two consecutive check-ups\n\n\n\n\n\nExamples\n\nTumor (occult) formation\nHIV seroconversion (viral antibodies become detectable in serum)\n\n\n\n\n\nChallenge\n\nNo exact failure time is observed"
  },
  {
    "objectID": "chap7.html#data-and-assumption-1",
    "href": "chap7.html#data-and-assumption-1",
    "title": "Applied Survival Analysis",
    "section": "Data and Assumption",
    "text": "Data and Assumption\n\n\nTarget of inference: still \\(T\\)\n\n\n\n\nCheck-up times: \\(U=(U_1&lt;U_2&lt;\\cdots&lt;U_K)\\)\n\n\\(K\\equiv 1\\): case-1 (current status data)\n\\(K\\equiv 2\\): case-2\n\\(\\vdots\\)\n\\(K\\) random (subject-specific): mixed-case\n\nIndependent check-up \\[\nU\\indep T\n\\]\n\nWith covariates: \\((U\\indep T)\\mid Z\\)"
  },
  {
    "objectID": "chap7.html#observed-data",
    "href": "chap7.html#observed-data",
    "title": "Applied Survival Analysis",
    "section": "Observed Data",
    "text": "Observed Data\n\n\nCensoring interval\n\n\\((L, R]\\): the check-up interval containing the event \nOther check-up times may be available but not relevant\nExample: current status data\n\n“Positive” at \\(U_1\\): \\((L, R]=(0, U_1]\\)\n“Negative” at \\(U_1\\): \\((L, R]=(U_1, \\infty)\\)\n\n\n\n\n\n\nObserved sample \\[\n(L_i, R_i)\\,\\,\\,(i=1,\\ldots, n)\n\\]"
  },
  {
    "objectID": "chap7.html#likelihood-based-inference",
    "href": "chap7.html#likelihood-based-inference",
    "title": "Applied Survival Analysis",
    "section": "Likelihood-Based Inference",
    "text": "Likelihood-Based Inference\n\n\nLikelihood function \\[\\begin{equation}\\label{eq:trunc:nonp}\nL_n(\\theta)=\\prod_{i=1}^n\\{S(L_i;\\theta)-S(R_i;\\theta)\\}\n\\end{equation}\\]\n\nLog-likelihood \\[\\begin{equation}\\label{eq:trunc:ic_log_lik}\nl_n(\\theta)=\\sum_{i=1}^n\\log\\{S(L_i;\\theta)-S(R_i;\\theta)\\}\n\\end{equation}\\]\n\n\n\n\n\nParametric Models\n\nStandard MLE \\(\\hat\\theta=\\arg\\max_\\theta l_n(\\theta)\\)"
  },
  {
    "objectID": "chap7.html#one-sample-estimation",
    "href": "chap7.html#one-sample-estimation",
    "title": "Applied Survival Analysis",
    "section": "One-Sample Estimation",
    "text": "One-Sample Estimation\n\n\nNonparametric maximum likelihood\n\n\\(F(t)=1-S(t)\\): treat as a step function\nLog-likelihood \\[\nl_n(F)=\\sum_{i=1}^n\\log\\{F(R_i)-F(L_i)\\}\n\\]\n\\(F(\\cdot)\\): step function jumping at unique (finite) values of the \\(R_i\\): \\[\nt_1&lt;t_2&lt;\\cdots&lt;t_m\n\\]\n\\(l_n(F)\\) becomes a function of \\[\n0\\leq F(t_1)\\leq F(t_2)\\leq\\cdots \\leq F(t_m)\\leq 1\n\\]"
  },
  {
    "objectID": "chap7.html#one-sample-constrained-maximization",
    "href": "chap7.html#one-sample-constrained-maximization",
    "title": "Applied Survival Analysis",
    "section": "One-Sample: Constrained Maximization",
    "text": "One-Sample: Constrained Maximization\n\n\nMonotonicity-constrained maximization \\[\\begin{equation}\\label{eq:trunc:iso}\n\\hat F=\\arg\\max_{F\\in\\mathcal A}l_n(F).\n\\end{equation}\\]\n\n\\(\\mathcal A=\\{F: 0\\leq F(t_1)\\leq F(t_2)\\leq\\cdots \\leq F(t_m)\\leq 1\\}\\): a convex set\nSolvable by linear programming\nIterative convex minorant (ICM): a monotonicity-contrained version of Newton-Raphson\n\\(\\hat F(t) - F(t)= O_P(n^{-1/3})\\), not asymptotically normal"
  },
  {
    "objectID": "chap7.html#semiparametric-models",
    "href": "chap7.html#semiparametric-models",
    "title": "Applied Survival Analysis",
    "section": "Semiparametric Models",
    "text": "Semiparametric Models\n\n\nGeneral approach \\(\\theta=(\\beta, \\eta)\\)\n\n\\(\\beta\\): regression parameter\n\\(\\eta(\\cdot)\\): nonparametric (monotone) baseline function (cumulative hazards/odds)\n\\((\\hat\\beta, \\hat\\eta)=\\arg\\max_{\\beta,\\eta}l_n(\\beta, \\eta)\\): maximize iteratively between \\(\\beta\\) and \\(\\eta(\\cdot)\\)\n\n\n\n\n\nExample: Cox proportional hazards (PH) model\n\nLog-likelihood \\[\nl_n(\\beta,\\Lambda_0)=\\sum_{i=1}^n\\log\\left[\\exp\\{-\\exp(\\beta^\\T Z_i)\\Lambda_0(L_i)\\}-\\exp\\{-\\exp(\\beta^\\T Z_i)\\Lambda_0(R_i)\\}\\right]\n\\]"
  },
  {
    "objectID": "chap7.html#example-cox-ph-model",
    "href": "chap7.html#example-cox-ph-model",
    "title": "Applied Survival Analysis",
    "section": "Example: Cox PH Model",
    "text": "Example: Cox PH Model\n\n\nIterative maximization\n\n\\(\\beta\\)-step (Newton-Raphson) \\[\n  \\beta^{(j+1)}=\\arg\\max_\\beta l_n(\\beta,\\Lambda_0^{(j)})\n  \\]\n\\(\\Lambda_0\\)-step (ICM) \\[\n\\Lambda_0^{(j+1)}=\\arg\\max_\\Lambda l_n(\\beta^{(j+1)},\\Lambda)\n\\]\n\n\n\n\n\nInference\n\n\\(\\hat\\Lambda_0(t)-\\Lambda_0(t)=O_P(n^{-1/3})\\): non-standard distribution\n\\(\\hat\\beta\\) asymptotically normal, variance estimable by efficient information\n\n\\(\\mathcal I(\\beta)=-\\partial^2 l_n\\{\\beta, \\hat\\Lambda_0(\\beta)\\}/\\partial\\beta^{\\otimes 2}\\) (negative quadrature of “profile likelihood”)"
  },
  {
    "objectID": "chap7.html#software-intcensicsurvicm",
    "href": "chap7.html#software-intcensicsurvicm",
    "title": "Applied Survival Analysis",
    "section": "Software: IntCens::ICSurvICM()",
    "text": "Software: IntCens::ICSurvICM()\n\nBasic syntax for analysis of interval-censored data\n\n\n\nobj &lt;- ICSurvICM(delta, gamma, U, V, Z, \n                 model = c(\"NP\", \"PH\", \"PO\"))\n\n\n\nInput\n\ndelta = 1: left censoring (\\(L_i=0\\)) \\(\\to\\) U = \\(R_i\\), V = NA\ngamma = 1: interval censoring (\\(L_i&gt;0, R_i&lt;\\infty\\)) \\(\\to\\) U = \\(L_i\\), V = \\(R_i\\)\ndelta = gamma = 0: right censoring (\\(R_i =\\infty\\)) \\(\\to\\) U = NA, V = \\(L_i\\)\nmodel = c(\"NP\", \"PH\", \"PO\"): nonparametric (one-sample) estimation, PH, PO regression models (with covariate matrix Z), respectively\n\nOutput: obj$beta (\\(\\hat\\beta\\)), obj$var(\\(\\hat\\var(\\hat\\beta)\\)), …"
  },
  {
    "objectID": "chap7.html#study-background",
    "href": "chap7.html#study-background",
    "title": "Applied Survival Analysis",
    "section": "Study Background",
    "text": "Study Background\n\n\nStudy information\n\nPopulation: 1,124 injecting drug users (IDUs) followed from 1995 to 1998 at 4-month intervals for blood test for HIV sero-positivity\nEndpoint: (interval-censored) time from enrollment to HIV seroconversion (link to follow-up plot)\nBaseline risk factors\n\nAge (years)\nSex (1: male; 0: female)\nHistory of needle sharing (1: yes; 0: no)\nHistory of being jailed/imprisoned (1: yes; 0: no)\nHistory of drug injection in jail (1: yes; 0: no)"
  },
  {
    "objectID": "chap7.html#cox-ph-regression",
    "href": "chap7.html#cox-ph-regression",
    "title": "Applied Survival Analysis",
    "section": "Cox PH Regression",
    "text": "Cox PH Regression\n\n\nLoad package and data\n\n\nlibrary(IntCens)\n## BMA data\nhead(df)\n#     L       R age sex needle jail inject\n#   40.6    Inf  37   0      0    1      1\n#   24.3    Inf  25   0      0    1      1\n#    0      4.1  49   0      1    1      1\n#    7.1   13.2  32   1      0    1      0\n# ...\n\n\n\n\nFit Cox model\n\n\n# Fit a proportional hazards model\nPH_fit &lt;- icsurvfit(L = df$L, R = df$R, Z = df[, 3:7], model = \"PH\")"
  },
  {
    "objectID": "chap7.html#cox-ph-regression-inference-i",
    "href": "chap7.html#cox-ph-regression-inference-i",
    "title": "Applied Survival Analysis",
    "section": "Cox PH Regression: Inference (I)",
    "text": "Cox PH Regression: Inference (I)\n\n\nSummary results\n\n\n# Print out regression results\nPH_fit \n#&gt; Call:\n#&gt; icsurvfit(L = df$L, R = df$R, Z = df[, 3:7], model = \"PH\")\n#&gt; \n#&gt; ICM algorithm converges in 102 iterations.\n#&gt; \n#&gt; Maximum Likelihood Estimates for Regression parameters:\n#&gt; \n#&gt;         Estimate    StdErr z.value  p.value   \n#&gt; age    -0.029914  0.011051 -2.7068 0.006793 **\n#&gt; sex     0.387923  0.268032  1.4473 0.147814   \n#&gt; needle  0.249568  0.144987  1.7213 0.085195 . \n#&gt; jail    0.456849  0.143961  3.1734 0.001506 **\n#&gt; inject  0.221270  0.146767  1.5076 0.131652   \n#&gt; ---\n#&gt; Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1"
  },
  {
    "objectID": "chap7.html#cox-ph-regression-inference-ii",
    "href": "chap7.html#cox-ph-regression-inference-ii",
    "title": "Applied Survival Analysis",
    "section": "Cox PH Regression: Inference (II)",
    "text": "Cox PH Regression: Inference (II)\n\n\nRegression results\n\nHistory of imprisonment increases risk of HIV seroconversion by \\(1.58-1=58\\%\\) (\\(p\\)-value 0.002)"
  },
  {
    "objectID": "chap7.html#cox-ph-regression-prediction",
    "href": "chap7.html#cox-ph-regression-prediction",
    "title": "Applied Survival Analysis",
    "section": "Cox PH Regression: Prediction",
    "text": "Cox PH Regression: Prediction\n\n\nModel-based prediction"
  },
  {
    "objectID": "chap7.html#notes-i",
    "href": "chap7.html#notes-i",
    "title": "Applied Survival Analysis",
    "section": "Notes (I)",
    "text": "Notes (I)\n\nLeft-truncated and interval-censored (LTIC) data\n\nDelayed entry with periodic check-ups\nPan and Chappell (1998a, 1998b, 2002), Gao and Chan (2018), etc.\n\nInterval-censored data\n\nReview: Huang and Wellner (1997)\nTime-varying covariates: Zeng et al. (2016)\nProfile-likelihood: Murphy and van der Vaart (2000)\nText: Sun (2010)"
  },
  {
    "objectID": "chap7.html#notes-ii",
    "href": "chap7.html#notes-ii",
    "title": "Applied Survival Analysis",
    "section": "Notes (II)",
    "text": "Notes (II)\n\nSun (2010)"
  },
  {
    "objectID": "chap7.html#summary",
    "href": "chap7.html#summary",
    "title": "Applied Survival Analysis",
    "section": "Summary",
    "text": "Summary\n\nLeft truncation\n\nCaused by delayed entry\nKaplan-Meier, log-rank test, and Cox model \\(\\to\\) modify risk set\nsurvival::Surv(entry, end, status)\n\nInterval censoring\n\nPeriodic check-ups of non-fatal, asymptomatic event\nNon- and semi-parametric models by NPMLE (ICM algorithm)\nIntCens::icsurvfit()\n\nNonparametric estimation\nProportional hazards model\nProportional odds model"
  },
  {
    "objectID": "chap7.html#hw-4-due-mar-20",
    "href": "chap7.html#hw-4-due-mar-20",
    "title": "Applied Survival Analysis",
    "section": "HW 4 (Due Mar 20)",
    "text": "HW 4 (Due Mar 20)\n\nChoose one\n\nProblem 5.1\nProblem 5.2\n\nProblem 6.5\nProblem 7.14 (The IntCens package is in “Files &gt; R-package”)"
  },
  {
    "objectID": "chap7.html#observed-data-1",
    "href": "chap7.html#observed-data-1",
    "title": "Applied Survival Analysis",
    "section": "Observed Data",
    "text": "Observed Data\n\n\nLikelihood function \\[\\begin{equation}\\label{eq:trunc:nonp}\nL_n(\\theta)=\\prod_{i=1}^n\\{S(L_i;\\theta)-S(R_i;\\theta)\\}\n\\end{equation}\\]\n\nLog-likelihood \\[\\begin{equation}\\label{eq:trunc:ic_log_lik}\nl_n(\\theta)=\\sum_{i=1}^n\\log\\{S(L_i;\\theta)-S(R_i;\\theta)\\}\n\\end{equation}\\]\n\n\n\n\n\nParametric Models\n\nStandard MLE \\(\\hat\\theta=\\arg\\max_\\theta l_n(\\theta)\\)"
  },
  {
    "objectID": "chap7.html#software-intcensicsurvfit",
    "href": "chap7.html#software-intcensicsurvfit",
    "title": "Applied Survival Analysis",
    "section": "Software: IntCens::icsurvfit()",
    "text": "Software: IntCens::icsurvfit()\n\n\nBasic syntax for analysis of interval-censored data\n\n\n\ndevtools::install_github(\"lmaowisc/IntCens\")\nlibrary(IntCens)\n# Fit non-/semi-parametric models to interval-censored data\nobj &lt;- icsurvfit(L, R, Z = NULL, model = c(\"NP\", \"PH\", \"PO\"))\n\n\n\n\n\nInput\n\nL, R: \\(L_i\\) and \\(R_i\\)\nZ: covariate matrix (optional)\nmodel = c(\"NP\", \"PH\", \"PO\"): nonparametric (one-sample) estimation, PH, PO regression models\n\nOutput: obj$beta (\\(\\hat\\beta\\)), obj$var(\\(\\hat\\var(\\hat\\beta)\\)), …"
  },
  {
    "objectID": "chap7.html#hw-4-due-mar-19",
    "href": "chap7.html#hw-4-due-mar-19",
    "title": "Applied Survival Analysis",
    "section": "HW 4 (Due Mar 19)",
    "text": "HW 4 (Due Mar 19)\n\nChoose one\n\nProblem 5.1\nProblem 5.2\n\nProblem 6.5\nProblem 7.14\n\n\n# Install and load IntCens package\n# devtools::install_github(\"lmaowisc/IntCens\")\nlibrary(IntCens)"
  },
  {
    "objectID": "chapter7.html#r-code",
    "href": "chapter7.html#r-code",
    "title": "Chapter 7 - Left Truncation and Interval Censoring",
    "section": "R code",
    "text": "R code\n\n\nShow the code\n###############################################################################\n# Chapter 7 R Code\n#\n# This script reproduces all major numerical results in Chapter 7, including:\n#   1. Analysis of left-truncated data (Channing House Study)\n#   2. Analysis of interval-censored data (BMA HIV Study)\n###############################################################################\n\n\n#==============================================================================\n# (A) Channing House Study (Left-Truncated Data)\n#==============================================================================\nlibrary(survival)\nlibrary(tidyverse)\nlibrary(patchwork)\n\n#------------------------------------------------------------------------------\n# 1. Read and Inspect the Channing Data\n#------------------------------------------------------------------------------\nchanning &lt;- read.table(\"Data\\\\Channing House Study\\\\channing.txt\")\nhead(channing)\n\n# Convert gender to factor\nchanning$gender &lt;- factor(channing$gender)\n\n#------------------------------------------------------------------------------\n# 2. Cox Model with Left-Truncation\n#------------------------------------------------------------------------------\nobj &lt;- coxph(Surv(Entry.Age, End.Age, status) ~ gender, data = channing)\nsummary(obj)\n\n#------------------------------------------------------------------------------\n# 3. Test Proportional Hazards Assumption (Schoenfeld Residuals)\n#------------------------------------------------------------------------------\nobj_zph &lt;- cox.zph(obj)\nobj_zph\n# Plot the rescaled residuals\nplot(\n  obj_zph,\n  ylab = \"Gender\",\n  xlab = \"Age (years)\",\n  lwd  = 2\n)\n\n#------------------------------------------------------------------------------\n# 4. Number at Risk by Gender Over Age\n#------------------------------------------------------------------------------\n# Create a function to compute number at risk at each time point\nt &lt;- seq(60, 100, by = 1)\n\nn_risk_t &lt;- function(entry, end) {\n  m   &lt;- length(t)\n  n_j &lt;- numeric(m)\n  for (j in seq_len(m)) {\n    n_j[j] &lt;- sum(entry &lt;= t[j] & t[j] &lt;= end)\n  }\n  return(n_j)\n}\n\n# Compute n at risk by gender\nnrisk &lt;- channing %&gt;%\n  group_by(gender) %&gt;%\n  reframe(n_j = n_risk_t(Entry.Age, End.Age)) %&gt;%\n  add_column(t = rep(t, 2), .before = 1) %&gt;%\n  mutate(gender = if_else(gender == 1, \"Male\", \"Female\"))\n\n# Plot number at risk\nnrisk_fig &lt;- nrisk %&gt;%\n  ggplot(aes(x = t, y = n_j)) +\n  geom_step(aes(linetype = gender)) +\n  theme_bw() +\n  labs(\n    x = \"Age (years)\",\n    y = \"Number at risk\"\n  ) +\n  theme(\n    legend.title    = element_blank(),\n    legend.position = \"top\"\n  )\n\n#------------------------------------------------------------------------------\n# 5. Conditional Survival Functions Given Age 70\n#------------------------------------------------------------------------------\nt0        &lt;- 70\nbeta      &lt;- obj$coefficients\nLambda0   &lt;- basehaz(obj, centered = FALSE)\n\n# Subset baseline hazard for times &gt;= t0\nLambda0t0 &lt;- Lambda0[Lambda0$time &gt;= t0, ]\n# Re-center the hazard to start at 0 for t &gt;= t0\nLambda0t0$hazard &lt;- Lambda0t0$hazard - Lambda0t0$hazard[1]\n\n# Construct survival curves for \"Male\" (reference) and \"Female\"\nsurv_t0 &lt;- Lambda0t0 %&gt;%\n  mutate(\n    St     = exp(-hazard),\n    gender = \"Male\"\n  ) %&gt;%\n  add_row(\n    Lambda0t0 %&gt;%\n      mutate(\n        St     = exp(-hazard * exp(beta)),\n        gender = \"Female\"\n      )\n  )\n\n# Plot conditional survival functions\nsurv_fig &lt;- surv_t0 %&gt;%\n  ggplot(aes(x = time, y = St)) +\n  geom_step(aes(linetype = gender)) +\n  theme_bw() +\n  labs(\n    x = \"Age (years)\",\n    y = \"Conditional survival probabilities\"\n  ) +\n  theme(\n    legend.title    = element_blank(),\n    legend.position = \"top\"\n  ) +\n  scale_x_continuous(expand = expansion(c(0, 0.05)))\n\n# Combine number-at-risk and conditional-survival plots\nchan_model &lt;- nrisk_fig + surv_fig +\n  plot_layout(ncol = 2, guides = \"collect\") &\n  theme(legend.position = 'top')\n\nchan_model\n\n# Uncomment to save the figure:\n# ggsave(\"trunc_chan_model.pdf\", chan_model, width = 8, height = 4)\n# ggsave(\"trunc_chan_model.eps\", chan_model, width = 8, height = 4)\n\n\n#==============================================================================\n# (B) Bangkok Metropolitan Administration (BMA) HIV Study (Interval-Censored)\n#==============================================================================\n# devtools::install_github(\"lmaowisc/IntCens\")\nlibrary(IntCens)\n\n#------------------------------------------------------------------------------\n# 1. Read BMA HIV Study Data\n#------------------------------------------------------------------------------\ndf &lt;- read.table(\"Data//Bangkok Metropolitan Administration HIV_AIDS Study//bam.txt\")\ndf\n\n#------------------------------------------------------------------------------\n# 2. Fit Proportional Hazards Model for Interval-Censored Data\n#------------------------------------------------------------------------------\nPH_fit &lt;- icsurvfit(\n  L = df$L,       # left endpoint of interval\n  R = df$R,       # right endpoint of interval\n  Z = df[, 3:7],  # covariates\n  model = \"PH\"\n)\nPH_fit\n\n#------------------------------------------------------------------------------\n# 3. Construct Table 7.3: Hazard Ratio & 95% CI\n#------------------------------------------------------------------------------\nbeta &lt;- PH_fit$beta\nse   &lt;- sqrt(diag(PH_fit$var))\n\nc1 &lt;- round(exp(beta), 2)\nc2 &lt;- paste0(\n  \"(\",\n  round(exp(beta - 1.96 * se), 2),\n  \", \",\n  round(exp(beta + 1.96 * se), 2),\n  \")\"\n)\n\nnoquote(cbind(c1, c2))\n\n#------------------------------------------------------------------------------\n# 4. Predict HIV Sero-Negative Probabilities\n#------------------------------------------------------------------------------\npar(mfrow = c(1, 1))\n\nage.med &lt;- median(df[, \"age\"])\n\n# Plot for a median-aged male IDU (sex=1) with no needle sharing or drug injection in jail\nplot(\n  PH_fit,\n  z    = c(age.med, 1, 0, 0, 0),\n  xlim = c(0, 50),\n  lty  = 2,\n  xlab = \"Time (months)\",\n  ylab = \"HIV sero-negative probabilities\",\n  lwd  = 2,\n  main = \"\"\n)\n\nplot(\n  PH_fit,\n  z    = c(age.med, 1, 0, 1, 0),\n  xlim = c(0, 50),\n  add  = TRUE,\n  lwd  = 2\n)\n\nlegend(\n  \"bottomleft\",\n  lty = c(2, 1),\n  legend = c(\"No history of imprisonment\", \"History of imprisonment\"),\n  lwd    = 2\n)",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 7 - Left Truncation and Interval Censoring"
    ]
  },
  {
    "objectID": "chap4.html",
    "href": "chap4.html",
    "title": "Applied Survival Analysis",
    "section": "",
    "text": "Model specification\nPartial-likelihood estimation and inference\nResidual analysis and goodness-of-fit\nTime-dependent covariates\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\]"
  },
  {
    "objectID": "chapter7.html#chapter-summary",
    "href": "chapter7.html#chapter-summary",
    "title": "Chapter 7 - Left Truncation and Interval Censoring",
    "section": "Chapter Summary",
    "text": "Chapter Summary\nWhen subjects enter the study late (thus excluding earlier failures) or when event times are only known to lie in intervals, traditional survival analysis methods must be adapted. Left truncation biases sampling toward individuals who have “survived” long enough to enroll. Interval censoring arises when event times are only observed through periodic assessments, leading to coarser information about the exact time of occurrence. It is important to properly adjust the risk sets and/or likelihood functions to ensure valid inference.\n\nLeft truncation\nLeft truncation occurs if a subject is enrolled at a later time \\(T_L\\) than the starting point so those who fail prior to \\(T_L\\) are never observed. Common examples include:\n\nRetrospective cohorts, where one must have survived long enough to be identified.\nHospital-based registries, where patients must be alive/available to visit a center.\n\nTo correct for this bias, standard risk-set calculations in the Kaplan–Meier, log-rank test, or Cox model are modified: \\[\nn_j \\;=\\;\\sum_{i=1}^{n} I\\bigl(T_{Li} \\;\\le\\; t_j \\;\\le\\; X_i\\bigr),\n\\] so that a subject only “enters” the risk set at \\(T_{Li}\\). Likewise, the partial likelihood in the Cox model replaces \\(I(X_j \\ge t)\\) with \\(I(T_{Lj} \\le t \\le X_j)\\) when constructing sums over at-risk individuals. Beyond these hazard-based methods, a more general approach employs a conditional likelihood factoring in \\(T_i &gt; T_{L,i}\\):\n\\[\nL_n(\\theta)\n\\;=\\;\n\\prod_{i=1}^{n}\nS\\bigl(T_{Li}; \\theta\\bigr)^{-1}\\,\n\\lambda\\bigl(X_i; \\theta\\bigr)^{\\delta_i}\\,\nS\\bigl(X_i; \\theta\\bigr).\n\\]\nThis reflects the fact that each subject is only observed if they survive beyond \\(T_{Li}\\).\n\n\nInterval censoring\nIn interval-censored data, the exact failure time \\(T\\) is only known to lie in \\((L_i, R_i]\\). A straightforward likelihood for a parametric or semiparametric model with survival function \\(S(t; \\theta)\\) is\n\\[\nL_n(\\theta)\n\\;=\\;\n\\prod_{i=1}^{n}\n\\Bigl\\{\nS\\bigl(L_i;\\theta\\bigr)\n\\;-\\;\nS\\bigl(R_i;\\theta\\bigr)\n\\Bigr\\}.\n\\]\nEach factor captures the probability that \\(T_i\\) falls strictly between \\(L_i\\) and \\(R_i\\). For purely nonparametric inference, one seeks the nonparametric MLE (NPMLE)—often computed via:\n\nTurnbull’s EM algorithm, which treats each actual \\(T_i\\) as missing and iteratively updates estimates of its distribution.\n\nIterative convex minorant (ICM) methods that maximize the log-likelihood subject to a monotonicity constraint on the distribution function or baseline hazard.\n\nSemiparametric models (e.g., Cox, proportional odds) introduce additional complexity because the baseline function is infinite-dimensional, but they can still be estimated via specialized EM or ICM algorithms. Although the baseline function converges slower than \\(n^{-1/2}\\), the finite-dimensional regression coefficients typically remain asymptotically normal under regular conditions.\n\n\nExample R commands\nBelow is a brief illustration using base packages () for left truncation and the package for interval censoring.\n\n###############################\n# 1. Left-truncated Cox model\n###############################\nlibrary(survival)\n\n# 'entry' is delayed entry time, 'end' is event/censor time, 'status' is 0/1\ncox_fit &lt;- coxph(Surv(entry, end, status) ~ covariate, data = df_left)\nsummary(cox_fit)  # modifies risk sets for delayed entry\n\n###############################\n# 2. Interval-censored data\n###############################\nlibrary(IntCens)\n\n# Fit a proportional hazards (PH) model to interval-censored data\n# L, R define the interval (L_i, R_i], Z includes covariates\nPH_fit &lt;- icsurvfit(L = df_ic$L, R = df_ic$R, Z = df_ic[, c(\"x1\", \"x2\")], \n                    model = \"PH\")\nPH_fit$beta   # estimated covariate effects\nPH_fit$var    # variance-covariance matrix\n\nIn both cases, these functions account for the specialized likelihoods required. For left truncation, the start/stop syntax in survival::Surv() adjusts the risk set. For interval censoring, IntCens::icsurvfit() implements the ICM algorithms and can handle nonparametric and proportional hazards/odds models.\n\n\nConclusion\nLeft-truncated designs require rethinking “at-risk” sets to reflect delayed study entry. Interval-censored data, which provide only bracketed failure times, rely on non-/semiparametric maximum likelihood with algorithms tailored to partial observations. Although more computationally involved than standard right-censored methods, these adjustments ensure valid statistical inference in the presence of complex data structures.",
    "crumbs": [
      "Home",
      "Part I - Univariate Events",
      "Chapter 7 - Left Truncation and Interval Censoring"
    ]
  },
  {
    "objectID": "chap8.html#outline",
    "href": "chap8.html#outline",
    "title": "Applied Survival Analysis",
    "section": "Outline",
    "text": "Outline\n\n\nIntroduction to frailty models\nMultivariate Cox model with shared frailty\nExample: A multi-center lung cancer study\nMarginal models and robust inference\nExample: the diabetic retinopathy study\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\]"
  },
  {
    "objectID": "chap8.html#multivariate-failure-times",
    "href": "chap8.html#multivariate-failure-times",
    "title": "Applied Survival Analysis",
    "section": "Multivariate Failure Times",
    "text": "Multivariate Failure Times\n\n\nTwo types of scenario\n\nMultiple events on same subject\n\nCardiovascular endpoints: heart failure, myocardio-infarction (MI; heart attack), stroke, etc.\n\nClustering within group\n\nGroup: region, study center, family, pair of twins\n\nCommon challenge\n\nCorrelation within same unit (subject, group, etc.)\n\n\n\n\n\n\nModelling strategies\n\nConditional (shared-frailty) models\nMarginal (component-wise) models"
  },
  {
    "objectID": "chap8.html#frailty-models-concept",
    "href": "chap8.html#frailty-models-concept",
    "title": "Applied Survival Analysis",
    "section": "Frailty Models: Concept",
    "text": "Frailty Models: Concept\n\n\nTarget of inference: \\(T=(T_1,\\ldots, T_K)\\)\n\nMultiple failures (same or different types) in same unit (subject or group)\n\n\n\n\n\nUnit-specific frailty \\(\\xi\\)\n\nLatent (unobserved) factor shared by components within unit \\(\\to\\) dependence\n\\(T_k\\) \\((k=1,\\ldots, K)\\): mutually independent given \\(\\xi\\) with hazard \\(\\xi\\eta'_k(t)\\) \\[\\begin{equation}\\label{eq:multi:fr_surv}\n\\pr(T_1&gt;t_1,\\ldots,T_K&gt;t_K\\mid \\xi)=\\exp\\left\\{-\\xi \\sum_{k=1}^K \\eta_k(t_k)\\right\\}\n\\end{equation}\\]\n\n\\(\\xi\\): nonnegative random variable with \\(E(\\xi)=1\\)\n\\(\\var(\\xi)\\uparrow\\) \\(\\to\\) greater between-unit variations \\(\\to\\) stronger within-unit correlations\n\\(\\eta_k(t)\\): conditional cumulative hazard given frailty"
  },
  {
    "objectID": "chap8.html#frailty-models-joint-distribution",
    "href": "chap8.html#frailty-models-joint-distribution",
    "title": "Applied Survival Analysis",
    "section": "Frailty Models: Joint Distribution",
    "text": "Frailty Models: Joint Distribution\n\n\nMarginal distribution\n\nJoint survival (\\(\\xi\\sim g(\\cdot \\gamma)\\)) \\[\\begin{align}\\label{eq:multi:joint_surv}\nS(t_1,\\ldots, t_K)=&\\pr(T_1&gt;t_1,\\ldots,T_K&gt;t_K)\\notag\\\\\n=&\\int_0^\\infty\\pr(T_1&gt;t_1,\\ldots,T_K&gt;t_K\\mid \\xi)g(\\xi;\\gamma)\\dd\\xi\\notag\\\\\n=&\\int_0^\\infty\\exp\\left\\{-\\xi  \\sum_{k=1}^K \\eta_k(t_k)\\right\\}g(\\xi;\\gamma)\\dd\\xi,\n\\end{align}\\]\nComponent-wise survival \\[S_k(t)=\\int_0^\\infty\\exp\\left\\{-\\xi \\eta_k(t)\\right\\}g(\\xi;\\gamma)\\dd\\xi\\]\nComponent-wise cumulative hazard: \\[\\Lambda_k(t) = -\\log S_k(t)=-\\log\\int_0^\\infty\\exp\\left\\{-\\xi \\eta_k(t)\\right\\}g(\\xi;\\gamma)\\dd\\xi\\neq \\eta_k(t)\\]"
  },
  {
    "objectID": "chap8.html#examples-gamma-frailty-i",
    "href": "chap8.html#examples-gamma-frailty-i",
    "title": "Applied Survival Analysis",
    "section": "Examples: Gamma Frailty (I)",
    "text": "Examples: Gamma Frailty (I)\n\n\nParametric families for \\(\\xi\\)\n\nGamma\nPositive stable\nInverse Gaussian\nLog-normal\n\n\n\n\n\nGamma frailty model\n\n\\(\\xi\\sim\\mbox{Gamma}(\\gamma, \\gamma)\\) \\((\\gamma &gt;0)\\) \\[\ng(u;\\gamma)=\\Gamma(\\gamma)^{-1}\\gamma^\\gamma u^{\\gamma-1}\\exp\\left(-\\gamma u\\right),\\hspace{3mm}u&gt;0\n\\]\n\n\\(\\Gamma(\\gamma)=\\int_0^\\infty x^{\\gamma-1}\\exp(-x)\\dd x\\)\n\\(E(\\xi) = 1\\), \\(\\var(\\xi)=\\gamma^{-1}\\) (Exercise)"
  },
  {
    "objectID": "chap8.html#examples-gamma-frailty-ii",
    "href": "chap8.html#examples-gamma-frailty-ii",
    "title": "Applied Survival Analysis",
    "section": "Examples: Gamma Frailty (II)",
    "text": "Examples: Gamma Frailty (II)\n\n\nImplied joint marginal \\[\nS(t_1,\\ldots, t_K)=\\left\\{1+\\gamma^{-1}\\sum_{k=1}^K \\eta_k(t_k)\\right\\}^{-\\gamma}\n\\]\n\nCorrelated for \\(0&lt;\\gamma&lt;\\infty\\)\nAs \\(\\gamma\\to\\infty\\), i.e., \\(\\var(\\xi)\\downarrow 0\\), \\(S(t_1,\\ldots, t_K)\\to\\exp\\{-\\sum_{k=1}^K \\eta_k(t_k)\\}\\)\n\n\n\n\n\nComponent-wise marginals \\[S_k(t)=\\left\\{1+\\gamma^{-1} \\eta_k(t)\\right\\}^{-\\gamma}\n\\]\n\nMarginal cumulative hazard: \\(\\Lambda_k(t)=\\gamma\\log\\left\\{1+\\gamma^{-1} \\eta_k(t)\\right\\}\\neq\\eta_k(t)\\)"
  },
  {
    "objectID": "chap8.html#examples-positive-stable-frailty",
    "href": "chap8.html#examples-positive-stable-frailty",
    "title": "Applied Survival Analysis",
    "section": "Examples: Positive Stable Frailty",
    "text": "Examples: Positive Stable Frailty\n\n\nOne-sided Stable distribution\n\nNo explicit form for \\(g(\\cdot;\\gamma)\\) \\((0&lt;\\gamma\\leq 1)\\)\nLaplace transform \\[\\begin{equation}\\label{eq:multi:stable_laplace}\n\\int_0^\\infty\\exp(-x\\xi)g(\\xi;\\gamma)\\dd\\xi=\\exp(-x^\\gamma)\n\\end{equation}\\]\nImplies joint marginal \\[\\begin{equation}\\label{eq:multi:stable_joint_survival}\nS(t_1,\\ldots, t_K)=\\int_0^\\infty\\exp\\left\\{-\\xi  \\sum_{k=1}^K \\eta_k(t_k)\\right\\}g(\\xi;\\gamma)\\dd\\xi=\\exp\\left[-\\left\\{\\sum_{k=1}^K \\eta_k(t_k)\\right\\}^\\gamma\\right]\n\\end{equation}\\]\n\n\\(\\gamma\\uparrow 1\\) \\(\\to\\) independence\n\nMarginal cumulative hazard: \\(\\Lambda_k(t)=\\eta_k(t_k)^\\gamma\\neq\\eta_k(t)\\)\n\nDoes preserve PH structure in regression"
  },
  {
    "objectID": "chap8.html#copula-models",
    "href": "chap8.html#copula-models",
    "title": "Applied Survival Analysis",
    "section": "Copula Models",
    "text": "Copula Models\n\n\nCopula: Joint distribution in terms of component marginals\n\n\n\n\nClayton copula\n\nInduced by Gamma frailty \\[\nS(t_1,\\ldots, t_K) = \\left\\{\\sum_{k=1}^KS_k(t_k)^{-1/\\gamma}-K+1\\right\\}^{-\\gamma}\n\\]\n\n\n\n\n\nGumbel-Hougaard copula\n\nInduced by positive-stable frailty \\[\nS(t_1,\\ldots, t_K) = \\exp\\left(-\\left[\\sum_{k=1}^K\\{-\\log S_k(t_k)\\}^{1/\\gamma}\\right]^\\gamma\\right)\n\\]"
  },
  {
    "objectID": "chap8.html#one-sample-data",
    "href": "chap8.html#one-sample-data",
    "title": "Applied Survival Analysis",
    "section": "One Sample: Data",
    "text": "One Sample: Data\n\n\nObserved data \\[\n(X_{ki}, \\delta_{ki}),\\hspace{5mm} k=1,\\ldots, K;\\,\\,\\, i=1,\\ldots, n\n\\]\n\n\\(X_{ki}=\\min(T_{ki}, C_{ki})\\)\n\\(T_{ki}\\): \\(T_k\\) in \\(i\\)th unit; \\(C_{ki}\\): censoring time for \\(T_{ki}\\)\n\\(\\delta_{ki} = I(T_{ki}\\leq C_{ki})\\)\n\\(N_{ki}(t) = I(X_{ki}\\leq t, \\delta_{ki} = 1)\\)\n\n\n\n\n\nParameters: \\(\\theta=(\\eta_1,\\ldots, \\eta_K, \\gamma)\\)\n\n\\(\\eta_1,\\ldots, \\eta_K\\): component-wise conditional cumulative hazards\n\\(\\gamma\\): frailty distribution parameter"
  },
  {
    "objectID": "chap8.html#one-sample-estimation",
    "href": "chap8.html#one-sample-estimation",
    "title": "Applied Survival Analysis",
    "section": "One Sample: Estimation",
    "text": "One Sample: Estimation\n\n\nExpectation-Maximization (EM) algorithm\n\nWith \\(\\xi\\) as “missing” data\n\\(E\\)-step (numerical integration) \\[\\begin{equation}\\label{eq:multi:estep}\n\\hat\\xi_i^{(j+1)}=E\\{\\xi_i\\mid (X_{ki}, \\delta_{ki}): k=1,\\ldots, K; \\theta^{(j)}\\}\n\\end{equation}\\]\n\\(M\\)-step (weighted Nelsen-Aalen estimator; standard MLE) \\[\\begin{equation}\\label{eq:multi:mstep_H}\n\\eta_k^{(j+1)}(t)=\\int_0^t\\frac{\\sum_{i=1}^n\\dd N_{ki}(u)}{\\sum_{i=1}^n\\hat\\xi_i^{(j+1)}I(X_{ki}\\geq u)}\n\\hspace{5mm}(k=1,\\ldots, K)\n\\end{equation}\\] \\[\n\\gamma^{(j+1)}=\\arg\\max_{\\gamma}\\sum_{i=1}^n\\log g(\\hat\\xi_i^{(j+1)};\\gamma)\n\\]"
  },
  {
    "objectID": "chap8.html#model-specification",
    "href": "chap8.html#model-specification",
    "title": "Applied Survival Analysis",
    "section": "Model Specification",
    "text": "Model Specification\n\n\nFrailty-conditioned Cox models\n\n\\(T_1,\\ldots, T_K\\) mutually independent given \\(Z\\) and \\(\\xi\\)\nConditional component-wise model \\[\\begin{align}\\label{eq:multi:ph_cond}\n\\lambda_k(t\\mid Z, \\xi)&= \\xi\\exp(\\beta_k^\\T Z) \\eta_{k0}'(t)\\\\\n\\pr(T_k&gt;t\\mid Z,\\xi)&=\\exp\\left\\{-\\xi\\exp(\\beta_k^\\T Z) \\eta_{k0}(t)\\right\\}\n\\end{align}\\]\nConditional joint survival \\[\\begin{equation}\\label{eq:multi:fr_surv_reg}\n\\pr(T_1&gt;t_1,\\ldots,T_K&gt;t_K\\mid Z,\\xi)=\\exp\\left\\{-\\xi\\sum_{k=1}^K\\exp(\\beta_k^\\T Z) \\eta_{k0}(t_k)\\right\\}\n\\end{equation}\\]"
  },
  {
    "objectID": "chap8.html#implied-marginals",
    "href": "chap8.html#implied-marginals",
    "title": "Applied Survival Analysis",
    "section": "Implied Marginals",
    "text": "Implied Marginals\n\n\nGamma frailty\n\nNon-proportional hazards \\[\n\\Lambda_k(t\\mid Z)=\\gamma\\log\\left\\{1+\\gamma^{-1} \\exp(\\beta_k^\\T Z)\\eta_{k0}(t)\\right\\}\n\\]\n\n\n\n\n\nPositive-stable frailty\n\nProportional hazards \\[\n\\Lambda_k(t\\mid Z)=\\exp(\\gamma\\beta_k^\\T Z)\\eta_{k0}(t)^\\gamma\n\\]\nSpecial case where PH structure is preserved"
  },
  {
    "objectID": "chap8.html#parametrizations",
    "href": "chap8.html#parametrizations",
    "title": "Applied Survival Analysis",
    "section": "Parametrizations",
    "text": "Parametrizations\n\n\nSame failure clustered in group \\[\\begin{align}\n\\beta_1&=\\cdots=\\beta_K=:\\beta\\\\\n\\eta_{10}(\\cdot)&=\\cdots=\\eta_{K0}(\\cdot)=:\\eta_0(\\cdot)\n\\end{align}\\]\n\n\n\n\nDifferent failure types \\[\\begin{align}\n&\\mbox{Different }\\beta_k\\\\\n&\\mbox{Different }\\eta_{k0}(\\cdot)\n\\end{align}\\]\n\nSame covariate effect: \\(\\beta_1=\\cdots=\\beta_K=:\\beta\\)\ne.g., beta blocker has same (relative) reduction in risk of all MACEs"
  },
  {
    "objectID": "chap8.html#estimation-and-inference",
    "href": "chap8.html#estimation-and-inference",
    "title": "Applied Survival Analysis",
    "section": "Estimation and Inference",
    "text": "Estimation and Inference\n\n\nEstimation\n\nEM algorithm treating the \\(\\xi\\) as missing data\n\\(E\\)-step: \\(\\hat\\xi_i^{(j+1)}=E\\{\\xi_i\\mid (X_{ki}, \\delta_{ki}, Z_i): k=1,\\ldots, K; \\theta^{(j)}\\}\\)\n\\(M\\)-step: \\(\\hat\\xi_i^{(j+1)}\\)-weighted partial likelihood for \\(\\beta_k^{(j+1)}\\) + Breslow estimator for \\(\\eta_{k0}^{(j+1)}(t)\\)\n\n\n\n\n\nTesting covariate effect on multiple components\n\n\\(Z_{\\cdot 1}\\): main treatment of interest \\[\n  H_0: \\beta_{11}=\\beta_{21}=\\cdots=\\beta_{K1}=0\n  \\]\n\\(\\chi_K^2\\): chi-square test with \\(𝐾\\) degrees of freedom"
  },
  {
    "objectID": "chap8.html#software-survivalcoxph-i",
    "href": "chap8.html#software-survivalcoxph-i",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::coxph() (I)",
    "text": "Software: survival::coxph() (I)\n\n\nScenario 1: Gamma-frailty with same \\(\\beta\\) and \\(\\eta_0\\)\n\nSame failure grouped in cluster id\nobj$frail: estimated \\(\\log(\\hat\\xi_i)\\) for each unit\n\n\n\n\nobj &lt;- coxph(Surv(time, status) ~ covariates + \n        frailty(id, distribution = \"gamma\"))\n\n\n\n\n\nScenario 2: Gamma-frailty with same \\(\\beta\\) and different \\(\\eta_{k0}\\)\n\nDifferent failure types enum in unit id with same covariate effect\nStratified Cox model by component (single \\(\\beta\\); component- specific \\(\\eta_{k0}\\))\n\n\n\n\ncoxph(Surv(time, status) ~ covariates + strata(enum)\n      + frailty(id, distribution = \"gamma\"))"
  },
  {
    "objectID": "chap8.html#software-survivalcoxph-ii",
    "href": "chap8.html#software-survivalcoxph-ii",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::coxph() (II)",
    "text": "Software: survival::coxph() (II)\n\n\nScenario 3: Gamma-frailty with different \\(\\beta_k\\) and \\(\\eta_{k0}\\)\n\nDifferent failure types enum in unit id with different covariate effects\nComponent specific \\(\\beta_k\\) and \\(\\eta_{k0}\\)\n\n\n\n\ncoxph(Surv(time, status) ~ covariates * strata(enum) + \n      frailty(id, distribution = \"gamma\"))\n\n\n\n\n\n\n\n\n\n\nProblem\n\n\nHow to set up a model of the form: \\[\n\\lambda_k(t\\mid Z, \\xi) \\;=\\; \\xi\\exp\\left(\\beta_k^\\T Z_{(1)} + \\gamma^\\T Z_{(2)}\\right) \\eta_{k0}'(t),\n\\] where the effects of \\(Z_{(1)}\\) are component-specific while those of \\(Z_{(2)}\\) are component-invariant?"
  },
  {
    "objectID": "chap8.html#study-background",
    "href": "chap8.html#study-background",
    "title": "Applied Survival Analysis",
    "section": "Study Background",
    "text": "Study Background\n\n\nStudy information\n\nPopulation: 228 lung cancer patients grouped in 18 institutions\nEndpoint: Death (link to follow-up plot)\nRisk factors\n\nAge (years); sex (1: male; 2: female); weight loss (pounds) in last six months\nPhysician-rated ECOG (0–3) and Karnofsky scores (50–100); Patient-rated Karnofsky score (50–100)"
  },
  {
    "objectID": "chap8.html#cox-regression-inference",
    "href": "chap8.html#cox-regression-inference",
    "title": "Applied Survival Analysis",
    "section": "Cox Regression: Inference",
    "text": "Cox Regression: Inference\n\n\nGamma frailty for correlation within institution\n\nsex and physician-rated ECOG strongly predictive of mortality\n\n\n# Fit a Cox model with institution-specific frailty\nobj &lt;- coxph(Surv(time, status) ~ age + factor(sex) + phec + phkn + \n            ptkn + wl + frailty(inst, distribution = \"gamma\"), data = df)\nsummary(obj)\n#&gt;              exp(coef) exp(-coef) lower .95 upper .95\n#&gt; age             1.0133     0.9869    0.9938    1.0331\n#&gt; factor(sex)2    0.5333     1.8751    0.3751    0.7582\n#&gt; phec            1.9984     0.5004    1.3460    2.9669\n#&gt; phkn            1.0204     0.9800    1.0002    1.0410\n#&gt; ptkn            0.9855     1.0147    0.9715    0.9998\n#&gt; wl              0.9870     1.0132    0.9735    1.0006\n#&gt; Iterations: 9 outer, 35 Newton-Raphson\n#&gt;  Variance of random effect= 0.008592303   I-likelihood = -635.5"
  },
  {
    "objectID": "chap8.html#cox-regression-prediction",
    "href": "chap8.html#cox-regression-prediction",
    "title": "Applied Survival Analysis",
    "section": "Cox Regression: Prediction",
    "text": "Cox Regression: Prediction"
  },
  {
    "objectID": "chap8.html#marginal-cox-models",
    "href": "chap8.html#marginal-cox-models",
    "title": "Applied Survival Analysis",
    "section": "Marginal Cox Models",
    "text": "Marginal Cox Models\n\n\nMarginal models\n\nFocusing on component-wise marginal distributions (averaged across units)\nNo specification of joint distribution between components\nAccount for correlation empirically\n\n\n\n\n\nMarginal Cox model \\[\\begin{equation}\\label{eq:multi:marg_cox}\n\\Lambda_k(t\\mid Z)=\\exp(\\beta_k^\\T Z)\\Lambda_{k0}(t)\n\\end{equation}\\]\n\n\\(\\beta_k\\): population-averaged log-hazard ratios\n\nNot comparable to unit-level \\(\\beta_k\\) in frailty model\n\nFor same-type failure, constrain \\(\\beta_1=\\cdots=\\beta_K\\) and \\(\\Lambda_{10}=\\cdots=\\Lambda_{K0}\\)"
  },
  {
    "objectID": "chap8.html#estimation-i",
    "href": "chap8.html#estimation-i",
    "title": "Applied Survival Analysis",
    "section": "Estimation (I)",
    "text": "Estimation (I)\n\n\nFree \\(\\beta_k\\) & \\(\\Lambda_{k0}\\)\n\nSolve \\(U_{nk}(\\hat\\beta_k)=0\\) \\[\\begin{align}\\label{eq:multi:eek}\nU_{nk}(\\beta_k)&=\\Pn\\int_0^\\infty\\left\\{Z_i-\n\\frac{\\sum_{j=1}^nI(X_{kj}\\geq t)Z_j\\exp(\\beta_k^\\T Z_j)}{\\sum_{j=1}^nI(X_{kj}\\geq t)\\exp(\\beta_k^\\T Z_j)}\\right\\}\\dd N_{ki}(t)\n\\end{align}\\]\n\\(\\hat\\Lambda_{k0}(t)=\\int_0^t\\frac{\\sum_{i=1}^n\\dd N_{ki}(u)}{\\sum_{i=1}^n I(X_{ki}\\geq u)\\exp(\\hat\\beta_k^\\T Z_i)}\\)\n\n\n\n\n\nSame \\(\\beta\\) & free \\(\\Lambda_{k0}\\)\n\nSolve \\(U_{n}(\\hat\\beta)=0\\) \\[\\begin{align}\\label{eq:multi:ee_stra}\nU_{n}(\\beta)&=\\Pn\\sum_{k=1}^K\\int_0^\\infty\\left\\{Z_i-\n\\frac{\\sum_{j=1}^nI(X_{kj}\\geq t)Z_j\\exp(\\beta^\\T Z_j)}{\\sum_{j=1}^nI(X_{kj}\\geq t)\\exp(\\beta^\\T Z_j)}\\right\\}\\dd N_{ki}(t)\n\\end{align}\\]"
  },
  {
    "objectID": "chap8.html#estimation-ii",
    "href": "chap8.html#estimation-ii",
    "title": "Applied Survival Analysis",
    "section": "Estimation (II)",
    "text": "Estimation (II)\n\n\nSame \\(\\beta\\) & \\(\\Lambda_{0}\\)\n\nSolve \\(U_{n}(\\hat\\beta)=0\\) \\[\\begin{align}\\label{eq:multi:ee_unstra}\nU_{n}(\\beta)&=\\Pn\\sum_{k=1}^K\\int_0^\\infty\\left\\{Z_i-\n\\frac{\\sum_{k'=1}^K\\sum_{j=1}^nI(X_{k'j}\\geq t)Z_j\\exp(\\beta^\\T Z_j)}{\\sum_{k'=1}^K\\sum_{j=1}^nI(X_{k'j}\\geq t)\\exp(\\beta^\\T Z_j)}\\right\\}\\times\\dd N_{ki}(t)\n\\end{align}\\]\n\n\n\n\n\n\n\n\n\n\nExercise: Breslow estimator\n\n\nConstruct proper Breslow estimators for the baseline function(s) given \\(\\hat\\beta\\) under:\n\nSame \\(\\beta\\) & free \\(\\Lambda_{k0}\\)\nSame \\(\\beta\\) & \\(\\Lambda_{0}\\)"
  },
  {
    "objectID": "chap8.html#robust-variance-sandwitch-estimator",
    "href": "chap8.html#robust-variance-sandwitch-estimator",
    "title": "Applied Survival Analysis",
    "section": "Robust Variance: Sandwitch Estimator",
    "text": "Robust Variance: Sandwitch Estimator\n\nMartingale not working\n\nConditional event rate given past \\(\\neq\\) modeling target\nBetween-component dependence not specified\n\nRobust variance\n\nWorks regardless of underlying dependence structure\nSandwich estimator \\[\n\\hat\\var(\\hat\\beta)=n^{-1}\\hat A_n^{-1}\\hat{\\mathcal I}_n \\hat A_n^{\\T-1}\n\\]\n\n\\(\\hat A_n=\\partial U_n(\\hat\\beta)/\\partial\\beta\\)\n\\(\\hat{\\mathcal I}_n=\\hat\\var\\{\\sqrt n U_n(\\beta)\\}\\): sample variance based on sum of independent units"
  },
  {
    "objectID": "chap8.html#conditional-vs-marginal-models",
    "href": "chap8.html#conditional-vs-marginal-models",
    "title": "Applied Survival Analysis",
    "section": "Conditional vs Marginal Models",
    "text": "Conditional vs Marginal Models\n\n\nComparison"
  },
  {
    "objectID": "chap8.html#software-survivalcoxph-i-1",
    "href": "chap8.html#software-survivalcoxph-i-1",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::coxph() (I)",
    "text": "Software: survival::coxph() (I)\n\n\nScenario 1: Marginal model with same \\(\\beta\\) and \\(\\Lambda_0\\)\n\nSame failure grouped in cluster id\n\n\n\n\ncoxph(Surv(time, status) ~ covariates + cluster(id))\n\n\n\n\n\nScenario 2: Marginal model with same \\(\\beta\\) and different \\(\\Lambda_{k0}\\)\n\nDifferent failure types enum in unit id with same covariate effect\n\nStratified Cox model by component (single \\(\\beta\\); component- specific \\(\\Lambda_{k0}\\))\n\n\n\n\n\ncoxph(Surv(time, status) ~ covariates + strata(enum)\n      + cluster(id))"
  },
  {
    "objectID": "chap8.html#software-survivalcoxph-ii-1",
    "href": "chap8.html#software-survivalcoxph-ii-1",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::coxph() (II)",
    "text": "Software: survival::coxph() (II)\n\n\nScenario 3: Marginal model with different \\(\\beta_k\\) and \\(\\Lambda_{k0}\\)\n\nDifferent failure types enum in unit id with different covariate effects\nComponent specific \\(\\beta_k\\) and \\(\\Lambda_{k0}\\)\n\n\n\n\ncoxph(Surv(time, status) ~ covariates * strata(enum) + \n      cluster(id))"
  },
  {
    "objectID": "chap8.html#study-background-1",
    "href": "chap8.html#study-background-1",
    "title": "Applied Survival Analysis",
    "section": "Study Background",
    "text": "Study Background\n\n\nStudy information\n\nDesign: randomized controlled trial of 197 diabetic patients (plot)\n\none eye receiving photocoagulation\nthe other eye left untreated as control\n\nEndpoint: Onset of blindness\n\nWhether treatment effect depends on type of diabetes (adult or juvenile)"
  },
  {
    "objectID": "chap8.html#marginal-cox-regression-inference-i",
    "href": "chap8.html#marginal-cox-regression-inference-i",
    "title": "Applied Survival Analysis",
    "section": "Marginal Cox Regression: Inference (I)",
    "text": "Marginal Cox Regression: Inference (I)\n\n\nMarginal Cox model to handle correlation between eyes\n\nTreatment effect differs by disease type substantially\n\n\n# Fit a bivariate marginal Cox model with treatment, diabetic type\n# risk score, and treatment*type interaction as covariates\nobj &lt;- coxph(Surv(time, status) ~ trt + type + trt : type + risk\n             + cluster(id), data = data)\n\nsummary(obj)\n#                      coef exp(coef) se(coef) robust se      z Pr(&gt;|z|)    \n# trt              -1.29375   0.27424  0.27552   0.24614 -5.256 1.47e-07 ***\n# typejuvenile     -0.37115   0.68994  0.19958   0.19535 -1.900  0.05745 .  \n# risk              0.15342   1.16582  0.05636   0.05981  2.565  0.01031 *  \n# trt:typejuvenile  0.88241   2.41672  0.35124   0.30962  2.850  0.00437 **"
  },
  {
    "objectID": "chap8.html#marginal-cox-regression-inference-ii",
    "href": "chap8.html#marginal-cox-regression-inference-ii",
    "title": "Applied Survival Analysis",
    "section": "Marginal Cox Regression: Inference (II)",
    "text": "Marginal Cox Regression: Inference (II)\n\n\nEfficiency gain by accounting for correlation\n\nRobust: sandwich estimator\nNaive: assuming two eyes are independent"
  },
  {
    "objectID": "chap8.html#marginal-cox-regression-results",
    "href": "chap8.html#marginal-cox-regression-results",
    "title": "Applied Survival Analysis",
    "section": "Marginal Cox Regression: Results",
    "text": "Marginal Cox Regression: Results\n\n\nTreatment effect depends on disease type\n\nMuch greater reduction in risk of blindness of adult (type II?) than juvenile patients (type I?) (p-value = 0.004)\n\n\n\n\n\n\n\n\n\nDiabetic type\nHazard ratio\n\n\n\n\nAdult\n\\[                                                                                                      \n                                                                                                                 \\exp(-1.294) = 27.4\\%       \n                                                                                                                                       \\]\n\n\nJuvenile\n\\[                                                                                                      \n                                                                                                            \\exp(-1.294 + 0.882)= 66.2\\%     \n                                                                                                                                       \\]"
  },
  {
    "objectID": "chap8.html#marginal-cox-regression-prediction",
    "href": "chap8.html#marginal-cox-regression-prediction",
    "title": "Applied Survival Analysis",
    "section": "Marginal Cox Regression: Prediction",
    "text": "Marginal Cox Regression: Prediction"
  },
  {
    "objectID": "chap8.html#notes-i",
    "href": "chap8.html#notes-i",
    "title": "Applied Survival Analysis",
    "section": "Notes (I)",
    "text": "Notes (I)\n\nComparison with longitudinal analysis\n\n\n\n\nMultivariate events\nLongitudinal data\n\n\n\n\nShared-frailty models\nMixed-effects models\n\n\nMarginal models\nMarginal models (GEE)\n\n\n\n\nFrailty models = random intercepts \\(\\to\\) random slopes \\[\n\\pr(T_k&gt;t\\mid Z, b)=\\exp\\left\\{-\\exp(b^\\T\\tilde Z+\\beta_k^\\T Z)\\eta_{k0}(t)\\right\\}\n\\]\n\n\\(\\tilde Z\\) a subset of \\(Z\\)\n\\(b\\sim_\\mbox{e.g.} MVN(0, \\Sigma)\\)"
  },
  {
    "objectID": "chap8.html#notes-ii",
    "href": "chap8.html#notes-ii",
    "title": "Applied Survival Analysis",
    "section": "Notes (II)",
    "text": "Notes (II)\n\nOther frailty distributions\n\nLog-normal: coxph(Surv(time, status) ~ covariates +      frailty(id, distribution = \"gaussian\"))\n\nfrailtyEM package\n\nemfrail(): EM algorithm for frailty models\nemfrail_dist(): specify frailty distribution\n\nPositive stable: dist = \"stable\"\nInverse Gaussian: dist = \"pvf\"\n\n\nlibrary(frailtyEM)\n# Frailty model via emfrail()\nobj &lt;- emfrail(Surv(time, status) ~ covariates + cluster(id) \n                  + distribution = emfrail_dist(dist = \"pvf\"))"
  },
  {
    "objectID": "chap8.html#summary",
    "href": "chap8.html#summary",
    "title": "Applied Survival Analysis",
    "section": "Summary",
    "text": "Summary\n\nShared-frailty Cox model \\[\n  \\pr(T_k&gt;t\\mid Z,\\xi)=\\exp\\left\\{-\\xi\\exp(\\beta_k^\\T Z) \\eta_{k0}(t)\\right\\}\n  \\]\n\nUnit-specific \\(\\xi\\) induces correlation\ncoxph(Surv(time, status) ~ covariates + frailty(id, distribution = \"gamma\"))\n\nMarginal Cox model \\[\n  \\Lambda_k(t\\mid Z)=\\exp(\\beta_k^\\T Z)\\Lambda_{k0}(t)\n  \\]\n\nRobust sandwich estimator to account for correlation empirically\ncoxph(Surv(time, status) ~ covariates + cluster(id))"
  },
  {
    "objectID": "chap8.html#robust-variance-sandwitch",
    "href": "chap8.html#robust-variance-sandwitch",
    "title": "Applied Survival Analysis",
    "section": "Robust Variance: Sandwitch",
    "text": "Robust Variance: Sandwitch\n\n\nMartingale not working\n\nConditional event rate given past \\(\\neq\\) modeling target\nBetween-component dependence not specified\n\n\n\n\n\nRobust variance\n\nWorks regardless of underlying dependence structure\nSandwich estimator \\[\n\\hat\\var(\\hat\\beta)=n^{-1}\\hat A_n^{-1}\\hat{\\mathcal I}_n \\hat A_n^{\\T-1}\n\\]\n\n\\(\\hat A_n=\\partial U_n(\\hat\\beta)/\\partial\\beta\\)\n\\(\\hat{\\mathcal I}_n=\\hat\\var\\{\\sqrt n U_n(\\beta)\\}\\): sample variance based on sum of independent units"
  },
  {
    "objectID": "chap8.html#notes-iii",
    "href": "chap8.html#notes-iii",
    "title": "Applied Survival Analysis",
    "section": "Notes (III)",
    "text": "Notes (III)\n\nTexts"
  },
  {
    "objectID": "chapter8.html#r-code",
    "href": "chapter8.html#r-code",
    "title": "Chapter 8 - Multivariate Failure Times",
    "section": "R Code",
    "text": "R Code\n\n\nShow the code\n###############################################################################\n# Chapter 8 R Code\n#\n# This script reproduces all major numerical results in Chapter 8, including:\n#   1. Clustered data analysis (NCCTG lung cancer study)\n#   2. Bivariate marginal Cox model (Diabetic Retinopathy Study)\n#   3. Multistate endpoints (TOPCAT trial)\n###############################################################################\n\nlibrary(survival)\nlibrary(tidyverse)\nlibrary(patchwork)\n\n#==============================================================================\n# (A) NCCTG Lung Cancer Study (Clustered Data)\n#==============================================================================\n#------------------------------------------------------------------------------\n# 1. Read the NCCTG lung cancer data\n#    (clustered by institution)\n#------------------------------------------------------------------------------\ndf &lt;- read.table(\"Data//NCCTG//lung.txt\")\nhead(df)\n\n#------------------------------------------------------------------------------\n# 2. Plot Follow-Up by Institution and Sex\n#------------------------------------------------------------------------------\ninst_by_sex_fu_plot &lt;- function(df) {\n  df %&gt;%\n    ggplot(aes(y = reorder(id, time), x = time, color = factor(2 - sex))) +\n    geom_linerange(aes(xmin = 0, xmax = time)) +\n    geom_point(aes(shape = factor(status)), size = 2, fill = \"white\") +\n    geom_vline(xintercept = 0, linewidth = 1) +\n    facet_grid(inst ~ ., scales = \"free\", space = \"free\", switch = \"y\") +\n    theme_minimal() +\n    scale_x_continuous(\n      \"Time (months)\",\n      limits  = c(0, 36),\n      breaks  = seq(0, 36, by = 12),\n      expand  = c(0, 0.25)\n    ) +\n    scale_y_discrete(\"Patients (by institution)\") +\n    scale_shape_manual(\n      values = c(23, 19),\n      labels = c(\"Censoring\", \"Death\")\n    ) +\n    scale_color_brewer(\n      palette = \"Set1\",\n      labels  = c(\"Female\", \"Male\")\n    ) +\n    theme(\n      strip.background = element_rect(fill = \"gray90\", color = \"gray90\"),\n      axis.text.y      = element_blank(),\n      axis.ticks.y     = element_blank(),\n      axis.line.y      = element_blank(),\n      panel.grid.major.y = element_blank(),\n      legend.title     = element_blank()\n    )\n}\n\np1 &lt;- inst_by_sex_fu_plot(df |&gt; filter(inst &lt;= 11))\np2 &lt;- inst_by_sex_fu_plot(df |&gt; filter(inst &gt; 11))\n\nmul_lung_fu &lt;- p1 + p2 +\n  plot_layout(ncol = 2, guides = \"collect\") &\n  theme(legend.position = \"top\")\n\n# ggsave(\"mul_lung_fu.pdf\", mul_lung_fu, width = 8, height = 10)\n# ggsave(\"mul_lung_fu.eps\", mul_lung_fu, width = 8, height = 10)\n\n#------------------------------------------------------------------------------\n# 3. Cox Model with Institution-Specific Frailty\n#------------------------------------------------------------------------------\ndf$sex &lt;- factor(df$sex)\n\nobj &lt;- coxph(\n  Surv(time, status) ~ age + sex + phec + phkn + ptkn + wl +\n    frailty(inst, distribution = \"gamma\"),\n  data = df\n)\n# Alternatively:\n# obj &lt;- coxph(\n#   Surv(time, status) ~ age + sex + phec + phkn + ptkn + wl +\n#     frailty(inst, distribution = \"gaussian\"),\n#   data = df\n# )\n\nsummary(obj) # model summary\nobj$coefficients # extract beta\nobj$frail # extract log-frailty\n\n#------------------------------------------------------------------------------\n# 4. Naive Cox Model (No Frailty)\n#------------------------------------------------------------------------------\nobj_naive &lt;- coxph(\n  Surv(time, status) ~ age + sex + phec + phkn + ptkn + wl,\n  data = df\n)\nsummary(obj_naive)\n\n#------------------------------------------------------------------------------\n# 5. Subject-Specific Survival Curves (Figure 8.2)\n#------------------------------------------------------------------------------\n# Typical patient with median values\nmed_age  &lt;- median(df$age, na.rm = TRUE)\nmed_phkn &lt;- median(df$phkn, na.rm = TRUE)\nmed_ptkn &lt;- median(df$ptkn, na.rm = TRUE)\nmed_wl   &lt;- median(df$wl, na.rm = TRUE)\n\nbeta     &lt;- obj$coefficients\nbase_obj &lt;- basehaz(obj, centered = FALSE)\neta      &lt;- base_obj$hazard\nt        &lt;- base_obj$time\n\n# Covariate profiles\n# ECOG: 0, 1, 2, 3\nzf0 &lt;- c(med_age, 1, 0, med_phkn, med_ptkn, med_wl)\nzf1 &lt;- c(med_age, 1, 1, med_phkn, med_ptkn, med_wl)\nzf2 &lt;- c(med_age, 1, 2, med_phkn, med_ptkn, med_wl)\nzf3 &lt;- c(med_age, 1, 3, med_phkn, med_ptkn, med_wl)\n\nzm0 &lt;- c(med_age, 0, 0, med_phkn, med_ptkn, med_wl)\nzm1 &lt;- c(med_age, 0, 1, med_phkn, med_ptkn, med_wl)\nzm2 &lt;- c(med_age, 0, 2, med_phkn, med_ptkn, med_wl)\nzm3 &lt;- c(med_age, 0, 3, med_phkn, med_ptkn, med_wl)\n\n# Base R plots for female\npar(mfrow = c(1, 2))\nplot(\n  t,\n  exp(-exp(sum(beta * zf0)) * eta),\n  type = \"s\",\n  xlim = c(0, 35),\n  ylim = c(0, 1),\n  frame = FALSE,\n  lty   = 1,\n  main  = \"Female\",\n  xlab  = \"Time (months)\",\n  ylab  = \"Survival probabilities\",\n  lwd   = 2,\n  cex.lab = 1.3,\n  cex.axis= 1.3,\n  cex.main= 1.3\n)\nlines(t, exp(-exp(sum(beta * zf1)) * eta), lty = 2, lwd = 2)\nlines(t, exp(-exp(sum(beta * zf2)) * eta), lty = 3, lwd = 2)\nlines(t, exp(-exp(sum(beta * zf3)) * eta), lty = 4, lwd = 2)\nlegend(\"topright\", lty = 1:4, lwd = 2, cex = 1.2, paste(\"ECOG\", 0:3))\n\n# Base R plots for male\nplot(\n  t,\n  exp(-exp(sum(beta * zm0)) * eta),\n  type  = \"s\",\n  xlim  = c(0, 35),\n  ylim  = c(0, 1),\n  frame = FALSE,\n  lty   = 1,\n  main  = \"Male\",\n  xlab  = \"Time (months)\",\n  ylab  = \"Survival probabilities\",\n  lwd   = 2,\n  cex.lab = 1.3,\n  cex.axis= 1.3,\n  cex.main= 1.3\n)\nlines(t, exp(-exp(sum(beta * zm1)) * eta), lty = 2, lwd = 2)\nlines(t, exp(-exp(sum(beta * zm2)) * eta), lty = 3, lwd = 2)\nlines(t, exp(-exp(sum(beta * zm3)) * eta), lty = 4, lwd = 2)\nlegend(\"topright\", lty = 1:4, lwd = 2, cex = 1.2, paste(\"ECOG\", 0:3))\n\n\n#==============================================================================\n# (B) Diabetic Retinopathy Study (Bivariate Marginal Cox Model)\n#==============================================================================\n#------------------------------------------------------------------------------\n# 1. Read the Data\n#------------------------------------------------------------------------------\ndf_drs &lt;- read.table(\"Data//Diabetic Retinopathy Study//drs.txt\")\nhead(df_drs)\n\n#------------------------------------------------------------------------------\n# 2. Fit Bivariate Marginal Cox Model\n#------------------------------------------------------------------------------\nobj_drs &lt;- coxph(\n  Surv(time, status) ~ trt + type + trt:type + risk + cluster(id),\n  data = df_drs\n)\nsummary(obj_drs)\n\n#------------------------------------------------------------------------------\n# 3. Table 8.1: Marginal Cox Model Analysis (Estimates, SE, p-values)\n#------------------------------------------------------------------------------\ncoeff  &lt;- summary(obj_drs)$coefficients\nc1     &lt;- coeff[, 1]  # beta estimate\nc2     &lt;- coeff[, 4]  # robust SE\nc3     &lt;- coeff[, 6]  # robust p-value\nc4     &lt;- coeff[, 3]  # naive SE\nc5     &lt;- 1 - pchisq((c1 / c4)^2, 1)  # naive p-value\n\n# Output table\nnoquote(round(cbind(c1, c2, c3, c4, c5), 3))\n\n#------------------------------------------------------------------------------\n# 4. Prediction of Vision-Retention Probabilities (Figure 8.4)\n#------------------------------------------------------------------------------\nLt &lt;- basehaz(obj_drs, centered = FALSE)\nt  &lt;- Lt$time\nL  &lt;- Lt$hazard\nbeta &lt;- coeff[, 1]\n\n# Covariate profiles: adult vs. juvenile, control vs. treatment\nadult_contr &lt;- exp(-exp(sum(beta * c(0, 0, 10, 0))) * L)\nadult_trt   &lt;- exp(-exp(sum(beta * c(1, 0, 10, 0))) * L)\njuv_contr   &lt;- exp(-exp(sum(beta * c(0, 1, 10, 0))) * L)\njuv_trt     &lt;- exp(-exp(sum(beta * c(1, 1, 10, 1))) * L)\n\npar(mfrow = c(1, 2))\n# Adult\nplot(\n  t, adult_contr,\n  type  = \"s\",\n  xlim  = c(0, 80),\n  ylim  = c(0, 1),\n  frame.plot = FALSE,\n  lty   = 3,\n  main  = \"Adult\",\n  xlab  = \"Time (months)\",\n  ylab  = \"Vision-retention probabilities\",\n  lwd   = 2,\n  cex.lab = 1.2,\n  cex.axis= 1.2,\n  cex.main= 1.2\n)\nlines(t, adult_trt, lty = 1, lwd = 2)\n\n# Juvenile\nplot(\n  t, juv_contr,\n  type  = \"s\",\n  xlim  = c(0, 80),\n  ylim  = c(0, 1),\n  frame = FALSE,\n  lty   = 3,\n  main  = \"Juvenile\",\n  xlab  = \"Time (months)\",\n  ylab  = \"Vision-retention probabilities\",\n  lwd   = 2,\n  cex.lab = 1.2,\n  cex.axis= 1.2,\n  cex.main= 1.2\n)\nlines(t, juv_trt, lty = 1, lwd = 2)\n\n\n#==============================================================================\n# (C) TOPCAT Trial (Multiple Endpoints)\n#==============================================================================\n#------------------------------------------------------------------------------\n# 1. Read and Inspect the Data\n#------------------------------------------------------------------------------\ntopcat &lt;- read.table(\"Data//TOPCAT//topcat.txt\")\n\n# Median follow-up\ntopcat %&gt;%\n  group_by(id) %&gt;%\n  slice_max(time) %&gt;%\n  slice_head() %&gt;%\n  ungroup() %&gt;%\n  summarize(median(time))\n\n#------------------------------------------------------------------------------\n# 2. Descriptive Analysis\n#------------------------------------------------------------------------------\ntmp &lt;- topcat %&gt;%\n  mutate(\n    drug   = if_else(drug == \"Spiro\", \"Spironolactone\", \"Placebo\"),\n    gender = if_else(gender == \"1:Male\", \"Male\", \"Female\")\n  )\n\n# De-duplicate\ndf_topcat &lt;- tmp %&gt;%\n  pivot_wider(\n    id_cols      = id,\n    names_from   = endpoint,\n    values_from  = c(time, status)\n  ) %&gt;%\n  left_join(\n    tmp %&gt;% filter(endpoint == \"HF\"),\n    join_by(id)\n  )\n\n# Helper: median (IQR) function\nmed_iqr &lt;- function(x, r = 1) {\n  qt &lt;- quantile(x, na.rm = TRUE)\n  paste0(\n    round(qt[3], r), \" (\",\n    round(qt[2], r), \", \",\n    round(qt[4], r), \")\"\n  )\n}\n\n# Quantitative variables table\ntab_quant &lt;- df_topcat %&gt;%\n  filter(endpoint == \"HF\") %&gt;%\n  group_by(drug) %&gt;%\n  summarize(across(c(age, bmi, hr), med_iqr)) %&gt;%\n  pivot_longer(!drug, values_to = \"value\", names_to = \"name\") %&gt;%\n  pivot_wider(values_from = value, names_from = drug) %&gt;%\n  mutate(\n    name = case_when(\n      name == \"age\" ~ \"Age (years)\",\n      name == \"bmi\" ~ \"BMI (kg/m^2)\",\n      name == \"hr\"  ~ \"Heart rate (per min)\"\n    )\n  )\n\n# Helper function for frequency tables\nfreq_pct &lt;- function(df, group, var, r = 1) {\n  var_counts &lt;- df %&gt;%\n    group_by({{ group }}, {{ var }}) %&gt;%\n    summarize(n = n(), .groups = \"drop\")\n\n  var_counts %&gt;%\n    left_join(\n      var_counts %&gt;% group_by({{ group }}) %&gt;% summarize(N = sum(n)),\n      by = join_by({{ group }})\n    ) %&gt;%\n    mutate(\n      value = paste0(n, \" (\", round(100 * n / N, r), \"%)\")\n    ) %&gt;%\n    select(-c(n, N)) %&gt;%\n    pivot_wider(names_from = {{ group }}, values_from = value) %&gt;%\n    rename(name = {{ var }})\n}\n\n# Categorical variables\ngender &lt;- df_topcat %&gt;%\n  freq_pct(drug, gender) %&gt;%\n  mutate(name = paste0(\"Gender - \", name))\n\nrace &lt;- df_topcat %&gt;%\n  freq_pct(drug, race) %&gt;%\n  mutate(name = paste0(\"Race - \", name))\n\nnyha &lt;- df_topcat %&gt;%\n  freq_pct(drug, nyha) %&gt;%\n  mutate(name = paste0(\"NYHA - \", name)) %&gt;%\n  filter(!is.na(name))\n\n# Helper for binary condition\nbin_pct &lt;- function(condition, r = 1) {\n  n &lt;- sum(condition, na.rm = TRUE)\n  N &lt;- length(condition)\n  paste0(n, \" (\", round(100 * n / N, r), \"%)\")\n}\n\ntabin &lt;- df_topcat %&gt;%\n  group_by(drug) %&gt;%\n  summarize(\n    N = n(),\n    across(c(smoke:cabg, status_HF, status_MI, status_Stroke), bin_pct)\n  ) %&gt;%\n  select(!N) %&gt;%\n  pivot_longer(!drug, values_to = \"value\", names_to = \"name\") %&gt;%\n  pivot_wider(values_from = value, names_from = drug) %&gt;%\n  mutate(\n    name = case_when(\n      name == \"smoke\"       ~ \"Smoker\",\n      name == \"chf_hosp\"    ~ \"CHF\",\n      name == \"copd\"        ~ \"COPD\",\n      name == \"asthma\"      ~ \"Asthma\",\n      name == \"dm\"          ~ \"Diabetes\",\n      name == \"htn\"         ~ \"Hypertension\",\n      name == \"cabg\"        ~ \"Coronary surgery\",\n      name == \"status_HF\"   ~ \"HF\",\n      name == \"status_MI\"   ~ \"MI\",\n      name == \"status_Stroke\" ~ \"Stroke\"\n    )\n  )\n\n# Event rates (per person-year)\nevent_rates &lt;- df_topcat %&gt;%\n  group_by(drug) %&gt;%\n  summarize(\n    `HF rate (per person-year)`     = sum(status_HF) / sum(time_HF),\n    `MI rate (per person-year)`     = sum(status_MI) / sum(time_MI),\n    `Stroke rate (per person-year)` = sum(status_Stroke) / sum(time_Stroke)\n  ) %&gt;%\n  pivot_longer(!drug, values_to = \"value\", names_to = \"name\") %&gt;%\n  pivot_wider(values_from = value, names_from = drug) %&gt;%\n  mutate(\n    Placebo         = as.character(round(Placebo, 4)),\n    Spironolactone  = as.character(round(Spironolactone, 4))\n  )\n\n# Combine tables\ntabone &lt;- bind_rows(\n  tab_quant[1, ],\n  gender,\n  race,\n  nyha,\n  tab_quant[-1, ],\n  tabin,\n  event_rates\n)\n\n# Add N to group names\ncolnames(tabone) &lt;- c(\n  \" \",\n  paste0(colnames(tabone)[2:3], \" (N=\", table(df_topcat$drug), \")\")\n)\n\n# Print table (example with knitr::kable)\nknitr::kable(tabone)\n\n#------------------------------------------------------------------------------\n# 3. Cox Model for Multiple Endpoints (Scenario 3)\n#------------------------------------------------------------------------------\nobj_topcat &lt;- coxph(\n  Surv(time, status) ~\n    (drug + age + gender + nyha + bmi + smoke + chf_hosp +\n       copd + asthma + dm + htn + cabg) *\n    strata(endpoint) + cluster(id),\n  data = topcat\n)\nsummary(obj_topcat)\nobj_topcat$coefficients\n\n#------------------------------------------------------------------------------\n# 4. Component-Specific HRs, 95% CIs, p-values\n#------------------------------------------------------------------------------\np     &lt;- 12  # number of covariates\nbeta  &lt;- obj_topcat$coefficients\nSigma &lt;- obj_topcat$var\n\nbetaHF  &lt;- numeric(p)\nvarHF   &lt;- numeric(p)\nbetaMI  &lt;- numeric(p)\nvarMI   &lt;- numeric(p)\nbetaStr &lt;- numeric(p)\nvarStr  &lt;- numeric(p)\n\n# Fill in HF, MI, Stroke\nfor (j in seq_len(p)) {\n  # HF\n  betaHF[j] &lt;- beta[j]\n  varHF[j]  &lt;- Sigma[j, j]\n\n  # MI (add interaction terms)\n  betaMI[j] &lt;- beta[j] + beta[p + 2 * j - 1]\n  varMI[j]  &lt;- Sigma[j, j] +\n               Sigma[p + 2 * j - 1, p + 2 * j - 1] +\n               2 * Sigma[j, p + 2 * j - 1]\n\n  # Stroke\n  betaStr[j] &lt;- beta[j] + beta[p + 2 * j]\n  varStr[j]  &lt;- Sigma[j, j] +\n               Sigma[p + 2 * j, p + 2 * j] +\n               2 * Sigma[j, p + 2 * j]\n}\n\nza &lt;- qnorm(0.975)\n\nhr_ci &lt;- function(b, v, r = 2) {\n  se &lt;- sqrt(v)\n  paste0(\n    round(exp(b), r), \" (\",\n    round(exp(b - za * se), r), \", \",\n    round(exp(b + za * se), r), \")\"\n  )\n}\n\nhr_p &lt;- function(b, v) {\n  se &lt;- sqrt(v)\n  round(1 - pchisq((b / se)^2, df = 1), 3)\n}\n\ndf_res &lt;- tibble(\n  variable = c(\n    \"Spironolactone\", \"Age (years)\", \"Female\", \"NYHA 3-4\", \"BMI\",\n    \"Smoke\", \"CHF\", \"COPD\", \"Asthma\", \"Diabetes\", \"Hypertension\", \"Coronary surgery\"\n  ),\n  HF       = hr_ci(betaHF, varHF),\n  HF_p     = hr_p(betaHF, varHF),\n  MI       = hr_ci(betaMI, varMI),\n  MI_p     = hr_p(betaMI, varMI),\n  Stroke   = hr_ci(betaStr, varStr),\n  Stroke_p = hr_p(betaStr, varStr)\n)\n\n# Print out table\ndf_res\n\n#------------------------------------------------------------------------------\n# 5. Joint Test of Spironolactone Effect on HF & Stroke\n#------------------------------------------------------------------------------\nbeta_q  &lt;- beta[c(1, 14)]\nSigma_q &lt;- Sigma[c(1, 14), c(1, 14)]\n\nchisq2  &lt;- t(beta_q) %*% solve(Sigma_q) %*% beta_q\npval    &lt;- 1 - pchisq(chisq2, 2)\n\n# pval is the p-value for the joint test",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 8 - Multivariate Failure Times"
    ]
  },
  {
    "objectID": "chapter8.html#chapter-summary",
    "href": "chapter8.html#chapter-summary",
    "title": "Chapter 8 - Multivariate Failure Times",
    "section": "Chapter Summary",
    "text": "Chapter Summary\nWhen analyzing multiple correlated event times—arising from either multiple failure types per subject (e.g., different clinical outcomes within the same patient) or clusters of subjects (e.g., families, institutions)—standard univariate approaches must be adapted to account for within-unit dependence. To do so, two broad modeling frameworks are useful:\n\nShared-frailty (conditional) models, which introduce a unit-level random effect (frailty) that influences all failure times in that unit, and\n\nMarginal models, which specify each event’s hazard at the population level and account for correlation via robust (sandwich) variance estimation.\n\nBoth frameworks extend Cox-type survival methods to multivariate data but differ in interpretation (conditional vs. population-averaged effects), assumptions about the joint distribution, and how correlation parameters are handled.\n\nShared-frailty models\nIn a shared-frailty model, each unit (subject or cluster) possesses a nonnegative frailty \\(\\xi\\). Conditioned on \\(\\xi\\), the component event times in that unit behave independently; marginally, they are correlated via the distribution of \\(\\xi\\). A typical conditional Cox specification is:\n\\[\n\\lambda_k(t \\mid Z, \\xi)\n\\;=\\;\n\\xi\\,\\exp\\bigl(\\beta_k^\\mathsf{T} Z\\bigr)\\,\\eta_{k0}'(t),\n\\]\nwhere \\(\\beta_k\\) is the (conditional) log-hazard ratio, and \\(\\eta_{k0}'(t)\\) is the baseline hazard for the \\(k\\)th event. Common frailty distributions include Gamma, positive stable, inverse Gaussian, and log-normal, each implying a distinct copula form.\n\nInterpretation: The coefficient \\(\\beta_k\\) reflects a within-unit comparison. For instance, comparing treated vs. untreated in the same frailty stratum yields the hazard ratio \\(\\exp(\\beta_k)\\).\n\nEstimation: Often via an EM algorithm that imputes each unit’s frailty \\(\\xi_i\\). Alternatively, software like R’s survival::coxph() can fit a Gamma-frailty Cox model directly with frailty(id, distribution=\"gamma\"). This yields both regression parameters and an estimate of the frailty variance, capturing the correlation strength.\n\n\n\nMarginal models\nA marginal Cox model specifies each event’s hazard averaged over the distribution of unobserved frailties or random effects:\n\\[\n\\Lambda_k(t \\mid Z)\n\\;=\\;\n\\exp\\bigl(\\beta_k^\\mathsf{T}Z\\bigr)\\,\\Lambda_{k0}(t).\n\\]\nThe within-unit dependence is handled by a robust (sandwich) variance estimator, rather than an explicit random-effects structure.\n\nInterpretation: \\(\\beta_k\\) gives a population-level hazard ratio, in contrast to the conditional hazard ratio from shared-frailty models.\n\nEstimation: The partial-likelihood score is constructed as if events were independent, but the covariance of \\(\\hat\\beta\\) is corrected using a cluster-based sandwich estimator (e.g., cluster(id) in R).\n\n\n\nThree scenarios\nWhen multiple event types exist (e.g., heart failure vs. stroke) or multiple members in a cluster, one can combine or separate the baselines and covariate effects:\n\nSame \\(\\beta\\) and same baseline: All events share one regression vector and one baseline hazard.\n\nSame \\(\\beta\\) but different baselines: Impose a single set of covariate effects while allowing event types (or clusters) different baseline hazards.\n\nDifferent \\(\\beta\\) and different baselines: Each event type (or group) has its own regression parameter vector and baseline hazard.\n\nThese choices apply to both shared-frailty and marginal modeling frameworks, depending on scientific questions and study design.\n\n\nExample R commands\nBelow are illustration snippets in R using the survival package, demonstrating how to fit both shared-frailty (conditional) and marginal Cox models under the three scenario types. We assume a data frame df with columns:\n\ntime (event or censor time),\n\nstatus (0/1 indicator),\n\nid (cluster or subject identifier),\n\nenum (if multiple event types),\n\ncovariates (e.g., x1, x2).\n\n\nShared-frailty (conditional) models\n\n# Scenario 1: Single regression vector, single baseline hazard\nfit_sf_scenario1 &lt;- coxph(\n  Surv(time, status) ~ x1 + x2 + frailty(id, distribution = \"gamma\"),\n  data = df\n)\n# Scenario 2: One covariate effect vector, separate baseline hazards\nfit_sf_scenario2 &lt;- coxph(\n  Surv(time, status) ~ x1 + x2 + strata(enum)\n    + frailty(id, distribution = \"gamma\",\n  data = df\n)\n# Scenario 3: Fully distinct covariate vectors and baseline hazards\nfit_sf_scenario3 &lt;- coxph(\n  Surv(time, status) ~ (x1 + x2) * strata(enum)\n    + frailty(id, distribution = \"gamma\",\n  data = df\n)\n\n\n\nMarginal (population-averaged) models\n\n# Scenario 1: Single beta, single baseline across events\nfit_marg_scenario1 &lt;- coxph(\n  Surv(time, status) ~ x1 + x2 + cluster(id),\n  data = df\n)\n# Scenario 2: Shared covariate effects, separate baseline hazards\nfit_marg_scenario2 &lt;- coxph(\n  Surv(time, status) ~ x1 + x2 + strata(enum) + cluster(id),\n  data = df\n)\n# Scenario 3: Event-type-specific beta vectors and baselines\nfit_marg_scenario3 &lt;- coxph(\n  Surv(time, status) ~ (x1 + x2) * strata(enum) + cluster(id),\n  data = df\n)\n\n\n\n\nConclusion\nModeling multiple correlated time-to-event outcomes requires specialized approaches:\nShared-frailty (conditional) models:\n\nIntroduce a random effect \\(\\xi\\) common to all events in a cluster.\nCovariate effects are interpreted within-unit.\nProvide direct correlation estimates via frailty variance but need stronger assumptions and more computation.\n\nMarginal models:\n\nFocus on population-level hazard functions.\nCovariate effects are population-averaged.\nDependence is handled by robust (sandwich) variances, requiring fewer assumptions but not yielding explicit correlation measures.\n\nThe choice between these approaches depends on whether unit-specific or population-averaged interpretations are of interest, along with practical considerations of model complexity and assumptions.",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 8 - Multivariate Failure Times"
    ]
  },
  {
    "objectID": "chapter8.html#r-code-examples",
    "href": "chapter8.html#r-code-examples",
    "title": "Chapter 8 Summary",
    "section": "R Code Examples",
    "text": "R Code Examples\nBelow are illustration snippets in R using the survival package, demonstrating how to fit both shared-frailty (conditional) and marginal Cox models under the three scenario types. We assume a data frame df with columns:\n\ntime (event or censor time),\n\nstatus (0/1 indicator),\n\nid (cluster or subject identifier),\n\nenum (if multiple event types),\n\ncovariates (e.g., x1, x2).\n\n\nShared-frailty (conditional) models\n\n# Scenario 1: Single regression vector, single baseline hazard\nfit_sf_scenario1 &lt;- coxph(\n  Surv(time, status) ~ x1 + x2 + frailty(id, distribution = \"gamma\")\n)\n# Scenario 2: One covariate effect vector, separate baseline hazards\nfit_sf_scenario2 &lt;- coxph(\n  Surv(time, status) ~ x1 + x2 + strata(enum)\n    + frailty(id, distribution = \"gamma\")\n)\n# Scenario 3: Fully distinct covariate vectors and baseline hazards\nfit_sf_scenario3 &lt;- coxph(\n  Surv(time, status) ~ (x1 + x2) * strata(enum)\n    + frailty(id, distribution = \"gamma\")\n)\n\n\n\nMarginal (population-averaged) models\n\n# Scenario 1: Single beta, single baseline across events\nfit_marg_scenario1 &lt;- coxph(\n  Surv(time, status) ~ x1 + x2 + cluster(id)\n)\n# Scenario 2: Shared covariate effects, separate baseline hazards\nfit_marg_scenario2 &lt;- coxph(\n  Surv(time, status) ~ x1 + x2 + strata(enum) + cluster(id)\n)\n# Scenario 3: Event-type-specific beta vectors and baselines\nfit_marg_scenario3 &lt;- coxph(\n  Surv(time, status) ~ (x1 + x2) * strata(enum) + cluster(id)\n)\n\n\n\nConclusion\nModeling multiple correlated time-to-event outcomes requires specialized approaches:\nShared-frailty (conditional) models:\n\nIntroduce a random effect \\(xi\\) common to all events in a cluster.\nCovariate effects are interpreted within-unit.\nProvide direct correlation estimates via frailty variance but need stronger assumptions and more computation.\n\nMarginal models:\n\nFocus on population-level hazard functions.\nCovariate effects are population-averaged.\nDependence is handled by robust (sandwich) variances, requiring fewer assumptions but not yielding explicit correlation measures.\n\nThe choice between these approaches depends on whether unit-specific or population-averaged interpretations are more desirable, along with practical considerations of model complexity and assumptions. Either method, if correctly applied, provides valid inferences while controlling for correlated observations in a multivariate failure-time setting.",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 8 Summary"
    ]
  },
  {
    "objectID": "chap9.html#outline",
    "href": "chap9.html#outline",
    "title": "Applied Survival Analysis",
    "section": "Outline",
    "text": "Outline\n\n\nIntensity and rate/mean functions\nCox-type models for recurrent events\nAnalysis of the Chronic Granulomatous Disease Study\nMultivariate approaches to recurrent events\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\]"
  },
  {
    "objectID": "chap9.html#recurrent-events",
    "href": "chap9.html#recurrent-events",
    "title": "Applied Survival Analysis",
    "section": "Recurrent Events",
    "text": "Recurrent Events\n\n\nRepeated occurrences of an adverse event\n\nInfections (CGD)\nTumor occurrences\nHospitalizations\nEpisodes of CV events: chest pain (angina), irregular heart beat (tachycardia)\nNaive approach: time to first event\n\n\n\n\n\nRecurrent event process\n\nStatistically more efficient\nFuller picture of patient experience\nChallenges: correlation, multiple events"
  },
  {
    "objectID": "chap9.html#outcome-data",
    "href": "chap9.html#outcome-data",
    "title": "Applied Survival Analysis",
    "section": "Outcome Data",
    "text": "Outcome Data\n\n\nTarget of inference\n\n\\(N^*(t)\\): number of recurrent events by \\(t\\)\n\n\\(N^*(t)=\\sum_{k=1}^\\infty I(T_k\\leq t)\\)\n\\(T_1&lt;T_2&lt;\\cdots\\): recurrent event times"
  },
  {
    "objectID": "chap9.html#intensity-function",
    "href": "chap9.html#intensity-function",
    "title": "Applied Survival Analysis",
    "section": "Intensity Function",
    "text": "Intensity Function\n\n\nModeling recurrent events\n\nIntensity: conditional incidence given history\nRate: marginal incidence across population\n\n\n\n\n\nIntensity: Current risk given event history \\[\\begin{equation}\\label{eq:rec:intensity}\n\\ell\\{t\\mid \\overline{N}^*(t-)\\}\\dd t=E\\{\\dd N^*(t)\\mid \\overline{N}^*(t-)\\}\n\\end{equation}\\]\n\n\\(\\overline{N}^*(t-)=\\{N^*(u):0\\leq u &lt; t\\}\\)\nUnivariate case \\[\n\\ell\\{t\\mid \\overline{N}^*(t-)\\}=I(T\\geq t)\\lambda(t)\\dd t\n\\]\n\nIntensity \\(=\\) an extension of hazard"
  },
  {
    "objectID": "chap9.html#example-poisson-process",
    "href": "chap9.html#example-poisson-process",
    "title": "Applied Survival Analysis",
    "section": "Example: Poisson Process",
    "text": "Example: Poisson Process\n\n\nIndependent events \\[\\begin{equation}\\label{eq:rec:poisson}\nE\\{\\dd N^*(t)\\mid \\overline{N}^*(t-)\\}=\\ell(t)\n\\end{equation}\\]\n\nCurrent risk \\(\\ell(t)\\) independent of past\n\nHomogeneous Poisson: \\(\\ell(t) = \\lambda\\)\n\nGenerally unrealistic in medical applications\n\nMore previous events \\(\\to\\) higher current risk\n\n\n\n\n\n\nPoisson properties\n\n\\(N^*(t_{j}) - N^*(t_{j-1})\\), number of events in \\((t_{j-1}, t_{j}]\\) \\((j=1, 2, \\ldots)\\), are mutually independent Poisson with mean \\(\\int_{t_{j-1}}^{t_j}\\ell(u)\\dd u\\)"
  },
  {
    "objectID": "chap9.html#rate-function",
    "href": "chap9.html#rate-function",
    "title": "Applied Survival Analysis",
    "section": "Rate Function",
    "text": "Rate Function\n\n\nRate: Marginal incidence \\[\\begin{equation}\\label{eq:rec:rate}\nr(t)\\dd t=E\\{\\dd N^*(t)\\}\n\\end{equation}\\]\n\nMean: Average number of events \\[\\begin{equation}\\label{eq:rec:mean}\n\\mu(t)=E\\{N^*(t)\\}=\\int_0^t r(u)\\dd u\n\\end{equation}\\]\n\n\n\n\n\nRate vs intensity \\[\nr(t)=E\\left[\\ell\\{t\\mid \\overline{N}^*(t-)\\}\\right]\n\\]\n\nPoisson process: \\(r(t)=\\ell(t)\\)"
  },
  {
    "objectID": "chap9.html#one-sample-estimation-of-mean",
    "href": "chap9.html#one-sample-estimation-of-mean",
    "title": "Applied Survival Analysis",
    "section": "One-Sample Estimation of Mean",
    "text": "One-Sample Estimation of Mean\n\n\nObserved data \\[\\begin{equation}\\label{eq:rec:obs}\n\\{N_i(\\cdot), C_i, Z_i\\},\\hspace{10mm}i=1,\\ldots, n\n\\end{equation}\\]\n\n\\(N(t)=N^*(t\\wedge C)\\); \\(C\\): independent censoring time\nNo terminal event like death \\(\\to\\) \\(C\\) always observed\n\n\n\n\n\nNelsen-Aalen-type estimator for mean \\[\n\\hat\\mu(t)=\\int_0^t\\frac{\\sum_{i=1}^n\\dd N_i(u)}{\\sum_{i=1}^n I(C_i\\geq u)}\n\\]\n\n\\(\\hat\\mu(t)\\to \\int_0^t\\frac{E\\{\\dd N(u)\\}}{\\pr(C\\geq u)}=\\int_0^t\\frac{\\pr(C\\geq u)E\\{\\dd N^*(u)\\}}{\\pr(C\\geq u)}=\\int_0^t r(u)\\dd u=\\mu(t)\\)"
  },
  {
    "objectID": "chap9.html#proportional-intensity-andersen-gill",
    "href": "chap9.html#proportional-intensity-andersen-gill",
    "title": "Applied Survival Analysis",
    "section": "Proportional Intensity (Andersen-Gill)",
    "text": "Proportional Intensity (Andersen-Gill)\n\n\nThree classes of models (handle correlations)\n\nProportional intensity (by time-varying covariates)\nShared frailty (by subject-specific frailty)\nProportional rates (by robust inference)\n\n\n\n\n\nProportional intensity (Andersen & Gill, 1982) \\[\\begin{equation}\\label{eq:rec:AG_model}\nE\\{\\dd N^*(t)\\mid \\overline N^*(t-), \\overline Z(t)\\}=\\exp\\left\\{\\beta^\\T Z(t)\\right\\}\\dd\\mu_0(t)\n\\end{equation}\\]\n\n\\(\\beta\\): log-intensity (risk) ratio\nDependence on past events fully explained by \\(Z(t)\\) (modulated Poisson)\n\nDefine \\(Z(t)\\) to summarize \\(\\overline N^*(t-)\\), e.g., \\(N^*(t-)\\): number of past events\nComplicates causal interpretation in randomized trials"
  },
  {
    "objectID": "chap9.html#andersen-gill-cox-extension",
    "href": "chap9.html#andersen-gill-cox-extension",
    "title": "Applied Survival Analysis",
    "section": "Andersen-Gill: Cox Extension",
    "text": "Andersen-Gill: Cox Extension\n\n\nEstimation and inference\n\nSame as Cox model with (internal) time-varying covariates\nPartial-likelihood score \\[\\begin{equation}\\label{eq:rec:score}\nU_n(\\beta)=n^{-1}\\sum_{i=1}^n\\int_0^\\infty \\left\\{Z_i(t)- \\frac{\\sum_{j=1}^n I(C_j\\geq t)Z_j(t)\\exp\\{\\beta^\\T Z_j(t)\\}}{\\sum_{j=1}^n I(C_j\\geq t)\\exp\\{\\beta^\\T Z_j(t)\\}}\n\\right\\}\\dd N_i(t)\n\\end{equation}\\]\n\nFull martingale properties\n\nBreslow estimator \\[\\begin{equation}\\label{eq:rec:breslow}\n\\hat\\mu_0(t)=\\int_0^t\\frac{\\sum_{i=1}^n\\dd N_i(u)}{\\sum_{i=1}^n I(C_i\\geq u)\\exp\\left\\{\\hat\\beta^\\T Z_i(u)\\right\\}}\n\\end{equation}\\]"
  },
  {
    "objectID": "chap9.html#shared-frailty-proportional-intensity",
    "href": "chap9.html#shared-frailty-proportional-intensity",
    "title": "Applied Survival Analysis",
    "section": "Shared-Frailty Proportional Intensity",
    "text": "Shared-Frailty Proportional Intensity\n\n\nFrailty-conditioned intensity \\[\\begin{equation}\\label{eq:rec:frailty_model}\nE\\{\\dd N^*(t)\\mid \\xi, \\overline N^*(t-), \\overline Z(t)\\}=\\xi\\exp\\{\\beta^\\T Z(t)\\}\\dd\\mu_0(t)\n\\end{equation}\\]\n\n\\(\\xi\\): subject-specific frailty to capture within-subject correlation\n\\(Z(t)\\): no need to capture elements of \\(\\overline N^*(t-)\\)\n\\(\\beta\\): subject-level log-intensity (risk) ratio\n\n\n\n\n\nEstimation and inference\n\nEM algorithm treating \\(\\xi\\) as missing data\nM-step: weighted partial-likelihood and Breslow estimator"
  },
  {
    "objectID": "chap9.html#marginal-proportional-rates-lwyy",
    "href": "chap9.html#marginal-proportional-rates-lwyy",
    "title": "Applied Survival Analysis",
    "section": "Marginal Proportional Rates (LWYY)",
    "text": "Marginal Proportional Rates (LWYY)\n\n\nProportion rates (Lin, Wei, Yang & Ying, 2000; LWYY) \\[\\begin{equation}\\label{eq:rec:rate_pr}\nE\\{\\dd N^*(t)\\mid \\overline Z(t)\\}=\\exp\\{\\beta^\\T Z(t)\\}\\dd\\mu_0(t)\n\\end{equation}\\]\n\nModeling marginal rate rather than intensity\nBaseline \\(Z\\) \\(\\to\\) proportional means model \\[\\begin{equation}\\label{eq:rec:rate_pm}\nE\\{N^*(t)\\mid Z\\}=\\exp(\\beta^\\T Z)\\mu_0(t)\n\\end{equation}\\]\n\n\\(Z = 1, 0\\): treated experience \\(\\exp(\\beta)\\) as many events as untreated\n\n\n\n\n\n\nEstimation and inference\n\nPartial-likelihood score as estimating function (same estimates as AG)\nRobust (sandwich) variance (different \\(\\se\\) than AG)"
  },
  {
    "objectID": "chap9.html#software-survivalcoxph-i",
    "href": "chap9.html#software-survivalcoxph-i",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::coxph() (I)",
    "text": "Software: survival::coxph() (I)\n\n\nInput data format\n\n\ncgd\n# id tstart tstop status   treat    sex age height weight   inherit \n#   1      0   219      1  rIFN-g female  12  147.0   62.0 autosomal\n#   1    219   373      1  rIFN-g female  12  147.0   62.0 autosomal\n#   1    373   414      0  rIFN-g female  12  147.0   62.0 autosomal\n#   2      0     8      1 placebo   male  15  159.0   47.5 autosomal\n#...\n\n\n\n\nProportional intensity (Andersen-Gill)\n\n(start, stop): time period between previous and current events\nNo need for subject id as correlation presumably captured by covariates\n\n\n\n\ncoxph(Surv(start, stop, status) ~ covariates)"
  },
  {
    "objectID": "chap9.html#software-survivalcoxph-ii",
    "href": "chap9.html#software-survivalcoxph-ii",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::coxph() (II)",
    "text": "Software: survival::coxph() (II)\n\n\nShared-frailty proportional intensity\n\nSubject id for frailty\n\n\n\n\n# Gamma frailty\ncoxph(Surv(start, stop, status) ~ covariates + \n        frailty(id, distribution = \"gamma\"))\n\n\n\n\n\nProportional rates/means (LWYY)\n\nSubject id for empirical evaluation of clustering\nUse se2 in results for robust standard error\n\n\n\n\ncoxph(Surv(start, stop, status) ~ covariates + cluster(id))"
  },
  {
    "objectID": "chap9.html#study-background",
    "href": "chap9.html#study-background",
    "title": "Applied Survival Analysis",
    "section": "Study Background",
    "text": "Study Background\n\n\nStudy information\n\nPopulation: a placebo-controlled randomized trial on 128 Chronic Granulomatous Disease (CGD) patients\nAim: evaluate effect of gamma interferon on incidence of repeated CGD infections\nBaseline risk factors\n\ntreatment (treat; rIFN-g vs placebo)\nsex (sex)\nage (age; years)\npattern of inheritance (inherit; autosomal recessive or X-linked)\nuse of steroids (steroids; Yes/No)\nuse of prophylactic antibiotics (propylac; Yes/No)"
  },
  {
    "objectID": "chap9.html#regression-results-i",
    "href": "chap9.html#regression-results-i",
    "title": "Applied Survival Analysis",
    "section": "Regression Results (I)",
    "text": "Regression Results (I)\n\n\nFit three multiplicative models\n\n\n# Andersen-Gill model\nobj_AG &lt;- coxph(Surv(tstart, tstop, status) ~ treat + sex + age + \n                  inherit + steroids + propylac, data = cgd)\n# Frailty model\nobj_frail &lt;- coxph(Surv(tstart, tstop, status) ~ treat + sex + age + \n                     inherit + steroids + propylac + \n                     frailty(id, distribution = \"gamma\"), data = cgd)\n# Proportional mean model (LWYY) - recommended\nobj_pm &lt;- coxph(Surv(tstart, tstop, status) ~ treat + sex + age + \n                  inherit + steroids + propylac + cluster(id), data = cgd)\nsummary(obj_pm)\n#                 coef exp(coef) se(coef) robust se      z Pr(&gt;|z|)    \n# treatrIFN-g -1.05140   0.34945  0.26500   0.31031 -3.388 0.000703 ***\n# sexmale      0.72832   2.07159  0.39044   0.43676  1.668 0.095405 .  \n# ..."
  },
  {
    "objectID": "chap9.html#regression-results-ii",
    "href": "chap9.html#regression-results-ii",
    "title": "Applied Survival Analysis",
    "section": "Regression Results (II)",
    "text": "Regression Results (II)\n\n\nLWYY (recommended)\n\nPatients treated by gamma interferon on average experience \\(\\exp(-1.051) = 35.0\\%\\) as many infections as those taking placebo (\\(p\\)-value 0.001)"
  },
  {
    "objectID": "chap9.html#prediction-of-mean-frequency",
    "href": "chap9.html#prediction-of-mean-frequency",
    "title": "Applied Survival Analysis",
    "section": "Prediction of Mean Frequency",
    "text": "Prediction of Mean Frequency\n\n\nLWYY (recommended)"
  },
  {
    "objectID": "chap9.html#modeling-choices",
    "href": "chap9.html#modeling-choices",
    "title": "Applied Survival Analysis",
    "section": "Modeling Choices",
    "text": "Modeling Choices\n\n\nMultivariate times\n\nTotal times: Time from beginning (randomization) to event \\[T_1 &lt; T_2 &lt; T_3 &lt; \\cdots \\]\nGap times: Time from last to current event \\[\nU_1 = T_1,\\,\\, U_2 = T_2 - T_1,\\,\\, U_3 = T_3 - T_2,\\,\\, \\ldots\n\\]\n\n\n\n\n\nThree classes of models\n\nMarginal total times (Wei, Lin, and Weissfeld, 1989; WLW)\nConditional total times (Prentice, Williams, and Peterson, 1981; PWP-TT)\nGap times (Prentice, Williams, and Peterson, 1981; PWP-GT)"
  },
  {
    "objectID": "chap9.html#marginal-total-times-wlw",
    "href": "chap9.html#marginal-total-times-wlw",
    "title": "Applied Survival Analysis",
    "section": "Marginal Total Times (WLW)",
    "text": "Marginal Total Times (WLW)\n\n\nModel specification \\[\\begin{equation}\\label{eq:rec:wlw}\n\\pr(t\\leq T_k&lt;t+\\dd t\\mid T_k\\geq t, Z)=\\exp(\\beta_k^\\T Z)\\dd\\Lambda_{k0}(t)\n\\end{equation}\\]\n\nMarginal Cox model for multivariate failure times \\(T_1&lt; \\ldots&lt; T_K\\)\n\\(\\beta_k\\): population-averaged log-hazard ratio for \\(k\\)th occurence\n\nCan constrain \\(\\beta_1=\\cdots=\\beta_K\\)\n\nRobust variance to account for correlation\n\n\n\n\n\nSoftware:\n\norder: \\(k\\)\n\n\n# WLW\ncoxph(Surv(stop, status) ~ covariates * strata(order) + cluster(id))"
  },
  {
    "objectID": "chap9.html#conditional-total-times-pwp-tt",
    "href": "chap9.html#conditional-total-times-pwp-tt",
    "title": "Applied Survival Analysis",
    "section": "Conditional Total Times (PWP-TT)",
    "text": "Conditional Total Times (PWP-TT)\n\n\nModel specification \\[\\begin{equation}\\label{eq:rec:pwp_tt}\n\\pr(t\\leq T_k&lt;t+\\dd t\\mid T_{k-1}&lt;t\\leq T_k, Z)=\\exp(\\beta^\\T Z)\\dd\\Lambda_{k0}(t)\n\\end{equation}\\]\n\nRationale: subject at risk for \\(k\\)th event only after experiencing the \\((k-1)\\)th\n\\(\\beta_k\\): log-hazard ratio among those at risk for \\(k\\) event\nRobust variance to account for correlation\n\n\n\n\n\nSoftware:\n\n\n# PWP-TT\ncoxph(Surv(start, stop, status) ~ covariates * strata(order) + cluster(id))"
  },
  {
    "objectID": "chap9.html#conditional-gap-times-pwp-gt",
    "href": "chap9.html#conditional-gap-times-pwp-gt",
    "title": "Applied Survival Analysis",
    "section": "Conditional Gap Times (PWP-GT)",
    "text": "Conditional Gap Times (PWP-GT)\n\n\nModel specification \\[\\begin{equation}\\label{eq:rec:pwp_gt}\n\\pr(t\\leq U_k&lt;t+\\dd t\\mid U_k\\geq t, Z)=\\exp(\\beta_k^\\T Z)\\dd\\Lambda_{k0}(t).\n\\end{equation}\\]\n\nA gap-time model: reset clock upon experiencing an event\n\nMarginal Cox model for multivariate failure times \\(U_1, \\ldots, U_K\\)\n\n\\(\\beta_k\\): log-hazard ratio for \\(k\\)th gap time\nRobust variance to account for correlation\n\n\n\n\n\nSoftware:\n\ngtime: stop - start (\\(U_k\\))\n\n\n# PWP-GT\ncoxph(Surv(gtime, status) ~ covariates * strata(order) + cluster(id))"
  },
  {
    "objectID": "chap9.html#notes-i",
    "href": "chap9.html#notes-i",
    "title": "Applied Survival Analysis",
    "section": "Notes (I)",
    "text": "Notes (I)\n\nLWYY (Lin, Wei, Yang & Ying, 2000)\n\nEarly explorations: Pepe and Cai (1993), Lawless and Nadeau (1995), Lawless et al. (1997)\n\nPWP (Prentice, Williams, and Peterson, 1981)\n\nOriginal version conditioned on event history\nRobust versions are presented here"
  },
  {
    "objectID": "chap9.html#notes-ii",
    "href": "chap9.html#notes-ii",
    "title": "Applied Survival Analysis",
    "section": "Notes (II)",
    "text": "Notes (II)\n\nParametric models\n\nPoisson regression\n\n\nglm(count ~ covariates + offset(log(follow_up)), family = poisson)\n\n\nZero-inflated Poisson\n\n\npscl::zeroinfl(count ~ \n                  covariates1 + offset(log(follow_up))  # Poisson sub-model\n                | covariates2 # Logistic sub-model for excess zeros\n              )\n\n\nNegative binomial\n\n\nMASS::glm.nb(count ~ covariates + offset(log(follow_up)))"
  },
  {
    "objectID": "chap9.html#summary-i",
    "href": "chap9.html#summary-i",
    "title": "Applied Survival Analysis",
    "section": "Summary (I)",
    "text": "Summary (I)\n\nProportional intensity (Andersen-Gill)\n\nHandles correlation by (internal) time-varying covariates\ncoxph(Surv(start, stop, status) ~ covariates)\n\nShared-frailty\n\nHandles correlation by subject-level frailty\ncoxph(Surv(start, stop, status) ~ covariates + frailty(id, distribution = \"gamma\"))\n\nProportional rates (LWYY) - recommended\n\nHandles correlation empirically via robust variance\ncoxph(Surv(start, stop, status) ~ covariates + cluster(id))"
  },
  {
    "objectID": "chap9.html#summary-ii",
    "href": "chap9.html#summary-ii",
    "title": "Applied Survival Analysis",
    "section": "Summary (II)",
    "text": "Summary (II)\n\nMultivariate approaches\n\nMarginal total times (WLW)\nConditional total times (PWP-TT)\nGap times (PWP-GT)\nSoftware: reorganize/transform data and tweak coxph() for multiple failure times"
  },
  {
    "objectID": "chap9.html#cgd-study-multivariate-perspective",
    "href": "chap9.html#cgd-study-multivariate-perspective",
    "title": "Applied Survival Analysis",
    "section": "CGD Study: Multivariate Perspective",
    "text": "CGD Study: Multivariate Perspective\n\n\nTreatment effects on different occurrences"
  },
  {
    "objectID": "chap9.html#notes-iii",
    "href": "chap9.html#notes-iii",
    "title": "Applied Survival Analysis",
    "section": "Notes (III)",
    "text": "Notes (III)\n\nCook and Lawless (2007)"
  },
  {
    "objectID": "chap9.html#descriptive-outcomes",
    "href": "chap9.html#descriptive-outcomes",
    "title": "Applied Survival Analysis",
    "section": "Descriptive Outcomes",
    "text": "Descriptive Outcomes\n\n\nInfection counts"
  },
  {
    "objectID": "chapter9.html#r-code",
    "href": "chapter9.html#r-code",
    "title": "Chapter 9 - Recurrent Events",
    "section": "R Code",
    "text": "R Code\n\n\nShow the code\n###############################################################################\n# Chapter 9 R Code\n#\n# This script reproduces all major numerical results in Chapter 9, including:\n#   1. Andersen-Gill Model for recurrent events (Chronic Granulomatous Disease)\n#   2. Frailty model vs. Proportional Means model (Chronic Granulomatous Disease)\n#   3. Multivariate approaches (WLW, PWP models)\n#   4. Poisson, Negative Binomial, and Zero-Inflated Poisson regressions\n###############################################################################\n\nlibrary(survival)\nlibrary(tidyverse)\nlibrary(gtsummary)\nlibrary(knitr)\nlibrary(patchwork)\n\n#==============================================================================\n# (A) Andersen-Gill/Frailty/LWYY Model for Recurrent Infections (CGD Data)\n#==============================================================================\n#------------------------------------------------------------------------------\n# 1. Read the Chronic Granulomatous Disease (CGD) Data\n#    in Counting Process Format\n#------------------------------------------------------------------------------\ncgd &lt;- read.table(\"Data\\\\Chronic Granulomatous Disease Study\\\\cgd_counting.txt\")\nhead(cgd)\n\n#------------------------------------------------------------------------------\n# 2. Andersen-Gill Model\n#------------------------------------------------------------------------------\nobj_AG &lt;- coxph(\n  Surv(tstart, tstop, status) ~ treat + sex + age + inherit + steroids + propylac,\n  data = cgd\n)\n\nsummary(obj_AG)\n\n# Residuals\ncox.zph(obj_AG)\nresiduals(obj_AG, type = \"martingale\", collapse = cgd$id)\n\n#------------------------------------------------------------------------------\n# 3. Frailty Model\n#------------------------------------------------------------------------------\nobj_frail &lt;- coxph(\n  Surv(tstart, tstop, status) ~ treat + sex + age + inherit + steroids + propylac +\n    frailty(id, distribution = \"gamma\"),\n  data = cgd\n)\nsummary(obj_frail)\n\n#------------------------------------------------------------------------------\n# 4. Proportional Means Model (LWYY)\n#------------------------------------------------------------------------------\nobj_pm &lt;- coxph(\n  Surv(tstart, tstop, status) ~ treat + sex + age + inherit + steroids + propylac +\n    cluster(id),\n  data = cgd\n)\nsummary(obj_pm)\n\n#------------------------------------------------------------------------------\n# 5. Extract Coefficients for Table 9.2\n#------------------------------------------------------------------------------\ncoeff_AG    &lt;- summary(obj_AG)$coeff\ncoeff_frail &lt;- summary(obj_frail)$coeff\ncoeff_pm    &lt;- summary(obj_pm)$coeff\n\n# Andersen-Gill\nc1 &lt;- coeff_AG[, 1]  # beta\nc2 &lt;- coeff_AG[, 3]  # se(beta)\nc3 &lt;- coeff_AG[, 5]  # p-value\n\n# Frailty\nc4 &lt;- coeff_frail[1:6, 1] # beta\nc5 &lt;- coeff_frail[1:6, 2] # se(beta)\nc6 &lt;- coeff_frail[1:6, 6] # p-value\n\n# Proportional Means\nc7 &lt;- coeff_pm[1:6, 1]    # beta\nc8 &lt;- coeff_pm[1:6, 4]    # se(beta)\nc9 &lt;- coeff_pm[1:6, 6]    # p-value\n\n# Print Table 9.1 (beta, se, p-values)\nnoquote(round(cbind(c1, c2, c3, c4, c5, c6, c7, c8, c9), 3))\n\n\n#==============================================================================\n# (B) Figure 9.4: Predicted Mean Functions by Treatment\n#==============================================================================\n# Predicted mean number of infections using Proportional Means model\n#------------------------------------------------------------------------------\n\n# 1. Extract Beta and Baseline Mean Function\nbeta &lt;- obj_pm$coefficients\nLt   &lt;- basehaz(obj_pm, centered = FALSE)\nt    &lt;- Lt$time\nmu0  &lt;- Lt$hazard  # baseline mean function mu0(t)\n\n# 2. Covariate Profiles\n# For \"female\" patient: (sex=0, age=12, inherit=X-linked=1, steroids=1, propylac=1)\n# Actually from the code: sex=1 means female, so we can check carefully:\n# code snippet suggests c(0, 12, 1, 1, 1) are the covariates besides treatment, \n# so treat=0 or 1 is appended in front.\nzf &lt;- c(0, 12, 1, 1, 1)\n\n# For \"male\" patient: (sex=1, age=12, etc.)\nzm &lt;- c(1, 12, 1, 1, 1)\n\n# 3. Construct Mean Functions\n# female: treat=1 or treat=0\nmu.f.trt   &lt;- exp(sum(c(1, zf) * beta)) * mu0\nmu.f.contr &lt;- exp(sum(c(0, zf) * beta)) * mu0\n\n# male: treat=1 or treat=0\nmu.m.trt   &lt;- exp(sum(c(1, zm) * beta)) * mu0\nmu.m.contr &lt;- exp(sum(c(0, zm) * beta)) * mu0\n\n# 4. Plot\npar(mfrow = c(1, 2))\n\n# Female\nplot(\n  t / 30.5, mu.f.trt,\n  type  = \"s\",\n  xlim  = c(0, 12),\n  ylim  = c(0, 6),\n  frame.plot = FALSE,\n  lty   = 1,\n  main  = \"Female\",\n  xlab  = \"Time (months)\",\n  ylab  = \"Mean number of infections\",\n  lwd   = 2\n)\nlines(t / 30.5, mu.f.contr, lty = 3, lwd = 2)\n\n# Male\nplot(\n  t / 30.5, mu.m.trt,\n  type  = \"s\",\n  xlim  = c(0, 12),\n  ylim  = c(0, 6),\n  frame.plot = FALSE,\n  lty   = 1,\n  main  = \"Male\",\n  xlab  = \"Time (months)\",\n  ylab  = \"Mean number of infections\",\n  lwd   = 2\n)\nlines(t / 30.5, mu.m.contr, lty = 3, lwd = 2)\n\n\n#==============================================================================\n# (C) Multivariate Approaches (WLW, PWP Models)\n#==============================================================================\ncgd_mul &lt;- cgd %&gt;%\n  arrange(id, tstart) %&gt;%\n  group_by(id) %&gt;%\n  mutate(\n    order = row_number(),\n    gtime = tstop - tstart,\n    .after = tstop\n  ) %&gt;%\n  ungroup()\n\n\n#------------------------------------------------------------------------------\n# 1. WLW Model\n#------------------------------------------------------------------------------\nwlw_obj &lt;- coxph(\n  Surv(tstop, status) ~ (treat + sex + age) * strata(order),\n  data = cgd_mul %&gt;% filter(order &lt;= 3)\n)\n\nwlw_obj0 &lt;- coxph(\n  Surv(tstop, status) ~ (treat + sex + age) + strata(order),\n  data = cgd_mul\n)\n\n#------------------------------------------------------------------------------\n# 2. PWP-TT Model\n#   (Time since trial entry)\n#------------------------------------------------------------------------------\npwp_tt_obj &lt;- coxph(\n  Surv(tstart, tstop, status) ~ (treat + sex + age) * strata(order),\n  data = cgd_mul %&gt;% filter(order &lt;= 3)\n)\n\npwp_tt_obj0 &lt;- coxph(\n  Surv(tstart, tstop, status) ~ (treat + sex + age) + strata(order),\n  data = cgd_mul\n)\n\n#------------------------------------------------------------------------------\n# 3. PWP-GT Model\n#   (Gap time between events)\n#------------------------------------------------------------------------------\npwp_gt_obj &lt;- coxph(\n  Surv(gtime, status) ~ (treat + sex + age) * strata(order),\n  data = cgd_mul %&gt;% filter(order &lt;= 3)\n)\n\npwp_gt_obj0 &lt;- coxph(\n  Surv(gtime, status) ~ (treat + sex + age) + strata(order),\n  data = cgd_mul\n)\n\n#------------------------------------------------------------------------------\n# 4. Tabulate Treatment Effect HR (95% CI) & p-values\n#------------------------------------------------------------------------------\ntrt_hr_mul &lt;- function(obj, obj0, p, K, r = 2) {\n  # p = # of covariates (including treatment)\n  # K = # of strata (or repeated events)\n  \n  beta &lt;- obj$coefficients\n  var  &lt;- obj$var\n  \n  beta_trt &lt;- numeric(p + 1)\n  var_trt  &lt;- numeric(p + 1)\n  \n  # event #1\n  beta_trt[1] &lt;- beta[1]\n  var_trt[1]  &lt;- var[1, 1]\n  \n  # subsequent events\n  for (j in 2:K) {\n    beta_trt[j] &lt;- beta[1] + beta[p + j - 1]\n    var_trt[j]  &lt;- var[1, 1] +\n                   var[p + j - 1, p + j - 1] +\n                   2 * var[1, p + j - 1]\n  }\n  \n  # Overall\n  beta_trt[p + 1] &lt;- obj0$coefficients[1]\n  var_trt[p + 1]  &lt;- obj0$var[1, 1]\n  \n  se_trt &lt;- sqrt(var_trt)\n  za     &lt;- qnorm(0.975)\n  \n  tibble(\n    HR = str_c(\n      round(exp(beta_trt), r), \" (\",\n      round(exp(beta_trt - za * se_trt), r), \", \",\n      round(exp(beta_trt + za * se_trt), r), \")\"\n    ),\n    P  = round(1 - pchisq((beta_trt / se_trt)^2, df = 1), 3)\n  )\n}\n\n# Example usage:\n# For demonstration, we pick the WLW objects:\n# trt_hr_mul(wlw_obj, wlw_obj0, p = 3, K = 3)\n\n# Collect relevant data\nN &lt;- cgd_mul %&gt;%\n  filter(order == 1) %&gt;%\n  count(treat) %&gt;%\n  pull(n)\n\nrow_header &lt;- cgd_mul %&gt;%\n  filter(status == 1) %&gt;%\n  count(treat, order) %&gt;%\n  filter(order &lt;= 3) %&gt;%\n  pivot_wider(values_from = n, names_from = treat) %&gt;%\n  mutate(order = as.character(order)) %&gt;%\n  add_row(\n    order   = \"All\",\n    placebo = cgd_mul %&gt;% filter(treat == \"placebo\", status == 1) %&gt;% count() %&gt;% pull(),\n    `rIFN-g`= cgd_mul %&gt;% filter(treat == \"rIFN-g\", status == 1) %&gt;% count() %&gt;% pull()\n  ) %&gt;%\n  mutate(\n    placebo = str_c(placebo, \" (\", round(100 * placebo / N[1], 1), \"%)\"),\n    `rIFN-g`= str_c(`rIFN-g`, \" (\", round(100 * `rIFN-g` / N[2], 1), \"%)\")\n  ) %&gt;%\n  select(order, `rIFN-g`, placebo)\n\n# Build table for WLW, PWP-TT, PWP-GT\nwlw_HR    &lt;- trt_hr_mul(wlw_obj,    wlw_obj0,    3, 3)$HR\npwpTT_HR  &lt;- trt_hr_mul(pwp_tt_obj, pwp_tt_obj0, 3, 3)$HR\npwpGT_HR  &lt;- trt_hr_mul(pwp_gt_obj, pwp_gt_obj0, 3, 3)$HR\n\n# Create table\ncgd_tab &lt;- row_header %&gt;%\n  add_column(\n    WLW      = wlw_HR,\n    `PWP-TT` = pwpTT_HR,\n    `PWP-GT` = pwpGT_HR\n  )\n\n# Print table\ncgd_tab \n# Example to create a LaTeX table:\n# cgd_tab %&gt;%\n#   kable(\"latex\")\n\n#------------------------------------------------------------------------------\n# 5. Forest Plot of Treatment Hazard Ratios\n#------------------------------------------------------------------------------\nhr_ci_parse &lt;- function(x) {\n  separate_wider_regex(\n    x,\n    patterns = c(x = \".+\", \" \\\\(\", xmin = \".+\", \", \", xmax = \".+\", \"\\\\)\")\n  )\n}\n\ncgd_models &lt;- cgd_tab %&gt;%\n  separate_wider_regex(\n    WLW:`PWP-GT`,\n    patterns  = c(x = \".+\", \" \\\\(\", xmin = \".+\", \", \", xmax = \".+\", \"\\\\)\"),\n    names_sep = \"_\"\n  ) %&gt;%\n  mutate(across(!c(order:placebo), as.numeric)) %&gt;%\n  pivot_longer(\n    !c(order:placebo),\n    names_to  = c(\"Model\", \".value\"),\n    names_sep = \"_\"\n  )\n\ncgd_models %&gt;%\n  ggplot(aes(x = x, y = order)) +\n  geom_point(aes(size = (order == \"All\"))) +\n  geom_linerange(aes(xmin = xmin, xmax = xmax, linewidth = (order == \"All\"))) +\n  geom_vline(xintercept = 1, linetype = 2) +\n  facet_wrap(~ fct(Model), ncol = 3) +\n  scale_y_discrete(\n    \"Infection\",\n    limits = rev(c(\"1\", \"2\", \"3\", \"All\")),\n    labels = rev(c(\"1st\", \"2nd\", \"3rd\", \"All\"))\n  ) +\n  scale_x_log10(\"Treatment hazard ratio (95% CI)\") +\n  scale_size_manual(values = c(1.5, 2)) +\n  scale_linewidth_manual(values = c(0.5, 0.8)) +\n  theme_minimal() +\n  theme(\n    axis.text        = element_text(size = 10),\n    axis.title       = element_text(size = 11),\n    panel.grid       = element_blank(),\n    strip.text       = element_text(size = 11),\n    legend.position  = \"none\"\n  )\n\n# ggsave(\"rec_cgd_forest.pdf\", width = 8, height = 4.5)\n# ggsave(\"rec_cgd_forest.eps\", width = 8, height = 4.5)\n\n\n#==============================================================================\n# (D) Poisson / Negative Binomial / Zero-Inflated Poisson Regressions\n#==============================================================================\nlibrary(MASS)\nlibrary(pscl)\n\n#------------------------------------------------------------------------------\n# 1. Flatten Data for One-Row-per-Subject\n#------------------------------------------------------------------------------\ndf_events &lt;- cgd %&gt;%\n  group_by(id) %&gt;%\n  mutate(\n    count      = sum(status),   # total # events for subject\n    follow_up  = max(tstop)     # maximum 'tstop' is censoring time\n  ) %&gt;%\n  distinct(id, .keep_all = TRUE)\n\n#------------------------------------------------------------------------------\n# 2. Poisson Regression\n#------------------------------------------------------------------------------\nps_obj &lt;- glm(\n  count ~ treat + age + sex + offset(log(follow_up)),\n  family = poisson(link = \"log\"),\n  data = df_events\n)\nsummary(ps_obj)\n\n#------------------------------------------------------------------------------\n# 3. Negative Binomial Regression\n#------------------------------------------------------------------------------\nnb_obj &lt;- MASS::glm.nb(\n  count ~ treat + age + sex + offset(log(follow_up)),\n  data = df_events\n)\nsummary(nb_obj)\n\n#------------------------------------------------------------------------------\n# 4. Zero-Inflated Poisson (ZIP) Regression\n#------------------------------------------------------------------------------\nzip_model &lt;- zeroinfl(\n  count ~ treat + age + sex + offset(log(follow_up))  # Poisson part\n    | treat + age + sex,                              # Logistic part\n  data = df_events\n)\nsummary(zip_model)\n\nzip_model$coefficients\nzip_model$vcov",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 9 - Recurrent Events"
    ]
  },
  {
    "objectID": "chap8.html",
    "href": "chap8.html",
    "title": "Applied Survival Analysis",
    "section": "",
    "text": "Introduction to frailty models\nMultivariate Cox model with shared frailty\nExample: A multi-center lung cancer study\nMarginal models and robust inference\nExample: the diabetic retinopathy study\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\]"
  },
  {
    "objectID": "chapter9.html#chapter-summary",
    "href": "chapter9.html#chapter-summary",
    "title": "Chapter 9 - Recurrent Events",
    "section": "Chapter Summary",
    "text": "Chapter Summary\nWhen a subject (or system) can experience recurrent events (e.g., repeated hospitalizations, infections, or mechanical failures), standard univariate approaches (like focusing only on the first event) can be inefficient and miss valuable information. Instead, we can model these repeated occurrences via extended Cox-type methods.\n\nIntensity vs. rate functions\n\nIntensity function \\(\\ell\\{t \\mid \\overline{N}^*(t-)\\}\\): The instantaneous incidence of a new event at time \\(t\\) conditional on the entire past. Generalizes the hazard function from univariate survival.\nRate function \\(r(t)\\): The marginal incidence rate across the population. Bypasses specifying how past events affect current risk but does not fully specify the likelihood. Often paired with robust variance methods.\n\nPoisson processes are the simplest example (memoryless arrivals), but in practice, recurrent events often cluster, so more realistic models are needed.\n\n\nMultiplicative intensity/rate models\n\nAndersen–Gill model\nA direct extension of the Cox model that posits: \\[\n\\ell\\{t \\mid \\overline{N}^*(t-), \\overline{Z}(t)\\}\n\\;=\\;\n\\exp\\bigl\\{\\beta^\\mathsf{T}Z(t)\\bigr\\}\\,\\mathrm{d}\\mu_0(t).\n\\]\n\nInterpretation: The conditional risk of a new event depends only on the current covariates \\(Z(t)\\), not the event history (unless included in \\(Z(t)\\)).\n\nEstimation: Uses partial-likelihood scores analogous to Cox, with counting-process style risk sets.\n\nLimitation: If only baseline covariates are included, ignoring event history can be unrealistic; including post-baseline events or other time-varying covariates can confound inference about baseline effects.\n\n\n\nMultiplicative intensity frailty models\nIncorporate a random effect (frailty) \\(\\xi\\) to induce within-subject dependence: \\[\n\\ell\\{t \\mid \\xi, \\overline{N}^*(t-), \\overline{Z}(t)\\}\n\\;=\\;\n\\xi \\,\\exp\\bigl\\{\\beta^\\mathsf{T} Z(t)\\bigr\\}\\,\\mathrm{d}\\mu_0(t).\n\\]\n\nExample: Gamma frailty, letting \\(\\xi\\) follow a Gamma distribution with mean 1, variance \\(1/\\gamma\\).\n\nInterpretation: Covariate effects are subject-specific; \\(\\beta\\) reflects hazard ratios within each random-effect stratum.\nEstimation: Typically via EM algorithm.\n\n\n\nProportional rates/means (LWYY) model\nTargets the marginal rate: \\[\nr\\{t \\mid \\overline{Z}(t)\\}\n\\;=\\;\n\\exp\\bigl\\{\\beta^\\mathsf{T} Z(t)\\bigr\\}\\,\\mathrm{d}\\mu_0(t).\n\\]\n\nEstimation: Identical point estimates as Andersen–Gill, but with robust (sandwich) standard errors to account for unmodeled within-subject correlation.\n\nInterpretation: \\(\\beta\\) is the population-level effect on the rate (or mean) of recurrent events, simpler to interpret when focusing on an overall treatment effect.\n\n\n\n\nMultivariate approaches to total or gap times\nRather than modeling the entire counting process \\(N^*(t)\\) directly, one can treat the times \\(T_1&lt; T_2&lt; \\cdots\\) (or gap times \\(U_k=T_k - T_{k-1}\\)) as a multivariate survival problem:\n\nWLW model: Marginal hazard for each event order (1st, 2nd, etc.), ignoring the conditioning on previous events.\n\nPWP-TT: Condition on having experienced the \\((k-1)\\)th event, analyzing total times but only for those who reached event \\(k-1\\).\n\nPWP-GT: Condition similarly, but use gap times from one event to the next, resetting the time clock after each event.\n\nDiffering risk-set definitions imply differences in interpretation for later events. WLW models the overall population-level hazard for the \\(k\\)th event, while PWP approaches focus on conditional hazards for those who already had \\((k-1)\\) events.\n\n\nExample R code\nBelow are code snippets using R’s survival::coxph() to demonstrate fitting the three main classes of Cox-type recurrent event models. Suppose our data frame df is in a “counting process” format with columns:\n\nstart, stop: time interval boundaries for each event segment,\n\nstatus: event indicator (1 if the event occurred in that interval, 0 if censored),\n\nid: subject identifier,\n\nadditional covariates (e.g., x1, x2).\n\n\nlibrary(survival)\n########################\n# 1. Andersen–Gill model\n########################\n# Assumes any correlation among events is captured\n# entirely by the covariates in the model.\nfit_AG &lt;- coxph(\n  Surv(start, stop, status) ~ x1 + x2, \n  data = df\n)\n\n####################################\n# 2. Frailty model (Gamma frailty)\n####################################\n# Introduces a subject-specific random effect\nfit_frail &lt;- coxph(\n  Surv(start, stop, status) ~ x1 + x2\n    + frailty(id, distribution = \"gamma\"),\n  data = df\n)\n\n############################################\n# 3. Proportional rates/means (LWYY model)\n############################################\n# Uses robust variance to account for correlation;\n# point estimates match Andersen–Gill, but standard errors differ.\nfit_LWYY &lt;- coxph(\n  Surv(start, stop, status) ~ x1 + x2\n    + cluster(id),\n  data = df\n)\n\nFor multivariate approaches, we need to preprocess the data to include event order or gap times:\n\norder: event order (1st, 2nd, etc.),\ngtime: gap time from the previous event.\n\n\n##################################\n# WLW model\n##################################\n# 'stop' is the time to the kth event (or censor),\n# ignoring whether the (k-1)th event occurred.\nfit_wlw &lt;- coxph(\n  Surv(stop, status) ~ x1 + x2 * strata(order)\n    + cluster(id),\n  data = df\n)\n\n##################################\n# PWP-TT model\n##################################\n# 'start' is the time of (k-1)th event; 'stop' is kth event time.\nfit_pwp_tt &lt;- coxph(\n  Surv(start, stop, status) ~ x1 + x2 * strata(order)\n    + cluster(id),\n  data = df\n)\n\n##################################\n# PWP-GT model\n##################################\n# 'gtime' is the gap time from (k-1)th event to kth event.\n# Otherwise similar to WLW in usage.\nfit_pwp_gt &lt;- coxph(\n  Surv(gtime, status) ~ x1 + x2 * strata(order)\n    + cluster(id),\n  data = df\n)",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 9 - Recurrent Events"
    ]
  },
  {
    "objectID": "chapter9.html#conclusion",
    "href": "chapter9.html#conclusion",
    "title": "Chapter 9 - Recurrent Events",
    "section": "Conclusion",
    "text": "Conclusion\nRecurrent event data demand methods that move beyond standard univariate survival analysis:\n\nAndersen–Gill and frailty models specify conditional intensities, capturing event dependence through time-varying covariates or latent frailties.\n\nProportional rates/means approaches target marginal rates, using robust variances to adjust for within-subject correlations.\n\nMultivariate total/gap-time approaches view each recurrence as a separate component, applying extensions of the Cox model (WLW, PWP-TT, PWP-GT), each with different conditioning and interpretational nuances.\n\nThe choice among these frameworks depends on scientific aims (e.g., dynamic prediction vs. inference on treatment effect at baseline) and how one wishes to handle correlations induced by repeated occurrences. All, however, build on the Cox model’s core multiplicative form, ensuring familiar regression interpretations and flexible software implementations.",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 9 - Recurrent Events"
    ]
  },
  {
    "objectID": "chap10.html#outline",
    "href": "chap10.html#outline",
    "title": "Applied Survival Analysis",
    "section": "",
    "text": "Cause-specific hazard and cumulative incidence\nNon- and semi-parametric methods\nAnalysis of bone marrow transplantation study\nSemi-competing risks and examples\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\cc}{{\\rm c}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\]"
  },
  {
    "objectID": "chap10.html#definition-and-examples",
    "href": "chap10.html#definition-and-examples",
    "title": "Applied Survival Analysis",
    "section": "Definition and Examples",
    "text": "Definition and Examples\n\n\nCompeting risks\n\nDefinition: multiple types of failures, occurrence of one precludes others\n\nMultiple latent risks competing with each other for first occurrence\n\nExamples: different causes of death\n\n\n\n\n\nDefining feature\n\nOne failure per subject\nLess info than multivariate failure times\nImplications for analysis and interpretation"
  },
  {
    "objectID": "chap10.html#outcome-data-identifiability",
    "href": "chap10.html#outcome-data-identifiability",
    "title": "Applied Survival Analysis",
    "section": "Outcome Data & Identifiability",
    "text": "Outcome Data & Identifiability\n\n\nTarget of inference: \\((T, \\Delta)\\)\n\n\\(T\\): time to failure\n\\(\\Delta \\in \\{1, \\ldots, K\\}\\): type/cause of failure (categorical)\n\n\n\n\n\nMultivariate perspective\n\nA conceptual framework \\[\\begin{equation}\\label{eq:cmpr:mult}\nT=\\min(T_1,\\ldots, T_K) \\hspace{1mm}\\mbox{ and } \\hspace{1mm}\\Delta=\\arg\\min_{k=1,\\ldots, K} T_k\n\\end{equation}\\]\n\n\\(T_k\\): time to \\(k\\)th latent risk \\((k=1,\\ldots, K)\\) in absence of other risks\nCompeting risks \\(=\\) partially observed multivariate failure times\n\nIdentifiability: net distribution of latent \\(T_k\\) not recognizable from \\((T, \\Delta)\\)\n\nunless under unrealistic assumption of mutual independence of the \\(T_k\\)"
  },
  {
    "objectID": "chap10.html#two-approaches",
    "href": "chap10.html#two-approaches",
    "title": "Applied Survival Analysis",
    "section": "Two Approaches",
    "text": "Two Approaches\n\n\nTwo ways to characterize \\((T, \\Delta)\\)\n\nCause-specific hazard\nCumulative incidence (Sub-distribution)\n\n\n\n\n\nCause-specific hazard (CSH) \\[\\begin{equation}\\label{eq:cmpr:cs_hazard}\n    \\dd\\Lambda_k^\\cc(t)=\\pr(t\\leq T&lt;t+\\dd t, \\Delta=k\\mid T\\geq t)\n    \\end{equation}\\]\n\nInterpretation: instantaneous incidence of \\(k\\)th risk given overall “survival”\nExample: \\(\\dd\\Lambda_1^\\cc(t)=\\) incidence rate for CV death among survivors at \\(t\\)\n\n\\(k =1\\): CV death; \\(k =2\\): other causes of death\n\nOverall hazard: \\(\\dd\\Lambda(t)=\\pr(t\\leq T&lt;t+\\dd t \\mid T\\geq t) = \\sum_{k=1}^K \\dd\\Lambda_k^\\cc(t)\\)"
  },
  {
    "objectID": "chap10.html#cause-specific-hazard",
    "href": "chap10.html#cause-specific-hazard",
    "title": "Applied Survival Analysis",
    "section": "Cause-Specific Hazard",
    "text": "Cause-Specific Hazard\n\n\nLimitations\n\nThe cumulative CSH \\(\\Lambda_k^\\cc(t)\\) not a meaningful quantity\n\\(\\exp\\{-\\Lambda_k^\\cc(t)\\}\\) not a survival function of any kind\n\n\n\n\n\nCorrespondence with “net hazard”\n\nUnder (unrealistic) mutual independence of the latent \\(T_k\\)\nHazard of \\(T_k\\) identifiable and equal to \\(\\Lambda_k^\\cc(t)\\)\nNot recommended"
  },
  {
    "objectID": "chap10.html#cumulative-incidence",
    "href": "chap10.html#cumulative-incidence",
    "title": "Applied Survival Analysis",
    "section": "Cumulative Incidence",
    "text": "Cumulative Incidence\n\n\nCumulative incidence function (CIF) \\[\n    F_k(t)=\\pr(T\\leq t, \\Delta=k)\n    \\]\n\nInterpretation: probability of failure from \\(k\\)th risk in presence of other risks\nMarginal quantity, easy to interpret (a real-world probability)\n\\(F(t)=\\pr(T\\leq t) = \\sum_{k=1}^K F_k(t)\\) (sub-distribution functions)\n\n\n\n\n\nRelationship\n\nCSH in terms of CIF (for a particular risk, no one-to-one correspondence) \\[\\begin{equation}\\label{eq:cmpr:correspond}\n\\dd\\Lambda_k^\\cc(t)=\\frac{\\dd F_k(t)}{1-\\sum_{l=1}^K F_l(t-)}\n\\end{equation}\\]"
  },
  {
    "objectID": "chap10.html#csh-vs-cif",
    "href": "chap10.html#csh-vs-cif",
    "title": "Applied Survival Analysis",
    "section": "CSH vs CIF",
    "text": "CSH vs CIF\n\n\nExample: effect on CSH may not align with CIF\n\nTreatment: \\(\\Lambda_1^\\cc(t)=\\Lambda_2^\\cc(t)=3t\\)\nControl: \\(\\Lambda_1^\\cc(t)=2t\\) and \\(\\Lambda_2^\\cc(t)=t\\)"
  },
  {
    "objectID": "chap10.html#comparison-of-functions",
    "href": "chap10.html#comparison-of-functions",
    "title": "Applied Survival Analysis",
    "section": "Comparison of Functions",
    "text": "Comparison of Functions\n\nCSH vs net hazard vs CIF"
  },
  {
    "objectID": "chap10.html#observed-data",
    "href": "chap10.html#observed-data",
    "title": "Applied Survival Analysis",
    "section": "Observed Data",
    "text": "Observed Data\n\n\nA random \\(n\\)-sample \\[(X_i, \\delta_i, Z_i), \\,\\,\\, i=1,\\ldots, n\\]\n\n\\(X=T\\wedge C\\)\n\\(\\delta=\\Delta I(T\\leq C)\\) (0: censored; \\(k\\): observed \\(k\\)th risk, \\(k=1,\\ldots, K\\))\n\\(C\\): independent censoring time\n\\(Z\\): covariates\n\\(N_{ki}(t)=I(X_i\\leq t, \\delta_i=k)\\): Observed counting process for \\(k\\)th risk"
  },
  {
    "objectID": "chap10.html#cause-specific-hazard-models-i",
    "href": "chap10.html#cause-specific-hazard-models-i",
    "title": "Applied Survival Analysis",
    "section": "Cause-Specific Hazard Models (I)",
    "text": "Cause-Specific Hazard Models (I)\n\n\nProportional cause-specific hazards \\[\\begin{equation}\\label{eq:cmpr:ph_csh}\n\\pr(t\\leq T&lt;t+\\dd t, \\Delta=k\\mid T\\geq t, Z)=\\exp(\\beta_k^\\T Z)\\dd\\Lambda_{k0}(t)\n\\end{equation}\\]\n\nA model on “survivors” (those who have not failed from any risk)\n\\(\\beta_k\\): log-hazard ratios for \\(k\\)th risk in survivors\n\n\n\n\n\nEstimation\n\nPartial likelihood score for \\(k\\)th risk \\[\n  U_{nk}(\\beta_k)=\\Pn\\int_0^\\infty\\left\\{Z_i-\\frac{\\sum_{j=1}^n I(X_j\\geq t)Z_j\\exp(\\beta_k^\\T Z_j)}{\\sum_{j=1}^n I(X_j\\geq t)\\exp(\\beta_k^\\T Z_j)}\\right\\}\\dd N_{ki}(t)\n\\]\n\nEssentially treating non-\\(k\\) risks as censoring\nEasy to implement in survival::coxph() (status == k)"
  },
  {
    "objectID": "chap10.html#cause-specific-hazard-models-ii",
    "href": "chap10.html#cause-specific-hazard-models-ii",
    "title": "Applied Survival Analysis",
    "section": "Cause-Specific Hazard Models (II)",
    "text": "Cause-Specific Hazard Models (II)\n\n\nUnder (unrealistic) independence of the latent \\(T_k\\)\n\nProportional cause-specific hazards \\(\\Longleftrightarrow\\) proportional net hazards\nFrailty to relax independence\nNot recommended\n\nNon-identifiability\nNon-interpretability\n\n\n\n\n\n\nLog-rank test\n\nRisk-specific log-rank statisic with other risks treated as censoring\n“Kaplan-Meier” doesn’t work \\(\\to\\) estimand \\(\\exp\\{-\\Lambda_k^\\cc(t)\\}\\) is non-quantity\nCompeting-risks equivalent of KM is Gray (1988) estimator of \\(F_k(t)\\)"
  },
  {
    "objectID": "chap10.html#cif-nonparametric-estimation",
    "href": "chap10.html#cif-nonparametric-estimation",
    "title": "Applied Survival Analysis",
    "section": "CIF: Nonparametric Estimation",
    "text": "CIF: Nonparametric Estimation\n\n\nDecomposition of \\(F_k(t)\\) \\[\\begin{equation*}\n    \\dd F_k(t)=S(t-)\\dd\\Lambda_k^\\cc(t)\n\\end{equation*}\\]\n\n\\(S(t-)=\\pr(T\\geq t)\\): By KM estimator \\(\\hat S(t-)\\) for overall failure\n\\(\\dd\\Lambda_k^\\cc(t)\\): By Nelsen-Aalen estimator (non-\\(k\\) risks as censoring) \\[\n  \\dd\\hat\\Lambda_k^\\cc(t)=\\frac{\\sum_{i=1}^n\\dd N_{ki}(t)}{\\sum_{i=1}^n I(X_i\\geq t)}\n  \\]\n\n\n\n\n\nGray estimator \\[\\begin{equation*}\n    \\hat F_k(t)=\\int_0^t \\hat S(u-)\\dd\\hat \\Lambda_k^\\cc(u)\n\\end{equation*}\\]"
  },
  {
    "objectID": "chap10.html#cif-sub-distribution-hazard",
    "href": "chap10.html#cif-sub-distribution-hazard",
    "title": "Applied Survival Analysis",
    "section": "CIF: Sub-Distribution Hazard",
    "text": "CIF: Sub-Distribution Hazard\n\n\nSub-distribution hazard (SDH) \\[\\begin{equation}\\label{eq:cmpr:sdh}\n    \\dd\\Lambda_k(t)=\\pr(t\\leq T_k^*&lt;t+\\dd t\\mid T_k^*\\geq t)\n    \\end{equation}\\]\n\nTime to \\(k\\)th risk in presence of other risks \\[\nT_k^*=T\\cdot I(\\Delta=k)+\\infty\\cdot I(\\Delta\\neq k)\n\\]\n\n\\(F_k(t)=\\pr(T_k^*\\leq t)\\)\n\nInterpretation: incidence of \\(k\\)th risk given not failing from it\nEasier to work with hazard-like functions (unbounded)\nCorrespondence with CIF \\[\\begin{equation}\\label{eq:cmpr:subdist}\nF_k(t)=1-\\exp\\{-\\Lambda_k(t)\\}\n\\end{equation}\\]\nModel/test on SDH \\(\\Longleftrightarrow\\) Model/test on CIF"
  },
  {
    "objectID": "chap10.html#cif-grays-test",
    "href": "chap10.html#cif-grays-test",
    "title": "Applied Survival Analysis",
    "section": "CIF: Gray’s Test",
    "text": "CIF: Gray’s Test\n\n\nDiscrete version (\\(k\\)th risk) \\[\n\\dd\\Lambda_k(t)=\\frac{\\dd F_k(t)}{1-F_k(t-)}\n\\]\n\n\n\n\nLog-rank-type test\n\nTesting \\(H_0: F_{k1}(t)=F_{k0}(t)\\) \\[\\begin{equation}\\label{eq:cmpr:gray_tests}\n\\int_0^\\infty W_k(t)\\big\\{\\dd\\hat\\Lambda_{k1}(t)-\\dd\\hat\\Lambda_{k0}(t)\\big\\}\n\\end{equation}\\]\n\\(\\hat\\Lambda_{ka}(t)\\): Gray’s CIF plug-in estimator for SDH in group \\(a\\) \\((a=1, 0)\\)\n\\(W_k(t)\\): Weight function\nExtensions: multi-group, stratification, etc."
  },
  {
    "objectID": "chap10.html#cif-fine-gray-regression",
    "href": "chap10.html#cif-fine-gray-regression",
    "title": "Applied Survival Analysis",
    "section": "CIF: Fine-Gray Regression",
    "text": "CIF: Fine-Gray Regression\n\n\nProportional sub-distribution hazards (Fine and Gray, 1999) \\[\\begin{equation}\\label{eq:cmpr:fg}\n\\pr(t\\leq T_k^*&lt;t+\\dd t\\mid T_k^*\\geq t, Z)=\\exp(\\beta_k^\\T Z)\\dd\\Lambda_{k0}(t)\n  \\end{equation}\\]\n\n\\(\\beta_k\\): log-hazard ratios for \\(k\\)th risk in entire population (under other risks)\nEstimation and inference: partial-likelihood score with IPCW to address dependent censoring by other risks\n\n\n\n\n\nTarget populations\n\nCause-specific hazard: survivors\nSub-distribution hazard: all, including those who have failed from other causes"
  },
  {
    "objectID": "chap10.html#software-cmprkcuminc",
    "href": "chap10.html#software-cmprkcuminc",
    "title": "Applied Survival Analysis",
    "section": "Software: cmprk::cuminc()",
    "text": "Software: cmprk::cuminc()\n\n\nBasic syntax for Gray’s estimator & test\n\n\n\nobj &lt;- cuminc(ftime, fstatus, group, strata, rho = 0)\n\n\n\nInput\n\n(ftime, fstatus): \\((X, \\delta)\\)\ngroup: group variable (optional); strata: strata variable (optional)\nrho: \\(\\rho\\) in weight \\(W_k(t)=\\{1 - \\hat F_k(t)\\}^\\rho\\) (HF \\(G^\\rho\\) family)\n\nOutput: a list\n\nobj$Tests: tests results on each risk\nobj$\"a k\": CIF estimates for \\(k\\)th risk in group \\(a\\)\n\ntime: \\(t\\); est: \\(\\hat F_k(t)\\); var: \\(\\hat\\var\\{\\hat F_k(t)\\}\\)"
  },
  {
    "objectID": "chap10.html#software-cmprkcrr-i",
    "href": "chap10.html#software-cmprkcrr-i",
    "title": "Applied Survival Analysis",
    "section": "Software: cmprk::crr() (I)",
    "text": "Software: cmprk::crr() (I)\n\n\nBasic syntax for Fine-Gray model\n\n\n\nobj &lt;- crr(ftime, fstatus, cov1, failcode = k)\n\n\n\nInput\n\n(ftime, fstatus): \\((X, \\delta)\\); cov1: \\(Z\\)\nfailcode = k: models \\(k\\)th risk\n\n\n\n\n\nOutput: a list of class crr\n\nobj$coef: \\(\\hat\\beta_k\\); obj$var: \\(\\hat\\var(\\hat\\beta_k)\\)\nobj$uftime: \\(t\\); obj$bfitj: \\(\\dd\\hat\\Lambda_{k0}(t)\\)"
  },
  {
    "objectID": "chap10.html#software-cmprkcrr-ii",
    "href": "chap10.html#software-cmprkcrr-ii",
    "title": "Applied Survival Analysis",
    "section": "Software: cmprk::crr() (II)",
    "text": "Software: cmprk::crr() (II)\n\n\nPrediction of CIF by Fine-Gray model\n\nobj: a crr object for fit model\nz: new covariate data\n\n\n\n\n\n\n# --- Method 1: use predict.crr() \nobj_pred &lt;- predict(obj, z)\n\n# --- Method 2: manual calculation\nbeta &lt;- obj$coef\nLambda &lt;- cumsum(obj$bfitj)\ntime &lt;- obj$uftime\n## Calculate CIF based on FG model\ncif &lt;- 1- exp(- exp(sum(beta * z)) * Lambda)\n## Same as obj_pred from Method 1\nobj_pred &lt;- cbind(time, cif)"
  },
  {
    "objectID": "chap10.html#study-background",
    "href": "chap10.html#study-background",
    "title": "Applied Survival Analysis",
    "section": "Study Background",
    "text": "Study Background\n\nStudy information\n\nPopulation: 864 multiple-myeloma leukemia patients undergoing allo-HCT cell transplantation\nEndpoints: Time from surgery to treatment-related mortality (TRM; death in remission) or relapse of leukemia\nRisk factors\n\nCohort indicator (years 1995–2000 or 2001–2005)\nType of donor (unrelated or HLA-identical sibling)\nHistory of a prior transplant\nTime from diagnosis to transplantation (&lt;24 months, or ≥ 24 months)"
  },
  {
    "objectID": "chap10.html#study-data",
    "href": "chap10.html#study-data",
    "title": "Applied Survival Analysis",
    "section": "Study Data",
    "text": "Study Data\n\n\nData format\n\n\nhead(cibmtr)\n#&gt;    time status cohort donor hist wait\n#&gt; 1 0.010      2      1     1    1    1\n#&gt; 2 0.066      2      1     1    1    0\n#&gt; 3 0.099      1      1     1    1    1\n#&gt; ..."
  },
  {
    "objectID": "chap10.html#cif-by-donor-type",
    "href": "chap10.html#cif-by-donor-type",
    "title": "Applied Survival Analysis",
    "section": "CIF by Donor Type",
    "text": "CIF by Donor Type\n\nGray’s nonparametric estimates/tests of CIFs by donor type\n\n\nobj_cif &lt;- tidycmprsk::cuminc(Surv(time, status) ~ donor, data = df)\n\n# Print results\nobj_cif\n#&gt; --- cuminc() ----------------------------------------------------\n#&gt; ...\n#&gt; • Tests\n#&gt; outcome   statistic   df     p.value    \n#&gt; Relapse   17.3        1.00   &lt;0.001     \n#&gt; TRM       12.3        1.00   &lt;0.001"
  },
  {
    "objectID": "chap10.html#regression-analysis",
    "href": "chap10.html#regression-analysis",
    "title": "Applied Survival Analysis",
    "section": "Regression Analysis",
    "text": "Regression Analysis\n\n\nSemiparametric regression\n\nProportional cause-specific hazard\nProportional sub-distribution hazard (FG)\n\n\n\n# Change k\nk &lt;- 1\n#--- proportional cause-specific hazards -----------------------------\nobj.cs &lt;- coxph(Surv(time, status == k) ~ cohort + donor + hist + wait,\n                data = cibmtr)\n\n#--- Fine and Gray --------------------------------------------------\nobj.fg &lt;- crr(cibmtr$time, cibmtr$status, cibmtr[, 3:6], failcode = k)"
  },
  {
    "objectID": "chap10.html#regression-results",
    "href": "chap10.html#regression-results",
    "title": "Applied Survival Analysis",
    "section": "Regression Results",
    "text": "Regression Results\n\n\nDifferential effects of prior surgery\n\nRelapse: increases risk by \\(42\\%\\)\nTRM: decreases risk by \\(1-0.63 = 37\\%\\)"
  },
  {
    "objectID": "chap10.html#definition-and-examples-1",
    "href": "chap10.html#definition-and-examples-1",
    "title": "Applied Survival Analysis",
    "section": "Definition and Examples",
    "text": "Definition and Examples\n\n\nSemi-competing risks\n\nTerminal event (competing): death\nNon-terminal events (non-competing): hospitalization, relapse, etc.\n\n\n\n\n\nExamples\n\nDeath + relapse of cancer (German breast cancer study)\nDeath terminates nonfatal event but not vice versa\n\n\n\n\n\nMethods\n\nMarginal: cumulative incidence/frequency\nFrailty (Ch. 8); Multistate (Ch. 12); Composite (Ch. 13)"
  },
  {
    "objectID": "chap10.html#data-and-identifiability",
    "href": "chap10.html#data-and-identifiability",
    "title": "Applied Survival Analysis",
    "section": "Data and Identifiability",
    "text": "Data and Identifiability\n\n\n\n\nTarget of inference: \\((T, D)\\)\n\n\\(T\\): time to nonfatal event\n\\(D\\): time to death\nJoint distribution \\[H(s, t)=\\pr(D&gt;s, T&gt;t)\\]\nIdentifiable region: \\(\\{(s, t):0\\leq t\\leq s&lt;\\infty\\}\\)\n\nPossible nonfatal \\(\\to\\) death, not vice versa"
  },
  {
    "objectID": "chap10.html#recurrent-events",
    "href": "chap10.html#recurrent-events",
    "title": "Applied Survival Analysis",
    "section": "Recurrent Events",
    "text": "Recurrent Events\n\n\nOutcome data: \\(\\{N^*(\\cdot), D\\}\\)\n\n\\(N^*(t)\\): number of recurrent events in presence of death\n\nRepeated tumor occurrences/hospitalizations before death (\\(\\dd N^*(t)\\equiv 0\\) for \\(t&gt;D\\))\n\nTreating \\(D\\) as censoring (AG/LWYY) \\(\\to\\) cause-specific event rate \\[E\\{\\dd N^*(t)\\mid D\\geq t\\}\\]\n\nIncidence rate in survivors\n\n\n\n\n\n\nCumulative frequency\n\nMean function in overall population, dead or alive \\[\n\\mu(t)=E\\{N^*(t)\\}\n\\]\nExtension of cumulative incidence"
  },
  {
    "objectID": "chap10.html#marginal-approaches",
    "href": "chap10.html#marginal-approaches",
    "title": "Applied Survival Analysis",
    "section": "Marginal Approaches",
    "text": "Marginal Approaches\n\n\nMethods for cumulative frequency\n\nGray-type nonparametric estimator/test (Ghosh and Lin, 2000)\nProportional CF model (Fine-Gray-type) (Ghosh and Lin, 2002) \\[\\begin{equation}\\label{eq:cmpr:pcf}\nE\\{N^*(t)\\mid Z\\}=\\exp(\\beta^\\T Z)\\mu_0(t)\n\\end{equation}\\]\nHigher death rate can reduce CF\n\n\n\n\n\nJoint analysis with mortality\n\nGhosh-Lin for recurrent events \\(+\\) Cox/log-rank for death\n\\(\\chi^2\\) test with 2 d.f.\n\n\n\n\n\nAlternative: shared-frailty models"
  },
  {
    "objectID": "chap10.html#example-bladder-tumor-study",
    "href": "chap10.html#example-bladder-tumor-study",
    "title": "Applied Survival Analysis",
    "section": "Example: Bladder Tumor Study",
    "text": "Example: Bladder Tumor Study\n\nBladder cancer trial: thiotepa (\\(n=38\\)) vs placebo (\\(n=48\\))\n\nEndpoints: tumor recurrences and death (\\(\\chi_2^2\\) test \\(p\\)-value 0.184)"
  },
  {
    "objectID": "chap10.html#notes",
    "href": "chap10.html#notes",
    "title": "Applied Survival Analysis",
    "section": "Notes",
    "text": "Notes\n\nFine–Gray regression\n\nModel diagnostics: R package crskdiag\nProportional sub-distribution odds model (Eriksson et al., 2015)\n\n\nlibrary(timereg)\n# Fit a proportional sub-distribution odds model for the kth risk\nobj_po &lt;- prop.odds.subdist(Event(time, status) ˜ covariates, cause = k)\n\n\nInterval-censored competing risks (Mao et al., 2018)\n\nSemi-competing risks\n\nTerm coined by Fine, Jiang, and Chappell (2001)\nMultivariate (here), multistate (Chapter 12), and composite (Chapter 13)\nNonfatal event as mediator of treatment effect on death (Huang, 2021, 2022)"
  },
  {
    "objectID": "chap10.html#summary",
    "href": "chap10.html#summary",
    "title": "Applied Survival Analysis",
    "section": "Summary",
    "text": "Summary\n\nCompeting risks\n\nCause-specific hazard: conditional failure rate on survivors\n\ncoxph(Surv(time, status == k) ~ covariates)\n\nCumulative incidence: marginal failure probability under other risks\n\nGray’s estimator/test cmprk::cuminc(ftime, fstatus, group, strata, rho = 0)\nFine-Gray model cmprk::crr(ftime, fstatus, cov1, failcode = k)\nTidy tables and graphics: tidycmprk package\n\n\nRecurrent events in presence of death\n\nGhosh-Lin methods\n\nNonparametric: rccf2::rccf(id, time, status, trt)\nProportional CF model: R packages mets and reReg"
  },
  {
    "objectID": "chap10.html#study-information",
    "href": "chap10.html#study-information",
    "title": "Applied Survival Analysis",
    "section": "Study Information",
    "text": "Study Information\n\n\nPopulation\n\n864 multiple-myeloma patients undergoing allo-HCT cell transplantation\n\nEndpoints: time from surgery to\n\nTreatment-related mortality (TRM; death in remission)\nRelapse of leukemia\n\nRisk factors\n\nCohort indicator (years 1995–2000 or 2001–2005)\nType of donor (unrelated or HLA-identical sibling)\nHistory of a prior transplant\nTime from diagnosis to transplantation (&lt;24 months, or ≥ 24 months)"
  },
  {
    "objectID": "chap10.html#software-tidycmprk-package",
    "href": "chap10.html#software-tidycmprk-package",
    "title": "Applied Survival Analysis",
    "section": "Software: tidycmprk Package",
    "text": "Software: tidycmprk Package\n\nTidy competing risks analysis\n\nWraps around cmprk functions\nFormula-based interface \\(+\\) Tidy output\nIntegrated with ggsurvfit and gtsummary\n\nGray’s estimator and test\n\ntidycmprsk::cuminc()\ntidycmprsk::tbl_cuminc()\ntidycmprsk::ggcuminc()\n\n\n\n# Compute and test on cumulative incidence function (CIF)\nobj_cif &lt;- tidycmprsk::cuminc(Surv(time, status) ~ group, data = df)\n# Tabulate CIF estimates with 95% CI at specific times\ntbl_surv &lt;- tidycmprsk::tbl_cuminc(\n    x = obj_cif,                     # Provide fitted object\n    times = seq(12, 120, by = 36),   # Time points for CIF\n    outcomes = c(\"1\", \"2\"),          # Specify risks to include\n) \n# Create group-specific CIF plot\nggcuminc(obj_cif, outcome = c(\"1\", \"2\"))  # Specify risks to include"
  },
  {
    "objectID": "chap10.html#software-tidycmprk-package-i",
    "href": "chap10.html#software-tidycmprk-package-i",
    "title": "Applied Survival Analysis",
    "section": "Software: tidycmprk Package (I)",
    "text": "Software: tidycmprk Package (I)\n\n\nTidy competing risks analysis\n\nWraps around cmprk functions\nFormula-based interface \\(+\\) Tidy output\nIntegrated with ggsurvfit and gtsummary\n\nMain functions\n\nNonparametric analysis\n\ntidycmprsk::cuminc(): model fitting\ntidycmprsk::tbl_cuminc(): tabulation of CIF estimates\nggsurvfit::ggcuminc(): plotting of CIF estimates\n\nFine-Gray regression\n\ntidycmprsk::crr(): model fitting\ngtsummary::tbl_regression(): regression table"
  },
  {
    "objectID": "chap10.html#software-tidycmprk-package-ii",
    "href": "chap10.html#software-tidycmprk-package-ii",
    "title": "Applied Survival Analysis",
    "section": "Software: tidycmprk Package (II)",
    "text": "Software: tidycmprk Package (II)\n\n\nSample code\n\n\n# Compute and test on cumulative incidence function (CIF) -------------------\nobj_cif &lt;- tidycmprsk::cuminc(Surv(time, status) ~ group, data = df)\n# Tabulate CIF estimates with 95% CI at specific times\ntbl_surv &lt;- tidycmprsk::tbl_cuminc(\n    x = obj_cif,                     # Provide fitted object\n    times = seq(12, 120, by = 36),   # Time points for CIF\n    outcomes = c(\"1\", \"2\"),          # Specify risks to include\n) \n# Create group-specific CIF plot\nggcuminc(obj_cif, outcome = c(\"1\", \"2\"))  # Specify risks to include\n\n# Fine-Gray regression for risk \"k\" -----------------------------------------\nobj_fg &lt;- tidycmprsk::crr(Surv(time, status) ~ covariates, \n                           data = df, failcode = \"k\")\n# Tabulate regression results\ntbl &lt;- tbl_regression(obj_fg, exponentiate = TRUE)"
  },
  {
    "objectID": "chap10.html#cif-by-donor-type-i",
    "href": "chap10.html#cif-by-donor-type-i",
    "title": "Applied Survival Analysis",
    "section": "CIF by Donor Type (I)",
    "text": "CIF by Donor Type (I)\n\n\nEstimation/testing by donor type\n\n\nobj_cif &lt;- tidycmprsk::cuminc(Surv(time, status) ~ donor, data = df)\nobj_cif # Print results\n#&gt; ...\n#&gt; • Tests\n#&gt; outcome   statistic   df     p.value    \n#&gt; Relapse   17.3        1.00   &lt;0.001     \n#&gt; TRM       12.3        1.00   &lt;0.001\n\n# Summarize CIF estimates at specific times \ntbl_surv &lt;- tbl_cuminc(\n    x = obj_cif,                     # Provide the fitted object\n    times = seq(12, 120, by = 36),   # Time points for CIF\n    outcomes = c(\"Relapse\", \"TRM\"),  # Specify risks to include\n    label_header = \"{time} months\"   # Column label format\n) \ntbl_surv"
  },
  {
    "objectID": "chap10.html#cif-by-donor-type-ii",
    "href": "chap10.html#cif-by-donor-type-ii",
    "title": "Applied Survival Analysis",
    "section": "CIF by Donor Type (II)",
    "text": "CIF by Donor Type (II)\n\n\nTable created by tbl_cuminc()"
  },
  {
    "objectID": "chap10.html#cif-by-donor-type-iii",
    "href": "chap10.html#cif-by-donor-type-iii",
    "title": "Applied Survival Analysis",
    "section": "CIF by Donor Type (III)",
    "text": "CIF by Donor Type (III)\n\n\nGraphics\n\n\nobj_cif |&gt; ggcuminc(outcome = c(\"Relapse\", \"TRM\")) # + ggplot2 formatting"
  },
  {
    "objectID": "chap10.html#bivariate-analysis",
    "href": "chap10.html#bivariate-analysis",
    "title": "Applied Survival Analysis",
    "section": "Bivariate Analysis",
    "text": "Bivariate Analysis\n\n\nMarginal models\n\nDeath: univariate event (KM, log-rank, Cox)\nNonfatal event\n\nCause-specific risk (treating death as censoring)\ncumulative incidence (Gray, FG)\n\n\n\n\n\n\nGerman breast cancer study\n\nNonfatal event: relapse of cancer (status == 1)\nDeath: overall mortality (status == 2)\n\n\n\ngbc &lt;- read.table(\"Data//German Breast Cancer Study//gbc.txt\") |&gt;\n   mutate(age40 = (age &gt; 40) + 0) # create age40: I(age &gt; 40)"
  },
  {
    "objectID": "chap10.html#bivariate-analysis---gbc-example",
    "href": "chap10.html#bivariate-analysis---gbc-example",
    "title": "Applied Survival Analysis",
    "section": "Bivariate Analysis - GBC Example",
    "text": "Bivariate Analysis - GBC Example\n\nData\n\n\ngbc\n#    id      time status hormone age meno size grade nodes prog estrg age40\n# 1   1 43.836066      1       1  38    1   18     3     5 1.41  1.05     0\n# 2   1 74.819672      0       1  38    1   18     3     5 1.41  1.05     0\n# 5   3 41.934426      1       1  47    1   30     2     1 4.22  0.89     1\n# 6   3 47.737705      2       1  47    1   30     2     1 4.22  0.89     1\n\n\nAnalysis\n\nDeath (subset to status != 1)\n\nStandard Cox: coxph(Surv(time, status == 2) ~ covariates)\n\nRelapse (subset to first row for each id)\n\nCause-specific hazard: coxph(Surv(time, status == 1) ~ covariates)\nSub-distribution hazard: tidycmprk::crr(Surv(time, status) ~ covariates, failcode = \"1\")"
  },
  {
    "objectID": "chap10.html#bivariate-analysis---gbc-example-i",
    "href": "chap10.html#bivariate-analysis---gbc-example-i",
    "title": "Applied Survival Analysis",
    "section": "Bivariate Analysis - GBC Example (I)",
    "text": "Bivariate Analysis - GBC Example (I)\n\n\nData\n\n\ngbc\n#    id      time status hormone age meno size grade nodes prog estrg age40\n# 1   1 43.836066      1       1  38    1   18     3     5 1.41  1.05     0\n# 2   1 74.819672      0       1  38    1   18     3     5 1.41  1.05     0\n# 5   3 41.934426      1       1  47    1   30     2     1 4.22  0.89     1\n# 6   3 47.737705      2       1  47    1   30     2     1 4.22  0.89     1\n\n\n\n\nAnalysis\n\nDeath (subset to status != 1)\n\nStandard Cox: coxph(Surv(time, status == 2) ~ covariates)\n\nRelapse (subset to first row for each id)\n\nCause-specific hazard: coxph(Surv(time, status == 1) ~ covariates)\nSub-distribution hazard: tidycmprk::crr(Surv(time, status) ~ covariates, failcode = \"1\")"
  },
  {
    "objectID": "chap10.html#bivariate-analysis---gbc-example-ii",
    "href": "chap10.html#bivariate-analysis---gbc-example-ii",
    "title": "Applied Survival Analysis",
    "section": "Bivariate Analysis - GBC Example (II)",
    "text": "Bivariate Analysis - GBC Example (II)\n\n\nRegression results\n\nRelapse: cause-specific \\(\\approx\\) sub-distribution—few deaths (21) before relapse\nAge effect: driven by relapse"
  },
  {
    "objectID": "chap10.html#software-rccf2rccf",
    "href": "chap10.html#software-rccf2rccf",
    "title": "Applied Survival Analysis",
    "section": "Software: rccf2::rccf()",
    "text": "Software: rccf2::rccf()\n\n\nTwo-sample estimation/testing of CF\n\n\n\ndevtools::install_github(\"lmaowisc/rccf2\")\nlibrary(rccf2) # Load package\nobj &lt;- rccf(id, time, status, trt) # Fit model\n\n\n\nInput\n\nid: subject ID; trt: binary treatment group\ntime: event time; status: event status (1: nonfatal; 2: death; 0: censoring)\n\n\n\n\n\nOutput\n\nobj$u1, obj$u2: Estimates of group-specific \\(\\mu(t)\\) as a function of \\(t\\) (obj$t).\nobj$pLR, obj$pD, obj$pjnt: \\(p\\)-values for tests on \\(\\mu(t)\\), death, and jointly"
  },
  {
    "objectID": "chap10.html#example-bladder-tumor-study-i",
    "href": "chap10.html#example-bladder-tumor-study-i",
    "title": "Applied Survival Analysis",
    "section": "Example: Bladder Tumor Study (I)",
    "text": "Example: Bladder Tumor Study (I)\n\n\nBladder cancer trial (Byar, 1980)\n\nTreatment groups: thiotepa (\\(n=38\\)) vs placebo (\\(n=48\\))\nEndpoints: tumor recurrences and death"
  },
  {
    "objectID": "chap10.html#example-bladder-tumor-study-ii",
    "href": "chap10.html#example-bladder-tumor-study-ii",
    "title": "Applied Survival Analysis",
    "section": "Example: Bladder Tumor Study (II)",
    "text": "Example: Bladder Tumor Study (II)\n\n\nSurvival and cumulative frequency\n\nJoint \\(\\chi_2^2\\) test: \\(p\\)-value 0.184"
  },
  {
    "objectID": "chapter10.html#r-code",
    "href": "chapter10.html#r-code",
    "title": "Chapter 10 - Competing and Semi-Competing Risks",
    "section": "R Code",
    "text": "R Code\n\n\nShow the code\n###############################################################################\n# Chapter 10 R Code\n#\n# This script reproduces all major numerical results in Chapter 10, including:\n#   1. Bone Marrow Transplantation Study (Competing risks)\n#   2. Semi-competing risks in the German Breast Cancer (GBC) data\n#   3. Bladder tumor study (recurrent events with death as a terminal event)\n###############################################################################\n\n#==============================================================================\n# (A) Bone Marrow Transplantation Study\n#==============================================================================\nlibrary(survival)     # For survival analysis (cause-specific hazards, etc.)\nlibrary(cmprsk)       # For Fine-Gray and Gray’s test\nlibrary(tidyverse)    # For data manipulation and plotting\n\n#------------------------------------------------------------------------------\n# 1. Read Data and Perform Gray's Test\n#------------------------------------------------------------------------------\ncibmtr &lt;- read.table(\"Data//Bone Marrow Transplantation Study//cibmtr.txt\")\nhead(cibmtr)\n\n# Gray's unweighted log-rank-type test for group differences in \n# cumulative incidence. 'rho=0' =&gt; unweighted test.\nobj &lt;- cmprsk::cuminc(cibmtr$time, cibmtr$status, cibmtr$donor, rho = 0)\n\n# Print test results (Gray’s test statistics and p-values)\nobj$Tests\n\n#------------------------------------------------------------------------------\n# 2. Plot the Cumulative Incidence Functions (Figure 10.2)\n#   - Relapse (k=1)\n#   - Treatment-related Mortality (k=2)\n#------------------------------------------------------------------------------\n# Extract group-specific CIF objects for siblings (donor=0) vs. unrelated (donor=1)\n# k=1: relapse, k=2: TRM\nobj.rlp.sib    &lt;- obj$`0 1`  # Relapse, siblings\nobj.rlp.nonsib &lt;- obj$`1 1`  # Relapse, unrelated\nobj.trm.sib    &lt;- obj$`0 2`  # TRM, siblings\nobj.trm.nonsib &lt;- obj$`1 2`  # TRM, unrelated\n\n# Set up two-panel plot\npar(mfrow = c(1, 2))\n\n# Left panel: Relapse\nplot(\n  obj.rlp.sib$time, obj.rlp.sib$est,\n  type      = \"s\",          # Step function\n  frame.plot= FALSE,\n  main      = \"Relapse\",\n  xlim      = c(0, 120),\n  ylim      = c(0, 0.6),\n  xlab      = \"Time (months)\",\n  ylab      = \"Cumulative incidence\",\n  lwd       = 2\n)\nlines(obj.rlp.nonsib$time, obj.rlp.nonsib$est, lty = 3, lwd = 2)\n\n# Right panel: TRM\nplot(\n  obj.trm.sib$time, obj.trm.sib$est,\n  type      = \"s\",\n  frame.plot= FALSE,\n  main      = \"Treatment-related mortality\",\n  xlim      = c(0, 120),\n  ylim      = c(0, 0.6),\n  xlab      = \"Time (months)\",\n  ylab      = \"Cumulative incidence\",\n  lwd       = 2\n)\nlines(obj.trm.nonsib$time, obj.trm.nonsib$est, lty = 3, lwd = 2)\n\n#------------------------------------------------------------------------------\n# 3. Fine-Gray vs. Cause-Specific Hazard Models \n#------------------------------------------------------------------------------\n# We focus on cause k = 1 (Relapse)\n\n# Fine-Gray model\nobj.fg &lt;- cmprsk::crr(cibmtr$time, cibmtr$status, cibmtr[, 3:6], failcode = 1)\n\n# Extract estimates and standard errors\nbeta.fg &lt;- obj.fg$coef\nse.fg   &lt;- sqrt(diag(obj.fg$var))\n\n# Format hazard ratios (HR), confidence intervals, and p-values\nc1 &lt;- round(exp(beta.fg), 2)\nc2 &lt;- paste0(\"(\", round(exp(beta.fg - 1.96 * se.fg), 2), \"-\", round(exp(beta.fg + 1.96 * se.fg), 2), \")\")\nc3 &lt;- round(1 - pchisq((beta.fg / se.fg)^2, 1), 3)\n\n# Cause-specific hazard model for k=1\nobj.csh &lt;- coxph(Surv(time, status == 1) ~ cohort + donor + hist + wait, data = cibmtr)\n\nbeta.csh &lt;- obj.csh$coef\nse.csh   &lt;- sqrt(diag(obj.csh$var))\n\nc4 &lt;- round(exp(beta.csh), 2)\nc5 &lt;- paste0(\"(\", round(exp(beta.csh - 1.96 * se.csh), 2), \"-\", round(exp(beta.csh + 1.96 * se.csh), 2), \")\")\nc6 &lt;- round(1 - pchisq((beta.csh / se.csh)^2, 1), 3)\n\n# Print combined Fine-Gray (columns 1-3) vs. cause-specific hazard (columns 4-6)\nnoquote(cbind(c1, c2, c3, c4, c5, c6))\n\n#------------------------------------------------------------------------------\n# 5. Covariate-Specific CIF Prediction\n#------------------------------------------------------------------------------\n# Example covariate vector: z = (1, 0, 1, 0)\nz &lt;- c(1, 0, 1, 0)\n\n# Method 1: Using predict.crr()\nobj_pred1 &lt;- predict(obj.fg, z)\n\n# Method 2: Manual calculation\nbeta   &lt;- obj.fg$coef\nLambda &lt;- cumsum(obj.fg$bfitj)  # Baseline integrated sub-distribution hazard\ntime   &lt;- obj.fg$uftime\ncif    &lt;- 1 - exp(-exp(sum(beta * z)) * Lambda)\nobj_pred2 &lt;- cbind(time, cif)\n\n# Compare both predictions (they should match closely)\ncbind(obj_pred1, obj_pred2)\n\n\n#==============================================================================\n# (B) Tidy Competing Risks Analysis\n#==============================================================================\nlibrary(tidycmprsk)  # For cuminc() wrappers & table building\nlibrary(ggsurvfit)   # For enhanced survival/cif plots\n\n# Recode the data for use with tidycmprsk\ndf &lt;- cibmtr %&gt;%\n  dplyr::mutate(\n    status = factor(status, levels = c(\"0\", \"1\", \"2\"), labels = c(\"Censored\", \"Relapse\", \"TRM\")),\n    donor  = factor(donor, levels = c(\"0\", \"1\"), labels = c(\"Id. sibling\", \"Unrelated\"))\n  )\n\n# Fit CIF by donor groups using tidycmprsk\nobj_cif &lt;- tidycmprsk::cuminc(Surv(time, status) ~ donor, data = df)\nobj_cif\n\n# Summaries of CIF at specific times (12, 48, 84, 120 months)\ntbl_surv &lt;- tbl_cuminc(\n  x          = obj_cif,\n  times      = seq(12, 120, by = 36),\n  outcomes   = c(\"Relapse\", \"TRM\"),\n  label_header = \"{time} months\",\n  label        = \"Donor\"\n)\ntbl_surv\n\n# Base CIF plot for both outcomes (Relapse, TRM) in one panel\nobj_cif %&gt;%\n  ggcuminc(outcome = c(\"Relapse\", \"TRM\")) +\n  scale_x_continuous(\"Time (months)\", limits = c(0, 120), breaks = seq(0, 120, 24)) +\n  add_risktable(risktable_stats = \"n.risk\") +\n  theme_minimal()\n\n#------------------------------------------------------------------------------\n# 1. Separate Plots by Risk (Patchwork)\n#------------------------------------------------------------------------------\nlibrary(patchwork)\nlibrary(ggsci)\n\n# Function to plot a single outcome's CIF\nplot_bm_cif &lt;- function(obj_cif, outcome) {\n  p &lt;- ggcuminc(obj_cif, outcome, linetype_aes = TRUE, linewidth = 0.8) +\n    add_risktable(\n      risktable_stats = \"n.risk\",\n      theme = list(theme_risktable_default())\n    ) +\n    ggtitle(outcome) +\n    scale_y_continuous(\n      \"Cumulative incidence\",\n      limits = c(0, 0.6),\n      breaks = seq(0, 1, by = 0.1),\n      expand = expansion(c(0, 0.005))\n    ) +\n    scale_x_continuous(\"Time (months)\", limits = c(0, 120), breaks = seq(0, 120, 24)) +\n    scale_color_jama() +                # JAMA color palette\n    scale_linetype_manual(values = c(2, 1)) +\n    theme_classic() +\n    theme(\n      plot.margin        = margin(0, 0, 0, 0),\n      legend.position    = \"top\",\n      legend.key.width   = unit(1, \"cm\"),\n      panel.grid.major.y = element_line(),\n      legend.text        = element_text(size = 10),\n      plot.caption       = element_text(size = 10),\n      plot.title         = element_text(size = 12)\n    )\n  p\n}\n\n# Two outcome-specific panels\nrel_fig &lt;- plot_bm_cif(obj_cif, \"Relapse\")\ntrm_fig &lt;- plot_bm_cif(obj_cif, \"TRM\")\n\n# Combine into one figure\nbm_fig &lt;- wrap_plots(\n  ggsurvfit_build(rel_fig),\n  ggsurvfit_build(trm_fig),\n  ncol = 2\n)\nbm_fig\n\n# Save if needed:\n# ggsave(\"images/cmpr_bm.png\", bm_fig, width = 8, height = 4.5)\n# ggsave(\"images/cmpr_bm.eps\", bm_fig, width = 8, height = 4.5)\n\n# Fit separate Fine-Gray models for relapse vs. TRM\nobj_rel &lt;- tidycmprsk::crr(Surv(time, status) ~ donor + cohort + hist + wait, data = df, failcode = \"Relapse\")\nobj_rel\nobj_trm &lt;- tidycmprsk::crr(Surv(time, status) ~ donor + cohort + hist + wait, data = df, failcode = \"TRM\")\nobj_trm\n\n# Example: subdistribution odds via timereg::prop.odds.subdist\nlibrary(timereg)\nobj_po1 &lt;- prop.odds.subdist(\n  Event(time, status) ~ donor + cohort + hist + wait,\n  data  = df,\n  cause = 1\n)\nobj_po1$gamma\nobj_po1$robvar.gamma\n\n\n#==============================================================================\n# (C) Semi-Competing Risks in the German Breast Cancer Data\n#==============================================================================\nlibrary(gtsummary)\nlibrary(labelled)\n\n#------------------------------------------------------------------------------\n# 1. Read and Recoding GBC Data\n#------------------------------------------------------------------------------\ngbc &lt;- read.table(\"Data//German Breast Cancer Study//gbc.txt\") %&gt;%\n  mutate(\n    age40 = (age &gt; 40) + 0,        # Binary for age&gt;40\n    grade = factor(grade),\n    prog  = prog / 100,           # Rescale progesterone\n    estrg = estrg / 100           # Rescale estrogen\n  )\n\n# Assign human-friendly variable labels for gtsummary\nvar_label(gbc) &lt;- list(\n  hormone = \"Hormone\",\n  meno    = \"Menopause\",\n  age40   = \"Age 40+\",\n  grade   = \"Tumor grade\",\n  size    = \"Tumor size (mm)\",\n  prog    = \"Progesterone (100 fmol/mg)\",\n  estrg   = \"Estrogen (100 fmol/mg)\"\n)\n\n#------------------------------------------------------------------------------\n# 2. Cox Model for Overall Survival (Death)\n#------------------------------------------------------------------------------\n# Exclude those who relapsed only (status=1), keep death (status=2) and censoring (status=0)\ngbc_death &lt;- gbc %&gt;%\n  filter(status != 1) %&gt;%\n  mutate(status = (status &gt; 0))  # status=1 if death, 0 if censor\n\nobj_death &lt;- coxph(\n  Surv(time, status) ~ hormone + meno + age40 + grade + size + prog + estrg,\n  data = gbc_death\n)\ndeath_tbl &lt;- tbl_regression(obj_death, exponentiate = TRUE)\n\n#------------------------------------------------------------------------------\n# 3. Cause-Specific Hazards for Relapse\n#------------------------------------------------------------------------------\n# Keep only first event for each subject\n# If status=1 =&gt; relapse, else censor\n# (Ignoring death, which is status=2)\ngbc_relc &lt;- gbc %&gt;%\n  group_by(id) %&gt;%\n  slice_min(time) %&gt;%\n  mutate(status = if_else(status == 2, 0, status)) %&gt;%\n  slice_max(status) %&gt;%\n  ungroup()\n\nobj_relc &lt;- coxph(\n  Surv(time, status) ~ hormone + meno + age40 + grade + size + prog + estrg,\n  data = gbc_relc\n)\nrelc_tbl &lt;- tbl_regression(obj_relc, exponentiate = TRUE)\n\n#------------------------------------------------------------------------------\n# 4. Subdistribution Hazards for Relapse (Fine-Gray)\n#------------------------------------------------------------------------------\n# Keep only the first event, re-encode status as factor\ngbc_tfe &lt;- gbc %&gt;%\n  group_by(id) %&gt;%\n  slice_min(time) %&gt;%\n  slice_max(status) %&gt;%\n  mutate(status = factor(status, levels = c(\"0\", \"1\", \"2\"))) %&gt;%\n  ungroup()\n\nobj_rel_sub &lt;- tidycmprsk::crr(\n  Surv(time, status) ~ hormone + meno + age40 + grade + size + prog + estrg,\n  data     = gbc_tfe,\n  failcode = \"1\"\n)\nrel_sub_tbl &lt;- tbl_regression(obj_rel_sub, exponentiate = TRUE)\n\n# Merge three tables: Death, Relapse (Cause-Specific), Relapse (Subdistribution)\ntbl &lt;- tbl_merge(\n  tbls = list(death_tbl, relc_tbl, rel_sub_tbl),\n  tab_spanner = c(\"**Death**\", \"**Relapse (cause-specific)**\", \"**Relapse (subdistribution)**\")\n)\ntbl\n# as_kable_extra(tbl, format = \"latex\")\n\n\n#==============================================================================\n# (D) Bladder Tumor Study (Recurrent Events with Death as Terminal Event)\n#==============================================================================\ndevtools::install_github(\"lmaowisc/rccf2\")\nlibrary(rccf2)\ndata(bladder)\n\n#------------------------------------------------------------------------------\n# 1. Descriptive Analysis\n#------------------------------------------------------------------------------\n# Count how many rows belong to each status\nbladder %&gt;%\n  count(status)\n\n# Prepare data for plotting\ndf &lt;- bladder %&gt;%\n  left_join(\n    bladder %&gt;% group_by(id) %&gt;% summarize(max_fu = max(time)),\n    by = \"id\"\n  ) %&gt;%\n  mutate(\n    id     = factor(id),\n    status = factor(status, levels = c(\"0\", \"1\", \"2\")),  # 0=censored,1=recur,2=death\n    trt    = if_else(trt == 1, \"Thiotepa\", \"Placebo\")\n  )\n\ndfmax &lt;- df %&gt;%\n  group_by(id, trt) %&gt;%\n  summarize(max_fu = max(time), .groups = \"drop\")\n\n# Follow-up plot showing recurrences/death\ndf %&gt;%\n  ggplot(aes(y = reorder(id, max_fu))) +\n  geom_linerange(data = dfmax, aes(xmin = 0, xmax = max_fu)) +\n  geom_point(aes(x = time, shape = status), size = 2, fill = \"white\") +\n  geom_vline(xintercept = 0, linewidth = 1) +\n  scale_shape_manual(values = c(23, 15, 19), labels = c(\"Censoring\", \"Tumor recurrence\", \"Death\")) +\n  scale_x_continuous(\n    \"Time (months)\",\n    limits = c(0, 65),\n    breaks = seq(0, 60, by = 12),\n    expand = c(0, 0.5)\n  ) +\n  scale_y_discrete(\"Patients\") +\n  facet_wrap(~ trt, scales = \"free\") +\n  theme_minimal() +\n  theme(\n    legend.position      = \"top\",\n    legend.title         = element_blank(),\n    panel.grid.minor.x   = element_blank(),\n    axis.text.y          = element_blank(),\n    axis.ticks.y         = element_blank(),\n    panel.grid.major.y   = element_blank()\n  )\n\n# ggsave(\"cmpr_blad_fu.pdf\", width = 8, height = 8)\n# ggsave(\"cmpr_blad_fu.eps\", width = 8, height = 8)\n\n#------------------------------------------------------------------------------\n# 2. Ghosh-Lin Two-Sample Analysis\n#------------------------------------------------------------------------------\nid     &lt;- bladder$id\ntime   &lt;- bladder$time\nstatus &lt;- bladder$status\ntrt    &lt;- bladder$trt\n\n# Fit the Ghosh-Lin test for recurrent events\nobj_rccf &lt;- rccf(id, time, status, trt)\nstat  &lt;- obj_rccf$stat  # test statistics\nS     &lt;- obj_rccf$S     # covariance matrix\nu1    &lt;- obj_rccf$u1    # mean function for group 1\nu2    &lt;- obj_rccf$u2    # mean function for group 2\nt_rccf&lt;- obj_rccf$t     # time points used\n\n# Derive partial tests\nQLR &lt;- stat[1] / sqrt(S[1, 1])   # Q-value for recurrence\npLR &lt;- 1 - pchisq(QLR^2, 1)\n\nQD &lt;- stat[2] / sqrt(S[2, 2])    # Q-value for death\npD &lt;- 1 - pchisq(QD^2, 1)\n\nQ  &lt;- t(stat) %*% solve(S) %*% stat  # joint test\np  &lt;- 1 - pchisq(Q, 2)\n\n#------------------------------------------------------------------------------\n# 3. Plot Estimated Cumulative Frequency (CF) (Figure 10.x)\n#------------------------------------------------------------------------------\npar(mfrow = c(1, 2))\n\n# Left panel: Survival from death (0=alive, &gt;0=dead)\nfatal &lt;- bladder[status != 1, ]\nobj_sf &lt;- survfit(Surv(time, status &gt; 0) ~ trt, data = fatal)\n\nplot(\n  obj_sf,\n  lty      = c(1, 3),\n  frame    = FALSE,\n  xlim     = c(0, 50),\n  lwd      = 2,\n  cex.lab  = 1.5,\n  cex.axis = 1.5,\n  xlab     = \"Time (months)\",\n  ylab     = \"Survival probabilities\"\n)\ntext(35, 0.14, paste0(\"Log-rank test: p=\", round(pD, 3)), cex = 1.2)\n\n# Right panel: Mean functions for tumor recurrences\nstepmu1 &lt;- stepfun(t_rccf, c(0, u1))\nstepmu2 &lt;- stepfun(t_rccf, c(0, u2))\n\nplot(\n  stepmu2,\n  do.points= FALSE,\n  xlab     = \"Time (months)\",\n  ylab     = \"Cumulative tumor frequency\",\n  main = \"\",\n  xlim     = c(0, 60),\n  ylim     = c(0, 3),\n  frame    = FALSE,\n  lwd      = 2,\n  cex.lab  = 1.5,\n  cex.axis = 1.5,\n  lty      = 3\n)\nplot(\n  stepmu1,\n  add       = TRUE,\n  lty       = 1,\n  do.points = FALSE,\n  lwd       = 2\n)\ntext(40, 0.4, paste0(\"Ghosh-Lin test: p=\", round(pLR, 3)), cex = 1.2)\n\n#------------------------------------------------------------------------------\n# 4. Ghosh-Lin Proportional CF Regression (mets::recreg)\n#------------------------------------------------------------------------------\nlibrary(mets)\ndata(bladder)\n\n# Create start-stop format for each ID\ndf_gl &lt;- bladder %&gt;%\n  group_by(id) %&gt;%\n  mutate(\n    start = lag(time, default = 0),\n    stop  = if_else(time == 0, 1e-4, time)\n  ) %&gt;%\n  select(id, start, stop, status, trt) %&gt;%\n  ungroup() %&gt;%\n  as.data.frame()\n\n# Fit the proportional cumulative frequency regression\nobj_reg &lt;- recreg(\n  Event(start, stop, status) ~ trt + cluster(id),\n  cause      = 1,    # Recurrent event\n  death.code = 2,    # Terminal event\n  data       = df_gl\n)\nsummary(obj_reg)",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 10 - Competing and Semi-Competing Risks"
    ]
  },
  {
    "objectID": "chap9.html",
    "href": "chap9.html",
    "title": "Applied Survival Analysis",
    "section": "",
    "text": "Intensity and rate/mean functions\nCox-type models for recurrent events\nAnalysis of the Chronic Granulomatous Disease Study\nMultivariate approaches to recurrent events\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\]"
  },
  {
    "objectID": "chapter10.html#chapter-summary",
    "href": "chapter10.html#chapter-summary",
    "title": "Chapter 10 - Competing and Semi-Competing Risks",
    "section": "Chapter Summary",
    "text": "Chapter Summary\nWhen a subject can experience at most one event among multiple competing risks (e.g., distinct causes of death) or a non-terminal event followed by a terminal event (semi-competing risks), standard survival analysis techniques need adjustments to account for the terminality of all or a subset of the events. These adjustments typically involve defining, modeling, and interpreting the cause-specific hazard, cumulative incidence, and/or sub-distribution hazards functions for competing risks, along with adaptations to semi-competing scenarios.\n\nCompeting risks\nIn competing risks, each subject can fail at most once from a single cause. The outcome data thus consist of the failure time \\(T\\) along with failure cause \\(\\Delta=1,\\ldots, K\\).\n\nCause-specific hazard (CSH)\n\\[\n\\mathrm{d}\\Lambda_k^{\\rm c}(t)\n\\;=\\;\n\\Pr\\bigl(t \\le T &lt; t+\\mathrm{d}t,\\; \\Delta=k \\,\\mid\\, T \\ge t\\bigr),\n\\] i.e., the conditional incidence of cause \\(k\\) among survivors of any cause.\n\nEstimation: Treat other causes as censoring and fit a standard Cox model.\n\nInterpretation: Covariate effects reflect changes in risk conditional on no failure so far.\n\nCumulative Incidence Function (CIF)\n\\[\nF_k(t)\n\\;=\\;\n\\Pr(T \\le t,\\;\\Delta = k),\n\\] the marginal probability of having cause \\(k\\) by time \\(t\\).\n\nNonparametric: Gray’s estimator integrates the cause-specific hazard with overall survival.\n\nTesting: Gray’s log-rank–type tests compare \\(F_k(t)\\) across groups.\n\nSub-distribution hazard: A transformation of CIF: \\(\\Lambda_k(t)=-\\log\\{1 - F_k(t)\\}\\).\n\nThe Fine–Gray model specifies a multiplicative structure on this sub-distribution hazard: \\[\n\\mathrm{d}\\Lambda_k(t\\mid Z) \\;=\\; \\exp(\\beta_k^\\mathrm{T} Z)\\,\\mathrm{d}\\Lambda_{k0}(t),\n\\]\n\n\\(\\beta_k\\): log-sub-distribution hazard ratios associated with unit increases in the covariates.\n\nRelationship between CSH and CIF (continuous): \\[\\begin{align}\n\\mathrm{d}\\Lambda_k^{\\rm c}(t)\n&\\;=\\; \\frac{ \\mathrm{d} F_k(t)}{1 - \\sum_{k'=1}^K F_{k'}(t)};\\\\\n\\mathrm{d} F_k(t)  &\\;=\\;\n\\exp\\left\\{-\\sum_{k'=1}^K \\Lambda_{k'}^{\\rm c}(t)\\right\\}\\mathrm{d}\\Lambda_k^{\\rm c}(t).\n\\end{align}\\]\n\n\n\nSemi-Competing Risks\nSemi-competing risks arise when a non-terminal event (e.g., relapse) can only be observed if it occurs before the terminal event (e.g., death). Once the terminal event happens, the non-terminal event cannot.\n\nTwo endpoints \\((T, D)\\): \\(T\\) = non-terminal, \\(D\\) = terminal, partially ordered by \\(T \\le D\\) if \\(T\\) occurs.\n\nRecurrent events with death: \\(N^*(t)\\) = number of non-terminal events by time \\(t\\), with \\(\\mathrm{d} N^*(t)\\equiv 0\\) for \\(t&gt; D\\) (no event after death).\n\nAnalyses can be:\n\nCause-specific: treat death as censoring for the non-terminal event.\n\nSub-distribution: treat death as a competing risk for the non-terminal event (acknowledging that there is no event after death).\n\nExtended frameworks: (multistate or shared frailty) for more detailed joint modeling.\n\nIn particular, the Ghosh-Lin test is a two-sample test for comparing the cumulative frequency \\(E\\{N^*(t)\\}\\), accounting for the terminal event. The proportional cumulative frequency regression extends this to covariate-adjusted models: \\[\nE\\{N^*(t)\\mid Z\\}\\;=\\;\\exp(\\beta^\\mathrm{T} Z)\\mu_0(t).\n\\]\n\n\nExample R code\nBelow are code snippets demonstrating nonparametric estimation and regression for competing (and semi-competing) risks. Assume a data frame df with:\n\ntime: observed time to event or censor,\n\nstatus: integer-coded event indicator (0 = censor, 1, 2 for distinct causes),\n\ncovariates: x1, x2, etc.\n\n\n########################################\n# 1. Proportional cause-specific hazards\n########################################\nlibrary(survival)\n# cause 1 vs. not 1\nfit_cs &lt;- coxph(Surv(time, status == 1) ~ x1 + x2, data = df)\nsummary(fit_cs)\n\n########################################\n# 2. Nonparametric CIF (Gray’s method)\n########################################\n# Using 'cmprsk' to estimate and test cumulative incidence\nlibrary(cmprsk)\n# Analyses all risks encoded in fstatus\nobj_cif &lt;- cuminc(ftime = df$time,\n                  fstatus = df$status,\n                  group   = df$group   # optional grouping\n                  )\nobj_cif          # prints CIF estimates & Gray's test p-values\nplot(obj_cif)    # basic CIF plot\n\n####################################################\n# 3. Fine–Gray proportional sub-distribution hazards\n####################################################\nlibrary(cmprsk)\n# Covariate matrix\ncov_mat &lt;- model.matrix(~ x1 + x2, data = df)[, -1]\n# cause of interest is 1\nfit_fg &lt;- crr(ftime = df$time,\n              fstatus = df$status,\n              cov1     = cov_mat,\n              failcode = 1,\n              cencode  = 0)\nsummary(fit_fg)\n\n####################################################\n# 4. Ghosh-Lin methods for cumulative frequency\n####################################################\ndevtools::install_github(\"lmaowisc/rccf2\")\nlibrary(rccf2)\n# Fit the Ghosh-Lin test for recurrent events\n# status = 1: recurrent event; 2: death; 0: censoring\nobj_rccf &lt;- rccf(id = df$id, # subject ID\n                 time = df$time, # event time\n                 status = df$status, # event status\n                 trt = df$trt # treatment group\n                 )\n\nobj_rccf # print results\n\n\n\nConclusion\nWhen analyzing competing risks, the cause-specific approach (treating other causes as censoring) targets the conditional hazard among survivors, while the cumulative incidence or sub-distribution hazard approach (Fine–Gray) provides a marginal interpretation of failure probability in the presence of competing events. For semi-competing risks—where a non-terminal event cannot follow a terminal event—researchers can treat the terminal event as a competing risk for the non-terminal one or use specialized multistate/frailty methods to capture joint behavior. Each method yields valid but different insights: cause-specific hazards focus on event rates among those alive, while cumulative incidence or sub-distribution models offer population-level probabilities.",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 10 - Competing and Semi-Competing Risks"
    ]
  },
  {
    "objectID": "chapter10.html#example-r-code",
    "href": "chapter10.html#example-r-code",
    "title": "Chapter 10 Summary",
    "section": "Example R code",
    "text": "Example R code\nBelow are concise code snippets demonstrating nonparametric estimation and regression for competing (and semi-competing) risks. Assume a data frame df with:\n\ntime: observed time to event or censor,\n\nstatus: integer-coded event indicator (0 = censor, 1, 2 for distinct causes),\n\ncovariates: x1, x2, etc.",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 10 Summary"
    ]
  },
  {
    "objectID": "chap11.html#outline",
    "href": "chap11.html#outline",
    "title": "Applied Survival Analysis",
    "section": "Outline",
    "text": "Outline\n\n\nLinear mixed effects models for longitudinal data\nA two-stage joint modeling approach\nExtensions and dynamic prediction\nAnalysis of an anti-retroviral drug trial\nAn example with multiple biomarkers*\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\cc}{{\\rm c}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\]"
  },
  {
    "objectID": "chap11.html#overview",
    "href": "chap11.html#overview",
    "title": "Applied Survival Analysis",
    "section": "Overview",
    "text": "Overview\n\n\nBackground\n\nBiomarkers, quality of life measured longitudinally while being followed for a clinical event\n\n\n\n\n\nJoint modeling\n\nAssociation between biomarker and (clinical) endpoint\n\nCD4 cell count \\(\\to\\) death from AIDS\nSerum creatinine/eGFR \\(\\to\\) kidney failure\n\nDependent dropout (death) in longitudinal analysis\nDynamic prediction of survival/biomarker"
  },
  {
    "objectID": "chap11.html#longitudinal-data",
    "href": "chap11.html#longitudinal-data",
    "title": "Applied Survival Analysis",
    "section": "Longitudinal Data",
    "text": "Longitudinal Data\n\n\nOutcome Data\n\n\\(Y_{i1},\\ldots, Y_{in_i}\\) longitudinal responses measured on subject \\(i\\) at the \\(t_{ij}\\)\n\\(t_{i1},\\ldots, t_{in_i}\\): measurement occasions for subject \\(i\\)\n\\(Z_{ij}\\): covariates on subject \\(i\\) at \\(t_{ij}\\)\n\nPatient characteristics \\(+\\) time trend (functions of \\(t_{ij}\\))\n\n\n\n\n\n\nLongitudinal regression\n\nMean model: \\(E(Y_{ij}\\mid Z_{ij}) = \\gamma_0 + \\gamma^\\T Z_{ij}\\)\nExample: \\(E(Y_{ij}\\mid A_i)=\\gamma_0+\\gamma_1A_i+\\gamma_2t_{ij}+\\gamma_3A_it_{ij}\\)\n\n\\(Z_{ij}=(A_i, t_{ij}, A_it_{ij})^\\T\\); \\(A_i = 1, 0\\): treatment indicator"
  },
  {
    "objectID": "chap11.html#handling-correlations",
    "href": "chap11.html#handling-correlations",
    "title": "Applied Survival Analysis",
    "section": "Handling Correlations",
    "text": "Handling Correlations\n\n\nChallenge: correlation of the \\(Y_{ij}\\) over \\(t_{ij}\\)\n\nStandard least squares invalid or suboptimal\n\n\n\n\n\nLinear mixed effects (LME) models \\[\\begin{equation}\\label{eq:longit:lme}\nY_{ij}=\\gamma_0+\\gamma^\\T Z_{ij}+b_i^\\T\\tilde Z_{ij}+\\epsilon_{ij}\n\\end{equation}\\]\n\n\\(\\tilde Z_{ij}\\) contains 1 and a subset of \\(Z_{ij}\\)\n\\(b_i\\sim \\mathcal N(0,\\Sigma_b)\\): subject-specific random effects (intercept, slope)\n\nInduces correlation within subject\n\n\\(\\epsilon_{ij}\\sim_{\\rm i.i.d.} \\mathcal N(0,\\sigma^2)\\): random measurement error\nTrue values: \\(E(Y_{ij}\\mid Z_{ij}, b_i)=\\gamma_0+\\gamma^\\T Z_{ij}+b_i^\\T\\tilde Z_{ij}\\)"
  },
  {
    "objectID": "chap11.html#lme-example",
    "href": "chap11.html#lme-example",
    "title": "Applied Survival Analysis",
    "section": "LME Example",
    "text": "LME Example\n\n\nRandom intercept \\(+\\) random slope\n\n\\(Y_{ij}=\\gamma_0+\\gamma_1t_{ij}+b_{i0}+b_{i1}t_{ij}+\\epsilon_{ij}\\)\n\n\\(Z_{ij}=t_{ij}\\), \\(\\tilde Z_{ij}=(1, t_{ij})^\\T\\), \\(b_i=(b_{i0},b_{i1})^\\T\\)"
  },
  {
    "objectID": "chap11.html#estimation-and-inference",
    "href": "chap11.html#estimation-and-inference",
    "title": "Applied Survival Analysis",
    "section": "Estimation and Inference",
    "text": "Estimation and Inference\n\n\nEM algorithm with \\(b_i\\) as missing data\n\n\\(E\\)-step: conditional expectation of \\(b_i\\) and \\(b_i^2\\) given observed data\n\nExplicit under multivariate normal\n\n\\(M\\)-step: (weighted) least squares\n\n\n\n\n\nVariance components\n\n\\(\\hat\\Sigma_b\\): between-subject\n\\(\\hat\\sigma_2\\): within-subject"
  },
  {
    "objectID": "chap11.html#rationale",
    "href": "chap11.html#rationale",
    "title": "Applied Survival Analysis",
    "section": "Rationale",
    "text": "Rationale\n\n\nTraditional Cox model\n\nSurvival vs observed biomarker as (internal) time-varying covariates\n\n\n\n\n\nLimitations\n\nBiomarker measured at discrete times, with missing data in-between\nBiomarker measured with error (sometimes with erratic noise)\n\n\n\n\n\nTwo-stage modeling\n\nLongitudinal sub-model: true biomarker process over continuous time\nSurvival sub-model: Cox model with true biomarker process as time-varying covariate"
  },
  {
    "objectID": "chap11.html#longitudinal-sub-model",
    "href": "chap11.html#longitudinal-sub-model",
    "title": "Applied Survival Analysis",
    "section": "Longitudinal Sub-Model",
    "text": "Longitudinal Sub-Model\n\n\nConceptual setup\n\n\\(Y_i(t)\\): latent biomarker process at time \\(t\\)\n\n\\(Y_i(t_{ij}) = Y_{ij}\\)\n\n\\(Z_i(t), \\tilde Z_i(t)\\): latent covariate processes at time \\(t\\)\n\n\\(Z_i(t_{ij}) = Z_{ij}\\); \\(\\tilde Z_i(t_{ij}) = \\tilde Z_{ij}\\)\n\n\n\n\n\n\nReformulation of LME \\[\\begin{equation}\\label{eq:longit:longit_sub}\nY_i(t)=m_i(t)+\\epsilon_i(t),\n\\end{equation}\\]\n\n\\(m_i(t)=\\gamma_0+\\gamma^\\T Z_i(t)+b_i^\\T\\tilde Z_i(t)\\): True biomarker process\n\\(\\epsilon_i(t)\\): Error process"
  },
  {
    "objectID": "chap11.html#survival-sub-model",
    "href": "chap11.html#survival-sub-model",
    "title": "Applied Survival Analysis",
    "section": "Survival Sub-Model",
    "text": "Survival Sub-Model\n\n\nModel specification \\[\\begin{equation}\\label{eq:longit:survival_sub}\n\\pr\\{t\\leq T_i&lt;t+\\dd t\\mid Z_i^*, \\overline m_i(t)\\}=\\exp\\{\\beta^\\T Z_i^*+\\nu m_i(t)\\}\\lambda_0(t)\\dd t\n\\end{equation}\\]\n\n\\(T_i\\): survival endpoint\n\\(\\overline m_i(t)=\\{m_i(u):0\\leq u\\leq t\\}\\): biomarker history\n\\(Z_i^*\\): baseline covariates to be adjusted for in survival model\n\\(\\nu\\): log-hazard ratio with one unit increase in current biomarker\n\n\n\n\n\nEstimation\n\n\\(E\\)-step: conditional expectation of the \\(b_i\\) (numerical integration)\n\\(M\\)-step: (weighted) least squares \\(+\\) partial-likelihood score"
  },
  {
    "objectID": "chap11.html#interaction-and-trend-effect",
    "href": "chap11.html#interaction-and-trend-effect",
    "title": "Applied Survival Analysis",
    "section": "Interaction and Trend Effect",
    "text": "Interaction and Trend Effect\n\n\nBiomarker effect by baseline group\n\nBiomarker \\(\\times\\) baseline interaction \\[\n\\pr(t\\leq T_i&lt;t+\\dd t\\mid Z_i^*, \\overline m_i(t))=\\exp\\big\\{\\beta^\\T Z_i^*+\\nu m_i(t)+ \\tilde\\nu^\\T Z_i^*m_i(t)\\big\\}\\lambda_0(t)\\dd t\n\\]\n\n\n\n\n\nEffect of biomarker trend (change rate)\n\nLongitudinal sub-model \\[\\begin{equation}\\label{eq:longit:longit_sub_slope}\nm_i(t)=\\gamma_0+\\gamma^\\T Z_i+\\eta t+b_{i0}+b_{i1}t,\n\\end{equation}\\]\nSurvival sub-model \\[\\begin{equation}\\label{eq:longit:survival_sub_rand}\n\\pr(t\\leq T_i&lt;t+\\dd t\\mid Z_i, b_i)=\\exp\\{\\beta^\\T Z_i+\\nu_0b_{i0}+\\nu_1b_{i1}\\}\\lambda_0(t)\\dd t.\n\\end{equation}\\]\n\\(\\nu_1\\):log-hazard ratio by unit increase in biomarker change rate"
  },
  {
    "objectID": "chap11.html#glme-models",
    "href": "chap11.html#glme-models",
    "title": "Applied Survival Analysis",
    "section": "GLME Models",
    "text": "GLME Models\n\n\nGeneralized linear mixed-effects models\n\nBinary, categorical, count biomarkers \\[\\begin{equation}\\label{eq:longit:glmm}\ng\\left[E\\{Y_i(t)\\mid Z_i,b_i\\}\\right]=\\gamma_0+\\gamma^\\T Z_i(t)+b_i^\\T\\tilde Z_i(t)\n\\end{equation}\\]\n\nExample : logistic regression with \\(g(x)=\\log\\{x/(1-x)\\}\\)\n\nSubject-level trajectory \\[m_i(t)=g^{-1}\\left\\{\\gamma_0+\\gamma^\\T Z_i(t)+b_i^\\T\\tilde Z_i(t)\\right\\}\\]\nSurvival sub-model: plug in \\(m_i(t)\\) or \\(g\\{m_i(t)\\}\\)"
  },
  {
    "objectID": "chap11.html#dynamic-prediction",
    "href": "chap11.html#dynamic-prediction",
    "title": "Applied Survival Analysis",
    "section": "Dynamic Prediction",
    "text": "Dynamic Prediction\n\n\nSetup\n\nQuestion: Prediction of survival/biomarker given current data\nObserved biomarker history: \\(\\overline Y_i(u)=\\{Y_i(t_{ij}):0\\leq t_{ij}\\leq u\\}\\)\n\n\n\n\n\nPrediction of future outcomes\n\nSurvival \\[\n  \\mathcal S_i\\{t\\mid u, \\overline Y_i(u)\\}=\\pr\\{T_i &gt; t \\mid T_i&gt;u, \\overline Y_i(u)\\}\n  \\]\nBiomarker \\[\n  \\mathcal M_i(t\\mid u)=E[Y_i(t)\\mid T_i&gt;u, \\overline Y_i(u)]\n  \\]\nBoth computable under fitted model"
  },
  {
    "objectID": "chap11.html#software-jm-package-i",
    "href": "chap11.html#software-jm-package-i",
    "title": "Applied Survival Analysis",
    "section": "Software: JM package (I)",
    "text": "Software: JM package (I)\n\n\nLongitudinal sub-model\n\nid: subject identifier; y: response; covariates: \\(Z\\); cov_rand: \\(\\tilde Z\\)\n\n\n\n\n# Longitudinal sub-model\nlongit_sub &lt;- lme(y ~ covariates, \n                  random = ~ cov_rand | id, data = df)\n\n\n\n\n\nSurvival sub-model\n\ncovariates1: \\(Z^*\\); x = TRUE to include \\(Z^*\\) in model fit\n\n\n\n\ndf_surv &lt;- df[!duplicated(df$id), ] # De-duplicate data\n# Fit Cox model without biomarker \nsurv_sub &lt;- coxph(Surv(time, status) ~ covariates1, \n                  data = df_surv, x = TRUE)"
  },
  {
    "objectID": "chap11.html#software-jm-package-ii",
    "href": "chap11.html#software-jm-package-ii",
    "title": "Applied Survival Analysis",
    "section": "Software: JM package (II)",
    "text": "Software: JM package (II)\n\n\nJoining two sub-models\n\n\"occasion\": time variable in longitudinal model (same unit as time)\n\"piecewise-PH-aGH\": piecewise linear baseline with 6 internal knots\n\n\n\n\n# combine the two models\nobj &lt;- jointModel(longit_sub, surv_sub, timeVar = \"occasion\",\n                            method = \"piecewise-PH-aGH\")\n\n\n\n\n\nOutput: a list of class jointModel\n\nobj$coefficients: main component\n\nbetas: \\(\\hat\\gamma\\); gammas: \\(\\hat\\beta\\); alpha: \\(\\hat\\nu\\); sigma: \\(\\hat\\sigma\\); D: \\(\\hat\\Sigma_b\\)\n\nSummary(obj) to print summary results"
  },
  {
    "objectID": "chap11.html#study-background",
    "href": "chap11.html#study-background",
    "title": "Applied Survival Analysis",
    "section": "Study Background",
    "text": "Study Background\n\n\nStudy information\n\nPopulation: 467 HIV-positive patients randomized to receive didanosine (ddI) and zalcitabine (ddC) followed over a median length of 13.2 month\nPrimary endpoint : All-cause mortality\nLongitudinal biomarker: number of CD4 cells per cubic millimeter of blood (square-root transformed), measured at baseline, 2, 6, 12, 18 months\nAims: evaluate associations between\n\nTreatment (ddI vs ddC) \\(\\to\\) CD4 cell count\nCD4 cell count \\(\\to\\) mortality"
  },
  {
    "objectID": "chap11.html#study-data",
    "href": "chap11.html#study-data",
    "title": "Applied Survival Analysis",
    "section": "Study Data",
    "text": "Study Data\n\n\nData format\n\nRepeated measures of CD4 cell count + death"
  },
  {
    "objectID": "chap11.html#transformation",
    "href": "chap11.html#transformation",
    "title": "Applied Survival Analysis",
    "section": "Transformation",
    "text": "Transformation\n\nSquare root transform \\(\\to\\) close to normality"
  },
  {
    "objectID": "chap11.html#joint-modeling-of-mortality-and-cd4",
    "href": "chap11.html#joint-modeling-of-mortality-and-cd4",
    "title": "Applied Survival Analysis",
    "section": "Joint Modeling of Mortality and CD4",
    "text": "Joint Modeling of Mortality and CD4\n\n\nLME + Cox model\n\nRandom intercept & time slope\nFixed effects: time, treatment \\(\\times\\) time\n\nadjusting for patient sex, history of HIV infection\n\n\n\n\n# Longitudinal sub-model: linear time\nlongit_sub &lt;- lme(CD4 ~ obsmo + obsmo:drug + sex + hist,\n                  random = ~ obsmo|id, data = df)\n# Survival sub-model\ndf_surv &lt;- df[!duplicated(df$id),]\nsurv_sub &lt;- coxph(Surv(time, status) ~ drug + sex + hist,\n                  data = df_surv, x = TRUE)"
  },
  {
    "objectID": "chap11.html#summary-results-i",
    "href": "chap11.html#summary-results-i",
    "title": "Applied Survival Analysis",
    "section": "Summary Results (I)",
    "text": "Summary Results (I)\n\n\nLongitudinal sub-model\n\n\n# Combine the two models\nobj_joint &lt;- jointModel(longit_sub, surv_sub, timeVar = \"obsmo\",\n                            method = \"piecewise-PH-aGH\")\nsummary(obj_joint)\n#&gt; Variance Components:\n#&gt;              StdDev    Corr\n#&gt; (Intercept)  3.9797  (Intr)\n#&gt; obsmo        0.1928 -0.0890\n#&gt; Residual     2.0428    \n#&gt; Longitudinal Process\n#&gt;                 Value Std.Err z-value p-value\n#&gt; (Intercept)    5.8614  0.6562  8.9322 &lt;0.0001\n#&gt; obsmo         -0.1922  0.0240 -8.0175 &lt;0.0001\n#&gt; sexmale       -0.3823  0.6642 -0.5757  0.5649\n#&gt; histnoAIDS     4.8617  0.4091 11.8835 &lt;0.0001\n#&gt; obsmo:drugddI  0.0219  0.0333  0.6558  0.5120"
  },
  {
    "objectID": "chap11.html#summary-results-ii",
    "href": "chap11.html#summary-results-ii",
    "title": "Applied Survival Analysis",
    "section": "Summary Results (II)",
    "text": "Summary Results (II)\n\n\nSurvival sub-model\n\n\nsummary(obj_joint)\n#&gt; Event Process\n#&gt;              Value Std.Err z-value p-value\n#&gt; drugddI     0.3487  0.1576  2.2118  0.0270\n#&gt; sexmale    -0.3313  0.2608 -1.2701  0.2040\n#&gt; histnoAIDS -0.5873  0.2255 -2.6040  0.0092\n#&gt; Assoct     -0.2569  0.0374 -6.8708 &lt;0.0001 # CD4 effect\n#&gt; ...\n\n\n\n\nResults\n\nddI leads to slightly slower rate of decline (by 0.0219 per month) in \\(\\sqrt{\\rm CD4}\\)\nOne unit decline in \\(\\sqrt{\\rm CD4}\\) increases the risk of death by \\(\\exp(0.2569) = 1.30\\)-fold (p-value \\(&lt; 0.0001\\))"
  },
  {
    "objectID": "chap11.html#mean-cd4-trajectory",
    "href": "chap11.html#mean-cd4-trajectory",
    "title": "Applied Survival Analysis",
    "section": "Mean CD4 Trajectory",
    "text": "Mean CD4 Trajectory\n\n\nModel-based predictions"
  },
  {
    "objectID": "chap11.html#notes",
    "href": "chap11.html#notes",
    "title": "Applied Survival Analysis",
    "section": "Notes",
    "text": "Notes\n\n\nJMbayes2 website"
  },
  {
    "objectID": "chap11.html#summary-i",
    "href": "chap11.html#summary-i",
    "title": "Applied Survival Analysis",
    "section": "Summary (I)",
    "text": "Summary (I)\n\nTwo-stage joint models\n\nLongitudinal sub-model \\[m_i(t)=\\gamma_0+\\gamma^\\T Z_i(t)+b_i^\\T\\tilde Z_i(t)\\]\n\nobj1 &lt;- nlme::lme()\n\nSurvival sub-model \\[\n\\pr\\{t\\leq T_i&lt;t+\\dd t\\mid Z_i^*, \\overline m_i(t)\\}=\\exp\\{\\beta^\\T Z_i^*+\\nu m_i(t)\\}\\lambda_0(t)\\dd t\n\\]\n\nobj2 &lt;- survival::coxph()\n\nJoining two models\n\nJM::jointModel(obj1, obj2, timeVar)"
  },
  {
    "objectID": "chap11.html#summary-ii",
    "href": "chap11.html#summary-ii",
    "title": "Applied Survival Analysis",
    "section": "Summary (II)",
    "text": "Summary (II)\n\nExtensions (Rizopoulos, 2012)\n\nBiomarker \\(\\times\\) baseline interactions\nChange rate \\(\\to\\) survival\nGLME GLMM\nMultivariate failure times (competing risks, recurrent events)\nDynamic predictions\nJMbayes2 package for Bayesian approach\n\n\n\nobj &lt;- jm(surv_sub, list(longit_sub1, longit_sub2), \n          time_var = \"obstime\",\n          functional_forms = fForms)"
  },
  {
    "objectID": "chap11.html#multivariate-models",
    "href": "chap11.html#multivariate-models",
    "title": "Applied Survival Analysis",
    "section": "Multivariate Models",
    "text": "Multivariate Models\n\n\nMultple biomarkers\n\nLongitudinal sub-models \\[\nm_{ik}(t)=\\gamma_{0k}+\\gamma_k^\\T Z_i(t)+b_{ik}^\\T\\tilde Z_i(t), \\quad k =1,\\ldots, K\n\\]\nSurvival sub-model \\[\n\\pr\\{t\\leq T_i&lt;t+\\dd t\\mid Z_i^*, \\overline m_{i1}(t), \\ldots, \\overline m_{iK}(t)\\}=\\exp\\left\\{\\beta^\\T Z_i^*+\\sum_k\\nu_k m_{ik}(t)\\right\\}\\lambda_0(t)\\dd t\n\\]\n\n\n\n\n\nMultple events\n\nShared-fraity sub-models \\[\\begin{equation}\\label{eq:longit:survival_sub_mult}\n\\pr\\{t\\leq T_{ik}&lt;t+\\dd t\\mid \\xi_i, Z_i^*, \\overline m_i(t)\\}=\\xi_i\\exp\\{\\beta_k^\\T Z_i^*+\\nu_k m_i(t)\\}\\lambda_{0k}(t)\\dd t\n\\end{equation}\\]"
  },
  {
    "objectID": "chap11.html#software-jmbayes2-package",
    "href": "chap11.html#software-jmbayes2-package",
    "title": "Applied Survival Analysis",
    "section": "Software: JMbayes2 package",
    "text": "Software: JMbayes2 package\n\n\nMultiple non-Gaussian biomarkers (Bayesian approach)\n\n\n\n# Fit longitudinal sub-models (linear time)\n# Biomarker 1 (Continuous)\nlongit_sub1 &lt;- lme(y1 ~ covariates + obstime, \n                   random = ~ obstime | id, data = df)\n\n# Biomarker 2 (Binary)\nlongit_sub2 &lt;- mixed_model(y2 ~ covariates + obstime, \n                           random = ~ obstime | id, data = df,\n                           family = binomial())"
  },
  {
    "objectID": "chap11.html#software-jmbayes2-package-i",
    "href": "chap11.html#software-jmbayes2-package-i",
    "title": "Applied Survival Analysis",
    "section": "Software: JMbayes2 package (I)",
    "text": "Software: JMbayes2 package (I)\n\n\nMultiple non-Gaussian biomarkers (Bayesian approach)\n\nmixed_model(formula, family = binomial()): logistic GLMM\n\n\n\n\n# Fit longitudinal sub-models (linear time)\n# Biomarker 1 (Continuous)\nlongit_sub1 &lt;- lme(y1 ~ covariates + obstime, \n                   random = ~ obstime | id, data = df)\n# Biomarker 2 (Binary)\nlongit_sub2 &lt;- mixed_model(y2 ~ covariates + obstime, \n                           random = ~ obstime | id, data = df,\n                           family = binomial())\n\n# Fit the Cox sub-model without the biomarker\nsurv_sub &lt;- coxph(Surv(time, status) ~ covariates, \n                  data = df_surv, x = TRUE)"
  },
  {
    "objectID": "chap11.html#glmm",
    "href": "chap11.html#glmm",
    "title": "Applied Survival Analysis",
    "section": "GLMM",
    "text": "GLMM\n\n\nGeneralized linear mixed-effects models (GLMM)\n\nBinary, categorical, count biomarkers \\[\\begin{equation}\\label{eq:longit:glmm}\ng\\left[E\\{Y_i(t)\\mid Z_i,b_i\\}\\right]=\\gamma_0+\\gamma^\\T Z_i(t)+b_i^\\T\\tilde Z_i(t)\n\\end{equation}\\]\n\nExample : logistic regression with \\(g(x)=\\log\\{x/(1-x)\\}\\)\n\nSubject-level trajectory \\[m_i(t)=g^{-1}\\left\\{\\gamma_0+\\gamma^\\T Z_i(t)+b_i^\\T\\tilde Z_i(t)\\right\\}\\]\nSurvival sub-model: plug in \\(m_i(t)\\) or \\(g\\{m_i(t)\\}\\)"
  },
  {
    "objectID": "chap11.html#software-jmbayes2-package-i-1",
    "href": "chap11.html#software-jmbayes2-package-i-1",
    "title": "Applied Survival Analysis",
    "section": "Software: JMbayes2 package (I)",
    "text": "Software: JMbayes2 package (I)\n\n\nJoin models (Bayesian approach)\n\nSpecify functional_forms for each biomarker\n\nvalue(): \\(m_{ik}(t)\\) (LME) (\\(g\\{m_{ik}(t)\\}\\) for GLMM)\nslope(): \\(\\d m_{ik}(t)/\\d t\\)\narea(): \\(\\int_0^t m_{ik}(u)\\d u\\)\n\n\n\n\n\n# Define functional forms of biomarkers to include in joint model\nfForms &lt;- list(\"y1\" = ~ value(y1) + slope(y1), \n               \"y2\" = ~ value(y2) + slope(y2))\n\n# Combine the longitudinal and survival sub-models\nobj &lt;- jm(surv_sub, list(longit_sub1, longit_sub2), \n          time_var = \"obstime\",\n          functional_forms = fForms)"
  },
  {
    "objectID": "chap11.html#software-jmbayes2-package-ii",
    "href": "chap11.html#software-jmbayes2-package-ii",
    "title": "Applied Survival Analysis",
    "section": "Software: JMbayes2 package (II)",
    "text": "Software: JMbayes2 package (II)\n\n\nJoin models (Bayesian approach)\n\nSpecify functional_forms for each biomarker\n\nvalue(): \\(m_{ik}(t)\\) (\\(g\\{m_{ik}(t)\\}\\) for GLMM)\nslope(): \\(\\d m_{ik}(t)/\\d t\\);\\(\\quad\\) area(): \\(\\int_0^t m_{ik}(u)\\d u\\)\n\n\n\n\n\n# Define functional forms of biomarkers to include in joint model\nfForms &lt;- list(\"y1\" = ~ value(y1) + slope(y1), \n               \"y2\" = ~ value(y2) + slope(y2))\n# Combine the longitudinal and survival sub-models\nobj &lt;- jm(surv_sub, list(longit_sub1, longit_sub2), \n          time_var = \"obstime\",\n          functional_forms = fForms)\n# Dynamic prediction\npred &lt;- predict(obj, newdata = df_new)"
  },
  {
    "objectID": "chap11.html#aortic-valve-replacement-study",
    "href": "chap11.html#aortic-valve-replacement-study",
    "title": "Applied Survival Analysis",
    "section": "Aortic Valve Replacement Study",
    "text": "Aortic Valve Replacement Study\n\n\nStudy information\n\nPopulation: 256 patients receiving a bioprosthetic valve replacement\nfollowed for up to 10 years from 1991–2002\nPrimary endpoint : All-cause mortality\nLongitudinal biomarker\n\nSerum creatinine (mg/dL) measured at baseline, 6, 12, 24, 36 months\neGFR (mL/min/1.73m\\(^2\\)) calculated from serum creatinine\n\nAims: evaluate associations between\n\nTreatment (ddI vs ddC) \\(\\to\\) CD4 cell count\nCD4 cell count \\(\\to\\) mortality"
  },
  {
    "objectID": "chap11.html#heart-valve-replacement-study",
    "href": "chap11.html#heart-valve-replacement-study",
    "title": "Applied Survival Analysis",
    "section": "Heart Valve Replacement Study",
    "text": "Heart Valve Replacement Study\n\nStudy information\n\nPopulation: 256 patients receiving a valve replacement surgery, followed for up to 10 years from 1991–2002\nPrimary endpoint : All-cause mortality\nLongitudinal biomarkers\n\nLeft ventricular ejection fraction (LVEF): &lt; 50%\nValve gradient (mmHg): pressure difference across heart valve during blood flow (valve narrowing)\nLV mass index (g/m\\(^2\\)): mass of LV relative to subject’s body surface area (hypertrophy)\n\nBaseline factors\n\nPatient age, sex, LV size (mm), LV function grade (1: good, 2: moderate, and 3: poor), history of cardiac surgery, presence of a coronary artery bypass graft (CABG), current use of ACE inhibitor, presence of high cholesterol, and operative urgency (0: elective, 1: urgent, and 3: emergency)"
  },
  {
    "objectID": "chap11.html#models-and-data",
    "href": "chap11.html#models-and-data",
    "title": "Applied Survival Analysis",
    "section": "Models and Data",
    "text": "Models and Data\n\nStudy aims\n\nBaseline factors \\(\\to\\) biomarkers\nBiomarkers \\(\\to\\) mortality"
  },
  {
    "objectID": "chap11.html#data-format",
    "href": "chap11.html#data-format",
    "title": "Applied Survival Analysis",
    "section": "Data Format",
    "text": "Data Format"
  },
  {
    "objectID": "chap11.html#longitudinal-survival-models",
    "href": "chap11.html#longitudinal-survival-models",
    "title": "Applied Survival Analysis",
    "section": "Longitudinal & Survival Models",
    "text": "Longitudinal & Survival Models\n\nLongitudinal sub-models\n\nLVEF\\(\\le 50\\%\\): logistic GLMM\nValve gradient: LME\nLV mass index: LME\n\nSurvival (Cox) sub-model\n\nCurrent log-odds of LVEF\\(\\le 50\\%\\)\nCurrent values and change rates of valve gradient and LVMI\nBaseline age, sex"
  },
  {
    "objectID": "chap11.html#longitudinal-survival-sub-models",
    "href": "chap11.html#longitudinal-survival-sub-models",
    "title": "Applied Survival Analysis",
    "section": "Longitudinal & Survival Sub-Models",
    "text": "Longitudinal & Survival Sub-Models\n\nLongitudinal sub-models\n\nLVEF\\(\\le 50\\%\\): logistic GLMM (binary)\nValve gradient: LME (continuous)\nLV mass index: LME (continuous)\n\nSurvival (Cox) sub-model\n\nCurrent log-odds of LVEF\\(\\le 50\\%\\)\nCurrent values and change rates of valve gradient and LVMI\nBaseline age, sex"
  },
  {
    "objectID": "chap11.html#fitting-longitudinal-sub-models",
    "href": "chap11.html#fitting-longitudinal-sub-models",
    "title": "Applied Survival Analysis",
    "section": "Fitting Longitudinal Sub-Models",
    "text": "Fitting Longitudinal Sub-Models"
  },
  {
    "objectID": "chap11.html#model-fitting-i",
    "href": "chap11.html#model-fitting-i",
    "title": "Applied Survival Analysis",
    "section": "Model Fitting (I)",
    "text": "Model Fitting (I)\n\nLongitudinal sub-models\n\n\n# 1. Ejection fraction &lt;= 50% at follow-up\nef_mod &lt;- mixed_model(ef50 ~ obsyear + age + sex  + vsize + lvef + redo \n                      + cabg + acei + hc + emergenc, \n                      random = ~ obsyear | id, data = df,\n                      family = binomial())\n\n# 2. Valve gradient at follow-up\ngrad_mod &lt;- lme(grad ~ obsyear + age + sex  + vsize + lvef + redo \n                + cabg + acei + hc + emergenc, \n                random = ~ obsyear | id, data = df)\n\n# 3. LV mass index at follow-up\nlvmi_mod &lt;- lme(lvmi ~ obsyear + age + sex  + vsize + lvef + redo \n                + cabg + acei + hc + emergenc, \n                random = ~ obsyear | id, data = df)"
  },
  {
    "objectID": "chap11.html#model-fitting-ii",
    "href": "chap11.html#model-fitting-ii",
    "title": "Applied Survival Analysis",
    "section": "Model Fitting (II)",
    "text": "Model Fitting (II)\n\nJoin with survival sub-model\n\n\n# Survival sub-model\ndf_surv &lt;- df[!duplicated(df$id),] # de-duplicated data\nsurv_mod &lt;- coxph(Surv(surv_time, status) ~ age + sex,  \n                  data = df_surv)\n\n# Set-up functional forms biomarkers in Cox model\nfForms &lt;- list(\n  \"grad\" = ~ slope(grad) + value(grad),\n  \"lvmi\" = ~ slope(lvmi) + value(lvmi)\n)\n\n# Fit joint model\nobj &lt;- jm(surv_mod, list(ef_mod, grad_mod, lvmi_mod), \n                time_var = \"obsyear\",\n                functional_forms = fForms)"
  },
  {
    "objectID": "chap11.html#regression-results-i",
    "href": "chap11.html#regression-results-i",
    "title": "Applied Survival Analysis",
    "section": "Regression Results (I)",
    "text": "Regression Results (I)\n\nThree longitudinal sub-models"
  },
  {
    "objectID": "chap11.html#regression-results-ii",
    "href": "chap11.html#regression-results-ii",
    "title": "Applied Survival Analysis",
    "section": "Regression Results (II)",
    "text": "Regression Results (II)\n\nCox sub-model for mortality\n\nDoubling odds of reduced LVEF \\(\\longrightarrow\\) \\(2^{1.63} - 1 = 210\\%\\) increase in mortality (\\(p\\)-value \\(= 0.049\\))"
  },
  {
    "objectID": "chap11.html#prediction-for-patient-id-3",
    "href": "chap11.html#prediction-for-patient-id-3",
    "title": "Applied Survival Analysis",
    "section": "Prediction for Patient ID 3",
    "text": "Prediction for Patient ID 3\n\nDynamic prediction: patient ID = 3 by year 3\n\n\n# Set up data\nt0 &lt;- 3 # Set current time u\nnewdf &lt;- df[df$id == 3, ] # Get data from patient 3\nnewdf &lt;- newdf[newdf$obsyear &lt; t0, ] # Subset to times before t0\n# Indicate that the patient is alive at t0\nnewdf$status &lt;- 0\nnewdf$surv_time &lt;- t0\n\n\n# Predict longitudinal trajectories\npred_longit &lt;- predict(obj, newdata = newdf,\n                       times = seq(t0, 10, length.out = 10),\n                       return_newdata = TRUE)\n\n# Plot the predicted trajectories\npar(mfrow = c(1, 3))\nplot(pred_longit, outcomes = 1:3, ...)"
  },
  {
    "objectID": "chap11.html#predicted-biomarker-curves",
    "href": "chap11.html#predicted-biomarker-curves",
    "title": "Applied Survival Analysis",
    "section": "Predicted Biomarker Curves",
    "text": "Predicted Biomarker Curves"
  },
  {
    "objectID": "chap11.html#prediction-results-i",
    "href": "chap11.html#prediction-results-i",
    "title": "Applied Survival Analysis",
    "section": "Prediction Results (I)",
    "text": "Prediction Results (I)\n\nBiomarker trajectories"
  },
  {
    "objectID": "chap11.html#prediction-results-ii",
    "href": "chap11.html#prediction-results-ii",
    "title": "Applied Survival Analysis",
    "section": "Prediction Results (II)",
    "text": "Prediction Results (II)\n\nPredict survival curve\n\n\n# Predict survival probabilities\npred_surv &lt;- predict(obj, newdata = newdf, process = \"event\",\n                     times = seq(t0, 10, length.out = 10),\n                     return_newdata = TRUE)\n# Plot the predicted survival probabilities\nplot(pred_longit, pred_surv, outcomes = 1:3,\n     fun_event = function(x) 1 - x, ...)"
  },
  {
    "objectID": "chap11.html#prediction-results-iii",
    "href": "chap11.html#prediction-results-iii",
    "title": "Applied Survival Analysis",
    "section": "Prediction Results (III)",
    "text": "Prediction Results (III)\n\nPredicted survival curve"
  },
  {
    "objectID": "chapter11.html#chapter-summary",
    "href": "chapter11.html#chapter-summary",
    "title": "Chapter 11 - Joint Analysis of Longitudinal and Survival Data",
    "section": "Chapter Summary",
    "text": "Chapter Summary\nWhen longitudinal biomarkers are repeatedly measured alongside a time-to-event outcome, separate analyses can lead to biased or inefficient results, especially in the presence of informative dropout. Joint models address this by integrating a mixed-effects model for the biomarker process with a survival model for the event time, providing a coherent framework for estimation, interpretation, and prediction.\n\nLongitudinal–survival joint models\nThe data consist of repeated measurements \\(Y_{ij}\\) over time \\(t_{ij}\\) \\((j=1,\\ldots, n_i)\\) and a survival outcome \\(T_i\\) subject to right censoring.\n\nLinear mixed-effects (LME) model\nFor continuous biomarkers, we assume: \\[\nY_{ij} = \\gamma_0 + \\gamma^\\mathrm{T} Z_{ij} + b_i^\\mathrm{T} \\tilde{Z}_{ij} + \\epsilon_{ij},\n\\] where \\(b_i \\sim \\mathcal{N}(0, \\Sigma_b)\\) are subject-specific random effects and \\(\\epsilon_{ij} \\sim \\mathcal{N}(0, \\sigma^2)\\) are measurement errors.\n\nInterpretation: \\(\\gamma\\) are population-level effects; \\(b_i\\) captures individual-specific deviation.\nEstimation: Maximum likelihood via EM algorithm with \\(b_i\\) as missing data.\n\nCox model with latent trajectory\nThe survival process is linked to the “true” biomarker trajectory \\(m_i(t)\\): \\[\n\\Pr(t \\le T_i &lt; t + \\mathrm{d}t \\mid Z_i^*, \\overline{m}_i(t))\n= \\lambda_0(t) \\exp\\left(\\beta^\\mathrm{T} Z_i^* + \\nu m_i(t)\\right) \\mathrm{d}t.\n\\]\n\n\\(\\nu\\) quantifies the log-hazard ratio per unit increase in the biomarker.\n\\(m_i(t)\\) may be extracted from an LME or generalized LME model.\n\n\n\n\nExtensions\n\nEffect modification\nInteraction of \\(m_i(t)\\) with treatment or baseline factors: \\[\n\\exp\\left\\{\\nu m_i(t) + \\tilde{\\nu}^\\mathrm{T} \\tilde{Z}_i^* m_i(t)\\right\\}.\n\\]\nLagged or cumulative effects\nReplace \\(m_i(t)\\) with lagged or average values, e.g., \\[\n\\overline{m}_i(t - \\tau_0, t) = \\frac{1}{\\tau_0} \\int_{t - \\tau_0}^t m_i(u) \\, \\mathrm{d}u.\n\\]\nRate of change as predictor\nInclude derivative \\(m_i'(t)\\) in the hazard model: \\[\n\\exp\\left\\{\\nu_0 m_i(t) + \\nu_1 m_i'(t)\\right\\}.\n\\]\nNon-continuous outcomes\nUse generalized linear mixed models (GLMMs): \\[\ng\\left[E\\{Y_i(t) \\mid Z_i(t), b_i\\}\\right] = \\gamma_0 + \\gamma^\\mathrm{T} Z_i(t) + b_i^\\mathrm{T} \\tilde{Z}_i(t).\n\\]\nMultivariate extensions\nFor multiple biomarkers and/or multiple events: \\[\n\\Pr(t \\le T_{ik} &lt; t + \\mathrm{d}t \\mid \\xi_i, \\overline{m}_i(t))\n= \\xi_i \\lambda_{0k}(t) \\exp\\left(\\beta_k^\\mathrm{T} Z_i^* + \\nu_k^\\mathrm{T} m_i(t)\\right) \\mathrm{d}t.\n\\]\n\n\n\nDynamic prediction\nJoint models enable real-time prediction of survival probability or biomarker levels:\n\nSurvival probability: \\[\n\\mathcal{S}_i(t \\mid u) = \\Pr(T_i &gt; t \\mid T_i &gt; u, \\overline{Y}_i(u)).\n\\]\nFuture biomarker level: \\[\n\\mathcal{M}_i(t \\mid u) = E[Y_i(t) \\mid T_i &gt; u, \\overline{Y}_i(u)].\n\\]\n\nThese are computed via Monte Carlo integration over \\(p(b_i \\mid \\overline{Y}_i(u), T_i &gt; u)\\).\n\n\nExample R code\n\nUnivariate Gaussian response: JM package\nBelow is a code snippet demonstrating two-stage joint modeling using the JM package. Assume a dataset df with:\n\nid: subject ID, y: longitudinal response, obstime: time of measurement,\n\ntime: event or censoring time, status: event indicator,\n\ncovariates: covariates.\n\n\n########################################\n# 1. Linear mixed-effects for biomarker\n########################################\nlibrary(nlme)\nlongit_sub &lt;- lme(y ~ covariates + obstime,\n                  random = ~ obstime | id,\n                  data = df)\n\n########################################\n# 2. Cox model for survival outcome\n########################################\nlibrary(survival)\ndf_surv &lt;- df[!duplicated(df$id), ]\nsurv_sub &lt;- coxph(Surv(time, status) ~ covariates, \n                  data = df_surv, x = TRUE)\n\n########################################\n# 3. Fit joint model\n########################################\nlibrary(JM)\nobj &lt;- jointModel(longit_sub, surv_sub,\n                  timeVar = \"obstime\",\n                  method = \"piecewise-PH-aGH\")\nsummary(obj)\n\n\n\nMore complex outcomes: JMbayes2 package\nAssume longitudinal outcomes y1 (continuous) and y2 (binary) with covariates obstime, age, and sex.\n\n########################################\n# 1. Fit two longitudinal models\n########################################\n# y1: continuous outcome (e.g., biomarker)\nlongit_sub1 &lt;- lme(y1 ~ obstime + age + sex,\n                   random = ~ obstime | id, data = df)\n\n# y2: binary outcome (e.g., clinical status)\nlibrary(JMbayes2)\nlongit_sub2 &lt;- mixed_model(y2 ~ obstime + age + sex,\n                           random = ~ obstime | id, data = df,\n                           family = binomial())\n\n########################################\n# 2. Fit survival model\n########################################\ndf_surv &lt;- df[!duplicated(df$id), ]\nsurv_sub &lt;- coxph(Surv(time, status) ~ age + sex, data = df_surv)\n\n########################################\n# 3. Fit joint model with multiple outcomes\n########################################\n# Define biomarker contributions to hazard\nfForms &lt;- list(\n  \"y1\" = ~ value(y1) + slope(y1),\n  \"y2\" = ~ value(y2)\n)\n\nobj &lt;- jm(surv_sub, list(longit_sub1, longit_sub2),\n          time_var = \"obstime\",\n          functional_forms = fForms)\n\nsummary(obj)\n\n\nvalue(y): uses the fitted mean or link-transformed mean (GLMM) as a predictor.\nslope(y): includes rate of change (i.e., \\(\\mathrm{d} m_i(t)/\\mathrm{d} t\\)).\narea(y): uses cumulative biomarker value up to time \\(t\\).\n\nJMbayes2 enables subject-specific predictions of biomarker evolution and survival probabilities using predict():\n\n# Predict for subject with ID = 3, up to time u = 3\nnewdf &lt;- df[df$id == 3 & df$obstime &lt; 3, ]\nnewdf$surv_time &lt;- 3\nnewdf$status &lt;- 0\n\n# Longitudinal prediction\npred_longit &lt;- predict(obj, newdata = newdf, return_newdata = TRUE)\n\n# Survival prediction\npred_surv &lt;- predict(obj, newdata = newdf, process = \"event\", return_newdata = TRUE)\n\nUse plot() to visualize predictions across biomarkers and time horizons, including posterior uncertainty bands.\n\n\n\nConclusion\nJoint modeling of longitudinal and survival data integrates biomarker evolution and event risk to improve efficiency, reduce bias from informative dropout, and provide individualized predictions. Extensions accommodate multiple or non-Gaussian biomarkers, flexible risk structures, and varying functional forms. These models are especially valuable in clinical studies where patient monitoring and outcome prediction are central goals.",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 11 - Joint Analysis of Longitudinal and Survival Data"
    ]
  },
  {
    "objectID": "quiz3.html",
    "href": "quiz3.html",
    "title": "10-Minute In-Class Quiz 3: Survival Analysis (Chapters 8-9)",
    "section": "",
    "text": "You have 10 minutes to complete this quiz.\nAnswer all questions concisely.\nShow all relevant calculations where applicable."
  },
  {
    "objectID": "quiz3.html#instructions",
    "href": "quiz3.html#instructions",
    "title": "10-Minute In-Class Quiz 3: Survival Analysis (Chapters 8-9)",
    "section": "",
    "text": "You have 10 minutes to complete this quiz.\nAnswer all questions concisely.\nShow all relevant calculations where applicable."
  },
  {
    "objectID": "quiz3.html#question-1-5-points-recurrent-events",
    "href": "quiz3.html#question-1-5-points-recurrent-events",
    "title": "10-Minute In-Class Quiz 3: Survival Analysis (Chapters 8-9)",
    "section": "Question 1 (5 points) – Recurrent Events",
    "text": "Question 1 (5 points) – Recurrent Events\nFigure 1 below shows the follow-up of six patients for repeated infections.\n\n\n\n\n\n\n\n\nFigure 1: Follow-up of six patients for repeated infections.\n\n\n\n\n\n\nCalculate the (Nelsen–Aalen-type) estimates of the average number of infections per patient by month 2, 4, and 6.\nWhy is the following arithmetic biased:\n\n\\[\n\\frac{\\mbox{Total number of black dots by month }2, 4, 6}{6 \\mbox{ subjects}}\n\\]"
  },
  {
    "objectID": "quiz3.html#question-2-5-points-mean-model",
    "href": "quiz3.html#question-2-5-points-mean-model",
    "title": "10-Minute In-Class Quiz 3: Survival Analysis (Chapters 8-9)",
    "section": "Question 2 (5 points) – Mean Model",
    "text": "Question 2 (5 points) – Mean Model\nLet \\(N^*(t)\\) denote the average number of recurrent events by time \\(t\\) (such as estimated in Question 1). Let \\(Z=1, 0\\) denote treatment and control groups, respectively. Under the multiplicative mean model: \\[\nE\\{N^*(t) \\mid Z\\} = \\exp(\\beta Z)\\mu_0(t),\n\\]\n\nWhat is the mean function in each group, i.e., \\(E\\{N^*(t) \\mid Z = z\\}\\) for \\(z= 1, 0\\)?\nSuppose \\(\\hat\\beta = \\log(0.8)\\), interpret the treatment effect."
  },
  {
    "objectID": "chap10.html",
    "href": "chap10.html",
    "title": "Applied Survival Analysis",
    "section": "",
    "text": "Cause-specific hazard and cumulative incidence\nNon- and semi-parametric methods\nAnalysis of bone marrow transplantation study\nSemi-competing risks and examples\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\cc}{{\\rm c}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\]"
  },
  {
    "objectID": "chapter11.html#r-code",
    "href": "chapter11.html#r-code",
    "title": "Chapter 11 - Joint Analysis of Longitudinal and Survival Data",
    "section": "R Code",
    "text": "R Code\n\n\nShow the code\n###############################################################################\n# Chapter 11 R Code\n#\n# This script reproduces all major numerical results in Chapter 11, including:\n#   1. Joint modeling of HIV/AIDS data (antiretroviral trial) using {JM}\n#   2. Multivariate joint modeling for heart valve study using {JMbayes2}\n###############################################################################\n\n\n#==============================================================================\n# (A) Analysis of the Antiretroviral Drug Trial\n#==============================================================================\nlibrary(tidyverse)   # For data manipulation and ggplot\nlibrary(survival)    # For survival analysis (e.g., coxph)\nlibrary(JM)          # Joint Modeling package\n\n#------------------------------------------------------------------------------\n# 1. Read and Prepare Data\n#------------------------------------------------------------------------------\ndf &lt;- read.table(\"Data//Anti-retroviral Trial//aids.txt\")\nhead(df)\n\n# Create a de-duplicated data set for the survival sub-model\ndf_surv &lt;- df[!duplicated(df$id), ]\n\n#------------------------------------------------------------------------------\n# 2. Longitudinal Sub-Model\n#------------------------------------------------------------------------------\n# Linear trajectory for sqrt(CD4) over time\nlongit_sub &lt;- lme(\n  CD4 ~ obsmo + obsmo:drug + sex + hist,\n  random = ~ obsmo | id,\n  data   = df\n)\n\n# Alternative with natural splines:\n# longit_sub &lt;- lme(\n#   CD4 ~ ns(obsmo, 3) + ns(obsmo, 3):drug + sex + hist,\n#   random = list(id = pdDiag(form = ~ ns(time, 3))),\n#   data   = df\n# )\n\n#------------------------------------------------------------------------------\n# 3. Survival Sub-Model\n#------------------------------------------------------------------------------\nsurv_sub &lt;- coxph(\n  Surv(time, status) ~ drug + sex + hist,\n  data = df_surv,\n  x    = TRUE\n)\n\n#------------------------------------------------------------------------------\n# 4. Joint Model (Piecewise-Constant Baseline Hazard)\n#------------------------------------------------------------------------------\nobj_joint &lt;- jointModel(\n  longit_sub,\n  surv_sub,\n  timeVar = \"obsmo\",\n  method  = \"piecewise-PH-aGH\"\n)\n\n# Alternatively, a 3-month lag:\n# obj_join_l3m &lt;- jointModel(\n#   longit_sub, surv_sub,\n#   timeVar = \"obsmo\", lag = 3,\n#   method  = \"piecewise-PH-aGH\"\n# )\n\n# Print summary\nsummary(obj_joint)\n\n#------------------------------------------------------------------------------\n# 5. Parameter Extraction and Basic Table\n#------------------------------------------------------------------------------\ncoef   &lt;- obj_joint$coefficients   # Coefficients from model\ncoef$D                             # Covariance matrix of random effects\nbeta   &lt;- c(coef$gammas, coef$alpha)  # Survival-related parameters\ngamma  &lt;- coef$betas                  # Longitudinal parameters\n\nhmat &lt;- obj_joint$Hessian\nVar  &lt;- solve(hmat)          # Inverse Hessian =&gt; approximate variance matrix\nse   &lt;- sqrt(diag(Var))\n\n# Prepare table for survival sub-model\nse_beta &lt;- se[str_detect(names(se), \"T.\")][1:4]  # Extract relevant subset\nza      &lt;- qnorm(0.975)\n\ncox_tab &lt;- tibble(\n  ` `       = c(\"ddI v. ddC\", \"Male v. female\",\n                \"Infection history (No v. yes)\",\n                \"CD4 count (mm^3)\"),\n  HR       = round(exp(beta), 2),\n  CI       = paste0(\n    \"(\",\n    round(exp(beta - za * se_beta), 2), \", \",\n    round(exp(beta + za * se_beta), 2), \")\"\n  ),\n  `p-value`= scales::pvalue(2 * (1 - pnorm(abs(beta / se_beta))))\n)\n\nknitr::kable(cox_tab, align = \"c\")\n\n#------------------------------------------------------------------------------\n# 6. Residual Analysis\n#------------------------------------------------------------------------------\n# Base R diagnostic plots\npar(mfrow = c(2, 2))\nplot(obj_joint)  # built-in {JM} diagnostic\n\n# Extract residuals\nepsilons &lt;- residuals(obj_joint, process = \"Longitudinal\", type = \"Subject\")  # subject-level\nRs       &lt;- residuals(obj_joint, process = \"Longitudinal\", type = \"Marginal\") # marginal\nmart     &lt;- residuals(obj_joint, process = \"Event\")                           # event-level\n\n# Fitted m_i(t): subtract subject-specific residual from observed\nms &lt;- df$CD4 - epsilons\n\n# Plot 1: Observed vs. fitted Y\npred_v_obs &lt;- tibble(\n  x = ms,\n  y = df$CD4\n) %&gt;%\n  ggplot(aes(x = x, y = y)) +\n  geom_point(color = \"gray20\") +\n  geom_abline(intercept = 0, slope = 1, linewidth = 0.8, linetype = 2) +\n  xlim(c(0, 22)) +\n  ylim(c(0, 22)) +\n  labs(\n    x     = expression(\"Fitted \" ~ hat(m)[i](t[j])),\n    y     = expression(\"Observed \" ~ Y[ij]),\n    title = \"Overall fit of longitudinal model\"\n  ) +\n  theme_minimal() +\n  theme(plot.title = element_text(size = 12))\n\npred_v_obs\n\n# Plot 2: QQ plot for measurement error\neps_qq &lt;- tibble(\n  epsilons = epsilons\n) %&gt;%\n  ggplot(aes(sample = epsilons)) +\n  stat_qq(color = \"gray20\") +\n  stat_qq_line(linewidth = 0.8, linetype = 2) +\n  labs(\n    x     = \"Normal Quantiles\",\n    y     = expression(\"Quantiles of \" ~ hat(epsilon)[ij]),\n    title = \"Normal QQ plot of measurement error\"\n  ) +\n  theme_minimal() +\n  theme(plot.title = element_text(size = 12))\n\neps_qq\n\n# Plot 3: Residual vs. observed outcome\neps_v_y &lt;- tibble(\n  x = df$CD4,\n  y = epsilons\n) %&gt;%\n  ggplot(aes(x = x, y = y)) +\n  geom_point(color = \"gray20\") +\n  geom_hline(yintercept = 0, linewidth = 0.8, linetype = 2) +\n  labs(\n    x     = expression(\"Observed \" ~ Y[ij]),\n    y     = expression(\"Residual \" ~ hat(epsilon)[ij]),\n    title = \"Homoscedasticity of measurement error\"\n  ) +\n  theme_minimal() +\n  theme(plot.title = element_text(size = 12))\n\neps_v_y\n\n# Plot 4: Martingale residual vs. fitted biomarker\nmart_v_mi &lt;- tibble(\n  x = ms,\n  y = mart\n) %&gt;%\n  ggplot(aes(x = x, y = y)) +\n  geom_point(color = \"gray20\") +\n  geom_smooth(color = \"black\", se = FALSE) +\n  geom_hline(yintercept = 0, linetype = 3) +\n  labs(\n    x     = expression(\"Fitted \" ~ hat(m)[i](t[j])),\n    y     = \"Martingale residuals\",\n    title = \"Martingale residual vs. biomarker\"\n  ) +\n  theme_minimal() +\n  theme(plot.title = element_text(size = 12))\n\nmart_v_mi\n\n# Combine with patchwork\nlibrary(patchwork)\n(pred_v_obs + eps_qq) / (eps_v_y + mart_v_mi)\n\n# Save figure\n# ggsave(\"images/longit_aids_resids.png\", width = 8, height = 8)\n# ggsave(\"images/longit_aids_resids.eps\", width = 8, height = 8)\n\n#------------------------------------------------------------------------------\n# 7. Model-Based Mean Trajectories (Figure)\n#------------------------------------------------------------------------------\n# Compute the mean trajectories based on the fitted longitudinal sub-model\nt &lt;- (0:180) / 10\n\ng0 &lt;- gamma[1]\ng1 &lt;- gamma[2]\ng3 &lt;- gamma[4]\ng4 &lt;- gamma[5]\n\n# ddC: baseline drug, with/without history\nddC_nonhist &lt;- (g0 + g3 + g1 * t)^2\nddC_hist    &lt;- (g0 + g1 * t)^2\n\n# ddI: alternate drug, with/without history\nddI_nonhist &lt;- (g0 + g3 + (g1 + g4)*t)^2\nddI_hist    &lt;- (g0 + (g1 + g4)*t)^2\n\n# Base R: Two-panel plot\npar(mfrow = c(1, 2))\n\nplot(\n  t, ddC_nonhist,\n  type       = \"l\",\n  frame.plot = FALSE,\n  main       = \"No previous infection\",\n  xlim       = c(0, 18),\n  ylim       = c(0, 120),\n  xlab       = \"Time (months)\",\n  ylab       = \"Mean CD4 cell count\",\n  lwd        = 2\n)\nlines(t, ddI_nonhist, lty = 3, lwd = 2)\n\nplot(\n  t, ddC_hist,\n  type       = \"l\",\n  frame.plot = FALSE,\n  main       = \"Previous infection\",\n  xlim       = c(0, 18),\n  ylim       = c(0, 120),\n  xlab       = \"Time (months)\",\n  ylab       = \"Mean CD4 cell count\",\n  lwd        = 2\n)\nlines(t, ddI_hist, lty = 3, lwd = 2)\n\n# ggplot version\nm &lt;- length(t)\ntibble(\n  t    = rep(t, 4),\n  CD4  = c(ddC_nonhist, ddI_nonhist, ddC_hist, ddI_hist),\n  trt  = rep(rep(c(\"ddC\", \"ddI\"), each = m), 2),\n  hist = rep(c(\"No previous infection\", \"Previous infection\"), each = 2*m)\n) %&gt;%\n  ggplot(aes(x = t, y = CD4, linetype = trt)) +\n  geom_line(linewidth = 0.8) +\n  facet_wrap(~ hist) +\n  scale_x_continuous(breaks = seq(0, 18, 6)) +\n  scale_y_continuous(limits = c(0, 120), breaks = seq(0, 120, 30)) +\n  labs(\n    x        = \"Time (months)\",\n    y        = expression(\"CD4 cell count / mm\"^3),\n    linetype = NULL\n  ) +\n  theme_minimal() +\n  theme(\n    legend.position = \"top\",\n    strip.text      = element_text(size = 11),\n    legend.text     = element_text(size = 11),\n    legend.key.width= unit(1, \"cm\")\n  )\n\n# ggsave(\"images/longit_mean_cd4.png\", width = 8, height = 4.5)\n# ggsave(\"images/longit_mean_cd4.eps\", width = 8, height = 4.5)\n\n\n#==============================================================================\n# (B) Multivariate Analysis (JMbayes2) – Heart Valve Study\n#==============================================================================\nlibrary(JMbayes2)\n\n#------------------------------------------------------------------------------\n# 1. Read and Inspect Data\n#------------------------------------------------------------------------------\ndf_valve &lt;- read.table(\"Data//Heart Valve Implantation Study//heartv.txt\", header = TRUE)\n\n# Basic descriptive info\nn &lt;- length(unique(df_valve$id))\nnum_deaths &lt;- df_valve %&gt;%\n  group_by(id) %&gt;%\n  slice(1) %&gt;%\n  filter(status == 1) %&gt;%\n  nrow()\n\n#------------------------------------------------------------------------------\n# 2. Longitudinal Sub-Models\n#------------------------------------------------------------------------------\n# (1) Binary outcome: ejection fraction &lt;= 50%\nef_mod &lt;- mixed_model(\n  ef50 ~ obsyear + age + sex + vsize + lvef + redo + cabg + acei + hc + emergenc,\n  random = ~ obsyear | id,\n  data   = df_valve,\n  family = binomial()\n)\nsummary(ef_mod)\n\n# (2) Log valve gradient\ngrad_mod &lt;- lme(\n  grad ~ obsyear + age + sex + vsize + lvef + redo + cabg + acei + hc + emergenc,\n  random = ~ obsyear | id,\n  data   = df_valve\n)\nsummary(grad_mod)\n\n# (3) Log LV mass index\nlvmi_mod &lt;- lme(\n  lvmi ~ obsyear + age + sex + vsize + lvef + redo + cabg + acei + hc + emergenc,\n  random = ~ obsyear | id,\n  data   = df_valve\n)\nsummary(lvmi_mod)\n\n#------------------------------------------------------------------------------\n# 3. Survival Sub-Model\n#------------------------------------------------------------------------------\ndf_surv_valve &lt;- df_valve[!duplicated(df_valve$id), ]\nsurv_mod &lt;- coxph(\n  Surv(surv_time, status) ~ age + sex,\n  data = df_surv_valve\n)\n\n#------------------------------------------------------------------------------\n# 4. Multivariate Joint Model in JMbayes2\n#------------------------------------------------------------------------------\n# Define functional forms in the Cox sub-model\nfForms &lt;- list(\n  \"ef50\" = ~ value(ef50),\n  \"grad\" = ~ slope(grad) + value(grad),\n  \"lvmi\" = ~ slope(lvmi) + value(lvmi)\n)\n\n# Fit the joint model (may require MCMC or default settings)\nobj_valve &lt;- jm(\n  surv_mod,\n  list(ef_mod, grad_mod, lvmi_mod),\n  time_var        = \"obsyear\",\n  functional_forms= fForms\n)\nsummary(obj_valve)\n\n#------------------------------------------------------------------------------\n# 5. Extract and Tabulate Results\n#------------------------------------------------------------------------------\nstats &lt;- obj_valve$statistics\nstats_mean &lt;- stats$Mean\nstats_sd   &lt;- stats$SD\n\n# A) Longitudinal sub-model estimates\ngamma_ef50_est &lt;- stats_mean$betas1\ngamma_ef50_se  &lt;- stats_sd$betas1\n\ngamma_grad_est &lt;- stats_mean$betas2\ngamma_grad_se  &lt;- stats_sd$betas2\n\ngamma_lvmi_est &lt;- stats_mean$betas3\ngamma_lvmi_se  &lt;- stats_sd$betas3\n\nza &lt;- qnorm(0.975)\n\n# Helper function to format estimates + CIs\nest_ci &lt;- function(est, se, r = 2, exponentiate = TRUE) {\n  if (exponentiate) {\n    paste0(\n      round(exp(est), r), \" (\",\n      round(exp(est - za * se), r), \", \",\n      round(exp(est + za * se), r), \")\"\n    )\n  } else {\n    paste0(\n      round(est, r), \" (\",\n      round(est - za * se, r), \", \",\n      round(est + za * se, r), \")\"\n    )\n  }\n}\n\npval_calc &lt;- function(est, se) {\n  scales::pvalue(1 - pchisq((est / se)^2, df = 1))\n}\n\n# Example table\ndf_res &lt;- tibble(\n  variable = c(\n    \"(Intercept)\", \"Years after surgery\", \"Age (years)\", \"Male vs. female\",\n    \"Valve size\", \"LVEF grade (1–3)\", \"History of surgery\", \"CABG\",\n    \"ACE inhibitor\", \"High cholesterol\", \"Emergency grade (1–3)\"\n  ),\n  EF_OR = est_ci(gamma_ef50_est, gamma_ef50_se, r = 2, exponentiate = TRUE),\n  Grad  = est_ci(gamma_grad_est, gamma_grad_se, r = 2, exponentiate = FALSE),\n  LVMI  = est_ci(gamma_lvmi_est, gamma_lvmi_se, r = 2, exponentiate = FALSE)\n)\ndf_res\n\n# B) Survival sub-model\nnu    &lt;- stats_mean$alphas\nnu_se &lt;- stats_sd$alphas\n\ncox_df &lt;- tibble(\n  variable = c(\n    \"EF&lt;= 50% (log-odds)\",\n    \"LV gradient (mmHg)\",\n    \"LV gradient slope (mmHg/yr)\",\n    \"LVMI (g/m^2)\",\n    \"LVMI slope (g/m^2/yr)\"\n  ),\n  HR   = est_ci(nu, nu_se, r = 2, exponentiate = TRUE),\n  pval = pval_calc(nu, nu_se)\n)\ncox_df\n\n#------------------------------------------------------------------------------\n# 6. Dynamic Predictions\n#------------------------------------------------------------------------------\n# Example: time t0=3 years for patient id=3\nt0    &lt;- 3\nnewdf &lt;- df_valve[df_valve$id == 3, ]            # data for this patient\nnewdf &lt;- newdf[newdf$obsyear &lt; t0, ]             # only times before t0\nnewdf$status     &lt;- 0                            # assume alive at t0\nnewdf$surv_time  &lt;- t0\n\n# Predict longitudinal trajectories from t0 to 10\npred_longit &lt;- predict(\n  obj_valve,\n  newdata     = newdf,\n  times       = seq(t0, 10, length.out = 10),\n  return_newdata = TRUE\n)\n\n# Base R plot\npar(mfrow = c(1, 3))\npar(mar   = c(5, 5.2, 2, 1))\n\nplot(\n  pred_longit,\n  outcomes  = 1:3,\n  ylab_long = c(\n    \"Probability of reduced LVEF\",\n    \"Valve gradient (mmHg)\",\n    expression(\"LVMI (\" ~ g/m^2 ~ \")\")\n  ),\n  xlab        = \"Time (years)\",\n  xlim        = c(0, 10),\n  cex_axis    = 1.5,\n  cex_xlab    = 1.8,\n  cex_ylab_long = 1.8,\n  col_points   = \"gray20\",\n  col_line_long= \"black\",\n  fill_CI_long = \"gray80\"\n)\n\n# Predict survival probabilities\npred_surv &lt;- predict(\n  obj_valve,\n  newdata     = newdf,\n  process     = \"event\",\n  times       = seq(t0, 10, length.out = 10),\n  return_newdata = TRUE\n)\n\n# Combined event + longitudinal\npar(mfrow = c(1, 1))\nplot(\n  pred_longit, pred_surv,\n  outcomes   = 1:3,\n  fun_event  = function(x) 1 - x,  # survival = 1 - CIF\n  ylab_event = \"Survival Probabilities\",\n  ylab_long  = c(\n    \"Probability of reduced LVEF\",\n    \"LV gradient (mmHg)\",\n    expression(\"LVMI (\" ~ g/m^2 ~ \")\")\n  ),\n  pos_ylab_long = c(0.5, 40, 300),\n  col_points    = \"gray20\",\n  col_line_long = \"black\",\n  fill_CI_long  = \"gray80\",\n  col_line_event= \"black\",\n  fill_CI_event = \"gray80\",\n  xlab   = \"Time (years)\",\n  xlim   = c(0, 10),\n  cex_axis= 1.2,\n  cex_xlab= 1,\n  cex_ylab_long = 1.2,\n  cex_ylab_event= 1\n)\n\n# Print predicted survival at 10 years\npred_surv %&gt;%\n  dplyr::filter(surv_time == 10) %&gt;%\n  dplyr::select(id, surv_time, pred_CIF, low_CIF, upp_CIF) %&gt;%\n  mutate(\n    pred  = round(1 - pred_CIF, 3),\n    lower = round(1 - upp_CIF, 3),\n    upper = round(1 - low_CIF, 3)\n  )",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 11 - Joint Analysis of Longitudinal and Survival Data"
    ]
  },
  {
    "objectID": "chap12.html#outline",
    "href": "chap12.html#outline",
    "title": "Applied Survival Analysis",
    "section": "Outline",
    "text": "Outline\n\n\nBasic concepts and examples\nTransition intensity and probability\nCox-type Markov and semi-Markov models\nAnalysis of the German breast cancer study\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\cc}{{\\rm c}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\] \\[\n\\newcommand\\mymathop[1]{\\mathop{\\operatorname{#1}}}\n\\]"
  },
  {
    "objectID": "chap12.html#definition-and-concepts",
    "href": "chap12.html#definition-and-concepts",
    "title": "Applied Survival Analysis",
    "section": "Definition and Concepts",
    "text": "Definition and Concepts\n\n\nMultistate processes\n\nStochastic process with discrete values indicating the subject’s current state\n\nAn alternative way of looking at (complex) time-to-event data\n\nExample: healthy \\(\\to\\) ill (hospitalized) \\(\\to\\) dead\n\n\n\n\n\nTerminology\n\nTransition: change of state, e.g., relapse, hospitalization, death\nAbsorbing state: a terminal state (no transition after entering), e.g., dead\nTransient state: a non-terminal state, e.g., hospitalized \\(\\to\\) discharge/death"
  },
  {
    "objectID": "chap12.html#life-death-competing-risks",
    "href": "chap12.html#life-death-competing-risks",
    "title": "Applied Survival Analysis",
    "section": "Life-Death & Competing Risks",
    "text": "Life-Death & Competing Risks\n\n\nMultistate model\n\nA model specifying possible transitions\n\n\n\n\n\nExamples\n\nLife-death (two states: transient \\(\\to\\) absorbing)\nCompeting risks (\\(K+1\\) states: transient \\(\\to\\) \\(K\\) absorbing states)"
  },
  {
    "objectID": "chap12.html#illness-death-model",
    "href": "chap12.html#illness-death-model",
    "title": "Applied Survival Analysis",
    "section": "Illness-Death Model",
    "text": "Illness-Death Model\n\n\nExamples\n\nIllness-death model (three states: healthy, ill/hospitalized, dead)\nSemi-competing risks\n\nProgressive: healthy \\(\\to\\) ill \\(\\to\\) dead\nReversible: healthy \\(\\rightleftharpoons\\) ill \\(\\to\\) dead"
  },
  {
    "objectID": "chap12.html#recurrent-events",
    "href": "chap12.html#recurrent-events",
    "title": "Applied Survival Analysis",
    "section": "Recurrent Events",
    "text": "Recurrent Events\n\n\nExamples\n\nRecurrent events (with death) (progressive transient states \\(\\to\\) absorbing) \n\n\n\n\n\nTwo types of processes\n\nProgressive: only forward, no turning back\nReversible: may go back and forth (hospital admission/discharge)"
  },
  {
    "objectID": "chap12.html#outcome-data",
    "href": "chap12.html#outcome-data",
    "title": "Applied Survival Analysis",
    "section": "Outcome Data",
    "text": "Outcome Data\n\n\nOutcome: multistate process \\[\nY(t)\\in \\{0, 1,\\ldots, K\\},\\,\\,\\, t\\geq 0\n\\]\n\n\\((K+1)\\) distinct states\nExample\n\n\\(0=\\) remission, \\(1=\\) relapsed, \\(2\\) = dead\n\\(0=\\) event-free, \\(k=1,\\ldots, K\\): cumulative number of hospitalizations (\\(K + 1 =\\) dead)\n\n\n\n\n\n\nLife history\n\\[\\begin{equation}\\label{eq:multi_state:lh1}\n\\mathcal H^*(t)=\\{Y(u):0\\leq u\\leq t\\}\n\\end{equation}\\]\n\nPast experience up to time \\(t\\)"
  },
  {
    "objectID": "chap12.html#counting-process-notation",
    "href": "chap12.html#counting-process-notation",
    "title": "Applied Survival Analysis",
    "section": "Counting Process Notation",
    "text": "Counting Process Notation\n\n\nCounting transitions\n\n\\(N_{kj}^*(t)\\): number of \\(k\\to j\\) transitions by \\(t\\) \\[\n\\dd N_{kj}^*(t)=I\\{Y(t)=j, Y(t-)=k\\}\n\\]\n\n\\(0\\leq k\\neq j\\leq K\\) (not all are possible)\n\nExamples\n\nLife-death model: \\(N_{01}^*(t)\\) counting process for death\nIllness-death model: \\(N_{01}^*(t)\\) counting process for onset of illness, \\(N_{02}^*(t)\\) for death without illness, \\(N_{12}^*(t)\\) for death with illness\n\nLife history re-formulated \\[\n  \\mathcal H^*(t)=\\{Y(0), N_{kj}^*(u): 1\\leq k\\neq j\\leq K; 0\\leq u\\leq t\\}\n\\]"
  },
  {
    "objectID": "chap12.html#intensity-function-definition",
    "href": "chap12.html#intensity-function-definition",
    "title": "Applied Survival Analysis",
    "section": "Intensity Function: Definition",
    "text": "Intensity Function: Definition\n\n\nTransition intensity\n\nInstantaneous rate of transition given past \\[\\begin{align}\\label{eq:multi_state:intensity}\n\\lambda_{kj}\\{t\\mid\\mathcal H^*(t-)\\}\\dd t&=\\pr\\{\\underbrace{Y(t+\\dd t)=j}_{\\text{Next state}}\\mid \\underbrace{Y(t-)=k}_{\\text{Current state}}, \\underbrace{\\mathcal H^*(t-)}_{\\text{Past experience}}\\}\\notag\\\\\n&=E\\{\\dd N_{kj}^*(t)\\mid Y(t-)=k,\\mathcal H^*(t-)\\}\n\\end{align}\\]\nSelf-generating: completely determines distribution of \\(Y(\\cdot)\\)\nWith (time-varying) covariates \\[\\begin{equation}\\label{eq:multi_state:lh2}\n\\mathcal H^*(t)=\\{Y(u), Z:0\\leq u\\leq t\\}\n\\end{equation}\\] \\[\\begin{equation}\\label{eq:multi_state:lh3}\n\\mathcal H^*(t)=\\{Y(u), Z(u):0\\leq u\\leq t\\}\n\\end{equation}\\]\n\nPast data include baseline and previous trajectory of covariates"
  },
  {
    "objectID": "chap12.html#intensity-function-examples-i",
    "href": "chap12.html#intensity-function-examples-i",
    "title": "Applied Survival Analysis",
    "section": "Intensity Function: Examples (I)",
    "text": "Intensity Function: Examples (I)\n\n\nWith \\(Y(0)\\equiv 0\\)\n\nLife-death model (\\(T\\): time to death) \\[\n\\lambda_{01}\\{t\\mid\\mathcal H^*(t-)\\} = \\lambda(t):\\,\\, \\mbox{hazard of $T$}\n\\]\nCompeting risks (\\(T\\): time to overall failure) \\[\n\\lambda_{0k}\\{t\\mid\\mathcal H^*(t-)\\} = \\lambda_k(t):\\,\\, \\mbox{$k$th cause-specific hazard}\n\\]"
  },
  {
    "objectID": "chap12.html#intensity-function-examples-ii",
    "href": "chap12.html#intensity-function-examples-ii",
    "title": "Applied Survival Analysis",
    "section": "Intensity Function: Examples (II)",
    "text": "Intensity Function: Examples (II)\n\n\nRecurrent events\n\nCounting process: \\(N^*(t)\\)\nIntensity for recurrent-event process (Chapter 9) \\[\\begin{equation}\\label{eq:rec:intensity}\n\\ell\\{t\\mid \\overline{N}^*(t-)\\}\\dd t=E\\{\\dd N^*(t)\\mid \\overline{N}^*(t-)\\}\n\\end{equation}\\]\nIntensity for transition \\[\\begin{align}\n\\lambda_{k-1,k}\\{t\\mid\\mathcal H^*(t-)\\}\\dd t &= E\\{\\dd N^*(t)\\mid N^*(t-) =k-1, \\overline{N}^*(t-)\\}\\\\\n&= \\mbox{A sub-function of }\\ell\\{t\\mid \\overline{N}^*(t-)\\}\n\\end{align}\\]"
  },
  {
    "objectID": "chap12.html#markov-semi-markov-processes",
    "href": "chap12.html#markov-semi-markov-processes",
    "title": "Applied Survival Analysis",
    "section": "Markov & Semi-Markov Processes",
    "text": "Markov & Semi-Markov Processes\n\n\nMarkov: transition independent of past given current state \\[\n    \\lambda_{kj}\\{t\\mid\\mathcal H^*(t-)\\}=\\lambda_{kj}(t)\\,\\,\\, \\mbox{fixed function}\n    \\]\n\nHomogeneous Markov: \\(\\lambda_{kj}(t)\\equiv \\lambda_{kj}\\)\n\n\n\n\n\nSemi-Markov: transition depends on past through time in current state \\[\n    \\lambda_{kj}\\{t\\mid\\mathcal H^*(t-)\\}=\\lambda_{kj}\\{t, B(t)\\}\n    \\]\n\n\\(B(t)\\): time since last entry into current state\nExample: risk of death depends on how long cancer has reappeared"
  },
  {
    "objectID": "chap12.html#markov-semi-markov-examples",
    "href": "chap12.html#markov-semi-markov-examples",
    "title": "Applied Survival Analysis",
    "section": "Markov & Semi-Markov Examples",
    "text": "Markov & Semi-Markov Examples\n\n\nIllness-death model (semi-competing risks)\n\nTransition intensities for \\(0\\to 1\\) (onset of illness), \\(0\\to 2\\) (death w.o. illness) \\[\n\\lambda_{01}(t) \\mbox{ and } \\lambda_{02}(t): \\,\\, \\mbox{always deterministic}\n\\]\n\nNo prior data to condition on\n\nTransition intensity for \\(1\\to 2\\) (death with illness) \\[\\begin{align}\n\\mbox{Markov model}:&\\,\\,\\, \\lambda_{12}\\{t\\mid\\mathcal H^*(t-)\\}=\\lambda_{12}(t) \\\\\n  \\mbox{Semi-Markov model}:&\\,\\,\\, \\lambda_{12}\\{t\\mid\\mathcal H^*(t-)\\}=\\lambda_{12}(t, t - T)\n\\end{align}\\] \\(T\\): time to onset of illness"
  },
  {
    "objectID": "chap12.html#transition-probability-definition",
    "href": "chap12.html#transition-probability-definition",
    "title": "Applied Survival Analysis",
    "section": "Transition Probability: Definition",
    "text": "Transition Probability: Definition\n\n\nTransition Probability\n\nDefinition \\[\\begin{equation}\\label{eq:multi_state:trans_prob}\nP_{kj}\\{s,t\\mid\\mathcal H^*(s-)\\}=\\pr\\{\\underbrace{Y(t)=j}_{\\text{Future state}}\\mid \\underbrace{Y(s-)=k}_{\\text{Current state}}, \\underbrace{\\mathcal H^*(s-)}_{\\text{Past experience}}\\}\n\\end{equation}\\]\n\nProbability of being in state \\(j\\) at future time \\(t\\) given current state \\(k\\) at \\(s\\)\n\nRelation with intensity \\[\\lambda_{kj}\\{t\\mid\\mathcal H^*(t-)\\}\\dd t=P_{kj}\\{t,t\\mid\\mathcal H^*(t-)\\}\\] \\[\\begin{align}\n\\mbox{Transition probability }\n\\mymathop{\\rightleftharpoons}_{\\mbox{cumulative}}^{\\mbox{instantaneous}} \\mbox{ intensity}\n\\end{align}\\]\n\nSimilarly to c.d.f. \\(\\leftrightarrows\\) hazard"
  },
  {
    "objectID": "chap12.html#transition-probability-examples-i",
    "href": "chap12.html#transition-probability-examples-i",
    "title": "Applied Survival Analysis",
    "section": "Transition Probability: Examples (I)",
    "text": "Transition Probability: Examples (I)\n\n\nLife-death model\n\n\\(\\lambda_{01}(t)\\): hazard for death \\[\\begin{align}\nP_{00}(0, t)&=\\exp\\left\\{-\\int_0^t\\lambda_{01}(u)\\dd u\\right\\}\\,\\,\\, \\mbox{(Survival)}\\\\\nP_{01}(0, t)&=1-\\exp\\left\\{-\\int_0^t\\lambda_{01}(u)\\dd u\\right\\}\\,\\,\\,  \\mbox{(c.d.f. of death)}\n\\end{align}\\]\n\n\n\n\n\nCompeting risks\n\n\\(\\lambda_{0k}(t)\\): cause-specific hazard for \\(k\\)th risk \\[\\begin{align}\nP_{00}(0, t)&=\\exp\\left\\{-\\int_0^t\\sum_{k=1}^K\\lambda_{0k}(u)\\dd u\\right\\}\\,\\,\\, \\mbox{(Overall survival)}\\\\\nP_{0k}(0, t)&=\\int_0^t P_{00}(0, u-)\\lambda_{0k}(u)\\dd u\\,\\,\\,  \\mbox{(Cumulative incidence\nof $k$th risk)}\n\\end{align}\\]"
  },
  {
    "objectID": "chap12.html#transition-probability-examples-ii",
    "href": "chap12.html#transition-probability-examples-ii",
    "title": "Applied Survival Analysis",
    "section": "Transition Probability: Examples (II)",
    "text": "Transition Probability: Examples (II)\n\n\nIllness-death model (semi-competing risks)\n\n\\(\\lambda_{01}(t), \\lambda_{02}(t)\\): cause-specific hazard for onset of illness or death w.o. illness \\[\nP_{00}(0, t)=\\exp\\left[-\\int_0^t\\{\\lambda_{01}(u)+\\lambda_{02}(u)\\}\\dd u\\right]\n\\]\n\\(P_{01}(0, t)\\) and \\(P_{02}(0, t)\\) more complicated and depends on \\(\\lambda_{12}\\{t\\mid\\mathcal H^*(t-)\\}\\)\nMarkov Process: \\(\\lambda_{12}\\{t\\mid\\mathcal H^*(t-)\\}=\\lambda_{12}(t)\\) \\[\\begin{equation}\\label{eq:multi_state:ill_death}\nP_{12}(s, t)=\\exp\\left\\{-\\int_s^t\\lambda_{12}(u)\\dd u\\right\\}\n\\end{equation}\\]"
  },
  {
    "objectID": "chap12.html#observed-data",
    "href": "chap12.html#observed-data",
    "title": "Applied Survival Analysis",
    "section": "Observed Data",
    "text": "Observed Data\n\n\nCensored life history\n\n\\(\\mathcal H(t)=\\{Y(u):0\\leq u\\leq t\\wedge C\\}\\)\n\n\n\n\n\nAlternate formulation\n\nFocusing on (observed) transitions \\(k\\to j\\)\n\n\\(u_k^{(r)}\\): \\(r\\)th time subject enters state \\(k\\)\n\\(v_k^{(r)}\\): exit or censoring time\n\\(\\delta_{kj}^{(r)}\\): indicator of observed transition to state \\(j\\) at \\(v_k^{(r)}\\) (0 if censored or going to other states)\n\nProgressive process \\(\\to\\) \\(r\\) redundant (why?)\nSuitable for models on intensities \\(\\lambda_{kj}\\{t\\mid\\mathcal H^*(t-)\\}\\)"
  },
  {
    "objectID": "chap12.html#likelihood-function",
    "href": "chap12.html#likelihood-function",
    "title": "Applied Survival Analysis",
    "section": "Likelihood Function",
    "text": "Likelihood Function\n\n\nObserved data \\[\\begin{equation}\\label{eq:multi_state:obs}\n    (u_k^{(r)}, v_k^{(r)}, \\delta_{kj}^{(r)}),\\hspace{3mm}r=1,2,\\ldots;\\hspace{2mm} 1\\leq k\\neq j\\leq K\n    \\end{equation}\\]\n\nCollection of all observed transitions\n\n\n\n\n\nLikelihood for a single subject \\[\\begin{equation}\\label{eq:multi_state:lik}\n    \\prod_{k\\neq j}^K\\prod_r\\lambda_{kj}\\left\\{v_k^{(r)}\\mid\\mathcal H^*(v_k^{(r)}-)\\right\\}^{\\delta_{kj}^{(r)}}\n    \\exp\\left[-\\int_{u_k^{(r)}}^{v_k^{(r)}}\\lambda_{kj}\\left\\{t\\mid\\mathcal H^*(t-)\\right\\}\\dd t\\right]\n    \\end{equation}\\]\n\nFactorize by transition intensities"
  },
  {
    "objectID": "chap12.html#inference-for-transition-intensity",
    "href": "chap12.html#inference-for-transition-intensity",
    "title": "Applied Survival Analysis",
    "section": "Inference for Transition Intensity",
    "text": "Inference for Transition Intensity\n\n\nLikelihood for \\(k\\to j\\) transition\n\nProgressive process \\[\n\\lambda_{kj}\\left\\{v_k\\mid\\mathcal H^*(v_k-)\\right\\}^{\\delta_{kj}}\n\\exp\\left[-\\int_{u_k}^{v_k}\\lambda_{kj}\\left\\{t\\mid\\mathcal H^*(t-)\\right\\}\\dd t\\right]\n\\]\nLeft-truncated, right-censored \\(N_{kj}^*(t)\\) with “hazard” \\(\\lambda_{kj}\\left\\{t\\mid\\mathcal H^*(t-)\\right\\}\\)\n\n\\(u_k\\): left-truncation (late entry) time\n\\(v_k\\): possibly censored event time\n\\(\\delta_{kj}\\): event indicator"
  },
  {
    "objectID": "chap12.html#semiparametric-regression-i",
    "href": "chap12.html#semiparametric-regression-i",
    "title": "Applied Survival Analysis",
    "section": "Semiparametric Regression (I)",
    "text": "Semiparametric Regression (I)\n\n\nModeling target\n\nCovariate-specific transition intensity \\[\n  \\lambda_{kj}\\{t\\mid\\mathcal H^*(t-), \\overline Z(t)\\} = E\\{\\dd N_{kj}^*(t)\\mid Y(t-)=k,\\mathcal H^*(t-), \\overline Z(t)\\}\n  \\]\n\n\\(Z(t)\\): possibly time-dependent covariates\n\n\n\n\n\n\nMultiplicative intensity models\n\nModulated (by covariates) Markov models \\[\\begin{equation}\\label{eq:multi_state:markov}\n\\lambda_{kj}\\{t\\mid\\mathcal H^*(t-), \\overline Z(t)\\}=\\exp\\{\\beta_{kj}^\\T Z(t)\\}\\lambda_{kj0}(t)\n\\end{equation}\\]\n\nRisk of transition independent of past given (current values of) covariates\n\\(\\beta_{kj}\\): log-intensity (risk) ratios of going to state \\(j\\) for those in state \\(k\\)"
  },
  {
    "objectID": "chap12.html#semiparametric-regression-ii",
    "href": "chap12.html#semiparametric-regression-ii",
    "title": "Applied Survival Analysis",
    "section": "Semiparametric Regression (II)",
    "text": "Semiparametric Regression (II)\n\n\nMultiplicative intensity models\n\nModulated semi-Markov models \\[\\begin{equation}\\label{eq:multi_state:semi_markov}\n\\lambda_{kj}\\{t\\mid\\mathcal H^*(t-)\\}=\\exp\\{\\beta_{kj}^\\T Z(t)+\\gamma_{kj} B(t)\\}\\lambda_{kj0}(t)\n\\end{equation}\\]\n\nRisk of transition depend on past through time last spent in current state and (current values) of covariates\n\\(\\gamma_{kj}\\): log-intensity (risk) ratio with unit increase in the time spent in current state\n\nExample: illness-death model\n\nSemi-Markov for \\(1\\to 2\\): risk of death in illness depends on how long the patient has been ill\n\\(\\gamma_{kj}\\): log-intensity (risk) ratio for death with unit increase in the time being ill"
  },
  {
    "objectID": "chap12.html#software-survivalcoxph-i",
    "href": "chap12.html#software-survivalcoxph-i",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::coxph() (I)",
    "text": "Software: survival::coxph() (I)\n\n\nInput data format\n\nLong format, one transition per row\n(start, stop): \\((u_k^{(r)}, v_k^{(r)})\\); status: \\(\\delta^{(r)}_{kj}\\)\n(from, to): \\((k, j)\\)\n\n\n\n# &gt; gbc_ms\n# id     start      stop status from to hormone age meno size grade nodes \n#  1  0.000000 43.836066      1    0  1       1  38    1   18     3     5  \n#  1  0.000000 43.836066      0    0  2       1  38    1   18     3     5 \n#  1 43.836066 74.819672      0    1  2       1  38    1   18     3     5 \n#  2  0.000000 46.557377      1    0  1       1  52    1   20     1     1 \n#  2  0.000000 46.557377      0    0  2       1  52    1   20     1     1 \n#  2 46.557377 65.770492      0    1  2       1  52    1   20     1     1 \n#   ..."
  },
  {
    "objectID": "chap12.html#software-survivalcoxph-ii",
    "href": "chap12.html#software-survivalcoxph-ii",
    "title": "Applied Survival Analysis",
    "section": "Software: survival::coxph() (II)",
    "text": "Software: survival::coxph() (II)\n\n\nBasic syntax for multiplicative intensity model\n\nFit each type of transition \\((k\\to j)\\) separately\n\nFactorization of likelihood\n\ncovariates: \\(Z(t)\\) and/or elements of \\(\\mathcal H^*(t-)\\), e.g., \\(B(t)\\)\n\n\n\n\n# Fit a model for transition k-&gt;j\nobj &lt;- coxph(Surv(start, stop, status) ~ covariates, \n       subset = (from == k) & (to == j))"
  },
  {
    "objectID": "chap12.html#whats-new",
    "href": "chap12.html#whats-new",
    "title": "Applied Survival Analysis",
    "section": "What’s New",
    "text": "What’s New\n\n\nStudy information\n\nPopulation: 686 patients with primary node positive breast cancer\nEndpoints: relapse of cancer and death (semi-competing risks)\n\nPreviously analyzed by time to earlier of relapse/death (RFS)\n\n\n\n\n\n\nMultistate perspective\n\nDoes hormonal treatment (or other risk factors) have differential effects on\n\nRelapse\nDeath in remission\nDeath after relapse"
  },
  {
    "objectID": "chap12.html#multistate-setup",
    "href": "chap12.html#multistate-setup",
    "title": "Applied Survival Analysis",
    "section": "Multistate Setup",
    "text": "Multistate Setup\n\n\nIllness-death model\n\n\n# &gt; gbc_ms\n# id     start      stop status from to hormone age meno size grade nodes \n#  1  0.000000 43.836066      1    0  1       1  38    1   18     3     5  \n#  1  0.000000 43.836066      0    0  2       1  38    1   18     3     5 \n#  1 43.836066 74.819672      0    1  2       1  38    1   18     3     5 \n#  2  0.000000 46.557377      1    0  1       1  52    1   20     1     1 \n#   ..."
  },
  {
    "objectID": "chap12.html#multiplicative-intensity-models",
    "href": "chap12.html#multiplicative-intensity-models",
    "title": "Applied Survival Analysis",
    "section": "Multiplicative Intensity Models",
    "text": "Multiplicative Intensity Models\n\n\nThree (semi-Markov) models\n\n\n# B(t): time spent in current state\ngbc_ms$Bt &lt;- gbc_ms$stop - gbc_ms$start\n\n### 0-&gt;1: remission to relapse ----------------------------------------\nobj01 &lt;- coxph(Surv(start, stop, status) ~ hormone + meno\n            + agec + size + prog + estrg + strata(grade), data = gbc_ms,\n            subset = ((from==0) & (to == 1)))\n### 0-&gt;2: remission to death ------------------------------------------\nobj02 &lt;- coxph(Surv(start, stop, status) ~ hormone + meno\n            + size + prog + estrg + strata(grade), data = gbc_ms,\n            subset = ((from == 0) & (to == 2)))\n### 1-&gt;2: relapse to death --------------------------------------------\nobj12 &lt;- coxph(Surv(start, stop, status) ~ Bt + hormone + meno\n            + agec + size + prog + estrg + strata(grade), data = gbc_ms,\n            subset = ((from == 1) & (to == 2)))"
  },
  {
    "objectID": "chap12.html#regression-results-i",
    "href": "chap12.html#regression-results-i",
    "title": "Applied Survival Analysis",
    "section": "Regression Results (I)",
    "text": "Regression Results (I)\n\n\nRegression table\n\nHormonal therapy beneficial on relapse (31.5% risk reduction; \\(p\\)-value 0.003)"
  },
  {
    "objectID": "chap12.html#regression-results-ii",
    "href": "chap12.html#regression-results-ii",
    "title": "Applied Survival Analysis",
    "section": "Regression Results (II)",
    "text": "Regression Results (II)\n\n\nRegression table\n\nHormonal therapy no effect on progression from relapse to death\nOne month away from relapse patient is at 10.7% less risk of mortality"
  },
  {
    "objectID": "chap12.html#notes",
    "href": "chap12.html#notes",
    "title": "Applied Survival Analysis",
    "section": "Notes",
    "text": "Notes\n\n\n\nMethods and Software\n\nNonparametric estimation of transition probability for Markov process: Chapter IV.4 of Andersen et al. (1991)\nText: Cook and Lawless (2018)\nR-packages\n\nmstate: competing risks models and prediction of transition probabilities\nmsm: Hidden Markov Models (HMMs) & standard models"
  },
  {
    "objectID": "chap12.html#summary",
    "href": "chap12.html#summary",
    "title": "Applied Survival Analysis",
    "section": "Summary",
    "text": "Summary\n\nMultistate models\n\nMultistate process \\(Y(t)\\in \\{0, 1,\\ldots, K\\}\\) \nTransition intensity: risk of going to another state given current state and history\n\nCox-type multiplicative intensity models\n\nMarkov or semi-Markov models for intensity \\(k\\to j\\)\n\ncoxph(Surv(start, stop, status) ~ covariates, subset = (from==k)&(to==j))"
  },
  {
    "objectID": "chap12.html#hw5-due-april-17",
    "href": "chap12.html#hw5-due-april-17",
    "title": "Applied Survival Analysis",
    "section": "HW5 (Due April 17)",
    "text": "HW5 (Due April 17)\n\nProblem 8.18\nChoose one\n\nProblem 10.6\nProblem 10.15\n\nProblem 11.18 (a) (“Data &gt; Renal Transplants Study”)\n(Extra credit) Problem 11.2"
  },
  {
    "objectID": "chap12.html#nonparametric-estimation-in-markov-process",
    "href": "chap12.html#nonparametric-estimation-in-markov-process",
    "title": "Applied Survival Analysis",
    "section": "Nonparametric Estimation in Markov Process",
    "text": "Nonparametric Estimation in Markov Process\n\n**Markov process*"
  },
  {
    "objectID": "chap12.html#estimation-in-markov-process",
    "href": "chap12.html#estimation-in-markov-process",
    "title": "Applied Survival Analysis",
    "section": "Estimation in Markov Process",
    "text": "Estimation in Markov Process\n\nTransition probability matrix \\[\n\\textbf{P}(s, t) \\;=\\;\n\\begin{bmatrix}\nP_{00}(s, t) & P_{01}(s, t) & \\cdots & P_{0K}(s, t) \\\\\nP_{10}(s, t) & P_{11}(s, t) & \\cdots & P_{1K}(s, t) \\\\\n\\vdots       & \\vdots       & \\ddots & \\vdots       \\\\\nP_{K0}(s, t) & P_{K1}(s, t) & \\cdots & P_{KK}(s, t)\n\\end{bmatrix}\n\\]"
  },
  {
    "objectID": "chap12.html#estimation-for-markov-process",
    "href": "chap12.html#estimation-for-markov-process",
    "title": "Applied Survival Analysis",
    "section": "Estimation for Markov Process",
    "text": "Estimation for Markov Process\n\nTransition probability vs. intensity\n\nTransition probability matrix \\[\n\\textbf{P}(s, t) \\;=\\;\n\\begin{bmatrix}\nP_{00}(s, t) & P_{01}(s, t) & \\cdots & P_{0K}(s, t) \\\\\nP_{10}(s, t) & P_{11}(s, t) & \\cdots & P_{1K}(s, t) \\\\\n\\vdots       & \\vdots       & \\ddots & \\vdots       \\\\\nP_{K0}(s, t) & P_{K1}(s, t) & \\cdots & P_{KK}(s, t)\n\\end{bmatrix}\n\\]\nIntensity matrix \\[\n\\dd\\mathbf{\\Lambda}(u) \\;=\\;\n\\begin{bmatrix}\n-\\sum_{k=1}^K \\lambda_{0k}(u) & \\lambda_{01}(u) & \\cdots & \\lambda_{0K}(u) \\\\\n\\lambda_{10}(u) & -\\sum_{k \\neq 1} \\lambda_{1k}(u) & \\cdots & \\lambda_{1K}(u) \\\\\n\\vdots & \\vdots & \\ddots & \\vdots \\\\\n\\lambda_{K0}(u) & \\lambda_{K1}(u) & \\cdots & -\\sum_{k=0}^{K-1} \\lambda_{Kk}(u)\n\\end{bmatrix} \\dd u.\n\\]"
  },
  {
    "objectID": "chap12.html#markov-process",
    "href": "chap12.html#markov-process",
    "title": "Applied Survival Analysis",
    "section": "Markov Process",
    "text": "Markov Process\n\n\nTransition intensity matrix \\[\n\\dd\\Lambda_{kj}(u) \\;=\\;\n\\begin{cases}\n\\lambda_{kj}(u) \\dd u, & \\text{if } k \\neq j, \\\\\n-\\sum_{l \\neq k} \\lambda_{kl}(u) \\dd u, & \\text{if } k = j\n\\end{cases}\n\\] i.e. \\[\n\\dd\\mathbf{\\Lambda}(u) \\;=\\;\n\\begin{bmatrix}\n-\\sum_{k=1}^K \\lambda_{0k}(u) & \\lambda_{01}(u) & \\cdots & \\lambda_{0K}(u) \\\\\n\\lambda_{10}(u) & -\\sum_{k \\neq 1} \\lambda_{1k}(u) & \\cdots & \\lambda_{1K}(u) \\\\\n\\vdots & \\vdots & \\ddots & \\vdots \\\\\n\\lambda_{K0}(u) & \\lambda_{K1}(u) & \\cdots & -\\sum_{k=0}^{K-1} \\lambda_{Kk}(u)\n\\end{bmatrix} \\dd u\n\\]"
  },
  {
    "objectID": "chap12.html#estimation-of-transition-intensity",
    "href": "chap12.html#estimation-of-transition-intensity",
    "title": "Applied Survival Analysis",
    "section": "Estimation of Transition Intensity",
    "text": "Estimation of Transition Intensity\n-   **Transition probability matrix**\n\\[\n\\textbf{P}(s, t) \\;=\\;\n\\begin{bmatrix}\nP_{00}(s, t) & P_{01}(s, t) & \\cdots & P_{0K}(s, t) \\\\\nP_{10}(s, t) & P_{11}(s, t) & \\cdots & P_{1K}(s, t) \\\\\n\\vdots       & \\vdots       & \\ddots & \\vdots       \\\\\nP_{K0}(s, t) & P_{K1}(s, t) & \\cdots & P_{KK}(s, t)\n\\end{bmatrix}\n\\]"
  },
  {
    "objectID": "chap12.html#transition-probability-vs.-intensity",
    "href": "chap12.html#transition-probability-vs.-intensity",
    "title": "Applied Survival Analysis",
    "section": "Transition Probability vs. Intensity",
    "text": "Transition Probability vs. Intensity\n\n\nTransition probability matrix\n\nDefinition \\[\n\\textbf{P}(s, t) =\n\\begin{bmatrix}\nP_{00}(s, t) & P_{01}(s, t) & \\cdots & P_{0K}(s, t) \\\\\nP_{10}(s, t) & P_{11}(s, t) & \\cdots & P_{1K}(s, t) \\\\\n\\vdots       & \\vdots       & \\ddots & \\vdots       \\\\\nP_{K0}(s, t) & P_{K1}(s, t) & \\cdots & P_{KK}(s, t)\n\\end{bmatrix}\n\\]\n\n\n\n\n\nProduct limit\n\n\\(s = u_0 &lt; u_1 &lt; \\cdots &lt; u_m = t\\), with \\(u_r - u_{r-1} = \\dd u\\) \\[\n\\textbf{P}(s, t) \\;=\\; \\lim_{\\dd u \\to 0}\n\\prod_{r = 1}^m \\bigl\\{ \\mathbf{I} \\,+\\, \\dd\\mathbf{\\Lambda}(u_r) \\bigr\\}\n\\]\n\\(\\mathbf{I}\\): Identity matrix"
  },
  {
    "objectID": "chap12.html#aalenjohansen-estimator",
    "href": "chap12.html#aalenjohansen-estimator",
    "title": "Applied Survival Analysis",
    "section": "Aalen–Johansen Estimator",
    "text": "Aalen–Johansen Estimator\n\n\nProduct-limit estimator \\[\n\\hat{\\textbf{P}}(s, t) \\;=\\; \\lim_{\\dd u \\to 0}\n\\prod_{r = 1}^m \\bigl\\{ \\mathbf{I} \\,+\\, \\dd\\hat{\\mathbf{\\Lambda}}(u_r) \\bigr\\}\n\\]\n\n\\(s = u_0 &lt; u_1 &lt; \\cdots &lt; u_m = t\\), with \\(u_r - u_{r-1} = \\dd u\\)\nReduces to KM, Gray’s estimator in life-death, competing risks models\n\n\n\n\n\nRobustness property\n\nValid even without Markov assumption"
  },
  {
    "objectID": "chap12.html#estimating-discrete-intensities",
    "href": "chap12.html#estimating-discrete-intensities",
    "title": "Applied Survival Analysis",
    "section": "Estimating Discrete Intensities",
    "text": "Estimating Discrete Intensities\n\n\nObserved data\n\n\\(C\\): censoring time\n\\(N_{kj}(t) = N^*_{kj}(t \\wedge C)\\) \\[\\begin{equation}\\label{eq:multi_state:censoredY}\n\\tilde Y(t) \\;=\\;\n\\begin{cases}\nY(t), & \\text{if uncensored by } t, \\\\\n-1,   & \\text{if censored by } t.\n\\end{cases}\n\\end{equation}\\]\n\n\n\n\n\nNelsen–Aalen-type estimator \\[\\begin{align}\\label{eq:multi_state:np_intensity}\n\\dd\\hat\\Lambda_{kj}(t)\n&\\;=\\; \\frac{\\text{Number of observed }k \\to j \\text{ transitions}}\n{\\text{Number of subjects at risk of a } k \\to j \\text{ transition}} \\notag\\\\\n&\\;=\\; \\frac{\\sum_{i=1}^n \\dd N_{kji}(t)}{\\sum_{i=1}^n I\\left\\{ \\tilde Y_i(t) = k \\right\\}}\n\\end{align}\\]"
  },
  {
    "objectID": "chap12.html#useful-functionals",
    "href": "chap12.html#useful-functionals",
    "title": "Applied Survival Analysis",
    "section": "Useful Functionals",
    "text": "Useful Functionals\n\n\nState-occupancy probability \\[\nP_k(t) = \\pr\\{Y(t) = k\\} = \\sum_{l=0}^K \\underbrace{\\pr\\{Y(0) = l\\}}_{\\text{Initial state}} \\, \\underbrace{P_{lk}(0, t)}_{\\text{Transition probability}}\n\\]\n\nExample: probability patient will be ill but still alive in one year\n\n\n\n\n\nRestricted mean sojourn time \\[\n\\mu_k(\\tau) = E\\left[ \\int_0^\\tau I\\{Y(t) = k\\} \\dd t \\right] = \\int_0^\\tau P_k(t) \\dd t\n\\]\n\nAverage time spent in state \\(k\\) (healthy, ill but alive, etc.) by time \\(\\tau\\)"
  },
  {
    "objectID": "chap12.html#hw5-due-april-16",
    "href": "chap12.html#hw5-due-april-16",
    "title": "Applied Survival Analysis",
    "section": "HW5 (Due April 16)",
    "text": "HW5 (Due April 16)\n\nProblem 8.18\nChoose one\n\nProblem 10.6\nProblem 10.15\n\nProblem 11.18 (a) (“Data &gt; Renal Transplants Study”)\n(Extra credit) Problem 11.2"
  },
  {
    "objectID": "chapter12.html#chapter-summary",
    "href": "chapter12.html#chapter-summary",
    "title": "Chapter 12 - Multistate Modeling of Life History",
    "section": "Chapter Summary",
    "text": "Chapter Summary\nMultistate models describe subjects transitioning through a series of discrete states over time (e.g., disease progression), generalizing standard survival models to accommodate multiple types or sequences of events. These models unify frameworks for competing risks, recurrent events, and semi-competing risks by specifying transition intensities between states and estimating quantities such as state occupancy and sojourn times.\n\nModel structure\nLet \\(Y(t) \\in \\{0, 1, \\ldots, K\\}\\) denote the state occupied at time \\(t\\). Some examples are shown in the diagrams below:\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nTransitions between states are governed by:\n\nTransition intensities\n\\[\n\\lambda_{kj}\\{t \\mid \\mathcal{H}^*(t-)\\} = \\Pr(Y(t+\\mathrm{d}t) = j \\mid Y(t-) = k, \\mathcal{H}^*(t-)),\n\\] where \\(\\mathcal{H}^*(t)\\) is the subject’s full state history up to \\(t\\).\n\nMarkov assumption: \\(\\lambda_{kj}\\{t \\mid \\mathcal{H}^*(t-)\\} = \\lambda_{kj}(t)\\)—depends only on current state and time.\n\nSemi-Markov: allows dependence on time since entry into current state.\n\nTransition probabilities (Markov) \\[\nP_{kj}(s, t) = \\Pr\\{Y(t) = j \\mid Y(s) = k\\},\n\\] with matrix representation \\(\\mathbf{P}(s, t)\\) that satisfies a product-integral formula: \\[\n\\mathbf{P}(s, t) = \\prod_{u = s}^t \\{\\mathbf{I} + \\mathrm{d}\\boldsymbol{\\Lambda}(u)\\}.\n\\]\n\nEstimation: use discrete versions of transition intensities from observed data.\n\nSojourn time and state occupancy\n\\[\n\\mu_k(\\tau) = \\int_0^\\tau P_k(t) \\, \\mathrm{d}t,\n\\] where \\(P_k(t)\\) is the probability of being in state \\(k\\) at time \\(t\\).\n\n\n\nNonparametric estimation\nThe Aalen–Johansen estimator generalizes the Kaplan–Meier and Gray estimators:\n\nDiscrete intensity estimator: \\[\n\\mathrm{d}\\hat{\\Lambda}_{kj}(t) = \\frac{\\# \\text{transitions } k \\to j}{\\# \\text{at risk in state } k},\n\\] computed at each observed transition time \\(t\\).\nCumulative probability matrix: \\[\n\\hat{\\mathbf{P}}(0, t) = \\prod_{t_j \\le t} \\left\\{ \\mathbf{I} + \\mathrm{d}\\hat{\\boldsymbol{\\Lambda}}(t_j) \\right\\}.\n\\]\n\nRecovers Kaplan–Meier for single events and Gray’s estimator for competing risks.\n\nProduces nonparametric estimates of transition probabilities and mean sojourn times.\n\n\n\n\nCox-type regression models\nTransition-specific covariate effects are modeled via multiplicative intensity models:\n\nModulated Markov model: \\[\n\\lambda_{kj}(t \\mid Z(t)) = \\lambda_{kj0}(t) \\exp\\big(\\beta_{kj}^\\mathrm{T} Z(t)\\big).\n\\]\nModulated semi-Markov model (includes duration in current state): \\[\n\\lambda_{kj}(t \\mid Z(t), B(t)) = \\lambda_{kj0}(t) \\exp\\big(\\beta_{kj}^\\mathrm{T} Z(t) + \\gamma_{kj} B(t)\\big),\n\\] where \\(B(t)\\) is the time since entering state \\(k\\).\n\nThese models are estimated using the Cox partial likelihood on data in counting process format.\n\n\nExample R code\nBelow is a code snippet for fitting a Cox-type model to a \\(k \\to j\\) transition using coxph() from the survival package.\n\n########################################\n# Cox-type model for a specific transition\n########################################\nlibrary(survival)\n\n# Data assumed to be in long format\nfit_kj &lt;- coxph(Surv(start, stop, status) ~ covariates,\n                data = df,\n                subset = (from == k & to == j))\nsummary(fit_kj)\n\nHere:\n\nstart, stop: entry and exit times of the interval at risk;\nstatus: indicator of the \\(k \\to j\\) transition (1 if observed, 0 otherwise);\nfrom, to: initial and target states.\n\nRepeat for each possible transition; estimation is separate due to likelihood factorization.\n\n\nConclusion\nMultistate models generalize survival analysis to account for multiple transitions, absorbing states, and intermediate events. Their flexible structure accommodates competing risks, recurrent events, and semi-competing frameworks. Nonparametric estimators like Aalen–Johansen and Cox-type regression models enable estimation of state-specific risks and covariate effects. This approach provides a unified and interpretable framework for analyzing complex disease processes.",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 12 - Multistate Modeling of Life History"
    ]
  },
  {
    "objectID": "chapter12.html#r-code",
    "href": "chapter12.html#r-code",
    "title": "Chapter 12 - Multistate Modeling of Life History",
    "section": "R Code",
    "text": "R Code\n\n\nShow the code\n###############################################################################\n# Chapter 12 R Code\n#\n# This script reproduces all major numerical results in Chapter 12, including:\n#   1. Multi-state analysis of the German Breast Cancer (GBC) Study\n###############################################################################\n\n\n#==============================================================================\n# (A) Read and Prepare the Data\n#==============================================================================\nlibrary(survival)  # For coxph and Surv\n\n#------------------------------------------------------------------------------\n# 1. GBC Multi-State Data\n#------------------------------------------------------------------------------\ngbc_ms &lt;- read.table(\"Data//German Breast Cancer Study//gbc_ms.txt\")\n\n#------------------------------------------------------------------------------\n# 2. Data Preprocessing\n#   - Age grouping\n#   - Time intervals\n#   - Rescaling hormones\n#   - Converting certain variables to factors\n#------------------------------------------------------------------------------\n# Age categories: &lt;=40 =&gt; group 1; (40,60] =&gt; group 2; &gt;60 =&gt; group 3\ngbc_ms$agec &lt;- (gbc_ms$age &lt;= 40) +\n  2 * (gbc_ms$age &gt; 40 & gbc_ms$age &lt;= 60) +\n  3 * (gbc_ms$age &gt; 60)\n\n# Bt: time spent in current state\ngbc_ms$Bt &lt;- gbc_ms$stop - gbc_ms$start\n\n# Rescale progesterone and estrogen levels by 10\ngbc_ms$prog  &lt;- gbc_ms$prog / 10\ngbc_ms$estrg &lt;- gbc_ms$estrg / 10\n\n# Convert variables to factors\ngbc_ms$hormone &lt;- factor(gbc_ms$hormone)\ngbc_ms$meno    &lt;- factor(gbc_ms$meno)\ngbc_ms$agec    &lt;- factor(gbc_ms$agec)\n\n\n#==============================================================================\n# (B) Fit Transition-Specific Cox Models\n#     States: 0=remission, 1=relapse, 2=death\n#==============================================================================\n#------------------------------------------------------------------------------\n# 1. 0 -&gt; 1: Remission to relapse\n#------------------------------------------------------------------------------\nobj01 &lt;- coxph(\n  Surv(start, stop, status) ~ hormone + meno + agec + size + prog + estrg + strata(grade),\n  data   = gbc_ms,\n  subset = ((from == 0) & (to == 1))\n)\n\n#------------------------------------------------------------------------------\n# 2. 0 -&gt; 2: Remission to death\n#------------------------------------------------------------------------------\nobj02 &lt;- coxph(\n  Surv(start, stop, status) ~ hormone + meno + size + prog + estrg + strata(grade),\n  data   = gbc_ms,\n  subset = ((from == 0) & (to == 2))\n)\n\n#------------------------------------------------------------------------------\n# 3. 1 -&gt; 2: Relapse to death\n#------------------------------------------------------------------------------\nobj12 &lt;- coxph(\n  Surv(start, stop, status) ~ Bt + hormone + meno + agec + size + prog + estrg + strata(grade),\n  data   = gbc_ms,\n  subset = ((from == 1) & (to == 2))\n)\n\n\n#==============================================================================\n# (C) Tabulate Model Results\n#     Hazard Ratios, 95% CI, and p-values for each transition\n#==============================================================================\nlibrary(dplyr)  # if needed for data manipulation\nlibrary(stringr)\n\n#------------------------------------------------------------------------------\n# 1. 0 -&gt; 1: Remission to relapse\n#------------------------------------------------------------------------------\nbeta01 &lt;- obj01$coefficients\nse01   &lt;- sqrt(diag(obj01$var))\np01    &lt;- 1 - pchisq((beta01 / se01)^2, 1)\n\nc1_01  &lt;- round(exp(beta01), 3)\nc2_01  &lt;- paste0(\n  \"(\",\n  round(exp(beta01 - 1.96 * se01), 3), \", \",\n  round(exp(beta01 + 1.96 * se01), 3), \")\"\n)\nc3_01  &lt;- round(p01, 3)\n\nnoquote(cbind(c1_01, c2_01, c3_01))\n\n#------------------------------------------------------------------------------\n# 2. 0 -&gt; 2: Remission to death\n#------------------------------------------------------------------------------\nbeta02 &lt;- obj02$coefficients\nse02   &lt;- sqrt(diag(obj02$var))\np02    &lt;- 1 - pchisq((beta02 / se02)^2, 1)\n\nc1_02  &lt;- round(exp(beta02), 3)\nc2_02  &lt;- paste0(\n  \"(\",\n  round(exp(beta02 - 1.96 * se02), 3), \", \",\n  round(exp(beta02 + 1.96 * se02), 3), \")\"\n)\nc3_02  &lt;- round(p02, 3)\n\nnoquote(cbind(c1_02, c2_02, c3_02))\n\n#------------------------------------------------------------------------------\n# 3. 1 -&gt; 2: Relapse to death\n#------------------------------------------------------------------------------\nbeta12 &lt;- obj12$coefficients\nse12   &lt;- sqrt(diag(obj12$var))\np12    &lt;- 1 - pchisq((beta12 / se12)^2, 1)\n\nc1_12  &lt;- round(exp(beta12), 3)\nc2_12  &lt;- paste0(\n  \"(\",\n  round(exp(beta12 - 1.96 * se12), 3), \", \",\n  round(exp(beta12 + 1.96 * se12), 3), \")\"\n)\nc3_12  &lt;- round(p12, 3)\n\nnoquote(cbind(c1_12, c2_12, c3_12))",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 12 - Multistate Modeling of Life History"
    ]
  },
  {
    "objectID": "chap12.html",
    "href": "chap12.html",
    "title": "Applied Survival Analysis",
    "section": "",
    "text": "Basic concepts and examples\nTransition intensity and probability\nCox-type Markov and semi-Markov models\nAnalysis of the German breast cancer study\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\cc}{{\\rm c}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\] \\[\n\\newcommand\\mymathop[1]{\\mathop{\\operatorname{#1}}}\n\\]"
  },
  {
    "objectID": "chap13.html#outline",
    "href": "chap13.html#outline",
    "title": "Applied Survival Analysis",
    "section": "Outline",
    "text": "Outline\n\n\nTraditional vs hierarchical composites\nThe restricted mean time in favor (RMT-IF) of treatment\nWin ratio: two-sample analysis\nSemiparametric regression of win ratio\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\cc}{{\\rm c}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\] \\[\n\\newcommand\\mymathop[1]{\\mathop{\\operatorname{#1}}}\n\\] \\[\n\\newcommand{\\Ut}{{n \\choose 2}^{-1}\\sum_{i&lt;j}\\sum}\n\\]\n$$ \n$$"
  },
  {
    "objectID": "chap13.html#the-composite-approach",
    "href": "chap13.html#the-composite-approach",
    "title": "Applied Survival Analysis",
    "section": "The Composite Approach",
    "text": "The Composite Approach\n\n\nComplex outcomes\n\nMultivariate/Recurrent events\n(Semi-)Competing risks\nLongitudinal measures with survival endpoint\n\n\n\n\n\nStandard methods\n\nJoint models (frailty, random effects)\nMarginal models (component-wise robust methods, cumulative incidence)\n\n\n\n\n\nTraditional composite\n\nTime to first event (event-free survival)"
  },
  {
    "objectID": "chap13.html#examples-and-advantages",
    "href": "chap13.html#examples-and-advantages",
    "title": "Applied Survival Analysis",
    "section": "Examples and Advantages",
    "text": "Examples and Advantages\n\n\nExamples\n\nCardiovascular: major adverse cardiovascular events (MACE), e.g., death, nonfatal heart failure, myocardial infarction, stroke, etc.\nOncology: death and tumor progression (progression-free survival)\n\n\n\n\n\nAdvantages\n\nMore events \\(\\to\\) higher power \\(\\to\\) smaller sample size/lower costs\nNo need for multiplicity adjustment\nA unified measure of treatment effect\nRecommended by ICH-E9 “Statistical Principles for Clinical Trials” (1998)"
  },
  {
    "objectID": "chap13.html#data-and-notation",
    "href": "chap13.html#data-and-notation",
    "title": "Applied Survival Analysis",
    "section": "Data and Notation",
    "text": "Data and Notation\n\n\nTime-to-event\n\n\\(D\\): survival time; \\(N^*_D(t)=I(D\\leq t)\\)\n\\(N^*_1(t), \\ldots, N^*_K(t)\\): counting processes for \\(K\\) nonfatal event types\nLife history: \\(\\mathcal H^*(t)=\\{N^*_D(u), N^*_1(u), \\ldots, N^*_K(u):0\\leq u\\leq t\\}\\)\n\n\n\n\n\nMultistate\n\n\\(Y(t)=0, 1,\\ldots, K,\\infty\\): multistate process; \\(\\infty=\\)death\nLife history: \\(\\mathcal H^*(t)= \\{Y(u):0\\leq u\\leq t\\}\\)\n\n\n\n\n\nCommon features\n\nDeath most important, followed by some other events/states"
  },
  {
    "objectID": "chap13.html#traditional-composite-endpoints",
    "href": "chap13.html#traditional-composite-endpoints",
    "title": "Applied Survival Analysis",
    "section": "Traditional Composite Endpoints",
    "text": "Traditional Composite Endpoints\n\n\nTime to first event\n\n\\(N_{\\rm TFE}(t) = I\\{N^*_D(t)+\\sum_{k=1}^KN^*_k(t)\\geq 1\\}= I\\{Y(t)\\geq 1\\}\\)\n\n\n\n\n\nWeighted composite event process\n\n\\(N_{\\rm R}(t)=w_DN^*_D(t)+\\sum_{k=1}^Kw_kN^*_k(t)\\)\n\n\n\n\n\nHierarchical composite endpoints (HCE)\n\nDeath &gt; nonfatal MACE &gt; minor symptoms &gt; …\nUse more data, avoid arbitrary specification of weights"
  },
  {
    "objectID": "chap13.html#motivating-examples",
    "href": "chap13.html#motivating-examples",
    "title": "Applied Survival Analysis",
    "section": "Motivating Examples",
    "text": "Motivating Examples\n\n\n\n\n\nColon cancer trial\n\nLevamisole + fluorouracil (\\(n=304\\)) vs control (\\(n=315\\))\nRelapse-free survival\n\n258 (89%) deaths ignored\n\n\nHF-ACTION trial\n\nExercise training (\\(n=205\\)) vs usual care (\\(n=221\\))\nHospitalization-free survival\n\n82 (88%) deaths + 707 (69%) hospitalizations ignored"
  },
  {
    "objectID": "chap13.html#hierarchical-composite-endpoints",
    "href": "chap13.html#hierarchical-composite-endpoints",
    "title": "Applied Survival Analysis",
    "section": "Hierarchical Composite Endpoints",
    "text": "Hierarchical Composite Endpoints\n\n\nRestricted mean time in favor (RMT-IF)\n\nNonparametric measure of effect size on HCE\nNet average time treatment gains in a more favorable state\n\nAn extension of RMST\n\nUses all events (hierarchically)\n\n\n\n\n\nWin ratio\n\nRatio of probability of better / worse outcomes\nInitially two-sample comparison (Pocock et al., 2012)\nExtended to semiparametric regression"
  },
  {
    "objectID": "chap13.html#outcome-data",
    "href": "chap13.html#outcome-data",
    "title": "Applied Survival Analysis",
    "section": "Outcome Data",
    "text": "Outcome Data\n\n\nTarget of inference\n\nMultistate outcomes \\[Y(t) \\in \\{0, 1,\\ldots, K, \\infty\\}\\]\n\n\\(0\\): initial state (e.g., remission)\n\\(1, \\ldots, K\\): a series of progressively worse states\n\\(\\infty\\): death\n\nExamples\n\n\\(1\\): relapse; \\(2\\): metastasis\n\\(1, 2, \\ldots\\): cumulative number of hospitalizations\n\nTwo-sample comparison\n\n\\(Y^{(a)}(t)\\): a random patient in group \\(a\\) (\\(a=1\\): treatment; \\(0\\): control)"
  },
  {
    "objectID": "chap13.html#time-on-a-win-or-loss",
    "href": "chap13.html#time-on-a-win-or-loss",
    "title": "Applied Survival Analysis",
    "section": "Time on a Win or Loss",
    "text": "Time on a Win or Loss\n\n\nPairwise win-loss time\n\n\\(Y^{(1)}(t)\\) vs \\(Y^{(0)}(t)\\) over \\([0, \\tau]\\);\n\n\\(\\tau\\): restiction time (e.g., 5 years)\n\nWin time \\(=\\) time residing in a lower-tiered (thus more favorable) state \\[\nW^{(a, 1-a)}(\\tau)=\\int_0^\\tau I\\{Y^{(a)}(t)&lt;Y^{(1-a)}(t)\\}{\\rm d}t\n\\]"
  },
  {
    "objectID": "chap13.html#net-average-win-time",
    "href": "chap13.html#net-average-win-time",
    "title": "Applied Survival Analysis",
    "section": "Net Average Win Time",
    "text": "Net Average Win Time\n\n\nRestricted mean time in favor (RMT-IF) of treatment \\[\n    \\mu(\\tau) = E\\{W^{(1, 0)}(\\tau)\\} - E\\{W^{(0, 1)}(\\tau)\\}\n    \\]\n\n\\(E\\{W^{(1, 0)}(\\tau)\\}\\): average win time by treatment vs control\n\\(E\\{W^{(0, 1)}(\\tau)\\}\\): average loss time by treatment vs control\n\\(\\mu(\\tau)\\): net average win time by treatment vs control\n\nReduces to difference in RMST in life-death model\n\nDecomposition: Time won on which component?\n\nExtra survival time + extra relapse-free time + …"
  },
  {
    "objectID": "chap13.html#decomposition",
    "href": "chap13.html#decomposition",
    "title": "Applied Survival Analysis",
    "section": "Decomposition",
    "text": "Decomposition\n\n\nStage-wise effects \\[\\mu(\\tau) = \\sum_{k=1}^{K,\\infty} \\mu_k(\\tau)\\]\n\nTime won on \\(k\\)th state (being in a better state) \\[W_k^{(a, 1-a)}(\\tau)=\\int_0^\\tau I\\{Y^{(a)}(t)&lt;Y^{(1-a)}(t) = k\\}{\\rm d}t\\]\nNet average win time on state \\(k\\) \\[\n\\mu_k(\\tau)= E\\{W_k^{(1, 0)}(\\tau)\\} - E\\{W_k^{(0, 1)}(\\tau)\\}\n  \\]\n\n\\(\\mu_\\infty(\\tau)\\): net win time on survival \\(=\\) difference in \\(\\tau\\)-RMST (regardless of other states)\n\\(\\mu_2(\\tau)\\): extra metastasis-free time; \\(\\mu_1(\\tau)\\): extra relapse-free time"
  },
  {
    "objectID": "chap13.html#simplify-for-progressive-processes",
    "href": "chap13.html#simplify-for-progressive-processes",
    "title": "Applied Survival Analysis",
    "section": "Simplify for Progressive Processes",
    "text": "Simplify for Progressive Processes\n\n\nProgressive process \\[Y^{(a)}(t)\\leq Y^{(a)}(s) \\mbox{ for all } 0\\leq t\\leq s\\]\n\nTransition time \\(T_k^{(a)}\\): time to transition to a state \\(\\geq k\\)\n\n\\(T_1^{(a)}\\): time to relapse/metastasis/death\n\\(T_2^{(a)}\\): time to metastasis/death\n\\(T_\\infty^{(a)}=D^{(a)}\\): time to death\n\nReformulation: \\[Y^{(a)}(\\cdot)\\equiv \\big\\{0\\leq T_1^{(a)}\\leq\\cdots\\leq T_K^{(a)}\\leq T_\\infty^{(a)}\\big\\}\\]\n\nA progressive process \\(\\Longleftrightarrow\\) a sequence of transition marks"
  },
  {
    "objectID": "chap13.html#delve-into-estimand",
    "href": "chap13.html#delve-into-estimand",
    "title": "Applied Survival Analysis",
    "section": "Delve into Estimand",
    "text": "Delve into Estimand\n\n\nAverage win time on state \\(k\\)\n\nRe-expression with \\(S_k^{(a)}(t)=P\\{T_k^{(a)}&gt; t\\}\\) \\[\\begin{align}\nE\\{W_k^{(a, 1-a)}(\\tau)\\}&=E\\left\\{\\int_0^\\tau I\\{Y^{(a)}(t)&lt;Y^{(1-a)}(t) = k\\}{\\rm d}t\\right\\}\\\\\n&=\\int_0^\\tau P\\{Y^{(a)}(t)&lt; k\\}P\\{Y^{(1-a)}(t) = k\\}{\\rm d}t\\\\\n&=\\int_0^\\tau P\\{T_k^{(a)}&gt; t\\}P\\{T_k^{(1-a)}\\leq t &lt; T_{k+1}^{(1-a)}\\}{\\rm d}t\\\\\n&=\\int_0^\\tau S_k^{(a)}(t)\\left\\{S_{k+1}^{(1-a)}(t) - S_k^{(1-a)}(t)\\right\\}{\\rm d}t\\\\\n\\end{align}\\]\nNet average win time \\[\\mu_k(\\tau)=E\\{W_k^{(1, 0)}(\\tau)\\}-E\\{W_k^{(0, 1)}(\\tau)\\}=\n  \\int_0^\\tau \\left\\{S_k^{(1)}(t)S_{k+1}^{(0)}(t) - S_k^{(0)}(t)S_{k+1}^{(1)}(t)\\right\\}{\\rm d}t\\]"
  },
  {
    "objectID": "chap13.html#observed-data-estimation",
    "href": "chap13.html#observed-data-estimation",
    "title": "Applied Survival Analysis",
    "section": "Observed Data & Estimation",
    "text": "Observed Data & Estimation\n\n\nCensored observations \\[\n      (X_k^{(a)}, \\delta_k^{(a)}),\\,\\,\\, k =1,\\ldots, K, \\infty\n      \\]\n\n\\(X_k^{(a)}= \\min(T_k^{(a)}, C^{(a)})\\); \\(\\delta_k^{(a)}= I(T_k^{(a)}\\leq C^{(a)})\\); \\(C^{(a)}=\\)censoring time\nKaplan–Meier estimator \\(\\hat S_k^{(a)}(t)\\)\n\n\n\n\n\nEstimation: Plug-in KM estimator \\[\n    \\hat\\mu_k(\\tau)=\n      \\int_0^\\tau \\left\\{\\hat S_k^{(1)}(t)\\hat S_{k+1}^{(0)}(t) - \\hat S_k^{(0)}(t)\\hat S_{k+1}^{(1)}(t)\\right\\}{\\rm d}t\n    \\]\n\nRobust variance estimator"
  },
  {
    "objectID": "chap13.html#hypothesis-testing",
    "href": "chap13.html#hypothesis-testing",
    "title": "Applied Survival Analysis",
    "section": "Hypothesis Testing",
    "text": "Hypothesis Testing\n\n\nTest of overall effect \\[\n    H_0: \\mu(\\tau)= 0\n    \\]\n\n\\(\\chi_1^2\\) test based on \\(\\hat\\mu(\\tau)=\\sum_{k=1}^{K,\\infty}\\hat\\mu_k(\\tau)\\)\n\n\n\n\n\nJoint test on components \\[\n    H_0: \\mu_1(\\tau)=\\cdots=\\mu_K(\\tau)=\\mu_\\infty(\\tau)\n    \\]\n\n\\(\\chi_{K+1}^2\\) test based on \\(\\hat\\mu_1(\\tau),\\ldots,\\hat\\mu_K(\\tau),\\hat\\mu_\\infty(\\tau)\\)\n\nOr individual components for secondary analyses"
  },
  {
    "objectID": "chap13.html#software-rmtrmtfit-i",
    "href": "chap13.html#software-rmtrmtfit-i",
    "title": "Applied Survival Analysis",
    "section": "Software: rmt::rmtfit() (I)",
    "text": "Software: rmt::rmtfit() (I)\n\n\nInput data format (long)\n\nStandard multistate\n\nstatus = k for entry into state \\(k\\), K+1 for death, 0 for censoring\n\nRecurrent events with death\n\nstatus = 1 for nonfatal event, 2 for death, 0 for censoring\n\n\n\n\nhead(hfaction)\n#&gt;       patid       time status trt_ab age60\n#&gt;  HFACT00001 0.60506502      1      0     1\n#&gt;  HFACT00001 1.04859685      0      0     1\n#&gt;  HFACT00002 0.06297057      1      0     1\n#&gt;  HFACT00002 0.35865845      1      0     1\n#&gt;  HFACT00002 0.39698836      1      0     1\n#&gt;  HFACT00002 3.83299110      0      0     1\n#&gt;  ..."
  },
  {
    "objectID": "chap13.html#software-rmtrmtfit-ii",
    "href": "chap13.html#software-rmtrmtfit-ii",
    "title": "Applied Survival Analysis",
    "section": "Software: rmt::rmtfit() (II)",
    "text": "Software: rmt::rmtfit() (II)\n\n\nBasic syntax\n\n\n\nlibrary(rmt)\n# trt: binary treatment\nobj &lt;- rmtfit(id, time, status, trt, \n              type = c(\"multistate\", \"recurrent\"))\n\n\n\nOutput: a list of class rmtfit\n\nobj$t: \\(t\\); obj$mu: a matrix of \\((K+2)\\) rows, \\(\\hat\\mu_k(t)\\) in \\(k\\)th row, \\(\\hat\\mu(t)\\) in last; obj$var: variances of point estimates in mu\nsummary(obj, tau) for summary results on \\(\\mu(\\tau)\\), including the \\(\\mu_k(\\tau)\\)\n\nRecurrent events: specify Kmax = k to merge \\(\\mu_{k+}(\\tau)\\sum_{k'=k}^K=\\mu_{k'}(\\tau)\\)\n\nplot(obj) to plot \\(\\hat\\mu(t)\\) against \\(t\\)"
  },
  {
    "objectID": "chap13.html#example-hf-action",
    "href": "chap13.html#example-hf-action",
    "title": "Applied Survival Analysis",
    "section": "Example: HF-ACTION",
    "text": "Example: HF-ACTION\n\n\nExercise training vs usual care\n\n\n\n\n\nTable 1: Descriptive statistics for a high-risk subgroup (n=426) in HF-ACTION trial.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nUsual care (N = 221)\nExercise training (N = 205)\n\n\n\n\nAge\n≤ 60 years\n122 (55.2%)\n128 (62.4%)\n\n\n\n&gt; 60 years\n99 (44.8%)\n77 (37.6%)\n\n\nFollow-up\n(months)\n28.6 (18.4, 39.3)\n27.6 (19, 40.2)\n\n\nDeath\n\n57 (25.8%)\n36 (17.6%)\n\n\nHospitalizations\n0\n51 (23.1%)\n60 (29.3%)\n\n\n\n1-3\n114 (51.6%)\n102 (49.8%)\n\n\n\n4-10\n49 (22.2%)\n39 (19%)\n\n\n\n&gt;10\n7 (3.2%)\n4 (2%)"
  },
  {
    "objectID": "chap13.html#standard-analyses",
    "href": "chap13.html#standard-analyses",
    "title": "Applied Survival Analysis",
    "section": "Standard Analyses",
    "text": "Standard Analyses\n\n\nTraditional composite and overall survival"
  },
  {
    "objectID": "chap13.html#r-code",
    "href": "chap13.html#r-code",
    "title": "Applied Survival Analysis",
    "section": "R-Code",
    "text": "R-Code\n\n\nlibrary(rmt)\nhead(hfaction)\n#&gt;       patid       time status trt_ab age60\n#&gt;  HFACT00001 0.60506502      1      0     1\n#&gt;  HFACT00001 1.04859685      0      0     1\n#&gt; ...\n\n\n\n\n# fit RMT-IF\nobj &lt;- rmtfit(hfaction$patid, hfaction$time, hfaction$status, hfaction$trt, \n              type = \"recurrent\")\nsummary(obj, Kmax=4, tau=3.97) ## combined recurrent events &gt;= 4\n# Restricted mean time in favor of group \"1\" by time tau = 3.97:\n#   Estimate    Std.Err Z value Pr(&gt;|z|)    \n# Event 1   0.0140515  0.0498836  0.2817 0.778184    \n# Event 2   0.0358028  0.0499618  0.7166 0.473619    \n# Event 3   0.1385287  0.0409533  3.3826 0.000718 ***\n# Event 4+ -0.0064731  0.0600813 -0.1077 0.914203    \n# Survival  0.2384169  0.1143484  2.0850 0.037069 *  \n# Overall   0.4203268  0.1777363  2.3649 0.018035 *"
  },
  {
    "objectID": "chap13.html#graphics",
    "href": "chap13.html#graphics",
    "title": "Applied Survival Analysis",
    "section": "Graphics",
    "text": "Graphics\n\n\n\\(\\hat\\mu(t)\\) as a function of \\(t\\)\n\nOverall RMT-IF becomes significant after 1 year (see lower CL)\n\n\nplot(obj, conf = TRUE, conf.col = \"gray\", lwd = 2, xlab = \"t (years)\",\n     ylab = \"expression(mu(t))\", main = \"\")"
  },
  {
    "objectID": "chap13.html#inference-results",
    "href": "chap13.html#inference-results",
    "title": "Applied Survival Analysis",
    "section": "Inference Results",
    "text": "Inference Results\n\n\n4-year RMT-IF of exercise training\n\nTraining on average gains 5.1 months (\\(P\\)=0.018) in favorable state\n\n2.9 months net survival \\(+\\) 2.2 months net time with fewer hospitalizations (little effect on 1st)\n\n\n\n\n\n\n\nTable 2: Analysis of 4-year RMT-IF of exercise training in HF-ACTION trial.\n\n\n\n\n\n\n\n\nEstimate\nSE\nP-value\n\n\n\n\nHopitalization\n\n2.18\n1.22\n0.073\n\n\n\n1\n0.17\n0.60\n0.778\n\n\n\n2\n0.43\n0.60\n0.474\n\n\n\n3\n1.66\n0.49\n&lt;0.001\n\n\n\n4+\n-0.08\n0.72\n0.914\n\n\nDeath\n\n2.86\n1.37\n0.037\n\n\nOverall\n\n5.04\n2.13\n0.018"
  },
  {
    "objectID": "chap13.html#standard-two-sample",
    "href": "chap13.html#standard-two-sample",
    "title": "Applied Survival Analysis",
    "section": "Standard Two-Sample",
    "text": "Standard Two-Sample\n\n\nTwo-sample comparison (Pocock et al., 2012)\n\nData: \\(D_i^{(a)}, T_i^{(a)}, C_i^{(a)}\\): survival, hospitalization, censoring times on \\(i\\)th subject in group \\(a\\) \\((i=1,\\ldots, N_a; a= 1, 0)\\)\nHierarchical composite: Death &gt; hospitalization\nPairwise comparisons \\[\\begin{align}\n\\hat w^{(a, 1-a)}_{ij}&= \\underbrace{I(D_j^{(1-a)}&lt; D_i^{(a)}\\wedge C_i^{(a)}\\wedge C_j^{(1-a)})}_{\\mbox{win on survival}}\\\\\n& + \\underbrace{I(\\min(D_i^{(a)}, D_j^{(1-a)}) &gt; C_i^{(a)}\\wedge C_j^{(1-a)}, T_j^{(1-a)}&lt; T_i^{(a)}\\wedge C_i^{(1)}\\wedge C_j^{(0)})}_{\\mbox{inconclusive on survival, win on hospitalization}}\n\\end{align}\\]\nPrioritized comparison on \\(\\left[0, C_i^{(a)}\\wedge C_j^{(1-a)}\\right]\\)"
  },
  {
    "objectID": "chap13.html#pococks-rule",
    "href": "chap13.html#pococks-rule",
    "title": "Applied Survival Analysis",
    "section": "Pocock’s Rule",
    "text": "Pocock’s Rule\n\n\nWin, lose, or tie?"
  },
  {
    "objectID": "chap13.html#calculation-of-win-ratio",
    "href": "chap13.html#calculation-of-win-ratio",
    "title": "Applied Survival Analysis",
    "section": "Calculation of Win Ratio",
    "text": "Calculation of Win Ratio\n\n\nTwo-sample statistics\n\nWin (loss) fraction for group \\(a\\) (\\(1-a\\)) \\[\n\\hat w^{(a, 1-a)}=(N_0N_1)^{-1}\\sum_{i=1}^{N_a}\\sum_{j=1}^{N_{1-a}}\\hat w^{(a, 1-a)}_{ij}\\]\nWin ratio statistic \\[\nWR = \\hat w^{(1, 0)} / \\hat w^{(0, 1)}\n\\]\nOther measures\n\nNet benefit (proportion in favor): \\(\\hat w^{(1, 0)} - \\hat w^{(0, 1)}\\)\nWin odds: \\((\\hat w^{(1, 0)} - \\hat w^{(0, 1)} + 1)/ (\\hat w^{(0, 1)} - \\hat w^{(1, 0)} + 1)\\)"
  },
  {
    "objectID": "chap13.html#the-binary-case",
    "href": "chap13.html#the-binary-case",
    "title": "Applied Survival Analysis",
    "section": "The Binary Case",
    "text": "The Binary Case\n\n\nConsider binary \\(Y^{(a)}= 1, 0\\)\n\n\\(\\hat w^{(a, 1-a)}_{ij} = I(Y_i^{(a)}&gt; Y_j^{(1-a)})=Y_i^{(a)}(1-Y_j^{(1-a)})\\)\nWin (loss) fraction \\[\n\\hat w^{(a, 1-a)} = (N_1N_0)^{-1}\\sum_{i=1}^{N_a}\\sum_{j=1}^{N_{1-a}}Y_i^{(a)}(1-Y_j^{(1-a)})\n= \\hat p^{(a)}(1-\\hat p^{(1-a)})\\] where \\(\\hat p^{(a)}= N_a^{-1}\\sum_{i=1}^{N_a} Y_i^{(a)}\\)\nEquivalencies \\[\\begin{align}\n{\\rm Win\\,\\, ratio}&= \\frac{\\hat w^{(1, 0)}}{\\hat w^{(0, 1)}} = \\frac{\\hat p^{(1)}(1-\\hat p^{(0)})}{\\hat p^{(0)}(1-\\hat p^{(1)})} = {\\rm Odds \\,\\, ratio}\\\\\n{\\rm Net \\,\\, benefit}&=\\hat w^{(1, 0)} - \\hat w^{(0, 1)} = \\hat p^{(1)}- \\hat p^{(0)}= {\\rm Risk \\,\\, difference}\n\\end{align}\\]"
  },
  {
    "objectID": "chap13.html#general-data",
    "href": "chap13.html#general-data",
    "title": "Applied Survival Analysis",
    "section": "General Data",
    "text": "General Data\n\n\nOutcome data \\[\\mathcal H^{*{(a)}}(t)=\\left\\{N^{*{(a)}}_D(u), N^{*{(a)}}_1(u), \\ldots, N^{*{(a)}}_K(u):0\\leq u\\leq t\\right\\}\\]\n\n\\(N^{*{(a)}}_D(u), N^{*{(a)}}_1(u), \\ldots, N^{*{(a)}}_K(u)\\): counting processes for death and \\(K\\) different types of nonfatal events\n\n\n\n\n\nObserved data \\[\\{\\mathcal H^{*{(a)}}(X^{(a)}), X^{(a)}\\}\\]\n\nLife history observed up to \\(X^{(a)}= D^{(a)}\\wedge C^{(a)}\\)"
  },
  {
    "objectID": "chap13.html#general-rule",
    "href": "chap13.html#general-rule",
    "title": "Applied Survival Analysis",
    "section": "General Rule",
    "text": "General Rule\n\n\nWin function \\[\\mathcal W(\\mathcal H^{*{(a)}}, \\mathcal H^{*{(1-a)}})(t) =I\\left\\{\\mathcal H^{*{(a)}}(t) \\mbox{ is more favorable than } \\mathcal H^{*{(1-a)}}(t)\\right\\}\\]\n\nBasic requirements\n\n(W1) \\(\\mathcal W(\\mathcal H^{*{(a)}}, \\mathcal H^{*{(1-a)}})(t)\\) is a function only of \\(\\mathcal H^{*{(a)}}(t)\\) and \\(\\mathcal H^{*{(1-a)}}(t)\\)\n(W2) \\(\\mathcal W(\\mathcal H^{*{(a)}}, \\mathcal H^{*{(1-a)}})(t)+\\mathcal W(\\mathcal H^{*{(1-a)}}, \\mathcal H^{*{(a)}})(t) \\in \\{0, 1\\}\\)\n(W3) \\(\\mathcal W(\\mathcal H^{*{(a)}}, \\mathcal H^{*{(1-a)}})(t)=\\mathcal W(\\mathcal H^{*{(a)}}, \\mathcal H^{*{(1-a)}})(D^{(a)}\\wedge D^{(1-a)}\\wedge t)\\)\n\nInterpretations\n\n(W1) Consistency of time frame\n(W2) Either win, loss, or tie\n(W3) No change of win-loss status after death (satisfied if death is prioritized)"
  },
  {
    "objectID": "chap13.html#generalized-win-ratio",
    "href": "chap13.html#generalized-win-ratio",
    "title": "Applied Survival Analysis",
    "section": "Generalized Win Ratio",
    "text": "Generalized Win Ratio\n\n\nGeneral WR statistics \\[\\begin{equation}\\label{eq:wr:gen_WR}\n    \\hat{\\mathcal E}_n(\\mathcal W)=\\frac{(N_1N_0)^{-1}\\sum_{i=1}^{N_1}\\sum_{j=1}^{N_0}\\mathcal W(\\mathcal H^{*{(1)}}_{i}, \\mathcal H^{*{(0)}}_{j})(X^{{(1)}}_{i}\\wedge X^{{(0)}}_{j})}\n    {(N_1N_0)^{-1}\\sum_{i=1}^{N_1}\\sum_{j=1}^{N_0}\\mathcal W(\\mathcal H^{*{(0)}}_{j}, \\mathcal H^{*{(1)}}_{i})(X^{{(1)}}_{i}\\wedge X^{{(0)}}_{j})}\n    \\end{equation}\\]\n\nWindow of comparison: \\([0, X^{{(1)}}_{i}\\wedge X^{{(0)}}_{j}]\\), by a general \\(\\mathcal W\\)\nStratified win ratio \\[\n\\frac{\\text{Weighted sum of within-stratum wins}}{\\text{Weighted sum of within-stratum losses}}\n\\]"
  },
  {
    "objectID": "chap13.html#pococks-win-ratio",
    "href": "chap13.html#pococks-win-ratio",
    "title": "Applied Survival Analysis",
    "section": "Pocock’s Win Ratio",
    "text": "Pocock’s Win Ratio\n\n\nWin function\n\n\\(K\\) nonfatal events hierarchically ranked\n\\(T^{(a)}_k\\): time of first event in \\(N_k^{*{(a)}}(t)\\) \\((k=1,\\ldots, K)\\) \\[\\begin{align}\\label{eq:wr:PWR}\n\\mathcal W_{\\rm P}(\\mathcal H^{*{(a)}}, \\mathcal H^{*{(1-a)}})(t)&=I\\{D^{(1-a)}&lt;D^{(a)}\\wedge t\\}\\notag\\\\\n&\\hspace{2mm}+I\\{D^{(a)}\\wedge D^{(1-a)}&gt;t, T_{1}^{(1-a)}&lt;T_{1}^{(a)}\\wedge t\\}\\notag\\\\\n&\\hspace{2mm}+\\sum_{k=2}^KI\\{\\tilde T_{k-1}^{(a)}\\wedge \\tilde T_{k-1}^{(1-a)}&gt;t, T_{k}^{(1-a)}&lt;T_{k}^{(a)}\\wedge t\\}\n\\end{align}\\]\n\n\\(\\tilde T_{k-1}^{(a)}=D^{(a)}\\wedge T_{1}^{(a)}\\wedge\\cdots\\wedge T_{k-1}^{(a)}\\)\n\n\n\n\n\n\nWin ratio statistic: \\(\\hat{\\mathcal E}_n(\\mathcal W_{\\rm P})\\)"
  },
  {
    "objectID": "chap13.html#taking-recurrent-events",
    "href": "chap13.html#taking-recurrent-events",
    "title": "Applied Survival Analysis",
    "section": "Taking Recurrent Events",
    "text": "Taking Recurrent Events\n\n\nRecurrent-event win ratio (RWR)\n\nDeath &gt; number of recurrent events &gt; time to last event"
  },
  {
    "objectID": "chap13.html#time-to-first-event",
    "href": "chap13.html#time-to-first-event",
    "title": "Applied Survival Analysis",
    "section": "Time-to-First-Event",
    "text": "Time-to-First-Event\n\n\nCompare on order of first event\n\nWin function \\[\n\\mathcal W_{\\rm TFE}(\\mathcal H^{*{(a)}},\\mathcal H^{*{(1-a)}})(t)=I(\\tilde T^{(1-a)}&lt;\\tilde T^{(a)}\\wedge t)\n\\]\n\n\\(\\tilde T^{(a)}=\\min(D^{(a)}, T_1^{(a)},\\ldots, T_K^{(a)})\\)\n\nAllowable but not desirable"
  },
  {
    "objectID": "chap13.html#regression-framework",
    "href": "chap13.html#regression-framework",
    "title": "Applied Survival Analysis",
    "section": "Regression Framework",
    "text": "Regression Framework\n\nMotivation\n\nMeaningful estimand of effect size\nMultiple (quantitative) predictors\n\nModelin target\n\nTwo independent subjects \\((\\mathcal H_i, Z_i)\\) and \\((\\mathcal H_j, Z_j)\\)\n\n\\(E\\{\\mathcal W(\\mathcal H_i,\\mathcal H_j)(t)\\mid Z_i, Z_j\\}\\): Conditional win fraction (probability) for \\(i\\) against \\(j\\) at \\(t\\)\n\\(E\\{\\mathcal W(\\mathcal H_j,\\mathcal H_i)(t)\\mid Z_i, Z_j\\}\\): Conditional win fraction (probability) for \\(j\\) against \\(i\\) at \\(t\\)\n\nCovariate-specific win ratio \\[\\begin{equation}\\label{eq:cov_spec_curtail_wr}\nWR(t; Z_i, Z_j;\\mathcal W):= \\frac{E\\{\\mathcal W(\\mathcal H_i,\\mathcal H_j)(t)\\mid Z_i,Z_j\\}}{E\\{\\mathcal W(\\mathcal H_j,\\mathcal H_i)(t)\\mid Z_i, Z_j\\}}\n\\end{equation}\\]\nModel it against \\(Z_i\\) and \\(Z_j\\) to study covariate effect on WR"
  },
  {
    "objectID": "chap13.html#model-specification",
    "href": "chap13.html#model-specification",
    "title": "Applied Survival Analysis",
    "section": "Model Specification",
    "text": "Model Specification\n\nProportional win-fractions (PW) model \\[\\begin{equation}\\label{eq:wr_reg}\nWR(t\\mid Z_i, Z_j;\\mathcal W)=\\exp\\left\\{\\beta^{\\rm T}\\left(Z_i- Z_j\\right)\\right\\}\n\\end{equation}\\]\n\nPW: covariate-specific win/loss fractions proportional over time\n\nWR constant over time\n\n\\(\\beta\\): log-win ratio associated with unit increases in covariates (regardless of follow-up time)\nSemiparametric model\n\nParametric covariate-specific WRs\nNonparametric in other aspects (baseline event rates, etc.)\n\nDenote model by PW\\((\\mathcal W)\\)\n\nStresses model’s dependency on \\(\\mathcal W\\) chosen"
  },
  {
    "objectID": "chap13.html#special-cases",
    "href": "chap13.html#special-cases",
    "title": "Applied Survival Analysis",
    "section": "Special Cases",
    "text": "Special Cases\n\nPocock’s two-sample WR\n\n\\(Z = 1, 0\\)\n\\(\\exp(\\beta)\\): WR comparing group \\(z=1\\) with group \\(0\\)\n\nCox PH model\n\nPW\\((\\mathcal W_{\\rm TFE})\\) \\(\\Leftrightarrow\\) Cox PH model on time to first event"
  },
  {
    "objectID": "chap13.html#estimation",
    "href": "chap13.html#estimation",
    "title": "Applied Survival Analysis",
    "section": "Estimation",
    "text": "Estimation\n\nConstruction of estimating function\n\nObserved win process \\(\\delta_{ij}(t)=\\mathcal W(\\mathcal H_i,\\mathcal H_j)(X_i\\wedge X_j\\wedge t)\\)\nDeterminancy (win or loss): \\(R_{ij}(t)=\\delta_{ij}(t)+\\delta_{ji}(t)\\)\nMean-zero residual \\[\\begin{equation}\\label{eq:wr:resid}\nM_{ij}(t\\mid Z_i, Z_j;\\beta)=\\underbrace{\\delta_{ij}(t)}_{\\rm observed\\,\\,win} -\n\\underbrace{R_{ij}(t)\\frac{\\exp\\left\\{\\beta^{\\rm T}\\left( Z_i- Z_j\\right)\\right\\}}{\n1+\\exp\\left\\{\\beta^{\\rm T}\\left(Z_i- Z_j\\right)\\right\\}}}_{\\rm model-based\\,\\, prediction}\n\\end{equation}\\]\nEstimating equation \\[\\begin{equation}\\label{eq:wr:ee}\n\\Ut\\int_0^\\infty (Z_i - Z_j) h(t; Z_i, Z_j)\\dd M_{ij}(t \\mid Z_i, Z_j;\\beta)=0\n\\end{equation}\\]\n\nWeight function \\(h(t; Z_i, Z_j)\\equiv 1\\)"
  },
  {
    "objectID": "chap13.html#checking-proportionality",
    "href": "chap13.html#checking-proportionality",
    "title": "Applied Survival Analysis",
    "section": "Checking Proportionality",
    "text": "Checking Proportionality\n\nCumulative residuals\n\nRescaled \\(\\hat U_n(t)=\\Ut(Z_i - Z_j)\\underbrace{M_{ij}(t \\mid Z_i, Z_j;\\hat\\beta)}_{\\rm observed\\,\\, minus\\,\\, model-based\\,\\,wins\\,\\, by\\,\\, t}\\)"
  },
  {
    "objectID": "chap13.html#software-wrpwreg-i",
    "href": "chap13.html#software-wrpwreg-i",
    "title": "Applied Survival Analysis",
    "section": "Software: WR::pwreg() (I)",
    "text": "Software: WR::pwreg() (I)\n\nInput data format\n\nstatus = 1 for death, 2 for nonfatal events, 0 for censoring\n\n\n\nlibrary(WR)\n#&gt; Loading required package: survival\nhead(non_ischemic)\n#&gt;   ID time status trt_ab age sex Black.vs.White Other.vs.White   bmi\n#&gt; 1  1  221      2      0  62   1              0              0 25.18\n#&gt; 2  1  383      0      0  62   1              0              0 25.18\n#&gt; 3  2   23      2      0  75   1              1              0 22.96\n#&gt; 4  2 1400      0      0  75   1              1              0 22.96\n#&gt; ..."
  },
  {
    "objectID": "chap13.html#software-wrpwreg-ii",
    "href": "chap13.html#software-wrpwreg-ii",
    "title": "Applied Survival Analysis",
    "section": "Software: WR::pwreg() (II)",
    "text": "Software: WR::pwreg() (II)\n\nBasic syntax for PW\\((\\mathcal W_{\\rm P})\\)\n\nID: subject identifier\nZ: covariate matrix; strata: possible stratifier (categorical)\n\n\n\n\n# fit PW model (death &gt; nonfatal event)\nobj &lt;- pwreg(ID, time, status, Z, strata = NULL)\n\n\n\nOutput: an object of class pwreg\n\nobj$beta: \\(\\hat\\beta\\)\nobj$Var: \\(\\hat\\var(\\hat\\beta)\\)\nprint(obj) to summarize regression results"
  },
  {
    "objectID": "chap13.html#software-wrscore.proc",
    "href": "chap13.html#software-wrscore.proc",
    "title": "Applied Survival Analysis",
    "section": "Software: WR::score.proc()",
    "text": "Software: WR::score.proc()\n\nChecking proportionality\n\nobj: a pwreg object\n\n\n\n\n# fit PW model (death &gt; nonfatal event)\nscore.obj &lt;- score.proc(obj)\n\n\n\nOutput: an object of class score.proc\n\nscore.obj$t: \\(t\\)\nscore.obj$score: a matrix with rescaled residual process for each covariate per row\nplot(score.obj, k): plot the rescaled residuals for \\(k\\)th covariate"
  },
  {
    "objectID": "chap13.html#hf-action-data",
    "href": "chap13.html#hf-action-data",
    "title": "Applied Survival Analysis",
    "section": "HF-ACTION: Data",
    "text": "HF-ACTION: Data\n\nAnother subset of HF-ACTION\n\nPopulation: \\(n=451\\) non-ischemic patients followed over median length of 31.6 months\nEndpoints: death &gt; first hospitalization\nPredictors: training vs usual care, age, sex, race, bmi, LVEF, medications, etc.\n\n\n\nlibrary(WR)\n#&gt; Loading required package: survival\nhead(non_ischemic)\n#&gt;   ID time status trt_ab age sex Black.vs.White Other.vs.White   bmi  ...\n#&gt; 1  1  221      2      0  62   1              0              0 25.18\n#&gt; 2  1  383      0      0  62   1              0              0 25.18\n#&gt; 3  2   23      2      0  75   1              1              0 22.96\n#&gt; 4  2 1400      0      0  75   1              1              0 22.96\n#&gt; ..."
  },
  {
    "objectID": "chap13.html#hf-action-regression-coding",
    "href": "chap13.html#hf-action-regression-coding",
    "title": "Applied Survival Analysis",
    "section": "HF-ACTION: Regression Coding",
    "text": "HF-ACTION: Regression Coding\n\nSet up PW\\((\\mathcal W_{\\rm P})\\)\n\n\n# extract variables and covariate matrix\nID &lt;- non_ischemic[,\"ID\"]\ntime &lt;- non_ischemic[,\"time\"]\nstatus &lt;- non_ischemic[,\"status\"]\nZ &lt;- as.matrix(non_ischemic[, 4:(3+p)], nr, p)\n# pass the parameters into the function\npwreg.obj &lt;- pwreg(ID, time, status, Z)\n# print out results\nprint(pwreg.obj)"
  },
  {
    "objectID": "chap13.html#hf-action-regression-results",
    "href": "chap13.html#hf-action-regression-results",
    "title": "Applied Survival Analysis",
    "section": "HF-ACTION: Regression Results",
    "text": "HF-ACTION: Regression Results\n\nSummary results\n\nTraining \\(\\exp(0.191) - 1= 21\\%\\) more likely to get favorable outcome than UC\nRace differences substantial and significant\nLVEF: 1% increases win likelihood by \\(\\exp(0.021) = 1.02\\) (\\(p\\)-value 0.013)\n\n\n\n#&gt; Estimates for Regression parameters:\n#&gt;                     Estimate         se z.value p.value\n#&gt; Training vs Usual  0.1906687  0.1264658  1.5077 0.13164\n#&gt; Age (year)        -0.0128306  0.0057285 -2.2398 0.02510 *\n#&gt; Male vs Female    -0.1552923  0.1294198 -1.1999 0.23017\n#&gt; Black vs White    -0.3026335  0.1461330 -2.0709 0.03836 *\n#&gt; Other vs White    -0.3565390  0.3424360 -1.0412 0.29779\n#&gt; BMI               -0.0181310  0.0097582 -1.8580 0.06316 .\n#&gt; LVEF               0.0214905  0.0086449  2.4859 0.01292 *\n#&gt; ..."
  },
  {
    "objectID": "chap13.html#hf-action-residual-analyses",
    "href": "chap13.html#hf-action-residual-analyses",
    "title": "Applied Survival Analysis",
    "section": "HF-ACTION: Residual Analyses",
    "text": "HF-ACTION: Residual Analyses\n\nChecking proportionality\n\n\nscore.obj &lt;- score.proc(pwreg.obj)\npar(mfrow = c(1, 3)) # plot residual processes for treatment, age, LVEF\nfor(i in c(1, 2, 7)){\n  plot(score.obj, k = i, xlab = \"Time (Days)\")\n}"
  },
  {
    "objectID": "chap13.html#notes",
    "href": "chap13.html#notes",
    "title": "Applied Survival Analysis",
    "section": "Notes",
    "text": "Notes\n\nBefore win ratio\n\nContinuous outcome: Wilcoxon (1945), Mann & Whitney (1947)\nHierarchical endpoints: Finkelstein and Schoenfeld (1999), Buyse (2010)\n\nMore on RMT-IF\n\nMao (2023, Biometrics)\n\nHierarchical endpoints\n\nGaining popularity and an active area of research"
  },
  {
    "objectID": "chap13.html#summary",
    "href": "chap13.html#summary",
    "title": "Applied Survival Analysis",
    "section": "Summary",
    "text": "Summary\n\nRMT-IF\n\nModel-free, component-wise decomposable \\[\n\\mu(\\tau) = \\underbrace{E\\{W^{(1, 0)}(\\tau)\\}}_{\\rm win\\,time\\,by\\,\\tau} -\n\\underbrace{E\\{W^{(0, 1)}(\\tau)\\}}_{\\rm loss\\,time\\,by\\,\\tau}\n\\]\nrmt::rmtfit()\n\nWin ratio regression\n\nProportionality and multiplicativity \\[\nWR(t\\mid Z_i, Z_j;\\mathcal W)=\\exp\\left\\{\\beta^{\\rm T}\\left(Z_i- Z_j\\right)\\right\\}\n\\]\n\\(\\exp(\\beta)\\): WRs with unit increases in covariates\nWR::pwreg()"
  },
  {
    "objectID": "chapter13.html#chapter-summary",
    "href": "chapter13.html#chapter-summary",
    "title": "Chapter 13 - Composite Endpoints",
    "section": "Chapter Summary",
    "text": "Chapter Summary\nComposite endpoints combine fatal and nonfatal events, typically ranked by clinical importance, into a single outcome. They are especially useful in clinical trials for increasing statistical efficiency and avoiding multiple testing. Traditional methods such as time to first event can obscure the relative severity of outcomes. Newer techniques—such as restricted mean time in favor (RMT-IF) and the proportional win-fractions (PW) model—offer interpretable, flexible alternatives that respect the hierarchical structure of composite events.\n\nMultistate outcome structure\nLet \\(Y_a(t)\\) denote the clinical state of a subject in treatment arm \\(a\\) at time \\(t\\), taking values in the ordered set \\(\\{0, 1, \\ldots, K, K+1\\}\\):\n\n\\(a \\in \\{0, 1\\}\\): treatment assignment (0 = control, 1 = treatment),\n\n\\(Y_a(t)\\) increases as the subject’s health condition worsens,\n\nState \\(K+1\\) is an absorbing state corresponding to death.\n\nExamples include:\n\nProgressive disease (e.g., cancer): \\(Y_a(t) = 0\\): remission, \\(1\\): relapse, \\(2\\): metastasis, \\(3\\): death (\\(K+1 = 3\\)).\nRecurrent hospitalizations with death:\n\\(Y_a(t)\\) = number of hospitalizations up to \\(t\\) (0 to \\(K\\)), with \\(K+1\\) = death.\n\nThe process \\(Y_a(t)\\) is assumed to be progressive, i.e., non-decreasing over time, and all transitions eventually terminate in the absorbing state.\n\n\nRestricted Mean Time in Favor (RMT-IF)\nThe RMT-IF measures the average duration over which a subject in one group is in a more favorable state than a subject in the other group, over a follow-up window \\([0, \\tau]\\).\n\nDefinition: \\[\n\\theta(\\tau) = E\\Bigg[ \\underbrace{\\int_0^\\tau I\\{ Y_1(t) &lt; Y_0(t)\\} \\mathrm{d} t}_{\\text{Win time } W^{(1, 0)}(\\tau)} \\Bigg]\n              - E\\Bigg[ \\underbrace{\\int_0^\\tau I\\{ Y_0(t) &lt; Y_1(t) \\} \\mathrm{d} t}_{\\text{Loss time } W^{(0, 1)}(\\tau)}  \\Bigg].\n\\]\n\n\n\n\n\n\n\nComponent-wise decomposition: \\[\n\\theta(\\tau) = \\sum_{k=1}^{K+1} \\theta_k(\\tau),\n\\] where each \\(\\theta_k(\\tau)\\) corresponds to a net gain in time prior to entering state \\(k\\).\nEstimation: Uses Kaplan–Meier survival curves for \\(T_{ak}\\) = time to entry into state \\(k\\) or worse.\n\nInterpretation: Reduces to RMST when only two states are considered (e.g., survival vs. death).\nRegression: \\[\ng\\{\\theta(Z_i, Z_j)(\\tau)\\} = \\beta_\\tau^\\mathrm{T}(Z_i - Z_j),\n\\] where \\(\\theta(Z_i, Z_j)(\\tau)\\) is the conditional RMT-IF between covariate profiles \\(Z_i\\) and \\(Z_j\\).\n\n\n\nWin Ratio and Proportional Win-Fractions (PW) Model\nThe win ratio compares all possible treatment–control subject pairs, assigning a “win” to the subject in the more favorable state based on a pre-specified hierarchical rule.\n\nBasic win ratio: \\[\n\\hat{\\text{WR}} = \\frac{\\text{\\# of treatment wins}}{\\text{\\# of control wins}}.\n\\]\nGeneral win function \\(\\mathcal{W}(\\mathcal{H}^*_i, \\mathcal{H}^*_j)(t)\\):\nCompares cumulative histories \\(\\mathcal{H}^*(t)\\) up to time \\(t\\) for two subjects, assigning 1 for a win and 0 otherwise.\nExamples:\n\nPocock win ratio (PWR): prioritize survival first, then first nonfatal event.\nRecurrent win ratio (RWR): compare cumulative event counts and recency.\nTime to first event: inverse of hazard ratio.\nBinary response: reduces to odds ratio.\n\n\n\n\n\n\n\n\nPW model: \\[\n\\text{WR}(t; Z_i, Z_j) = \\exp\\left\\{ \\beta^\\mathrm{T}(Z_i - Z_j) \\right\\}.\n\\] This assumes proportional win fractions across time; \\(\\exp(\\beta_j)\\) gives the win ratio per unit increase in covariate \\(j\\).\nInference:\nEstimation is performed via U-statistic–based pairwise comparisons and weighted logistic regression. Score processes are used for model checking.\n\n\n\nExample R code\n\n########################################\n# 1. Two-sample RMT-IF\n########################################\nlibrary(rmt)\nobj &lt;- rmtfit(id, time, status, trt, \n              type = \"recurrent\" # \"recurrent\" (default) or \"multistate\"\n              )\nsummary(obj, tau = 4) # Summarize effect sizes at restriction time 4\nplot(obj)        # RMT-IF curve\nbouquet(obj)     # Bouquet plot\n\nHere:\n\nid: subject identifier;\n\ntime: time to event or censoring;\n\nstatus: event type indicator\n\ntype = \"recurrent\": 1: nonfatal event, 2: death, 0: censoring;\n\ntype = \"multistate\": k: a transition to state \\(k\\) (K+1 for death, 0 for censoring)\n\ntrt: treatment group (0 = control, 1 = treatment);\n\n\n\n########################################\n# 2. Proportional Win-Fractions model\n########################################\nlibrary(WR)\nobj &lt;- pwreg(ID, time, status, Z, strata = NULL)\n\nHere:\n\nID: subject identifier;\n\ntime: time to event or censoring;\n\nstatus = 1: death, 2: nonfatal event, 0: censoring;\n\nZ: matrix of baseline covariates;\n\nstrata: optional stratification variable.\n\n\n\nConclusion\nRMT-IF and PW models provide robust, interpretable alternatives to traditional time-to-first-event analysis for composite endpoints. They respect the ordering of clinical priorities and utilize full patient histories, including both fatal and nonfatal events. RMT-IF summarizes effects in absolute time units, while PW models yield covariate-adjusted win ratios with a semiparametric interpretation. Together, they offer powerful tools for improving clinical trial analyses of complex outcomes.",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 13 - Composite Endpoints"
    ]
  },
  {
    "objectID": "chapter13.html#r-code",
    "href": "chapter13.html#r-code",
    "title": "Chapter 13 - Composite Endpoints",
    "section": "R Code",
    "text": "R Code\n\n\nShow the code\n###############################################################################\n# Chapter 13 R Code\n#\n# This script reproduces all major numerical results in Chapter 13, including:\n#   1. RMT-IF analysis of the high-risk subgroup of the HF-ACTION study\n#   2. Additional illustration with the WR package for heart failure data\n###############################################################################\n\n\n#==============================================================================\n# (A) RMT-IF Analysis of the HF-ACTION Study (High-Risk Subgroup)\n#==============================================================================\n#------------------------------------------------------------------------------\n# 1. Load Packages\n#------------------------------------------------------------------------------\n# install.packages(\"rmt\")\nlibrary(rmt)\n\n# The \"hfaction\" data is built into the {rmt} package\ndata(\"hfaction\")\n\ndata &lt;- hfaction\n\n#------------------------------------------------------------------------------\n# 2. Basic Data Summary\n#------------------------------------------------------------------------------\n# Sample size\nuid &lt;- unique(data$patid)\nn   &lt;- length(uid)\n\n# By treatment group\nuid1 &lt;- unique(data$patid[data$trt_ab == 1])\nn1   &lt;- length(uid1)\n\nuid0 &lt;- unique(data$patid[data$trt_ab == 0])\nn0   &lt;- length(uid0)\n\n# Average # of hospitalizations by group\nmean_hosp_1 &lt;- sum(data$status[data$trt_ab == 1] == 1) / n1\nmean_hosp_0 &lt;- sum(data$status[data$trt_ab == 0] == 1) / n0\n\n# Total # hospitalizations and # deaths\ntotal_hosp &lt;- sum(data$status == 1)\ntotal_death &lt;- sum(data$status == 2)\n\n#------------------------------------------------------------------------------\n# 3. Time-to-First-Event and Mortality Sub-Analyses\n#------------------------------------------------------------------------------\nlibrary(survRM2)\n\n# Create data for time to first event (TFE)\ndata.TFE &lt;- data[!duplicated(data$patid), ]\n\n# Create data for overall mortality (status==2 or 0)\ndata_death &lt;- data[data$status == 2 | data$status == 0, ]\n\n# RMST analysis for hospitalization-free survival & overall survival, up to ~4 years\nrmst_tfe   &lt;- rmst2(data.TFE$time,   data.TFE$status &gt; 0,   data.TFE$trt_ab, tau = 3.97)\nrmst_death &lt;- rmst2(data_death$time, data_death$status &gt; 0, data_death$trt_ab, tau = 3.97)\n\n#------------------------------------------------------------------------------\n# 4. Kaplan-Meier Curves for Hospitalization-Free Survival and Overall Survival\n#------------------------------------------------------------------------------\nobj.TFE   &lt;- survfit(Surv(time, status &gt; 0) ~ trt_ab, data = data.TFE)\nobj.death &lt;- survfit(Surv(time, status == 2) ~ trt_ab, data = data_death)\n\n# Plot (Figure 13.1)\npar(mfrow = c(1, 2))\n\n# (A) TFE\nplot(\n  obj.TFE,\n  main = \"Hospitalization-free survival\",\n  lty  = 1:2,\n  ylab = \"Survival probabilities\",\n  xlab = \"Time (years)\",\n  lwd  = 2\n)\nlegend(\"bottomleft\", c(\"Usual care\", \"Exercise training\"), lwd = 2, lty = 1:2)\nabline(v = 4, lty = 3, lwd = 2)\n\n# (B) Overall survival\nplot(\n  obj.death,\n  main = \"Overall survival\",\n  lty  = 1:2,\n  ylab = \"Survival probabilities\",\n  xlab = \"Time (years)\",\n  lwd  = 2\n)\nlegend(\"bottomleft\", lty = 1:2, c(\"Usual care\", \"Exercise training\"), lwd = 2)\nabline(v = 4, lty = 3, lwd = 2)\n\npar(mfrow = c(1, 1))\n\n#------------------------------------------------------------------------------\n# 5. RMT-IF Analysis via rmtfit()\n#------------------------------------------------------------------------------\n# Here we treat the composite event as repeated events:\n#  status=1 =&gt; hospitalization, status=2 =&gt; death.\nobj_rmt &lt;- rmtfit(rec(patid, time, status) ~ trt_ab, data = data)\n\n# Alternatively:\n# obj_rmt &lt;- rmtfit(id, time, status, trt, type = \"recurrent\")\n\nsummary(obj_rmt, Kmax = 1, tau = 3.97)\n\n#------------------------------------------------------------------------------\n# 6. Graphical Summaries of RMT-IF (Figure 13.2)\n#------------------------------------------------------------------------------\npar(mfrow = c(1, 2))\n\n# (A) bouquet() with Kmax=4 =&gt; aggregated for k = 4,...,K\nbouquet(\n  obj_rmt,\n  Kmax     = 4,\n  cex.group= 1.0,\n  cex.lab  = 1.5,\n  cex.axis = 1.5,\n  xlab     = \"Restricted mean win/loss time (years)\",\n  ylab     = \"Follow-up time (years)\",\n  group.label = FALSE,\n  ylim     = c(0, 4.2)\n)\ntext(-0.8, 4.15, \"Usual care\",    cex = 1.2)\ntext( 0.8, 4.15, \"Exercise training\", cex = 1.2)\n\n# (B) plot() for difference in RMT-IF (Exercise - Usual)\nplot(\n  obj_rmt,\n  conf      = TRUE,\n  lwd       = 2,\n  cex.lab   = 1.5,\n  cex.axis  = 1.5,\n  xlab      = \"Follow-up time (years)\",\n  ylab      = \"RMT-IF of training (years)\",\n  main      = \"\"\n)\n\npar(mfrow = c(1, 1))\n\n#------------------------------------------------------------------------------\n# 7. Creating a LaTeX-Style Table of Results\n#------------------------------------------------------------------------------\npval_fmt3 &lt;- function(x) {\n  if (x &lt; 0.001) {\n    return(\"$&lt;$0.001\")\n  } else {\n    return(round(x, 3))\n  }\n}\n\nltable &lt;- NULL\n\n# (A) k=1 =&gt; first events only\nhosp_sum &lt;- summary(obj_rmt, Kmax = 1, tau = 3.97)$tab\n\n# (B) k=4 =&gt; aggregated for k=4,...,K\nall_sum  &lt;- summary(obj_rmt, Kmax = 4, tau = 3.97)$tab\n\n# First row =&gt; hospitalization\nltable &lt;- c(\n  \"&\", \"&\", \"&\",\n  round(12 * hosp_sum[1, 1], 2),\n  \"&\", round(12 * hosp_sum[1, 2], 2),\n  \"&\", pval_fmt3(hosp_sum[1, 4]),\n  \"\\\\\"\n)\n\n# Next rows =&gt; k=1,...,6 (or re-labeled in loop)\nfor (i in 1:6) {\n  tmp &lt;- c(\n    \"&\", i, \"&&\",\n    round(12 * all_sum[i, 1], 2), \"&\",\n    round(12 * all_sum[i, 2], 2), \"&\",\n    pval_fmt3(all_sum[i, 4]),\n    \"\\\\\"\n  )\n  ltable &lt;- rbind(ltable, tmp)\n}\n\n# Adjust labeling\nltable[5, 2] &lt;- \"4+\"\nltable[6:7, 2] &lt;- \"\"\n\nrownames(ltable) &lt;- c(\"Hospitalization\", \"\", \"\", \"\", \"\", \"Death\", \"Overall\")\n\nnoquote(ltable)\n\n\n#==============================================================================\n# (B) Additional Analysis with WR Package (Non-Ischemic HF Data)\n#==============================================================================\n# The real data used in Section 13.3 are protected. Below is a similar example\n# from the {WR} package for HF-ACTION with 451 non-ischemic heart failure patients\n#------------------------------------------------------------------------------\n# 1. Load Package and Example Data\n#------------------------------------------------------------------------------\n# install.packages(\"WR\")\nlibrary(WR)\n# The \"non_ischemic\" dataset is built into {WR}\nhead(non_ischemic)\n\n# Re-label the covariates with more informative names\ncolnames(non_ischemic)[4:16] &lt;- c(\n  \"Training vs Usual\", \"Age (year)\", \"Male vs Female\", \"Black vs White\",\n  \"Other vs White\", \"BMI\", \"LVEF\", \"Hypertension\", \"COPD\", \"Diabetes\",\n  \"ACE Inhibitor\", \"Beta Blocker\", \"Smoker\"\n)\n\n# Sample size\nlength(unique(non_ischemic$ID))\n\n# Median follow-up (in months) among those status &lt; 2 (no event or non-fatal)\nmedian(non_ischemic$time[non_ischemic$status &lt; 2]) / 30.5\n\n#------------------------------------------------------------------------------\n# 2. Fit Pocock's Proportional Win-Fractions Regression Model\n#------------------------------------------------------------------------------\nnr &lt;- nrow(non_ischemic)\np  &lt;- ncol(non_ischemic) - 3\n\nID     &lt;- non_ischemic[, \"ID\"]\ntime   &lt;- non_ischemic[, \"time\"]\nstatus &lt;- non_ischemic[, \"status\"]\nZ      &lt;- as.matrix(non_ischemic[, 4:(3 + p)], nr, p)\n\npwreg.obj &lt;- pwreg(ID = ID, time = time, status = status, Z = Z)\nprint(pwreg.obj)\n\n#------------------------------------------------------------------------------\n# 3. Hypothesis Testing for Race\n#------------------------------------------------------------------------------\n# Test H0: beta_4 = beta_5 = 0 for race (Black vs White, Other vs White)\nbeta_race &lt;- matrix(pwreg.obj$beta[4:5])\nSigma_race&lt;- pwreg.obj$Var[4:5, 4:5]\nchistats  &lt;- t(beta_race) %*% solve(Sigma_race) %*% beta_race\n1 - pchisq(chistats, df = 2)\n\n#------------------------------------------------------------------------------\n# 4. Standardized Score Processes\n#------------------------------------------------------------------------------\nscore.obj &lt;- score.proc(pwreg.obj)\nprint(score.obj)\n\noldpar &lt;- par(mfrow = c(4, 4))\nfor (i in 1:13) {\n  plot(score.obj, k = i)\n}\npar(oldpar)",
    "crumbs": [
      "Home",
      "Part II - Complex Outcomes",
      "Chapter 13 - Composite Endpoints"
    ]
  },
  {
    "objectID": "chap14.html#outline",
    "href": "chap14.html#outline",
    "title": "Applied Survival Analysis",
    "section": "Outline",
    "text": "Outline\n\n\nThe counterfactual framework\nInverse weighting and standardization\nEstimating causal survival curves\nMarginal structural models with time-varying treatment/confounding\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\cc}{{\\rm c}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\] \\[\n\\newcommand\\mymathop[1]{\\mathop{\\operatorname{#1}}}\n\\] \\[\n\\newcommand{\\Ut}{{n \\choose 2}^{-1}\\sum_{i&lt;j}\\sum}\n\\def\\a{{(a)}} \\def\\b{{(1-a)}} \\def\\t{{(1)}} \\def\\c{{(0)}} \\def\\d{{\\rm d}} \\def\\T{{\\rm T}}\n\\]"
  },
  {
    "objectID": "chap14.html#association-vs-causation",
    "href": "chap14.html#association-vs-causation",
    "title": "Applied Survival Analysis",
    "section": "Association vs Causation",
    "text": "Association vs Causation\n\n\nStatistical inference\n\nAssociation: test of group difference, correlation, regression\nCausation: informal or irrelevant\n\n\n\n\n\nCausal inference: study causal relationships\n\nCounterfactual framework\nCausal diagrams\n\n\n\n\n\nMotivating example: German Breast Cancer Study\n\nRelapse-free survival (\\(T\\)) vs hormonal therapy (\\(A=1\\) yes; \\(A=0\\): no)\nFirst assume \\(T\\) is fully observed (no censoring)"
  },
  {
    "objectID": "chap14.html#rct-as-gold-standard",
    "href": "chap14.html#rct-as-gold-standard",
    "title": "Applied Survival Analysis",
    "section": "RCT as Gold Standard",
    "text": "RCT as Gold Standard\n\n\nRandomized controlled trial (RCT)\n\nPatients randomly assigned to hormonal vs non-hormonal treatments\nTwo groups identical (exchangeable) in terms of baseline characteristic\nAny between-group difference in relapse-free survival attributable to treatment (no confounding)\n\nIncrease in \\(t=5\\) years relapse-free survival rate caused by hormonal treatment\n\n\\[\n\\hat\\pr(T&gt;t\\mid A=1)-\\hat\\pr(T&gt;t\\mid A=0)\n\\]\n\n(Causal) Hazard ratio under Cox model with binary group as covariate"
  },
  {
    "objectID": "chap14.html#possible-confounding",
    "href": "chap14.html#possible-confounding",
    "title": "Applied Survival Analysis",
    "section": "Possible Confounding",
    "text": "Possible Confounding\n\n\nHormone non-randomized \n\nWomen under hormonal treatment more likely to be post-menopausal than non-treatment (76.0% vs 47.5%)\nDifference in RFS \\(\\to\\) treatment or menopause?\nConfounder: menopausal status"
  },
  {
    "objectID": "chap14.html#traditional-methods",
    "href": "chap14.html#traditional-methods",
    "title": "Applied Survival Analysis",
    "section": "Traditional Methods",
    "text": "Traditional Methods\n\n\nAdjustment for confounding\n\nLog-rank test stratified by menopausal status (Ch. 3)\nCox regression with menopausal status as a covariate (Ch. 4; conditional hazard ratio)\nNeither provides a population-level causal effect size of hormone treatment like that derived from an RCT\n\n\n\n\n\nGoal\n\nDrawing causal inference in an RCT-like setting, even with observational data"
  },
  {
    "objectID": "chap14.html#counterfactual-framework",
    "href": "chap14.html#counterfactual-framework",
    "title": "Applied Survival Analysis",
    "section": "Counterfactual Framework",
    "text": "Counterfactual Framework\n\n\nPotential outcomes\n\nEach subject has two potential outcomes \\(T^{(a)}\\) \\((a=1, 0)\\)\n\n\\(T^{(1)}\\): had the subject been assigned to treatment\n\\(T^{(0)}\\): had the subject been assigned to control\n\n\n\n\n\n\nCausal estimand\n\nAny contrast in distribution between \\(T^{(1)}\\) vs \\(T^{(0)}\\)\nExample\n\nSurvival probability: \\(\\pr(T^{(1)}&gt;t)-\\pr(T^{(0)}&gt;t)\\)\nRMST: \\(E(T^{(1)}\\wedge t) - E(T^{(0)}\\wedge t)\\)"
  },
  {
    "objectID": "chap14.html#exchangeability-assumption",
    "href": "chap14.html#exchangeability-assumption",
    "title": "Applied Survival Analysis",
    "section": "Exchangeability Assumption",
    "text": "Exchangeability Assumption\n\n\nObserved outcome\n\n\\(A = 1, 0\\): actually assigned group \\[T=AT^{(1)}+(1-A)T^{(0)}\\,\\,\\,\\, (\\rm consistency)\\]\n\n\n\n\n\nAssumptions\n\nComplete randomization \\(T^{(a)}\\indep A,\\hspace{5mm}a=1, 0\\)\n\nToo strong, typically not satisfied\n\nConditional exchangeability \\[\\begin{equation}\\label{eq:causal:cond_exch}\nT^{(a)}\\indep A \\mid W,\\hspace{5mm} a=1, 0\n\\end{equation}\\]\n\nAssignment independent of potential outcome given confounders \\(W\\)\nAll confounders are captured in \\(W\\)"
  },
  {
    "objectID": "chap14.html#causal-diagrams",
    "href": "chap14.html#causal-diagrams",
    "title": "Applied Survival Analysis",
    "section": "Causal Diagrams",
    "text": "Causal Diagrams\n\n\nDirected Acyclic Graph"
  },
  {
    "objectID": "chap14.html#estimand",
    "href": "chap14.html#estimand",
    "title": "Applied Survival Analysis",
    "section": "Estimand",
    "text": "Estimand\n\n\nObserved data (\\(T_i\\) fully observed) \\[(T_i, A_i, W_i),\\,\\,\\,\\, i=1,\\ldots, n\\]\n\n\n\n\nTwo classes of methods\n\nInverse probability treatment weighting (IPTW)\nStandardization\n\n\n\n\n\nCausal estimand \\[\\begin{equation*}\nS_a(t)=\\pr(T^{(a)}&gt;t)\n\\end{equation*}\\]"
  },
  {
    "objectID": "chap14.html#propensity-score",
    "href": "chap14.html#propensity-score",
    "title": "Applied Survival Analysis",
    "section": "Propensity Score",
    "text": "Propensity Score\n\n\nSelection bias \\[\n    \\text{Naive estimator:}\\quad \\hat S_a^{\\rm naive}(t)=\\frac{\\sum_{i=1}^nI(A_i=a, T_i&gt;t)}{\\sum_{i=1}^nI(A_i = a)}\n    \\]\n\n\\((Y\\mid A = 1)\\) and \\((Y\\mid A = 0)\\) non-representative of general population\n\n\n\n\n\nPropensity score \\[\n    \\pi_a(W)=\\pr(A=a\\mid W)\n\\]\n\nProbability of entering treatment \\(a\\)\nGeneral population \\(\\stackrel{\\pi_a(W)}{\\rightleftarrows}\\) Group \\(a\\)"
  },
  {
    "objectID": "chap14.html#iptw",
    "href": "chap14.html#iptw",
    "title": "Applied Survival Analysis",
    "section": "IPTW",
    "text": "IPTW\n\n\nRe-constitute general population\n\nInverse weighting: Group \\(a\\) \\(\\stackrel{\\pi_a(W)^{-1}}{\\rightarrow}\\) General population \\[\\begin{equation}\\label{eq:causal:ipw_surv}\n\\hat S_a^{\\rm IP}(t)=n^{-1}\\sum_{i=1}^n\\frac{I(A_i=a, T_i&gt;t)}{\\pi_a(W_i)}\n\\end{equation}\\]\nUnbiased \\[\\begin{align*}\nE\\left\\{\\frac{I(A=a, T&gt;t)}{\\pi_a(W)}\\right\\}&=E\\left\\{\\frac{I(A=a, T^{(a)}&gt;t)}{\\pi_a(W)}\\right\\}\\\\\n&=E\\left[\\pi_a(W)^{-1}E\\left\\{I(A=a, T^{(a)}&gt;t)\\mid W\\right\\}\\right]\\\\\n&=E\\left\\{\\pi_a(W)^{-1}\\pr(A=a\\mid W)\\pr(T^{(a)}&gt;t\\mid W)\\right\\}\\\\\n&=E\\left\\{\\pr(T^{(a)}&gt;t\\mid W)\\right\\}\\\\\n&=S_a(t)\n\\end{align*}\\]"
  },
  {
    "objectID": "chap14.html#estimate-propensity-score",
    "href": "chap14.html#estimate-propensity-score",
    "title": "Applied Survival Analysis",
    "section": "Estimate Propensity Score",
    "text": "Estimate Propensity Score\n\n\n\\(\\pi_a(W)\\) unknown unless by design\n\nEstimate \\(\\hat\\pi_a(\\cdot)\\) using \\[\n(A_i, W_i),\\,\\,\\ i=1,\\ldots,n\n\\]\nLogistic regression/machine learning classification\n\n\n\n\n\nIPTW estimator\n\nPlug in \\(\\hat\\pi_a(W_i)\\) \\[\\begin{equation}\n\\hat S_a^{\\rm IP}(t)=n^{-1}\\sum_{i=1}^n\\frac{I(A_i=a, T_i&gt;t)}{\\hat\\pi_a(W_i)}\n\\end{equation}\\]\nVariance estimation needs to account for randomness in \\(\\hat\\pi_a(\\cdot)\\)"
  },
  {
    "objectID": "chap14.html#standardization",
    "href": "chap14.html#standardization",
    "title": "Applied Survival Analysis",
    "section": "Standardization",
    "text": "Standardization\n\n\nModel outcome vs confounder\n\nInstead of treatment vs confounder \\[\n\\hat S_a(t\\mid W)= \\hat\\pr(T^{(a)}&gt;t\\mid W)\n\\]\nE.g., Cox model based on \\[\n\\{(T_i, W_i): A_i=a, i=1,\\ldots, n\\}\n\\]\n\\((T\\mid A =a, W) = (T^{(a)}\\mid A =a, W) = (T^{(a)}\\mid W)\\) (conditional exchangeability)\n\n\n\n\n\nStandardized estimator\n\nAverage across population: \\(\\hat S_a^{\\rm reg}(t)=n^{-1}\\sum_{i=1}^n\\hat S_a(t\\mid W_i)\\)"
  },
  {
    "objectID": "chap14.html#iptw-vs-standardization",
    "href": "chap14.html#iptw-vs-standardization",
    "title": "Applied Survival Analysis",
    "section": "IPTW vs Standardization",
    "text": "IPTW vs Standardization\n\n\nModeling target\n\nIPTW: treatment vs confounder\nStandardization: outcome vs confounder \n\n\n\n\n\nProperties\n\nNonparametric setting (categorical confounder): \\(\\hat S_a^{\\rm IP}(t)=\\hat S_a^{\\rm reg}(t)\\)\nDoubly robust estimator: valid when either model is true, efficient when both are true"
  },
  {
    "objectID": "chap14.html#dealing-with-censored-data",
    "href": "chap14.html#dealing-with-censored-data",
    "title": "Applied Survival Analysis",
    "section": "Dealing with Censored Data",
    "text": "Dealing with Censored Data\n\n\nIn presence of censoring\n\nIPTW (+ IPCW)\nStandardardization (adjust for cenosring)\nObserved data \\((X, \\delta, A, W)\\)\n\n\\(X=T\\wedge C\\), \\(\\delta = I(T\\leq C)\\), \\(C\\): censoring time\n\n\n\n\n\n\nTwo levels of coarsening\n\n\\(T^{(a)}\\to T\\): treatment assignment\n\\(T\\to (X, \\delta)\\): Censoring"
  },
  {
    "objectID": "chap14.html#assumptions-about-censoring",
    "href": "chap14.html#assumptions-about-censoring",
    "title": "Applied Survival Analysis",
    "section": "Assumptions about Censoring",
    "text": "Assumptions about Censoring\n\n\nTwo types of assumption\n\nCensoring depends on confounder (general) \\[\\begin{equation}\\label{eq:causal:indep_cens1}\nT\\indep C\\mid (A, W)\n\\end{equation}\\]\nCensoring not dependent on confounder \\[\\begin{equation}\\label{eq:causal:indep_cens2}\nT\\indep C\\mid A\n\\end{equation}\\]"
  },
  {
    "objectID": "chap14.html#ipcw",
    "href": "chap14.html#ipcw",
    "title": "Applied Survival Analysis",
    "section": "IPCW",
    "text": "IPCW\n\n\nGeneral assumption \\((W\\to C)\\)\n\nAdjust for selection bias by censoring\nInverse probability treatment weighting (IPTW) + Inverse probability censoring weighting (IPCW)\n\n\n\n\n\nCensoring weight\n\n\\(G_a(t\\mid W)=\\pr(C\\geq t\\mid A=a, W)\\)\nE.g., Cox model fit on \\[\n(X_i, 1-\\delta_i, W_i)\\,\\,\\,\\, i=1,\\ldots, n\n\\] with \\(C_i\\) as outcome"
  },
  {
    "objectID": "chap14.html#inverse-weighting",
    "href": "chap14.html#inverse-weighting",
    "title": "Applied Survival Analysis",
    "section": "Inverse Weighting",
    "text": "Inverse Weighting\n\n\nSelection probability\n\nIn group \\(a\\) and not censored by \\(t\\): \\(\\pi_a(W)G_a(t\\mid W)\\)\nInverse weight \\[\n\\hat w_{ai}(t)=\\frac{I(A_i=a)}{\\hat\\pi_a(W_i)\\hat G_a(t\\mid W_i)}\n\\]\n\n\n\n\n\nIPT(C)W-adjusted KM estimator\n\n\\(N_i(t)=I(X_i\\leq t,\\delta_i=1)\\) \\[\\begin{equation}\\label{eq:causal_ipcw}\n\\hat S_a^{\\rm IP}(t)=\\prod_{0\\leq u\\leq t}\\left\\{1-\\frac{\\sum_{i=1}^n \\hat w_{ai}(u)\\dd N_i(u)}{\\sum_{i=1}^n \\hat w_{ai}(u)I(X_i\\geq u)}\\right\\}\n\\end{equation}\\]\nIf \\((T\\indep C)\\mid A\\), then \\(\\hat G_a(t\\mid W_i)\\equiv 1\\)"
  },
  {
    "objectID": "chap14.html#causal-cox-model",
    "href": "chap14.html#causal-cox-model",
    "title": "Applied Survival Analysis",
    "section": "Causal Cox Model",
    "text": "Causal Cox Model\n\n\nMarginal structural model\n\n\\(\\lambda_a(t)\\): hazard function of \\(T^{(a)}\\) \\[\\begin{equation}\\label{eq:causal:msm_cox}\n\\lambda_a(t)=\\exp(a\\beta)\\lambda_0(t)\n\\end{equation}\\]\n\n\n\n\n\nIPT(C)W-adjusted partial likelihood score\n\n\\(\\hat w_i(t)=\\{\\hat\\pi_{A_i}(W_i)\\hat G_{A_i}(t\\mid W_i)\\}^{-1}\\) \\[\\begin{equation}\\label{eq:causal:score}\nn^{-1}\\sum_{i=1}^n\\int_0^\\infty\\left\\{A_i-\\frac{\\sum_{j=1}^nA_j\\hat w_{j}(t) I(X_j\\geq t)\\exp(A_j\\beta)}\n{\\sum_{j=1}^n \\hat w_{j}(t) I(X_j\\geq t)\\exp(A_j\\beta)}\\right\\}\\hat w_{i}(t)\\dd N_i(t)=0\n\\end{equation}\\]\n\\(\\exp(\\beta)\\): causal hazard ratio"
  },
  {
    "objectID": "chap14.html#standardization-approach",
    "href": "chap14.html#standardization-approach",
    "title": "Applied Survival Analysis",
    "section": "Standardization Approach",
    "text": "Standardization Approach\n\n\nTwo-steps\n\nOutcome (censored) vs confounder \\[S_a(t\\mid W)=\\pr(T^{(a)}&gt;t\\mid W)\\]\nAverage \\(\\hat S_a^{\\rm reg}(t)=n^{-1}\\sum_{i=1}^n\\hat S_a(t\\mid W_i)\\)\nStandard software"
  },
  {
    "objectID": "chap14.html#software-ipwipwpoint",
    "href": "chap14.html#software-ipwipwpoint",
    "title": "Applied Survival Analysis",
    "section": "Software: ipw::ipwpoint()",
    "text": "Software: ipw::ipwpoint()\n\n\nBasic syntax for computing propensity scores\n\nA: A; confounders: W\nfamily = \"binomial\", link=\"logit\": logistic regression for binary \\(A\\)\n\n\n\n\ntmp &lt;- ipwpoint(exposure = A, denominator=~ confounders,\n                family = \"binomial\", link=\"logit\")\n\n\n\n\n\nOutput\n\ntmp$ipw.weights: \\(n\\)-Vector of inverse weights\nPlug in survfit() and coxph()\n\n\n# IPTW-adjusted KM\nobj &lt;- survfit(Surv(time,status) ~ A, weights = tmp$ipw.weights)"
  },
  {
    "objectID": "chap14.html#gbc-an-example",
    "href": "chap14.html#gbc-an-example",
    "title": "Applied Survival Analysis",
    "section": "GBC: An Example",
    "text": "GBC: An Example\n\n\nGerman Breast Cancer study\n\n\\(A\\): hormone treatment (1) vs no treatment (0)\n\\(T\\): relapse-free survival time\n\\(𝑊\\): confounders (menopausal status, tumor size, tumor grade, progesterone and estrogen receptor levels)\n\n\n\n\n\nAssumption about censoring \\[(T\\indep C)\\mid A\\]\n\nOnly IPTW needed (no IPCW)"
  },
  {
    "objectID": "chap14.html#gbc-coding-results",
    "href": "chap14.html#gbc-coding-results",
    "title": "Applied Survival Analysis",
    "section": "GBC: Coding & Results",
    "text": "GBC: Coding & Results\n\n\nIPTW-adjusted vs unweighted KM\n\nCausal hazard ratio: 69.5% (\\(p\\)-value 0.006)\nStandard error may be incorrect due to randomness in estimated weights\n\nBootstrap\n\n\n\n# estimate propensity score\ntmp &lt;- ipwpoint(exposure = A, family=\"binomial\",link=\"logit\",\n             denominator =~ meno + size + factor(grade) + nodes + prog \n                      + estrg, data=data.CE)\n# IPTW-adjusted KM\nobj &lt;- survfit(Surv(time, status) ~ A, weights = tmp$ipw.weights, \n                       data = data.CE)\n# IPTW Cox model (essentially a marginal structural Cox model)\ncoxph(Surv(time,status) ~ A, weights=tmp$ipw.weights, data=data.CE)\n#&gt;       coef exp(coef) se(coef) robust se     z       p\n#&gt; A -0.36947   0.69110  0.08318   0.13632 -2.71 0.00672"
  },
  {
    "objectID": "chap14.html#gbc-iptw-vs-naive",
    "href": "chap14.html#gbc-iptw-vs-naive",
    "title": "Applied Survival Analysis",
    "section": "GBC: IPTW vs Naive",
    "text": "GBC: IPTW vs Naive\n\n\nConfounding not obvious"
  },
  {
    "objectID": "chap14.html#point-treatment",
    "href": "chap14.html#point-treatment",
    "title": "Applied Survival Analysis",
    "section": "Point Treatment",
    "text": "Point Treatment\n\n\nCausal inference\n\nRelationship between \\(T^{(a)}\\) vs \\(a\\), rather than \\(T\\) vs \\(A\\)\n\n\n\n\n\nMarginal structural models\n\nDefinition: a model for \\(T^{(a)}\\) against \\(a\\), possibly adjusting for baseline covariates \\(V\\subset W\\)\nMarginal: no need to condition on full \\(W\\) as covariates\nStructural: treatment is \\(a\\) (as in RCT), not observed \\(A\\)\nSimplest case: \\(V=\\emptyset\\) \\[\\begin{equation}\n\\lambda_a(t)=\\exp(a\\beta)\\lambda_0(t)\n\\end{equation}\\]\nMost useful in time-varying treatment/confounding"
  },
  {
    "objectID": "chap14.html#marginal-structural-cox-model",
    "href": "chap14.html#marginal-structural-cox-model",
    "title": "Applied Survival Analysis",
    "section": "Marginal Structural Cox Model",
    "text": "Marginal Structural Cox Model\n\n\nGeneral form\n\n\\(\\lambda_a(t\\mid V)\\): conditional hazard of \\(T^{(a)}\\) given \\(V\\) \\[\\begin{equation}\\label{eq:causal:msm_cox1}\n\\lambda_a(t\\mid V)=\\exp(\\beta a+\\gamma^{\\rm T}V)\\lambda_0(t)\n\\end{equation}\\]\n\\(\\exp(\\beta)\\): causal hazard ratio for treatment vs control adjusting for \\(V\\)\n\nDifferent from the causal HR conditional on all of \\(W\\)\n\nTreatment \\(\\times\\) covariate interaction \\[\\begin{equation}\\label{eq:causal:msm_cox2}\n\\lambda_a(t\\mid V)=\\exp(\\beta a+\\gamma^{\\rm T}V+a\\eta^{\\rm T}V)\\lambda_0(t)\n\\end{equation}\\]"
  },
  {
    "objectID": "chap14.html#fitting-msm",
    "href": "chap14.html#fitting-msm",
    "title": "Applied Survival Analysis",
    "section": "Fitting MSM",
    "text": "Fitting MSM\n\n\nGeneral assumption: \\(T\\indep C\\mid (A, W)\\)\nWeight construction\n\nStandard IPTW-IPCW weights \\[w_i(t)=\\frac{1}{\\pi_{A_i}(W_i)G_{A_i}(t\\mid W_i)}\\]\nStablized IPTW-IPCW weights \\[\\begin{equation}\\label{eq:causal:swights}\nw^{\\rm s}_i(t)=\\frac{\\pi_{A_i}(V_i)G_{A_i}(t\\mid V_i)}{\\pi_{A_i}(W_i)G_{A_i}(t\\mid W_i)},\n\\end{equation}\\]\n\n\\(\\pi_{a}(V)=\\pr(A=a\\mid V)\\) and \\(G_{a}(t\\mid V)=\\pr(C&gt;t\\mid A=a, V)\\)\nSet \\(G_{a}(t\\mid V)=G_{a}(t\\mid W)\\equiv 1\\) if \\(W\\not\\to C\\)"
  },
  {
    "objectID": "chap14.html#weighted-partial-likelihood-score",
    "href": "chap14.html#weighted-partial-likelihood-score",
    "title": "Applied Survival Analysis",
    "section": "Weighted Partial-Likelihood Score",
    "text": "Weighted Partial-Likelihood Score\n\n\nUsing stablized weights \\[\\begin{equation}\\label{eq:causal:msm_ee}\n    n^{-1}\\sum_{i=1}^n\\int_0^\\infty\\left\\{Z_i-\\frac{\\sum_{j=1}^nZ_j\\hat w^{\\rm s}_j(t) I(X_j\\geq t)\\exp(\\zeta^{\\rm T}Z_j)}\n    {\\sum_{j=1}^n \\hat w^{\\rm s}_j(t) I(X_j\\geq t)\\exp(\\zeta^{\\rm T}Z_j)}\\right\\} \\hat w^{\\rm s}_i(t)\\dd N_i(t)=0\n    \\end{equation}\\]\n\n\\(\\hat w^{\\rm s}_i(t)\\): an estimate of \\(w^{\\rm s}_i(t)\\)\n\\(Z_i=(A_i, V_i^{\\rm T})^{\\rm T}\\) and \\(\\zeta=(\\beta,\\gamma^{\\rm T})^{\\rm T}\\)"
  },
  {
    "objectID": "chap14.html#time-varying-treatment",
    "href": "chap14.html#time-varying-treatment",
    "title": "Applied Survival Analysis",
    "section": "Time-Varying Treatment",
    "text": "Time-Varying Treatment\n\n\nMSM\n\nAdjust for confounders \\(\\not\\leftrightarrow\\) adjust for covariates\nConditioning on covariate changes meaning of covariate effects\n\n\n\n\n\nMost useful in time-varying treatment/confounding\n\nMediator of previous treatment \\(\\leftrightarrow\\) Confounder for current/future treatment\nPrevious anti-retroviral treatment \\(\\to\\) current CD4 count \\(\\stackrel{\\rm prescribe}{\\rightarrow}\\) ART\n\nConditioning on CD4 \\(\\to\\) corrects confounding for current trt, blocks causal path of previous trt"
  },
  {
    "objectID": "chap14.html#notation-dag",
    "href": "chap14.html#notation-dag",
    "title": "Applied Survival Analysis",
    "section": "Notation & DAG",
    "text": "Notation & DAG\n\n\nNotation\n\n\\(a(t)\\): hypothetical treatment at \\(t\\); \\(A(t)\\): observed treatment at \\(t\\)\n\\(W(t)\\): possible confounders at \\(t\\)\nDiscretization\n\n\\(0=t_0&lt;t_1&lt;\\cdots&lt;t_m\\): time points\n\\(A_{\\cdot j}=A(t_j)\\) and \\(W_{\\cdot j}=W(t_j)\\)\n\\(\\overline A_{\\cdot j}=\\{A_{\\cdot 0},\\ldots, A_{\\cdot j}\\}\\); \\(\\overline W_{\\cdot j}=\\{W_{\\cdot 0},\\ldots, W_{\\cdot j}\\}\\); \\(V\\subset W_{\\cdot 0}\\): baseline covariates"
  },
  {
    "objectID": "chap14.html#msm-for-time-varying-treatment",
    "href": "chap14.html#msm-for-time-varying-treatment",
    "title": "Applied Survival Analysis",
    "section": "MSM for Time-Varying Treatment",
    "text": "MSM for Time-Varying Treatment\n\n\nModeling target\n\nTreatment path (sequence): \\(\\overline a(t)=\\{a(u): 0\\leq u\\leq t\\}\\)\nOutcome: \\(T^{(\\overline a)}\\) = potential outcome under treatment path \\(\\overline a(\\infty)\\) against \\(a(\\cdot)\\)\n\n\n\n\n\nModel specification\n\n\\(\\lambda_{\\overline a}(t\\mid V)\\): conditional hazard of \\(T^{(\\overline a)}\\) given \\(V\\) \\[\\begin{equation}\\label{eq:causal:msm_tv}\n\\lambda_{\\overline a}(t\\mid V)=\\exp\\{\\beta a(t)+\\gamma^{\\rm T}V\\}\n\\end{equation}\\]\nCox model with external (why?) time-varying covariate \\(a(t)\\)\n\nReplace \\(a(t)\\) by any summary of \\(\\overline a(t)\\), e.g., total time on treatment"
  },
  {
    "objectID": "chap14.html#sequential-randomization-assumption",
    "href": "chap14.html#sequential-randomization-assumption",
    "title": "Applied Survival Analysis",
    "section": "Sequential Randomization Assumption",
    "text": "Sequential Randomization Assumption\n\n\nSequential conditional exchangeability\n\nAn time-varying version of CE \\[\\begin{equation}\\label{eq:causal:cond_exch1}\nT^{(\\overline a)}\\indep A_{\\cdot j}\\mid (\\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})  \\hspace{2mm}j=1,\\ldots, m.\n\\end{equation}\\]\nTreatment assignment random given previous treatments and current/previous confounders (biomarkers)"
  },
  {
    "objectID": "chap14.html#longitudinal-weights",
    "href": "chap14.html#longitudinal-weights",
    "title": "Applied Survival Analysis",
    "section": "Longitudinal Weights",
    "text": "Longitudinal Weights\n\n\nAt time \\(t_j\\)\n\nPropensity scores/non-censoring hazards \\[\\begin{align}\n\\pi_k(t_j; \\overline A_{\\cdot, j-1}, V)&=\\pr(A_{\\cdot j}=k\\mid \\overline A_{\\cdot, j-1}, V)\\\\\n\\pi_k(t_j; \\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})&=\\pr(A_{\\cdot j}=k\\mid \\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})\\\\\n\\lambda_C(t_j\\mid \\overline A_{\\cdot, j-1}, V)&=\\pr(C&gt;t_j \\mid\nC&gt;t_{j-1}, \\overline A_{\\cdot, j-1}, V)\\\\\n\\lambda_C(t_j\\mid \\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})&=\\pr(C&gt;t_j \\mid\nC&gt;t_{j-1}, \\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})\n\\end{align}\\]\n\n\n\n\n\nStablized weight at \\(t\\)\n\nIPTW + IPCW \\[\\begin{equation}\\label{eq:causal:swights_tv}\nw^{\\rm s}(t)=\\prod_{t_j\\leq t}\\frac{\\pi_{A_{\\cdot, j}}(t_j; \\overline A_{\\cdot, j-1}, V)\\lambda_C(t_j\\mid \\overline A_{\\cdot, j-1}, V)}\n{\\pi_{A_{\\cdot, j}}(t_j; \\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})\\lambda_C(t_j\\mid \\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})}\n\\end{equation}\\]"
  },
  {
    "objectID": "chap14.html#weighted-partial-likelihood-score-1",
    "href": "chap14.html#weighted-partial-likelihood-score-1",
    "title": "Applied Survival Analysis",
    "section": "Weighted Partial-Likelihood Score",
    "text": "Weighted Partial-Likelihood Score\n\n\nUsing stablized weights\n\n\\(\\hat w^{\\rm s}_i(t)\\): estimated \\(w^{\\rm s}(t)\\) for \\(i\\)th subject \\[\\begin{align*}\nn^{-1}\\sum_{i=1}^n\\int_0^\\infty\\left\\{Z_i(t)-\\frac{\\sum_{j=1}^n\\hat w^{\\rm s}_j(t) Z_j(t) I(X_j\\geq t)\\exp\\{\\zeta^{\\rm T}Z_j(t)\\}}\n{\\sum_{j=1}^n \\hat w^{\\rm s}_j(t) I(X_j\\geq t)\\exp\\{\\zeta^{\\rm T}Z_j(t)\\}}\\right\\} \\hat w^{\\rm s}_i(t)\\dd N_i(t)\n\\end{align*}\\]\n\n\\(Z_i(t)=\\{A_i(t), V_i^{\\rm T})\\}^{\\rm T}\\); \\(\\zeta=(\\beta,\\gamma^{\\rm T})^{\\rm T}\\)"
  },
  {
    "objectID": "chap14.html#software-ipwipwtm-i",
    "href": "chap14.html#software-ipwipwtm-i",
    "title": "Applied Survival Analysis",
    "section": "Software: ipw::ipwtm() (I)",
    "text": "Software: ipw::ipwtm() (I)\n\n\nInput data (long format)\n\n\nhead(haartdat)\n # patient tstart fuptime haartind event sex age      cd4 endtime dropout\n #       1   -100       0        0     0   1  22 23.83275    2900       0\n #       1      0     100        0     0   1  22 25.59297    2900       0\n #       1    100     200        0     0   1  22 23.47339    2900       0\n #       1    200     300        0     0   1  22 24.16609    2900       0\n #       1    300     400        0     0   1  22 23.23790    2900       0\n #       1    400     500        0     0   1  22 24.85961    2900       0\n # ..."
  },
  {
    "objectID": "chap14.html#software-ipwipwtm-ii",
    "href": "chap14.html#software-ipwipwtm-ii",
    "title": "Applied Survival Analysis",
    "section": "Software: ipw::ipwtm() (II)",
    "text": "Software: ipw::ipwtm() (II)\n\n\nBasic syntax for IPTW weights\n\ntrt: treatment indicator; V: baseline covariates \\(V\\); W: (time-varying) confounders; (tstart, timevar): start/stop times; id: subject identifier\n\n\n\n\n# treatment changes only once, from 0 to 1, \n# e.g., initiation of ART \niptw &lt;- ipwtm(exposure = trt, family = \"survival\",\n        numerator =~ V, denominator =~ W, id, \n        tstart, timevar, type = \"first\")\n\n# treatment binary and changes arbitrarily\niptw &lt;- ipwtm(exposure = trt, family = \"binomial\",\n        link=\"logit\", numerator =~ V, denominator =~ W,\n        id, type = \"all\")"
  },
  {
    "objectID": "chap14.html#software-ipwipwtm-iii",
    "href": "chap14.html#software-ipwipwtm-iii",
    "title": "Applied Survival Analysis",
    "section": "Software: ipw::ipwtm() (III)",
    "text": "Software: ipw::ipwtm() (III)\n\n\nIPTW output:\n\niptw$ipw.weights: \\[\n\\prod_{t_j\\leq t}\\frac{\\pi_{A_{\\cdot, j}}(t_j; \\overline A_{\\cdot, j-1}, V)}\n{\\pi_{A_{\\cdot, j}}(t_j; \\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})}\n\\]\n\nBasic syntax for IPCW weights\n\ncensor = 1: censored, 0: not censored\n\n\n\n\nipcw &lt;- ipwtm(exposure = censor, family = \"survival\",\n        numerator = ~V, denominator = ~W, id, \n        tstart, timevar, type = \"first\")"
  },
  {
    "objectID": "chap14.html#software-ipwipwtm-iii-1",
    "href": "chap14.html#software-ipwipwtm-iii-1",
    "title": "Applied Survival Analysis",
    "section": "Software: ipw::ipwtm() (III)",
    "text": "Software: ipw::ipwtm() (III)\n\n\nIPCW output:\n\nipcw$ipw.weights: \\[\n\\prod_{t_j\\leq t}\\frac{\\lambda_C(t_j\\mid \\overline A_{\\cdot, j-1}, V)}\n{\\lambda_C(t_j\\mid \\overline A_{\\cdot, j-1}, \\overline W_{\\cdot j})}\n\\]\n\n\n\n\n\nFit MSM using combined weights\n\niptw$ipw.weights * ipcw$ipw.weights: \\(\\hat w^{\\rm s}_i(t)\\)\n\n\n\n\nobj &lt;- coxph(Surv(tstart, timevar, status) ~ trt + V \n             + cluster(id), \n             weights = iptw$ipw.weights * ipcw$ipw.weights)"
  },
  {
    "objectID": "chap14.html#an-hiv-study",
    "href": "chap14.html#an-hiv-study",
    "title": "Applied Survival Analysis",
    "section": "An HIV Study",
    "text": "An HIV Study\n\n\nStudy infomation\n\nPopulation: 1200 HIV-infected patients (van der Wal and Geskus, 2011) followed until death or censoring\nTreatment: Some initiate highly active anti-retroviral therapy (HAART) during follow-up, as determined by patient CD4 cell count\n\n\\(A=\\) haartind; \\(V=\\) sex, age; \\(W=\\) sex, age, cd4\n\n\n\n\nhead(haartdat)\n # patient tstart fuptime haartind event sex age      cd4 endtime dropout\n #       1   -100       0        0     0   1  22 23.83275    2900       0\n #       1      0     100        0     0   1  22 25.59297    2900       0\n #       1    100     200        0     0   1  22 23.47339    2900       0\n # ..."
  },
  {
    "objectID": "chap14.html#fit-msm-for-haart",
    "href": "chap14.html#fit-msm-for-haart",
    "title": "Applied Survival Analysis",
    "section": "Fit MSM for HAART",
    "text": "Fit MSM for HAART\n\n\nCompute weights and fit model\n\n\n# Compute the IPTW weights\niptw &lt;- ipwtm(exposure = haartind, family = \"survival\",\n          numerator = ~ sex + age, denominator = ~ cd4 + sex +\n          age, id = patient, tstart = tstart, timevar = fuptime, \n          type = \"first\", data = haartdat)\n\n# Compute the IPCW weights\nipcw &lt;- ipwtm(exposure = dropout, family = \"survival\",\n          numerator = ~ sex + age, denominator = ~ cd4 + sex +\n          age, id = patient, tstart = tstart, timevar = fuptime, \n          type = \"first\", data = haartdat)\n\n# Fit IPTW/IPCW marginal structural Cox model\nobj &lt;- coxph(Surv(tstart, fuptime, event) ~ haartind + sex +\n             age + cluster(patient), data = haartdat, \n             weights = iptw$ipw.weights * ipcw$ipw.weights)"
  },
  {
    "objectID": "chap14.html#inference",
    "href": "chap14.html#inference",
    "title": "Applied Survival Analysis",
    "section": "Inference",
    "text": "Inference\n\n\nResults\n\nHAART initiation reduces the mortality risk by \\(1 – 0.382 = 61.8\\%\\)\nCox model without adjusting for CD4 confounding \\(\\to\\) only \\(46.1\\%\\) reduction\n\nPatients who initiate HAART tend to have poor prognosis\n\n\n\n\nsummary(obj)\n#&gt;              coef exp(coef) se(coef) robust se      z Pr(&gt;|z|)    \n#&gt; haartind -0.96171   0.38224  0.43017   0.45148 -2.130 0.033160 *  \n#&gt; sex       0.09761   1.10253  0.43770   0.45351  0.215 0.829592    \n#&gt; age       0.06400   1.06609  0.01414   0.01678  3.815 0.000136 ***\n\n\n\n\n\n\n\nExercise\n\n\nWhat happens if you adjust for CD4 cell count as a time-varying covariate?"
  },
  {
    "objectID": "chap14.html#notes-i",
    "href": "chap14.html#notes-i",
    "title": "Applied Survival Analysis",
    "section": "Notes (I)",
    "text": "Notes (I)\n\nCounterfactual framework\n\nCausal inference for statistics, social, and biomedical sciences (Imbens and Rubin, 2015)\n\nPoint/time-varying treatment/confounding\n\nCausal inference: what if (Hernan and Robins, 2024)\n\nhttps://www.hsph.harvard.edu/miguel-hernan/causal-inference-book\n\n\nDirected acyclic graph (DAG) approach\n\nCausality: models, reasoning, and inference (Pearl, 2011)"
  },
  {
    "objectID": "chap14.html#notes-ii",
    "href": "chap14.html#notes-ii",
    "title": "Applied Survival Analysis",
    "section": "Notes (II)",
    "text": "Notes (II)\n\nTexts"
  },
  {
    "objectID": "chap14.html#summary-i",
    "href": "chap14.html#summary-i",
    "title": "Applied Survival Analysis",
    "section": "Summary (I)",
    "text": "Summary (I)\n\nCounterfactual framework\n\nPotential outcomes \\(T^{(a)}\\) \\((a=1, 0)\\)- mimicking RCT\n\nConditional exchangeability\n\nAll confounders captured in \\(W\\) \n\nMethods\n\nInverse probability treatment weighting (IPTW; ipw R-package)\nStandardization"
  },
  {
    "objectID": "chap14.html#summary-ii",
    "href": "chap14.html#summary-ii",
    "title": "Applied Survival Analysis",
    "section": "Summary (II)",
    "text": "Summary (II)\n\nMarginal structural model (MSM) \\[\\begin{equation}\n    \\lambda_{\\overline a}(t\\mid V)=\\exp\\{\\beta a(t)+\\gamma^{\\rm T}V\\}\n    \\end{equation}\\] \n\nIPTW/IPCW computed by ipw::ipwtm() and fed into survival::coxph()"
  },
  {
    "objectID": "chap14.html#hw6-due-may-1",
    "href": "chap14.html#hw6-due-may-1",
    "title": "Applied Survival Analysis",
    "section": "HW6 (Due May 1)",
    "text": "HW6 (Due May 1)\n\nProblem 12.5\nProblem 13.13\nProblem 14.10\n(Extra credit) Problem 14.9"
  },
  {
    "objectID": "chap14.html#hw6-due-april-30",
    "href": "chap14.html#hw6-due-april-30",
    "title": "Applied Survival Analysis",
    "section": "HW6 (Due April 30)",
    "text": "HW6 (Due April 30)\n\nProblem 12.11\nProblem 13.13\nProblem 14.10\n(Extra credit) Problem 14.9"
  },
  {
    "objectID": "chap14.html#weighted-partial-likelihood-score-2",
    "href": "chap14.html#weighted-partial-likelihood-score-2",
    "title": "Applied Survival Analysis",
    "section": "Weighted Partial-Likelihood Score",
    "text": "Weighted Partial-Likelihood Score\n\n\nInput data (long format)\n\n\nhead(haartdat)\n # patient tstart fuptime haartind event sex age      cd4 endtime dropout\n #       1   -100       0        0     0   1  22 23.83275    2900       0\n #       1      0     100        0     0   1  22 25.59297    2900       0\n #       1    100     200        0     0   1  22 23.47339    2900       0\n #       1    200     300        0     0   1  22 24.16609    2900       0\n #       1    300     400        0     0   1  22 23.23790    2900       0\n #       1    400     500        0     0   1  22 24.85961    2900       0\n # ..."
  },
  {
    "objectID": "chap13.html",
    "href": "chap13.html",
    "title": "Applied Survival Analysis",
    "section": "",
    "text": "Traditional vs hierarchical composites\nThe restricted mean time in favor (RMT-IF) of treatment\nWin ratio: two-sample analysis\nSemiparametric regression of win ratio\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\cc}{{\\rm c}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\] \\[\n\\newcommand\\mymathop[1]{\\mathop{\\operatorname{#1}}}\n\\] \\[\n\\newcommand{\\Ut}{{n \\choose 2}^{-1}\\sum_{i&lt;j}\\sum}\n\\]\n$$ \n$$"
  },
  {
    "objectID": "chap15.html#outline",
    "href": "chap15.html#outline",
    "title": "Applied Survival Analysis",
    "section": "Outline",
    "text": "Outline\n\n\nRegularized Cox regression models\nNonparametric regression by survival trees\nBuilding prediction models for German Breast Cancer study\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\cc}{{\\rm c}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\] \\[\n\\newcommand\\mymathop[1]{\\mathop{\\operatorname{#1}}}\n\\] \\[\n\\newcommand{\\Ut}{{n \\choose 2}^{-1}\\sum_{i&lt;j}\\sum}\n\\]"
  },
  {
    "objectID": "chap15.html#rationale",
    "href": "chap15.html#rationale",
    "title": "Applied Survival Analysis",
    "section": "Rationale",
    "text": "Rationale\n\n\nWith many covariates\n\nPrediction accuracy: under- vs over-fitting \n\nToo many predictors \\(\\to\\) overfitting\n\nInterpretation: easier with fewer predictors"
  },
  {
    "objectID": "chap15.html#linear-model-basics",
    "href": "chap15.html#linear-model-basics",
    "title": "Applied Survival Analysis",
    "section": "Linear Model Basics",
    "text": "Linear Model Basics\n\n\nSet-up \\[\nY=\\alpha+\\beta^\\T Z+\\epsilon\n\\]\n\n\\(Z\\): a \\(p\\)-vector of covariates (predictors)\n\\(E(\\epsilon\\mid Z)=0\\)\nAssume WLOG \\(\\sum_{i=1}^n Y_i=0\\) and \\(\\sum_{i=1}^n Z_i=0\\)\nOrdinary least-squares (OLS) estimator \\[\\begin{align*}\n\\hat\\beta_{\\rm OLS}=\\arg\\min_\\beta R_n(\\beta)=\\left(\\sum_{i=1}^n Z_i^{\\otimes 2}\\right)^{-1}\\sum_{i=1}^nZ_iY_i\n\\end{align*}\\]\n\n\\(R_n(\\beta)=\\sum_{i=1}^n(Y_i-\\beta^\\T Z_i)^2\\): residual sum of squares (RSS)"
  },
  {
    "objectID": "chap15.html#subset-selection",
    "href": "chap15.html#subset-selection",
    "title": "Applied Survival Analysis",
    "section": "Subset Selection",
    "text": "Subset Selection\n\n\nBig \\(p\\) problem\n\nLarge variance (overfit) \\(\\to\\) poor prediction\n\\(p&gt;n\\): no fit\n\n\n\n\n\nBest-subset selection\n\nFor each \\(l\\in\\{0, 1,\\ldots, p\\}\\), choose best model with \\(l\\) covariates with least RSS\n\\((p+1)\\) best models with decreasing RSS (as \\(l=0,1,\\ldots, p\\))\nChoose \\(l\\) by cross-validation\n\nPartition sample into \\(k\\) pieces\nSet one piece aside to evaluate RSS of model fit on remaining data\nCycle through all \\(k\\) pieces and average validation errors"
  },
  {
    "objectID": "chap15.html#cross-validation",
    "href": "chap15.html#cross-validation",
    "title": "Applied Survival Analysis",
    "section": "Cross-Validation",
    "text": "Cross-Validation\n\n\nComputing validation error"
  },
  {
    "objectID": "chap15.html#subset-selection-limitations",
    "href": "chap15.html#subset-selection-limitations",
    "title": "Applied Survival Analysis",
    "section": "Subset Selection: Limitations",
    "text": "Subset Selection: Limitations\n\n\nBest subset\n\nFit all \\(2^p\\) submodels\n\n\n\n\n\nForward/backward stepwise selections\n\nStart with null/full model, add/drop most/least significant predictor\nWhere to stop \\(\\to\\) cross-validation\n\n\n\n\n\nDisadvantages\n\nComputationally costly\nA discrete process: covariates are either retained or dropped; may be sub-optimal for prediction"
  },
  {
    "objectID": "chap15.html#penalized-regression-i",
    "href": "chap15.html#penalized-regression-i",
    "title": "Applied Survival Analysis",
    "section": "Penalized Regression (I)",
    "text": "Penalized Regression (I)\n\n\nConstrained least-squares\n\nRestricting \\(L_q\\)-norm of \\(\\beta\\) reduces effective d.f. \\[\\begin{equation}\\label{eq:vs:constrained}\n\\tilde\\beta(c)=\\arg\\min_\\beta R_n(\\beta), \\mbox{ subject to }\\sum_{j=1}^p|\\beta_j|^q\\leq c,\n\\end{equation}\\]\n\n\n\n\n\nEquivalent form by Lagrange multiplier\n\n\\(L_q\\)-penalized regression \\[\\begin{equation}\\label{eq:vs:penal}\n\\hat\\beta(\\lambda)=\\arg\\min_\\beta \\left\\{R_n(\\beta)+\\lambda\\sum_{j=1}^p|\\beta_j|^q\\right\\}\n\\end{equation}\\]\n\n\\(\\lambda\\geq 0\\): tuning parameter controlling degree of regulation, determined by cross-validation\n\\(\\hat\\beta(0)=\\hat\\beta_{\\rm OLS}\\); \\(\\hat\\beta(\\infty)=0\\)"
  },
  {
    "objectID": "chap15.html#penalized-regression-ii",
    "href": "chap15.html#penalized-regression-ii",
    "title": "Applied Survival Analysis",
    "section": "Penalized Regression (II)",
    "text": "Penalized Regression (II)\n\n\nExamples\n\nRidge regression \\((q=2)\\)\n\nClosed-form solution (not sparse; every \\(\\beta_j\\neq 0\\)) \\[\\begin{equation}\\label{eq:vs:ridge}\n\\hat\\beta(\\lambda)=\\left(\\sum_{i=1}^n Z_i^{\\otimes 2}+\\lambda I_p\\right)^{-1}\\sum_{i=1}^nZ_iY_i\n\\end{equation}\\]\n\nLasso (\\(q=1\\); Least absolute shrinkage and selection operator)\n\nSets some \\(\\hat\\beta_j\\equiv 0\\); sparse solution\n\nElastic net\n\nCombines the strengths of ridge regression and lasso \\[\\begin{equation}\\label{eq:vs:en}\n\\hat\\beta(\\lambda)=\\arg\\min_\\beta \\left[R_n(\\beta)+\\lambda\\sum_{j=1}^p\\left\\{\\alpha|\\beta_j|+2^{-1}(1-\\alpha)\\beta_j^2\\right\\}\\right]\n\\end{equation}\\]\nHandles correlated covariates better than lasso"
  },
  {
    "objectID": "chap15.html#l_1-regularized-cox-model",
    "href": "chap15.html#l_1-regularized-cox-model",
    "title": "Applied Survival Analysis",
    "section": "\\(L_1\\)-Regularized Cox Model",
    "text": "\\(L_1\\)-Regularized Cox Model\n\n\nWhat’s with Cox model\n\nObjective function (RSS not computable due to censoring)\nComputational algorithm\nDefinition of error for cross-validation\n\n\n\n\n\nObjective function: negative log-partial likelihood\n\nRegularize by \\(L_1\\) penalty \\[\\begin{equation}\\label{eq:vs:cox_lasso}\nQ_n(\\beta;\\lambda)=-n^{-1}pl_n(\\beta)+\\lambda\\sum_{j=1}^p|\\beta_j|\n\\end{equation}\\]\nSoltution: \\(\\hat\\beta(\\lambda)=\\arg\\min_\\beta Q_n(\\beta;\\lambda)\\)"
  },
  {
    "objectID": "chap15.html#pathwise-solution",
    "href": "chap15.html#pathwise-solution",
    "title": "Applied Survival Analysis",
    "section": "Pathwise Solution",
    "text": "Pathwise Solution\n\n\n\\(\\hat\\beta(\\lambda)\\) as a path of \\(\\lambda\\)\n\nIterative \\(pl_n(\\beta)\\approx\\) weighted sum of squares\nCoordinate descent at each iteration for \\(L_1\\)-penalized weighted least-squares\nDetails in Section 15.1.3 of lecture notes\n\n\n\n\n\n\\(K\\)-fold cross-validation to select \\(\\lambda_{\\rm opt}\\)\n\nSome \\(\\hat\\beta_j(\\lambda_{\\rm opt})=0\\)\nSelected variables \\(\\{Z_{\\cdot j}: \\hat\\beta_j(\\lambda_{\\rm opt})\\neq 0, j=1,\\ldots, p\\}\\)"
  },
  {
    "objectID": "chap15.html#cross-validation-error",
    "href": "chap15.html#cross-validation-error",
    "title": "Applied Survival Analysis",
    "section": "Cross-Validation Error",
    "text": "Cross-Validation Error\n\n\nWhat is measure of error?\n\nRSS not applicable due to censoring\nNegative partial-likelihood?\n\nUnstable with small validation set (risk set too small)\n\n\n\n\n\n\nPartial-likelihood deviance\n\nOn \\(j\\)th validation set \\[\n  \\mbox{CV}_j(\\lambda)=pl_{n,-j}\\{\\hat\\beta(\\lambda)\\}-pl_{n}\\{\\hat\\beta(\\lambda)\\}\n  \\]\n\n\\(pl_{n,-j}(\\beta)\\): log-partial likelihood based on training set\n\n\\(\\mbox{CV}(\\lambda)=k^{-1}\\sum_{j=1}^k\\mbox{CV}_j(\\lambda)\\)"
  },
  {
    "objectID": "chap15.html#prediction-error-brier-score",
    "href": "chap15.html#prediction-error-brier-score",
    "title": "Applied Survival Analysis",
    "section": "Prediction Error: Brier Score",
    "text": "Prediction Error: Brier Score\n\n\nBrier score\n\nMean squared error for predicted vs observed in test set\nCommonly used for binary outcomes\n\n\n\n\n\nExtension to time-to-event endpoint\n\nIPCW \\[\\begin{align}\\label{eq:ml:BS}\n\\hat{BS}(t)&=n^{-1}\\sum_{i=1}^n\\Bigg[I(X_i\\leq t, \\delta_i=1)\\hat G(X_i)^{-1}\\hat S_i(t)^2\\notag\\\\\n&\\hspace{20mm} + I(X_i&gt;t)\\hat G(t)^{-1}\\{1-\\hat S_i(t)\\}^2 \\Bigg]\n\\end{align}\\]\n\n\\(\\hat S_i(t)\\): predicted survival function for \\(i\\)th subject\n\\(\\hat G(t)\\): KM estimator for the censoring distribution in test set"
  },
  {
    "objectID": "chap15.html#software-glmnetglmnet-i",
    "href": "chap15.html#software-glmnetglmnet-i",
    "title": "Applied Survival Analysis",
    "section": "Software: glmnet::glmnet() (I)",
    "text": "Software: glmnet::glmnet() (I)\n\n\nBasic syntax for regularized Cox model\n\nElastic net \\[\n\\hat\\beta(\\lambda)=\\arg\\min_\\beta \\left[-n^{-1}pl_n(\\beta)+\\lambda\\sum_{j=1}^p\\left\\{\\alpha|\\beta_j|+2^{-1}(1-\\alpha)\\beta_j^2\\right\\}\\right]\n\\]\nZ: covariate matrix; alpha: \\(\\alpha\\)\n\n\n\n\n# compute the covariate path as a function of lambda\n# alpha=1: L_1 penalty (lasso)\nobj &lt;- glmnet(Z, Surv(time, status), family = \"cox\", alpha = 1)\n# compute 10-fold (default) cross-validation\nobj.cv &lt;- cv.glmnet(Z, Surv(time, status), family = \"cox\", \n                    alpha = 1)"
  },
  {
    "objectID": "chap15.html#software-glmnetglmnet-ii",
    "href": "chap15.html#software-glmnetglmnet-ii",
    "title": "Applied Survival Analysis",
    "section": "Software: glmnet::glmnet() (II)",
    "text": "Software: glmnet::glmnet() (II)\n\n\nFind optimal \\(\\lambda\\)\n\n\n\n# plot validation error (partial-likelihood deviance)\n# as a function of log-lambda\nplot(obj.cv)\n# the optimal lambda\nobj.cv$lambda.min\n# the beta at optimal lambda\nbeta &lt;- coef(obj.cv, s = \"lambda.min\")"
  },
  {
    "objectID": "chap15.html#gbc-an-example",
    "href": "chap15.html#gbc-an-example",
    "title": "Applied Survival Analysis",
    "section": "GBC: An Example",
    "text": "GBC: An Example\n\n\nGerman Breast Cancer (GBC) study\n\nCohort: 686 breast cancer patients\n\nOutcome: relapse-free survival\nPredictors: age (\\(\\leq\\) 40 vs &gt;40), menopausal status, hormone treatment, tumor grade, tumor size, lymph nodes, estrogen and progesterone receptor levels\nTraining set (\\(n=400\\)) + test set (\\(n=286\\))\n\n\n\n# select training set N=400\nset.seed(1234)\nind &lt;- sample(1:n)[1:400]\ntrain &lt;- data.CE[ind,]\ntest &lt;- data.CE[-ind,]"
  },
  {
    "objectID": "chap15.html#graphics",
    "href": "chap15.html#graphics",
    "title": "Applied Survival Analysis",
    "section": "Graphics",
    "text": "Graphics"
  },
  {
    "objectID": "chap15.html#selected-predictors",
    "href": "chap15.html#selected-predictors",
    "title": "Applied Survival Analysis",
    "section": "Selected Predictors",
    "text": "Selected Predictors\n\n\nCV results\n\n\\(\\log(\\lambda_{\\rm opt}) = -3.89\\)\n\n\n# the optimal lambda\nobj.cv$lambda.min\nlog(obj.cv$lambda.min)\n#&gt; [1] -3.886169\n# the beta at optimal lambda\nbeta &lt;- coef(obj.cv, s = \"lambda.min\")\n# the non-zero coefficients\nbeta.selected &lt;- beta[abs(beta[,1])&gt;0,]\n# print out the non-zero coefficients\nbeta.selected\n#&gt;      hormone        age40         size        grade        nodes \n#&gt; -0.371809445  0.455421368  0.003448500  0.201404194  0.040170638\n#&gt;      prog \n#&gt; -0.002908887"
  },
  {
    "objectID": "chap15.html#decision-trees",
    "href": "chap15.html#decision-trees",
    "title": "Applied Survival Analysis",
    "section": "Decision Trees",
    "text": "Decision Trees\n\n\nLimitations of regularized Cox model\n\nProportionality\nLinearity of covariate effects\nInteractions\n\n\n\n\n\nTree-based classification and regression\n\nClassification and Regression Trees (CART; Breiman et al., 1984)\nRoot node (all sample) \\(\\stackrel{\\rm covariates}{\\rightarrow}\\) split into (more homogeneous) daughter nodes \\(\\stackrel{\\rm covariates}{\\rightarrow}\\) split recursively"
  },
  {
    "objectID": "chap15.html#basic-procedures",
    "href": "chap15.html#basic-procedures",
    "title": "Applied Survival Analysis",
    "section": "Basic Procedures",
    "text": "Basic Procedures\n\n\nGrowing the tree\n\nStarting with root node, search partition criteria \\[Z_{\\cdot j}\\leq z \\,\\,\\,(j=1,\\ldots, p; z \\in\\mathbb R)\\] for one that minimizes “impurity” within daughter nodes \\[\\begin{equation}\\label{eq:tree:nodes}\nA=\\{i=1,\\ldots, n: Z_{ij}\\leq z\\} \\mbox{ and }\nB=\\{i=1,\\ldots, n: Z_{ij}&gt; z\\}\n\\end{equation}\\]\nRecursive splitting until terminal nodes sufficiently “pure” in outcome\n\n\n\n\n\nTree-based prediction\n\nA new covariate vector \\(\\to\\) terminal node it belongs \\(\\to\\) predicted outcome\n\nMajority class\nempirical mean\nKaplan-Meier estimator"
  },
  {
    "objectID": "chap15.html#splitting-criterion",
    "href": "chap15.html#splitting-criterion",
    "title": "Applied Survival Analysis",
    "section": "Splitting Criterion",
    "text": "Splitting Criterion\n\n\nObjective function\n\nChoose partition \\(A|B\\) to minimize \\[\nR(A\\mid\\mid B)=\\hat P(A)\\hat{\\mathcal G}(A)+\\hat P(B)\\hat{\\mathcal G}(B)\n\\]\n\n\\(\\hat P(A)\\), \\(\\hat P(B)\\): proportions of observations in daughter nodes\n\\(\\hat{\\mathcal G}(A)\\), \\(\\hat{\\mathcal G}(B)\\): impurity measures within daughter nodes\n\n\n\n\n\n\nImpurity measure\n\nCategorical \\(Y \\in\\{1,\\ldots, K\\}\\): Gini index \\(\\pr(Y_i\\neq Y_j) = 1-\\sum_{k=1}^K \\pi_k^2\\)\nContinuous: mean squared error\nSurvival: mean squared deviance residuals (Cox model with binary node) \\[\\begin{equation}\\label{eq:tree:deviance}\nR(A\\mid\\mid B)=n^{-1}\\sum_{i \\in A}d_{i}^2 +n^{-1}\\sum_{i \\in B}d_{i}^2\n\\end{equation}\\]"
  },
  {
    "objectID": "chap15.html#pruning-the-tree",
    "href": "chap15.html#pruning-the-tree",
    "title": "Applied Survival Analysis",
    "section": "Pruning the Tree",
    "text": "Pruning the Tree\n\n\nPenalize complexity\n\nCut overgrown branches \\(\\to\\) prevent overfitting \\(\\to\\) generalizability\n\nMinimize \\(R(\\mathcal T;\\lambda)=R(\\mathcal T)+\\lambda|\\mathcal T|\\)\n\n\\(R(\\mathcal T)\\): mean squared (deviance) residuals for terminal nodes of tree \\(\\mathcal T\\)\n\\(|\\mathcal T|\\): number of terminal nodes\n\\(\\lambda\\geq 0\\): complexity parameter determined by cross-validation\n\n\n\n\n\n\nFinal tree\n\n\\(\\mathcal T^{\\rm opt} = \\arg\\min_{\\mathcal T}R(\\mathcal T;\\lambda_{\\rm opt})\\)\n\\(\\mathcal T^{\\rm opt}(z)\\): terminal node for new covariate vector \\(z\\)\n\\(\\hat S(t\\mid z)\\): KM estimates in node \\(\\mathcal T^{\\rm opt}(z)\\)"
  },
  {
    "objectID": "chap15.html#bagging-and-random-forests",
    "href": "chap15.html#bagging-and-random-forests",
    "title": "Applied Survival Analysis",
    "section": "Bagging and Random Forests",
    "text": "Bagging and Random Forests\n\n\nBagging\n\nA single tree \\(\\to\\) large variance\nTake \\(B\\) bootstrapped samples from training data\n\n\\(\\mathcal T_b\\): survival tree grown on \\(b\\)th bootstrap sample \\((b=1, \\ldots, B)\\) (without pruning)\n\\(\\hat S_b(t\\mid z)\\): predicted survival function\n\n\nFinal prediction \\[\n\\hat S(t\\mid z)=B^{-1}\\sum_{b=1}^B \\hat S_b(t\\mid z)\n\\]\n\n\n\n\n\nRandom forests\n\nSame except only a random subset of covariates are considered at each split\nDe-correlate the trees grown on different bootstrapped samples)"
  },
  {
    "objectID": "chap15.html#software-rpartrpart",
    "href": "chap15.html#software-rpartrpart",
    "title": "Applied Survival Analysis",
    "section": "Software: rpart::rpart()",
    "text": "Software: rpart::rpart()\n\n\nBasic syntax for growing survival tree\n\nxval = k: \\(k\\)-fold cross-validation; minbucket: minimum size of terminal node; cp: minimum reduction of impurity measure for a split\n\n\n\n\n# grow the tree, with cross-validation\nobj &lt;- rpart(Surv(time, status) ~ covariates, \n    control = rpart.control(xval = 10, minbucket = 2, cp = 0))\n# cross-validation results\ncptable &lt;- obj$cptable\n# complexity parameter (lambda)\nCP &lt;- cptable[, 1] \n# find optimal parameter\n# cptable[, 4]: error function\ncp.opt &lt;- CP[which.min(cptable[, 4])]"
  },
  {
    "objectID": "chap15.html#software-rpartprune",
    "href": "chap15.html#software-rpartprune",
    "title": "Applied Survival Analysis",
    "section": "Software: rpart::prune()",
    "text": "Software: rpart::prune()\n\n\nBasic syntax for pruning survival tree\n\ntree: rpart object for grown tree; cp: optimal \\(\\lambda\\)\ntest: test data frame\n\n\n\n\n# prune the tree, with optimal lambda\nfit &lt;- prune(tree = obj, cp = cp.opt)\n# plot the pruned tree structure\nrpart.plot(fit)\n# fit$where: vector of terminal node for training data\n# compute KM estimates by terminal node\nkm &lt;- survfit(Surv(time, status) ~ fit$where)\n## prediction on test data ---------------------------\n# terminal node for test data\ntreeClust::rpart.predict.leaves(fit, test)"
  },
  {
    "objectID": "chap15.html#gbc-survival-trees",
    "href": "chap15.html#gbc-survival-trees",
    "title": "Applied Survival Analysis",
    "section": "GBC: Survival Trees",
    "text": "GBC: Survival Trees\n\n\nSame training data\n\n\\(\\lambda_{\\rm opt}=0.017\\); 3 splits (4 terminal nodes)\n\n\n\n# Conduct 10-fold cross-validation (xval = 10)\nobj &lt;- rpart(Surv(time, status) ~ hormone + meno + size + grade + nodes + \n              prog + estrg + age,\n             control = rpart.control(xval = 10, minbucket = 2, cp = 0),\n             data = train)\nprintcp(obj) # xerror: objective \n#            CP  nsplit rel.error  xerror   xstd\n# 1  0.07556835      0   1.00000 1.00411 0.046231\n# 2  0.03720019      1   0.92443 0.96817 0.047281\n# 3  0.02661914      2   0.88723 0.95124 0.046567\n# 4  0.01716925      3   0.86061 0.92745 0.046606 # minimizer\n# 5  0.01398306      4   0.84344 0.92976 0.047514\n# 6  0.01394869      5   0.82946 0.93941 0.048404\n# 7  0.01055028      9   0.77120 0.97722 0.052133"
  },
  {
    "objectID": "chap15.html#gbc-final-tree",
    "href": "chap15.html#gbc-final-tree",
    "title": "Applied Survival Analysis",
    "section": "GBC: Final Tree",
    "text": "GBC: Final Tree\n\n\nPruned tree"
  },
  {
    "objectID": "chap15.html#gbc-brier-scores",
    "href": "chap15.html#gbc-brier-scores",
    "title": "Applied Survival Analysis",
    "section": "GBC: Brier Scores",
    "text": "GBC: Brier Scores\n\n\nBrier scores of three models on test data"
  },
  {
    "objectID": "chap15.html#notes-i",
    "href": "chap15.html#notes-i",
    "title": "Applied Survival Analysis",
    "section": "Notes (I)",
    "text": "Notes (I)\n\nThe lasso\n\nFirst proposed by Tibshirani (1996) for least-squares\nExtended to Cox model by Tibshirani (1997)\nAlgorithms for \\(L_1\\)-regularized Cox model described in Simon et al. (2011)\n\nVariations\n\ngroup lasso (Yuan and Lin, 2006)\nadaptive lasso (Zou, 2006)\nsmoothly clipped absolute deviations (SCAD; Xie and Huang, 2009)\n\nElastic net for win ratio\n\nWRnet (Mao, 2025)"
  },
  {
    "objectID": "chap15.html#notes-ii",
    "href": "chap15.html#notes-ii",
    "title": "Applied Survival Analysis",
    "section": "Notes (II)",
    "text": "Notes (II)\n\n\n\n\nMore on decision trees\n\nText: Breiman et al. (1984)\nReview article: Bou-Hamad et al. (2011, Statistics Surveys)\n\nBagging and random forests (R-packages)\n\nipred\nrandomSurvivalForest\nranger"
  },
  {
    "objectID": "chap15.html#notes-iii",
    "href": "chap15.html#notes-iii",
    "title": "Applied Survival Analysis",
    "section": "Notes (III)",
    "text": "Notes (III)\n\nTidymodels\n\ncensored: a member of tidymodels family\nhttps://censored.tidymodels.org/\n\n\n\n\nlibrary(censored) \n\ndecision_tree() %&gt;% \n  set_engine(\"rpart\") %&gt;% \n  set_mode(\"censored regression\")\n#&gt; Decision Tree Model Specification (censored regression)\n#&gt; \n#&gt; Computational engine: rpart"
  },
  {
    "objectID": "chap15.html#summary",
    "href": "chap15.html#summary",
    "title": "Applied Survival Analysis",
    "section": "Summary",
    "text": "Summary\n\nRegularized Cox model\n\nObjective function \\[\nQ_n(\\beta;\\lambda)=-n^{-1}pl_n(\\beta)+\\lambda\\sum_{j=1}^p|\\beta_j|\n\\]\n\nglmnet::glmnet(Z, Surv(time, status), family =  “cox”, alpha = 1)\n\n\nSurvival trees\n\nRoot node \\(\\to\\) recursive partitioning based on similarity in outcome \\(\\to\\) pruning to prevent overfitting\n\nrpart:: rpart(Surv(time, status) ~ covariates)"
  },
  {
    "objectID": "intro_comp_endpts.html#outline",
    "href": "intro_comp_endpts.html#outline",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Outline",
    "text": "Outline\n\n\nTraditional vs hierarchical composites\nWin ratio: two-sample analysis\nSemiparametric regression of win ratio\n\n\n\\[\\newcommand{\\d}{{\\rm d}}\\] \\[\\newcommand{\\T}{{\\rm T}}\\] \\[\\newcommand{\\dd}{{\\rm d}}\\] \\[\\newcommand{\\cc}{{\\rm c}}\\] \\[\\newcommand{\\pr}{{\\rm pr}}\\] \\[\\newcommand{\\var}{{\\rm var}}\\] \\[\\newcommand{\\se}{{\\rm se}}\\] \\[\\newcommand{\\indep}{\\perp \\!\\!\\! \\perp}\\] \\[\\newcommand{\\Pn}{n^{-1}\\sum_{i=1}^n}\\] \\[\n\\newcommand\\mymathop[1]{\\mathop{\\operatorname{#1}}}\n\\] \\[\n\\newcommand{\\Ut}{{n \\choose 2}^{-1}\\sum_{i&lt;j}\\sum}\n\\]\n$$ \n$$"
  },
  {
    "objectID": "intro_comp_endpts.html#the-composite-approach",
    "href": "intro_comp_endpts.html#the-composite-approach",
    "title": "Survival Analysis in Clinical Trials",
    "section": "The Composite Approach",
    "text": "The Composite Approach\n\n\nComplex outcomes\n\nMultivariate/Recurrent events\n(Semi-)Competing risks (death vs nonfatal events)\nLongitudinal measures (biomarkers) with survival endpoint\n\n\n\n\n\nStandard methods\n\nJoint models (frailty, random effects)\nMarginal models (event-specific analyses)\n\n\n\n\n\nTraditional composite\n\nTime to first event (event-free survival)"
  },
  {
    "objectID": "intro_comp_endpts.html#examples-and-advantages",
    "href": "intro_comp_endpts.html#examples-and-advantages",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Examples and Advantages",
    "text": "Examples and Advantages\n\n\nExamples\n\nCardiovascular: major adverse cardiovascular events (MACE), e.g., death, nonfatal heart failure, myocardial infarction, stroke, etc.\nOncology: death and tumor progression (progression-free survival)\n\n\n\n\n\nAdvantages\n\nMore events \\(\\to\\) higher power \\(\\to\\) smaller sample size/lower costs\nNo need for multiplicity adjustment\nA unified measure of treatment effect\nRecommended by ICH-E9 “Statistical Principles for Clinical Trials” (1998)"
  },
  {
    "objectID": "intro_comp_endpts.html#data-and-notation",
    "href": "intro_comp_endpts.html#data-and-notation",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Data and Notation",
    "text": "Data and Notation\n\n\nTime-to-event\n\n\\(D\\): survival time; \\(N^*_D(t)=I(D\\leq t)\\)\n\\(N^*_1(t), \\ldots, N^*_K(t)\\): counting processes for \\(K\\) nonfatal event types\nLife history: \\(\\mathcal H^*(t)=\\{N^*_D(u), N^*_1(u), \\ldots, N^*_K(u):0\\leq u\\leq t\\}\\)\n\n\n\n\n\nCommon feature\n\nDeath most important, followed by some other events"
  },
  {
    "objectID": "intro_comp_endpts.html#traditional-composite-endpoints",
    "href": "intro_comp_endpts.html#traditional-composite-endpoints",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Traditional Composite Endpoints",
    "text": "Traditional Composite Endpoints\n\n\nTime to first event\n\n\\(N_{\\rm TFE}(t) = I\\{N^*_D(t)+\\sum_{k=1}^KN^*_k(t)\\geq 1\\}= I\\{Y(t)\\geq 1\\}\\)\n\n\n\n\n\nWeighted composite event process\n\n\\(N_{\\rm R}(t)=w_DN^*_D(t)+\\sum_{k=1}^Kw_kN^*_k(t)\\)\n\n\n\n\n\nHierarchical composite endpoints (HCE)\n\nDeath &gt; nonfatal MACE &gt; minor symptoms &gt; …\nUse more data, avoid arbitrary specification of weights"
  },
  {
    "objectID": "intro_comp_endpts.html#motivating-examples",
    "href": "intro_comp_endpts.html#motivating-examples",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Motivating Examples",
    "text": "Motivating Examples\n\n\n\n\n\nColon cancer trial\n\nLevamisole + fluorouracil (\\(n=304\\)) vs control (\\(n=315\\))\nRelapse-free survival\n\n258 (89%) deaths ignored\n\n\nHF-ACTION trial\n\nExercise training (\\(n=205\\)) vs usual care (\\(n=221\\))\nHospitalization-free survival\n\n82 (88%) deaths + 707 (69%) hospitalizations ignored"
  },
  {
    "objectID": "intro_comp_endpts.html#hierarchical-composite-endpoints",
    "href": "intro_comp_endpts.html#hierarchical-composite-endpoints",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Hierarchical Composite Endpoints",
    "text": "Hierarchical Composite Endpoints\n\n\nWin ratio\n\nRatio of probability of better / worse outcomes\nInitially two-sample comparison (Pocock et al., 2012)\nExtended to semiparametric regression"
  },
  {
    "objectID": "intro_comp_endpts.html#standard-two-sample",
    "href": "intro_comp_endpts.html#standard-two-sample",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Standard Two-Sample",
    "text": "Standard Two-Sample\n\n\nTwo-sample comparison (Pocock et al., 2012)\n\nData: \\(D_i^{(a)}, T_i^{(a)}, C_i^{(a)}\\): survival, hospitalization, censoring times on \\(i\\)th subject in group \\(a\\) \\((i=1,\\ldots, N_a; a= 1, 0)\\)\nHierarchical composite: Death &gt; hospitalization\nPairwise comparisons \\[\\begin{align}\n\\hat w^{(a, 1-a)}_{ij}&= \\underbrace{I(D_j^{(1-a)}&lt; D_i^{(a)}\\wedge C_i^{(a)}\\wedge C_j^{(1-a)})}_{\\mbox{win on survival}}\\\\\n& + \\underbrace{I(\\min(D_i^{(a)}, D_j^{(1-a)}) &gt; C_i^{(a)}\\wedge C_j^{(1-a)}, T_j^{(1-a)}&lt; T_i^{(a)}\\wedge C_i^{(1)}\\wedge C_j^{(0)})}_{\\mbox{inconclusive on survival, win on hospitalization}}\n\\end{align}\\]\nPrioritized comparison on \\(\\left[0, C_i^{(a)}\\wedge C_j^{(1-a)}\\right]\\)"
  },
  {
    "objectID": "intro_comp_endpts.html#pococks-rule",
    "href": "intro_comp_endpts.html#pococks-rule",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Pocock’s Rule",
    "text": "Pocock’s Rule\n\n\nWin, lose, or tie?"
  },
  {
    "objectID": "intro_comp_endpts.html#calculation-of-win-ratio",
    "href": "intro_comp_endpts.html#calculation-of-win-ratio",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Calculation of Win Ratio",
    "text": "Calculation of Win Ratio\n\n\nTwo-sample statistics\n\nWin (loss) fraction for group \\(a\\) (\\(1-a\\)) \\[\n\\hat w^{(a, 1-a)}=(N_0N_1)^{-1}\\sum_{i=1}^{N_a}\\sum_{j=1}^{N_{1-a}}\\hat w^{(a, 1-a)}_{ij}\\]\nWin ratio statistic \\[\nWR = \\hat w^{(1, 0)} / \\hat w^{(0, 1)}\n\\]\nOther measures\n\nNet benefit (proportion in favor): \\(\\hat w^{(1, 0)} - \\hat w^{(0, 1)}\\)\nWin odds: \\((\\hat w^{(1, 0)} - \\hat w^{(0, 1)} + 1)/ (\\hat w^{(0, 1)} - \\hat w^{(1, 0)} + 1)\\)"
  },
  {
    "objectID": "intro_comp_endpts.html#the-binary-case",
    "href": "intro_comp_endpts.html#the-binary-case",
    "title": "Survival Analysis in Clinical Trials",
    "section": "The Binary Case",
    "text": "The Binary Case\n\n\nConsider binary \\(Y^{(a)}= 1, 0\\)\n\n\\(\\hat w^{(a, 1-a)}_{ij} = I(Y_i^{(a)}&gt; Y_j^{(1-a)})=Y_i^{(a)}(1-Y_j^{(1-a)})\\)\nWin (loss) fraction \\[\n\\hat w^{(a, 1-a)} = (N_1N_0)^{-1}\\sum_{i=1}^{N_a}\\sum_{j=1}^{N_{1-a}}Y_i^{(a)}(1-Y_j^{(1-a)})\n= \\hat p^{(a)}(1-\\hat p^{(1-a)})\\] where \\(\\hat p^{(a)}= N_a^{-1}\\sum_{i=1}^{N_a} Y_i^{(a)}\\)\nEquivalencies \\[\\begin{align}\n{\\rm Win\\,\\, ratio}&= \\frac{\\hat w^{(1, 0)}}{\\hat w^{(0, 1)}} = \\frac{\\hat p^{(1)}(1-\\hat p^{(0)})}{\\hat p^{(0)}(1-\\hat p^{(1)})} = {\\rm Odds \\,\\, ratio}\\\\\n{\\rm Net \\,\\, benefit}&=\\hat w^{(1, 0)} - \\hat w^{(0, 1)} = \\hat p^{(1)}- \\hat p^{(0)}= {\\rm Risk \\,\\, difference}\n\\end{align}\\]"
  },
  {
    "objectID": "intro_comp_endpts.html#general-data",
    "href": "intro_comp_endpts.html#general-data",
    "title": "Survival Analysis in Clinical Trials",
    "section": "General Data",
    "text": "General Data\n\n\nOutcome data \\[\\mathcal H^{*{(a)}}(t)=\\left\\{N^{*{(a)}}_D(u), N^{*{(a)}}_1(u), \\ldots, N^{*{(a)}}_K(u):0\\leq u\\leq t\\right\\}\\]\n\n\\(N^{*{(a)}}_D(u), N^{*{(a)}}_1(u), \\ldots, N^{*{(a)}}_K(u)\\): counting processes for death and \\(K\\) different types of nonfatal events\n\n\n\n\n\nObserved data \\[\\{\\mathcal H^{*{(a)}}(X^{(a)}), X^{(a)}\\}\\]\n\nLife history observed up to \\(X^{(a)}= D^{(a)}\\wedge C^{(a)}\\)"
  },
  {
    "objectID": "intro_comp_endpts.html#general-rule",
    "href": "intro_comp_endpts.html#general-rule",
    "title": "Survival Analysis in Clinical Trials",
    "section": "General Rule",
    "text": "General Rule\n\n\nWin function \\[\\mathcal W(\\mathcal H^{*{(a)}}, \\mathcal H^{*{(1-a)}})(t) =I\\left\\{\\mathcal H^{*{(a)}}(t) \\mbox{ is more favorable than } \\mathcal H^{*{(1-a)}}(t)\\right\\}\\]\n\nBasic requirements\n\n(W1) \\(\\mathcal W(\\mathcal H^{*{(a)}}, \\mathcal H^{*{(1-a)}})(t)\\) is a function only of \\(\\mathcal H^{*{(a)}}(t)\\) and \\(\\mathcal H^{*{(1-a)}}(t)\\)\n(W2) \\(\\mathcal W(\\mathcal H^{*{(a)}}, \\mathcal H^{*{(1-a)}})(t)+\\mathcal W(\\mathcal H^{*{(1-a)}}, \\mathcal H^{*{(a)}})(t) \\in \\{0, 1\\}\\)\n(W3) \\(\\mathcal W(\\mathcal H^{*{(a)}}, \\mathcal H^{*{(1-a)}})(t)=\\mathcal W(\\mathcal H^{*{(a)}}, \\mathcal H^{*{(1-a)}})(D^{(a)}\\wedge D^{(1-a)}\\wedge t)\\)\n\nInterpretations\n\n(W1) Consistency of time frame\n(W2) Either win, loss, or tie\n(W3) No change of win-loss status after death (satisfied if death is prioritized)"
  },
  {
    "objectID": "intro_comp_endpts.html#generalized-win-ratio",
    "href": "intro_comp_endpts.html#generalized-win-ratio",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Generalized Win Ratio",
    "text": "Generalized Win Ratio\n\n\nGeneral WR statistics \\[\\begin{equation}\\label{eq:wr:gen_WR}\n    \\hat{\\mathcal E}_n(\\mathcal W)=\\frac{(N_1N_0)^{-1}\\sum_{i=1}^{N_1}\\sum_{j=1}^{N_0}\\mathcal W(\\mathcal H^{*{(1)}}_{i}, \\mathcal H^{*{(0)}}_{j})(X^{{(1)}}_{i}\\wedge X^{{(0)}}_{j})}\n    {(N_1N_0)^{-1}\\sum_{i=1}^{N_1}\\sum_{j=1}^{N_0}\\mathcal W(\\mathcal H^{*{(0)}}_{j}, \\mathcal H^{*{(1)}}_{i})(X^{{(1)}}_{i}\\wedge X^{{(0)}}_{j})}\n    \\end{equation}\\]\n\nWindow of comparison: \\([0, X^{{(1)}}_{i}\\wedge X^{{(0)}}_{j}]\\), by a general \\(\\mathcal W\\)\nStratified win ratio \\[\n\\frac{\\text{Weighted sum of within-stratum wins}}{\\text{Weighted sum of within-stratum losses}}\n\\]"
  },
  {
    "objectID": "intro_comp_endpts.html#pococks-win-ratio",
    "href": "intro_comp_endpts.html#pococks-win-ratio",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Pocock’s Win Ratio",
    "text": "Pocock’s Win Ratio\n\n\nWin function\n\n\\(K\\) nonfatal events hierarchically ranked\n\\(T^{(a)}_k\\): time of first event in \\(N_k^{*{(a)}}(t)\\) \\((k=1,\\ldots, K)\\) \\[\\begin{align}\\label{eq:wr:PWR}\n\\mathcal W_{\\rm P}(\\mathcal H^{*{(a)}}, \\mathcal H^{*{(1-a)}})(t)&=I\\{D^{(1-a)}&lt;D^{(a)}\\wedge t\\}\\notag\\\\\n&\\hspace{2mm}+I\\{D^{(a)}\\wedge D^{(1-a)}&gt;t, T_{1}^{(1-a)}&lt;T_{1}^{(a)}\\wedge t\\}\\notag\\\\\n&\\hspace{2mm}+\\sum_{k=2}^KI\\{\\tilde T_{k-1}^{(a)}\\wedge \\tilde T_{k-1}^{(1-a)}&gt;t, T_{k}^{(1-a)}&lt;T_{k}^{(a)}\\wedge t\\}\n\\end{align}\\]\n\n\\(\\tilde T_{k-1}^{(a)}=D^{(a)}\\wedge T_{1}^{(a)}\\wedge\\cdots\\wedge T_{k-1}^{(a)}\\)\n\n\n\n\n\n\nWin ratio statistic: \\(\\hat{\\mathcal E}_n(\\mathcal W_{\\rm P})\\)"
  },
  {
    "objectID": "intro_comp_endpts.html#taking-recurrent-events",
    "href": "intro_comp_endpts.html#taking-recurrent-events",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Taking Recurrent Events",
    "text": "Taking Recurrent Events\n\n\nRecurrent-event win ratio (RWR)\n\nDeath &gt; number of recurrent events &gt; time to last event"
  },
  {
    "objectID": "intro_comp_endpts.html#time-to-first-event",
    "href": "intro_comp_endpts.html#time-to-first-event",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Time-to-First-Event",
    "text": "Time-to-First-Event\n\n\nCompare on order of first event\n\nWin function \\[\n\\mathcal W_{\\rm TFE}(\\mathcal H^{*{(a)}},\\mathcal H^{*{(1-a)}})(t)=I(\\tilde T^{(1-a)}&lt;\\tilde T^{(a)}\\wedge t)\n\\]\n\n\\(\\tilde T^{(a)}=\\min(D^{(a)}, T_1^{(a)},\\ldots, T_K^{(a)})\\)\n\nAllowable but not desirable"
  },
  {
    "objectID": "intro_comp_endpts.html#regression-framework",
    "href": "intro_comp_endpts.html#regression-framework",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Regression Framework",
    "text": "Regression Framework\n\nMotivation\n\nMeaningful estimand of effect size\nMultiple (quantitative) predictors\n\nModelin target\n\nTwo independent subjects \\((\\mathcal H_i, Z_i)\\) and \\((\\mathcal H_j, Z_j)\\)\n\n\\(E\\{\\mathcal W(\\mathcal H_i,\\mathcal H_j)(t)\\mid Z_i, Z_j\\}\\): Conditional win fraction (probability) for \\(i\\) against \\(j\\) at \\(t\\)\n\\(E\\{\\mathcal W(\\mathcal H_j,\\mathcal H_i)(t)\\mid Z_i, Z_j\\}\\): Conditional win fraction (probability) for \\(j\\) against \\(i\\) at \\(t\\)\n\nCovariate-specific win ratio \\[\\begin{equation}\\label{eq:cov_spec_curtail_wr}\nWR(t; Z_i, Z_j;\\mathcal W):= \\frac{E\\{\\mathcal W(\\mathcal H_i,\\mathcal H_j)(t)\\mid Z_i,Z_j\\}}{E\\{\\mathcal W(\\mathcal H_j,\\mathcal H_i)(t)\\mid Z_i, Z_j\\}}\n\\end{equation}\\]\nModel it against \\(Z_i\\) and \\(Z_j\\) to study covariate effect on WR"
  },
  {
    "objectID": "intro_comp_endpts.html#model-specification",
    "href": "intro_comp_endpts.html#model-specification",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Model Specification",
    "text": "Model Specification\n\nProportional win-fractions (PW) model \\[\\begin{equation}\\label{eq:wr_reg}\nWR(t\\mid Z_i, Z_j;\\mathcal W)=\\exp\\left\\{\\beta^{\\rm T}\\left(Z_i- Z_j\\right)\\right\\}\n\\end{equation}\\]\n\nPW: covariate-specific win/loss fractions proportional over time\n\nWR constant over time\n\n\\(\\beta\\): log-win ratio associated with unit increases in covariates (regardless of follow-up time)\nSemiparametric model\n\nParametric covariate-specific WRs\nNonparametric in other aspects (baseline event rates, etc.)\n\nDenote model by PW\\((\\mathcal W)\\)\n\nStresses model’s dependency on \\(\\mathcal W\\) chosen"
  },
  {
    "objectID": "intro_comp_endpts.html#special-cases",
    "href": "intro_comp_endpts.html#special-cases",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Special Cases",
    "text": "Special Cases\n\nPocock’s two-sample WR\n\n\\(Z = 1, 0\\)\n\\(\\exp(\\beta)\\): WR comparing group \\(z=1\\) with group \\(0\\)\n\nCox PH model\n\nPW\\((\\mathcal W_{\\rm TFE})\\) \\(\\Leftrightarrow\\) Cox PH model on time to first event"
  },
  {
    "objectID": "intro_comp_endpts.html#estimation",
    "href": "intro_comp_endpts.html#estimation",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Estimation",
    "text": "Estimation\n\nConstruction of estimating function\n\nObserved win process \\(\\delta_{ij}(t)=\\mathcal W(\\mathcal H_i,\\mathcal H_j)(X_i\\wedge X_j\\wedge t)\\)\nDeterminancy (win or loss): \\(R_{ij}(t)=\\delta_{ij}(t)+\\delta_{ji}(t)\\)\nMean-zero residual \\[\\begin{equation}\\label{eq:wr:resid}\nM_{ij}(t\\mid Z_i, Z_j;\\beta)=\\underbrace{\\delta_{ij}(t)}_{\\rm observed\\,\\,win} -\n\\underbrace{R_{ij}(t)\\frac{\\exp\\left\\{\\beta^{\\rm T}\\left( Z_i- Z_j\\right)\\right\\}}{\n1+\\exp\\left\\{\\beta^{\\rm T}\\left(Z_i- Z_j\\right)\\right\\}}}_{\\rm model-based\\,\\, prediction}\n\\end{equation}\\]\nEstimating equation \\[\\begin{equation}\\label{eq:wr:ee}\n\\Ut\\int_0^\\infty (Z_i - Z_j) h(t; Z_i, Z_j)\\dd M_{ij}(t \\mid Z_i, Z_j;\\beta)=0\n\\end{equation}\\]\n\nWeight function \\(h(t; Z_i, Z_j)\\equiv 1\\)"
  },
  {
    "objectID": "intro_comp_endpts.html#checking-proportionality",
    "href": "intro_comp_endpts.html#checking-proportionality",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Checking Proportionality",
    "text": "Checking Proportionality\n\nCumulative residuals\n\nRescaled \\(\\hat U_n(t)=\\Ut(Z_i - Z_j)\\underbrace{M_{ij}(t \\mid Z_i, Z_j;\\hat\\beta)}_{\\rm observed\\,\\, minus\\,\\, model-based\\,\\,wins\\,\\, by\\,\\, t}\\)"
  },
  {
    "objectID": "intro_comp_endpts.html#software-wrpwreg-i",
    "href": "intro_comp_endpts.html#software-wrpwreg-i",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Software: WR::pwreg() (I)",
    "text": "Software: WR::pwreg() (I)\n\nInput data format\n\nstatus = 1 for death, 2 for nonfatal events, 0 for censoring\n\n\n\nlibrary(WR)\n#&gt; Loading required package: survival\nhead(non_ischemic)\n#&gt;   ID time status trt_ab age sex Black.vs.White Other.vs.White   bmi\n#&gt; 1  1  221      2      0  62   1              0              0 25.18\n#&gt; 2  1  383      0      0  62   1              0              0 25.18\n#&gt; 3  2   23      2      0  75   1              1              0 22.96\n#&gt; 4  2 1400      0      0  75   1              1              0 22.96\n#&gt; ..."
  },
  {
    "objectID": "intro_comp_endpts.html#software-wrpwreg-ii",
    "href": "intro_comp_endpts.html#software-wrpwreg-ii",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Software: WR::pwreg() (II)",
    "text": "Software: WR::pwreg() (II)\n\nBasic syntax for PW\\((\\mathcal W_{\\rm P})\\)\n\nID: subject identifier\nZ: covariate matrix; strata: possible stratifier (categorical)\n\n\n\n\n# fit PW model (death &gt; nonfatal event)\nobj &lt;- pwreg(ID, time, status, Z, strata = NULL)\n\n\n\nOutput: an object of class pwreg\n\nobj$beta: \\(\\hat\\beta\\)\nobj$Var: \\(\\hat\\var(\\hat\\beta)\\)\nprint(obj) to summarize regression results"
  },
  {
    "objectID": "intro_comp_endpts.html#software-wrscore.proc",
    "href": "intro_comp_endpts.html#software-wrscore.proc",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Software: WR::score.proc()",
    "text": "Software: WR::score.proc()\n\nChecking proportionality\n\nobj: a pwreg object\n\n\n\n\n# fit PW model (death &gt; nonfatal event)\nscore.obj &lt;- score.proc(obj)\n\n\n\nOutput: an object of class score.proc\n\nscore.obj$t: \\(t\\)\nscore.obj$score: a matrix with rescaled residual process for each covariate per row\nplot(score.obj, k): plot the rescaled residuals for \\(k\\)th covariate"
  },
  {
    "objectID": "intro_comp_endpts.html#hf-action-data",
    "href": "intro_comp_endpts.html#hf-action-data",
    "title": "Survival Analysis in Clinical Trials",
    "section": "HF-ACTION: Data",
    "text": "HF-ACTION: Data\n\nAnother subset of HF-ACTION\n\nPopulation: \\(n=451\\) non-ischemic patients followed over median length of 31.6 months\nEndpoints: death &gt; first hospitalization\nPredictors: training vs usual care, age, sex, race, bmi, LVEF, medications, etc.\n\n\n\nlibrary(WR)\n#&gt; Loading required package: survival\nhead(non_ischemic)\n#&gt;   ID time status trt_ab age sex Black.vs.White Other.vs.White   bmi  ...\n#&gt; 1  1  221      2      0  62   1              0              0 25.18\n#&gt; 2  1  383      0      0  62   1              0              0 25.18\n#&gt; 3  2   23      2      0  75   1              1              0 22.96\n#&gt; 4  2 1400      0      0  75   1              1              0 22.96\n#&gt; ..."
  },
  {
    "objectID": "intro_comp_endpts.html#hf-action-regression-coding",
    "href": "intro_comp_endpts.html#hf-action-regression-coding",
    "title": "Survival Analysis in Clinical Trials",
    "section": "HF-ACTION: Regression Coding",
    "text": "HF-ACTION: Regression Coding\n\nSet up PW\\((\\mathcal W_{\\rm P})\\)\n\n\n# extract variables and covariate matrix\nID &lt;- non_ischemic[,\"ID\"]\ntime &lt;- non_ischemic[,\"time\"]\nstatus &lt;- non_ischemic[,\"status\"]\nZ &lt;- as.matrix(non_ischemic[, 4:(3+p)], nr, p)\n# pass the parameters into the function\npwreg.obj &lt;- pwreg(ID, time, status, Z)\n# print out results\nprint(pwreg.obj)"
  },
  {
    "objectID": "intro_comp_endpts.html#hf-action-regression-results",
    "href": "intro_comp_endpts.html#hf-action-regression-results",
    "title": "Survival Analysis in Clinical Trials",
    "section": "HF-ACTION: Regression Results",
    "text": "HF-ACTION: Regression Results\n\nSummary results\n\nTraining \\(\\exp(0.191) - 1= 21\\%\\) more likely to get favorable outcome than UC\nRace differences substantial and significant\nLVEF: 1% increases win likelihood by \\(\\exp(0.021) = 1.02\\) (\\(p\\)-value 0.013)\n\n\n\n#&gt; Estimates for Regression parameters:\n#&gt;                     Estimate         se z.value p.value\n#&gt; Training vs Usual  0.1906687  0.1264658  1.5077 0.13164\n#&gt; Age (year)        -0.0128306  0.0057285 -2.2398 0.02510 *\n#&gt; Male vs Female    -0.1552923  0.1294198 -1.1999 0.23017\n#&gt; Black vs White    -0.3026335  0.1461330 -2.0709 0.03836 *\n#&gt; Other vs White    -0.3565390  0.3424360 -1.0412 0.29779\n#&gt; BMI               -0.0181310  0.0097582 -1.8580 0.06316 .\n#&gt; LVEF               0.0214905  0.0086449  2.4859 0.01292 *\n#&gt; ..."
  },
  {
    "objectID": "intro_comp_endpts.html#hf-action-residual-analyses",
    "href": "intro_comp_endpts.html#hf-action-residual-analyses",
    "title": "Survival Analysis in Clinical Trials",
    "section": "HF-ACTION: Residual Analyses",
    "text": "HF-ACTION: Residual Analyses\n\nChecking proportionality\n\n\nscore.obj &lt;- score.proc(pwreg.obj)\npar(mfrow = c(1, 3)) # plot residual processes for treatment, age, LVEF\nfor(i in c(1, 2, 7)){\n  plot(score.obj, k = i, xlab = \"Time (Days)\")\n}"
  },
  {
    "objectID": "intro_comp_endpts.html#notes",
    "href": "intro_comp_endpts.html#notes",
    "title": "Survival Analysis in Clinical Trials",
    "section": "Notes",
    "text": "Notes\n\nBefore win ratio\n\nContinuous outcome: Wilcoxon (1945), Mann & Whitney (1947)\nHierarchical endpoints: Finkelstein and Schoenfeld (1999), Buyse (2010)\n\nWin ratio regression\n\nProportionality and multiplicativity \\[\nWR(t\\mid Z_i, Z_j;\\mathcal W)=\\exp\\left\\{\\beta^{\\rm T}\\left(Z_i- Z_j\\right)\\right\\}\n\\]\n\\(\\exp(\\beta)\\): WRs with unit increases in covariates\nWR::pwreg()\n\nHierarchical endpoints\n\nGaining popularity and an active area of research"
  }
]